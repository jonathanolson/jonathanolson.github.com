var lp=Object.defineProperty;var cp=(r,e,t)=>e in r?lp(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var Zh=(r,e,t)=>(cp(r,typeof e!="symbol"?e+"":e,t),t);import{N as Oo,X as dp,y as ft,T as X,D as Ve,g as re,I as Le,Y as U,A as _e,o as E,c as pe,q as ge,B as w,Z as Bt,b as C,V as T,Q as Un,J as Es,_ as Kc,x as Mo,w as Hs,$ as V,P as me,a0 as ae,n as se,a1 as up,a2 as Jh,a3 as el,v as Ni,a4 as mt,p as it,R as os,E as si,d as ii,a5 as nt,a6 as pp,f as Mt,a7 as Dt,t as Je,a as Tt,a8 as J,l as ls,r as Ot,F as Ge,a9 as ct,aa as qa,ab as gp,G as Z,e as Ro,ac as No,h as gn,ad as mp,ae as fp,M as Gi,S as tl,O as M,af as yp,ag as bp,ah as zi}from"./UnivariatePolynomial-1rLpyqfN.js";import{t as ue,p as Te,u as Lp,S as H,w as Bo,x as ee,m as qs,y as Me,D as Wi,o as vp,L as sl,z as Li,A as Qa,C as Yn,O as Us}from"./getCoordinateClusteredMap-Bd_wM-c0.js";window.sceneryLog=null;const Xc=document.createElement("canvas"),Pp=Xc.getContext("2d");let $i="";const d=new Oo("scenery");d.register("scratchCanvas",Xc);d.register("scratchContext",Pp);function _p(r){d.logString+=`${r.replace(/%c/g,"")}
`}function Sp(...r){window.console&&window.console.log&&window.console.log(...Array.prototype.slice.call(r,0))}const il={dirty:{name:"dirty",style:"color: #888;"},bounds:{name:"bounds",style:"color: #888;"},hitTest:{name:"hitTest",style:"color: #888;"},hitTestInternal:{name:"hitTestInternal",style:"color: #888;"},PerfCritical:{name:"Perf",style:"color: #f00;"},PerfMajor:{name:"Perf",style:"color: #aa0;"},PerfMinor:{name:"Perf",style:"color: #088;"},PerfVerbose:{name:"Perf",style:"color: #888;"},Cursor:{name:"Cursor",style:""},Stitch:{name:"Stitch",style:""},StitchDrawables:{name:"Stitch",style:""},GreedyStitcher:{name:"Greedy",style:"color: #088;"},GreedyVerbose:{name:"Greedy",style:"color: #888;"},RelativeTransform:{name:"RelativeTransform",style:"color: #606;"},BackboneDrawable:{name:"Backbone",style:"color: #a00;"},CanvasBlock:{name:"Canvas",style:""},WebGLBlock:{name:"WebGL",style:""},Display:{name:"Display",style:""},DOMBlock:{name:"DOM",style:""},Drawable:{name:"",style:""},FittedBlock:{name:"FittedBlock",style:""},Instance:{name:"Instance",style:""},InstanceTree:{name:"InstanceTree",style:""},ChangeInterval:{name:"ChangeInterval",style:"color: #0a0;"},SVGBlock:{name:"SVG",style:""},SVGGroup:{name:"SVGGroup",style:""},ImageSVGDrawable:{name:"ImageSVGDrawable",style:""},Paints:{name:"Paints",style:""},Filters:{name:"Filters",style:""},AlignBox:{name:"AlignBox",style:""},AlignGroup:{name:"AlignGroup",style:""},RichText:{name:"RichText",style:""},Sim:{name:"Sim",style:""},ParallelDOM:{name:"ParallelDOM",style:""},PDOMInstance:{name:"PDOMInstance",style:""},PDOMTree:{name:"PDOMTree",style:""},PDOMDisplaysInfo:{name:"PDOMDisplaysInfo",style:""},KeyboardFuzzer:{name:"KeyboardFuzzer",style:""},InputListener:{name:"InputListener",style:""},InputEvent:{name:"InputEvent",style:""},OnInput:{name:"OnInput",style:""},Pointer:{name:"Pointer",style:""},Input:{name:"Input",style:""},EventDispatch:{name:"EventDispatch",style:""},EventPath:{name:"EventPath",style:""}};dp(d,{logString:"",logFunction:function(...r){window.console&&window.console.log&&window.console.log(...Array.prototype.slice.call(r,0))},switchLogToConsole:function(){d.logFunction=Sp},switchLogToString:function(){window.console&&window.console.log("switching to string log"),d.logFunction=_p},enableIndividualLog:function(r){if(r==="stitch"){this.enableIndividualLog("Stitch"),this.enableIndividualLog("StitchDrawables"),this.enableIndividualLog("GreedyStitcher"),this.enableIndividualLog("GreedyVerbose");return}if(r==="perf"){this.enableIndividualLog("PerfCritical"),this.enableIndividualLog("PerfMajor"),this.enableIndividualLog("PerfMinor"),this.enableIndividualLog("PerfVerbose");return}if(r==="input"){this.enableIndividualLog("InputListener"),this.enableIndividualLog("InputEvent"),this.enableIndividualLog("OnInput"),this.enableIndividualLog("Pointer"),this.enableIndividualLog("Input"),this.enableIndividualLog("EventDispatch"),this.enableIndividualLog("EventPath");return}if(r==="a11y"||r==="pdom"){this.enableIndividualLog("ParallelDOM"),this.enableIndividualLog("PDOMInstance"),this.enableIndividualLog("PDOMTree"),this.enableIndividualLog("PDOMDisplaysInfo");return}r&&(assert&&assert(il[r],`Unknown logger: ${r}, please use periods (.) to separate different log names`),window.sceneryLog[r]=window.sceneryLog[r]||function(e,t){const s=il[r],i=s.name?`[${s.name}] `:"";d.logFunction(`%c${$i}%c${i}${e}`,"color: #ddd;",t||s.style)})},disableIndividualLog:function(r){r&&delete window.sceneryLog[r]},enableLogging:function(r){window.sceneryLog=function(e){d.logFunction(e)},window.sceneryLog.push=function(){$i+="| "},window.sceneryLog.pop=function(){$i=$i.slice(0,-2)},window.sceneryLog.getDepth=function(){return $i.length/2};for(let e=0;e<r.length;e++)this.enableIndividualLog(r[e])},disableLogging:function(){window.sceneryLog=null},isLoggingPerformance:function(){return window.sceneryLog.PerfCritical||window.sceneryLog.PerfMajor||window.sceneryLog.PerfMinor||window.sceneryLog.PerfVerbose}});const Ds={DISABLED_OPACITY:.45,DEFAULT_COLOR_PROFILE:"default",PROJECTOR_COLOR_PROFILE:"projector"};d.register("SceneryConstants",Ds);function O(r){return r instanceof ft||r instanceof X}const Vs=Ve.clamp,tr=Ve.linear,hi="(-?\\d{1,3}%?)",nl="(\\d+|\\d*\\.\\d+)",li="(\\d{1,3})";function ci(r){let e=1;return r.endsWith("%")&&(e=2.55,r=r.slice(0,r.length-1)),Ve.roundSymmetric(Number(r)*e)}const z=class z{constructor(e,t,s,i){this.changeEmitter=new re,this.set(e,t,s,i)}copy(){return new z(this.r,this.g,this.b,this.a)}set(e,t,s,i){if(assert&&assert(e!==void 0,"Can't call Color.set( undefined )"),e===null)this.setRGBA(0,0,0,0);else if(typeof e=="string")this.setCSS(e);else if(e instanceof z)this.setRGBA(e.r,e.g,e.b,e.a);else if(s===void 0){assert&&assert(t===void 0||typeof t=="number");const n=e>>16&255,a=e>>8&255,o=e>>0&255,h=t===void 0?1:t;this.setRGBA(n,a,o,h)}else assert&&assert(i===void 0||typeof i=="number"),this.setRGBA(e,t,s,i===void 0?1:i);return this}getRed(){return this.r}get red(){return this.getRed()}set red(e){this.setRed(e)}setRed(e){return this.setRGBA(e,this.g,this.b,this.a)}getGreen(){return this.g}get green(){return this.getGreen()}set green(e){this.setGreen(e)}setGreen(e){return this.setRGBA(this.r,e,this.b,this.a)}getBlue(){return this.b}get blue(){return this.getBlue()}set blue(e){this.setBlue(e)}setBlue(e){return this.setRGBA(this.r,this.g,e,this.a)}getAlpha(){return this.a}get alpha(){return this.getAlpha()}set alpha(e){this.setAlpha(e)}setAlpha(e){return this.setRGBA(this.r,this.g,this.b,e)}setRGBA(e,t,s,i){return this.r=Ve.roundSymmetric(Vs(e,0,255)),this.g=Ve.roundSymmetric(Vs(t,0,255)),this.b=Ve.roundSymmetric(Vs(s,0,255)),this.a=Vs(i,0,1),this.updateColor(),this}blend(e,t){const i=Math.pow(this.r,2.4),n=Math.pow(e.r,2.4),a=Math.pow(this.g,2.4),o=Math.pow(e.g,2.4),h=Math.pow(this.b,2.4),l=Math.pow(e.b,2.4),c=Math.pow(i+(n-i)*t,1/2.4),u=Math.pow(a+(o-a)*t,1/2.4),m=Math.pow(h+(l-h)*t,1/2.4),b=this.a+(e.a-this.a)*t;return new z(c,u,m,b)}computeCSS(){if(this.a===1)return`rgb(${this.r},${this.g},${this.b})`;{let e=this.a.toFixed(20);for(;e.length>=2&&e.endsWith("0")&&e[e.length-2]!==".";)e=e.slice(0,e.length-1);const t=this.a===0||this.a===1?this.a:e;return`rgba(${this.r},${this.g},${this.b},${t})`}}toCSS(){return assert&&assert(this._css===this.computeCSS(),`CSS cached value is ${this._css}, but the computed value appears to be ${this.computeCSS()}`),this._css}setCSS(e){let t=!1;const s=z.preprocessCSS(e);for(let i=0;i<z.formatParsers.length;i++){const n=z.formatParsers[i],a=n.regexp.exec(s);if(a){n.apply(this,a),t=!0;break}}if(!t)throw new Error(`Color unable to parse color string: ${e}`);return this.updateColor(),this}toNumber(){return(this.r<<16)+(this.g<<8)+this.b}updateColor(){assert&&assert(!this.immutable,"Cannot modify an immutable color. Likely caused by trying to mutate a color after it was used for a node fill/stroke"),assert&&assert(typeof this.red=="number"&&typeof this.green=="number"&&typeof this.blue=="number"&&typeof this.alpha=="number",`Ensure color components are numeric: ${this.toString()}`),assert&&assert(isFinite(this.red)&&isFinite(this.green)&&isFinite(this.blue)&&isFinite(this.alpha),"Ensure color components are finite and not NaN"),assert&&assert(this.red>=0&&this.red<=255&&this.green>=0&&this.green<=255&&this.red>=0&&this.red<=255&&this.alpha>=0&&this.alpha<=1,`Ensure color components are in the proper ranges: ${this.toString()}`);const e=this._css;this._css=this.computeCSS(),e!==this._css&&this.changeEmitter.emit()}setImmutable(){return assert&&(this.immutable=!0),this}getCanvasStyle(){return this.toCSS()}setHSLA(e,t,s,i){e=e%360/360,t=Vs(t/100,0,1),s=Vs(s/100,0,1);let n;s<.5?n=s*(t+1):n=s+t-s*t;const a=s*2-n;return this.r=Ve.roundSymmetric(z.hueToRGB(a,n,e+1/3)*255),this.g=Ve.roundSymmetric(z.hueToRGB(a,n,e)*255),this.b=Ve.roundSymmetric(z.hueToRGB(a,n,e-1/3)*255),this.a=Vs(i,0,1),this.updateColor(),this}equals(e){return this.r===e.r&&this.g===e.g&&this.b===e.b&&this.a===e.a}withAlpha(e){return new z(this.r,this.g,this.b,e)}checkFactor(e){return assert&&assert(e===void 0||e>=0&&e<=1,`factor must be between 0 and 1: ${e}`),e===void 0?.7:e}brighterColor(e){e=this.checkFactor(e);const t=Math.min(255,Math.floor(this.r/e)),s=Math.min(255,Math.floor(this.g/e)),i=Math.min(255,Math.floor(this.b/e));return new z(t,s,i,this.a)}colorUtilsBrighter(e){e=this.checkFactor(e);const t=Math.min(255,this.getRed()+Math.floor(e*(255-this.getRed()))),s=Math.min(255,this.getGreen()+Math.floor(e*(255-this.getGreen()))),i=Math.min(255,this.getBlue()+Math.floor(e*(255-this.getBlue())));return new z(t,s,i,this.getAlpha())}darkerColor(e){e=this.checkFactor(e);const t=Math.max(0,Math.floor(e*this.r)),s=Math.max(0,Math.floor(e*this.g)),i=Math.max(0,Math.floor(e*this.b));return new z(t,s,i,this.a)}colorUtilsDarker(e){e=this.checkFactor(e);const t=Math.max(0,this.getRed()-Math.floor(e*this.getRed())),s=Math.max(0,this.getGreen()-Math.floor(e*this.getGreen())),i=Math.max(0,this.getBlue()-Math.floor(e*this.getBlue()));return new z(t,s,i,this.getAlpha())}colorUtilsBrightness(e){return e===0?this:e>0?this.colorUtilsBrighter(e):this.colorUtilsDarker(-e)}toString(){return`${this.constructor.name}[r:${this.r} g:${this.g} b:${this.b} a:${this.a}]`}toHexString(){let e=this.toNumber().toString(16);for(;e.length<6;)e=`0${e}`;return`#${e}`}toStateObject(){return{r:this.r,g:this.g,b:this.b,a:this.a}}static hueToRGB(e,t,s){return s<0&&(s=s+1),s>1&&(s=s-1),s*6<1?e+(t-e)*s*6:s*2<1?t:s*3<2?e+(t-e)*(2/3-s)*6:e}static toColor(e){return e===null?z.TRANSPARENT:e instanceof z?e:typeof e=="string"?new z(e):z.toColor(e.value)}static interpolateRGBA(e,t,s){if(s<0||s>1)throw new Error(`distance must be between 0 and 1: ${s}`);const i=Math.floor(tr(0,1,e.r,t.r,s)),n=Math.floor(tr(0,1,e.g,t.g,s)),a=Math.floor(tr(0,1,e.b,t.b,s)),o=tr(0,1,e.a,t.a,s);return new z(i,n,a,o)}static supersampleBlend(e){const s=e.map(m=>Math.pow(m.r/255,2.2)),i=e.map(m=>Math.pow(m.g/255,2.2)),n=e.map(m=>Math.pow(m.b/255,2.2)),a=e.map(m=>Math.pow(m.a,2.2)),o=_.sum(a);if(o===0)return new z(0,0,0,0);const h=_.sum(_.range(0,e.length).map(m=>s[m]*a[m]))/o,l=_.sum(_.range(0,e.length).map(m=>i[m]*a[m]))/o,c=_.sum(_.range(0,e.length).map(m=>n[m]*a[m]))/o,u=o/e.length;return new z(Math.floor(Math.pow(h,1/2.2)*255),Math.floor(Math.pow(l,1/2.2)*255),Math.floor(Math.pow(c,1/2.2)*255),Math.pow(u,1/2.2))}static fromStateObject(e){return new z(e.r,e.g,e.b,e.a)}static hsla(e,t,s,i){return new z(0,0,0,1).setHSLA(e,t,s,i)}static checkPaintString(e){if(assert)try{wp.setCSS(e)}catch{assert(!1,`The CSS string is an invalid color: ${e}`)}}static checkPaint(e){typeof e=="string"?z.checkPaintString(e):O(e)&&typeof e.value=="string"&&z.checkPaintString(e.value)}static getLuminance(e){const t=z.toColor(e),s=t.red*.2126+t.green*.7152+t.blue*.0722;return assert&&assert(s>=0&&s<=255,`unexpected luminance: ${s}`),s}static toGrayscale(e){const t=z.getLuminance(e);return new z(t,t,t)}static isDarkColor(e,t=186){return assert&&assert(t>=0&&t<=255,"invalid luminanceThreshold"),z.getLuminance(e)<t}static isLightColor(e,t){return!z.isDarkColor(e,t)}static grayColor(e,t){return new z(e,e,e,t)}static preprocessCSS(e){let t=e.replace(/ /g,"").toLowerCase();const s=z.colorKeywords[t];return s&&(t=`#${s}`),t}static isCSSColorString(e){const t=z.preprocessCSS(e);for(let s=0;s<z.formatParsers.length;s++)if(z.formatParsers[s].regexp.exec(t))return!0;return!1}};z.formatParsers=[{regexp:/^transparent$/,apply:(e,t)=>{e.setRGBA(0,0,0,0)}},{regexp:/^#(\w{1})(\w{1})(\w{1})$/,apply:(e,t)=>{e.setRGBA(parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16),1)}},{regexp:/^#(\w{2})(\w{2})(\w{2})$/,apply:(e,t)=>{e.setRGBA(parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16),1)}},{regexp:new RegExp(`^rgb\\(${hi},${hi},${hi}\\)$`),apply:(e,t)=>{e.setRGBA(ci(t[1]),ci(t[2]),ci(t[3]),1)}},{regexp:new RegExp(`^rgba\\(${hi},${hi},${hi},${nl}\\)$`),apply:(e,t)=>{e.setRGBA(ci(t[1]),ci(t[2]),ci(t[3]),Number(t[4]))}},{regexp:new RegExp(`^hsl\\(${li},${li}%,${li}%\\)$`),apply:(e,t)=>{e.setHSLA(Number(t[1]),Number(t[2]),Number(t[3]),1)}},{regexp:new RegExp(`^hsla\\(${li},${li}%,${li}%,${nl}\\)$`),apply:(e,t)=>{e.setHSLA(Number(t[1]),Number(t[2]),Number(t[3]),Number(t[4]))}}],z.basicColorKeywords={aqua:"00ffff",black:"000000",blue:"0000ff",fuchsia:"ff00ff",gray:"808080",green:"008000",lime:"00ff00",maroon:"800000",navy:"000080",olive:"808000",purple:"800080",red:"ff0000",silver:"c0c0c0",teal:"008080",white:"ffffff",yellow:"ffff00"},z.colorKeywords={aliceblue:"f0f8ff",antiquewhite:"faebd7",aqua:"00ffff",aquamarine:"7fffd4",azure:"f0ffff",beige:"f5f5dc",bisque:"ffe4c4",black:"000000",blanchedalmond:"ffebcd",blue:"0000ff",blueviolet:"8a2be2",brown:"a52a2a",burlywood:"deb887",cadetblue:"5f9ea0",chartreuse:"7fff00",chocolate:"d2691e",coral:"ff7f50",cornflowerblue:"6495ed",cornsilk:"fff8dc",crimson:"dc143c",cyan:"00ffff",darkblue:"00008b",darkcyan:"008b8b",darkgoldenrod:"b8860b",darkgray:"a9a9a9",darkgreen:"006400",darkgrey:"a9a9a9",darkkhaki:"bdb76b",darkmagenta:"8b008b",darkolivegreen:"556b2f",darkorange:"ff8c00",darkorchid:"9932cc",darkred:"8b0000",darksalmon:"e9967a",darkseagreen:"8fbc8f",darkslateblue:"483d8b",darkslategray:"2f4f4f",darkslategrey:"2f4f4f",darkturquoise:"00ced1",darkviolet:"9400d3",deeppink:"ff1493",deepskyblue:"00bfff",dimgray:"696969",dimgrey:"696969",dodgerblue:"1e90ff",firebrick:"b22222",floralwhite:"fffaf0",forestgreen:"228b22",fuchsia:"ff00ff",gainsboro:"dcdcdc",ghostwhite:"f8f8ff",gold:"ffd700",goldenrod:"daa520",gray:"808080",green:"008000",greenyellow:"adff2f",grey:"808080",honeydew:"f0fff0",hotpink:"ff69b4",indianred:"cd5c5c",indigo:"4b0082",ivory:"fffff0",khaki:"f0e68c",lavender:"e6e6fa",lavenderblush:"fff0f5",lawngreen:"7cfc00",lemonchiffon:"fffacd",lightblue:"add8e6",lightcoral:"f08080",lightcyan:"e0ffff",lightgoldenrodyellow:"fafad2",lightgray:"d3d3d3",lightgreen:"90ee90",lightgrey:"d3d3d3",lightpink:"ffb6c1",lightsalmon:"ffa07a",lightseagreen:"20b2aa",lightskyblue:"87cefa",lightslategray:"778899",lightslategrey:"778899",lightsteelblue:"b0c4de",lightyellow:"ffffe0",lime:"00ff00",limegreen:"32cd32",linen:"faf0e6",magenta:"ff00ff",maroon:"800000",mediumaquamarine:"66cdaa",mediumblue:"0000cd",mediumorchid:"ba55d3",mediumpurple:"9370db",mediumseagreen:"3cb371",mediumslateblue:"7b68ee",mediumspringgreen:"00fa9a",mediumturquoise:"48d1cc",mediumvioletred:"c71585",midnightblue:"191970",mintcream:"f5fffa",mistyrose:"ffe4e1",moccasin:"ffe4b5",navajowhite:"ffdead",navy:"000080",oldlace:"fdf5e6",olive:"808000",olivedrab:"6b8e23",orange:"ffa500",orangered:"ff4500",orchid:"da70d6",palegoldenrod:"eee8aa",palegreen:"98fb98",paleturquoise:"afeeee",palevioletred:"db7093",papayawhip:"ffefd5",peachpuff:"ffdab9",peru:"cd853f",pink:"ffc0cb",plum:"dda0dd",powderblue:"b0e0e6",purple:"800080",red:"ff0000",rosybrown:"bc8f8f",royalblue:"4169e1",saddlebrown:"8b4513",salmon:"fa8072",sandybrown:"f4a460",seagreen:"2e8b57",seashell:"fff5ee",sienna:"a0522d",silver:"c0c0c0",skyblue:"87ceeb",slateblue:"6a5acd",slategray:"708090",slategrey:"708090",snow:"fffafa",springgreen:"00ff7f",steelblue:"4682b4",tan:"d2b48c",teal:"008080",thistle:"d8bfd8",tomato:"ff6347",turquoise:"40e0d0",violet:"ee82ee",wheat:"f5deb3",white:"ffffff",whitesmoke:"f5f5f5",yellow:"ffff00",yellowgreen:"9acd32"};let P=z;d.register("Color",P);P.BLACK=P.black=new P(0,0,0).setImmutable();P.BLUE=P.blue=new P(0,0,255).setImmutable();P.CYAN=P.cyan=new P(0,255,255).setImmutable();P.DARK_GRAY=P.darkGray=new P(64,64,64).setImmutable();P.GRAY=P.gray=new P(128,128,128).setImmutable();P.GREEN=P.green=new P(0,255,0).setImmutable();P.LIGHT_GRAY=P.lightGray=new P(192,192,192).setImmutable();P.MAGENTA=P.magenta=new P(255,0,255).setImmutable();P.ORANGE=P.orange=new P(255,200,0).setImmutable();P.PINK=P.pink=new P(255,175,175).setImmutable();P.RED=P.red=new P(255,0,0).setImmutable();P.WHITE=P.white=new P(255,255,255).setImmutable();P.YELLOW=P.yellow=new P(255,255,0).setImmutable();P.TRANSPARENT=P.transparent=new P(0,0,0,0).setImmutable();const wp=new P("blue");P.ColorIO=new Le("ColorIO",{valueType:P,documentation:"A color, with rgba",toStateObject:r=>r.toStateObject(),fromStateObject:r=>new P(r.r,r.g,r.b,r.a),stateSchema:{r:U,g:U,b:U,a:U}});const A={};d.register("Features",A);function Vr(r){try{const e=document.createElement("canvas");e.width=1,e.height=1;const t=e.getContext("2d");t.fillStyle="black",t.fillRect(0,0,1,1);const s=e.toDataURL([r]),i=`data:${r}`;return s.slice(0,i.length)===i}catch{return!1}}function Gr(r,e){const t=document.createElement("canvas");t.width=1,t.height=1;const s=t.getContext("2d"),i=document.createElement("img");i.crossOrigin="Anonymous";const n=()=>{try{s.drawImage(i,0,0),t.toDataURL(),A[r]=!0}catch{A[r]=!1}};i.onload=n;try{i.src=e,i.complete&&n()}catch{A[r]=!1}}A.canvasPNGOutput=Vr("image/png");A.canvasJPEGOutput=Vr("image/jpeg");A.canvasGIFOutput=Vr("image/gif");A.canvasICONOutput=Vr("image/x-icon");Gr("canvasPNGInput","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVQIW2NkYGD4DwABCQEBtxmN7wAAAABJRU5ErkJggg==");Gr("canvasJPEGInput","data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/2wBDAAMCAgICAgMCAgIDAwMDBAYEBAQEBAgGBgUGCQgKCgkICQkKDA8MCgsOCwkJDRENDg8QEBEQCgwSExIQEw8QEBD/2wBDAQMDAwQDBAgEBAgQCwkLEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBD/wAARCAABAAEDASIAAhEBAxEB/8QAHwAAAQUBAQEBAQEAAAAAAAAAAAECAwQFBgcICQoL/8QAtRAAAgEDAwIEAwUFBAQAAAF9AQIDAAQRBRIhMUEGE1FhByJxFDKBkaEII0KxwRVS0fAkM2JyggkKFhcYGRolJicoKSo0NTY3ODk6Q0RFRkdISUpTVFVWV1hZWmNkZWZnaGlqc3R1dnd4eXqDhIWGh4iJipKTlJWWl5iZmqKjpKWmp6ipqrKztLW2t7i5usLDxMXGx8jJytLT1NXW19jZ2uHi4+Tl5ufo6erx8vP09fb3+Pn6/8QAHwEAAwEBAQEBAQEBAQAAAAAAAAECAwQFBgcICQoL/8QAtREAAgECBAQDBAcFBAQAAQJ3AAECAxEEBSExBhJBUQdhcRMiMoEIFEKRobHBCSMzUvAVYnLRChYkNOEl8RcYGRomJygpKjU2Nzg5OkNERUZHSElKU1RVVldYWVpjZGVmZ2hpanN0dXZ3eHl6goOEhYaHiImKkpOUlZaXmJmaoqOkpaanqKmqsrO0tba3uLm6wsPExcbHyMnK0tPU1dbX2Nna4uPk5ebn6Onq8vP09fb3+Pn6/9oADAMBAAIRAxEAPwD8qqKKKAP/2Q==");Gr("canvasSVGInput","data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIj8+DQo8c3ZnIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2aWV3cG9ydD0iMCAwIDEgMSIgd2lkdGg9IjEiIGhlaWdodD0iMSIgPg0KICA8cmVjdCB4PSIwIiB5PSIwIiB3aWR0aD0iMSIgaGVpZ2h0PSIxIiByeD0iMCIgcnk9IjAiIHN0eWxlPSJmaWxsOiBibGFjazsgc3Ryb2tlOiBub25lOyI+PC9yZWN0Pg0KPC9zdmc+DQo=");Gr("canvasGIFInput","data:image/gif;base64,R0lGODlhAQABAJEAAAAAAP///////wAAACH5BAEAAAIALAAAAAABAAEAAAICRAEAOw==");const jc=document.createElement("canvas"),Kn=jc.getContext("2d");A.toDataURLHD=ue(jc,"toDataURLHD");A.createImageDataHD=ue(Kn,"createImageDataHD");A.getImageDataHD=ue(Kn,"getImageDataHD");A.putImageDataHD=ue(Kn,"putImageDataHD");A.currentTransform=ue(Kn,"currentTransform");A.canvasFilter=ue(Kn,"filter");const Fo=document.createElement("span"),qt=document.createElement("div");A.textStroke=ue(Fo.style,"textStroke");A.textStrokeColor=ue(Fo.style,"textStrokeColor");A.textStrokeWidth=ue(Fo.style,"textStrokeWidth");A.transform=ue(qt.style,"transform");A.transformOrigin=ue(qt.style,"transformOrigin");A.backfaceVisibility=ue(qt.style,"backfaceVisibility");A.borderRadius=ue(qt.style,"borderRadius");A.userSelect=ue(qt.style,"userSelect");A.touchAction=ue(qt.style,"touchAction");A.touchCallout=ue(qt.style,"touchCallout");A.userDrag=ue(qt.style,"userDrag");A.tapHighlightColor=ue(qt.style,"tapHighlightColor");A.fontSmoothing=ue(qt.style,"fontSmoothing");A.requestAnimationFrame=ue(window,"requestAnimationFrame");A.cancelAnimationFrame=ue(window,"cancelAnimationFrame");A.setStyle=(r,e,t)=>{e!==void 0&&(r.style[e]=t)};A.passive=!1;window.addEventListener("test",null,Object.defineProperty({},"passive",{get:()=>{A.passive=!0}}));const rl=["normal","italic","oblique"],al=["normal","small-caps"],ol=["normal","bold","bolder","lighter","100","200","300","400","500","600","700","800","900"],hl=["normal","ultra-condensed","extra-condensed","condensed","semi-condensed","semi-expanded","expanded","extra-expanded","ultra-expanded"],bt=class bt extends _e{constructor(e){assert&&assert(e===void 0||typeof e=="object"&&Object.getPrototypeOf(e)===Object.prototype,"options, if provided, should be a raw object");const t=E()({style:"normal",variant:"normal",weight:"normal",stretch:"normal",size:"10px",lineHeight:"normal",family:"sans-serif",phetioType:bt.FontIO},e);assert&&assert(typeof t.weight=="string"||typeof t.weight=="number","Font weight should be specified as a string or number"),assert&&assert(typeof t.size=="string"||typeof t.size=="number","Font size should be specified as a string or number"),super(t),this._style=t.style,this._variant=t.variant,this._weight=`${t.weight}`,this._stretch=t.stretch,this._size=bt.castSize(t.size),this._lineHeight=t.lineHeight,this._family=t.family,assert&&assert(typeof this._style=="string"&&_.includes(rl,this._style),'Font style must be one of "normal", "italic", or "oblique"'),assert&&assert(typeof this._variant=="string"&&_.includes(al,this._variant),'Font variant must be "normal" or "small-caps"'),assert&&assert(typeof this._weight=="string"&&_.includes(ol,this._weight),'Font weight must be one of "normal", "bold", "bolder", "lighter", "100", "200", "300", "400", "500", "600", "700", "800", or "900"'),assert&&assert(typeof this._stretch=="string"&&_.includes(hl,this._stretch),'Font stretch must be one of "normal", "ultra-condensed", "extra-condensed", "condensed", "semi-condensed", "semi-expanded", "expanded", "extra-expanded", or "ultra-expanded"'),assert&&assert(typeof this._size=="string"&&!_.includes(["0","1","2","3","4","5","6","7","8","9"],this._size[this._size.length-1]),"Font size must be either passed as a number (not a string, interpreted as px), or must contain a suffix for percentage, absolute or relative units, or an explicit size constant"),assert&&assert(typeof this._lineHeight=="string"),assert&&assert(typeof this._family=="string"),this._font=this.computeShorthand()}getFont(){return this._font}get font(){return this.getFont()}getStyle(){return this._style}get style(){return this.getStyle()}getVariant(){return this._variant}get variant(){return this.getVariant()}getWeight(){return this._weight}get weight(){return this.getWeight()}getStretch(){return this._stretch}get stretch(){return this.getStretch()}getSize(){return this._size}get size(){return this.getSize()}getNumericSize(){const e=this._size.match(/^(\d+)px$/);if(e)return Number(e[1]);const t=this._size.match(/^(\d+)pt$/);if(t)return .75*Number(t[1]);const s=this._size.match(/^(\d+)em$/);return s?Number(s[1])/16:12}get numericSize(){return this.getNumericSize()}getLineHeight(){return this._lineHeight}get lineHeight(){return this.getLineHeight()}getFamily(){return this._family}get family(){return this.getFamily()}copy(e){return new bt(pe({style:this._style,variant:this._variant,weight:this._weight,stretch:this._stretch,size:this._size,lineHeight:this._lineHeight,family:this._family},e))}computeShorthand(){let e="";return this._style!=="normal"&&(e+=`${this._style} `),this._variant!=="normal"&&(e+=`${this._variant} `),this._weight!=="normal"&&(e+=`${this._weight} `),this._stretch!=="normal"&&(e+=`${this._stretch} `),e+=this._size,this._lineHeight!=="normal"&&(e+=`/${this._lineHeight}`),e+=` ${this._family}`,e}toCSS(){return this.getFont()}static castSize(e){return typeof e=="number"?`${e}px`:e}static isFontStyle(e){return rl.includes(e)}static isFontVariant(e){return al.includes(e)}static isFontWeight(e){return ol.includes(e)}static isFontStretch(e){return hl.includes(e)}static fromCSS(e){const t={},s=_.filter(e.split(/[\x09\x0A\x0C\x0D\x20]/),i=>i.length>0);for(let i=0;i<s.length;i++){const n=s[i];if(n!=="normal")if(bt.isFontStyle(n))assert&&assert(t.style===void 0,`Style cannot be applied twice. Already set to "${t.style}", attempt to replace with "${n}"`),t.style=n;else if(bt.isFontVariant(n))assert&&assert(t.variant===void 0,`Variant cannot be applied twice. Already set to "${t.variant}", attempt to replace with "${n}"`),t.variant=n;else if(bt.isFontWeight(n))assert&&assert(t.weight===void 0,`Weight cannot be applied twice. Already set to "${t.weight}", attempt to replace with "${n}"`),t.weight=n;else if(bt.isFontStretch(n))assert&&assert(t.stretch===void 0,`Stretch cannot be applied twice. Already set to "${t.stretch}", attempt to replace with "${n}"`),t.stretch=n;else{const a=n.split(/\//);t.size=a[0],a[1]&&(t.lineHeight=a[1]),t.family=s.slice(i+1).join(" ");break}}return new bt(t)}};bt.DEFAULT=new bt;let xe=bt;d.register("Font",xe);xe.FontIO=new Le("FontIO",{valueType:xe,documentation:"Font handling for text drawing. Options:<ul><li><strong>style:</strong> normal      &mdash; normal | italic | oblique </li><li><strong>variant:</strong> normal    &mdash; normal | small-caps </li><li><strong>weight:</strong> normal     &mdash; normal | bold | bolder | lighter | 100 | 200 | 300 | 400 | 500 | 600 | 700 | 800 | 900 </li><li><strong>stretch:</strong> normal    &mdash; normal | ultra-condensed | extra-condensed | condensed | semi-condensed | semi-expanded | expanded | extra-expanded | ultra-expanded </li><li><strong>size:</strong> 10px         &mdash; absolute-size | relative-size | length | percentage -- unitless number interpreted as px. absolute suffixes: cm, mm, in, pt, pc, px. relative suffixes: em, ex, ch, rem, vw, vh, vmin, vmax. </li><li><strong>lineHeight:</strong> normal &mdash; normal | number | length | percentage -- NOTE: Canvas spec forces line-height to normal </li><li><strong>family:</strong> sans-serif &mdash; comma-separated list of families, including generic families (serif, sans-serif, cursive, fantasy, monospace). ideally escape with double-quotes</li></ul>",toStateObject:r=>({style:r.getStyle(),variant:r.getVariant(),weight:r.getWeight(),stretch:r.getStretch(),size:r.getSize(),lineHeight:r.getLineHeight(),family:r.getFamily()}),fromStateObject(r){return new xe(r)},stateSchema:{style:ge,variant:ge,weight:ge,stretch:ge,size:ge,lineHeight:ge,family:ge}});const p={};d.register("Renderer",p);p.numActiveRenderers=4;p.bitsPerRenderer=5;p.bitmaskRendererArea=255;p.bitmaskCurrentRendererArea=15;p.bitmaskLacksOffset=65536;p.bitmaskLacksShift=16;p.bitmaskNodeDefault=p.bitmaskRendererArea;p.bitmaskCanvas=1;p.bitmaskSVG=2;p.bitmaskDOM=4;p.bitmaskWebGL=8;p.bitmaskSingleCanvas=256;p.bitmaskSingleSVG=512;p.bitmaskNotPainted=4096;p.bitmaskBoundsValid=8192;p.bitmaskNoPDOM=16384;p.bitmaskLacksCanvas=p.bitmaskCanvas<<p.bitmaskLacksShift;p.bitmaskLacksSVG=p.bitmaskSVG<<p.bitmaskLacksShift;p.bitmaskLacksDOM=p.bitmaskDOM<<p.bitmaskLacksShift;p.bitmaskLacksWebGL=p.bitmaskWebGL<<p.bitmaskLacksShift;p.isCanvas=function(r){return(r&p.bitmaskCanvas)!==0};p.isSVG=function(r){return(r&p.bitmaskSVG)!==0};p.isDOM=function(r){return(r&p.bitmaskDOM)!==0};p.isWebGL=function(r){return(r&p.bitmaskWebGL)!==0};const Dp={canvas:p.bitmaskCanvas,svg:p.bitmaskSVG,dom:p.bitmaskDOM,webgl:p.bitmaskWebGL};p.fromName=function(r){return Dp[r]};p.stripBitmask=function(r){return r&p.bitmaskRendererArea};p.createOrderBitmask=function(r,e,t,s){return r=r||0,e=e||0,t=t||0,s=s||0,r|e<<5|t<<10|s<<15};p.bitmaskOrder=function(r,e){return e>0&&(r=r>>5*e),r&p.bitmaskCurrentRendererArea};p.bitmaskOrderFirst=function(r){return r&p.bitmaskCurrentRendererArea};p.bitmaskOrderSecond=function(r){return r>>5&p.bitmaskCurrentRendererArea};p.bitmaskOrderThird=function(r){return r>>10&p.bitmaskCurrentRendererArea};p.bitmaskOrderFourth=function(r){return r>>15&p.bitmaskCurrentRendererArea};p.pushOrderBitmask=function(r,e){assert&&assert(typeof r=="number"),assert&&assert(typeof e=="number");let t=e;const s=p.bitsPerRenderer*p.numActiveRenderers;for(let i=0;i<=s;i+=p.bitsPerRenderer){const n=r>>i&p.bitmaskCurrentRendererArea;if(n===t)return r;if(n===0)return r=r|t<<i,r;if(r=r&~(p.bitmaskCurrentRendererArea<<i),r=r|t<<i,t=n,t===e)return r}throw new Error("pushOrderBitmask overflow")};p.createSelfDrawable=function(r,e,t,s){let i;if(p.isCanvas(t))i=e.createCanvasDrawable(t,r);else if(p.isSVG(t))i=e.createSVGDrawable(t,r);else if(p.isDOM(t))i=e.createDOMDrawable(t,r);else if(p.isWebGL(t))i=e.createWebGLDrawable(t,r);else throw new Error(`Unrecognized renderer: ${t}`);return assert&&_.each(e.drawableMarkFlags,n=>{const a=`markDirty${n[0].toUpperCase()}${n.slice(1)}`;assert(typeof i[a]=="function",`Did not find ${a}`)}),i.setFittable(s),i};p.webglCustom=1;p.webglTexturedTriangles=2;p.webglVertexColorPolygons=3;const ne="http://www.w3.org/2000/svg";d.register("svgns",ne);const vi="http://www.w3.org/1999/xlink";d.register("xlinkns",vi);function ms(r,e){return new T(r,e)}const aa=A.transform,Tp=A.transformOrigin||"transformOrigin";let ll=!0,oa;const Y={prepareForTransform(r){r.style[Tp]="top left"},applyPreparedTransform(r,e){e.style[aa]=r.getCSSTransform()},setTransform(r,e){e.style[aa]=r},unsetTransform(r){r.style[aa]=""},polyfillRequestAnimationFrame(){(!window.requestAnimationFrame||!window.cancelAnimationFrame)&&(!A.requestAnimationFrame||!A.cancelAnimationFrame?(window.requestAnimationFrame=r=>{const e=Date.now();return window.setTimeout(()=>{r(Date.now()-e)},16)},window.cancelAnimationFrame=clearTimeout):(window.requestAnimationFrame=window[A.requestAnimationFrame],window.cancelAnimationFrame=window[A.cancelAnimationFrame]))},backingStorePixelRatio(r){return r.webkitBackingStorePixelRatio||r.mozBackingStorePixelRatio||r.msBackingStorePixelRatio||r.oBackingStorePixelRatio||r.backingStorePixelRatio||1},backingScale(r){if("devicePixelRatio"in window){const e=Y.backingStorePixelRatio(r);return window.devicePixelRatio/e}return 1},supportsNativeCanvasFilter(){return!!A.canvasFilter},supportsImageDataCanvasFilter(){return Y.backingStorePixelRatio(d.scratchContext)===1},scanBounds(r,e,t){const s=_.map(_.range(e),()=>!1),i=_.map(_.range(e),()=>!1);for(let c=0;c<e;c++)for(let u=0;u<e;u++){const m=4*(u*e+c);(r.data[m]!==0||r.data[m+1]!==0||r.data[m+2]!==0||r.data[m+3]!==0)&&(s[c]=!0,i[u]=!0)}const n=_.indexOf(s,!0),a=_.lastIndexOf(s,!0),o=_.indexOf(i,!0),h=_.lastIndexOf(i,!0),l=e/16;return{minBounds:new w(n<1||n>=e-1?Number.POSITIVE_INFINITY:t.inversePosition2(ms(n+1+l,0)).x,o<1||o>=e-1?Number.POSITIVE_INFINITY:t.inversePosition2(ms(0,o+1+l)).y,a<1||a>=e-1?Number.NEGATIVE_INFINITY:t.inversePosition2(ms(a-l,0)).x,h<1||h>=e-1?Number.NEGATIVE_INFINITY:t.inversePosition2(ms(0,h-l)).y),maxBounds:new w(n<1||n>=e-1?Number.NEGATIVE_INFINITY:t.inversePosition2(ms(n-1-l,0)).x,o<1||o>=e-1?Number.NEGATIVE_INFINITY:t.inversePosition2(ms(0,o-1-l)).y,a<1||a>=e-1?Number.POSITIVE_INFINITY:t.inversePosition2(ms(a+2+l,0)).x,h<1||h>=e-1?Number.POSITIVE_INFINITY:t.inversePosition2(ms(0,h+2+l)).y)}},canvasAccurateBounds(r,e){const t=e&&e.precision?e.precision:.001,s=e&&e.resolution?e.resolution:128,i=e&&e.initialScale?e.initialScale:1/16;let n=w.NOTHING,a=w.EVERYTHING;const o=document.createElement("canvas");o.width=s,o.height=s;const h=o.getContext("2d");function l(v){h.save(),v.matrix.canvasSetTransform(h),r(h),h.restore();const S=h.getImageData(0,0,s,s),B=Y.scanBounds(S,s,v);return h.clearRect(0,0,s,s),B}function c(v){const B=(s-4)/(v.maxX-v.minX),ce=(s-2*2)/(v.maxY-v.minY),fe=-B*v.minX+2,k=-ce*v.minY+2;return new Bt(C.translation(fe,k).timesMatrix(C.scaling(B,ce)))}const u=new Bt;u.append(C.translation(s/2,s/2)),u.append(C.scaling(i));const m=l(u);n=n.union(m.minBounds),a=a.intersection(m.maxBounds);let b,y,f;for(b=a.minY,y=a.maxY;isFinite(n.minX)&&isFinite(a.minX)&&Math.abs(n.minX-a.minX)>t&&(f=l(c(new w(a.minX,b,n.minX,y))),!(n.minX<=f.minBounds.minX&&a.minX>=f.maxBounds.minX));)n=n.withMinX(Math.min(n.minX,f.minBounds.minX)),a=a.withMinX(Math.max(a.minX,f.maxBounds.minX)),b=Math.max(b,f.maxBounds.minY),y=Math.min(y,f.maxBounds.maxY);for(b=a.minY,y=a.maxY;isFinite(n.maxX)&&isFinite(a.maxX)&&Math.abs(n.maxX-a.maxX)>t&&(f=l(c(new w(n.maxX,b,a.maxX,y))),!(n.maxX>=f.minBounds.maxX&&a.maxX<=f.maxBounds.maxX));)n=n.withMaxX(Math.max(n.maxX,f.minBounds.maxX)),a=a.withMaxX(Math.min(a.maxX,f.maxBounds.maxX)),b=Math.max(b,f.maxBounds.minY),y=Math.min(y,f.maxBounds.maxY);for(b=a.minX,y=a.maxX;isFinite(n.minY)&&isFinite(a.minY)&&Math.abs(n.minY-a.minY)>t&&(f=l(c(new w(b,a.minY,y,n.minY))),!(n.minY<=f.minBounds.minY&&a.minY>=f.maxBounds.minY));)n=n.withMinY(Math.min(n.minY,f.minBounds.minY)),a=a.withMinY(Math.max(a.minY,f.maxBounds.minY)),b=Math.max(b,f.maxBounds.minX),y=Math.min(y,f.maxBounds.maxX);for(b=a.minX,y=a.maxX;isFinite(n.maxY)&&isFinite(a.maxY)&&Math.abs(n.maxY-a.maxY)>t&&(f=l(c(new w(b,n.maxY,y,a.maxY))),!(n.maxY>=f.minBounds.maxY&&a.maxY<=f.maxBounds.maxY));)n=n.withMaxY(Math.max(n.maxY,f.minBounds.maxY)),a=a.withMaxY(Math.min(a.maxY,f.maxBounds.maxY)),b=Math.max(b,f.maxBounds.minX),y=Math.min(y,f.maxBounds.maxX);const L=new w(isFinite(n.minX)&&isFinite(a.minX)?(n.minX+a.minX)/2:Number.POSITIVE_INFINITY,isFinite(n.minY)&&isFinite(a.minY)?(n.minY+a.minY)/2:Number.POSITIVE_INFINITY,isFinite(n.maxX)&&isFinite(a.maxX)?(n.maxX+a.maxX)/2:Number.NEGATIVE_INFINITY,isFinite(n.maxY)&&isFinite(a.maxY)?(n.maxY+a.maxY)/2:Number.NEGATIVE_INFINITY);return L.minBounds=n,L.maxBounds=a,L.isConsistent=a.containsBounds(n),L.precision=Math.max(Math.abs(n.minX-a.minX),Math.abs(n.minY-a.minY),Math.abs(n.maxX-a.maxX),Math.abs(n.maxY-a.maxY)),L},toPowerOf2(r){let e=1;for(;e<r;)e*=2;return e},createShader(r,e,t){const s=r.createShader(t);return r.shaderSource(s,e),r.compileShader(s),r.getShaderParameter(s,r.COMPILE_STATUS)||(console.log("GLSL compile error:"),console.log(r.getShaderInfoLog(s)),console.log(e)),s},applyWebGLContextDefaults(r){r.clearColor(0,0,0,0),r.enable(r.BLEND),r.blendFunc(r.ONE,r.ONE_MINUS_SRC_ALPHA)},setWebGLEnabled(r){ll=r},checkWebGLSupport(r){if(!ll)return!1;const e=document.createElement("canvas"),t={failIfMajorPerformanceCaveat:!0};try{const s=!!window.WebGLRenderingContext&&(e.getContext("webgl",t)||e.getContext("experimental-webgl",t));if(!s)return!1;if(r){for(let i=0;i<r.length;i++)if(s.getExtension(r[i])===null)return!1}return!0}catch{return!1}},checkIE11StencilSupport(){const r=document.createElement("canvas");try{const e=!!window.WebGLRenderingContext&&(r.getContext("webgl")||r.getContext("experimental-webgl"));return e?(e.clearStencil(0),e.getError()===0):!1}catch{return!1}},get isWebGLSupported(){return oa===void 0&&(oa=Y.checkWebGLSupport()),oa},loseContext(r){const e=r.getExtension("WEBGL_lose_context");e&&(e.loseContext(),setTimeout(()=>{e.restoreContext()},1e3))},safariEmbeddingMarkWorkaround(r){if(Te.safari){const e=r.split("");let t="",s=!1;for(let i=0;i<e.length;i++){const n=e[i],a=n==="‪"||n==="‫"||n==="‬";s&&a&&(t+="​"),t+=n,s=a}return t}else return r}};d.register("Utils",Y);const Ar=class Ar{constructor(e,t){this.display=e,this.trail=t}};Ar.FocusIO=new Le("FocusIO",{valueType:Ar,documentation:"A PhET-iO Type for the instance in the simulation which currently has keyboard focus. FocusIO is serialized into and Object with key `focusedPhetioElement` that is a list of PhET-iO Elements, from parent-most to child-most corresponding to the PhET-iO Element that was instrumented.",toStateObject:e=>{const t=[];return e.trail.nodes.forEach((s,i)=>{s.isPhetioInstrumented()&&t.push(s.tandem.phetioID)}),{focusedPhetioElement:t}},stateSchema:{focusedPhetioElement:Un(ge)}});let Nt=Ar;d.register("Focus",Nt);const qc="ArrowRight",Qc="ArrowLeft",Zc="ArrowUp",Jc="ArrowDown",Ho="ShiftRight",Vo="ShiftLeft",Go="ControlLeft",zo="ControlRight",Wo="AltLeft",$o="AltRight",Uo="MetaLeft",Yo="MetaRight",Ko="OSLeft",Xo="OSRight",Cp="KeyW",Ip="KeyA",Ep="KeyS",kp="KeyD",ed="Digit0",td="Digit1",sd="Digit2",id="Digit3",nd="Digit4",rd="Digit5",ad="Digit6",od="Digit7",hd="Digit8",ld="Digit9",Za="Alt",Ja="Shift",eo="Control",ha=[qc,Qc,Zc,Jc],la=[Cp,Ep,Ip,kp],Ap=[ed,td,sd,id,nd,rd,ad,od,hd,ld],ca=[Vo,Ho],da=[Go,zo],ua=[Wo,$o],cl=[Uo,Yo,Ko,Xo],xp=[Za,eo,Ja],Op=[Wo,$o,Go,zo,Vo,Ho,Uo,Yo,Ko,Xo],Mp={valueType:Event},to=[],g={KEY_SPACE:"Space",KEY_ENTER:"Enter",KEY_TAB:"Tab",KEY_RIGHT_ARROW:qc,KEY_LEFT_ARROW:Qc,KEY_UP_ARROW:Zc,KEY_DOWN_ARROW:Jc,KEY_SHIFT_LEFT:Vo,KEY_SHIFT_RIGHT:Ho,KEY_ALT_LEFT:Wo,KEY_ALT_RIGHT:$o,KEY_CONTROL_LEFT:Go,KEY_CONTROL_RIGHT:zo,KEY_META_LEFT:Uo,KEY_META_RIGHT:Yo,KEY_META_LEFT_FIREFOX:Ko,KEY_META_RIGHT_FIREFOX:Xo,KEY_SHIFT:Ja,KEY_ALT:Za,KEY_CONTROL:eo,KEY_ESCAPE:"Escape",KEY_DELETE:"Delete",KEY_BACKSPACE:"Backspace",KEY_PAGE_UP:"PageUp",KEY_PAGE_DOWN:"PageDown",KEY_END:"End",KEY_HOME:"Home",KEY_0:ed,KEY_1:td,KEY_2:sd,KEY_3:id,KEY_4:nd,KEY_5:rd,KEY_6:ad,KEY_7:od,KEY_8:hd,KEY_9:ld,KEY_NUMPAD_0:"Numpad0",KEY_NUMPAD_1:"Numpad1",KEY_NUMPAD_2:"Numpad2",KEY_NUMPAD_3:"Numpad3",KEY_NUMPAD_4:"Numpad4",KEY_NUMPAD_5:"Numpad5",KEY_NUMPAD_6:"Numpad6",KEY_NUMPAD_7:"Numpad7",KEY_NUMPAD_8:"Numpad8",KEY_NUMPAD_9:"Numpad9",KEY_NUMPAD_DECIMAL:"NumpadDecimal",KEY_NUMPAD_PLUS:"NumpadAdd",KEY_NUMPAD_MINUS:"NumpadSubtract",KEY_A:"KeyA",KEY_B:"KeyB",KEY_C:"KeyC",KEY_D:"KeyD",KEY_E:"KeyE",KEY_F:"KeyF",KEY_G:"KeyG",KEY_H:"KeyH",KEY_I:"KeyI",KEY_J:"KeyJ",KEY_K:"KeyK",KEY_L:"KeyL",KEY_M:"KeyM",KEY_N:"KeyN",KEY_O:"KeyO",KEY_P:"KeyP",KEY_Q:"KeyQ",KEY_R:"KeyR",KEY_S:"KeyS",KEY_T:"KeyT",KEY_U:"KeyU",KEY_V:"KeyV",KEY_W:"KeyW",KEY_X:"KeyX",KEY_Y:"KeyY",KEY_Z:"KeyZ",KEY_EQUALS:"Equal",KEY_PLUS:"Equal",KEY_MINUS:"Minus",KEY_PERIOD:"Period",ARROW_KEYS:ha,WASD_KEYS:la,MOVEMENT_KEYS:ha.concat(la),SHIFT_KEYS:ca,CONTROL_KEYS:da,ALT_KEYS:ua,META_KEYS:cl,MODIFIER_KEY_CODES:Op,MODIFIER_KEY_TO_CODE_MAP:new Map([[Za,ua],[Ja,ca],[eo,da]]),isArrowKey(r){return g.isAnyKeyEvent(r,ha)},isRangeKey(r){return g.isArrowKey(r)||g.isAnyKeyEvent(r,[g.KEY_PAGE_UP,g.KEY_PAGE_DOWN,g.KEY_HOME,g.KEY_END])},isNumberKey(r){return g.isAnyKeyEvent(r,Ap)},getNumberFromCode(r){return g.isNumberKey(r)&&r instanceof KeyboardEvent?Number(r.code.replace("Digit","")):null},isShiftKey(r){return g.isAnyKeyEvent(r,ca)},isAltKey(r){return g.isAnyKeyEvent(r,ua)},isControlKey(r){return g.isAnyKeyEvent(r,da)},isMetaKey(r){return g.isAnyKeyEvent(r,cl)},isWASDKey(r){return g.isAnyKeyEvent(r,la)},isMovementKey(r){return g.isAnyKeyEvent(r,g.MOVEMENT_KEYS)},isAnyKeyEvent(r,e){Es(r,Mp);const t=g.getEventCode(r);return t?e.includes(t):!1},isKeyEvent(r,e){return g.getEventCode(r)===e},getEventCode(r){let e=null;return r instanceof KeyboardEvent&&r.code&&(e=r.code,e.startsWith("Numpad")&&to.includes(r.key)&&(e=r.key)),e},isModifierKey(r){return xp.includes(r)},ALL_KEYS:to};for(const r in g)g.hasOwnProperty(r)&&typeof g[r]=="string"&&to.push(g[r]);d.register("KeyboardUtils",g);const Qs={q:[g.KEY_Q],w:[g.KEY_W],e:[g.KEY_E],r:[g.KEY_R],t:[g.KEY_T],y:[g.KEY_Y],u:[g.KEY_U],i:[g.KEY_I],o:[g.KEY_O],p:[g.KEY_P],a:[g.KEY_A],s:[g.KEY_S],d:[g.KEY_D],f:[g.KEY_F],g:[g.KEY_G],h:[g.KEY_H],j:[g.KEY_J],k:[g.KEY_K],l:[g.KEY_L],z:[g.KEY_Z],x:[g.KEY_X],c:[g.KEY_C],v:[g.KEY_V],b:[g.KEY_B],n:[g.KEY_N],m:[g.KEY_M],0:[g.KEY_0,g.KEY_NUMPAD_0],1:[g.KEY_1,g.KEY_NUMPAD_1],2:[g.KEY_2,g.KEY_NUMPAD_2],3:[g.KEY_3,g.KEY_NUMPAD_3],4:[g.KEY_4,g.KEY_NUMPAD_4],5:[g.KEY_5,g.KEY_NUMPAD_5],6:[g.KEY_6,g.KEY_NUMPAD_6],7:[g.KEY_7,g.KEY_NUMPAD_7],8:[g.KEY_8,g.KEY_NUMPAD_8],9:[g.KEY_9,g.KEY_NUMPAD_9],enter:[g.KEY_ENTER],tab:[g.KEY_TAB],equals:[g.KEY_EQUALS],plus:[g.KEY_PLUS,g.KEY_NUMPAD_PLUS],minus:[g.KEY_MINUS,g.KEY_NUMPAD_MINUS],period:[g.KEY_PERIOD,g.KEY_NUMPAD_DECIMAL],escape:[g.KEY_ESCAPE],delete:[g.KEY_DELETE],backspace:[g.KEY_BACKSPACE],pageUp:[g.KEY_PAGE_UP],pageDown:[g.KEY_PAGE_DOWN],end:[g.KEY_END],home:[g.KEY_HOME],space:[g.KEY_SPACE],arrowLeft:[g.KEY_LEFT_ARROW],arrowRight:[g.KEY_RIGHT_ARROW],arrowUp:[g.KEY_UP_ARROW],arrowDown:[g.KEY_DOWN_ARROW],ctrl:g.CONTROL_KEYS,alt:g.ALT_KEYS,shift:g.SHIFT_KEYS,meta:g.META_KEYS};d.register("EnglishStringToCodeMap",Qs);const Rp=["ctrl","alt","shift","meta"],cd=r=>{for(const e in Qs)if(Qs.hasOwnProperty(e)&&Qs[e].includes(r))return e;return null},Ts=new Le("BooleanIO",{supertype:Kc,valueType:"boolean",documentation:"PhET-iO Type for Javascript's boolean primitive type",stateSchema:Mo.asValue("boolean",{valueType:"boolean"}),toStateObject:_.identity});Hs.register("BooleanIO",Ts);const dl=r=>Object.getPrototypeOf(r)===Object.prototype,so=new Le("ObjectLiteralIO",{documentation:"PhET-iO Type for object literals",isValidValue:dl,supertype:Kc,stateSchema:Mo.asValue("object",{valueType:Object,isValidValue:dl}),toStateObject:_.identity});Hs.register("ObjectLiteralIO",so);const xs=new Le("EventIO",{valueType:window.Event,documentation:"A DOM Event",toStateObject:r=>us.serializeDomEvent(r),fromStateObject:r=>us.deserializeDomEvent(r),stateSchema:()=>({constructorName:ge,altKey:V(Ts),button:V(U),charCode:V(U),clientX:V(U),clientY:V(U),code:V(ge),ctrlKey:V(Ts),deltaMode:V(U),deltaX:V(U),deltaY:V(U),deltaZ:V(U),key:V(ge),keyCode:V(U),metaKey:V(Ts),pageX:V(U),pageY:V(U),pointerId:V(U),pointerType:V(ge),scale:V(U),shiftKey:V(Ts),target:V(so),type:V(ge),relatedTarget:V(so),which:V(U)})});d.register("EventIO",xs);const jo=document.createElement("style");jo.type="text/css";document.head.appendChild(jo);const dd=document.styleSheets[document.styleSheets.length-1];assert&&assert(dd.disabled===!1);const zr={stylesheet:dd,styleElement:jo,addRule(r){this.stylesheet.insertRule(r,0)}};d.register("SceneryStyle",zr);class ks{constructor(e,t){this.canvas=e,this.context=t,this.resetStyles()}resetStyles(){this.fillStyle=void 0,this.strokeStyle=void 0,this.lineWidth=void 0,this.lineCap=void 0,this.lineJoin=void 0,this.lineDash=void 0,this.lineDashOffset=void 0,this.miterLimit=void 0,this.font=void 0,this.direction=void 0}setDimensions(e,t){this.canvas.width=e,this.canvas.height=t,this.resetStyles()}setFillStyle(e){e&&O(e)&&(e=e.value),e&&e.getCanvasStyle&&(e=e.getCanvasStyle()),this.fillStyle!==e&&(this.fillStyle=e,this.context.fillStyle=e)}setStrokeStyle(e){e&&O(e)&&(e=e.value),e&&e.getCanvasStyle&&(e=e.getCanvasStyle()),this.strokeStyle!==e&&(this.strokeStyle=e,this.context.strokeStyle=e)}setLineWidth(e){this.lineWidth!==e&&(this.lineWidth=e,this.context.lineWidth=e)}setLineCap(e){this.lineCap!==e&&(this.lineCap=e,this.context.lineCap=e)}setLineJoin(e){this.lineJoin!==e&&(this.lineJoin=e,this.context.lineJoin=e)}setMiterLimit(e){assert&&assert(typeof e=="number"),this.miterLimit!==e&&(this.miterLimit=e,this.context.miterLimit=e)}setLineDash(e){assert&&assert(e!==void 0,"undefined line dash would cause hard-to-trace errors"),this.lineDash!==e&&(this.lineDash=e,this.context.setLineDash?this.context.setLineDash(e===null?[]:e):this.context.mozDash!==void 0?this.context.mozDash=e:this.context.webkitLineDash!==void 0&&(this.context.webkitLineDash=e||[]))}setLineDashOffset(e){this.lineDashOffset!==e&&(this.lineDashOffset=e,this.context.lineDashOffset!==void 0?this.context.lineDashOffset=e:this.context.webkitLineDashOffset!==void 0&&(this.context.webkitLineDashOffset=e))}setFont(e){this.font!==e&&(this.font=e,this.context.font=e)}setDirection(e){this.direction!==e&&(this.direction=e,this.context.direction=e)}}d.register("CanvasContextWrapper",ks);const ul=ue(document,"exitFullscreen")||ue(document,"cancelFullScreen"),Np=ue(document,"fullscreenElement")||ue(document,"fullScreenElement"),Bp=ue(document,"fullscreenEnabled")||ue(document,"fullScreenEnabled");let io=Lp(document,"fullscreenchange");io==="msfullscreenchange"&&(io="MSFullscreenChange");const Zs={isFullScreen(){return!!document[Np]},isFullScreenEnabled(){return document[Bp]&&!Te.safari7},enterFullScreen(r){const e=ue(document.body,"requestFullscreen")||ue(document.body,"requestFullScreen");r.domElement[e]&&r.domElement[e]()},exitFullScreen(){document[ul]&&document[ul]()},toggleFullScreen(r){Zs.isFullScreen()?Zs.exitFullScreen():Zs.enterFullScreen(r)},isFullScreenProperty:new me(!1)};document.addEventListener(io,r=>{Zs.isFullScreenProperty.set(Zs.isFullScreen())});d.register("FullScreen",Zs);const Fp=Zs;class ud{constructor(e,t){this.create=e,this.destroy=t,this.map=new Map}increment(e,t=1){if(assert&&assert(typeof t=="number"),assert&&assert(t>=1),this.map.has(e))this.map.get(e).count+=t;else{const s=this.create(e),i=no.createFromPool(t,e,s);this.map.set(e,i)}}decrement(e,t=1){assert&&assert(typeof t=="number"),assert&&assert(t>=1);const s=this.map.get(e);s&&(s.count-=t,s.count<1&&(this.destroy(e,s.value),this.map.delete(e),s.dispose()))}get(e){return this.map.get(e).value}clear(){this.map.clear()}}class no{constructor(e,t,s){this.initialize(e,t,s)}initialize(e,t,s){this.count=e,this.key=t,this.value=s}dispose(){this.key=null,this.value=null,this.freeToPool()}}ae.mixInto(no,{initialize:no.prototype.initialize});d.register("CountMap",ud);class pd extends X{constructor(e,t){const s=E()({display:null,followPdomOrder:!1,requireVisible:!0,requirePdomVisible:!1,requireEnabled:!1,requireInputEnabled:!1},t);super([]),this.listenedNodeSet=new Set,this.node=e,this.display=s.display,this.followPdomOrder=s.followPdomOrder,this.requireVisible=s.requireVisible,this.requirePdomVisible=s.requirePdomVisible,this.requireEnabled=s.requireEnabled,this.requireInputEnabled=s.requireInputEnabled,this._trailUpdateListener=this.update.bind(this),this.update()}update(){const e=this.display,t=this.followPdomOrder,s=this.requireVisible,i=this.requirePdomVisible,n=this.requireEnabled,a=this.requireInputEnabled,o=[],h=new Set,l=new R(this.node);(function m(){const b=l.rootNode();if(b.isDisposed||(h.add(b),s&&!b.visible||i&&!b.pdomVisible||n&&!b.enabled||a&&!b.inputEnabled))return;const y=b.getRootedDisplays();let f;e===null?f=y.length>0:e instanceof Be?f=y.includes(e):f=y.some(e),f&&o.push(l.copy()),(t&&b.pdomParent?[b.pdomParent]:b.parents).forEach(v=>{l.addAncestor(v),m(),l.removeAncestor()})})(),h.forEach(m=>{this.listenedNodeSet.has(m)||this.addNodeListener(m)}),this.listenedNodeSet.forEach(m=>{h.has(m)||this.removeNodeListener(m)});const c=this.value;let u=c.length===o.length;if(u){for(let m=0;m<o.length;m++)if(!c[m].equals(o[m])){u=!1;break}}u||(this.value=o)}addNodeListener(e){this.listenedNodeSet.add(e),e.parentAddedEmitter.addListener(this._trailUpdateListener),e.parentRemovedEmitter.addListener(this._trailUpdateListener),e.rootedDisplayChangedEmitter.addListener(this._trailUpdateListener),e.disposeEmitter.addListener(this._trailUpdateListener),this.followPdomOrder&&e.pdomParentChangedEmitter.addListener(this._trailUpdateListener),this.requireVisible&&e.visibleProperty.lazyLink(this._trailUpdateListener),this.requirePdomVisible&&e.pdomVisibleProperty.lazyLink(this._trailUpdateListener),this.requireEnabled&&e.enabledProperty.lazyLink(this._trailUpdateListener),this.requireInputEnabled&&e.inputEnabledProperty.lazyLink(this._trailUpdateListener)}removeNodeListener(e){this.listenedNodeSet.delete(e),e.parentAddedEmitter.removeListener(this._trailUpdateListener),e.parentRemovedEmitter.removeListener(this._trailUpdateListener),e.rootedDisplayChangedEmitter.removeListener(this._trailUpdateListener),e.disposeEmitter.removeListener(this._trailUpdateListener),this.followPdomOrder&&e.pdomParentChangedEmitter.removeListener(this._trailUpdateListener),this.requireVisible&&e.visibleProperty.unlink(this._trailUpdateListener),this.requirePdomVisible&&e.pdomVisibleProperty.unlink(this._trailUpdateListener),this.requireEnabled&&e.enabledProperty.unlink(this._trailUpdateListener),this.requireInputEnabled&&e.inputEnabledProperty.unlink(this._trailUpdateListener)}dispose(){this.listenedNodeSet.forEach(e=>this.removeNodeListener(e)),super.dispose()}}d.register("DisplayedTrailsProperty",pd);const Hp="DerivedPropertyIO",pl=_.hasIn(window,"phet.chipper.queryParameters")&&phet.chipper.queryParameters.strictAxonDependencies;function pa(r,e,t){assert&&pl&&r&&el.push(t);try{return e(...t.map(s=>s.get()))}finally{assert&&pl&&r&&el.pop()}}class be extends ft{constructor(e,t,s){const i=E()({phetioReadOnly:!0,phetioOuterType:be.DerivedPropertyIO,phetioLinkDependencies:!0,strictAxonDependencies:!0},s);assert&&assert(e.every(_.identity),"dependencies should all be truthy"),assert&&assert(e.length===_.uniq(e).length,"duplicate dependencies");const n=pa(i.strictAxonDependencies,t,e);super(n,i),se.VALIDATION&&this.isPhetioInstrumented()&&assert&&assert(this.phetioType.typeName.startsWith("DerivedPropertyIO"),"phetioType should be DerivedPropertyIO"),this.dependencies=e,this.derivation=t,this.strictAxonDependencies=i.strictAxonDependencies,this.derivedPropertyListener=this.getDerivedPropertyListener.bind(this),e.forEach(a=>{if(a.lazyLink(this.derivedPropertyListener),se.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&a instanceof _e&&a.isPhetioInstrumented()&&(a instanceof ft&&up.registerPhetioOrderDependency(a,Jh.UNDEFER,this,Jh.UNDEFER),i.tandem&&i.phetioLinkDependencies)){const o=i.tandem.createTandem("dependencies");this.addLinkedElement(a,{tandem:o.createTandemFromPhetioID(a.tandem.phetioID)})}})}hasDependency(e){return this.definedDependencies.includes(e)}get definedDependencies(){return assert&&assert(this.dependencies!==null,"Dependencies should be defined, has this Property been disposed?"),this.dependencies}getDerivedPropertyListener(){this.isDisposed||(this.isDeferred?this.hasDeferredValue=!0:super.set(pa(this.strictAxonDependencies,this.derivation,this.definedDependencies)))}recomputeDerivation(){this.getDerivedPropertyListener()}dispose(){const e=this.definedDependencies;for(let t=0;t<e.length;t++){const s=e[t];s.hasListener(this.derivedPropertyListener)&&s.unlink(this.derivedPropertyListener)}this.dependencies=null,super.dispose()}setDeferred(e){return this.isDeferred&&!e&&(this.deferredValue=pa(this.strictAxonDependencies,this.derivation,this.definedDependencies)),super.setDeferred(e)}static valueEquals(e,t,s){return new be([e,t],(i,n)=>i===n,s)}static valueEqualsConstant(e,t,s){return new be([e],i=>i===t,s)}static and(e,t){return assert&&assert(e.length>0,"must provide a dependency"),be.deriveAny(e,()=>_.reduce(e,Vp,!0),t)}static or(e,t){return assert&&assert(e.length>0,"must provide a dependency"),be.deriveAny(e,()=>_.reduce(e,Gp,!1),t)}static multiply(e,t){return assert&&assert(e.length>0,"must provide a dependency"),be.deriveAny(e,()=>_.reduce(e,zp,1),t)}static add(e,t){return assert&&assert(e.length>0,"must provide a dependency"),be.deriveAny(e,()=>_.reduce(e,Wp,0),t)}static not(e,t){return new be([e],s=>!s,t)}static deriveAny(e,t,s){return new be(e,t,s)}}const Vp=(r,e)=>r&&e.value,Gp=(r,e)=>(assert&&assert(typeof e.value=="boolean","boolean value required"),r||e.value),zp=(r,e)=>(assert&&assert(typeof e.value=="number","number value required"),r*e.value),Wp=(r,e)=>(assert&&assert(typeof e.value=="number","number value required"),r+e.value),ga=new Ni;be.DerivedPropertyIO=r=>(assert&&assert(r,"DerivedPropertyIO needs parameterType"),ga.has(r)||ga.set(r,new Le(`${Hp}<${r.typeName}>`,{valueType:be,parameterTypes:[r],supertype:me.PropertyIO(r),documentation:"Like PropertyIO, but not settable.  Instead it is derived from other DerivedPropertyIO or PropertyIO instances",applyState:_.noop,methods:{setValue:{returnType:mt,parameterTypes:[r],implementation:be.prototype.set,documentation:"Errors out when you try to set a derived property.",invocableForReadOnlyElements:!1}}})),ga.get(r));class gd extends be{}class ib extends be{}class nb extends be{}class rb extends be{}it.register("DerivedProperty",be);class $p extends gd{constructor(e,t){const s=new pd(e,t);super([s],i=>i.length>0,t),this.displayedTrailsProperty=s}dispose(){this.displayedTrailsProperty.dispose(),super.dispose()}}d.register("DisplayedProperty",$p);class Up{constructor(e){this.scene=e,this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d"),this.img=document.createElement("img"),this.update()}update(e){this.scene.updateScene(),this.canvas.width=this.scene.getSceneWidth(),this.canvas.height=this.scene.getSceneHeight(),this.scene.renderToCanvas(this.canvas,this.context,()=>{const t=this.toDataURL();this.img.onload=()=>{e(),delete this.img.onload},this.img.src=t})}}d.register("SceneImage",Up);class ie extends me{constructor(e,t){const s=E()({valueType:"boolean",phetioValueType:Ts},t);super(e,s)}toggle(){this.value=!this.value}}it.register("BooleanProperty",ie);var zc,Wc,$c,Uc,Yc;const Ii=new ie(!((Wc=(zc=window==null?void 0:window.phet)==null?void 0:zc.chipper)!=null&&Wc.queryParameters)||((Yc=(Uc=($c=window==null?void 0:window.phet)==null?void 0:$c.chipper)==null?void 0:Uc.queryParameters)==null?void 0:Yc.allowLinks),{tandem:se.GENERAL_MODEL.createTandem("allowLinksProperty")});d.register("allowLinksProperty",Ii);function md(r,e=Ii.value){const t=phet&&phet.chipper&&phet.chipper.isFuzzEnabled();if(e&&!t){const s=window.open(r,"_blank");s&&s.focus()}}d.register("openPopup",md);const ro=(r,e)=>{const t=E()({requiredOnly:!1},e),s=[],i=new LineBreaker(r);i[Symbol.iterator]=()=>({next(){const a=i.nextBreak();return a!==null?{value:a,done:!1}:{done:!0}}});let n=0;for(const a of i){const o=a.position;t.requiredOnly&&!a.required||(n!==o&&s.push(new os(n,o)),n=a.position)}return n<r.length&&s.push(new os(n,r.length)),s};d.register("getLineBreakRanges",ro);const Yp=new T(0,0),Kp=C.IDENTITY.copy(),Lt=class Lt extends si{};Lt.TRANSLATION=new Lt,Lt.TRANSLATION_AND_SCALE=new Lt,Lt.TRANSLATION_AND_ROTATION=new Lt,Lt.AFFINE=new Lt,Lt.enumeration=new ii(Lt,{phetioDocumentation:"Defines the available transform type for a SpriteInstance"});let Ys=Lt;const fn=class fn{constructor(){this.sprite=null,this.matrix=new C().setToAffine(1,0,0,0,1,0),this.transformType=Ys.TRANSLATION,this.alpha=1}initialize(){return this}getShape(){return this.sprite?this.sprite.getShape().transformed(this.matrix):new H}containsPoint(e){if(!this.sprite)return!1;const t=Yp.set(e);return this.transformType===Ys.AFFINE?Kp.set(this.matrix).invert().multiplyVector2(t):(t.x-=this.matrix.m02(),t.y-=this.matrix.m12(),this.transformType===Ys.TRANSLATION_AND_SCALE?(t.x/=this.matrix.m00(),t.y/=this.matrix.m11()):this.transformType===Ys.TRANSLATION_AND_ROTATION&&t.rotate(-this.matrix.rotation)),this.sprite.containsPoint(t)}freeToPool(){fn.pool.freeToPool(this)}};fn.pool=new nt(fn,{maxSize:1e3});let ao=fn;d.register("SpriteInstance",ao);const ma=new Mt(1024,1024),Gs=1,sr=1,Yh=class Yh{constructor(e){this.useMipmaps=e,this.gl=null,this.texture=null,this.bounds=new w(0,0,ma.width,ma.height),assert&&assert(this.bounds.minX===0&&this.bounds.minY===0,"Assumed constraint later on for transforms"),this.width=this.bounds.width,this.height=this.bounds.height,this.canvas=document.createElement("canvas"),this.canvas.width=this.width,this.canvas.height=this.height,this.context=this.canvas.getContext("2d"),this.binPacker=new pp(this.bounds),this.dirty=!0,this.usedSprites=[],this.unusedSprites=[]}initializeContext(e){this.gl=e,this.createTexture()}createTexture(){const e=this.gl;assert&&assert(e),this.texture=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.texture),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,this.useMipmaps?e.LINEAR_MIPMAP_LINEAR:e.LINEAR),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.LINEAR),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,!1),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.canvas),this.useMipmaps&&(e.hint(e.GENERATE_MIPMAP_HINT,e.NICEST),e.generateMipmap(e.TEXTURE_2D)),e.bindTexture(e.TEXTURE_2D,null),this.dirty=!1}updateTexture(){if(assert&&assert(this.gl,"SpriteSheet needs context to updateTexture()"),this.dirty){this.dirty=!1;const e=this.gl;assert&&assert(e),e.bindTexture(e.TEXTURE_2D,this.texture),e.texImage2D(e.TEXTURE_2D,0,e.RGBA,e.RGBA,e.UNSIGNED_BYTE,this.canvas),this.useMipmaps&&(e.hint(e.GENERATE_MIPMAP_HINT,e.NICEST),e.generateMipmap(e.TEXTURE_2D)),e.bindTexture(e.TEXTURE_2D,null)}}addImage(e,t,s){let i;for(i=0;i<this.usedSprites.length;i++){const a=this.usedSprites[i];if(a.image===e)return a.count++,a}for(i=0;i<this.unusedSprites.length;i++){const a=this.unusedSprites[i];if(a.image===e)return a.count++,assert&&assert(a.count===1,"Count should be exactly 1 after coming back from being unused"),this.unusedSprites.splice(i,1),this.usedSprites.push(a),a}let n;for(;!(n=this.binPacker.allocate(t+2*Gs+sr,s+2*Gs+sr))&&this.unusedSprites.length;){const a=this.unusedSprites.shift();this.dirty=!0;const o=a.bin.bounds;this.context.clearRect(o.x,o.y,o.width,o.height),this.binPacker.deallocate(a.bin)}if(n){const a=new w((n.bounds.minX+Gs)/this.width,(n.bounds.minY+Gs)/this.height,(n.bounds.maxX-Gs-sr)/this.width,(n.bounds.maxY-Gs-sr)/this.height),o=new fd(this,n,a,e,1);return this.copyImageWithGutter(e,t,s,n.bounds.x,n.bounds.y),this.dirty=!0,this.usedSprites.push(o),o}else return null}removeImage(e){let t,s;for(s=0;s<this.usedSprites.length;s++)if(this.usedSprites[s].image===e){t=this.usedSprites[s];break}assert&&assert(t,"Sprite not found for removeImage"),--t.count<=0&&(this.usedSprites.splice(s,1),this.unusedSprites.push(t))}containsImage(e){let t;for(t=0;t<this.usedSprites.length;t++)if(this.usedSprites[t].image===e)return!0;for(t=0;t<this.unusedSprites.length;t++)if(this.unusedSprites[t].image===e)return!0;return!1}copyImageWithGutter(e,t,s,i,n){assert&&assert(Gs===1),this.copyImageRegion(e,1,1,0,0,i,n),this.copyImageRegion(e,1,1,t-1,0,i+1+t,n),this.copyImageRegion(e,1,1,t-1,s-1,i+1+t,n+1+s),this.copyImageRegion(e,1,1,0,s-1,i,n+1+s),this.copyImageRegion(e,t,1,0,0,i+1,n),this.copyImageRegion(e,t,1,0,s-1,i+1,n+1+s),this.copyImageRegion(e,1,s,0,0,i,n+1),this.copyImageRegion(e,1,s,t-1,0,i+1+t,n+1),this.context.drawImage(e,i+1,n+1)}copyImageRegion(e,t,s,i,n,a,o){this.context.drawImage(e,i,n,t,s,a,o,t,s)}};Yh.MAX_DIMENSION=ma;let Os=Yh;d.register("SpriteSheet",Os);let fd=class{constructor(e,t,s,i,n){this.spriteSheet=e,this.bin=t,this.uvBounds=s,this.image=i,this.count=n}};Os.Sprite=fd;class Wr{constructor(e,t,s,i){const n=E()({attributes:[],uniforms:[]},i);this.vertexSource=t,this.fragmentSource=s,this.attributeNames=n.attributes,this.uniformNames=n.uniforms,this.initialize(e)}initialize(e){this.gl=e,this.used=!1,this.program=this.gl.createProgram(),this.vertexShader=Y.createShader(this.gl,this.vertexSource,this.gl.VERTEX_SHADER),this.fragmentShader=Y.createShader(this.gl,this.fragmentSource,this.gl.FRAGMENT_SHADER),this.gl.attachShader(this.program,this.vertexShader),this.gl.attachShader(this.program,this.fragmentShader),this.gl.linkProgram(this.program),this.gl.getProgramParameter(this.program,this.gl.LINK_STATUS)||(console.log("GLSL link error:"),console.log(this.gl.getProgramInfoLog(this.program)),console.log("for vertex shader"),console.log(this.vertexSource),console.log("for fragment shader"),console.log(this.fragmentSource)),this.gl.deleteShader(this.vertexShader),this.gl.deleteShader(this.fragmentShader),this.uniformLocations={},this.attributeLocations={},this.activeAttributes={},_.each(this.attributeNames,t=>{this.attributeLocations[t]=this.gl.getAttribLocation(this.program,t),this.activeAttributes[t]=!0}),_.each(this.uniformNames,t=>{this.uniformLocations[t]=this.gl.getUniformLocation(this.program,t)}),this.isInitialized=!0}use(){this.used||(this.used=!0,this.gl.useProgram(this.program),_.each(this.attributeNames,e=>{this.activeAttributes[e]&&this.enableVertexAttribArray(e)}))}activateAttribute(e){this.activeAttributes[e]||(this.activeAttributes[e]=!0,this.used&&this.enableVertexAttribArray(e))}enableVertexAttribArray(e){this.gl.enableVertexAttribArray(this.attributeLocations[e])}unuse(){this.used&&(this.used=!1,_.each(this.attributeNames,e=>{this.activeAttributes[e]&&this.disableVertexAttribArray(e)}))}disableVertexAttribArray(e){this.gl.disableVertexAttribArray(this.attributeLocations[e])}deactivateAttribute(e){this.activeAttributes[e]&&(this.activeAttributes[e]=!1,this.used&&this.disableVertexAttribArray(e))}dispose(){this.gl.deleteProgram(this.program)}}d.register("ShaderProgram",Wr);class yd extends me{constructor(e,t){t&&(assert&&assert(!t.hasOwnProperty("valueType"),"ColorProperty sets valueType"),assert&&assert(!t.hasOwnProperty("phetioType"),"ColorProperty sets phetioType"));const s=E()({valueType:P,phetioValueType:P.ColorIO},t);super(e,s)}}d.register("ColorProperty",yd);const gl="sceneryTextSizeContainer",ml="sceneryTextSizeElement";let Vt,Et;const fl={};let yl=!1;const gt={approximateSVGBounds(r,e){if(assert&&assert(r instanceof xe,"Font required"),assert&&assert(typeof e=="string","renderedText required"),!Vt.parentNode)if(document.body)document.body.appendChild(Vt);else throw new Error("No document.body and trying to get approximate SVG bounds of a Text node");gt.setSVGTextAttributes(Et,r,e);const t=Et.getBBox();return t.width===0&&t.height===0&&e.length>0?(yl||(yl=!0,console.log("WARNING: Guessing text bounds, is the simulation hidden? See https://github.com/phetsims/chipper/issues/768")),gt.guessSVGBounds(r,e)):new w(t.x,t.y,t.x+t.width,t.y+t.height)},guessSVGBounds(r,e){const t=r.getNumericSize(),s=r.weight==="bold";return new w(0,-.9*t,(s?.435:.4)*t*e.length,.22*t)},accurateCanvasBounds(r){const e=d.scratchContext;e.font=r._font.toCSS(),e.direction="ltr";const t=e.measureText(r.renderedText);return new w(-t.actualBoundingBoxLeft,-t.actualBoundingBoxAscent,t.actualBoundingBoxRight,t.actualBoundingBoxDescent)},accurateCanvasBoundsFallback(r){const e=gt.approximateSVGBounds(r._font,r.renderedText);if(!r.renderedText.length||e.width===0)return e;const t=Y.canvasAccurateBounds(s=>{if(s.font=r._font.toCSS(),s.direction="ltr",s.fillText(r.renderedText,0,0),r.hasPaintableStroke()){const i=new ks(null,s);r.beforeCanvasStroke(i),s.strokeText(r.renderedText,0,0),r.afterCanvasStroke(i)}},{precision:.5,resolution:128,initialScale:32/Math.max(Math.abs(e.minX),Math.abs(e.minY),Math.abs(e.maxX),Math.abs(e.maxY))});return t.isFinite()?t:e},getVerticalBounds(r){assert&&assert(r instanceof xe,"Font required");const e=r.toCSS();let t=fl[e];return t||(t=fl[e]=gt.approximateSVGBounds(r,"m")),t},approximateCanvasWidth(r,e){assert&&assert(r instanceof xe,"Font required"),assert&&assert(typeof e=="string","renderedText required");const t=d.scratchContext;return t.font=r.toCSS(),t.direction="ltr",t.measureText(e).width},approximateHybridBounds(r,e){assert&&assert(r instanceof xe,"Font required"),assert&&assert(typeof e=="string","renderedText required");const t=gt.getVerticalBounds(r),s=gt.approximateCanvasWidth(r,e);return new w(0,t.minY,s,t.maxY)},approximateDOMBounds(r,e){assert&&assert(r instanceof xe,"Font required");const t=1024,s=document.createElement("div");$(s).css({position:"absolute",left:0,top:0,padding:"0 !important",margin:"0 !important",display:"hidden"});const i=document.createElement("span");$(i).css("font",r.toCSS()),i.appendChild(e),i.setAttribute("direction","ltr");const n=document.createElement("div");$(n).css({"vertical-align":"baseline",display:"inline-block",width:0,height:`${t}px`,margin:"0 !important",padding:"0 !important"}),s.appendChild(i),s.appendChild(n),document.body.appendChild(s);const a=i.getBoundingClientRect(),o=s.getBoundingClientRect(),h=new w(a.left,a.top-t,a.right+1,a.bottom-t).shiftedXY(-o.left,-o.top);return document.body.removeChild(s),h},approximateImprovedDOMBounds(r,e){assert&&assert(r instanceof xe,"Font required");const t=document.createElement("div");t.style.display="inline-block",t.style.font=r.toCSS(),t.style.color="transparent",t.style.padding="0 !important",t.style.margin="0 !important",t.style.position="absolute",t.style.left="0",t.style.top="0",t.setAttribute("direction","ltr"),t.appendChild(e),document.body.appendChild(t);const s=new w(t.offsetLeft,t.offsetTop,t.offsetLeft+t.offsetWidth+1,t.offsetTop+t.offsetHeight+1);document.body.removeChild(t);const i=gt.getVerticalBounds(r);return s.shiftedY(i.minY)},setSVGTextAttributes(r,e,t){assert&&assert(e instanceof xe,"Font required"),assert&&assert(typeof t=="string","renderedText required"),r.setAttribute("direction","ltr"),r.setAttribute("font-family",e.getFamily()),r.setAttribute("font-size",e.getSize()),r.setAttribute("font-style",e.getStyle()),r.setAttribute("font-weight",e.getWeight()),r.setAttribute("font-stretch",e.getStretch()),r.lastChild.nodeValue=t},initializeTextBounds(){Vt=document.getElementById(gl),Vt||(Vt=document.createElementNS(ne,"svg"),Vt.setAttribute("width","2"),Vt.setAttribute("height","2"),Vt.setAttribute("id",gl),Vt.setAttribute("style","visibility: hidden; pointer-events: none; position: absolute; left: -65535px; right: -65535px;")),Et=document.getElementById(ml),Et||(Et=document.createElementNS(ne,"text"),Et.appendChild(document.createTextNode("")),Et.setAttribute("dominant-baseline","alphabetic"),Et.setAttribute("text-rendering","geometricPrecision"),Et.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:space","preserve"),Et.setAttribute("id",ml),Vt.appendChild(Et))}};d.register("TextBounds",gt);class oo{constructor(e,t,s){this.pdomInstance=e,this.trail=t,this.isRoot=s,this.isRoot=s,this.fullTrail=this.pdomInstance.trail.copy();for(let i=this.isRoot?0:1;i<this.trail.length;i++)this.fullTrail.addDescendant(this.trail.nodes[i])}}d.register("PartialPDOMTrail",oo);const bd="a11y-pdom-element",Ld="a11y-pdom-root",vd="a11y-pdom-list-item";zr.addRule(`.${bd}{position: fixed;pointer-events: none;top: 0px;left: 0px;transform-origin: left top 0px;border-width: 0px;border: 0px;padding: 1px 1px;margin: 0px;white-space: nowrap;outline: none;box-shadow:none;border-color:transparent;font-size: 1px;clip: rect(1px, 1px, 1px, 1px);}`);zr.addRule(`.${Ld}{position: absolute;z-index: 1;opacity: 0.0001;}`);zr.addRule(`.${vd}{list-style: none;`);const Pd={SIBLING_CLASS_NAME:bd,ROOT_CLASS_NAME:Ld,LIST_ITEM_CLASS_NAME:vd};d.register("PDOMSiblingStyle",Pd);const qo=Pd,_d="NEXT",Xp="PREVIOUS",pr="INPUT",jp="LABEL",ho="BUTTON",lo="TEXTAREA",co="SELECT",bl="OPTGROUP",Ll="DATALIST",vl="OUTPUT",Pl="DIV",uo="A",qp="AREA",fa="P",Qp="IFRAME",Sd="B",wd="STRONG",Dd="I",Td="EM",Cd="MARK",Id="SMALL",Ed="DEL",kd="INS",Ad="SUB",xd="SUP",Zp="BR",Jp=[uo,qp,pr,co,lo,ho,Qp],_l=[Sd,wd,Dd,Td,Cd,Id,Ed,kd,Ad,xd,Zp],eg=[pr],tg=["focusin","focusout","input","change","click","keydown","keyup"],sg=["input","change","click","keydown","keyup"],ig=["touchstart","touchend","touchmove","touchcancel","mousedown","mouseup","mousemove","mouseover","mouseout","pointerdown","pointerup","pointermove","pointerover","pointerout","pointercancel","gotpointercapture","lostpointercapture"],ng="aria-labelledby",rg="aria-describedby",ag="aria-activedescendant",Sl="data-focusable",og="data-unique-id",hg=[ng,rg,ag];function po(r){const e=r.getElementsByTagName("*"),t=[];for(let s=0;s<e.length;s++)e[s].nodeType===Node.ELEMENT_NODE&&(t[s]=e[s]);return t}function Od(r){return r.hidden?!0:r===document.body?!1:Od(r.parentElement)}function wl(r,e){const t=e||document.body,s=po(t),i=document.activeElement,n=s.indexOf(i),a=r===_d?1:-1;let o=n+a;for(;o<s.length&&o>=0;){const h=s[o];if(o+=a,ws.isElementFocusable(h))return h}return i}function lg(r){return r.replace(/^\s+/,"")}function Dl(r){return!_.includes(eg,r.toUpperCase())}const ws={unwrapStringProperty(r){const e=r===null?null:typeof r=="string"?r:r.value;return assert&&assert(e===null||typeof e=="string"),e},getNextFocusable(r){return wl(_d,r)},getPreviousFocusable(r){return wl(Xp,r)},getFirstFocusable(r){const e=r||document.body,t=po(e);let s=document.body,i=0;for(;i<t.length;){const n=t[i];if(i++,ws.isElementFocusable(n)){s=n;break}}return s},getRandomFocusable(r){assert&&assert(r,"Random expected");const e=po(document.body),t=[];for(let s=0;s<e.length;s++)ws.isElementFocusable(e[s])&&t.push(e[s]);return t[r.nextInt(t.length)]},unwrapProperty(r){return O(r)?r.value:r},containsFormattingTags(r){if(r===null)return!1;assert&&assert(typeof r=="string","unsupported type for textContent.");let e=0;const t=[],s=[];for(;e<r.length;){const a=r.indexOf("<",e),o=r.indexOf(">",e);a>-1&&(t.push(a),e=a+1),o>-1?(s.push(o),e=o+1):e++}if(t.length!==s.length||t.length===0)return!1;let i=!0;const n=r.toUpperCase();for(let a=0;a<t.length;a++){let o=n.substring(t[a]+1,s[a]);o=o.replace("/","");const h=lg(o);o.length-h.length>0||_.includes(_l,o)||(i=!1)}return i},setTextContent(r,e){if(assert&&assert(r instanceof Element),assert&&assert(e===null||typeof e=="string"),e===null)r.innerHTML="";else{const t=e.replaceAll("<br>","<br/>"),s=Bo(t);Es(s,Dt.STRING_WITHOUT_TEMPLATE_VARS_VALIDATOR),Dl(r.tagName)&&(ws.containsFormattingTags(s)?r.innerHTML=s:r.textContent=s)}},tagIsDefaultFocusable(r){return _.includes(Jp,r.toUpperCase())},isElementFocusable(r){return!document.body.contains(r)||Od(r)||_.includes(_l,r.tagName)?!1:r.getAttribute(Sl)==="true"},tagNameSupportsContent(r){return Dl(r)},removeElements(r,e){for(let t=0;t<e.length;t++){const s=e[t];assert&&assert(r.contains(s),"element does not contain child to be removed: ",s),r.removeChild(s)}},insertElements(r,e,t){assert&&assert(r instanceof window.Element),assert&&assert(Array.isArray(e));for(let s=0;s<e.length;s++){const i=e[s];r.insertBefore(i,t||null)}},createElement(r,e,t){t=Je({namespace:null,id:null},t);const s=t.namespace?document.createElementNS(t.namespace,r):document.createElement(r);return t.id&&(s.id=t.id),ws.overrideFocusWithTabIndex(s,e),s.classList.add(qo.SIBLING_CLASS_NAME),s},overrideFocusWithTabIndex(r,e){ws.tagIsDefaultFocusable(r.tagName)!==e?r.tabIndex=e?0:-1:r.removeAttribute("tabindex"),r.setAttribute(Sl,e)},TAGS:{INPUT:pr,LABEL:jp,BUTTON:ho,TEXTAREA:lo,SELECT:co,OPTGROUP:bl,DATALIST:Ll,OUTPUT:vl,DIV:Pl,A:uo,P:fa,B:Sd,STRONG:wd,I:Dd,EM:Td,MARK:Cd,SMALL:Id,DEL:Ed,INS:kd,SUB:Ad,SUP:xd},FORM_ELEMENTS:[pr,ho,lo,co,bl,Ll,vl,uo],DEFAULT_CONTAINER_TAG_NAME:Pl,DEFAULT_DESCRIPTION_TAG_NAME:fa,DEFAULT_LABEL_TAG_NAME:fa,ASSOCIATION_ATTRIBUTES:hg,INPUT_TYPES_THAT_SUPPORT_CHECKED:["RADIO","CHECKBOX"],DOM_EVENTS:tg,USER_GESTURE_EVENTS:sg,BLOCKED_DOM_EVENTS:ig,DATA_PDOM_UNIQUE_ID:og,PDOM_UNIQUE_ID_SEPARATOR:"-",DATA_EXCLUDE_FROM_INPUT:"data-exclude-from-input"};d.register("PDOMUtils",ws);const N=ws;class $r extends me{constructor(e,t){t&&(assert&&assert(!t.hasOwnProperty("valueType"),"StringProperty sets valueType"),assert&&assert(!t.hasOwnProperty("phetioType"),"StringProperty sets phetioType"));const s=E()({valueType:"string",phetioValueType:ge},t);super(e,s)}}it.register("StringProperty",$r);const cg=_.hasIn(window,"phet.chipper.queryParameters.colorProfile")?phet.chipper.queryParameters.colorProfile:Ds.DEFAULT_COLOR_PROFILE,dg=_.hasIn(window,"phet.chipper.colorProfiles")?phet.chipper.colorProfiles:[Ds.DEFAULT_COLOR_PROFILE],Rn=new $r(cg,{tandem:se.GENERAL_VIEW.createTandem("colorProfileProperty"),phetioFeatured:!0,validValues:dg});d.register("colorProfileProperty",Rn);const ug=".",mn=[];class pg extends yd{constructor(e,t,s,i){const n=E()({valueComparisonStrategy:"equalsFunction",tandemNameSuffix:["ColorProperty","FillProperty","StrokeProperty"]},i);if(s=_.mapValues(s,a=>P.toColor(a).setImmutable()),assert&&assert(s.hasOwnProperty(Ds.DEFAULT_COLOR_PROFILE),"default color profile must be provided"),assert&&assert(!!s[Ds.DEFAULT_COLOR_PROFILE],"default color profile must be truthy"),super(P.toColor(s[Rn.value]||s[Ds.DEFAULT_COLOR_PROFILE]),n),this.colorProfileMap=s,Rn.link(a=>{this.value=P.toColor(this.colorProfileMap[a]||this.colorProfileMap[Ds.DEFAULT_COLOR_PROFILE])}),this.name=`${e.name}${ug}${t}`,this.link(a=>{window.parent!==window&&window.parent.postMessage(JSON.stringify({type:"reportColor",name:this.name,value:a.toHexString(),alpha:a.getAlpha()}),"*")}),assert){const a=mn.filter(o=>o.name===this.name);assert&&assert(a.length===0,"cannot use the same name for two different ProfileColorProperty instances: "+name)}mn.push(this)}dispose(){Tt(mn,this),super.dispose()}}window.addEventListener("message",r=>{let e;try{e=JSON.parse(r.data)}catch{}if(e&&e.type==="setColor")for(let t=0;t<mn.length;t++){const s=mn[t];s.name===e.name&&(s.colorProfileMap[Rn.value]=new P(e.value).withAlpha(e.alpha),s.value=P.toColor(s.colorProfileMap[Rn.value]))}});d.register("ProfileColorProperty",pg);let gg=1;class wt{constructor(){this.id=`paint${gg++}`,this.transformMatrix=null}setTransformMatrix(e){return this.transformMatrix!==e&&(this.transformMatrix=e),this}toString(){return this.id}}wt.prototype.isPaint=!0;d.register("Paint",wt);class st extends wt{constructor(){super(),assert&&assert(this.constructor.name!=="Gradient","Please create a LinearGradient or RadialGradient. Do not directly use the supertype Gradient."),this.stops=[],this.lastStopRatio=0,this.canvasGradient=null,this.colorStopsDirty=!1,this.lastColorStopValues=[]}addColorStop(e,t){if(assert&&assert(e>=0&&e<=1,"Ratio needs to be between 0,1 inclusively"),assert&&assert(t===null||typeof t=="string"||t instanceof P||O(t)&&(t.value===null||typeof t.value=="string"||t.value instanceof P),"Color should match the addColorStop type specification"),this.lastStopRatio>e)throw new Error("Color stops not specified in the order of increasing ratios");return this.lastStopRatio=e,this.stops.push({ratio:e,color:t}),this.lastColorStopValues.push(""),this}getSVGStops(){return this.stops}invalidateCanvasGradient(){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`Invalidated Canvas Gradient for #${this.id}`),this.colorStopsDirty=!0}haveCanvasColorStopsChanged(){if(this.lastColorStopValues===null)return!0;for(let e=0;e<this.stops.length;e++)if(st.colorToString(this.stops[e].color)!==this.lastColorStopValues[e])return!0;return!1}getCanvasStyle(){if(!this.canvasGradient||this.colorStopsDirty&&this.haveCanvasColorStopsChanged()){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`Regenerating Canvas Gradient for #${this.id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.colorStopsDirty=!1,ee(this.lastColorStopValues),this.canvasGradient=this.createCanvasGradient();for(let e=0;e<this.stops.length;e++){const t=this.stops[e],s=st.colorToString(t.color);this.canvasGradient.addColorStop(t.ratio,s),this.lastColorStopValues.push(s)}sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}return this.canvasGradient}static colorToString(e){return O(e)&&(e=e.value),e===null&&(e="transparent"),e instanceof P&&(e=e.toCSS()),e}}st.prototype.isGradient=!0;d.register("Gradient",st);class Pi extends st{constructor(e,t,s,i){assert&&assert(isFinite(e)&&isFinite(t)&&isFinite(s)&&isFinite(i)),super(),this.start=new T(e,t),this.end=new T(s,i)}createCanvasGradient(){return d.scratchContext.createLinearGradient(this.start.x,this.start.y,this.end.x,this.end.y)}createSVGPaint(e){return mr.pool.create(e,this)}toString(){let e=`new phet.scenery.LinearGradient( ${this.start.x}, ${this.start.y}, ${this.end.x}, ${this.end.y} )`;return _.each(this.stops,t=>{e+=`.addColorStop( ${t.ratio}, ${Qo.scenerySerialize(t.color)} )`}),e}}Pi.prototype.isLinearGradient=!0;d.register("LinearGradient",Pi);class _i extends st{constructor(e,t,s,i,n,a){if(super(),this.start=new T(e,t),this.end=new T(i,n),Te.safari){const o=(e+i)/2,h=(t+n)/2;this.start.x=o,this.start.y=h,this.end.x=o,this.end.y=h}this.startRadius=s,this.endRadius=a,this.focalPoint=this.start.plus(this.end.minus(this.start).times(this.startRadius/(this.startRadius-this.endRadius))),this.startIsLarger=this.startRadius>this.endRadius,this.largePoint=this.startIsLarger?this.start:this.end,this.maxRadius=Math.max(this.startRadius,this.endRadius),this.minRadius=Math.min(this.startRadius,this.endRadius),this.startRadius>=this.endRadius?assert&&assert(this.focalPoint.minus(this.start).magnitude<=this.startRadius):assert&&assert(this.focalPoint.minus(this.end).magnitude<=this.endRadius)}createCanvasGradient(){return d.scratchContext.createRadialGradient(this.start.x,this.start.y,this.startRadius,this.end.x,this.end.y,this.endRadius)}createSVGPaint(e){return fr.pool.create(e,this)}getSVGStops(){const e=this.startIsLarger,t=this.maxRadius,s=this.minRadius;function i(o,h,l,c,u){return l+(u-o)*(c-l)/(h-o)}function n(o){let h=e?1-o.ratio:o.ratio;return s>0&&(h=i(0,1,s/t,1,h)),{ratio:h,color:o.color}}const a=this.stops.map(n);return e&&a.reverse(),a}toString(){let e=`new phet.scenery.RadialGradient( ${this.start.x}, ${this.start.y}, ${this.startRadius}, ${this.end.x}, ${this.end.y}, ${this.endRadius} )`;return _.each(this.stops,t=>{e+=`.addColorStop( ${t.ratio}, ${Qo.scenerySerialize(t.color)} )`}),e}}_i.prototype.isRadialGradient=!0;d.register("RadialGradient",_i);class Ms extends wt{constructor(e){super(),this.image=e,this.canvasPattern=d.scratchContext.createPattern(e,"repeat")}getCanvasStyle(){return this.canvasPattern}createSVGPaint(e){return yr.pool.create(this)}toString(){return`new phet.scenery.Pattern( $( '<img src="${this.image.src}"/>' )[0] )`}}Ms.prototype.isPattern=!0;d.register("Pattern",Ms);class Md extends Ms{constructor(e,t,s,i,n,a,o=C.IDENTITY){assert&&assert(t>0&&Number.isInteger(t),"Resolution should be a positive integer"),assert&&assert(Number.isInteger(n)),assert&&assert(Number.isInteger(a));const h=document.createElement("img");function l(u,m,b,y,f){h.src=u.toDataURL()}new D({scale:t,children:[e]}).toCanvas(l,-s*t,-i*t,n*t,a*t),super(h),this.setTransformMatrix(o.timesMatrix(C.scaling(1/t)))}}d.register("NodePattern",Md);let mg=1;class Rs{constructor(){this.id=`filter${mg++}`,this.filterRegionPercentageIncrease=0}isDOMCompatible(){return!1}isSVGCompatible(){return!1}isCanvasCompatible(){return A.canvasFilter?this.isDOMCompatible():!1}isWebGLCompatible(){return!1}toString(){return this.id}static applyColorMatrix(e,t,s,i){const n=document.createElementNS(ne,"feColorMatrix");n.setAttribute("type","matrix"),n.setAttribute("values",e),n.setAttribute("in",s),n.setAttribute("color-interpolation-filters","sRGB"),i&&n.setAttribute("result",i),t.appendChild(n)}}d.register("Filter",Rs);const ya=new Ni,Ei=r=>{assert&&assert(Array.isArray(r),"OrIO needs to be an array"),assert&&assert(r.length>1,"OrIO needs parameterTypes");const e=r.map(s=>s.typeName),t=e.join(",");if(!ya.has(t)){const s=i=>{for(let n=0;n<r.length;n++){const a=r[n];if(Dt.isValueValid(i,a.validator))return!0}return!1};ya.set(t,new Le(`OrIO<${e.join(", ")}>`,{documentation:"A PhET-iO Type adding support for a composite type that can be any of its parameters.",parameterTypes:r,isValidValue:s,toStateObject:i=>{for(let n=0;n<r.length;n++){const a=r[n];if(Dt.isValueValid(i,a.validator))return{index:n,state:a.toStateObject(i)}}throw new Error("somehow the instance was not valid, we should not get here. Why was isValidValue not used before this step?")},fromStateObject:i=>(assert&&assert(i.hasOwnProperty("index"),"index required for deserialization"),assert&&assert(i.hasOwnProperty("state"),"state required for deserialization"),r[i.index].fromStateObject(i.state)),stateSchema:Mo.asValue(`${e.join("|")}`,{isValidValue:i=>typeof i.index=="number"?r[i.index].isStateObjectValid(i.state):!1})}))}return ya.get(t)};Hs.register("OrIO",Ei);class Rd extends Error{constructor(){super("CouldNotYetDeserializeError")}}Hs.register("CouldNotYetDeserializeError",Rd);const ba=new Ni,Nd=r=>{assert&&assert(r,"ReferenceIO needs parameterType");const e=r;return ba.has(e)||(assert&&assert(typeof r.typeName=="string","type name should be a string"),ba.set(e,new Le(`ReferenceIO<${r.typeName}>`,{isValidValue:t=>Dt.isValueValid(t,r.validator),documentation:"Uses reference identity for serializing and deserializing, and validates based on its parameter PhET-iO Type.",parameterTypes:[r],toStateObject(t){return{phetioID:t.tandem.phetioID}},stateSchema:{phetioID:ge},fromStateObject(t){if(assert&&assert(t&&typeof t.phetioID=="string","phetioID should be a string"),phet.phetio.phetioEngine.hasPhetioObject(t.phetioID))return phet.phetio.phetioEngine.getPhetioElement(t.phetioID);throw new Rd},applyState(t){assert&&assert(!1,`ReferenceIO is meant to be used as DataType serialization (see fromStateObject) for phetioID: ${t.tandem.phetioID}`)}}))),ba.get(e)};Hs.register("ReferenceIO",Nd);const Nn={isColorDef(r){return r===null||typeof r=="string"||r instanceof P||O(r)&&(r.value===null||typeof r.value=="string"||r.value instanceof P)},scenerySerialize(r){return r===null?"null":r instanceof P?`'${r.toCSS()}'`:typeof r=="string"?`'${r}'`:Nn.scenerySerialize(r.value)},ColorDefIO:null};Nn.ColorDefIO=new Le("ColorDefIO",{isValidValue:Nn.isColorDef,supertype:V(Ei([ge,P.ColorIO,Nd(me.PropertyIO(V(Ei([ge,P.ColorIO]))))]))});d.register("ColorDef",Nn);const Qo=Nn,hs={isPaintDef(r){return r===null||typeof r=="string"||r instanceof P||r instanceof wt||O(r)&&(r.value===null||typeof r.value=="string"||r.value instanceof P)},toColor(r){if(typeof r=="string")return new P(r);if(r instanceof P)return r.copy();if(O(r))return hs.toColor(r.value);if(r instanceof st){let e=P.TRANSPARENT;const t=0;return r.stops.forEach(s=>{e=e.blend(hs.toColor(s.color),1/(t+1))}),e}return P.TRANSPARENT}};d.register("PaintDef",hs);const fg=(r,e,t)=>be.and([r,new ie(!0,pe({tandem:e.createTandem("selfVisibleProperty"),phetioFeatured:!0},t))],{tandem:e.createTandem("visibleProperty"),phetioValueType:Ts});d.register("createGatedVisibleProperty",fg);const yg=Y.supportsImageDataCanvasFilter(),bg=Te.chromium;class ni extends Rs{constructor(e,t,s,i,n,a,o,h,l,c,u,m,b,y,f,L,v,S,B,ce){assert&&assert(isFinite(e),"m00 should be a finite number"),assert&&assert(isFinite(t),"m01 should be a finite number"),assert&&assert(isFinite(s),"m02 should be a finite number"),assert&&assert(isFinite(i),"m03 should be a finite number"),assert&&assert(isFinite(n),"m04 should be a finite number"),assert&&assert(isFinite(a),"m10 should be a finite number"),assert&&assert(isFinite(o),"m11 should be a finite number"),assert&&assert(isFinite(h),"m12 should be a finite number"),assert&&assert(isFinite(l),"m13 should be a finite number"),assert&&assert(isFinite(c),"m14 should be a finite number"),assert&&assert(isFinite(u),"m20 should be a finite number"),assert&&assert(isFinite(m),"m21 should be a finite number"),assert&&assert(isFinite(b),"m22 should be a finite number"),assert&&assert(isFinite(y),"m23 should be a finite number"),assert&&assert(isFinite(f),"m24 should be a finite number"),assert&&assert(isFinite(L),"m30 should be a finite number"),assert&&assert(isFinite(v),"m31 should be a finite number"),assert&&assert(isFinite(S),"m32 should be a finite number"),assert&&assert(isFinite(B),"m33 should be a finite number"),assert&&assert(isFinite(ce),"m34 should be a finite number"),super(),this.m00=e,this.m01=t,this.m02=s,this.m03=i,this.m04=n,this.m10=a,this.m11=o,this.m12=h,this.m13=l,this.m14=c,this.m20=u,this.m21=m,this.m22=b,this.m23=y,this.m24=f,this.m30=L,this.m31=v,this.m32=S,this.m33=B,this.m34=ce}applySVGFilter(e,t,s){Rs.applyColorMatrix(`${J(this.m00)} ${J(this.m01)} ${J(this.m02)} ${J(this.m03)} ${J(this.m04)} ${J(this.m10)} ${J(this.m11)} ${J(this.m12)} ${J(this.m13)} ${J(this.m14)} ${J(this.m20)} ${J(this.m21)} ${J(this.m22)} ${J(this.m23)} ${J(this.m24)} ${J(this.m30)} ${J(this.m31)} ${J(this.m32)} ${J(this.m33)} ${J(this.m34)}`,e,t,s)}applyCanvasFilter(e){const t=e.canvas.width,s=e.canvas.height,i=e.context.getImageData(0,0,t,s),n=t*s;for(let a=0;a<n;a++){const o=a*4;if(bg){const l=Math.pow(i.data[o+0]/255,1.45),c=Math.pow(i.data[o+1]/255,1.45),u=Math.pow(i.data[o+2]/255,1.45),m=Math.pow(i.data[o+3]/255,1.45);i.data[o+0]=255*Math.pow(l*this.m00+c*this.m01+u*this.m02+m*this.m03+this.m04,1/1.45),i.data[o+1]=255*Math.pow(l*this.m10+c*this.m11+u*this.m12+m*this.m13+this.m14,1/1.45),i.data[o+2]=255*Math.pow(l*this.m20+c*this.m21+u*this.m22+m*this.m23+this.m24,1/1.45),i.data[o+3]=255*Math.pow(l*this.m30+c*this.m31+u*this.m32+m*this.m33+this.m34,1/1.45)}else{const h=i.data[o+0],l=i.data[o+1],c=i.data[o+2],u=i.data[o+3];i.data[o+0]=h*this.m00+l*this.m01+c*this.m02+u*this.m03+this.m04,i.data[o+1]=h*this.m10+l*this.m11+c*this.m12+u*this.m13+this.m14,i.data[o+2]=h*this.m20+l*this.m21+c*this.m22+u*this.m23+this.m24,i.data[o+3]=h*this.m30+l*this.m31+c*this.m32+u*this.m33+this.m34}}e.context.putImageData(i,0,0)}isSVGCompatible(){return!0}isCanvasCompatible(){return super.isCanvasCompatible()||yg}getCSSFilterString(){throw new Error("unimplemented")}}d.register("ColorMatrixFilter",ni);const xr=class xr extends ni{constructor(e){assert&&assert(isFinite(e),"Brightness amount should be finite"),assert&&assert(e>=0,"Brightness amount should be non-negative"),super(e,0,0,0,0,0,e,0,0,0,0,0,e,0,0,0,0,0,1,0),this.amount=e}getCSSFilterString(){return`brightness(${J(this.amount)})`}isDOMCompatible(){return!0}};xr.BLACKEN=new xr(0);let go=xr;d.register("Brightness",go);const Or=class Or extends ni{constructor(e){assert&&assert(isFinite(e),"Contrast amount should be finite"),assert&&assert(e>=0,"Contrast amount should be non-negative"),super(e,0,0,0,-(.5*e)+.5,0,e,0,0,-(.5*e)+.5,0,0,e,0,-(.5*e)+.5,0,0,0,1,0),this.amount=e}getCSSFilterString(){return`contrast(${J(this.amount)})`}isDOMCompatible(){return!0}};Or.GRAY=new Or(0);let mo=Or;d.register("Contrast",mo);class Lg extends Rs{constructor(e,t,s,i=15){assert&&assert(e.isFinite(),"DropShadow offset should be finite"),assert&&assert(isFinite(t),"DropShadow blurRadius should be finite"),assert&&assert(t>=0,"DropShadow blurRadius should be non-negative"),assert&&assert(Qo.isColorDef(s),"DropShadow color should be a ColorDef"),super(),this.offset=e,this.blurRadius=t,this.color=s,this.colorCSS=hs.toColor(s).toCSS(),this.filterRegionPercentageIncrease=i}getCSSFilterString(){return`drop-shadow(${J(this.offset.x)}px ${J(this.offset.y)}px ${J(this.blurRadius)}px ${this.colorCSS})`}isDOMCompatible(){return!0}applyCanvasFilter(){throw new Error("unimplemented")}applySVGFilter(e,t,s){throw new Error("unimplemented")}}d.register("DropShadow",Lg);class vg extends Rs{constructor(e,t=15){assert&&assert(isFinite(e),"GaussianBlur standardDeviation should be finite"),assert&&assert(e>=0,"GaussianBlur standardDeviation should be non-negative"),super(),this.standardDeviation=e,this.filterRegionPercentageIncrease=t}getCSSFilterString(){return`blur(${J(this.standardDeviation)}px)`}applySVGFilter(e,t,s){const i=document.createElementNS(ne,"feGaussianBlur");i.setAttribute("stdDeviation",J(this.standardDeviation)),i.setAttribute("edgeMode","none"),e.appendChild(i),i.setAttribute("in",t),s&&i.setAttribute("result",s),e.appendChild(i)}isDOMCompatible(){return!0}isSVGCompatible(){return!0}applyCanvasFilter(e){throw new Error("unimplemented")}}d.register("GaussianBlur",vg);const Mr=class Mr extends ni{constructor(e=1){assert&&assert(isFinite(e),"Grayscale amount should be finite"),assert&&assert(e>=0,"Grayscale amount should be non-negative"),assert&&assert(e<=1,"Grayscale amount should be no greater than 1");const t=1-e;super(.2126+.7874*t,.7152-.7152*t,.0722-.0722*t,0,0,.2126-.2126*t,.7152+.2848*t,.0722-.0722*t,0,0,.2126-.2126*t,.7152-.7152*t,.0722+.9278*t,0,0,0,0,0,1,0),this.amount=e}getCSSFilterString(){return`grayscale(${J(this.amount)})`}isDOMCompatible(){return!0}};Mr.FULL=new Mr(1);let fo=Mr;d.register("Grayscale",fo);class Pg extends ni{constructor(e){assert&&assert(isFinite(e),"HueRotate amount should be finite"),assert&&assert(e>=0,"HueRotate amount should be non-negative");const t=Math.cos(e),s=Math.sin(e);super(.213+.787*t-.213*s,.715-.715*t-.715*s,.072-.072*t+.928*s,0,0,.213-.213*t+.143*s,.715+.285*t+.14*s,.072-.072*t-.283*s,0,0,.213-.213*t-.787*s,.715-.715*t+.715*s,.072+.928*t+.072*s,0,0,0,0,0,1,0),this.amount=e}getCSSFilterString(){return`hue-rotate(${J(Ve.toDegrees(this.amount))}deg)`}isDOMCompatible(){return!0}}d.register("HueRotate",Pg);const Rr=class Rr extends Rs{constructor(e=1){assert&&assert(isFinite(e),"Invert amount should be finite"),assert&&assert(e>=0,"Invert amount should be non-negative"),assert&&assert(e<=1,"Invert amount should be no greater than 1"),super(),this.amount=e}getCSSFilterString(){return`invert(${J(this.amount)})`}isDOMCompatible(){return!0}applyCanvasFilter(e){throw new Error("unimplemented")}applySVGFilter(e,t,s){throw new Error("unimplemented")}};Rr.FULL=new Rr(1);let yo=Rr;d.register("Invert",yo);class _g extends Rs{constructor(e){assert&&assert(isFinite(e),"Opacity amount should be finite"),assert&&assert(e>=0,"Opacity amount should be non-negative"),assert&&assert(e<=1,"Opacity amount should be no greater than 1"),super(),this.amount=e}getCSSFilterString(){return`opacity(${J(this.amount)})`}isDOMCompatible(){return!0}applyCanvasFilter(e){throw new Error("unimplemented")}applySVGFilter(e,t,s){throw new Error("unimplemented")}}d.register("Opacity",_g);class Sg extends ni{constructor(e){assert&&assert(isFinite(e),"Saturate amount should be finite"),assert&&assert(e>=0,"Saturate amount should be non-negative"),super(.213+.787*e,.715-.715*e,.072-.072*e,0,0,.213-.213*e,.715-.285*e,.072-.072*e,0,0,.213-.213*e,.715-.715*e,.072-.928*e,0,0,0,0,0,1,0),this.amount=e}getCSSFilterString(){return`saturate(${J(this.amount)})`}isDOMCompatible(){return!0}}d.register("Saturate",Sg);const Nr=class Nr extends ni{constructor(e=1){assert&&assert(isFinite(e),"Sepia amount should be finite"),assert&&assert(e>=0,"Sepia amount should be non-negative"),assert&&assert(e<=1,"Sepia amount should be at most 1"),super(.393+.607*(1-e),.769-.769*(1-e),.189-.189*(1-e),0,0,.349-.349*(1-e),.686+.314*(1-e),.168-.168*(1-e),0,0,.272-.272*(1-e),.534-.534*(1-e),.131+.869*(1-e),0,0,0,0,0,1,0),this.amount=e}getCSSFilterString(){return`sepia(${J(this.amount)})`}isDOMCompatible(){return!0}};Nr.FULL=new Nr(1);let bo=Nr;d.register("Sepia",bo);const ki=new X(!1);Hs.register("isSettingPhetioStateProperty",ki);class Ut extends X{constructor(e,t=!1,s){super(e,s),t&&(this.targetPropertyInstrumented=t),assert&&(this.phetioInitialized=!1)}setValueOrTargetProperty(e,t,s){if(O(s))this.setTargetProperty(s,e,t);else{const i=this.get();this.clearTargetProperty(),assert&&assert(!this.targetProperty,"just cleared"),this.setPropertyValue(s),this.areValuesEqual(i,s)||this.notifyListeners(i)}}setTargetProperty(e,t=null,s=null){if(assert&&t&&s===null&&this.targetPropertyInstrumented&&assert(!t.isPhetioInstrumented(),"tandemName must be provided for instrumented Nodes"),this.targetProperty===e)return t;const i=this.targetProperty&&this.targetProperty instanceof ft&&this.targetProperty.isPhetioInstrumented();assert&&i&&assert(e&&e instanceof ft&&e.isPhetioInstrumented(),"Cannot set swap out a PhET-iO instrumented targetProperty for an uninstrumented one");const n=this.targetProperty;this.ownedPhetioProperty&&e!==this.ownedPhetioProperty&&this.disposeOwnedPhetioProperty(),t&&s!==null&&t.updateLinkedElementForProperty(s,n,e);const a=this.get();return this.clearTargetProperty(),this.targetProperty=e,this.targetProperty?(assert&&assert(this.forwardingListener,"forwardingListener is not set yet"),this.targetProperty.lazyLink(this.forwardingListener),this.setPropertyValue(this.targetProperty.value)):this.setPropertyValue(a),this.areValuesEqual(a,this.get())||this.notifyListeners(a),t}clearTargetProperty(){this.forwardingListener=this.forwardingListener||this.onTargetPropertyChange.bind(this),this.targetProperty&&this.targetProperty.unlink(this.forwardingListener),this.targetProperty=null}onTargetPropertyChange(e){super.set(e)}set(e){return this.targetProperty?(assert&&assert(this.targetProperty.isSettable(),"targetProperty must be settable"),this.targetProperty.set(e)):super.set(e),this}setTargetPropertyInstrumented(e,t){return assert&&assert(!t.isPhetioInstrumented(),"this option only works if it is passed in before this Node is instrumented"),this.targetPropertyInstrumented=e,t}getTargetPropertyInstrumented(){return this.targetPropertyInstrumented||!1}initializePhetio(e,t,s){assert&&assert(!this.phetioInitialized,"already initialized"),assert&&assert(!this.ownedPhetioProperty,"Already created the ownedPhetioProperty"),!this.targetProperty&&this.targetPropertyInstrumented?(this.ownedPhetioProperty=s(),assert&&assert(this.ownedPhetioProperty instanceof me,"The owned property should be an AXON/Property"),assert&&assert(this.ownedPhetioProperty instanceof ft&&this.ownedPhetioProperty.isPhetioInstrumented(),"The owned property should be PhET-iO instrumented"),this.setTargetProperty(this.ownedPhetioProperty,e,t)):this.targetProperty&&this.targetProperty instanceof ft&&this.targetProperty.isPhetioInstrumented()&&e.updateLinkedElementForProperty(t,null,this.targetProperty),assert&&(this.phetioInitialized=!0)}getTargetProperty(){return this.targetProperty||null}disposeOwnedPhetioProperty(){this.ownedPhetioProperty&&(this.ownedPhetioProperty.dispose(),delete this.ownedPhetioProperty)}dispose(){this.clearTargetProperty(),this.disposeOwnedPhetioProperty(),super.dispose()}}it.register("TinyForwardingProperty",Ut);const di=N.TAGS.INPUT,Bd=N.TAGS.P,wg=Bd,Dg=Bd,Tg=(r,e,t)=>(e.labelTagName=`h${r.headingLevel}`,e.labelContent=t,e),Ui=r=>{const e=r===null?null:typeof r=="string"?r:r.value;return assert&&assert(e===null||typeof e=="string"),e},Cg=N.FORM_ELEMENTS,Tl=N.INPUT_TYPES_THAT_SUPPORT_CHECKED,Ig=N.ASSOCIATION_ATTRIBUTES,Lo=["focusable","tagName","accessibleName","accessibleNameBehavior","helpText","helpTextBehavior","pdomHeading","pdomHeadingBehavior","containerTagName","containerAriaRole","innerContent","inputType","inputValue","pdomChecked","pdomNamespace","ariaLabel","ariaRole","ariaValueText","labelTagName","labelContent","appendLabel","descriptionTagName","descriptionContent","appendDescription","focusHighlight","focusHighlightLayerable","groupFocusHighlight","pdomVisibleProperty","pdomVisible","pdomOrder","ariaLabelledbyAssociations","ariaDescribedbyAssociations","activeDescendantAssociations","focusPanTargetBoundsProperty","limitPanDirection","positionInPDOM","pdomTransformSourceNode"];class Bn extends _e{constructor(e){super(e),this._inputValue=null,this._labelContent=null,this._innerContent=null,this._descriptionContent=null,this._ariaLabel=null,this._hasAppliedAriaLabel=!1,this._ariaValueText=null,this._hasAppliedAriaValueText=!1,this._accessibleName=null,this._helpText=null,this._pdomHeading=null,this.focusHighlightChangedEmitter=new re,this.pdomParentChangedEmitter=new re,this.pdomDisplaysEmitter=new re,this._onPDOMContentChangeListener=this.onPDOMContentChange.bind(this),this._onInputValueChangeListener=this.invalidatePeerInputValue.bind(this),this._onAriaLabelChangeListener=this.onAriaLabelChange.bind(this),this._onAriaValueTextChangeListener=this.onAriaValueTextChange.bind(this),this._onLabelContentChangeListener=this.invalidatePeerLabelSiblingContent.bind(this),this._onDescriptionContentChangeListener=this.invalidatePeerDescriptionSiblingContent.bind(this),this._onInnerContentChangeListener=this.onInnerContentPropertyChange.bind(this),this._tagName=null,this._containerTagName=null,this._labelTagName=null,this._descriptionTagName=null,this._inputType=null,this._pdomChecked=!1,this._appendLabel=!1,this._appendDescription=!1,this._pdomAttributes=[],this._pdomClasses=[],this._pdomNamespace=null,this._ariaRole=null,this._containerAriaRole=null,this._ariaLabelledbyAssociations=[],this._nodesThatAreAriaLabelledbyThisNode=[],this._ariaDescribedbyAssociations=[],this._nodesThatAreAriaDescribedbyThisNode=[],this._activeDescendantAssociations=[],this._nodesThatAreActiveDescendantToThisNode=[],this._focusableOverride=null,this._focusHighlight=null,this._focusHighlightLayerable=!1,this._groupFocusHighlight=!1,this._pdomOrder=null,this._pdomParent=null,this._pdomTransformSourceNode=null,this._focusPanTargetBoundsProperty=null,this._limitPanDirection=null,this._pdomDisplaysInfo=new Gd(this),this._pdomInstances=[],this._positionInPDOM=!1,this.excludeLabelSiblingFromInput=!1,this._pdomVisibleProperty=new Ut(!0,!1,this.onPdomVisiblePropertyChange.bind(this)),this._accessibleNameBehavior=Bn.BASIC_ACCESSIBLE_NAME_BEHAVIOR,this._helpTextBehavior=Bn.HELP_TEXT_AFTER_CONTENT,this._headingLevel=null,this._pdomHeadingBehavior=Tg,this.pdomBoundInputEnabledListener=this.pdomInputEnabledListener.bind(this)}disposeParallelDOM(){O(this._accessibleName)&&!this._accessibleName.isDisposed&&(this._accessibleName.unlink(this._onPDOMContentChangeListener),this._accessibleName=null),O(this._helpText)&&!this._helpText.isDisposed&&(this._helpText.unlink(this._onPDOMContentChangeListener),this._helpText=null),O(this._pdomHeading)&&!this._pdomHeading.isDisposed&&(this._pdomHeading.unlink(this._onPDOMContentChangeListener),this._pdomHeading=null),O(this._inputValue)&&!this._inputValue.isDisposed&&(this._inputValue.unlink(this._onPDOMContentChangeListener),this._inputValue=null),O(this._ariaLabel)&&!this._ariaLabel.isDisposed&&this._ariaLabel.unlink(this._onAriaLabelChangeListener),O(this._ariaValueText)&&!this._ariaValueText.isDisposed&&this._ariaValueText.unlink(this._onAriaValueTextChangeListener),O(this._innerContent)&&!this._innerContent.isDisposed&&this._innerContent.unlink(this._onInnerContentChangeListener),O(this._labelContent)&&!this._labelContent.isDisposed&&this._labelContent.unlink(this._onLabelContentChangeListener),O(this._descriptionContent)&&!this._descriptionContent.isDisposed&&this._descriptionContent.unlink(this._onDescriptionContentChangeListener),this.inputEnabledProperty.unlink(this.pdomBoundInputEnabledListener),this.pdomOrder=null,this.setPDOMTransformSourceNode(null),this.setAriaLabelledbyAssociations([]),this.setAriaDescribedbyAssociations([]),this.setActiveDescendantAssociations([]),this.removePDOMAttributes(),this._pdomVisibleProperty.dispose()}pdomInputEnabledListener(e){this.setPDOMAttribute("aria-disabled",!e),this.setPDOMAttribute("onclick",e?"":"return false")}isFocused(){for(let e=0;e<this._pdomInstances.length;e++)if(this._pdomInstances[e].peer.isFocused())return!0;return!1}get focused(){return this.isFocused()}focus(){if(this._pdomInstances.length>0){assert&&assert(this.focusable,"trying to set focus on a node that is not focusable"),assert&&assert(this.pdomVisible,"trying to set focus on a node with invisible pdom content"),assert&&assert(this._pdomInstances.length===1,"focus() unsupported for Nodes using DAG, pdom content is not unique");const e=this._pdomInstances[0].peer;assert&&assert(e,"must have a peer to focus"),e.focus()}}blur(){if(this._pdomInstances.length>0){assert&&assert(this._pdomInstances.length===1,"blur() unsupported for Nodes using DAG, pdom content is not unique");const e=this._pdomInstances[0].peer;assert&&assert(e,"must have a peer to blur"),e.blur()}}pdomAudit(){this.hasPDOMContent&&assert&&(this._inputType&&assert(this._tagName.toUpperCase()===di,"tagName must be INPUT to support inputType"),this._pdomChecked&&assert(this._tagName.toUpperCase()===di,"tagName must be INPUT to support pdomChecked."),this._inputValue&&assert(this._tagName.toUpperCase()===di,"tagName must be INPUT to support inputValue"),this._pdomChecked&&assert(Tl.includes(this._inputType.toUpperCase()),`inputType does not support checked attribute: ${this._inputType}`),this._focusHighlightLayerable&&assert(this.focusHighlight instanceof D,"focusHighlight must be Node if highlight is layerable"),this._tagName.toUpperCase()===di&&assert(typeof this._inputType=="string"," inputType expected for input"),this.ariaRole==="application"&&assert(this.innerContent||this.accessibleName,"must have some innerContent or element will never be focusable in VoiceOver"));for(let e=0;e<this.children.length;e++)this.children[e].pdomAudit()}setAccessibleName(e){e!==this._accessibleName&&(O(this._accessibleName)&&!this._accessibleName.isDisposed&&this._accessibleName.unlink(this._onPDOMContentChangeListener),this._accessibleName=e,O(e)&&e.lazyLink(this._onPDOMContentChangeListener),this.onPDOMContentChange())}set accessibleName(e){this.setAccessibleName(e)}get accessibleName(){return this.getAccessibleName()}getAccessibleName(){return O(this._accessibleName)?this._accessibleName.value:this._accessibleName}removeFromPDOM(){assert&&assert(this._tagName!==null,"There is no pdom content to clear from the PDOM"),this.tagName=null}setAccessibleNameBehavior(e){this._accessibleNameBehavior!==e&&(this._accessibleNameBehavior=e,this.onPDOMContentChange())}set accessibleNameBehavior(e){this.setAccessibleNameBehavior(e)}get accessibleNameBehavior(){return this.getAccessibleNameBehavior()}getAccessibleNameBehavior(){return this._accessibleNameBehavior}setPDOMHeading(e){e!==this._pdomHeading&&(O(this._pdomHeading)&&!this._pdomHeading.isDisposed&&this._pdomHeading.unlink(this._onPDOMContentChangeListener),this._pdomHeading=e,O(e)&&e.lazyLink(this._onPDOMContentChangeListener),this.onPDOMContentChange())}set pdomHeading(e){this.setPDOMHeading(e)}get pdomHeading(){return this.getPDOMHeading()}getPDOMHeading(){return O(this._pdomHeading)?this._pdomHeading.value:this._pdomHeading}setPDOMHeadingBehavior(e){this._pdomHeadingBehavior!==e&&(this._pdomHeadingBehavior=e,this.onPDOMContentChange())}set pdomHeadingBehavior(e){this.setPDOMHeadingBehavior(e)}get pdomHeadingBehavior(){return this.getPDOMHeadingBehavior()}getPDOMHeadingBehavior(){return this._pdomHeadingBehavior}getHeadingLevel(){return this._headingLevel}get headingLevel(){return this.getHeadingLevel()}computeHeadingLevel(){if(!this._pdomParent)return this.pdomHeading?(this._headingLevel=1,1):0;if(this.pdomHeading){const e=this._pdomParent.computeHeadingLevel()+1;return this._headingLevel=e,e}else return this._pdomParent.computeHeadingLevel()}setHelpText(e){e!==this._helpText&&(O(this._helpText)&&!this._helpText.isDisposed&&this._helpText.unlink(this._onPDOMContentChangeListener),this._helpText=e,O(e)&&e.lazyLink(this._onPDOMContentChangeListener),this.onPDOMContentChange())}set helpText(e){this.setHelpText(e)}get helpText(){return this.getHelpText()}getHelpText(){return O(this._helpText)?this._helpText.value:this._helpText}setHelpTextBehavior(e){this._helpTextBehavior!==e&&(this._helpTextBehavior=e,this.onPDOMContentChange())}set helpTextBehavior(e){this.setHelpTextBehavior(e)}get helpTextBehavior(){return this.getHelpTextBehavior()}getHelpTextBehavior(){return this._helpTextBehavior}setTagName(e){assert&&assert(e===null||typeof e=="string"),e!==this._tagName&&(this._tagName=e,this.onPDOMContentChange())}set tagName(e){this.setTagName(e)}get tagName(){return this.getTagName()}getTagName(){return this._tagName}setLabelTagName(e){assert&&assert(e===null||typeof e=="string"),e!==this._labelTagName&&(this._labelTagName=e,this.onPDOMContentChange())}set labelTagName(e){this.setLabelTagName(e)}get labelTagName(){return this.getLabelTagName()}getLabelTagName(){return this._labelTagName}setDescriptionTagName(e){assert&&assert(e===null||typeof e=="string"),e!==this._descriptionTagName&&(this._descriptionTagName=e,this.onPDOMContentChange())}set descriptionTagName(e){this.setDescriptionTagName(e)}get descriptionTagName(){return this.getDescriptionTagName()}getDescriptionTagName(){return this._descriptionTagName}setInputType(e){if(assert&&assert(e===null||typeof e=="string"),assert&&this.tagName&&assert(this._tagName.toUpperCase()===di,"tag name must be INPUT to support inputType"),e!==this._inputType){this._inputType=e;for(let t=0;t<this._pdomInstances.length;t++){const s=this._pdomInstances[t].peer;e===null?s.removeAttributeFromElement("type"):s.setAttributeToElement("type",e)}}}set inputType(e){this.setInputType(e)}get inputType(){return this.getInputType()}getInputType(){return this._inputType}setAppendLabel(e){this._appendLabel!==e&&(this._appendLabel=e,this.onPDOMContentChange())}set appendLabel(e){this.setAppendLabel(e)}get appendLabel(){return this.getAppendLabel()}getAppendLabel(){return this._appendLabel}setAppendDescription(e){this._appendDescription!==e&&(this._appendDescription=e,this.onPDOMContentChange())}set appendDescription(e){this.setAppendDescription(e)}get appendDescription(){return this.getAppendDescription()}getAppendDescription(){return this._appendDescription}setContainerTagName(e){assert&&assert(e===null||typeof e=="string",`invalid tagName argument: ${e}`),this._containerTagName!==e&&(this._containerTagName=e,this.onPDOMContentChange())}set containerTagName(e){this.setContainerTagName(e)}get containerTagName(){return this.getContainerTagName()}getContainerTagName(){return this._containerTagName}invalidatePeerLabelSiblingContent(){const e=this.labelContent;this._labelTagName||this.setLabelTagName(Dg);for(let t=0;t<this._pdomInstances.length;t++)this._pdomInstances[t].peer.setLabelSiblingContent(e)}setLabelContent(e){e!==this._labelContent&&(O(this._labelContent)&&!this._labelContent.isDisposed&&this._labelContent.unlink(this._onLabelContentChangeListener),this._labelContent=e,O(e)&&e.lazyLink(this._onLabelContentChangeListener),this.invalidatePeerLabelSiblingContent())}set labelContent(e){this.setLabelContent(e)}get labelContent(){return this.getLabelContent()}getLabelContent(){return Ui(this._labelContent)}onInnerContentPropertyChange(){const e=this.innerContent;for(let t=0;t<this._pdomInstances.length;t++)this._pdomInstances[t].peer.setPrimarySiblingContent(e)}setInnerContent(e){e!==this._innerContent&&(O(this._innerContent)&&!this._innerContent.isDisposed&&this._innerContent.unlink(this._onInnerContentChangeListener),this._innerContent=e,O(e)&&e.lazyLink(this._onInnerContentChangeListener),this.onInnerContentPropertyChange())}set innerContent(e){this.setInnerContent(e)}get innerContent(){return this.getInnerContent()}getInnerContent(){return Ui(this._innerContent)}invalidatePeerDescriptionSiblingContent(){const e=this.descriptionContent;this._descriptionTagName||this.setDescriptionTagName(wg);for(let t=0;t<this._pdomInstances.length;t++)this._pdomInstances[t].peer.setDescriptionSiblingContent(e)}setDescriptionContent(e){e!==this._descriptionContent&&(O(this._descriptionContent)&&!this._descriptionContent.isDisposed&&this._descriptionContent.unlink(this._onDescriptionContentChangeListener),this._descriptionContent=e,O(e)&&e.lazyLink(this._onDescriptionContentChangeListener),this.invalidatePeerDescriptionSiblingContent())}set descriptionContent(e){this.setDescriptionContent(e)}get descriptionContent(){return this.getDescriptionContent()}getDescriptionContent(){return Ui(this._descriptionContent)}setAriaRole(e){assert&&assert(e===null||typeof e=="string"),this._ariaRole!==e&&(this._ariaRole=e,e!==null?this.setPDOMAttribute("role",e):this.removePDOMAttribute("role"))}set ariaRole(e){this.setAriaRole(e)}get ariaRole(){return this.getAriaRole()}getAriaRole(){return this._ariaRole}setContainerAriaRole(e){assert&&assert(e===null||typeof e=="string"),this._containerAriaRole!==e&&(this._containerAriaRole=e,e===null?this.removePDOMAttribute("role",{elementName:ns.CONTAINER_PARENT}):this.setPDOMAttribute("role",e,{elementName:ns.CONTAINER_PARENT}))}set containerAriaRole(e){this.setContainerAriaRole(e)}get containerAriaRole(){return this.getContainerAriaRole()}getContainerAriaRole(){return this._containerAriaRole}onAriaValueTextChange(){const e=this.ariaValueText;e===null?this._hasAppliedAriaLabel&&(this.removePDOMAttribute("aria-valuetext"),this._hasAppliedAriaLabel=!1):(this.setPDOMAttribute("aria-valuetext",e),this._hasAppliedAriaLabel=!0)}setAriaValueText(e){this._ariaValueText!==e&&(O(this._ariaValueText)&&!this._ariaValueText.isDisposed&&this._ariaValueText.unlink(this._onAriaValueTextChangeListener),this._ariaValueText=e,O(e)&&e.lazyLink(this._onAriaValueTextChangeListener),this.onAriaValueTextChange())}set ariaValueText(e){this.setAriaValueText(e)}get ariaValueText(){return this.getAriaValueText()}getAriaValueText(){return Ui(this._ariaValueText)}setPDOMNamespace(e){return assert&&assert(e===null||typeof e=="string"),this._pdomNamespace!==e&&(this._pdomNamespace=e,this.onPDOMContentChange()),this}set pdomNamespace(e){this.setPDOMNamespace(e)}get pdomNamespace(){return this.getPDOMNamespace()}getPDOMNamespace(){return this._pdomNamespace}onAriaLabelChange(){const e=this.ariaLabel;e===null?this._hasAppliedAriaLabel&&(this.removePDOMAttribute("aria-label"),this._hasAppliedAriaLabel=!1):(this.setPDOMAttribute("aria-label",e),this._hasAppliedAriaLabel=!0)}setAriaLabel(e){this._ariaLabel!==e&&(O(this._ariaLabel)&&!this._ariaLabel.isDisposed&&this._ariaLabel.unlink(this._onAriaLabelChangeListener),this._ariaLabel=e,O(e)&&e.lazyLink(this._onAriaLabelChangeListener),this.onAriaLabelChange())}set ariaLabel(e){this.setAriaLabel(e)}get ariaLabel(){return this.getAriaLabel()}getAriaLabel(){return Ui(this._ariaLabel)}setFocusHighlight(e){this._focusHighlight!==e&&(this._focusHighlight=e,this._focusHighlightLayerable&&(assert&&assert(e instanceof D),e.visible=!1),this.focusHighlightChangedEmitter.emit())}set focusHighlight(e){this.setFocusHighlight(e)}get focusHighlight(){return this.getFocusHighlight()}getFocusHighlight(){return this._focusHighlight}setFocusHighlightLayerable(e){this._focusHighlightLayerable!==e&&(this._focusHighlightLayerable=e,this._focusHighlight&&(assert&&assert(this._focusHighlight instanceof D),this._focusHighlight.visible=!1,this.focusHighlightChangedEmitter.emit()))}set focusHighlightLayerable(e){this.setFocusHighlightLayerable(e)}get focusHighlightLayerable(){return this.getFocusHighlightLayerable()}getFocusHighlightLayerable(){return this._focusHighlightLayerable}setGroupFocusHighlight(e){this._groupFocusHighlight=e}set groupFocusHighlight(e){this.setGroupFocusHighlight(e)}get groupFocusHighlight(){return this.getGroupFocusHighlight()}getGroupFocusHighlight(){return this._groupFocusHighlight}setAriaLabelledbyAssociations(e){let t,s;if(assert)for(assert(Array.isArray(e)),s=0;s<e.length;s++)t=e[s];if(e.length===0&&this._ariaLabelledbyAssociations.length===0)return;const i=[],n=[],a=[];for(qs(e,this._ariaLabelledbyAssociations,n,i,a),s=0;s<i.length;s++)t=i[s],this.removeAriaLabelledbyAssociation(t);for(assert&&assert(this._ariaLabelledbyAssociations.length===a.length,"Removing associations should not have triggered other association changes"),s=0;s<n.length;s++){const o=e[s];this.addAriaLabelledbyAssociation(o)}}set ariaLabelledbyAssociations(e){this.setAriaLabelledbyAssociations(e)}get ariaLabelledbyAssociations(){return this.getAriaLabelledbyAssociations()}getAriaLabelledbyAssociations(){return this._ariaLabelledbyAssociations}addAriaLabelledbyAssociation(e){this._ariaLabelledbyAssociations.push(e),e.otherNode._nodesThatAreAriaLabelledbyThisNode.push(this),this.updateAriaLabelledbyAssociationsInPeers()}removeAriaLabelledbyAssociation(e){assert&&assert(_.includes(this._ariaLabelledbyAssociations,e)),this._ariaLabelledbyAssociations.splice(_.indexOf(this._ariaLabelledbyAssociations,e),1)[0].otherNode.removeNodeThatIsAriaLabelledByThisNode(this),this.updateAriaLabelledbyAssociationsInPeers()}removeNodeThatIsAriaLabelledByThisNode(e){const t=_.indexOf(this._nodesThatAreAriaLabelledbyThisNode,e);assert&&assert(t>=0),this._nodesThatAreAriaLabelledbyThisNode.splice(t,1)}updateAriaLabelledbyAssociationsInPeers(){for(let e=0;e<this.pdomInstances.length;e++)this.pdomInstances[e].peer.onAriaLabelledbyAssociationChange()}updateOtherNodesAriaLabelledby(){for(let e=0;e<this._nodesThatAreAriaLabelledbyThisNode.length;e++)this._nodesThatAreAriaLabelledbyThisNode[e].updateAriaLabelledbyAssociationsInPeers()}getNodesThatAreAriaLabelledbyThisNode(){return this._nodesThatAreAriaLabelledbyThisNode}get nodesThatAreAriaLabelledbyThisNode(){return this.getNodesThatAreAriaLabelledbyThisNode()}setAriaDescribedbyAssociations(e){let t;if(assert){assert(Array.isArray(e));for(let o=0;o<e.length;o++)t=e[o]}if(e.length===0&&this._ariaDescribedbyAssociations.length===0)return;const s=[],i=[],n=[];let a;for(qs(e,this._ariaDescribedbyAssociations,i,s,n),a=0;a<s.length;a++)t=s[a],this.removeAriaDescribedbyAssociation(t);for(assert&&assert(this._ariaDescribedbyAssociations.length===n.length,"Removing associations should not have triggered other association changes"),a=0;a<i.length;a++){const o=e[a];this.addAriaDescribedbyAssociation(o)}}set ariaDescribedbyAssociations(e){this.setAriaDescribedbyAssociations(e)}get ariaDescribedbyAssociations(){return this.getAriaDescribedbyAssociations()}getAriaDescribedbyAssociations(){return this._ariaDescribedbyAssociations}addAriaDescribedbyAssociation(e){assert&&assert(!_.includes(this._ariaDescribedbyAssociations,e),"describedby association already registed"),this._ariaDescribedbyAssociations.push(e),e.otherNode._nodesThatAreAriaDescribedbyThisNode.push(this),this.updateAriaDescribedbyAssociationsInPeers()}hasAriaDescribedbyAssociation(e){return _.includes(this._ariaDescribedbyAssociations,e)}removeAriaDescribedbyAssociation(e){assert&&assert(_.includes(this._ariaDescribedbyAssociations,e)),this._ariaDescribedbyAssociations.splice(_.indexOf(this._ariaDescribedbyAssociations,e),1)[0].otherNode.removeNodeThatIsAriaDescribedByThisNode(this),this.updateAriaDescribedbyAssociationsInPeers()}removeNodeThatIsAriaDescribedByThisNode(e){const t=_.indexOf(this._nodesThatAreAriaDescribedbyThisNode,e);assert&&assert(t>=0),this._nodesThatAreAriaDescribedbyThisNode.splice(t,1)}updateAriaDescribedbyAssociationsInPeers(){for(let e=0;e<this.pdomInstances.length;e++)this.pdomInstances[e].peer.onAriaDescribedbyAssociationChange()}updateOtherNodesAriaDescribedby(){for(let e=0;e<this._nodesThatAreAriaDescribedbyThisNode.length;e++)this._nodesThatAreAriaDescribedbyThisNode[e].updateAriaDescribedbyAssociationsInPeers()}getNodesThatAreAriaDescribedbyThisNode(){return this._nodesThatAreAriaDescribedbyThisNode}get nodesThatAreAriaDescribedbyThisNode(){return this.getNodesThatAreAriaDescribedbyThisNode()}setActiveDescendantAssociations(e){let t;if(assert){assert(Array.isArray(e));for(let o=0;o<e.length;o++)t=e[o]}if(e.length===0&&this._activeDescendantAssociations.length===0)return;const s=[],i=[],n=[];let a;for(qs(e,this._activeDescendantAssociations,i,s,n),a=0;a<s.length;a++)t=s[a],this.removeActiveDescendantAssociation(t);for(assert&&assert(this._activeDescendantAssociations.length===n.length,"Removing associations should not have triggered other association changes"),a=0;a<i.length;a++){const o=e[a];this.addActiveDescendantAssociation(o)}}set activeDescendantAssociations(e){this.setActiveDescendantAssociations(e)}get activeDescendantAssociations(){return this.getActiveDescendantAssociations()}getActiveDescendantAssociations(){return this._activeDescendantAssociations}addActiveDescendantAssociation(e){this._activeDescendantAssociations.push(e),e.otherNode._nodesThatAreActiveDescendantToThisNode.push(this),this.updateActiveDescendantAssociationsInPeers()}removeActiveDescendantAssociation(e){assert&&assert(_.includes(this._activeDescendantAssociations,e)),this._activeDescendantAssociations.splice(_.indexOf(this._activeDescendantAssociations,e),1)[0].otherNode.removeNodeThatIsActiveDescendantThisNode(this),this.updateActiveDescendantAssociationsInPeers()}removeNodeThatIsActiveDescendantThisNode(e){const t=_.indexOf(this._nodesThatAreActiveDescendantToThisNode,e);assert&&assert(t>=0),this._nodesThatAreActiveDescendantToThisNode.splice(t,1)}updateActiveDescendantAssociationsInPeers(){for(let e=0;e<this.pdomInstances.length;e++)this.pdomInstances[e].peer.onActiveDescendantAssociationChange()}updateOtherNodesActiveDescendant(){for(let e=0;e<this._nodesThatAreActiveDescendantToThisNode.length;e++)this._nodesThatAreActiveDescendantToThisNode[e].updateActiveDescendantAssociationsInPeers()}getNodesThatAreActiveDescendantToThisNode(){return this._nodesThatAreActiveDescendantToThisNode}get nodesThatAreActiveDescendantToThisNode(){return this.getNodesThatAreActiveDescendantToThisNode()}setPDOMOrder(e){if(assert&&assert(Array.isArray(e)||e===null,`Array or null expected, received: ${e}`),assert&&e&&e.forEach((t,s)=>{assert&&assert(t===null||t instanceof D,`Elements of pdomOrder should be either a Node or null. Element at index ${s} is: ${t}`)}),assert&&e&&assert(this.getTrails(t=>_.includes(e,t)).length===0,"pdomOrder should not include any ancestors or the node itself"),this._pdomOrder!==e){const t=this._pdomOrder;this._pdomOrder=e===null?null:e.slice(),St.pdomOrderChange(this,t,e),this.rendererSummaryRefreshEmitter.emit()}}set pdomOrder(e){this.setPDOMOrder(e)}get pdomOrder(){return this.getPDOMOrder()}getPDOMOrder(){return this._pdomOrder?this._pdomOrder.slice(0):this._pdomOrder}hasPDOMOrder(){return this._pdomOrder!==null&&this._pdomOrder.length!==0&&(this._pdomOrder.length>1||this._pdomOrder[0]!==null)}getPDOMParent(){return this._pdomParent}get pdomParent(){return this.getPDOMParent()}getEffectiveChildren(){const e=[];for(let t=0;t<this._children.length;t++){const s=this._children[t];s._pdomParent||e.push(s)}if(this.hasPDOMOrder()){const t=this.pdomOrder.slice(),s=t.indexOf(null);return s>=0?(e.unshift(s,1),Array.prototype.splice.apply(t,e)):Array.prototype.push.apply(t,e),t}else return e}onPdomVisiblePropertyChange(e){this._pdomDisplaysInfo.onPDOMVisibilityChange(e)}setPdomVisibleProperty(e){return this._pdomVisibleProperty.setTargetProperty(e),this}set pdomVisibleProperty(e){this.setPdomVisibleProperty(e)}get pdomVisibleProperty(){return this.getPdomVisibleProperty()}getPdomVisibleProperty(){return this._pdomVisibleProperty}setPDOMVisible(e){this.pdomVisibleProperty.value=e}set pdomVisible(e){this.setPDOMVisible(e)}get pdomVisible(){return this.isPDOMVisible()}isPDOMVisible(){return this.pdomVisibleProperty.value}isPDOMDisplayed(){for(let e=0;e<this._pdomInstances.length;e++)if(this._pdomInstances[e].isGloballyVisible())return!0;return!1}get pdomDisplayed(){return this.isPDOMDisplayed()}invalidatePeerInputValue(){for(let e=0;e<this.pdomInstances.length;e++)this.pdomInstances[e].peer.onInputValueChange()}setInputValue(e){assert&&this._tagName&&assert(_.includes(Cg,this._tagName.toUpperCase()),"dom element must be a form element to support value"),e!==this._inputValue&&(O(this._inputValue)&&!this._inputValue.isDisposed&&this._inputValue.unlink(this._onPDOMContentChangeListener),this._inputValue=e,O(e)&&e.lazyLink(this._onPDOMContentChangeListener),this.invalidatePeerInputValue())}set inputValue(e){this.setInputValue(e)}get inputValue(){return this.getInputValue()}getInputValue(){let e;return O(this._inputValue)?e=this._inputValue.value:e=this._inputValue,e===null?null:""+e}setPDOMChecked(e){this._tagName&&assert&&assert(this._tagName.toUpperCase()===di,"Cannot set checked on a non input tag."),this._inputType&&assert&&assert(Tl.includes(this._inputType.toUpperCase()),`inputType does not support checked: ${this._inputType}`),this._pdomChecked!==e&&(this._pdomChecked=e,this.setPDOMAttribute("checked",e,{asProperty:!0}))}set pdomChecked(e){this.setPDOMChecked(e)}get pdomChecked(){return this.getPDOMChecked()}getPDOMChecked(){return this._pdomChecked}getPDOMAttributes(){return this._pdomAttributes.slice(0)}get pdomAttributes(){return this.getPDOMAttributes()}setPDOMAttribute(e,t,s){assert&&s&&assert(Object.getPrototypeOf(s)===Object.prototype,"Extra prototype on pdomAttribute options object is a code smell");const i=E()({namespace:null,asProperty:!1,elementName:ns.PRIMARY_SIBLING},s);assert&&assert(!Ig.includes(e),"setPDOMAttribute does not support association attributes");for(let a=0;a<this._pdomAttributes.length;a++){const o=this._pdomAttributes[a];o.attribute===e&&o.options.namespace===i.namespace&&o.options.elementName===i.elementName&&(o.options.asProperty===i.asProperty?this._pdomAttributes.splice(a,1):this.removePDOMAttribute(o.attribute,o.options))}let n=a=>{assert&&typeof a=="string"&&Es(a,Dt.STRING_WITHOUT_TEMPLATE_VARS_VALIDATOR);for(let o=0;o<this._pdomInstances.length;o++)this._pdomInstances[o].peer.setAttributeToElement(e,a,i)};O(t)?t.link(n):(n(t),n=null),this._pdomAttributes.push({attribute:e,value:t,listener:n,options:i})}removePDOMAttribute(e,t){assert&&t&&assert(Object.getPrototypeOf(t)===Object.prototype,"Extra prototype on pdomAttribute options object is a code smell");const s=E()({namespace:null,elementName:ns.PRIMARY_SIBLING},t);let i=!1;for(let n=0;n<this._pdomAttributes.length;n++)if(this._pdomAttributes[n].attribute===e&&this._pdomAttributes[n].options.namespace===s.namespace&&this._pdomAttributes[n].options.elementName===s.elementName){const a=this._pdomAttributes[n];a.listener&&O(a.value)&&!a.value.isDisposed&&a.value.unlink(a.listener),this._pdomAttributes.splice(n,1),i=!0}assert&&assert(i,`Node does not have pdom attribute ${e}`);for(let n=0;n<this._pdomInstances.length;n++)this._pdomInstances[n].peer.removeAttributeFromElement(e,s)}removePDOMAttributes(){const e=this.getPDOMAttributes();for(let t=0;t<e.length;t++){const s=e[t].attribute;this.removePDOMAttribute(s)}}hasPDOMAttribute(e,t){assert&&t&&assert(Object.getPrototypeOf(t)===Object.prototype,"Extra prototype on pdomAttribute options object is a code smell");const s=E()({namespace:null,elementName:ns.PRIMARY_SIBLING},t);let i=!1;for(let n=0;n<this._pdomAttributes.length;n++)this._pdomAttributes[n].attribute===e&&this._pdomAttributes[n].options.namespace===s.namespace&&this._pdomAttributes[n].options.elementName===s.elementName&&(i=!0);return i}setPDOMClass(e,t){const s=E()({elementName:ns.PRIMARY_SIBLING},t);for(let i=0;i<this._pdomClasses.length;i++){const n=this._pdomClasses[i];if(n.className===e&&n.options.elementName===s.elementName)return}this._pdomClasses.push({className:e,options:s});for(let i=0;i<this._pdomInstances.length;i++)this._pdomInstances[i].peer.setClassToElement(e,s)}removePDOMClass(e,t){const s=E()({elementName:ns.PRIMARY_SIBLING},t);let i=!1;for(let n=0;n<this._pdomClasses.length;n++)this._pdomClasses[n].className===e&&this._pdomClasses[n].options.elementName===s.elementName&&(this._pdomClasses.splice(n,1),i=!0);assert&&assert(i,`Node does not have pdom attribute ${e}`);for(let n=0;n<this._pdomClasses.length;n++)this.pdomInstances[n].peer.removeClassFromElement(e,s)}getPDOMClasses(){return this._pdomClasses.slice(0)}get pdomClasses(){return this.getPDOMClasses()}setFocusable(e){if(assert&&assert(e===null||typeof e=="boolean"),this._focusableOverride!==e){this._focusableOverride=e;for(let t=0;t<this._pdomInstances.length;t++)assert&&assert(this._pdomInstances[t].peer,"Peer required to set focusable."),this._pdomInstances[t].peer.setFocusable(this.focusable)}}set focusable(e){this.setFocusable(e)}get focusable(){return this.isFocusable()}isFocusable(){return this._focusableOverride!==null?this._focusableOverride:this._tagName===null?!1:N.tagIsDefaultFocusable(this._tagName)}setPDOMTransformSourceNode(e){this._pdomTransformSourceNode=e;for(let t=0;t<this._pdomInstances.length;t++)this._pdomInstances[t].peer.setPDOMTransformSourceNode(this._pdomTransformSourceNode)}set pdomTransformSourceNode(e){this.setPDOMTransformSourceNode(e)}get pdomTransformSourceNode(){return this.getPDOMTransformSourceNode()}getPDOMTransformSourceNode(){return this._pdomTransformSourceNode}setFocusPanTargetBoundsProperty(e){e!==this._focusPanTargetBoundsProperty&&(assert&&assert(!this._focusPanTargetBoundsProperty,"Cannot change focusPanTargetBoundsProperty after it is set."),this._focusPanTargetBoundsProperty=e)}getFocusPanTargetBoundsProperty(){return this._focusPanTargetBoundsProperty}set focusPanTargetBoundsProperty(e){this.setFocusPanTargetBoundsProperty(e)}get focusPanTargetBoundsProperty(){return this.getFocusPanTargetBoundsProperty()}setLimitPanDirection(e){this._limitPanDirection=e}getLimitPanDirection(){return this._limitPanDirection}set limitPanDirection(e){this.setLimitPanDirection(e)}get limitPanDirection(){return this.getLimitPanDirection()}setPositionInPDOM(e){this._positionInPDOM=e;for(let t=0;t<this._pdomInstances.length;t++)this._pdomInstances[t].peer.setPositionInPDOM(e)}set positionInPDOM(e){this.setPositionInPDOM(e)}get positionInPDOM(){return this.getPositionInPDOM()}getPositionInPDOM(){return this._positionInPDOM}setExcludeLabelSiblingFromInput(){this.excludeLabelSiblingFromInput=!0,this.onPDOMContentChange()}isInsidePhetioArchetype(e=this){if(e.isPhetioInstrumented())return e.phetioIsArchetype;for(let t=0;t<e.parents.length;t++)if(this.isInsidePhetioArchetype(e.parents[t]))return!0;return!1}alertDescriptionUtterance(e){if(ki.value||se.PHET_IO_ENABLED&&this.isInsidePhetioArchetype())return;const t=this.getConnectedDisplays();for(let s=0;s<t.length;s++){const i=t[s];i.isAccessible()&&i.descriptionUtteranceQueue.addToBack(e)}}forEachUtteranceQueue(e){const t=this.getConnectedDisplays();assert&&assert(t.length>0,"must be connected to a display to use UtteranceQueue features");for(let s=0;s<t.length;s++){const i=t[s];i.isAccessible()&&e(i.descriptionUtteranceQueue)}}getBaseOptions(){const e={};for(let t=0;t<Lo.length;t++){const s=Lo[t];e[s]=this[s]}return e}getNestedPDOMOrder(){const e=new R(this);let t=[];const s=[],i=[s];function n(a,o){let h=0;if(_.each(t,u=>{a===u&&h++}),h>1||h===1&&!o)return;if(a.hasPDOMContent){const u={trail:e.copy(),children:[]};i[i.length-1].push(u),i.push(u.children)}const l=a._pdomOrder===null?[]:a._pdomOrder;t=t.concat(l),_.each(l,u=>{_.each(a.getLeafTrailsTo(u),m=>{m.removeAncestor(),e.addDescendantTrail(m),n(u,!0),e.removeDescendantTrail(m)})});const c=a._children.length;for(let u=0;u<c;u++){const m=a._children[u];e.addDescendant(m,u),n(m,!1),e.removeDescendant()}_.each(l,()=>{t.pop()}),a.hasPDOMContent&&i.pop()}return n(this,!1),s}onPDOMContentChange(){St.pdomContentChange(this),this.pdomHeading&&this.computeHeadingLevel(),this.rendererSummaryRefreshEmitter.emit()}get hasPDOMContent(){return!!this._tagName}onPDOMAddChild(e){sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.ParallelDOM(`onPDOMAddChild n#${e.id} (parent:n#${this.id})`),sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.push(),assert&&function(s){s._rendererSummary.hasNoPDOM()||s.pdomOrder&&assert(s.getTrails(i=>_.includes(s.pdomOrder,i)).length===0,"pdomOrder should not include any ancestors or the node itself")}(e),assert&&St.auditNodeForPDOMCycles(this),this._pdomDisplaysInfo.onAddChild(e),St.addChild(this,e),sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.pop()}onPDOMRemoveChild(e){sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.ParallelDOM(`onPDOMRemoveChild n#${e.id} (parent:n#${this.id})`),sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.push(),this._pdomDisplaysInfo.onRemoveChild(e),St.removeChild(this,e),e.updateOtherNodesAriaLabelledby(),e.updateOtherNodesAriaDescribedby(),e.updateOtherNodesActiveDescendant(),sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.pop()}onPDOMReorderedChildren(){sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.ParallelDOM(`onPDOMReorderedChildren (parent:n#${this.id})`),sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.push(),St.childrenOrderChange(this),sceneryLog&&sceneryLog.ParallelDOM&&sceneryLog.pop()}updateLinkedElementForProperty(e,t,s){if(assert&&assert(t!==s,"should not be called on same values"),this.isPhetioInstrumented()){t&&t instanceof ft&&t.isPhetioInstrumented()&&t instanceof _e&&this.removeLinkedElements(t);const i=this.tandem.createTandem(e);s&&s instanceof ft&&s.isPhetioInstrumented()&&s instanceof _e&&i!==s.tandem&&this.addLinkedElement(s,{tandemName:e})}}getPDOMInstances(){return this._pdomInstances}get pdomInstances(){return this.getPDOMInstances()}addPDOMInstance(e){this._pdomInstances.push(e)}removePDOMInstance(e){const t=_.indexOf(this._pdomInstances,e);assert&&assert(t!==-1,"Cannot remove a PDOMInstance from a Node if it was not there"),this._pdomInstances.splice(t,1)}static BASIC_ACCESSIBLE_NAME_BEHAVIOR(e,t,s){return e.tagName==="input"?(t.labelTagName="label",t.labelContent=s):N.tagNameSupportsContent(e.tagName)?t.innerContent=s:t.ariaLabel=s,t}static HELP_TEXT_BEFORE_CONTENT(e,t,s){return t.descriptionTagName=N.DEFAULT_DESCRIPTION_TAG_NAME,t.descriptionContent=s,t.appendDescription=!1,t}static HELP_TEXT_AFTER_CONTENT(e,t,s){return t.descriptionTagName=N.DEFAULT_DESCRIPTION_TAG_NAME,t.descriptionContent=s,t.appendDescription=!0,t}}d.register("ParallelDOM",Bn);const La="enabledProperty";class Fn extends ie{constructor(e,t){const s=E()({phetioDocumentation:"Determines whether the element is enabled (true) or disabled (false).",phetioFeatured:!0,checkTandemName:!0},t);assert&&s&&s.tandem&&s.tandem.supplied&&s.checkTandemName&&assert&&assert(s.tandem.name===La,`EnabledProperty tandems should be named ${La}`),super(e,s)}static get TANDEM_NAME(){return La}}it.register("EnabledProperty",Fn);class cn extends X{constructor(e,t){super(e),this.onAccessAttempt=t}get(){return this.onAccessAttempt(),super.get()}set(e){throw new Error("Cannot set a TinyStaticProperty value")}isSettable(){return!1}notifyListeners(e){this.emit(this.get(),e,this)}link(e){this.addListener(e),e(this.get(),null,this)}equalsValue(e){return this.areValuesEqual(e,this.get())}}it.register("TinyStaticProperty",cn);let Eg=1;const Yi=w.NOTHING.copy(),kg=w.NOTHING.copy(),va=new C,Pa=Fn.TANDEM_NAME,_a="visibleProperty",Sa="inputEnabledProperty",Fd=!1;let Ki=0,Xi=0;const cs=["leftTop","centerTop","rightTop","leftCenter","center","rightCenter","leftBottom","centerBottom","rightBottom","left","right","top","bottom","centerX","centerY"],Ag=["children","cursor","phetioVisiblePropertyInstrumented","visibleProperty","visible","pickableProperty","pickable","phetioEnabledPropertyInstrumented","enabledProperty","enabled","phetioInputEnabledPropertyInstrumented","inputEnabledProperty","inputEnabled","inputListeners","opacity","disabledOpacity","filters","matrix","translation","x","y","rotation","scale","excludeInvisibleChildrenFromBounds","layoutOptions","localBounds","maxWidth","maxHeight","renderer","layerSplit","usesOpacity","cssTransform","excludeInvisible","webglScale","preventFit","mouseArea","touchArea","clipArea","transformBounds",...cs],ve={phetioVisiblePropertyInstrumented:!0,visible:!0,opacity:1,disabledOpacity:1,pickable:null,enabled:!0,phetioEnabledPropertyInstrumented:!1,inputEnabled:!0,phetioInputEnabledPropertyInstrumented:!1,clipArea:null,mouseArea:null,touchArea:null,cursor:null,transformBounds:!1,maxWidth:null,maxHeight:null,renderer:null,usesOpacity:!1,layerSplit:!1,cssTransform:!1,excludeInvisible:!1,webglScale:null,preventFit:!1},xg=ve.renderer===null?0:p.fromName(ve.renderer);var We;let ti=(We=class extends Bn{constructor(e){super(),this.childrenChangedEmitter=new re,this.childInsertedEmitter=new re,this.childRemovedEmitter=new re,this.childrenReorderedEmitter=new re,this.parentAddedEmitter=new re,this.parentRemovedEmitter=new re,this.transformEmitter=new re,this.instanceRefreshEmitter=new re,this.rendererSummaryRefreshEmitter=new re,this.filterChangeEmitter=new re,this.changedInstanceEmitter=new re,this.rootedDisplayChangedEmitter=new re,this.layoutOptionsChangedEmitter=new re,this._activeParentLayoutConstraint=null,this._id=Eg++,this._instances=[],this._rootedDisplays=[],this._drawables=[],this._visibleProperty=new Ut(ve.visible,ve.phetioVisiblePropertyInstrumented,this.onVisiblePropertyChange.bind(this)),this.opacityProperty=new X(ve.opacity,this.onOpacityPropertyChange.bind(this)),this.disabledOpacityProperty=new X(ve.disabledOpacity,this.onDisabledOpacityPropertyChange.bind(this)),this._pickableProperty=new Ut(ve.pickable,!1,this.onPickablePropertyChange.bind(this)),this._enabledProperty=new Ut(ve.enabled,ve.phetioEnabledPropertyInstrumented,this.onEnabledPropertyChange.bind(this)),this._inputEnabledProperty=new Ut(ve.inputEnabled,ve.phetioInputEnabledPropertyInstrumented),this.clipAreaProperty=new X(ve.clipArea),this.voicingVisibleProperty=new X(!0),this._mouseArea=ve.mouseArea,this._touchArea=ve.touchArea,this._cursor=ve.cursor,this._children=[],this._parents=[],this._transformBounds=ve.transformBounds,this._transform=new Bt,this._transformListener=this.onTransformChange.bind(this),this._transform.changeEmitter.addListener(this._transformListener),this._maxWidth=ve.maxWidth,this._maxHeight=ve.maxHeight,this._appliedScaleFactor=1,this._inputListeners=[],this._renderer=xg,this._usesOpacity=ve.usesOpacity,this._layerSplit=ve.layerSplit,this._cssTransform=ve.cssTransform,this._excludeInvisible=ve.excludeInvisible,this._webglScale=ve.webglScale,this._preventFit=ve.preventFit,this.inputEnabledProperty.lazyLink(this.pdomBoundInputEnabledListener);const t=this.onBoundsListenersAddedOrRemoved.bind(this),s=this.validateBounds.bind(this),i=this.validateSelfBounds.bind(this);this.boundsProperty=new cn(w.NOTHING.copy(),s),this.boundsProperty.changeCount=t,this.localBoundsProperty=new cn(w.NOTHING.copy(),s),this.localBoundsProperty.changeCount=t,this.childBoundsProperty=new cn(w.NOTHING.copy(),s),this.childBoundsProperty.changeCount=t,this.selfBoundsProperty=new cn(w.NOTHING.copy(),i),this._localBoundsOverridden=!1,this._excludeInvisibleChildrenFromBounds=!1,this._layoutOptions=null,this._boundsDirty=!0,this._localBoundsDirty=!0,this._selfBoundsDirty=!0,this._childBoundsDirty=!0,assert&&(this._originalBounds=this.boundsProperty._value,this._originalLocalBounds=this.localBoundsProperty._value,this._originalSelfBounds=this.selfBoundsProperty._value,this._originalChildBounds=this.childBoundsProperty._value),this._filters=[],this._rendererBitmask=p.bitmaskNodeDefault,this._rendererSummary=new wa(this),this._boundsEventCount=0,this._boundsEventSelfCount=0,this._picker=new Hd(this),this._isGettingRemovedFromParent=!1,e&&this.mutate(e)}insertChild(e,t,s){var i,n,a,o;if(assert&&assert(t!=null,"insertChild cannot insert a null/undefined child"),assert&&assert(!_.includes(this._children,t),"Parent already contains child"),assert&&assert(t!==this,"Cannot add self as a child"),assert&&assert(t._parents!==null,"Tried to insert a disposed child node?"),assert&&assert(!t.isDisposed,"Tried to insert a disposed Node"),this._picker.onInsertChild(t),this.changeBoundsEventCount(t._boundsEventCount>0?1:0),this._rendererSummary.summaryChange(wa.bitmaskAll,t._rendererSummary.bitmask),t._parents.push(this),assert&&((n=(i=window.phet)==null?void 0:i.chipper)!=null&&n.queryParameters)&&isFinite(phet.chipper.queryParameters.parentLimit)){const h=t._parents.length;Ki<h&&(Ki=h,console.log(`Max Node parents: ${Ki}`),assert(Ki<=phet.chipper.queryParameters.parentLimit,`parent count of ${Ki} above ?parentLimit=${phet.chipper.queryParameters.parentLimit}`))}if(this._children.splice(e,0,t),assert&&((o=(a=window.phet)==null?void 0:a.chipper)!=null&&o.queryParameters)&&isFinite(phet.chipper.queryParameters.childLimit)){const h=this._children.length;Xi<h&&(Xi=h,console.log(`Max Node children: ${Xi}`),assert(Xi<=phet.chipper.queryParameters.childLimit,`child count of ${Xi} above ?childLimit=${phet.chipper.queryParameters.childLimit}`))}return t._rendererSummary.hasNoPDOM()||this.onPDOMAddChild(t),t.invalidateBounds(),this._boundsDirty=!0,this.childInsertedEmitter.emit(t,e),t.parentAddedEmitter.emit(this),!s&&this.childrenChangedEmitter.emit(),assertSlow&&this._picker.audit(),this}addChild(e,t){return this.insertChild(this._children.length,e,t),this}removeChild(e,t){assert&&assert(e&&e instanceof We,"Need to call node.removeChild() with a Node."),assert&&assert(this.hasChild(e),"Attempted to removeChild with a node that was not a child.");const s=_.indexOf(this._children,e);return this.removeChildWithIndex(e,s,t),this}removeChildAt(e,t){assert&&assert(e>=0),assert&&assert(e<this._children.length);const s=this._children[e];return this.removeChildWithIndex(s,e,t),this}removeChildWithIndex(e,t,s){assert&&assert(e&&e instanceof We,"Need to call node.removeChildWithIndex() with a Node."),assert&&assert(this.hasChild(e),"Attempted to removeChild with a node that was not a child."),assert&&assert(this._children[t]===e,"Incorrect index for removeChildWithIndex"),assert&&assert(e._parents!==null,"Tried to remove a disposed child node?");const i=_.indexOf(e._parents,this);e._isGettingRemovedFromParent=!0,e._rendererSummary.hasNoPDOM()||this.onPDOMRemoveChild(e),this._picker.onRemoveChild(e),this.changeBoundsEventCount(e._boundsEventCount>0?-1:0),this._rendererSummary.summaryChange(e._rendererSummary.bitmask,wa.bitmaskAll),e._parents.splice(i,1),this._children.splice(t,1),e._isGettingRemovedFromParent=!1,this.invalidateBounds(),this._childBoundsDirty=!0,this.childRemovedEmitter.emit(e,t),e.parentRemovedEmitter.emit(this),!s&&this.childrenChangedEmitter.emit(),assertSlow&&this._picker.audit()}moveChildToIndex(e,t){assert&&assert(this.hasChild(e),"Attempted to moveChildToIndex with a node that was not a child."),assert&&assert(t%1===0&&t>=0&&t<this._children.length,`Invalid index: ${t}`);const s=this.indexOfChild(e);return this._children[t]!==e&&(this._children.splice(s,1),this._children.splice(t,0,e),this._rendererSummary.hasNoPDOM()||this.onPDOMReorderedChildren(),this.childrenReorderedEmitter.emit(Math.min(s,t),Math.max(s,t)),this.childrenChangedEmitter.emit()),this}removeAllChildren(){return this.setChildren([]),this}setChildren(e){const t=[],s=[],i=[];let n;for(qs(e,this._children,s,t,i),n=t.length-1;n>=0;n--)this.removeChild(t[n],!0);assert&&assert(this._children.length===i.length,"Removing children should not have triggered other children changes");let a=-1,o=-1;for(n=0;n<i.length;n++){const l=i[n];this._children[n]!==l&&(this._children[n]=l,a===-1&&(a=n),o=n)}const h=a!==-1;if(h&&(this._rendererSummary.hasNoPDOM()||this.onPDOMReorderedChildren(),this.childrenReorderedEmitter.emit(a,o)),s.length){let l=0,c=s[l];for(n=0;n<e.length;n++)e[n]===c&&(this.insertChild(n,c,!0),c=s[++l])}if((t.length!==0||s.length!==0||h)&&this.childrenChangedEmitter.emit(),assert)for(let l=0;l<this._children.length;l++)assert(e[l]===this._children[l],"Incorrect child after setChildren, possibly a reentrancy issue");return this}set children(e){this.setChildren(e)}get children(){return this.getChildren()}getChildren(){return this._children.slice(0)}getChildrenCount(){return this._children.length}getParents(){return this._parents.slice(0)}get parents(){return this.getParents()}getParent(){return assert&&assert(this._parents.length<=1,"Cannot call getParent on a node with multiple parents"),this._parents.length?this._parents[0]:null}get parent(){return this.getParent()}getChildAt(e){return this._children[e]}indexOfParent(e){return _.indexOf(this._parents,e)}indexOfChild(e){return _.indexOf(this._children,e)}moveToFront(){return _.each(this.parents,e=>e.moveChildToFront(this)),this}moveChildToFront(e){return this.moveChildToIndex(e,this._children.length-1)}moveForward(){return this.parents.forEach(e=>e.moveChildForward(this)),this}moveChildForward(e){const t=this.indexOfChild(e);return t<this.getChildrenCount()-1&&this.moveChildToIndex(e,t+1),this}moveBackward(){return this.parents.forEach(e=>e.moveChildBackward(this)),this}moveChildBackward(e){const t=this.indexOfChild(e);return t>0&&this.moveChildToIndex(e,t-1),this}moveToBack(){return _.each(this.parents,e=>e.moveChildToBack(this)),this}moveChildToBack(e){return this.moveChildToIndex(e,0)}replaceChild(e,t){assert&&assert(this.hasChild(e),"Attempted to replace a node that was not a child.");const s=this.indexOfChild(e),i=e.focused;return this.removeChild(e,!0),this.insertChild(s,t,!0),this.childrenChangedEmitter.emit(),i&&t.focusable&&t.focus(),this}detach(){return _.each(this._parents.slice(0),e=>e.removeChild(this)),this}changeBoundsEventCount(e){if(e!==0){const t=this._boundsEventCount===0;this._boundsEventCount+=e,assert&&assert(this._boundsEventCount>=0,"subtree bounds event count should be guaranteed to be >= 0");const s=this._boundsEventCount===0;if(t!==s){const i=t?1:-1,n=this._parents.length;for(let a=0;a<n;a++)this._parents[a].changeBoundsEventCount(i)}}}validateSelfBounds(){if(this._selfBoundsDirty){const e=Yi.set(this.selfBoundsProperty._value),t=this.updateSelfBounds();return this._selfBoundsDirty=!1,t&&this.selfBoundsProperty.notifyListeners(e),!0}return!1}validateBounds(){sceneryLog&&sceneryLog.bounds&&sceneryLog.bounds(`validateBounds #${this._id}`),sceneryLog&&sceneryLog.bounds&&sceneryLog.push();let e;const t=1e-13;let s=this.validateSelfBounds();const i=this.childBoundsProperty._value,n=this.localBoundsProperty._value,a=this.selfBoundsProperty._value,o=this.boundsProperty._value;if(this._childBoundsDirty){for(s=!0,sceneryLog&&sceneryLog.bounds&&sceneryLog.bounds("childBounds dirty"),e=this._children.length;e--;){const l=this._children[e];l&&l.validateBounds()}const h=Yi.set(i);for(i.set(w.NOTHING),e=this._children.length;e--;){const l=this._children[e];(l&&!this._excludeInvisibleChildrenFromBounds||l.isVisible())&&i.includeBounds(l.bounds)}this._childBoundsDirty=!1,sceneryLog&&sceneryLog.bounds&&sceneryLog.bounds(`childBounds: ${i}`),i.equals(h)||i.equalsEpsilon(h,t)||this.childBoundsProperty.notifyListeners(h)}if(this._localBoundsDirty){s=!0,sceneryLog&&sceneryLog.bounds&&sceneryLog.bounds("localBounds dirty"),this._localBoundsDirty=!1;const h=Yi.set(n);if(!this._localBoundsOverridden){n.set(a).includeBounds(i);const l=this.clipArea;l&&n.constrainBounds(l.bounds)}sceneryLog&&sceneryLog.bounds&&sceneryLog.bounds(`localBounds: ${n}`),(this._maxWidth!==null||this._maxHeight!==null)&&this.updateMaxDimension(n),n.equals(h)||(this._boundsDirty=!0,n.equalsEpsilon(h,t)||this.localBoundsProperty.notifyListeners(h))}if(this._boundsDirty){s=!0,sceneryLog&&sceneryLog.bounds&&sceneryLog.bounds("bounds dirty"),this._boundsDirty=!1;const h=Yi.set(o);if(this._transformBounds&&!this._transform.getMatrix().isAxisAligned()){const l=va.set(this.getMatrix());o.set(w.NOTHING),this._includeTransformedSubtreeBounds(l,o);const c=this.clipArea;c&&o.constrainBounds(c.getBoundsWithTransform(l))}else o.set(n),this.transformBoundsFromLocalToParent(o);if(sceneryLog&&sceneryLog.bounds&&sceneryLog.bounds(`bounds: ${o}`),!o.equals(h)){for(e=this._parents.length;e--;)this._parents[e].invalidateBounds();o.equalsEpsilon(h,t)||this.boundsProperty.notifyListeners(h)}}return(this._childBoundsDirty||this._boundsDirty)&&(sceneryLog&&sceneryLog.bounds&&sceneryLog.bounds("revalidation"),this.validateBounds()),assert&&(assert(this._originalBounds===this.boundsProperty._value,"Reference for bounds changed!"),assert(this._originalLocalBounds===this.localBoundsProperty._value,"Reference for localBounds changed!"),assert(this._originalSelfBounds===this.selfBoundsProperty._value,"Reference for selfBounds changed!"),assert(this._originalChildBounds===this.childBoundsProperty._value,"Reference for childBounds changed!")),assertSlow&&(()=>{const l=w.NOTHING.copy();_.each(this._children,b=>{(!this._excludeInvisibleChildrenFromBounds||b.isVisible())&&l.includeBounds(b.boundsProperty._value)});let c=this.selfBoundsProperty._value.union(l);const u=this.clipArea;u&&(c=c.intersection(u.bounds));const m=this.localToParentBounds(c);assertSlow&&assertSlow(this.childBoundsProperty._value.equalsEpsilon(l,1e-6),`Child bounds mismatch after validateBounds: ${this.childBoundsProperty._value.toString()}, expected: ${l.toString()}`),assertSlow&&assertSlow(this._localBoundsOverridden||this._transformBounds||this.boundsProperty._value.equalsEpsilon(m,1e-6),`Bounds mismatch after validateBounds: ${this.boundsProperty._value.toString()}, expected: ${m.toString()}. This could have happened if a bounds instance owned by a Node was directly mutated (e.g. bounds.erode())`)})(),sceneryLog&&sceneryLog.bounds&&sceneryLog.pop(),s}_includeTransformedSubtreeBounds(e,t){this.selfBounds.isEmpty()||t.includeBounds(this.getTransformedSelfBounds(e));const s=this._children.length;for(let i=0;i<s;i++){const n=this._children[i];e.multiplyMatrix(n._transform.getMatrix()),n._includeTransformedSubtreeBounds(e,t),e.multiplyMatrix(n._transform.getInverse())}return t}validateWatchedBounds(){for(;this.watchedBoundsScan(););}watchedBoundsScan(){if(this._boundsEventSelfCount!==0)return this.validateBounds();if(this._boundsEventCount>0&&this._childBoundsDirty){let e=!1;const t=this._children.length;for(let s=0;s<t;s++)e=this._children[s].watchedBoundsScan()||e;return e}else return!1}invalidateBounds(){this._boundsDirty=!0,this._localBoundsDirty=!0;let e=this._parents.length;for(;e--;)this._parents[e].invalidateChildBounds()}invalidateChildBounds(){if(!this._childBoundsDirty){this._childBoundsDirty=!0,this._localBoundsDirty=!0;let e=this._parents.length;for(;e--;)this._parents[e].invalidateChildBounds()}}invalidateSelf(e){assert&&assert(e===void 0||e instanceof w,"invalidateSelf's newSelfBounds, if provided, needs to be Bounds2");const t=this.selfBoundsProperty._value;if(!e)this._selfBoundsDirty=!0,this.invalidateBounds(),this._picker.onSelfBoundsDirty();else if(assert&&assert(e.isEmpty()||e.isFinite(),"Bounds must be empty or finite in invalidateSelf"),this._selfBoundsDirty=!1,!t.equals(e)){const s=Yi.set(t);this.invalidateBounds(),this._picker.onSelfBoundsDirty(),t.set(e),this.selfBoundsProperty.notifyListeners(s)}assertSlow&&this._picker.audit()}updateSelfBounds(){return assert&&assert(this.selfBoundsProperty._value.equals(w.NOTHING)),!1}hasChild(e){assert&&assert(e&&e instanceof We,"hasChild needs to be called with a Node");const t=_.includes(this._children,e);return assert&&assert(t===_.includes(e._parents,this),"child-parent reference should match parent-child reference"),t}getSelfShape(){return this.selfBounds.isEmpty()?new H:H.bounds(this.selfBounds)}getSelfBounds(){return this.selfBoundsProperty.value}get selfBounds(){return this.getSelfBounds()}getSafeSelfBounds(){return this.selfBoundsProperty.value}get safeSelfBounds(){return this.getSafeSelfBounds()}getChildBounds(){return this.childBoundsProperty.value}get childBounds(){return this.getChildBounds()}getLocalBounds(){return this.localBoundsProperty.value}get localBounds(){return this.getLocalBounds()}set localBounds(e){this.setLocalBounds(e)}get localBoundsOverridden(){return this._localBoundsOverridden}setLocalBounds(e){assert&&assert(e===null||e instanceof w,"localBounds override should be set to either null or a Bounds2"),assert&&assert(e===null||!isNaN(e.minX),"minX for localBounds should not be NaN"),assert&&assert(e===null||!isNaN(e.minY),"minY for localBounds should not be NaN"),assert&&assert(e===null||!isNaN(e.maxX),"maxX for localBounds should not be NaN"),assert&&assert(e===null||!isNaN(e.maxY),"maxY for localBounds should not be NaN");const t=this.localBoundsProperty._value,s=t.copy();if(e===null)this._localBoundsOverridden&&(this._localBoundsOverridden=!1,this.localBoundsProperty.notifyListeners(s),this.invalidateBounds());else{const i=!e.equals(t)||!this._localBoundsOverridden;i&&t.set(e),this._localBoundsOverridden||(this._localBoundsOverridden=!0),i&&(this.localBoundsProperty.notifyListeners(s),this.invalidateBounds())}return this}getTransformedSelfBounds(e){return this.selfBounds.transformed(e)}getTransformedSafeSelfBounds(e){return this.safeSelfBounds.transformed(e)}getSafeTransformedVisibleBounds(e){const t=(e||C.IDENTITY).timesMatrix(this.matrix),s=w.NOTHING.copy();if(this.visibleProperty.value&&(this.selfBounds.isEmpty()||s.includeBounds(this.getTransformedSafeSelfBounds(t)),this._children.length))for(let i=0;i<this._children.length;i++)s.includeBounds(this._children[i].getSafeTransformedVisibleBounds(t));return s}get safeTransformedVisibleBounds(){return this.getSafeTransformedVisibleBounds()}setTransformBounds(e){return this._transformBounds!==e&&(this._transformBounds=e,this.invalidateBounds()),this}set transformBounds(e){this.setTransformBounds(e)}get transformBounds(){return this.getTransformBounds()}getTransformBounds(){return this._transformBounds}getBounds(){return this.boundsProperty.value}get bounds(){return this.getBounds()}getVisibleLocalBounds(){const e=this.selfBounds.copy();let t=this._children.length;for(;t--;)e.includeBounds(this._children[t].getVisibleBounds());const s=this.clipArea;return s&&e.constrainBounds(s.bounds),assert&&assert(e.isFinite()||e.isEmpty(),"Visible bounds should not be infinite"),e}get visibleLocalBounds(){return this.getVisibleLocalBounds()}getVisibleBounds(){return this.isVisible()?this.getVisibleLocalBounds().transform(this.getMatrix()):w.NOTHING}get visibleBounds(){return this.getVisibleBounds()}hitTest(e,t,s){return assert&&assert(e.isFinite(),"The point should be a finite Vector2"),assert&&assert(t===void 0||typeof t=="boolean","If isMouse is provided, it should be a boolean"),assert&&assert(s===void 0||typeof s=="boolean","If isTouch is provided, it should be a boolean"),this._picker.hitTest(e,!!t,!!s)}trailUnderPointer(e){return e.point===null?null:this.hitTest(e.point,e instanceof lt,e.isTouchLike())}containsPoint(e){return this.hitTest(e)!==null}containsPointSelf(e){return this.selfBounds.containsPoint(e)}intersectsBoundsSelf(e){return this.selfBounds.intersectsBounds(e)}isPhetioMouseHittable(e){return this.pickable===!1&&!this.isAnyDescendantAPhetioMouseHitTarget()?!1:this.visible&&(this.clipArea===null||this.clipArea.containsPoint(this._transform.getInverse().timesVector2(e)))}isAnyDescendantAPhetioMouseHitTarget(){return this.getPhetioMouseHitTarget()!=="phetioNotSelectable"||_.some(this.children,e=>e.isAnyDescendantAPhetioMouseHitTarget())}getPhetioMouseHit(e){if(!this.isPhetioMouseHittable(e))return null;const t=this._transform.getInverse().timesVector2(e);let s=null;for(let i=this._children.length-1;i>=0;i--){const n=this._children[i].getPhetioMouseHit(t);if(n instanceof _e)return n;n==="phetioNotSelectable"&&(s=!0)}return s?this.getPhetioMouseHitTarget():this._mouseArea?this._mouseArea.containsPoint(t)?this.getPhetioMouseHitTarget():null:this.selfBounds.containsPoint(t)&&this.containsPointSelf(t)?this.getPhetioMouseHitTarget():null}isPainted(){return!1}areSelfBoundsValid(){return!0}hasParent(){return this._parents.length!==0}hasChildren(){return this._children.length>0}isChildIncludedInLayout(e){return e.bounds.isValid()&&(!this._excludeInvisibleChildrenFromBounds||e.visible)}walkDepthFirst(e){e(this);const t=this._children.length;for(let s=0;s<t;s++)this._children[s].walkDepthFirst(e)}addInputListener(e){return assert&&assert(!_.includes(this._inputListeners,e),"Input listener already registered on this Node"),assert&&assert(e!==null,"Input listener cannot be null"),assert&&assert(e!==void 0,"Input listener cannot be undefined"),_.includes(this._inputListeners,e)||(this._inputListeners.push(e),this._picker.onAddInputListener(),assertSlow&&this._picker.audit()),this}removeInputListener(e){const t=_.indexOf(this._inputListeners,e);return assert&&assert(this.isDisposed||t>=0,"Could not find input listener to remove"),t>=0&&(this._inputListeners.splice(t,1),this._picker.onRemoveInputListener(),assertSlow&&this._picker.audit()),this}hasInputListener(e){for(let t=0;t<this._inputListeners.length;t++)if(this._inputListeners[t]===e)return!0;return!1}interruptInput(){const e=this.inputListeners;for(let t=0;t<e.length;t++){const s=e[t];s.interrupt&&s.interrupt()}return this}interruptSubtreeInput(){this.interruptInput();const e=this._children.slice();for(let t=0;t<e.length;t++)e[t].interruptSubtreeInput();return this}translate(e,t,s){if(typeof e=="number"){if(assert&&assert(isFinite(e),"x should be a finite number"),assert&&assert(typeof t=="number"&&isFinite(t),"y should be a finite number"),Math.abs(e)<1e-12&&Math.abs(t)<1e-12)return;s?this.prependTranslation(e,t):this.appendMatrix(va.setToTranslation(e,t))}else{const i=e;if(assert&&assert(i.isFinite(),"translation should be a finite Vector2 if not finite numbers"),!i.x&&!i.y)return;this.translate(i.x,i.y,t)}}scale(e,t,s){if(typeof e=="number")if(assert&&assert(isFinite(e),"scales should be finite"),t===void 0||typeof t=="boolean")this.scale(e,e,t);else{if(assert&&assert(isFinite(t),"scales should be finite numbers"),assert&&assert(s===void 0||typeof s=="boolean","If provided, prependInstead should be boolean"),e===1&&t===1)return;s?this.prependMatrix(C.scaling(e,t)):this.appendMatrix(C.scaling(e,t))}else{const i=e;assert&&assert(i.isFinite(),"scale should be a finite Vector2 if not a finite number"),this.scale(i.x,i.y,t)}}rotate(e,t){assert&&assert(isFinite(e),"angle should be a finite number"),assert&&assert(t===void 0||typeof t=="boolean"),e%(2*Math.PI)!==0&&(t?this.prependMatrix(C.rotation2(e)):this.appendMatrix(C.rotation2(e)))}rotateAround(e,t){assert&&assert(e.isFinite(),"point should be a finite Vector2"),assert&&assert(isFinite(t),"angle should be a finite number");let s=C.translation(-e.x,-e.y);return s=C.rotation2(t).timesMatrix(s),s=C.translation(e.x,e.y).timesMatrix(s),this.prependMatrix(s),this}setX(e){return assert&&assert(isFinite(e),"x should be a finite number"),this.translate(e-this.getX(),0,!0),this}set x(e){this.setX(e)}get x(){return this.getX()}getX(){return this._transform.getMatrix().m02()}setY(e){return assert&&assert(isFinite(e),"y should be a finite number"),this.translate(0,e-this.getY(),!0),this}set y(e){this.setY(e)}get y(){return this.getY()}getY(){return this._transform.getMatrix().m12()}setScaleMagnitude(e,t){const s=this.getScaleVector();return typeof e=="number"?(t===void 0&&(t=e),assert&&assert(isFinite(e),"setScaleMagnitude parameters should be finite numbers"),assert&&assert(isFinite(t),"setScaleMagnitude parameters should be finite numbers"),this.appendMatrix(C.scaling(e/s.x,t/s.y))):(assert&&assert(e.isFinite(),"first parameter should be a finite Vector2"),this.appendMatrix(C.scaling(e.x/s.x,e.y/s.y))),this}getScaleVector(){return this._transform.getMatrix().getScaleVector()}setRotation(e){return assert&&assert(isFinite(e),"rotation should be a finite number"),this.appendMatrix(va.setToRotationZ(e-this.getRotation())),this}set rotation(e){this.setRotation(e)}get rotation(){return this.getRotation()}getRotation(){return this._transform.getMatrix().getRotation()}setTranslation(e,t){const s=this._transform.getMatrix(),i=s.m02(),n=s.m12();let a,o;return typeof e=="number"?(assert&&assert(isFinite(e),"Parameters to setTranslation should be finite numbers"),assert&&assert(t!==void 0&&isFinite(t),"Parameters to setTranslation should be finite numbers"),a=e-i,o=t-n):(assert&&assert(e.isFinite(),"Should be a finite Vector2"),a=e.x-i,o=e.y-n),this.translate(a,o,!0),this}set translation(e){this.setTranslation(e)}get translation(){return this.getTranslation()}getTranslation(){const e=this._transform.getMatrix();return new T(e.m02(),e.m12())}appendMatrix(e){assert&&assert(e.isFinite(),"matrix should be a finite Matrix3"),assert&&assert(e.getDeterminant()!==0,"matrix should not map plane to a line or point"),this._transform.append(e)}prependMatrix(e){assert&&assert(e.isFinite(),"matrix should be a finite Matrix3"),assert&&assert(e.getDeterminant()!==0,"matrix should not map plane to a line or point"),this._transform.prepend(e)}prependTranslation(e,t){assert&&assert(isFinite(e),"x should be a finite number"),assert&&assert(isFinite(t),"y should be a finite number"),!(!e&&!t)&&this._transform.prependTranslation(e,t)}setMatrix(e){assert&&assert(e.isFinite(),"matrix should be a finite Matrix3"),assert&&assert(e.getDeterminant()!==0,"matrix should not map plane to a line or point"),this._transform.setMatrix(e)}set matrix(e){this.setMatrix(e)}get matrix(){return this.getMatrix()}getMatrix(){return this._transform.getMatrix()}getTransform(){return this._transform}get transform(){return this.getTransform()}resetTransform(){this.setMatrix(C.IDENTITY)}onTransformChange(){this.invalidateBounds(),this._picker.onTransformChange(),assertSlow&&this._picker.audit(),this.transformEmitter.emit()}onSummaryChange(e,t){this._pdomDisplaysInfo.onSummaryChange(e,t)}updateMaxDimension(e){assert&&this.auditMaxDimensions();const t=this._appliedScaleFactor;let s=1;if(this._maxWidth!==null){const n=e.width;n>this._maxWidth&&(s=Math.min(s,this._maxWidth/n))}if(this._maxHeight!==null){const n=e.height;n>this._maxHeight&&(s=Math.min(s,this._maxHeight/n))}const i=s/t;i!==1&&(this._appliedScaleFactor=s,this.scale(i))}auditMaxDimensions(){assert&&assert(this._maxWidth===null||!Si(this)||this.preferredWidth===null||this._maxWidth>=this.preferredWidth-1e-7,"If maxWidth and preferredWidth are both non-null, maxWidth should NOT be smaller than the preferredWidth. If that happens, it would trigger an infinite loop"),assert&&assert(this._maxHeight===null||!wi(this)||this.preferredHeight===null||this._maxHeight>=this.preferredHeight-1e-7,"If maxHeight and preferredHeight are both non-null, maxHeight should NOT be smaller than the preferredHeight. If that happens, it would trigger an infinite loop")}onMaxDimensionChange(e,t){e===null&&t!==null?(this.changeBoundsEventCount(1),this._boundsEventSelfCount++):e!==null&&t===null&&(this.changeBoundsEventCount(-1),this._boundsEventSelfCount--)}setMaxWidth(e){assert&&assert(e===null||typeof e=="number"&&e>0,"maxWidth should be null (no constraint) or a positive number"),this._maxWidth!==e&&(this.onMaxDimensionChange(this._maxWidth,e),this._maxWidth=e,this.updateMaxDimension(this.localBoundsProperty.value))}set maxWidth(e){this.setMaxWidth(e)}get maxWidth(){return this.getMaxWidth()}getMaxWidth(){return this._maxWidth}setMaxHeight(e){assert&&assert(e===null||typeof e=="number"&&e>0,"maxHeight should be null (no constraint) or a positive number"),this._maxHeight!==e&&(this.onMaxDimensionChange(this._maxHeight,e),this._maxHeight=e,this.updateMaxDimension(this.localBoundsProperty.value))}set maxHeight(e){this.setMaxHeight(e)}get maxHeight(){return this.getMaxHeight()}getMaxHeight(){return this._maxHeight}setLeft(e){const t=this.getLeft();return isFinite(t)&&this.translate(e-t,0,!0),this}set left(e){this.setLeft(e)}get left(){return this.getLeft()}getLeft(){return this.getBounds().minX}setRight(e){const t=this.getRight();return isFinite(t)&&this.translate(e-t,0,!0),this}set right(e){this.setRight(e)}get right(){return this.getRight()}getRight(){return this.getBounds().maxX}setCenterX(e){const t=this.getCenterX();return isFinite(t)&&this.translate(e-t,0,!0),this}set centerX(e){this.setCenterX(e)}get centerX(){return this.getCenterX()}getCenterX(){return this.getBounds().getCenterX()}setCenterY(e){const t=this.getCenterY();return isFinite(t)&&this.translate(0,e-t,!0),this}set centerY(e){this.setCenterY(e)}get centerY(){return this.getCenterY()}getCenterY(){return this.getBounds().getCenterY()}setTop(e){const t=this.getTop();return isFinite(t)&&this.translate(0,e-t,!0),this}set top(e){this.setTop(e)}get top(){return this.getTop()}getTop(){return this.getBounds().minY}setBottom(e){const t=this.getBottom();return isFinite(t)&&this.translate(0,e-t,!0),this}set bottom(e){this.setBottom(e)}get bottom(){return this.getBottom()}getBottom(){return this.getBounds().maxY}setLeftTop(e){assert&&assert(e.isFinite(),"leftTop should be a finite Vector2");const t=this.getLeftTop();return t.isFinite()&&this.translate(e.minus(t),!0),this}set leftTop(e){this.setLeftTop(e)}get leftTop(){return this.getLeftTop()}getLeftTop(){return this.getBounds().getLeftTop()}setCenterTop(e){assert&&assert(e.isFinite(),"centerTop should be a finite Vector2");const t=this.getCenterTop();return t.isFinite()&&this.translate(e.minus(t),!0),this}set centerTop(e){this.setCenterTop(e)}get centerTop(){return this.getCenterTop()}getCenterTop(){return this.getBounds().getCenterTop()}setRightTop(e){assert&&assert(e.isFinite(),"rightTop should be a finite Vector2");const t=this.getRightTop();return t.isFinite()&&this.translate(e.minus(t),!0),this}set rightTop(e){this.setRightTop(e)}get rightTop(){return this.getRightTop()}getRightTop(){return this.getBounds().getRightTop()}setLeftCenter(e){assert&&assert(e.isFinite(),"leftCenter should be a finite Vector2");const t=this.getLeftCenter();return t.isFinite()&&this.translate(e.minus(t),!0),this}set leftCenter(e){this.setLeftCenter(e)}get leftCenter(){return this.getLeftCenter()}getLeftCenter(){return this.getBounds().getLeftCenter()}setCenter(e){assert&&assert(e.isFinite(),"center should be a finite Vector2");const t=this.getCenter();return t.isFinite()&&this.translate(e.minus(t),!0),this}set center(e){this.setCenter(e)}get center(){return this.getCenter()}getCenter(){return this.getBounds().getCenter()}setRightCenter(e){assert&&assert(e.isFinite(),"rightCenter should be a finite Vector2");const t=this.getRightCenter();return t.isFinite()&&this.translate(e.minus(t),!0),this}set rightCenter(e){this.setRightCenter(e)}get rightCenter(){return this.getRightCenter()}getRightCenter(){return this.getBounds().getRightCenter()}setLeftBottom(e){assert&&assert(e.isFinite(),"leftBottom should be a finite Vector2");const t=this.getLeftBottom();return t.isFinite()&&this.translate(e.minus(t),!0),this}set leftBottom(e){this.setLeftBottom(e)}get leftBottom(){return this.getLeftBottom()}getLeftBottom(){return this.getBounds().getLeftBottom()}setCenterBottom(e){assert&&assert(e.isFinite(),"centerBottom should be a finite Vector2");const t=this.getCenterBottom();return t.isFinite()&&this.translate(e.minus(t),!0),this}set centerBottom(e){this.setCenterBottom(e)}get centerBottom(){return this.getCenterBottom()}getCenterBottom(){return this.getBounds().getCenterBottom()}setRightBottom(e){assert&&assert(e.isFinite(),"rightBottom should be a finite Vector2");const t=this.getRightBottom();return t.isFinite()&&this.translate(e.minus(t),!0),this}set rightBottom(e){this.setRightBottom(e)}get rightBottom(){return this.getRightBottom()}getRightBottom(){return this.getBounds().getRightBottom()}getWidth(){return this.getBounds().getWidth()}get width(){return this.getWidth()}getHeight(){return this.getBounds().getHeight()}get height(){return this.getHeight()}getLocalWidth(){return this.getLocalBounds().getWidth()}get localWidth(){return this.getLocalWidth()}getLocalHeight(){return this.getLocalBounds().getHeight()}get localHeight(){return this.getLocalHeight()}getLocalLeft(){return this.getLocalBounds().minX}get localLeft(){return this.getLocalLeft()}getLocalRight(){return this.getLocalBounds().maxX}get localRight(){return this.getLocalRight()}getLocalCenterX(){return this.getLocalBounds().getCenterX()}get localCenterX(){return this.getLocalCenterX()}getLocalCenterY(){return this.getLocalBounds().getCenterY()}get localCenterY(){return this.getLocalCenterY()}getLocalTop(){return this.getLocalBounds().minY}get localTop(){return this.getLocalTop()}getLocalBottom(){return this.getLocalBounds().maxY}get localBottom(){return this.getLocalBottom()}getLocalLeftTop(){return this.getLocalBounds().getLeftTop()}get localLeftTop(){return this.getLocalLeftTop()}getLocalCenterTop(){return this.getLocalBounds().getCenterTop()}get localCenterTop(){return this.getLocalCenterTop()}getLocalRightTop(){return this.getLocalBounds().getRightTop()}get localRightTop(){return this.getLocalRightTop()}getLocalLeftCenter(){return this.getLocalBounds().getLeftCenter()}get localLeftCenter(){return this.getLocalLeftCenter()}getLocalCenter(){return this.getLocalBounds().getCenter()}get localCenter(){return this.getLocalCenter()}getLocalRightCenter(){return this.getLocalBounds().getRightCenter()}get localRightCenter(){return this.getLocalRightCenter()}getLocalLeftBottom(){return this.getLocalBounds().getLeftBottom()}get localLeftBottom(){return this.getLocalLeftBottom()}getLocalCenterBottom(){return this.getLocalBounds().getCenterBottom()}get localCenterBottom(){return this.getLocalCenterBottom()}getLocalRightBottom(){return this.getLocalBounds().getRightBottom()}get localRightBottom(){return this.getLocalRightBottom()}getId(){return this._id}get id(){return this.getId()}onVisiblePropertyChange(e){this._picker.onVisibilityChange(),assertSlow&&this._picker.audit(),this._pdomDisplaysInfo.onVisibilityChange(e);for(let t=0;t<this._parents.length;t++){const s=this._parents[t];s._excludeInvisibleChildrenFromBounds&&s.invalidateChildBounds()}}setVisibleProperty(e){return this._visibleProperty.setTargetProperty(e,this,_a)}set visibleProperty(e){this.setVisibleProperty(e)}get visibleProperty(){return this.getVisibleProperty()}getVisibleProperty(){return this._visibleProperty}setVisible(e){return this.visibleProperty.set(e),this}set visible(e){this.setVisible(e)}get visible(){return this.isVisible()}isVisible(){return this.visibleProperty.value}setPhetioVisiblePropertyInstrumented(e){return this._visibleProperty.setTargetPropertyInstrumented(e,this)}set phetioVisiblePropertyInstrumented(e){this.setPhetioVisiblePropertyInstrumented(e)}get phetioVisiblePropertyInstrumented(){return this.getPhetioVisiblePropertyInstrumented()}getPhetioVisiblePropertyInstrumented(){return this._visibleProperty.getTargetPropertyInstrumented()}swapVisibility(e){assert&&assert(this.visible!==e.visible);const t=this.visible?this:e,s=this.visible?e:this,i=t.focused;return t.visible=!1,s.visible=!0,i&&s.focusable&&s.focus(),this}setOpacity(e){if(assert&&assert(isFinite(e),"opacity should be a finite number"),e<0||e>1)throw new Error(`opacity out of range: ${e}`);this.opacityProperty.value=e}set opacity(e){this.setOpacity(e)}get opacity(){return this.getOpacity()}getOpacity(){return this.opacityProperty.value}setDisabledOpacity(e){if(assert&&assert(isFinite(e),"disabledOpacity should be a finite number"),e<0||e>1)throw new Error(`disabledOpacity out of range: ${e}`);return this.disabledOpacityProperty.value=e,this}set disabledOpacity(e){this.setDisabledOpacity(e)}get disabledOpacity(){return this.getDisabledOpacity()}getDisabledOpacity(){return this.disabledOpacityProperty.value}getEffectiveOpacity(){return this.opacityProperty.value*(this.enabledProperty.value?1:this.disabledOpacityProperty.value)}get effectiveOpacity(){return this.getEffectiveOpacity()}onOpacityPropertyChange(){this.filterChangeEmitter.emit()}onDisabledOpacityPropertyChange(){this._enabledProperty.value||this.filterChangeEmitter.emit()}setFilters(e){assert&&assert(Array.isArray(e),"filters should be an array"),assert&&assert(_.every(e,t=>t instanceof Rs),"filters should consist of Filter objects only"),this._filters.length=0,this._filters.push(...e),this.invalidateHint(),this.filterChangeEmitter.emit()}set filters(e){this.setFilters(e)}get filters(){return this.getFilters()}getFilters(){return this._filters.slice()}setPickableProperty(e){return this._pickableProperty.setTargetProperty(e,this,null)}set pickableProperty(e){this.setPickableProperty(e)}get pickableProperty(){return this.getPickableProperty()}getPickableProperty(){return this._pickableProperty}setPickable(e){return assert&&assert(e===null||typeof e=="boolean"),this._pickableProperty.set(e),this}set pickable(e){this.setPickable(e)}get pickable(){return this.isPickable()}isPickable(){return this._pickableProperty.value}onPickablePropertyChange(e,t){this._picker.onPickableChange(t,e),assertSlow&&this._picker.audit()}setEnabledProperty(e){return this._enabledProperty.setTargetProperty(e,this,Pa)}set enabledProperty(e){this.setEnabledProperty(e)}get enabledProperty(){return this.getEnabledProperty()}getEnabledProperty(){return this._enabledProperty}setPhetioEnabledPropertyInstrumented(e){return this._enabledProperty.setTargetPropertyInstrumented(e,this)}set phetioEnabledPropertyInstrumented(e){this.setPhetioEnabledPropertyInstrumented(e)}get phetioEnabledPropertyInstrumented(){return this.getPhetioEnabledPropertyInstrumented()}getPhetioEnabledPropertyInstrumented(){return this._enabledProperty.getTargetPropertyInstrumented()}setEnabled(e){return assert&&assert(e===null||typeof e=="boolean"),this._enabledProperty.set(e),this}set enabled(e){this.setEnabled(e)}get enabled(){return this.isEnabled()}isEnabled(){return this._enabledProperty.value}onEnabledPropertyChange(e){!e&&this.interruptSubtreeInput(),this.inputEnabled=e,this.disabledOpacityProperty.value!==1&&this.filterChangeEmitter.emit()}setInputEnabledProperty(e){return this._inputEnabledProperty.setTargetProperty(e,this,Sa)}set inputEnabledProperty(e){this.setInputEnabledProperty(e)}get inputEnabledProperty(){return this.getInputEnabledProperty()}getInputEnabledProperty(){return this._inputEnabledProperty}setPhetioInputEnabledPropertyInstrumented(e){return this._inputEnabledProperty.setTargetPropertyInstrumented(e,this)}set phetioInputEnabledPropertyInstrumented(e){this.setPhetioInputEnabledPropertyInstrumented(e)}get phetioInputEnabledPropertyInstrumented(){return this.getPhetioInputEnabledPropertyInstrumented()}getPhetioInputEnabledPropertyInstrumented(){return this._inputEnabledProperty.getTargetPropertyInstrumented()}setInputEnabled(e){this.inputEnabledProperty.value=e}set inputEnabled(e){this.setInputEnabled(e)}get inputEnabled(){return this.isInputEnabled()}isInputEnabled(){return this.inputEnabledProperty.value}setInputListeners(e){for(assert&&assert(Array.isArray(e));this._inputListeners.length;)this.removeInputListener(this._inputListeners[0]);for(let t=0;t<e.length;t++)this.addInputListener(e[t]);return this}set inputListeners(e){this.setInputListeners(e)}get inputListeners(){return this.getInputListeners()}getInputListeners(){return this._inputListeners.slice(0)}setCursor(e){this._cursor=e==="auto"?null:e}set cursor(e){this.setCursor(e)}get cursor(){return this.getCursor()}getCursor(){return this._cursor}getEffectiveCursor(){if(this._cursor)return this._cursor;for(let e=0;e<this._inputListeners.length;e++){const t=this._inputListeners[e];if(t.cursor)return t.cursor}return null}setMouseArea(e){return assert&&assert(e===null||e instanceof H||e instanceof w,"mouseArea needs to be a phet.kite.Shape, phet.dot.Bounds2, or null"),this._mouseArea!==e&&(this._mouseArea=e,this._picker.onMouseAreaChange(),assertSlow&&this._picker.audit()),this}set mouseArea(e){this.setMouseArea(e)}get mouseArea(){return this.getMouseArea()}getMouseArea(){return this._mouseArea}setTouchArea(e){return assert&&assert(e===null||e instanceof H||e instanceof w,"touchArea needs to be a phet.kite.Shape, phet.dot.Bounds2, or null"),this._touchArea!==e&&(this._touchArea=e,this._picker.onTouchAreaChange(),assertSlow&&this._picker.audit()),this}set touchArea(e){this.setTouchArea(e)}get touchArea(){return this.getTouchArea()}getTouchArea(){return this._touchArea}setClipArea(e){assert&&assert(e===null||e instanceof H,"clipArea needs to be a phet.kite.Shape, or null"),this.clipArea!==e&&(this.clipAreaProperty.value=e,this.invalidateBounds(),this._picker.onClipAreaChange(),assertSlow&&this._picker.audit())}set clipArea(e){this.setClipArea(e)}get clipArea(){return this.getClipArea()}getClipArea(){return this.clipAreaProperty.value}hasClipArea(){return this.clipArea!==null}setRendererBitmask(e){assert&&assert(isFinite(e)),e!==this._rendererBitmask&&(this._rendererBitmask=e,this._rendererSummary.selfChange(),this.instanceRefreshEmitter.emit())}invalidateSupportedRenderers(){}invalidateHint(){this.rendererSummaryRefreshEmitter.emit(),this.instanceRefreshEmitter.emit()}setRenderer(e){assert&&assert(e===null||e==="canvas"||e==="svg"||e==="dom"||e==="webgl",'Renderer input should be null, or one of: "canvas", "svg", "dom" or "webgl".');let t=0;e==="canvas"?t=p.bitmaskCanvas:e==="svg"?t=p.bitmaskSVG:e==="dom"?t=p.bitmaskDOM:e==="webgl"&&(t=p.bitmaskWebGL),assert&&assert(e===null==(t===0),"We should only end up with no actual renderer if renderer is null"),this._renderer!==t&&(this._renderer=t,this.invalidateHint())}set renderer(e){this.setRenderer(e)}get renderer(){return this.getRenderer()}getRenderer(){return this._renderer===0?null:this._renderer===p.bitmaskCanvas?"canvas":this._renderer===p.bitmaskSVG?"svg":this._renderer===p.bitmaskDOM?"dom":this._renderer===p.bitmaskWebGL?"webgl":(assert&&assert(!1,"Seems to be an invalid renderer?"),null)}setLayerSplit(e){e!==this._layerSplit&&(this._layerSplit=e,this.invalidateHint())}set layerSplit(e){this.setLayerSplit(e)}get layerSplit(){return this.isLayerSplit()}isLayerSplit(){return this._layerSplit}setUsesOpacity(e){e!==this._usesOpacity&&(this._usesOpacity=e,this.invalidateHint())}set usesOpacity(e){this.setUsesOpacity(e)}get usesOpacity(){return this.getUsesOpacity()}getUsesOpacity(){return this._usesOpacity}setCSSTransform(e){e!==this._cssTransform&&(this._cssTransform=e,this.invalidateHint())}set cssTransform(e){this.setCSSTransform(e)}get cssTransform(){return this.isCSSTransformed()}isCSSTransformed(){return this._cssTransform}setExcludeInvisible(e){e!==this._excludeInvisible&&(this._excludeInvisible=e,this.invalidateHint())}set excludeInvisible(e){this.setExcludeInvisible(e)}get excludeInvisible(){return this.isExcludeInvisible()}isExcludeInvisible(){return this._excludeInvisible}setExcludeInvisibleChildrenFromBounds(e){e!==this._excludeInvisibleChildrenFromBounds&&(this._excludeInvisibleChildrenFromBounds=e,this.invalidateBounds())}set excludeInvisibleChildrenFromBounds(e){this.setExcludeInvisibleChildrenFromBounds(e)}get excludeInvisibleChildrenFromBounds(){return this.isExcludeInvisibleChildrenFromBounds()}isExcludeInvisibleChildrenFromBounds(){return this._excludeInvisibleChildrenFromBounds}setLayoutOptions(e){assert&&assert(e===null||typeof e=="object"&&Object.getPrototypeOf(e)===Object.prototype,"layoutOptions should be null or an plain options-style object"),e!==this._layoutOptions&&(this._layoutOptions=e,this.layoutOptionsChangedEmitter.emit())}set layoutOptions(e){this.setLayoutOptions(e)}get layoutOptions(){return this.getLayoutOptions()}getLayoutOptions(){return this._layoutOptions}mutateLayoutOptions(e){this.layoutOptions=ls()({},this.layoutOptions||{},e)}get widthSizable(){return!1}get heightSizable(){return!1}get extendsWidthSizable(){return!1}get extendsHeightSizable(){return!1}get extendsSizable(){return!1}setPreventFit(e){e!==this._preventFit&&(this._preventFit=e,this.invalidateHint())}set preventFit(e){this.setPreventFit(e)}get preventFit(){return this.isPreventFit()}isPreventFit(){return this._preventFit}setWebGLScale(e){assert&&assert(e===null||typeof e=="number"&&isFinite(e)),e!==this._webglScale&&(this._webglScale=e,this.invalidateHint())}set webglScale(e){this.setWebGLScale(e)}get webglScale(){return this.getWebGLScale()}getWebGLScale(){return this._webglScale}getUniqueTrail(e){if(e){const t=this.getTrails(e);return assert&&assert(t.length===1,`getUniqueTrail found ${t.length} matching trails for the predicate`),t[0]}else{const t=new R;let s=this;for(;s;)assert&&assert(s._parents.length<=1,`getUniqueTrail found a Node with ${s._parents.length} parents.`),t.addAncestor(s),s=s._parents[0];return t}}getUniqueTrailTo(e){return this.getUniqueTrail(t=>e===t)}getTrails(e){e=e||We.defaultTrailPredicate;const t=[],s=new R(this);return R.appendAncestorTrailsWithPredicate(t,s,e),t}getTrailsTo(e){return this.getTrails(t=>t===e)}getLeafTrails(e){e=e||We.defaultLeafTrailPredicate;const t=[],s=new R(this);return R.appendDescendantTrailsWithPredicate(t,s,e),t}getLeafTrailsTo(e){return this.getLeafTrails(t=>t===e)}getUniqueLeafTrail(e){const t=this.getLeafTrails(e);return assert&&assert(t.length===1,`getUniqueLeafTrail found ${t.length} matching trails for the predicate`),t[0]}getUniqueLeafTrailTo(e){return this.getUniqueLeafTrail(t=>t===e)}getConnectedNodes(){const e=[];let t=this._children.concat(this._parents).concat(this);for(;t.length;){const s=t.pop();_.includes(e,s)||(e.push(s),t=t.concat(s._children,s._parents))}return e}getSubtreeNodes(){const e=[];let t=this._children.concat(this);for(;t.length;){const s=t.pop();_.includes(e,s)||(e.push(s),t=t.concat(s._children))}return e}getTopologicallySortedNodes(){const e={},t=[],s=[];let i;_.each(this.getConnectedNodes(),a=>{e[a.id]={},_.each(a._children,o=>{e[a.id][o.id]=!0}),a.parents.length||t.push(a)});function n(a){delete e[i.id][a.id],_.every(e,o=>!o[a.id])&&t.push(a)}for(;t.length;)i=t.pop(),s.push(i),_.each(i._children,n);return assert&&assert(_.every(e,a=>_.every(a,o=>!1)),"circular reference check"),s}canAddChild(e){if(this===e||_.includes(this._children,e))return!1;const t={},s=[];let i;_.each(this.getConnectedNodes().concat(e.getConnectedNodes()),a=>{t[a.id]={},_.each(a._children,o=>{t[a.id][o.id]=!0}),!a.parents.length&&a!==e&&s.push(a)}),t[this.id][e.id]=!0;function n(a){delete t[i.id][a.id],_.every(t,o=>!o[a.id])&&s.push(a)}for(;s.length;)i=s.pop(),_.each(i._children,n),i===this&&n(e);return _.every(t,a=>_.every(a,o=>!1))}canvasPaintSelf(e,t){}renderToCanvasSelf(e,t){this.isPainted()&&this._rendererBitmask&p.bitmaskCanvas&&this.canvasPaintSelf(e,t)}renderToCanvasSubtree(e,t){t=t||C.identity(),e.resetStyles(),this.renderToCanvasSelf(e,t);for(let s=0;s<this._children.length;s++){const i=this._children[s];if(i.isVisible()&&i.bounds.isValid()){const n=i.effectiveOpacity!==1||i.clipArea||i._filters.length;if(e.context.save(),t.multiplyMatrix(i._transform.getMatrix()),t.canvasSetTransform(e.context),n){const a=i.localBounds.transformed(t).dilate(4).roundOut().constrainBounds(kg.setMinMax(0,0,e.canvas.width,e.canvas.height));if(a.width>0&&a.height>0){const o=document.createElement("canvas");o.width=a.width,o.height=a.height;const h=o.getContext("2d"),l=new ks(o,h),c=t.copy().prependTranslation(-a.minX,-a.minY);c.canvasSetTransform(h),i.renderToCanvasSubtree(l,c),e.context.save(),i.clipArea&&(e.context.beginPath(),i.clipArea.writeToContext(e.context),e.context.clip()),e.context.setTransform(1,0,0,1,0,0),e.context.globalAlpha=i.effectiveOpacity;let u=!1;i._filters.length&&(A.canvasFilter&&_.every(i._filters,m=>m.isDOMCompatible())?(e.context.filter=i._filters.map(m=>m.getCSSFilterString()).join(" "),u=!0):i._filters.forEach(m=>m.applyCanvasFilter(l))),e.context.drawImage(o,a.minX,a.minY),e.context.restore(),u&&(e.context.filter="none")}}else i.renderToCanvasSubtree(e,t);t.multiplyMatrix(i._transform.getInverse()),e.context.restore()}}}renderToCanvas(e,t,s,i){assert&&Ot("Node.renderToCanvas() is deprecated, please use Node.rasterized() instead"),e.width=e.width,i&&(t.fillStyle=i,t.fillRect(0,0,e.width,e.height));const n=new ks(e,t);this.renderToCanvasSubtree(n,C.identity()),s&&s()}toCanvas(e,t,s,i,n){assert&&assert(t===void 0||typeof t=="number","If provided, x should be a number"),assert&&assert(s===void 0||typeof s=="number","If provided, y should be a number"),assert&&assert(i===void 0||typeof i=="number"&&i>=0&&i%1===0,"If provided, width should be a non-negative integer"),assert&&assert(n===void 0||typeof n=="number"&&n>=0&&n%1===0,"If provided, height should be a non-negative integer");const a=2,o=this.getBounds().union(this.localToParentBounds(this.getSafeSelfBounds()));assert&&assert(!o.isEmpty()||t!==void 0&&s!==void 0&&i!==void 0&&n!==void 0,"Should not call toCanvas on a Node with empty bounds, unless all dimensions are provided"),t=t!==void 0?t:Math.ceil(a-o.minX),s=s!==void 0?s:Math.ceil(a-o.minY),i=i!==void 0?i:Math.ceil(o.getWidth()+2*a),n=n!==void 0?n:Math.ceil(o.getHeight()+2*a);const h=document.createElement("canvas");h.width=i,h.height=n;const l=h.getContext("2d");l.translate(t,s),this._transform.getMatrix().canvasAppendTransform(l);const c=new ks(h,l);this.renderToCanvasSubtree(c,C.translation(t,s).timesMatrix(this._transform.getMatrix())),e(h,t,s,i,n)}toDataURL(e,t,s,i,n){assert&&assert(t===void 0||typeof t=="number","If provided, x should be a number"),assert&&assert(s===void 0||typeof s=="number","If provided, y should be a number"),assert&&assert(i===void 0||typeof i=="number"&&i>=0&&i%1===0,"If provided, width should be a non-negative integer"),assert&&assert(n===void 0||typeof n=="number"&&n>=0&&n%1===0,"If provided, height should be a non-negative integer"),this.toCanvas((a,o,h,l,c)=>{e(a.toDataURL(),o,h,l,c)},t,s,i,n)}toImage(e,t,s,i,n){assert&&Ot("Node.toImage() is deprecated, please use Node.rasterized() instead"),assert&&assert(t===void 0||typeof t=="number","If provided, x should be a number"),assert&&assert(s===void 0||typeof s=="number","If provided, y should be a number"),assert&&assert(i===void 0||typeof i=="number"&&i>=0&&i%1===0,"If provided, width should be a non-negative integer"),assert&&assert(n===void 0||typeof n=="number"&&n>=0&&n%1===0,"If provided, height should be a non-negative integer"),this.toDataURL((a,o,h)=>{const l=document.createElement("img");l.onload=()=>{e(l,o,h);try{delete l.onload}catch{}},l.src=a},t,s,i,n)}toImageNodeAsynchronous(e,t,s,i,n){assert&&Ot("Node.toImageNodeAsyncrhonous() is deprecated, please use Node.rasterized() instead"),assert&&assert(t===void 0||typeof t=="number","If provided, x should be a number"),assert&&assert(s===void 0||typeof s=="number","If provided, y should be a number"),assert&&assert(i===void 0||typeof i=="number"&&i>=0&&i%1===0,"If provided, width should be a non-negative integer"),assert&&assert(n===void 0||typeof n=="number"&&n>=0&&n%1===0,"If provided, height should be a non-negative integer"),this.toImage((a,o,h)=>{e(new We({children:[new $e(a,{x:-o,y:-h})]}))},t,s,i,n)}toCanvasNodeSynchronous(e,t,s,i){assert&&Ot("Node.toCanvasNodeSynchronous() is deprecated, please use Node.rasterized() instead"),assert&&assert(e===void 0||typeof e=="number","If provided, x should be a number"),assert&&assert(t===void 0||typeof t=="number","If provided, y should be a number"),assert&&assert(s===void 0||typeof s=="number"&&s>=0&&s%1===0,"If provided, width should be a non-negative integer"),assert&&assert(i===void 0||typeof i=="number"&&i>=0&&i%1===0,"If provided, height should be a non-negative integer");let n=null;return this.toCanvas((a,o,h)=>{n=new We({children:[new $e(a,{x:-o,y:-h})]})},e,t,s,i),assert&&assert(n,"toCanvasNodeSynchronous requires that the node can be rendered only using Canvas"),n}toDataURLImageSynchronous(e,t,s,i){assert&&Ot("Node.toDataURLImageSychronous() is deprecated, please use Node.rasterized() instead"),assert&&assert(e===void 0||typeof e=="number","If provided, x should be a number"),assert&&assert(t===void 0||typeof t=="number","If provided, y should be a number"),assert&&assert(s===void 0||typeof s=="number"&&s>=0&&s%1===0,"If provided, width should be a non-negative integer"),assert&&assert(i===void 0||typeof i=="number"&&i>=0&&i%1===0,"If provided, height should be a non-negative integer");let n=null;return this.toDataURL((a,o,h,l,c)=>{n=new $e(a,{x:-o,y:-h,initialWidth:l,initialHeight:c})},e,t,s,i),assert&&assert(n,"toDataURL failed to return a result synchronously"),n}toDataURLNodeSynchronous(e,t,s,i){return assert&&Ot("Node.toDataURLNodeSynchronous() is deprecated, please use Node.rasterized() instead"),assert&&assert(e===void 0||typeof e=="number","If provided, x should be a number"),assert&&assert(t===void 0||typeof t=="number","If provided, y should be a number"),assert&&assert(s===void 0||typeof s=="number"&&s>=0&&s%1===0,"If provided, width should be a non-negative integer"),assert&&assert(i===void 0||typeof i=="number"&&i>=0&&i%1===0,"If provided, height should be a non-negative integer"),new We({children:[this.toDataURLImageSynchronous(e,t,s,i)]})}rasterized(e){const t=E()({resolution:1,sourceBounds:null,useTargetBounds:!0,wrap:!0,useCanvas:!1,imageOptions:{}},e),s=t.resolution,i=t.sourceBounds;assert&&(assert(typeof s=="number"&&s>0,"resolution should be a positive number"),assert(i===null||i instanceof w,"sourceBounds should be null or a Bounds2"),i&&(assert(i.isValid(),"sourceBounds should be valid (finite non-negative)"),assert(Number.isInteger(i.width),"sourceBounds.width should be an integer"),assert(Number.isInteger(i.height),"sourceBounds.height should be an integer")));const n=new We({scale:s,children:[this]});let a=i||this.getSafeTransformedVisibleBounds().dilated(2).roundedOut();s!==1&&(a=new w(s*a.minX,s*a.minY,s*a.maxX,s*a.maxY),a.width%1!==0&&(a.maxX+=1-a.width%1),a.height%1!==0&&(a.maxY+=1-a.height%1));let o=null;function h(c,u,m,b,y){const f=t.useCanvas?c:c.toDataURL();o=new $e(f,pe({},t.imageOptions,{x:-u,y:-m,initialWidth:b,initialHeight:y})),o.scale(1/s,1/s,!0)}n.toCanvas(h,-a.minX,-a.minY,Ve.roundSymmetric(a.width),Ve.roundSymmetric(a.height)),assert&&assert(o,"The toCanvas should have executed synchronously"),n.dispose();let l=this.getVisibleBounds();if(i&&(l=i.intersection(l)),t.useTargetBounds&&(o.imageBounds=o.parentToLocalBounds(l)),t.wrap){const c=new We({children:[o]});return t.useTargetBounds&&(c.localBounds=l),c}else return t.useTargetBounds&&(o.localBounds=o.parentToLocalBounds(l)),o}createDOMDrawable(e,t){throw new Error("createDOMDrawable is abstract. The subtype should either override this method, or not support the DOM renderer")}createSVGDrawable(e,t){throw new Error("createSVGDrawable is abstract. The subtype should either override this method, or not support the DOM renderer")}createCanvasDrawable(e,t){throw new Error("createCanvasDrawable is abstract. The subtype should either override this method, or not support the DOM renderer")}createWebGLDrawable(e,t){throw new Error("createWebGLDrawable is abstract. The subtype should either override this method, or not support the DOM renderer")}getInstances(){return this._instances}get instances(){return this.getInstances()}addInstance(e){this._instances.push(e),this.changedInstanceEmitter.emit(e,!0)}removeInstance(e){const t=_.indexOf(this._instances,e);assert&&assert(t!==-1,"Cannot remove a Instance from a Node if it was not there"),this._instances.splice(t,1),this.changedInstanceEmitter.emit(e,!1)}wasVisuallyDisplayed(e){for(let t=0;t<this._instances.length;t++){const s=this._instances[t];if(s.visible&&(!e||s.display===e))return!0}return!1}getRootedDisplays(){return this._rootedDisplays}get rootedDisplays(){return this.getRootedDisplays()}addRootedDisplay(e){this._rootedDisplays.push(e),this._pdomDisplaysInfo.onAddedRootedDisplay(e),this.rootedDisplayChangedEmitter.emit(e)}removeRootedDisplay(e){const t=_.indexOf(this._rootedDisplays,e);assert&&assert(t!==-1,"Cannot remove a Display from a Node if it was not there"),this._rootedDisplays.splice(t,1),this._pdomDisplaysInfo.onRemovedRootedDisplay(e),this.rootedDisplayChangedEmitter.emit(e)}getRecursiveConnectedDisplays(e){this.rootedDisplays.length&&e.push(...this.rootedDisplays);for(let t=0;t<this._parents.length;t++)e.push(...this._parents[t].getRecursiveConnectedDisplays(e));return _.uniq(e)}getConnectedDisplays(){return _.uniq(this.getRecursiveConnectedDisplays([]))}localToParentPoint(e){return this._transform.transformPosition2(e)}localToParentBounds(e){return this._transform.transformBounds2(e)}parentToLocalPoint(e){return this._transform.inversePosition2(e)}parentToLocalBounds(e){return this._transform.inverseBounds2(e)}transformBoundsFromLocalToParent(e){return e.transform(this._transform.getMatrix())}transformBoundsFromParentToLocal(e){return e.transform(this._transform.getInverse())}getLocalToGlobalMatrix(){let e=this;const t=[];for(;e;)t.push(e._transform.getMatrix()),assert&&assert(e._parents[1]===void 0,"getLocalToGlobalMatrix unable to work for DAG"),e=e._parents[0];const s=C.identity();for(let i=t.length-1;i>=0;i--)s.multiplyMatrix(t[i]);return s}getUniqueTransform(){return new Bt(this.getLocalToGlobalMatrix())}getGlobalToLocalMatrix(){return this.getLocalToGlobalMatrix().invert()}localToGlobalPoint(e){let t=this;const s=e.copy();for(;t;)t._transform.getMatrix().multiplyVector2(s),assert&&assert(t._parents[1]===void 0,"localToGlobalPoint unable to work for DAG"),t=t._parents[0];return s}globalToLocalPoint(e){let t=this;const s=[];for(;t;)s.push(t._transform),assert&&assert(t._parents[1]===void 0,"globalToLocalPoint unable to work for DAG"),t=t._parents[0];const i=e.copy();for(let n=s.length-1;n>=0;n--)s[n].getInverse().multiplyVector2(i);return i}localToGlobalBounds(e){return e.transformed(this.getLocalToGlobalMatrix())}globalToLocalBounds(e){return e.transformed(this.getGlobalToLocalMatrix())}parentToGlobalPoint(e){return assert&&assert(this.parents.length<=1,"parentToGlobalPoint unable to work for DAG"),this.parents.length?this.parents[0].localToGlobalPoint(e):e}parentToGlobalBounds(e){return assert&&assert(this.parents.length<=1,"parentToGlobalBounds unable to work for DAG"),this.parents.length?this.parents[0].localToGlobalBounds(e):e}globalToParentPoint(e){return assert&&assert(this.parents.length<=1,"globalToParentPoint unable to work for DAG"),this.parents.length?this.parents[0].globalToLocalPoint(e):e}globalToParentBounds(e){return assert&&assert(this.parents.length<=1,"globalToParentBounds unable to work for DAG"),this.parents.length?this.parents[0].globalToLocalBounds(e):e}getGlobalBounds(){return assert&&assert(this.parents.length<=1,"globalBounds unable to work for DAG"),this.parentToGlobalBounds(this.getBounds())}get globalBounds(){return this.getGlobalBounds()}boundsOf(e){return this.globalToLocalBounds(e.getGlobalBounds())}boundsTo(e){return e.globalToLocalBounds(this.getGlobalBounds())}attachDrawable(e){return this._drawables.push(e),this}detachDrawable(e){const t=_.indexOf(this._drawables,e);return assert&&assert(t>=0,"Invalid operation: trying to detach a non-referenced drawable"),this._drawables.splice(t,1),this}mutate(e){if(!e)return this;assert&&assert(Object.getPrototypeOf(e)===Object.prototype,"Extra prototype on Node options object is a code smell"),assert&&assert(_.filter(["translation","x","left","right","centerX","centerTop","rightTop","leftCenter","center","rightCenter","leftBottom","centerBottom","rightBottom"],s=>e[s]!==void 0).length<=1,`More than one mutation on this Node set the x component, check ${Object.keys(e).join(",")}`),assert&&assert(_.filter(["translation","y","top","bottom","centerY","centerTop","rightTop","leftCenter","center","rightCenter","leftBottom","centerBottom","rightBottom"],s=>e[s]!==void 0).length<=1,`More than one mutation on this Node set the y component, check ${Object.keys(e).join(",")}`),assert&&e.hasOwnProperty("enabled")&&e.hasOwnProperty("enabledProperty")&&assert&&assert(e.enabledProperty.value===e.enabled,"If both enabled and enabledProperty are provided, then values should match"),assert&&e.hasOwnProperty("inputEnabled")&&e.hasOwnProperty("inputEnabledProperty")&&assert&&assert(e.inputEnabledProperty.value===e.inputEnabled,"If both inputEnabled and inputEnabledProperty are provided, then values should match"),assert&&e.hasOwnProperty("visible")&&e.hasOwnProperty("visibleProperty")&&assert&&assert(e.visibleProperty.value===e.visible,"If both visible and visibleProperty are provided, then values should match"),assert&&e.hasOwnProperty("pdomVisible")&&e.hasOwnProperty("pdomVisibleProperty")&&assert&&assert(e.pdomVisibleProperty.value===e.pdomVisible,"If both pdomVisible and pdomVisibleProperty are provided, then values should match"),assert&&e.hasOwnProperty("pickable")&&e.hasOwnProperty("pickableProperty")&&assert&&assert(e.pickableProperty.value===e.pickable,"If both pickable and pickableProperty are provided, then values should match");const t=this._mutatorKeys;for(let s=0;s<t.length;s++){const i=t[s];if(assert&&assert(!e.hasOwnProperty(i)||e[i]!==void 0,`Undefined not allowed for Node key: ${i}`),e[i]!==void 0){const n=Object.getOwnPropertyDescriptor(We.prototype,i);n&&typeof n.value=="function"?this[i](e[i]):this[i]=e[i]}}return this.initializePhetioObject(Og,e),this}initializePhetioObject(e,t){const s=this.isPhetioInstrumented();super.initializePhetioObject(e,t),se.PHET_IO_ENABLED&&!s&&this.isPhetioInstrumented()&&(this._visibleProperty.initializePhetio(this,_a,()=>new ie(this.visible,pe({phetioReadOnly:this.phetioReadOnly,tandem:this.tandem.createTandem(_a),phetioDocumentation:"Controls whether the Node will be visible (and interactive)."},t.visiblePropertyOptions))),this._enabledProperty.initializePhetio(this,Pa,()=>new Fn(this.enabled,pe({phetioReadOnly:this.phetioReadOnly,phetioDocumentation:'Sets whether the node is enabled. This will set whether input is enabled for this Node and most often children as well. It will also control and toggle the "disabled look" of the node.',tandem:this.tandem.createTandem(Pa)},t.enabledPropertyOptions))),this._inputEnabledProperty.initializePhetio(this,Sa,()=>new me(this.inputEnabled,pe({phetioReadOnly:this.phetioReadOnly,tandem:this.tandem.createTandem(Sa),phetioValueType:Ts,phetioFeatured:!0,phetioDocumentation:"Sets whether the element will have input enabled, and hence be interactive."},t.inputEnabledPropertyOptions))))}setVoicingVisible(e){this.voicingVisibleProperty.value!==e&&(this.voicingVisibleProperty.value=e)}set voicingVisible(e){this.setVoicingVisible(e)}get voicingVisible(){return this.isVoicingVisible()}isVoicingVisible(){return this.voicingVisibleProperty.value}getDebugHTMLExtras(){return""}inspect(){localStorage.scenerySnapshot=JSON.stringify({type:"Subtree",rootNodeId:this.id,nodes:Gu(this)})}toString(){return`${this.constructor.name}#${this.id}`}auditInstanceSubtreeForDisplay(e){if(assertSlow){const t=this._instances.length;for(let s=0;s<t;s++){const i=this._instances[s];i.display===e&&assertSlow(i.trail.isValid(),`Invalid trail on Instance: ${i.toString()} with trail ${i.trail.toString()}`)}this.children.forEach(s=>{s.auditInstanceSubtreeForDisplay(e)})}}onBoundsListenersAddedOrRemoved(e){this.changeBoundsEventCount(e),this._boundsEventSelfCount+=e}dispose(){this.disposeParallelDOM(),this.removeAllChildren(),this.detach(),this._inputEnabledProperty.dispose(),this._enabledProperty.dispose(),this._pickableProperty.dispose(),this._visibleProperty.dispose(),super.dispose()}disposeSubtree(){if(!this.isDisposed){const e=this.children;this.dispose();for(let t=0;t<e.length;t++)e[t].disposeSubtree()}}static defaultTrailPredicate(e){return e._parents.length===0}static defaultLeafTrailPredicate(e){return e._children.length===0}},We.REQUIRES_BOUNDS_OPTION_KEYS=cs,We.DEFAULT_NODE_OPTIONS=ve,We);ti.prototype._mutatorKeys=Lo.concat(Ag);ti.prototype.drawableMarkFlags=[];d.register("Node",ti);ti.NodeIO=new Le("NodeIO",{valueType:ti,documentation:"The base type for graphical and potentially interactive objects.",metadataDefaults:{phetioState:Fd}});const Og={phetioType:ti.NodeIO,phetioState:Fd},D=ti;class Hd{constructor(e){this.node=e,this.selfPruned=!1,this.selfInclusive=!1,this.subtreePrunable=!0,this.subtreePickableCount=0,this.mouseInclusiveBounds=w.NOTHING.copy(),this.mouseExclusiveBounds=w.NOTHING.copy(),this.touchInclusiveBounds=w.NOTHING.copy(),this.touchExclusiveBounds=w.NOTHING.copy(),this.mouseInclusiveDirty=!0,this.mouseExclusiveDirty=!0,this.touchInclusiveDirty=!0,this.touchExclusiveDirty=!0,this.scratchVector=new T(0,0)}hitTest(e,t,s){assert&&assert(e,"trailUnderPointer requires a point"),sceneryLog&&sceneryLog.hitTest&&sceneryLog.hitTest(`-------------- ${this.node.constructor.name}#${this.node.id}`);const i=this.selfInclusive;return t?i?this.validateMouseInclusive():this.validateMouseExclusive():s?i?this.validateTouchInclusive():this.validateTouchExclusive():this.node.validateBounds(),this.recursiveHitTest(e,t,s,!1)}recursiveHitTest(e,t,s,i){if(i=i||this.selfInclusive,this.selfPruned||!i&&this.subtreePrunable)return sceneryLog&&sceneryLog.hitTest&&sceneryLog.hitTest(`${this.node.constructor.name}#${this.node.id} pruned ${this.selfPruned?"(self)":"(subtree)"}`),null;let n;if(t?(n=i?this.mouseInclusiveBounds:this.mouseExclusiveBounds,assert&&assert(i?!this.mouseInclusiveDirty:!this.mouseExclusiveDirty)):s?(n=i?this.touchInclusiveBounds:this.touchExclusiveBounds,assert&&assert(i?!this.touchInclusiveDirty:!this.touchExclusiveDirty)):(n=this.node.bounds,assert&&assert(!this.node._boundsDirty)),!n.containsPoint(e))return sceneryLog&&sceneryLog.hitTest&&sceneryLog.hitTest(`${this.node.constructor.name}#${this.node.id} pruned: ${t?"mouse":s?"touch":"regular"}`),null;const a=this.node._transform.getInverse().multiplyVector2(this.scratchVector.set(e)),o=this.node.clipArea;if(o!==null&&!o.containsPoint(a))return sceneryLog&&sceneryLog.hitTest&&sceneryLog.hitTest(`${this.node.constructor.name}#${this.node.id} out of clip area`),null;sceneryLog&&sceneryLog.hitTest&&sceneryLog.hitTest(`${this.node.constructor.name}#${this.node.id}`);for(let h=this.node._children.length-1;h>=0;h--){const l=this.node._children[h];sceneryLog&&sceneryLog.hitTest&&sceneryLog.push();const c=l._picker.recursiveHitTest(a,t,s,i);if(sceneryLog&&sceneryLog.hitTest&&sceneryLog.pop(),c)return c.addAncestor(this.node,h)}return t&&this.node._mouseArea?(sceneryLog&&sceneryLog.hitTest&&sceneryLog.hitTest(`${this.node.constructor.name}#${this.node.id} mouse area hit`),this.node._mouseArea.containsPoint(a)?new R(this.node):null):s&&this.node._touchArea?(sceneryLog&&sceneryLog.hitTest&&sceneryLog.hitTest(`${this.node.constructor.name}#${this.node.id} touch area hit`),this.node._touchArea.containsPoint(a)?new R(this.node):null):this.node.selfBounds.containsPoint(a)&&this.node.containsPointSelf(a)?(sceneryLog&&sceneryLog.hitTest&&sceneryLog.hitTest(`${this.node.constructor.name}#${this.node.id} self hit`),new R(this.node)):null}invalidate(e,t){let s=!!t||!this.mouseInclusiveDirty||!this.touchInclusiveDirty;if(this.mouseInclusiveDirty=!0,this.touchInclusiveDirty=!0,e&&(s=s||!this.mouseExclusiveDirty||!this.touchExclusiveDirty,this.mouseExclusiveDirty=!0,this.touchExclusiveDirty=!0),!this.selfPruned&&s){const i=this.node._parents;for(let n=0;n<i.length;n++)i[n]._picker.invalidate(e||this.selfInclusive,!1)}}validateMouseInclusive(){if(!this.mouseInclusiveDirty)return;this.mouseInclusiveBounds.set(this.node.selfBounds);const e=this.node._children;for(let t=0;t<e.length;t++){const s=e[t]._picker;s.selfPruned||(s.validateMouseInclusive(),this.mouseInclusiveBounds.includeBounds(s.mouseInclusiveBounds))}this.applyAreasAndTransform(this.mouseInclusiveBounds,this.node._mouseArea),this.mouseInclusiveDirty=!1}validateMouseExclusive(){if(!this.mouseExclusiveDirty)return;this.mouseExclusiveBounds.set(this.node.selfBounds);const e=this.node._children;for(let t=0;t<e.length;t++){const s=e[t]._picker;s.subtreePrunable||(s.selfInclusive?(s.validateMouseInclusive(),this.mouseExclusiveBounds.includeBounds(s.mouseInclusiveBounds)):(s.validateMouseExclusive(),this.mouseExclusiveBounds.includeBounds(s.mouseExclusiveBounds)))}this.applyAreasAndTransform(this.mouseExclusiveBounds,this.node._mouseArea),this.mouseExclusiveDirty=!1}validateTouchInclusive(){if(!this.touchInclusiveDirty)return;this.touchInclusiveBounds.set(this.node.selfBounds);const e=this.node._children;for(let t=0;t<e.length;t++){const s=e[t]._picker;s.selfPruned||(s.validateTouchInclusive(),this.touchInclusiveBounds.includeBounds(s.touchInclusiveBounds))}this.applyAreasAndTransform(this.touchInclusiveBounds,this.node._touchArea),this.touchInclusiveDirty=!1}validateTouchExclusive(){if(!this.touchExclusiveDirty)return;this.touchExclusiveBounds.set(this.node.selfBounds);const e=this.node._children;for(let t=0;t<e.length;t++){const s=e[t]._picker;s.subtreePrunable||(s.selfInclusive?(s.validateTouchInclusive(),this.touchExclusiveBounds.includeBounds(s.touchInclusiveBounds)):(s.validateTouchExclusive(),this.touchExclusiveBounds.includeBounds(s.touchExclusiveBounds)))}this.applyAreasAndTransform(this.touchExclusiveBounds,this.node._touchArea),this.touchExclusiveDirty=!1}applyAreasAndTransform(e,t){t&&e.includeBounds(t instanceof w?t:t.bounds);const s=this.node.clipArea;if(s){const i=s.bounds;e.minX=Math.max(e.minX,i.minX),e.minY=Math.max(e.minY,i.minY),e.maxX=Math.min(e.maxX,i.maxX),e.maxY=Math.min(e.maxY,i.maxY)}this.node.transformBoundsFromLocalToParent(e)}onInsertChild(e){if(!e._picker.selfPruned){const t=e._picker.subtreePickableCount>0;t&&this.changePickableCount(1),this.invalidate(t,!0)}}onRemoveChild(e){if(!e._picker.selfPruned){const t=e._picker.subtreePickableCount>0;t&&this.changePickableCount(-1),this.invalidate(t,!0)}}onAddInputListener(){this.checkSelfInclusive(),this.checkSubtreePrunable(),this.changePickableCount(1),assertSlow&&this.audit()}onRemoveInputListener(){this.checkSelfInclusive(),this.checkSubtreePrunable(),this.changePickableCount(-1),assertSlow&&this.audit()}onPickableChange(e,t){this.checkSelfPruned(),this.checkSelfInclusive(),this.checkSubtreePrunable();const s=(e===!0?-1:0)+(t===!0?1:0);s&&this.changePickableCount(s),assertSlow&&this.audit()}onVisibilityChange(){this.checkSelfPruned(),this.checkSubtreePrunable()}onMouseAreaChange(){this.invalidate(!0)}onTouchAreaChange(){this.invalidate(!0)}onTransformChange(){this.invalidate(!0)}onSelfBoundsDirty(){this.invalidate(!0)}onClipAreaChange(){this.invalidate(!0)}checkSelfPruned(){const e=this.node.pickableProperty.value===!1||!this.node.isVisible();if(this.selfPruned!==e){this.selfPruned=e;const t=this.node._parents;for(let s=0;s<t.length;s++){const i=t[s]._picker;this.subtreePickableCount>0?(i.invalidate(!0,!0),i.changePickableCount(this.selfPruned?-1:1)):i.invalidate(!1,!0)}}}checkSelfInclusive(){const e=this.node.pickableProperty.value===!0||this.node._inputListeners.length>0;this.selfInclusive!==e&&(this.selfInclusive=e,this.invalidate(!0,!0))}checkSubtreePrunable(){const e=this.node.pickableProperty.value===!1||!this.node.isVisible()||this.node.pickableProperty.value!==!0&&this.subtreePickableCount===0;this.subtreePrunable!==e&&(this.subtreePrunable=e,this.invalidate(!0,!0))}changePickableCount(e){if(e===0)return;const t=this.subtreePickableCount===0;this.subtreePickableCount+=e;const s=this.subtreePickableCount===0;if(this.checkSubtreePrunable(),assert&&assert(this.subtreePickableCount>=0,"subtree pickable count should be guaranteed to be >= 0"),!this.selfPruned&&t!==s){const i=this.node._parents.length;for(let n=0;n<i;n++)this.node._parents[n]._picker.changePickableCount(t?1:-1)}}audit(){if(assertSlow){this.node._children.forEach(a=>{a._picker.audit()});const e=assertSlow,t=this.node.pickable===!1||!this.node.isVisible(),s=this.node.pickable===!0||this.node._inputListeners.length>0,i=this.node.pickable===!1||!this.node.isVisible()||this.node.pickable!==!0&&this.subtreePickableCount===0,n=this.node._inputListeners.length+(this.node.pickableProperty.value===!0?1:0)+_.filter(this.node._children,a=>!a._picker.selfPruned&&a._picker.subtreePickableCount>0).length;assertSlow(this.selfPruned===t,"selfPruned mismatch"),assertSlow(this.selfInclusive===s,"selfInclusive mismatch"),assertSlow(this.subtreePrunable===i,"subtreePrunable mismatch"),assertSlow(this.subtreePickableCount===n,"subtreePickableCount mismatch"),this.node._parents.forEach(a=>{const o=a._picker,h=this;o.mouseInclusiveDirty||e(h.selfPruned||!h.mouseInclusiveDirty),o.mouseExclusiveDirty||(h.selfInclusive?e(h.selfPruned||!h.mouseInclusiveDirty):e(h.selfPruned||h.subtreePrunable||!h.mouseExclusiveDirty)),o.touchInclusiveDirty||e(h.selfPruned||!h.touchInclusiveDirty),o.touchExclusiveDirty||(h.selfInclusive?e(h.selfPruned||!h.touchInclusiveDirty):e(h.selfPruned||h.subtreePrunable||!h.touchExclusiveDirty))})}}}d.register("Picker",Hd);const rs=[p.bitmaskCanvas,p.bitmaskSVG,p.bitmaskDOM,p.bitmaskWebGL,p.bitmaskSingleCanvas,p.bitmaskSingleSVG,p.bitmaskNotPainted,p.bitmaskBoundsValid,p.bitmaskNoPDOM,p.bitmaskLacksCanvas,p.bitmaskLacksSVG,p.bitmaskLacksDOM,p.bitmaskLacksWebGL],Vd={};rs.forEach((r,e)=>{Vd[r]=e});const ys=rs.length;let Zo=0;for(let r=0;r<ys;r++)Zo|=rs[r];class as{constructor(e){assert&&assert(e instanceof D),assert&&assert(e._rendererBitmask===p.bitmaskNodeDefault,"Node must have a default bitmask when creating a RendererSummary"),assert&&assert(e._children.length===0,"Node cannot have children when creating a RendererSummary"),this.node=e,this._counts=new Int16Array(ys),this.bitmask=Zo,this.selfBitmask=as.summaryBitmaskForNodeSelf(e),this.summaryChange(this.bitmask,this.selfBitmask);const t=this.selfChange.bind(this);this.node.filterChangeEmitter.addListener(t),this.node.clipAreaProperty.lazyLink(t),this.node.rendererSummaryRefreshEmitter.addListener(t)}summaryChange(e,t){assert&&this.audit();const s=e^t;let i=0,n=0;for(let a=0;a<ys;a++){const o=rs[a],h=Vd[o];o&s&&(o&t?(this._counts[h]--,this._counts[h]===0&&(n|=o)):(this._counts[h]++,this._counts[h]===1&&(i|=o)))}if(i||n){const a=this.bitmask;assert&&assert(a!==void 0);for(let h=0;h<ys;h++){const l=rs[h];n&l&&(this.bitmask|=l),i&l&&(this.bitmask^=l,assert&&assert(!(this.bitmask&l),"Should be cleared, doing cheaper XOR assuming it already was set"))}this.node.instanceRefreshEmitter.emit(),this.node.onSummaryChange(a,this.bitmask);const o=this.node._parents.length;for(let h=0;h<o;h++)this.node._parents[h]._rendererSummary.summaryChange(i,n);assert&&assert(this.bitmask===this.computeBitmask(),"Sanity check")}assert&&this.audit()}selfChange(){const e=this.selfBitmask,t=as.summaryBitmaskForNodeSelf(this.node);e!==t&&(this.summaryChange(e,t),this.selfBitmask=t)}computeBitmask(){let e=0;for(let t=0;t<ys;t++)this._counts[t]===0&&(e|=rs[t]);return e}isSubtreeFullyCompatible(e){return!!(e&this.bitmask)}isSubtreeContainingCompatible(e){return!(e<<p.bitmaskLacksShift&this.bitmask)}isSingleCanvasSupported(){return!!(p.bitmaskSingleCanvas&this.bitmask)}isSingleSVGSupported(){return!!(p.bitmaskSingleSVG&this.bitmask)}isNotPainted(){return!!(p.bitmaskNotPainted&this.bitmask)}hasNoPDOM(){return!!(p.bitmaskNoPDOM&this.bitmask)}areBoundsValid(){return!!(p.bitmaskBoundsValid&this.bitmask)}isSubtreeRenderedExclusivelySVG(e){if(!this.isSingleSVGSupported())return!1;for(let t=0;t<p.numActiveRenderers;t++){const s=p.bitmaskOrder(e,t);if(p.bitmaskSVG&s)return!0;if(this.isSubtreeContainingCompatible(s))return!1}return!1}isSubtreeRenderedExclusivelyCanvas(e){if(!this.isSingleCanvasSupported())return!1;for(let t=0;t<p.numActiveRenderers;t++){const s=p.bitmaskOrder(e,t);if(p.bitmaskCanvas&s)return!0;if(this.isSubtreeContainingCompatible(s))return!1}return!1}audit(){if(assert)for(let e=0;e<ys;e++){const t=rs[e],s=this._counts[e]===0,i=!!(this.bitmask&t);assert(s===i,"Bits should be set if count is zero")}}toString(){let e=as.bitmaskToString(this.bitmask);for(let t=0;t<ys;t++){const s=rs[t],i=this._counts[t];i!==0&&(e+=` ${as.bitToString(s)}:${i}`)}return e}static summaryBitmaskForNodeSelf(e){let t=e._rendererBitmask;e.isPainted()?t|=(e._rendererBitmask&p.bitmaskCurrentRendererArea^p.bitmaskCurrentRendererArea)<<p.bitmaskLacksShift:t|=p.bitmaskCurrentRendererArea<<p.bitmaskLacksShift;const s=e._cssTransform||e._layerSplit,i=e._renderer;return!s&&p.isSVG(e._rendererBitmask)&&(!i||p.isSVG(i))&&(t|=p.bitmaskSingleSVG),!s&&p.isCanvas(e._rendererBitmask)&&(!i||p.isCanvas(i))&&(t|=p.bitmaskSingleCanvas),e.isPainted()||(t|=p.bitmaskNotPainted),e.areSelfBoundsValid()&&(t|=p.bitmaskBoundsValid),!e.hasPDOMContent&&!e.hasPDOMOrder()&&(t|=p.bitmaskNoPDOM),t}static bitToString(e){return e===p.bitmaskCanvas?"Canvas":e===p.bitmaskSVG?"SVG":e===p.bitmaskDOM?"DOM":e===p.bitmaskWebGL?"WebGL":e===p.bitmaskLacksCanvas?"(-Canvas)":e===p.bitmaskLacksSVG?"(-SVG)":e===p.bitmaskLacksDOM?"(-DOM)":e===p.bitmaskLacksWebGL?"(-WebGL)":e===p.bitmaskSingleCanvas?"SingleCanvas":e===p.bitmaskSingleSVG?"SingleSVG":e===p.bitmaskNotPainted?"NotPainted":e===p.bitmaskBoundsValid?"BoundsValid":e===p.bitmaskNoPDOM?"NotAccessible":"?"}static bitmaskToString(e){let t="";for(let s=0;s<ys;s++){const i=rs[s];e&i&&(t+=`${as.bitToString(i)} `)}return t}}as.bitmaskAll=Zo;d.register("RendererSummary",as);const wa=as;class Gd{constructor(e){this.node=e,this.pdomDisplays=[]}onAddChild(e){sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`onAddChild n#${e.id} (parent:n#${this.node.id})`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),e._pdomDisplaysInfo.canHavePDOMDisplays()&&e._pdomDisplaysInfo.addPDOMDisplays(this.pdomDisplays),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}onRemoveChild(e){sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`onRemoveChild n#${e.id} (parent:n#${this.node.id})`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),e._pdomDisplaysInfo.canHavePDOMDisplays()&&e._pdomDisplaysInfo.removePDOMDisplays(this.pdomDisplays),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}onSummaryChange(e,t){if(sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`onSummaryChange n#${this.node.id} wasPDOM:${!(p.bitmaskNoPDOM&e)}, isPDOM:${!(p.bitmaskNoPDOM&t)}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),this.node.visible&&this.node.pdomVisible){const s=!(p.bitmaskNoPDOM&e),i=!(p.bitmaskNoPDOM&t);i&&!s&&this.addAllPDOMDisplays(),!i&&s&&this.removeAllPDOMDisplays()}sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}onVisibilityChange(e){sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`onVisibilityChange n#${this.node.id} visible:${e}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),this.node.pdomVisible&&!this.node._rendererSummary.hasNoPDOM()&&(e?this.addAllPDOMDisplays():this.removeAllPDOMDisplays()),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}onPDOMVisibilityChange(e){sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`onPDOMVisibilityChange n#${this.node.id} pdomVisible:${e}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),this.node.visible&&!this.node._rendererSummary.hasNoPDOM()&&(e?this.addAllPDOMDisplays():this.removeAllPDOMDisplays()),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}onAddedRootedDisplay(e){sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`onAddedRootedDisplay n#${this.node.id}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),e._accessible&&this.canHavePDOMDisplays()&&this.addPDOMDisplays([e]),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}onRemovedRootedDisplay(e){sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`onRemovedRootedDisplay n#${this.node.id}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),e._accessible&&this.canHavePDOMDisplays()&&this.removePDOMDisplays([e]),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}canHavePDOMDisplays(){return this.node.visible&&this.node.pdomVisible&&!this.node._rendererSummary.hasNoPDOM()}addAllPDOMDisplays(){sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`addAllPDOMDisplays n#${this.node.id}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),assert&&assert(this.pdomDisplays.length===0,"Should be empty before adding everything"),assert&&assert(this.canHavePDOMDisplays(),"Should happen when we can store pdomDisplays");let e;const t=[];for(e=0;e<this.node._parents.length;e++)Array.prototype.push.apply(t,this.node._parents[e]._pdomDisplaysInfo.pdomDisplays);for(e=0;e<this.node._rootedDisplays.length;e++){const s=this.node._rootedDisplays[e];s._accessible&&t.push(s)}this.addPDOMDisplays(t),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}removeAllPDOMDisplays(){sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`removeAllPDOMDisplays n#${this.node.id}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),assert&&assert(!this.canHavePDOMDisplays(),"Should happen when we cannot store pdomDisplays"),this.removePDOMDisplays(this.pdomDisplays.slice()),assert&&assert(this.pdomDisplays.length===0,"Should be empty after removing everything"),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}addPDOMDisplays(e){if(sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`addPDOMDisplays n#${this.node.id} numDisplays:${e.length}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),assert&&assert(Array.isArray(e)),e.length!==0){Array.prototype.push.apply(this.pdomDisplays,e);for(let t=0;t<this.node._children.length;t++)this.node._children[t]._pdomDisplaysInfo.canHavePDOMDisplays()&&this.node._children[t]._pdomDisplaysInfo.addPDOMDisplays(e);this.node.pdomDisplaysEmitter.emit()}sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}removePDOMDisplays(e){if(sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.PDOMDisplaysInfo(`removePDOMDisplays n#${this.node.id} numDisplays:${e.length}`),sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.push(),assert&&assert(Array.isArray(e)),assert&&assert(this.pdomDisplays.length>=e.length,"there should be at least as many PDOMDisplays as Displays"),e.length!==0){let t;for(t=e.length-1;t>=0;t--){const s=this.pdomDisplays.lastIndexOf(e[t]);assert&&assert(s>=0),this.pdomDisplays.splice(t,1)}for(t=0;t<this.node._children.length;t++){const s=this.node._children[t];s._pdomDisplaysInfo.canHavePDOMDisplays()&&!s._isGettingRemovedFromParent&&s._pdomDisplaysInfo.removePDOMDisplays(e)}this.node.pdomDisplaysEmitter.emit()}sceneryLog&&sceneryLog.PDOMDisplaysInfo&&sceneryLog.pop()}}d.register("PDOMDisplaysInfo",Gd);const ir=1e-9,vo=["preferredWidth","minimumWidth","localPreferredWidth","localMinimumWidth","widthSizable"],Ur=Me(r=>{const e=Bi("WidthSizable",vo,class extends r{constructor(...s){super(...s),this.preferredWidthProperty=new X(null),this.minimumWidthProperty=new X(null),this.localPreferredWidthProperty=new X(null),this.localMinimumWidthProperty=new X(null),this.isWidthResizableProperty=new X(!0),this._preferredSizeChanging=!1,this._minimumSizeChanging=!1,this._preferredSizeChangeAttemptDuringLock=!1,this._minimumSizeChangeAttemptDuringLock=!1,this._updatePreferredWidthListener=this._updatePreferredWidth.bind(this),this._updateLocalPreferredWidthListener=this._updateLocalPreferredWidth.bind(this),this._updateMinimumWidthListener=this._updateMinimumWidth.bind(this),this._updateLocalMinimumWidthListener=this._updateLocalMinimumWidth.bind(this),this.preferredWidthProperty.lazyLink(this._updateLocalPreferredWidthListener),this.localPreferredWidthProperty.lazyLink(this._updatePreferredWidthListener),this.minimumWidthProperty.lazyLink(this._updateLocalMinimumWidthListener),this.localMinimumWidthProperty.lazyLink(this._updateMinimumWidthListener),this.transformEmitter.addListener(this._updateLocalPreferredWidthListener),this.transformEmitter.addListener(this._updateMinimumWidthListener)}get preferredWidth(){return assert&&assert(this.preferredWidthProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),this.preferredWidthProperty.value}set preferredWidth(s){assert&&assert(this.preferredWidthProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),assert&&assert(s===null||typeof s=="number"&&isFinite(s)&&s>=0,"preferredWidth should be null or a non-negative finite number"),this.preferredWidthProperty.value=s}get localPreferredWidth(){return assert&&assert(this.localPreferredWidthProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),this.localPreferredWidthProperty.value}set localPreferredWidth(s){assert&&assert(this.localPreferredWidthProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),assert&&assert(s===null||typeof s=="number"&&isFinite(s)&&s>=0,"localPreferredWidth should be null or a non-negative finite number"),this.localPreferredWidthProperty.value=s}get minimumWidth(){return assert&&assert(this.minimumWidthProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),this.minimumWidthProperty.value}set minimumWidth(s){assert&&assert(this.minimumWidthProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),assert&&assert(s===null||typeof s=="number"&&isFinite(s)),this.minimumWidthProperty.value=s}get localMinimumWidth(){return assert&&assert(this.localMinimumWidthProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),this.localMinimumWidthProperty.value}set localMinimumWidth(s){assert&&assert(this.localMinimumWidthProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),assert&&assert(s===null||typeof s=="number"&&isFinite(s)),this.localMinimumWidthProperty.value=s}get widthSizable(){return assert&&assert(this.isWidthResizableProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),this.isWidthResizableProperty.value}set widthSizable(s){assert&&assert(this.isWidthResizableProperty,"WidthSizable options should be set from a later mutate() call instead of the super constructor"),this.isWidthResizableProperty.value=s}get extendsWidthSizable(){return!0}validateLocalPreferredWidth(){if(assert){const s=this.localWidth,i=this.localMinimumWidth===null?s:this.localMinimumWidth,n=this.localPreferredWidth===null?i:this.localPreferredWidth;assert(n===s||Math.abs(n-s)<1e-7)}}_calculateLocalPreferredWidth(){return this.matrix.isAligned()&&this.preferredWidth!==null?Math.abs(this.transform.inverseDeltaX(this.preferredWidth)):null}_onReentrantPreferredWidth(){this._updateLocalPreferredWidthListener()}_updateLocalPreferredWidth(){if(assert&&this.auditMaxDimensions(),this._preferredSizeChanging)this._preferredSizeChangeAttemptDuringLock=!0;else{this._preferredSizeChanging=!0;do{this._preferredSizeChangeAttemptDuringLock=!1;const s=this._calculateLocalPreferredWidth();(this.localPreferredWidthProperty.value===null||s===null||Math.abs(this.localPreferredWidthProperty.value-s)>ir)&&(this.localPreferredWidthProperty.value=s)}while(this._preferredSizeChangeAttemptDuringLock);this._preferredSizeChanging=!1}}_calculatePreferredWidth(){return this.matrix.isAligned()&&this.localPreferredWidth!==null?Math.abs(this.transform.transformDeltaX(this.localPreferredWidth)):null}_updatePreferredWidth(){if(this._preferredSizeChanging)this._preferredSizeChangeAttemptDuringLock=!0;else{this._preferredSizeChanging=!0,this._preferredSizeChangeAttemptDuringLock=!1;const s=this._calculatePreferredWidth();(this.preferredWidthProperty.value===null||s===null||Math.abs(this.preferredWidthProperty.value-s)>ir)&&(this.preferredWidthProperty.value=s),this._preferredSizeChanging=!1,this._preferredSizeChangeAttemptDuringLock&&this._onReentrantPreferredWidth()}}_calculateLocalMinimumWidth(){return this.matrix.isAligned()&&this.minimumWidth!==null?Math.abs(this.transform.inverseDeltaX(this.minimumWidth)):null}_onReentrantLocalMinimumWidth(){this._updateMinimumWidthListener()}_updateLocalMinimumWidth(){if(this._minimumSizeChanging)this._minimumSizeChangeAttemptDuringLock=!0;else{this._minimumSizeChanging=!0;const s=this._calculateLocalMinimumWidth();this._minimumSizeChangeAttemptDuringLock=!1,(this.localMinimumWidthProperty.value===null||s===null||Math.abs(this.localMinimumWidthProperty.value-s)>ir)&&(this.localMinimumWidthProperty.value=s),this._minimumSizeChanging=!1,this._minimumSizeChangeAttemptDuringLock&&this._onReentrantLocalMinimumWidth()}}_calculateMinimumWidth(){return this.matrix.isAligned()&&this.localMinimumWidth!==null?Math.abs(this.transform.transformDeltaX(this.localMinimumWidth)):null}_updateMinimumWidth(){if(this._minimumSizeChanging)this._minimumSizeChangeAttemptDuringLock=!0;else{this._minimumSizeChanging=!0;do{this._minimumSizeChangeAttemptDuringLock=!1;const s=this._calculateMinimumWidth();(this.minimumWidthProperty.value===null||s===null||Math.abs(this.minimumWidthProperty.value-s)>ir)&&(this.minimumWidthProperty.value=s)}while(this._minimumSizeChangeAttemptDuringLock);this._minimumSizeChanging=!1}}mutate(s){return super.mutate(s)}});if(e.prototype._mutatorKeys){const t=e.prototype._mutatorKeys,s=vo,i=t.indexOf(cs[0]);e.prototype._mutatorKeys=[...t.slice(0,i),...s,...t.slice(i)]}return e}),Si=r=>r.widthSizable,Cl=r=>r.extendsWidthSizable;d.register("WidthSizable",Ur);const nr=1e-9,Po=["preferredHeight","minimumHeight","localPreferredHeight","localMinimumHeight","heightSizable"],Jo=Me(r=>{const e=Bi("HeightSizable",Po,class extends r{constructor(...s){super(...s),this.preferredHeightProperty=new X(null),this.minimumHeightProperty=new X(null),this.localPreferredHeightProperty=new X(null),this.localMinimumHeightProperty=new X(null),this.isHeightResizableProperty=new X(!0),this._preferredSizeChanging=!1,this._minimumSizeChanging=!1,this._preferredSizeChangeAttemptDuringLock=!1,this._minimumSizeChangeAttemptDuringLock=!1,this._updatePreferredHeightListener=this._updatePreferredHeight.bind(this),this._updateLocalPreferredHeightListener=this._updateLocalPreferredHeight.bind(this),this._updateMinimumHeightListener=this._updateMinimumHeight.bind(this),this._updateLocalMinimumHeightListener=this._updateLocalMinimumHeight.bind(this),this.preferredHeightProperty.lazyLink(this._updateLocalPreferredHeightListener),this.localPreferredHeightProperty.lazyLink(this._updatePreferredHeightListener),this.minimumHeightProperty.lazyLink(this._updateLocalMinimumHeightListener),this.localMinimumHeightProperty.lazyLink(this._updateMinimumHeightListener),this.transformEmitter.addListener(this._updateLocalPreferredHeightListener),this.transformEmitter.addListener(this._updateMinimumHeightListener)}get preferredHeight(){return assert&&assert(this.preferredHeightProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),this.preferredHeightProperty.value}set preferredHeight(s){assert&&assert(this.preferredHeightProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),assert&&assert(s===null||typeof s=="number"&&isFinite(s)&&s>=0,"preferredHeight should be null or a non-negative finite number"),this.preferredHeightProperty.value=s}get localPreferredHeight(){return assert&&assert(this.localPreferredHeightProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),this.localPreferredHeightProperty.value}set localPreferredHeight(s){assert&&assert(this.localPreferredHeightProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),assert&&assert(s===null||typeof s=="number"&&isFinite(s)&&s>=0,"localPreferredHeight should be null or a non-negative finite number"),this.localPreferredHeightProperty.value=s}get minimumHeight(){return assert&&assert(this.minimumHeightProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),this.minimumHeightProperty.value}set minimumHeight(s){assert&&assert(this.minimumHeightProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),assert&&assert(s===null||typeof s=="number"&&isFinite(s)),this.minimumHeightProperty.value=s}get localMinimumHeight(){return assert&&assert(this.localMinimumHeightProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),this.localMinimumHeightProperty.value}set localMinimumHeight(s){assert&&assert(this.localMinimumHeightProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),assert&&assert(s===null||typeof s=="number"&&isFinite(s)),this.localMinimumHeightProperty.value=s}get heightSizable(){return assert&&assert(this.isHeightResizableProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),this.isHeightResizableProperty.value}set heightSizable(s){assert&&assert(this.isHeightResizableProperty,"HeightSizable options should be set from a later mutate() call instead of the super constructor"),this.isHeightResizableProperty.value=s}get extendsHeightSizable(){return!0}validateLocalPreferredHeight(){if(assert){const s=this.localHeight,i=this.localMinimumHeight===null?s:this.localMinimumHeight,n=this.localPreferredHeight===null?i:this.localPreferredHeight;assert(n===s||Math.abs(n-s)<1e-7)}}_calculateLocalPreferredHeight(){return this.matrix.isAligned()&&this.preferredHeight!==null?Math.abs(this.transform.inverseDeltaY(this.preferredHeight)):null}_onReentrantPreferredHeight(){this._updateLocalPreferredHeightListener()}_updateLocalPreferredHeight(){if(assert&&this.auditMaxDimensions(),this._preferredSizeChanging)this._preferredSizeChangeAttemptDuringLock=!0;else{this._preferredSizeChanging=!0;do{this._preferredSizeChangeAttemptDuringLock=!1;const s=this._calculateLocalPreferredHeight();(this.localPreferredHeightProperty.value===null||s===null||Math.abs(this.localPreferredHeightProperty.value-s)>nr)&&(this.localPreferredHeightProperty.value=s)}while(this._preferredSizeChangeAttemptDuringLock);this._preferredSizeChanging=!1}}_calculatePreferredHeight(){return this.matrix.isAligned()&&this.localPreferredHeight!==null?Math.abs(this.transform.transformDeltaY(this.localPreferredHeight)):null}_updatePreferredHeight(){if(this._preferredSizeChanging)this._preferredSizeChangeAttemptDuringLock=!0;else{this._preferredSizeChanging=!0,this._preferredSizeChangeAttemptDuringLock=!1;const s=this._calculatePreferredHeight();(this.preferredHeightProperty.value===null||s===null||Math.abs(this.preferredHeightProperty.value-s)>nr)&&(this.preferredHeightProperty.value=s),this._preferredSizeChanging=!1,this._preferredSizeChangeAttemptDuringLock&&this._onReentrantPreferredHeight()}}_calculateLocalMinimumHeight(){return this.matrix.isAligned()&&this.minimumHeight!==null?Math.abs(this.transform.inverseDeltaY(this.minimumHeight)):null}_onReentrantLocalMinimumHeight(){this._updateMinimumHeight()}_updateLocalMinimumHeight(){if(this._minimumSizeChanging)this._minimumSizeChangeAttemptDuringLock=!0;else{this._minimumSizeChanging=!0,this._minimumSizeChangeAttemptDuringLock=!1;const s=this._calculateLocalMinimumHeight();(this.localMinimumHeightProperty.value===null||s===null||Math.abs(this.localMinimumHeightProperty.value-s)>nr)&&(this.localMinimumHeightProperty.value=s),this._minimumSizeChanging=!1,this._minimumSizeChangeAttemptDuringLock&&this._onReentrantLocalMinimumHeight()}}_calculateMinimumHeight(){return this.matrix.isAligned()&&this.localMinimumHeight!==null?Math.abs(this.transform.transformDeltaY(this.localMinimumHeight)):null}_updateMinimumHeight(){if(!this._minimumSizeChanging){this._minimumSizeChanging=!0;do{this._minimumSizeChangeAttemptDuringLock=!1;const s=this._calculateMinimumHeight();(this.minimumHeightProperty.value===null||s===null||Math.abs(this.minimumHeightProperty.value-s)>nr)&&(this.minimumHeightProperty.value=s)}while(this._minimumSizeChangeAttemptDuringLock);this._minimumSizeChanging=!1}}mutate(s){return super.mutate(s)}});if(e.prototype._mutatorKeys){const t=e.prototype._mutatorKeys,s=Po,i=t.indexOf(cs[0]);e.prototype._mutatorKeys=[...t.slice(0,i),...s,...t.slice(i)]}return e}),wi=r=>r.heightSizable,Il=r=>r.extendsHeightSizable;d.register("HeightSizable",Jo);const El=["preferredSize","minimumSize","localPreferredSize","localMinimumSize","sizable"],zd=["preferredSize","minimumSize","localPreferredSize","localMinimumSize","sizable",...vo,...Po],Yr=Me(r=>{const e=Ur(Jo(r)),t=Bi("Sizable",El,class extends e{constructor(...i){super(...i),this.preferredWidthProperty.lazyLink(this._updateLocalPreferredHeightListener),this.preferredHeightProperty.lazyLink(this._updateLocalPreferredWidthListener),this.localPreferredWidthProperty.lazyLink(this._updatePreferredHeightListener),this.localPreferredHeightProperty.lazyLink(this._updatePreferredWidthListener),this.minimumWidthProperty.lazyLink(this._updateLocalMinimumHeightListener),this.minimumHeightProperty.lazyLink(this._updateLocalMinimumWidthListener),this.localMinimumWidthProperty.lazyLink(this._updateMinimumHeightListener),this.localMinimumHeightProperty.lazyLink(this._updateMinimumWidthListener)}get preferredSize(){return assert&&assert(this.preferredWidth===null==(this.preferredHeight===null),"Cannot get a preferredSize when one of preferredWidth/preferredHeight is null"),this.preferredWidth===null||this.preferredHeight===null?null:new Mt(this.preferredWidth,this.preferredHeight)}set preferredSize(i){this.preferredWidth=i===null?null:i.width,this.preferredHeight=i===null?null:i.height}get localPreferredSize(){return assert&&assert(this.localPreferredWidth===null==(this.localPreferredHeight===null),"Cannot get a preferredSize when one of preferredWidth/preferredHeight is null"),this.localPreferredWidth===null||this.localPreferredHeight===null?null:new Mt(this.localPreferredWidth,this.localPreferredHeight)}set localPreferredSize(i){this.localPreferredWidth=i===null?null:i.width,this.localPreferredHeight=i===null?null:i.height}get minimumSize(){return assert&&assert(this.minimumWidth===null==(this.minimumHeight===null),"Cannot get a minimumSize when one of minimumWidth/minimumHeight is null"),this.minimumWidth===null||this.minimumHeight===null?null:new Mt(this.minimumWidth,this.minimumHeight)}set minimumSize(i){this.minimumWidth=i===null?null:i.width,this.minimumHeight=i===null?null:i.height}get localMinimumSize(){return assert&&assert(this.localMinimumWidth===null==(this.localMinimumHeight===null),"Cannot get a minimumSize when one of minimumWidth/minimumHeight is null"),this.localMinimumWidth===null||this.localMinimumHeight===null?null:new Mt(this.localMinimumWidth,this.localMinimumHeight)}set localMinimumSize(i){this.localMinimumWidth=i===null?null:i.width,this.localMinimumHeight=i===null?null:i.height}get sizable(){return assert&&assert(this.widthSizable===this.heightSizable,"widthSizable and heightSizable not the same, which is required for the sizable getter"),this.widthSizable}set sizable(i){this.widthSizable=i,this.heightSizable=i}get extendsSizable(){return!0}validateLocalPreferredSize(){assert&&(this.validateLocalPreferredWidth(),this.validateLocalPreferredHeight())}mutate(i){return Ge(i,["preferredSize"],["preferredWidth","preferredHeight"]),Ge(i,["localPreferredSize"],["localPreferredWidth","localPreferredHeight"]),Ge(i,["minimumSize"],["minimumWidth","minimumHeight"]),Ge(i,["localMinimumSize"],["localMinimumWidth","localMinimumHeight"]),Ge(i,["sizable"],["widthSizable","heightSizable"]),super.mutate(i)}_calculateLocalPreferredWidth(){if(this.matrix.isAxisAligned()){if(this.matrix.isAligned()){if(this.preferredWidth!==null)return Math.abs(this.transform.inverseDeltaX(this.preferredWidth))}else if(this.preferredHeight!==null)return Math.abs(this.transform.getInverse().m01()*this.preferredHeight)}return null}_calculateLocalPreferredHeight(){if(this.matrix.isAxisAligned()){if(this.matrix.isAligned()){if(this.preferredHeight!==null)return Math.abs(this.transform.inverseDeltaY(this.preferredHeight))}else if(this.preferredWidth!==null)return Math.abs(this.transform.getInverse().m10()*this.preferredWidth)}return null}_calculatePreferredWidth(){if(this.matrix.isAxisAligned()){if(this.matrix.isAligned()){if(this.localPreferredWidth!==null)return Math.abs(this.transform.transformDeltaX(this.localPreferredWidth))}else if(this.localPreferredHeight!==null)return Math.abs(this.transform.matrix.m01()*this.localPreferredHeight)}return null}_calculatePreferredHeight(){if(this.matrix.isAxisAligned()){if(this.matrix.isAligned()){if(this.localPreferredHeight!==null)return Math.abs(this.transform.transformDeltaY(this.localPreferredHeight))}else if(this.localPreferredWidth!==null)return Math.abs(this.transform.matrix.m10()*this.localPreferredWidth)}return null}_onReentrantLocalMinimumWidth(){this._updateMinimumWidthListener(),this._updateMinimumHeightListener()}_onReentrantLocalMinimumHeight(){this._updateMinimumWidthListener(),this._updateMinimumHeightListener()}_onReentrantPreferredWidth(){this._updateLocalPreferredWidthListener(),this._updateLocalPreferredHeightListener()}_onReentrantPreferredHeight(){this._updateLocalPreferredWidthListener(),this._updateLocalPreferredHeightListener()}_calculateLocalMinimumWidth(){if(this.matrix.isAxisAligned()){if(this.matrix.isAligned()){if(this.minimumWidth!==null)return Math.abs(this.transform.inverseDeltaX(this.minimumWidth))}else if(this.minimumHeight!==null)return Math.abs(this.transform.getInverse().m01()*this.minimumHeight)}return null}_calculateLocalMinimumHeight(){if(this.matrix.isAxisAligned()){if(this.matrix.isAligned()){if(this.minimumHeight!==null)return Math.abs(this.transform.inverseDeltaY(this.minimumHeight))}else if(this.minimumWidth!==null)return Math.abs(this.transform.getInverse().m10()*this.minimumWidth)}return null}_calculateMinimumWidth(){if(this.matrix.isAxisAligned()){if(this.matrix.isAligned()){if(this.localMinimumWidth!==null)return Math.abs(this.transform.transformDeltaX(this.localMinimumWidth))}else if(this.localMinimumHeight!==null)return Math.abs(this.transform.matrix.m01()*this.localMinimumHeight)}return null}_calculateMinimumHeight(){if(this.matrix.isAxisAligned()){if(this.matrix.isAligned()){if(this.localMinimumHeight!==null)return Math.abs(this.transform.transformDeltaY(this.localMinimumHeight))}else if(this.localMinimumWidth!==null)return Math.abs(this.transform.matrix.m10()*this.localMinimumWidth)}return null}});if(t.prototype._mutatorKeys){const s=t.prototype._mutatorKeys,i=El,n=s.indexOf(cs[0]);t.prototype._mutatorKeys=[...s.slice(0,n),...i,...s.slice(n)]}return t});d.register("Sizable",Yr);const rr=N.PDOM_UNIQUE_ID_SEPARATOR;class R{constructor(e){if(assert&&(this.immutable=void 0),e instanceof R){const t=e;this.nodes=t.nodes.slice(0),this.length=t.length,this.uniqueId=t.uniqueId,this.indices=t.indices.slice(0);return}if(this.nodes=[],this.length=0,this.uniqueId="",this.indices=[],e)if(e instanceof D){const t=e;this.addDescendant(t)}else{const t=e.length;for(let s=0;s<t;s++)this.addDescendant(e[s])}}copy(){return new R(this)}isPainted(){return this.lastNode().isPainted()}isValid(){this.reindex();const e=this.indices.length;for(let t=0;t<e;t++)if(this.indices[t]<0)return!1;return!0}isVisible(){let e=this.nodes.length;for(;e--;)if(!this.nodes[e].isVisible())return!1;return!0}isPDOMVisible(){let e=this.nodes.length;for(;e--;)if(!this.nodes[e].isVisible()||!this.nodes[e].isPDOMVisible())return!1;return!0}getOpacity(){let e=1,t=this.nodes.length;for(;t--;)e*=this.nodes[t].getOpacity();return e}isPickable(){return _.some(this.nodes,e=>e.pickable===!1||!e.visible)?!1:!!_.some(this.nodes,e=>e._inputListeners.length>0||e.pickableProperty.value===!0)}get(e){return e>=0?this.nodes[e]:this.nodes[this.nodes.length+e]}slice(e,t){return new R(this.nodes.slice(e,t))}subtrailTo(e,t=!1){return this.slice(0,_.indexOf(this.nodes,e)+(t?0:1))}isEmpty(){return this.nodes.length===0}getMatrixConcatenation(e,t){const s=C.identity(),i=this.nodes;for(let n=e;n<t;n++)s.multiplyMatrix(i[n].getMatrix());return s}getMatrix(){return this.getMatrixConcatenation(0,this.nodes.length)}getAncestorMatrix(){return this.getMatrixConcatenation(1,this.nodes.length)}getParentMatrix(){return this.getMatrixConcatenation(0,this.nodes.length-1)}getAncestorParentMatrix(){return this.getMatrixConcatenation(1,this.nodes.length-1)}getTransform(){return new Bt(this.getMatrix())}getParentTransform(){return new Bt(this.getParentMatrix())}addAncestor(e,t){if(assert&&assert(!this.immutable,"cannot modify an immutable Trail with addAncestor"),assert&&assert(e,"cannot add falsy value to a Trail"),this.nodes.length){const s=this.nodes[0];this.indices.unshift(t===void 0?_.indexOf(e._children,s):t)}return this.nodes.unshift(e),this.length++,this.uniqueId=this.uniqueId?e.id+rr+this.uniqueId:`${e.id}`,this}removeAncestor(){return assert&&assert(!this.immutable,"cannot modify an immutable Trail with removeAncestor"),assert&&assert(this.length>0,"cannot remove a Node from an empty trail"),this.nodes.shift(),this.indices.length&&this.indices.shift(),this.length--,this.updateUniqueId(),this}addDescendant(e,t){if(assert&&assert(!this.immutable,"cannot modify an immutable Trail with addDescendant"),assert&&assert(e,"cannot add falsy value to a Trail"),this.nodes.length){const s=this.lastNode();this.indices.push(t===void 0?_.indexOf(s._children,e):t)}return this.nodes.push(e),this.length++,this.uniqueId=this.uniqueId?this.uniqueId+rr+e.id:`${e.id}`,this}removeDescendant(){return assert&&assert(!this.immutable,"cannot modify an immutable Trail with removeDescendant"),assert&&assert(this.length>0,"cannot remove a Node from an empty trail"),this.nodes.pop(),this.indices.length&&this.indices.pop(),this.length--,this.updateUniqueId(),this}addDescendantTrail(e){const t=e.length;t&&this.addDescendant(e.nodes[0]);for(let s=1;s<t;s++)this.addDescendant(e.nodes[s],this.indices[s-1])}removeDescendantTrail(e){const t=e.length;for(let s=t-1;s>=0;s--)assert&&assert(this.lastNode()===e.nodes[s]),this.removeDescendant()}reindex(){const e=this.length;for(let t=1;t<e;t++){const s=this.indices[t-1],i=this.nodes[t-1];i._children[s]!==this.nodes[t]&&(this.indices[t-1]=_.indexOf(i._children,this.nodes[t]))}}setImmutable(){return assert&&(assert(this.immutable!==!1,"A trail cannot be made immutable after being flagged as mutable"),this.immutable=!0),this}setMutable(){return assert&&(assert(this.immutable!==!0,"A trail cannot be made mutable after being flagged as immutable"),this.immutable=!1),this}areIndicesValid(){for(let e=1;e<this.length;e++){const t=this.indices[e-1];if(this.nodes[e-1]._children[t]!==this.nodes[e])return!1}return!0}equals(e){if(this.length!==e.length)return!1;for(let t=0;t<this.nodes.length;t++)if(this.nodes[t]!==e.nodes[t])return!1;return!0}upToNode(e){const t=_.indexOf(this.nodes,e);return assert&&assert(t>=0,"Trail does not contain the node"),this.slice(0,_.indexOf(this.nodes,e)+1)}isExtensionOf(e,t){if(this.length<=e.length-(t?1:0))return!1;for(let s=0;s<e.nodes.length;s++)if(this.nodes[s]!==e.nodes[s])return!1;return!0}containsNode(e){return _.includes(this.nodes,e)}getTransformTo(e){return new Bt(this.getMatrixTo(e))}getMatrixTo(e){this.reindex(),e.reindex();const t=this.getBranchIndexTo(e);let s,i=C.IDENTITY;for(s=this.length-1;s>=t;s--)i=this.nodes[s].getMatrix().timesMatrix(i);for(s=t;s<e.length;s++)i=e.nodes[s].getTransform().getInverse().timesMatrix(i);return i}getBranchIndexTo(e){assert&&assert(this.nodes[0]===e.nodes[0],"To get a branch index, the trails must have the same root");let t;const s=Math.min(this.length,e.length);for(t=0;t<s&&this.nodes[t]===e.nodes[t];t++);return t}getLastInputEnabledIndex(){let e=-1;for(let t=0;t<this.length&&this.nodes[t].inputEnabled;t++)e=t;return e}getCursorCheckIndex(){return this.getLastInputEnabledIndex()}nodeFromTop(e){return this.nodes[this.length-1-e]}lastNode(){return this.nodeFromTop(0)}rootNode(){return this.nodes[0]}previous(){if(this.nodes.length<=1)return null;const e=this.nodeFromTop(0),t=this.nodeFromTop(1),s=_.indexOf(t._children,e);assert&&assert(s!==-1);const i=this.nodes.slice(0,this.nodes.length-1);if(s===0)return new R(i);for(i.push(t._children[s-1]);i[i.length-1]._children.length!==0;){const n=i[i.length-1];i.push(n._children[n._children.length-1])}return new R(i)}previousPainted(){let e=this.previous();for(;e&&!e.isPainted();)e=e.previous();return e}next(){const e=this.nodes.slice(0),t=this.nodeFromTop(0);if(t._children.length>0)return e.push(t._children[0]),new R(e);{let s=this.nodes.length-1;for(;s>0;){const i=this.nodes[s],n=this.nodes[s-1];e.pop();const a=_.indexOf(n._children,i);if(a!==n._children.length-1)return e.push(n._children[a+1]),new R(e);s--}return null}}nextPainted(){let e=this.next();for(;e&&!e.isPainted();)e=e.next();return e}eachTrailUnder(e){new zt(this,!0).eachTrailBetween(new zt(this,!1),e)}compare(e){assert&&assert(!this.isEmpty(),"cannot compare with an empty trail"),assert&&assert(!e.isEmpty(),"cannot compare with an empty trail"),assert&&assert(this.nodes[0]===e.nodes[0],"for Trail comparison, trails must have the same root node"),assertSlow&&assertSlow(this.areIndicesValid(),`Trail.compare this.areIndicesValid() failed on ${this.toString()}`),assertSlow&&assertSlow(e.areIndicesValid(),`Trail.compare other.areIndicesValid() failed on ${e.toString()}`);const t=Math.min(this.nodes.length,e.nodes.length);for(let s=0;s<t;s++)if(this.nodes[s]!==e.nodes[s])return this.nodes[s-1].children.indexOf(this.nodes[s])<e.nodes[s-1].children.indexOf(e.nodes[s])?-1:1;return this.nodes.length<e.nodes.length?-1:this.nodes.length>e.nodes.length?1:0}isBefore(e){return this.compare(e)===-1}isAfter(e){return this.compare(e)===1}localToGlobalPoint(e){return this.getMatrix().timesVector2(e)}localToGlobalBounds(e){return e.transformed(this.getMatrix())}globalToLocalPoint(e){return this.getTransform().inversePosition2(e)}globalToLocalBounds(e){return this.getTransform().inverseBounds2(e)}parentToGlobalPoint(e){return this.getParentMatrix().timesVector2(e)}parentToGlobalBounds(e){return e.transformed(this.getParentMatrix())}globalToParentPoint(e){return this.getParentTransform().inversePosition2(e)}globalToParentBounds(e){return this.getParentTransform().inverseBounds2(e)}updateUniqueId(){let e="";const t=this.nodes.length;t>0&&(e+=this.nodes[0]._id);for(let s=1;s<t;s++)e+=rr+this.nodes[s]._id;this.uniqueId=e}getUniqueId(){if(assert){const e=this.uniqueId;this.updateUniqueId(),assert(e===this.uniqueId)}return this.uniqueId}toString(){return this.reindex(),this.length?`[Trail ${this.indices.join(".")} ${this.getUniqueId()}]`:"Empty Trail"}toPathString(){return _.map(this.nodes,e=>{let t=e.constructor.name;return t==="Node"&&(t="."),t}).join("/")}toDebugString(){return`${this.toString()} ${this.toPathString()}`}static eachPaintedTrailBetween(e,t,s,i,n){R.eachTrailBetween(e,t,a=>a.isPainted()?s(a):!1,i,n)}static eachTrailBetween(e,t,s,i,n){const a=e?new zt(e.copy(),!0):new zt(new R(n),!0),o=t?new zt(t.copy(),!0):new zt(new R(n),!1);i&&(a.nestedForwards(),o.nestedBackwards(),a.compareNested(o)===1)||a.depthFirstUntil(o,h=>h.isBefore?s(h.trail):!1,!1)}static branchIndex(e,t){assert&&assert(e.nodes[0]===t.nodes[0],"Branch changes require roots to be the same");let s;const i=Math.min(e.length,t.length);for(s=0;s<i&&e.nodes[s]===t.nodes[s];s++);return s}static sharedTrail(e,t){return e.slice(0,R.branchIndex(e,t))}static appendAncestorTrailsWithPredicate(e,t,s){const i=t.rootNode();s(i)&&e.push(t.copy());const n=i._parents.length;for(let a=0;a<n;a++){const o=i._parents[a];t.addAncestor(o),R.appendAncestorTrailsWithPredicate(e,t,s),t.removeAncestor()}}static appendDescendantTrailsWithPredicate(e,t,s){const i=t.lastNode();s(i)&&e.push(t.copy());const n=i._children.length;for(let a=0;a<n;a++){const o=i._children[a];t.addDescendant(o,a),R.appendDescendantTrailsWithPredicate(e,t,s),t.removeDescendant()}}static spannedSubtrees(e,t){}static fromUniqueId(e,t){const i=t.split(rr).map(h=>Number(h));let n=e;const a=i.shift(),o=[n];for(assert&&assert(a===e.id);i.length>0;){const h=i.shift(),c=(n.pdomOrder||[]).concat(n.children);for(let u=0;u<c.length;u++){if(c[u]!==null&&c[u].id===h){const m=c[u];o.push(m),n=m;break}assert&&assert(u!==c.length-1,"unable to find node from unique Trail id")}}return new R(o)}}d.register("Trail",R);class zt{constructor(e,t){this.trail=e,this.setBefore(t)}isActive(){return!!this.trail}copy(){return assert&&assert(this.isActive()),new zt(this.trail.copy(),this.isBefore)}setBefore(e){this.isBefore=e,this.isAfter=!e}getRenderSwappedPointer(){assert&&assert(this.isActive());const e=this,t=this.isBefore?e.trail.previous():e.trail.next();return t===null?null:new zt(t,!this.isBefore)}getRenderBeforePointer(){return this.isBefore?this:this.getRenderSwappedPointer()}getRenderAfterPointer(){return this.isAfter?this:this.getRenderSwappedPointer()}compareRender(e){assert&&assert(e!==null);const t=this.getRenderBeforePointer(),s=e.getRenderBeforePointer();return t!==null&&s!==null?(assert&&assert(t.isActive()&&s.isActive()),t.trail.compare(s.trail)):t===s?0:t===null?1:-1}compareNested(e){assert&&assert(e),assert&&assert(this.isActive()&&e.isActive());const t=this,s=e,i=t.trail.compare(s.trail);return i===0?this.isBefore===e.isBefore?0:this.isBefore?-1:1:t.trail.isExtensionOf(s.trail)?e.isBefore?1:-1:s.trail.isExtensionOf(t.trail)?this.isBefore?-1:1:i}equalsRender(e){return this.compareRender(e)===0}equalsNested(e){return this.compareNested(e)===0}hasTrail(){return!!this.trail}nestedForwards(){assert&&assert(this.isActive());const e=this;if(this.isBefore){const t=e.trail.lastNode()._children;t.length>0?e.trail.addDescendant(t[0],0):this.setBefore(!1)}else{if(e.trail.indices.length===0)return this.trail=null,null;{const t=e.trail.indices[e.trail.indices.length-1];e.trail.removeDescendant();const s=e.trail.lastNode()._children;s.length>t+1&&(e.trail.addDescendant(s[t+1],t+1),this.setBefore(!0))}}return this}nestedBackwards(){assert&&assert(this.isActive());const e=this;if(this.isBefore){if(e.trail.indices.length===0)return this.trail=null,null;{const t=e.trail.indices[e.trail.indices.length-1];e.trail.removeDescendant(),t-1>=0&&(e.trail.addDescendant(e.trail.lastNode()._children[t-1],t-1),this.setBefore(!1))}}else if(e.trail.lastNode()._children.length>0){const t=e.trail.lastNode()._children;e.trail.addDescendant(t[t.length-1],t.length-1)}else this.setBefore(!0);return this}eachNodeBetween(e,t){this.eachTrailBetween(e,s=>t(s.lastNode()))}eachTrailBetween(e,t){this.isBefore&&(assert&&assert(this.isActive()),t(this.trail)),this.depthFirstUntil(e,s=>s.isBefore?t(s.trail):!1,!0)}depthFirstUntil(e,t,s){assert&&assert(this.isActive()&&e.isActive());const i=this,n=e;assert&&assert(this.compareNested(e)<=(s?-1:0),"TrailPointer.depthFirstUntil pointers out of order, possibly in both meanings of the phrase!"),assert&&assert(i.trail.rootNode()===n.trail.rootNode(),"TrailPointer.depthFirstUntil takes pointers with the same root"),i.trail.reindex(),n.trail.reindex();const a=this.copy();a.trail.setMutable();let o=!0;for(;!a.equalsNested(e);){assert&&assert(a.compareNested(e)!==1,"skipped in depthFirstUntil");let h=!1;if(o?(s||(h=t(a)),o=!1):h=t(a),h&&a.isBefore){if(a.setBefore(!1),a.compareNested(e)===1)break}else a.nestedForwards()}s||t(a)}toString(){return assert&&assert(this.isActive()),`[${this.isBefore?"before":"after"} ${this.trail.toString().slice(1)}`}static compareNested(e,t,s,i){const n=e.compare(s);return n===0?t===i?0:t?-1:1:e.isExtensionOf(s)?i?1:-1:s.isExtensionOf(e)?t?-1:1:n}}d.register("TrailPointer",zt);const Mg=(r,e)=>r.size===e.size&&_.every([...r],t=>e.has(t));class _o extends X{constructor(e){super(new Set),this.node=e,this.listenedNodeSet=new Set,this.updateEmitter=new re,this.valueComparisonStrategy=Mg,this._nodeUpdateListener=this.update.bind(this),this.addNodeListener(e),this.update()}update(){const e=new Set;(function t(s){s.parents.forEach(n=>{e.add(n),t(n)})})(this.node),e.forEach(t=>{this.listenedNodeSet.has(t)||this.addNodeListener(t)}),this.listenedNodeSet.forEach(t=>{!e.has(t)&&t!==this.node&&this.removeNodeListener(t)}),this.value=e,this.updateEmitter.emit()}addNodeListener(e){this.listenedNodeSet.add(e),e.parentAddedEmitter.addListener(this._nodeUpdateListener),e.parentRemovedEmitter.addListener(this._nodeUpdateListener)}removeNodeListener(e){this.listenedNodeSet.delete(e),e.parentAddedEmitter.removeListener(this._nodeUpdateListener),e.parentRemovedEmitter.removeListener(this._nodeUpdateListener)}dispose(){this.listenedNodeSet.forEach(e=>this.removeNodeListener(e)),super.dispose()}}d.register("AncestorNodesProperty",_o);class Wd extends X{constructor(e,t){super([]),this.listenedNodeSet=new Set,this.rootNode=e,this.leafNode=t,this._trailUpdateListener=this.update.bind(this),this.update()}update(){const e=[],t=new Set,s=new R(this.leafNode),i=this.rootNode;(function o(){const h=s.rootNode();t.add(h),h===i&&e.push(s.copy()),h.parents.forEach(l=>{s.addAncestor(l),o(),s.removeAncestor()})})(),t.forEach(o=>{this.listenedNodeSet.has(o)||this.addNodeListener(o)}),this.listenedNodeSet.forEach(o=>{t.has(o)||this.removeNodeListener(o)});const n=this.value;let a=n.length===e.length;if(a){for(let o=0;o<e.length;o++)if(!n[o].equals(e[o])){a=!1;break}}a||(this.value=e)}addNodeListener(e){this.listenedNodeSet.add(e),e.parentAddedEmitter.addListener(this._trailUpdateListener),e.parentRemovedEmitter.addListener(this._trailUpdateListener)}removeNodeListener(e){this.listenedNodeSet.delete(e),e.parentAddedEmitter.removeListener(this._trailUpdateListener),e.parentRemovedEmitter.removeListener(this._trailUpdateListener)}dispose(){this.listenedNodeSet.forEach(e=>this.removeNodeListener(e)),super.dispose()}}d.register("TrailsBetweenProperty",Wd);class Rg extends X{constructor(e,t,s){const i=E()({fromCoordinateFrame:"local",toCoordinateFrame:"local"},s);super(C.IDENTITY),this.from=e,this.to=t,this.rootNode=null,this.fromTrail=null,this.toTrail=null,this.listenedNodeSet=new Set,this.fromCoordinateFrame=i.fromCoordinateFrame,this.toCoordinateFrame=i.toCoordinateFrame,this.valueComparisonStrategy="equalsFunction",this.fromAncestorsProperty=new _o(e),this.toAncestorsProperty=new _o(t);const n=this.update.bind(this);this._nodeTransformListener=this.updateMatrix.bind(this),this.fromAncestorsProperty.updateEmitter.addListener(n),this.toAncestorsProperty.updateEmitter.addListener(n),this.update()}update(){const e=[...this.fromAncestorsProperty.value,this.from],t=[...this.toAncestorsProperty.value,this.to],s=e.filter(o=>t.includes(o));let i=!1;const n=s.filter(o=>{const h=e.filter(v=>o.hasChild(v)),l=t.filter(v=>o.hasChild(v)),c=[],u=[];qs(h,l,c,u,[]);const b=h.length>1||l.length>1,y=c.length||u.length;b&&y&&(i=!0);const f=c.length>0||this.from===o,L=u.length>0||this.to===o;return f&&L});!i&&n.length===1?(this.rootNode=n[0],this.fromTrail=this.from.getUniqueTrailTo(this.rootNode),this.toTrail=this.to.getUniqueTrailTo(this.rootNode)):(this.rootNode=null,this.fromTrail=null,this.toTrail=null);const a=new Set;this.fromTrail&&this.fromTrail.nodes.forEach(o=>a.add(o)),this.toTrail&&this.toTrail.nodes.forEach(o=>a.add(o)),a.forEach(o=>{this.listenedNodeSet.has(o)||this.addNodeListener(o)}),this.listenedNodeSet.forEach(o=>{!a.has(o)&&o!==this.from&&o!==this.to&&this.removeNodeListener(o)}),this.updateMatrix()}updateMatrix(){if(this.rootNode&&this.fromTrail&&this.toTrail){const e=this.fromTrail.nodes.length===1,t=this.toTrail.nodes.length===1,s=e&&this.fromCoordinateFrame==="parent"||t&&this.toCoordinateFrame==="parent",i=this.fromTrail.getMatrixConcatenation(s?0:1,this.fromTrail.nodes.length-(this.fromCoordinateFrame==="parent"?1:0)),n=this.toTrail.getMatrixConcatenation(s?0:1,this.toTrail.nodes.length-(this.toCoordinateFrame==="parent"?1:0));this.value=n.inverted().timesMatrix(i)}else this.value=null}addNodeListener(e){this.listenedNodeSet.add(e),e.transformEmitter.addListener(this._nodeTransformListener)}removeNodeListener(e){this.listenedNodeSet.delete(e),e.transformEmitter.removeListener(this._nodeTransformListener)}dispose(){this.fromAncestorsProperty.dispose(),this.toAncestorsProperty.dispose(),super.dispose()}}d.register("MatrixBetweenProperty",Rg);const Ng=Te.safari5,$d=["fill","fillPickable","stroke","strokePickable","lineWidth","lineCap","lineJoin","miterLimit","lineDash","lineDashOffset","cachedPaints"],Cs={fill:null,fillPickable:!0,stroke:null,strokePickable:!1,lineWidth:Wi.lineWidth,lineCap:Wi.lineCap,lineJoin:Wi.lineJoin,lineDashOffset:Wi.lineDashOffset,miterLimit:Wi.miterLimit},Ud=["fill","stroke","lineWidth","lineOptions","cachedPaints"],Kr=Me(r=>(assert&&assert(_.includes(ct(r),D),"Only Node subtypes should mix Paintable"),class extends r{constructor(...t){super(...t),vp(this,["_drawables"]),this._fill=Cs.fill,this._fillPickable=Cs.fillPickable,this._stroke=Cs.stroke,this._strokePickable=Cs.strokePickable,this._cachedPaints=[],this._lineDrawingStyles=new sl}setFill(t){return assert&&assert(hs.isPaintDef(t),"Invalid fill type"),assert&&typeof t=="string"&&P.checkPaintString(t),this._fill!==t&&(this._fill=t,this.invalidateFill()),this}set fill(t){this.setFill(t)}get fill(){return this.getFill()}getFill(){return this._fill}hasFill(){return this.getFillValue()!==null}getFillValue(){const t=this.getFill();return O(t)?t.get():t}get fillValue(){return this.getFillValue()}setStroke(t){if(assert&&assert(hs.isPaintDef(t),"Invalid stroke type"),assert&&typeof t=="string"&&P.checkPaintString(t),this._stroke!==t){if(this._stroke=t,assert&&t instanceof wt&&t.transformMatrix){const s=t.transformMatrix.getScaleVector();assert(Math.abs(s.x-s.y)<1e-7,"You cannot specify a pattern or gradient to a stroke that does not have a symmetric scale.")}this.invalidateStroke()}return this}set stroke(t){this.setStroke(t)}get stroke(){return this.getStroke()}getStroke(){return this._stroke}hasStroke(){return this.getStrokeValue()!==null}hasPaintableStroke(){return this.hasStroke()&&this.getLineWidth()>0}getStrokeValue(){const t=this.getStroke();return O(t)?t.get():t}get strokeValue(){return this.getStrokeValue()}setFillPickable(t){return this._fillPickable!==t&&(this._fillPickable=t,this.invalidateFill()),this}set fillPickable(t){this.setFillPickable(t)}get fillPickable(){return this.isFillPickable()}isFillPickable(){return this._fillPickable}setStrokePickable(t){return this._strokePickable!==t&&(this._strokePickable=t,this.invalidateStroke()),this}set strokePickable(t){this.setStrokePickable(t)}get strokePickable(){return this.isStrokePickable()}isStrokePickable(){return this._strokePickable}setLineWidth(t){if(assert&&assert(t>=0,`lineWidth should be non-negative instead of ${t}`),this.getLineWidth()!==t){this._lineDrawingStyles.lineWidth=t,this.invalidateStroke();const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyLineWidth()}return this}set lineWidth(t){this.setLineWidth(t)}get lineWidth(){return this.getLineWidth()}getLineWidth(){return this._lineDrawingStyles.lineWidth}setLineCap(t){if(assert&&assert(t==="butt"||t==="round"||t==="square",`lineCap should be one of "butt", "round" or "square", not ${t}`),this._lineDrawingStyles.lineCap!==t){this._lineDrawingStyles.lineCap=t,this.invalidateStroke();const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyLineOptions()}return this}set lineCap(t){this.setLineCap(t)}get lineCap(){return this.getLineCap()}getLineCap(){return this._lineDrawingStyles.lineCap}setLineJoin(t){if(assert&&assert(t==="miter"||t==="round"||t==="bevel",`lineJoin should be one of "miter", "round" or "bevel", not ${t}`),this._lineDrawingStyles.lineJoin!==t){this._lineDrawingStyles.lineJoin=t,this.invalidateStroke();const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyLineOptions()}return this}set lineJoin(t){this.setLineJoin(t)}get lineJoin(){return this.getLineJoin()}getLineJoin(){return this._lineDrawingStyles.lineJoin}setMiterLimit(t){if(assert&&assert(isFinite(t),"miterLimit should be a finite number"),this._lineDrawingStyles.miterLimit!==t){this._lineDrawingStyles.miterLimit=t,this.invalidateStroke();const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyLineOptions()}return this}set miterLimit(t){this.setMiterLimit(t)}get miterLimit(){return this.getMiterLimit()}getMiterLimit(){return this._lineDrawingStyles.miterLimit}setLineDash(t){if(assert&&assert(Array.isArray(t)&&t.every(s=>typeof s=="number"&&isFinite(s)&&s>=0),"lineDash should be an array of finite non-negative numbers"),this._lineDrawingStyles.lineDash!==t){this._lineDrawingStyles.lineDash=t||[],this.invalidateStroke();const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyLineOptions()}return this}set lineDash(t){this.setLineDash(t)}get lineDash(){return this.getLineDash()}getLineDash(){return this._lineDrawingStyles.lineDash}hasLineDash(){return!!this._lineDrawingStyles.lineDash.length}setLineDashOffset(t){if(assert&&assert(isFinite(t),`lineDashOffset should be a number, not ${t}`),this._lineDrawingStyles.lineDashOffset!==t){this._lineDrawingStyles.lineDashOffset=t,this.invalidateStroke();const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyLineOptions()}return this}set lineDashOffset(t){this.setLineDashOffset(t)}get lineDashOffset(){return this.getLineDashOffset()}getLineDashOffset(){return this._lineDrawingStyles.lineDashOffset}setLineStyles(t){return this._lineDrawingStyles=t,this.invalidateStroke(),this}set lineStyles(t){this.setLineStyles(t)}get lineStyles(){return this.getLineStyles()}getLineStyles(){return this._lineDrawingStyles}setCachedPaints(t){this._cachedPaints=t.filter(i=>i instanceof wt);const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyCachedPaints();return this}set cachedPaints(t){this.setCachedPaints(t)}get cachedPaints(){return this.getCachedPaints()}getCachedPaints(){return this._cachedPaints}addCachedPaint(t){if(t instanceof wt){this._cachedPaints.push(t);const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyCachedPaints()}}removeCachedPaint(t){if(t instanceof wt){assert&&assert(_.includes(this._cachedPaints,t)),Tt(this._cachedPaints,t);const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyCachedPaints()}}beforeCanvasFill(t){assert&&assert(this.getFillValue()!==null);const s=this.getFillValue();t.setFillStyle(s),s.transformMatrix&&(t.context.save(),s.transformMatrix.canvasAppendTransform(t.context))}afterCanvasFill(t){this.getFillValue().transformMatrix&&t.context.restore()}beforeCanvasStroke(t){const s=this.getStrokeValue();if(t.setStrokeStyle(this._stroke),t.setLineCap(this.getLineCap()),t.setLineJoin(this.getLineJoin()),s.transformMatrix){const i=s.transformMatrix.getScaleVector();assert&&assert(Math.abs(i.x-i.y)<1e-7,"You cannot specify a pattern or gradient to a stroke that does not have a symmetric scale.");const n=1/i.x;t.context.save(),s.transformMatrix.canvasAppendTransform(t.context),t.setLineWidth(this.getLineWidth()*n),t.setMiterLimit(this.getMiterLimit()*n),t.setLineDash(this.getLineDash().map(a=>a*n)),t.setLineDashOffset(this.getLineDashOffset()*n)}else t.setLineWidth(this.getLineWidth()),t.setMiterLimit(this.getMiterLimit()),t.setLineDash(this.getLineDash()),t.setLineDashOffset(this.getLineDashOffset())}afterCanvasStroke(t){this.getStrokeValue().transformMatrix&&t.context.restore()}getCSSFill(){const t=this.getFillValue();return t?t.toCSS?t.toCSS():t:"transparent"}getSimpleCSSStroke(){const t=this.getStrokeValue();return t?t.toCSS?t.toCSS():t:"transparent"}appendFillablePropString(t,s){return this._fill&&(s&&(s+=`,
`),typeof this.getFillValue()=="string"?s+=`${t}fill: '${this.getFillValue()}'`:s+=`${t}fill: ${this.getFillValue()}`),s}appendStrokablePropString(t,s){function i(n,a,o){s&&(s+=`,
`),!o&&typeof a=="string"?s+=`${t+n}: '${a}'`:s+=`${t+n}: ${a}`}if(this._stroke){const n=new sl,a=this.getStrokeValue();typeof a=="string"?i("stroke",a):i("stroke",a?a.toString():"null",!0),_.each(["lineWidth","lineCap","miterLimit","lineJoin","lineDashOffset"],o=>{this[o]!==n[o]&&i(o,this[o])}),this.lineDash.length&&i("lineDash",JSON.stringify(this.lineDash),!0)}return s}getFillRendererBitmask(){let t=0;return Ng&&this._fill instanceof st||(t|=p.bitmaskSVG),t|=p.bitmaskCanvas,this.hasFill()&&(this._fill instanceof Ms||this._fill instanceof st)||(t|=p.bitmaskDOM,t|=p.bitmaskWebGL),t}getStrokeRendererBitmask(){let t=0;return t|=p.bitmaskCanvas,t|=p.bitmaskSVG,this.hasStroke()||(t|=p.bitmaskDOM,t|=p.bitmaskWebGL),t}invalidateFill(){this.invalidateSupportedRenderers();const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyFill()}invalidateStroke(){this.invalidateSupportedRenderers();const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyStroke()}}));d.register("Paintable",Kr);Kr.DEFAULT_OPTIONS=Cs;const Bg=Math.log2||function(r){return Math.log(r)/Math.LN2},ss={imageOpacity:1,initialWidth:0,initialHeight:0,mipmap:!1,mipmapBias:0,mipmapInitialLevel:4,mipmapMaxLevel:5,hitTestPixels:!1};let Da=null,Ta=null;const Yd=()=>(Da||(Da=document.createElement("canvas")),Da),Fg=()=>(Ta||(Ta=Yd().getContext("2d",{willReadFrequently:!0})),Ta),Ct=r=>class extends r{constructor(...t){super(...t),this._imageProperty=new Ut(null,!1,this.onImagePropertyChange.bind(this)),this._image=null,this._initialWidth=ss.initialWidth,this._initialHeight=ss.initialHeight,this._imageOpacity=ss.imageOpacity,this._mipmap=ss.mipmap,this._mipmapBias=ss.mipmapBias,this._mipmapInitialLevel=ss.mipmapInitialLevel,this._mipmapMaxLevel=ss.mipmapMaxLevel,this._hitTestPixels=ss.hitTestPixels,this._mipmapCanvases=[],this._mipmapURLs=[],this._mipmapData=null,this._imageLoadListener=this._onImageLoad.bind(this),this._imageLoadListenerAttached=!1,this._hitTestImageData=null,this.mipmapEmitter=new re}setImage(t){return assert&&assert(t,"image should be available"),this._imageProperty.value=t,this}set image(t){this.setImage(t)}get image(){return this.getImage()}getImage(){return assert&&assert(this._image!==null),this._image}onImagePropertyChange(t){assert&&assert(t,"image should be available");let s=this._image!==t;if(s&&typeof t=="string"&&this._image&&this._image instanceof HTMLImageElement&&t===this._image.src&&(s=!1),s&&t===this._mipmapData&&(s=!1),s){if(this._initialWidth=0,this._initialHeight=0,this._image&&this._imageLoadListenerAttached&&this._detachImageLoadListener(),this._mipmapData=null,typeof t=="string"){const i=t;t=document.createElement("img"),t.src=i}else Array.isArray(t)&&(this._mipmapData=t,t=t[0].img,this._mipmapInitialLevel=this._mipmapMaxLevel=this._mipmapData.length,this._mipmap=!0);this._image=t,this._image instanceof HTMLImageElement&&(!this._image.width||!this._image.height)&&this._attachImageLoadListener(),this.invalidateImage()}}setImageProperty(t){return this._imageProperty.setTargetProperty(t)}set imageProperty(t){this.setImageProperty(t)}get imageProperty(){return this.getImageProperty()}getImageProperty(){return this._imageProperty}invalidateImage(){this.invalidateMipmaps(),this._invalidateHitTestData()}setImageWithSize(t,s,i){return this.setImage(t),this.setInitialWidth(s),this.setInitialHeight(i),this}setImageOpacity(t){assert&&assert(isFinite(t)&&t>=0&&t<=1,`imageOpacity out of range: ${t}`),this._imageOpacity!==t&&(this._imageOpacity=t)}set imageOpacity(t){this.setImageOpacity(t)}get imageOpacity(){return this.getImageOpacity()}getImageOpacity(){return this._imageOpacity}setInitialWidth(t){return assert&&assert(t>=0&&t%1===0,"initialWidth should be a non-negative integer"),t!==this._initialWidth&&(this._initialWidth=t,this.invalidateImage()),this}set initialWidth(t){this.setInitialWidth(t)}get initialWidth(){return this.getInitialWidth()}getInitialWidth(){return this._initialWidth}setInitialHeight(t){return assert&&assert(t>=0&&t%1===0,"initialHeight should be a non-negative integer"),t!==this._initialHeight&&(this._initialHeight=t,this.invalidateImage()),this}set initialHeight(t){this.setInitialHeight(t)}get initialHeight(){return this.getInitialHeight()}getInitialHeight(){return this._initialHeight}setMipmap(t){return this._mipmap!==t&&(this._mipmap=t,this.invalidateMipmaps()),this}set mipmap(t){this.setMipmap(t)}get mipmap(){return this.isMipmap()}isMipmap(){return this._mipmap}setMipmapBias(t){return this._mipmapBias!==t&&(this._mipmapBias=t,this.invalidateMipmaps()),this}set mipmapBias(t){this.setMipmapBias(t)}get mipmapBias(){return this.getMipmapBias()}getMipmapBias(){return this._mipmapBias}setMipmapInitialLevel(t){return assert&&assert(t%1===0&&t>=0,"mipmapInitialLevel should be a non-negative integer"),this._mipmapInitialLevel!==t&&(this._mipmapInitialLevel=t,this.invalidateMipmaps()),this}set mipmapInitialLevel(t){this.setMipmapInitialLevel(t)}get mipmapInitialLevel(){return this.getMipmapInitialLevel()}getMipmapInitialLevel(){return this._mipmapInitialLevel}setMipmapMaxLevel(t){return assert&&assert(t%1===0&&t>=0,"mipmapMaxLevel should be a non-negative integer"),this._mipmapMaxLevel!==t&&(this._mipmapMaxLevel=t,this.invalidateMipmaps()),this}set mipmapMaxLevel(t){this.setMipmapMaxLevel(t)}get mipmapMaxLevel(){return this.getMipmapMaxLevel()}getMipmapMaxLevel(){return this._mipmapMaxLevel}setHitTestPixels(t){return this._hitTestPixels!==t&&(this._hitTestPixels=t,this._invalidateHitTestData()),this}set hitTestPixels(t){this.setHitTestPixels(t)}get hitTestPixels(){return this.getHitTestPixels()}getHitTestPixels(){return this._hitTestPixels}_constructNextMipmap(){const t=this._mipmapCanvases.length,s=this._mipmapCanvases[t-1];if(s.width*s.height>2){const i=document.createElement("canvas");if(i.width=Math.ceil(s.width/2),i.height=Math.ceil(s.height/2),i.width>0&&i.height>0){const n=i.getContext("2d");n.scale(.5,.5),n.drawImage(s,0,0),this._mipmapCanvases.push(i),this._mipmapURLs.push(i.toDataURL())}}}invalidateMipmaps(){if(ee(this._mipmapCanvases),ee(this._mipmapURLs),this._image&&this._mipmap)if(this._mipmapData)for(let t=0;t<this._mipmapData.length;t++){const s=this._mipmapData[t].url;this._mipmapURLs.push(s);const i=this._mipmapData[t].updateCanvas;i&&i(),this._mipmapCanvases.push(this._mipmapData[t].canvas)}else{const t=document.createElement("canvas");if(t.width=this.getImageWidth(),t.height=this.getImageHeight(),t.width&&t.height){t.getContext("2d").drawImage(this._image,0,0),this._mipmapCanvases.push(t),this._mipmapURLs.push(t.toDataURL());let i=0;for(;++i<this._mipmapInitialLevel;)this._constructNextMipmap()}}this.mipmapEmitter.emit()}getMipmapLevel(t,s=0){assert&&assert(this._mipmap,"Assumes mipmaps can be used");const i=Ct.getApproximateMatrixScale(t)*(window.devicePixelRatio||1);return this.getMipmapLevelFromScale(i,s)}getMipmapLevelFromScale(t,s=0){if(assert&&assert(t>0,"scale should be a positive number"),t>=1)return 0;let i=Bg(1/t);if(i=Ve.roundSymmetric(i+this._mipmapBias+s-.7),i<0&&(i=0),i>this._mipmapMaxLevel&&(i=this._mipmapMaxLevel),this.mipmap&&!this._mipmapCanvases[i]){let n=this._mipmapCanvases.length-1;for(;++n<=i;)this._constructNextMipmap();return Math.min(i,this._mipmapCanvases.length-1)}else return i}getMipmapCanvas(t){if(assert&&assert(t>=0&&t<this._mipmapCanvases.length&&t%1===0),this._mipmapData){const s=this._mipmapData[t]&&this._mipmapData[t].updateCanvas;s&&s()}return this._mipmapCanvases[t]}getMipmapURL(t){return assert&&assert(t>=0&&t<this._mipmapCanvases.length&&t%1===0),this._mipmapURLs[t]}hasMipmaps(){return this._mipmapCanvases.length>0}_invalidateHitTestData(){this._hitTestPixels&&this._image!==null&&(this._hitTestImageData=Ct.getHitTestData(this._image,this.imageWidth,this.imageHeight))}getImageWidth(){if(this._image===null)return 0;const t=this._mipmapData?this._mipmapData[0].width:("naturalWidth"in this._image?this._image.naturalWidth:0)||this._image.width;return t===0?this._initialWidth:(assert&&assert(this._initialWidth===0||this._initialWidth===t,"Bad Image.initialWidth"),t)}get imageWidth(){return this.getImageWidth()}getImageHeight(){if(this._image===null)return 0;const t=this._mipmapData?this._mipmapData[0].height:("naturalHeight"in this._image?this._image.naturalHeight:0)||this._image.height;return t===0?this._initialHeight:(assert&&assert(this._initialHeight===0||this._initialHeight===t,"Bad Image.initialHeight"),t)}get imageHeight(){return this.getImageHeight()}getImageURL(){return assert&&assert(this._image instanceof HTMLImageElement,"Only supported for HTML image elements"),this._image.src}_attachImageLoadListener(){assert&&assert(!this._imageLoadListenerAttached,"Should only be attached to one thing at a time"),this.isDisposed||(this._image.addEventListener("load",this._imageLoadListener),this._imageLoadListenerAttached=!0)}_detachImageLoadListener(){assert&&assert(this._imageLoadListenerAttached,"Needs to be attached first to be detached."),this._image.removeEventListener("load",this._imageLoadListener),this._imageLoadListenerAttached=!1}_onImageLoad(){assert&&assert(this._imageLoadListenerAttached,"If _onImageLoad is firing, it should be attached"),this.invalidateImage(),this._detachImageLoadListener()}dispose(){this._image&&this._imageLoadListenerAttached&&this._detachImageLoadListener(),this._imageProperty.dispose(),super.dispose&&super.dispose()}};Ct.getHitTestData=(r,e,t)=>{if(!("naturalWidth"in r&&r.naturalWidth||r.width)||!("naturalHeight"in r&&r.naturalHeight||r.height))return null;const s=Yd(),i=Fg();return s.width=e,s.height=t,i.drawImage(r,0,0),i.getImageData(0,0,e,t)};Ct.testHitTestData=(r,e,t,s)=>{const i=Ve.clamp(Math.floor(s.x/e*r.width),0,r.width-1),n=Ve.clamp(Math.floor(s.y/t*r.height),0,r.height-1),a=4*(i+n*r.width)+3;return r.data[a]!==0};Ct.hitTestDataToShape=(r,e,t)=>{const s=e/r.width,i=t/r.height,n=new H;let a=!1,o=0;for(let h=0;h<r.height;h++){for(let l=0;l<r.width;l++){const c=4*(l+h*r.width)+3;r.data[c]!==0?a||(a=!0,o=l):a&&(a=!1,n.rect(o*s,h*s,s*(l-o),i))}a&&(a=!1,n.rect(o*s,h*s,s*(r.width-o),i))}return n.getSimplifiedAreaShape()};Ct.createSVGImage=(r,e,t)=>{assert&&assert(isFinite(e)&&e>=0&&e%1===0,"width should be a non-negative finite integer"),assert&&assert(isFinite(t)&&t>=0&&t%1===0,"height should be a non-negative finite integer");const s=document.createElementNS(ne,"image");return s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("width",`${e}px`),s.setAttribute("height",`${t}px`),s.setAttributeNS(vi,"xlink:href",r),s};Ct.createFastMipmapFromCanvas=r=>{const e=[],t=r.toDataURL(),s=new window.Image;s.src=t,e.push({img:s,url:t,width:r.width,height:r.height,canvas:r});let i=r;for(;i.width>=2&&i.height>=2;){const n=document.createElement("canvas");n.width=Math.ceil(i.width/2),n.height=Math.ceil(i.height/2);const a=n.getContext("2d");a.setTransform(.5,0,0,.5,0,0),a.drawImage(i,0,0);const o={width:n.width,height:n.height,canvas:n,url:n.toDataURL(),img:new window.Image};o.img.src=o.url,i=n,e.push(o)}return e};Ct.getApproximateMatrixScale=r=>(Math.sqrt(r.m00()*r.m00()+r.m10()*r.m10())+Math.sqrt(r.m01()*r.m01()+r.m11()*r.m11()))/2;Ct.CANVAS_MIPMAP_BIAS_ADJUSTMENT=.5;Ct.DEFAULT_OPTIONS=ss;d.register("Imageable",Ct);const ht=Ct,Kd=(r,e,t)=>{const s=`_${r}PendingOptions`,i=`_${r}IsConstructed`;return class extends t{constructor(...a){super(...a),this[i]=!0,this.mutate(this[s]),this[s]=void 0}mutate(a){return a&&!this[i]&&(this[s]=pe(this[s]||{},_.pick(a,e)),a=_.omit(a,e)),super.mutate(a)}}};d.register("DelayedMutate",Kd);const Bi=Kd,Hg=["image","imageProperty","imageOpacity","imageBounds","initialWidth","initialHeight","mipmap","mipmapBias","mipmapInitialLevel","mipmapMaxLevel","hitTestPixels"],Kh=class Kh extends ht(D){constructor(e,t){const s={};O(e)?s.imageProperty=e:s.image=e;const i=E()(s,t);super(),this._imageBounds=null,this.mutate(i),this.invalidateSupportedRenderers()}invalidateImage(){this._image?this.invalidateSelf(this._imageBounds||new w(0,0,this.getImageWidth(),this.getImageHeight())):this.invalidateSelf(w.NOTHING);const e=this._drawables.length;for(let t=0;t<e;t++)this._drawables[t].markDirtyImage();super.invalidateImage(),this.invalidateSupportedRenderers()}invalidateSupportedRenderers(){let e=p.bitmaskCanvas;this.getImageWidth()<=Os.MAX_DIMENSION.width&&this.getImageHeight()<=Os.MAX_DIMENSION.height&&(e|=p.bitmaskWebGL),this._image instanceof HTMLCanvasElement||(e|=p.bitmaskSVG|p.bitmaskDOM),this.setRendererBitmask(e)}setImageOpacity(e){const t=this._imageOpacity!==e;if(super.setImageOpacity(e),t){const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyImageOpacity()}}setImageBounds(e){this._imageBounds!==e&&(this._imageBounds=e,this.invalidateImage())}set imageBounds(e){this.setImageBounds(e)}get imageBounds(){return this._imageBounds}getImageBounds(){return this._imageBounds}isPainted(){return!0}canvasPaintSelf(e,t){Tc.prototype.paintCanvas(e,this,t)}createDOMDrawable(e,t){return my.createFromPool(e,t)}createSVGDrawable(e,t){return yy.createFromPool(e,t)}createCanvasDrawable(e,t){return Tc.createFromPool(e,t)}createWebGLDrawable(e,t){return by.createFromPool(e,t)}containsPointSelf(e){const t=D.prototype.containsPointSelf.call(this,e);return!t||!this._hitTestPixels||!this._hitTestImageData?t:ht.testHitTestData(this._hitTestImageData,this.imageWidth,this.imageHeight,e)}getSelfShape(){return this._hitTestPixels&&this._hitTestImageData?ht.hitTestDataToShape(this._hitTestImageData,this.imageWidth,this.imageHeight):D.prototype.getSelfShape.call(this)}invalidateMipmaps(){const e=this._image&&this._mipmap&&!this._mipmapData;if(super.invalidateMipmaps(),e){const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyMipmap()}}mutate(e){return super.mutate(e)}};Kh.DEFAULT_IMAGE_OPTIONS=pe({},D.DEFAULT_NODE_OPTIONS,ht.DEFAULT_OPTIONS);let $e=Kh;$e.prototype._mutatorKeys=[...Hg,...D.prototype._mutatorKeys];$e.prototype.drawableMarkFlags=[...D.prototype.drawableMarkFlags,"image","imageOpacity","mipmap"];$e.ImageIO=new Le("ImageIO",{valueType:$e,supertype:D.NodeIO,events:["changed"],methods:{setImage:{returnType:mt,parameterTypes:[ge],implementation:function(r){const e=new window.Image;e.src=r,this.image=e},documentation:"Set the image from a base64 string",invocableForReadOnlyElements:!1}}});d.register("Image",$e);const Vg=["boundsMethod","shape","shapeProperty"],ar={shape:null,boundsMethod:"accurate"},Xh=class Xh extends Kr(D){constructor(e,t){assert&&assert(t===void 0||Object.getPrototypeOf(t)===Object.prototype,"Extra prototype on Node options object is a code smell"),(e||t!=null&&t.shape)&&assert&&assert(!e||!(t!=null&&t.shape),"Do not define shape twice. Check constructor and providedOptions.");const s={boundsMethod:ar.boundsMethod};O(e)?s.shapeProperty=e:s.shape=e;const i=E()(s,t);super(),this._shapeProperty=new Ut(null,!1,this.onShapePropertyChange.bind(this)),this._shape=ar.shape,this._strokedShape=null,this._boundsMethod=ar.boundsMethod,this._invalidShapeListener=this.invalidateShape.bind(this),this._invalidShapeListenerAttached=!1,this.invalidateSupportedRenderers(),this.mutate(i)}setShape(e){return assert&&assert(e===null||typeof e=="string"||e instanceof H,"A path's shape should either be null, a string, or a Shape"),this._shapeProperty.value=e,this}set shape(e){this.setShape(e)}get shape(){return this.getShape()}getShape(){return this._shape}onShapePropertyChange(e){assert&&assert(e===null||typeof e=="string"||e instanceof H,"A path's shape should either be null, a string, or a Shape"),this._shape!==e&&(this._invalidShapeListenerAttached&&this.detachShapeListener(),typeof e=="string"&&(e=new H(e)),this._shape=e,this.invalidateShape(),this._shape&&!this._shape.isImmutable()&&this.attachShapeListener())}setShapeProperty(e){return this._shapeProperty.setTargetProperty(e)}set shapeProperty(e){this.setShapeProperty(e)}get shapeProperty(){return this.getShapeProperty()}getShapeProperty(){return this._shapeProperty}getStrokedShape(){return assert&&assert(this.hasShape(),"We cannot stroke a non-existing shape"),this._strokedShape||(this._strokedShape=this.getShape().getStrokedShape(this._lineDrawingStyles)),this._strokedShape}getPathRendererBitmask(){return p.bitmaskCanvas|p.bitmaskSVG}invalidateSupportedRenderers(){this.setRendererBitmask(this.getFillRendererBitmask()&this.getStrokeRendererBitmask()&this.getPathRendererBitmask())}invalidateShape(){this.invalidatePath();const e=this._drawables.length;for(let t=0;t<e;t++)this._drawables[t].markDirtyShape();this._invalidShapeListenerAttached&&this._shape&&this._shape.isImmutable()&&this.detachShapeListener()}invalidatePath(){this._strokedShape=null,this.invalidateSelf()}attachShapeListener(){assert&&assert(!this._invalidShapeListenerAttached,"We do not want to have two listeners attached!"),this.isDisposed||(this._shape.invalidatedEmitter.addListener(this._invalidShapeListener),this._invalidShapeListenerAttached=!0)}detachShapeListener(){assert&&assert(this._invalidShapeListenerAttached,"We cannot detach an unattached listener"),this._shape.invalidatedEmitter.removeListener(this._invalidShapeListener),this._invalidShapeListenerAttached=!1}updateSelfBounds(){const e=this.hasShape()?this.computeShapeBounds():w.NOTHING,t=!e.equals(this.selfBoundsProperty._value);return t&&this.selfBoundsProperty._value.set(e),t}setBoundsMethod(e){return assert&&assert(e==="accurate"||e==="unstroked"||e==="tightPadding"||e==="safePadding"||e==="none"),this._boundsMethod!==e&&(this._boundsMethod=e,this.invalidatePath(),this.rendererSummaryRefreshEmitter.emit()),this}set boundsMethod(e){this.setBoundsMethod(e)}get boundsMethod(){return this.getBoundsMethod()}getBoundsMethod(){return this._boundsMethod}computeShapeBounds(){const e=this.getShape();if(this._boundsMethod==="none"||!e)return w.NOTHING;if(!this.hasPaintableStroke()||this._boundsMethod==="unstroked")return e.bounds;if(this._boundsMethod==="accurate")return e.getStrokedBounds(this.getLineStyles());{let t;return this._boundsMethod==="safePadding"&&this.getLineJoin()==="miter"?t=this.getMiterLimit():this.getLineCap()==="square"?t=Math.SQRT2:t=1,e.bounds.dilated(t*this.getLineWidth()/2)}}areSelfBoundsValid(){return this._boundsMethod==="accurate"||this._boundsMethod==="safePadding"?!0:this._boundsMethod==="none"?!1:!this.hasStroke()}getTransformedSelfBounds(e){return assert&&assert(this.hasShape()),(this._stroke?this.getStrokedShape():this.getShape()).getBoundsWithTransform(e)}getTransformedSafeSelfBounds(e){return this.getTransformedSelfBounds(e)}invalidateStroke(){this.invalidatePath(),this.rendererSummaryRefreshEmitter.emit(),super.invalidateStroke()}hasShape(){return!!this._shape}canvasPaintSelf(e,t){Ic.prototype.paintCanvas(e,this,t)}createSVGDrawable(e,t){return Sy.createFromPool(e,t)}createCanvasDrawable(e,t){return Ic.createFromPool(e,t)}isPainted(){return!0}containsPointSelf(e){let t=!1;return this.hasShape()&&(this._fillPickable&&(t=this.getShape().containsPoint(e)),!t&&this._strokePickable&&(t=this.getStrokedShape().containsPoint(e))),t}getSelfShape(){return H.union([...this.hasShape()&&this._fillPickable?[this.getShape()]:[],...this.hasShape()&&this._strokePickable?[this.getStrokedShape()]:[]])}intersectsBoundsSelf(e){return this._shape?this._shape.intersectsBounds(e):!1}requiresSVGBoundsWorkaround(){if(!this._stroke||!(this._stroke instanceof wt)||!this.hasShape())return!1;const e=this.computeShapeBounds();return e.width*e.height===0}getDebugHTMLExtras(){return this._shape?` (<span style="color: #88f" onclick="window.open( 'data:text/plain;charset=utf-8,' + encodeURIComponent( '${this._shape.getSVGPath()}' ) );">path</span>)`:""}dispose(){this._invalidShapeListenerAttached&&this.detachShapeListener(),this._shapeProperty.dispose(),super.dispose()}mutate(e){return super.mutate(e)}};Xh.DEFAULT_PATH_OPTIONS=pe({},D.DEFAULT_NODE_OPTIONS,ar);let Pe=Xh;Pe.prototype._mutatorKeys=[...$d,...Vg,...D.prototype._mutatorKeys];Pe.prototype.drawableMarkFlags=[...D.prototype.drawableMarkFlags,...Ud,"shape"];d.register("Path",Pe);const Gg=["view","linked","string","none"],eh=new me("none",{tandem:se.GENERAL_VIEW.createTandem("phetioElementSelectionProperty"),phetioValueType:ge,validValues:Gg,phetioState:!1,phetioDocumentation:'Specifies how PhET-iO Elements are being selected. "view": the target view element, "linked": the corresponding linked element of the view element (if there is one), "string": select only string elements in the sim, "none": no active selection.'});Hs.register("phetioElementSelectionProperty",eh);const ur="stringProperty",zg=["boundsMethod",ur,"string","font","fontWeight","fontFamily","fontStretch","fontStyle","fontSize"],Wg=window.navigator.userAgent.includes("like Gecko) Version/5")&&window.navigator.userAgent.includes("Safari/"),vt=class vt extends Kr(D){constructor(e,t){assert&&assert(t===void 0||Object.getPrototypeOf(t)===Object.prototype,"Extra prototype on Node options object is a code smell"),super(),this._stringProperty=new Ut("",!0,this.onStringPropertyChange.bind(this)),this._font=xe.DEFAULT,this._boundsMethod="hybrid",this._isHTML=!1,this._cachedRenderedText=null;const s=Li({fill:"#000000",tandemNameSuffix:"Text",phetioType:vt.TextIO,phetioVisiblePropertyInstrumented:!1},t);assert&&assert(!s.hasOwnProperty("string")&&!s.hasOwnProperty(vt.STRING_PROPERTY_TANDEM_NAME),"provide string and stringProperty through constructor arg please"),typeof e=="string"||typeof e=="number"?s.string=e:s.stringProperty=e,this.mutate(s),this.invalidateSupportedRenderers()}mutate(e){return assert&&e&&e.hasOwnProperty("string")&&e.hasOwnProperty(ur)&&assert&&assert(e.stringProperty.value===e.string,"If both string and stringProperty are provided, then values should match"),super.mutate(e)}setString(e){return assert&&assert(e!=null,"String should be defined and non-null. Use the empty string if needed."),e=`${e}`,this._stringProperty.set(e),this}set string(e){this.setString(e)}get string(){return this.getString()}getString(){return this._stringProperty.value}getRenderedText(){return this._cachedRenderedText===null&&(this._cachedRenderedText=this.string.replace(" "," "),Te.edge&&(this._cachedRenderedText=vt.simplifyEmbeddingMarks(this._cachedRenderedText))),this._cachedRenderedText}get renderedText(){return this.getRenderedText()}onStringPropertyChange(){this._cachedRenderedText=null;const e=this._drawables.length;for(let t=0;t<e;t++)this._drawables[t].markDirtyText();this.invalidateText()}setStringProperty(e){return this._stringProperty.setTargetProperty(e,this,vt.STRING_PROPERTY_TANDEM_NAME)}set stringProperty(e){this.setStringProperty(e)}get stringProperty(){return this.getStringProperty()}getStringProperty(){return this._stringProperty}initializePhetioObject(e,t){const s=this.isPhetioInstrumented();super.initializePhetioObject(e,t),se.PHET_IO_ENABLED&&!s&&this.isPhetioInstrumented()&&this._stringProperty.initializePhetio(this,vt.STRING_PROPERTY_TANDEM_NAME,()=>new $r(this.string,pe({phetioReadOnly:!0,tandem:this.tandem.createTandem(vt.STRING_PROPERTY_TANDEM_NAME),phetioDocumentation:"Property for the displayed text"},t.stringPropertyOptions)))}getPhetioMouseHitTarget(e=!1){return eh.value==="string"?this.getStringPropertyPhetioMouseHitTarget(e):super.getPhetioMouseHitTarget(e)}getStringPropertyPhetioMouseHitTarget(e=!1){const t=this._stringProperty.getTargetProperty();return t instanceof _e?t.getPhetioMouseHitTarget(e):"phetioNotSelectable"}setBoundsMethod(e){if(assert&&assert(e==="fast"||e==="fastCanvas"||e==="accurate"||e==="hybrid","Unknown Text boundsMethod"),e!==this._boundsMethod){this._boundsMethod=e,this.invalidateSupportedRenderers();const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyBounds();this.invalidateText(),this.rendererSummaryRefreshEmitter.emit()}return this}set boundsMethod(e){this.setBoundsMethod(e)}get boundsMethod(){return this.getBoundsMethod()}getBoundsMethod(){return this._boundsMethod}getTextRendererBitmask(){let e=0;return this._boundsMethod!=="fast"&&!this._isHTML&&(e|=p.bitmaskCanvas),this._isHTML||(e|=p.bitmaskSVG),e|=p.bitmaskDOM,e}invalidateSupportedRenderers(){this.setRendererBitmask(this.getFillRendererBitmask()&this.getStrokeRendererBitmask()&this.getTextRendererBitmask())}invalidateText(){this.invalidateSelf();const e=this._drawables.length;for(let t=0;t<e;t++)this._drawables[t].markDirtyBounds();this.invalidateSupportedRenderers()}updateSelfBounds(){let e;this._isHTML||Wg&&this._boundsMethod!=="accurate"?e=gt.approximateDOMBounds(this._font,this.getDOMTextNode()):this._boundsMethod==="hybrid"?e=gt.approximateHybridBounds(this._font,this.renderedText):this._boundsMethod==="accurate"?e=gt.accurateCanvasBounds(this):(assert&&assert(this._boundsMethod==="fast"||this._boundsMethod==="fastCanvas"),e=gt.approximateSVGBounds(this._font,this.renderedText)),this.hasStroke()&&e.dilate(this.getLineWidth()/2);const t=!e.equals(this.selfBoundsProperty._value);return t&&this.selfBoundsProperty._value.set(e),t}invalidateStroke(){this.invalidateText(),super.invalidateStroke()}invalidateFill(){this.invalidateText(),super.invalidateFill()}canvasPaintSelf(e,t){Ac.prototype.paintCanvas(e,this,t)}createDOMDrawable(e,t){return ky.createFromPool(e,t)}createSVGDrawable(e,t){return Oy.createFromPool(e,t)}createCanvasDrawable(e,t){return Ac.createFromPool(e,t)}getDOMTextNode(){if(this._isHTML){const e=document.createElement("span");return e.innerHTML=this.string,e}else return document.createTextNode(this.renderedText)}getSafeSelfBounds(){const t=this.getSelfBounds();return t.dilatedXY(1*t.width,1*t.height)}setFont(e){if(e!==(typeof e=="string"?this._font.toCSS():this._font)){this._font=typeof e=="string"?xe.fromCSS(e):e;const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyFont();this.invalidateText()}return this}set font(e){this.setFont(e)}get font(){return this.getFont()}getFont(){return this._font.getFont()}setFontWeight(e){return this.setFont(this._font.copy({weight:e}))}set fontWeight(e){this.setFontWeight(e)}get fontWeight(){return this.getFontWeight()}getFontWeight(){return this._font.getWeight()}setFontFamily(e){return this.setFont(this._font.copy({family:e}))}set fontFamily(e){this.setFontFamily(e)}get fontFamily(){return this.getFontFamily()}getFontFamily(){return this._font.getFamily()}setFontStretch(e){return this.setFont(this._font.copy({stretch:e}))}set fontStretch(e){this.setFontStretch(e)}get fontStretch(){return this.getFontStretch()}getFontStretch(){return this._font.getStretch()}setFontStyle(e){return this.setFont(this._font.copy({style:e}))}set fontStyle(e){this.setFontStyle(e)}get fontStyle(){return this.getFontStyle()}getFontStyle(){return this._font.getStyle()}setFontSize(e){return this.setFont(this._font.copy({size:e}))}set fontSize(e){this.setFontSize(e)}get fontSize(){return this.getFontSize()}getFontSize(){return this._font.getSize()}isPainted(){return!0}areSelfBoundsValid(){return this._boundsMethod==="accurate"}getDebugHTMLExtras(){return` "${Qa(this.renderedText)}"${this._isHTML?" (html)":""}`}dispose(){super.dispose(),this._stringProperty.dispose()}static embeddedDebugString(e){return e.replace(/\u202a/g,"[LTR]").replace(/\u202b/g,"[RTL]").replace(/\u202c/g,"[POP]")}static simplifyEmbeddingMarks(e){const t={dir:null,children:[],parent:null};let s=t;for(let l=0;l<e.length;l++){const c=e.charAt(l);if(c===$g||c===Ug){const u={dir:c,children:[],parent:s};s.children.push(u),s=u}else c===Yg?(assert&&assert(s.parent,`Bad nesting of embedding marks: ${vt.embeddedDebugString(e)}`),s=s.parent):s.children.push(c)}assert&&assert(s===t,`Bad nesting of embedding marks: ${vt.embeddedDebugString(e)}`);function i(l){for(let c=l.children.length-1;c>=0;c--){const u=l.children[c];typeof u!="string"&&l.dir===u.dir&&l.children.splice(c,1,...u.children)}}function n(l){l.children.length===1&&typeof l.children[0]!="string"&&l.children[0].dir&&(l.dir=l.children[0].dir,l.children=l.children[0].children)}function a(l){for(let c=l.children.length-1;c>=1;c--){const u=l.children[c-1],m=l.children[c];typeof m!="string"&&typeof u!="string"&&m.dir&&u.dir===m.dir&&(u.children=u.children.concat(m.children),l.children.splice(c,1),a(u))}}function o(l){if(typeof l!="string"){for(let c=0;c<l.children.length;c++)o(l.children[c]);n(l),i(l),a(l)}return l}function h(l){if(typeof l=="string")return l;const c=l.children.map(h).join("");return l.dir?`${l.dir+c}‬`:c}return h(o(t))}};vt.STRING_PROPERTY_NAME=ur,vt.STRING_PROPERTY_TANDEM_NAME=ur;let Fe=vt;Fe.prototype._mutatorKeys=[...$d,...zg,...D.prototype._mutatorKeys];Fe.prototype.drawableMarkFlags=[...D.prototype.drawableMarkFlags,...Ud,"text","font","bounds"];d.register("Text",Fe);const $g="‪",Ug="‫",Yg="‬";gt.initializeTextBounds();Fe.TextIO=new Le("TextIO",{valueType:Fe,supertype:D.NodeIO,documentation:"Text that is displayed in the simulation. TextIO has a nested PropertyIO.&lt;String&gt; for the current string value."});const Kg=["canvasBounds"];class Ks extends D{constructor(e){super(e),this.setRendererBitmask(p.bitmaskCanvas)}setCanvasBounds(e){this.invalidateSelf(e)}set canvasBounds(e){this.setCanvasBounds(e)}get canvasBounds(){return this.getCanvasBounds()}getCanvasBounds(){return this.getSelfBounds()}isPainted(){return!0}invalidatePaint(){const e=this._drawables.length;for(let t=0;t<e;t++)this._drawables[t].markDirty()}canvasPaintSelf(e,t){this.paintCanvas(e.context)}containsPointSelf(e){return!1}getSelfShape(){return new H}createCanvasDrawable(e,t){return dy.createFromPool(e,t)}mutate(e){return super.mutate(e)}}Ks.prototype._mutatorKeys=Kg.concat(D.prototype._mutatorKeys);d.register("CanvasNode",Ks);const Xg=["radius"];class Ai extends Pe{constructor(e,t){super(null),this._radius=0,typeof e=="object"?(t=e,assert&&assert(t===void 0||Object.getPrototypeOf(t)===Object.prototype,"Extra prototype on Node options object is a code smell")):(assert&&assert(t===void 0||Object.getPrototypeOf(t)===Object.prototype,"Extra prototype on Node options object is a code smell"),t=Li({radius:e},t)),this.mutate(t)}getStrokeRendererBitmask(){let e=super.getStrokeRendererBitmask();return this.hasStroke()&&!this.getStroke().isGradient&&!this.getStroke().isPattern&&this.getLineWidth()<=this.getRadius()&&(e|=p.bitmaskDOM),e}getPathRendererBitmask(){return p.bitmaskCanvas|p.bitmaskSVG|(A.borderRadius?p.bitmaskDOM:0)}invalidateCircle(){assert&&assert(this._radius>=0,"A circle needs a non-negative radius"),this._shape=null,this.invalidatePath()}createCircleShape(){return H.circle(0,0,this._radius).makeImmutable()}intersectsBoundsSelf(e){let t=Math.abs(e.centerX),s=Math.abs(e.centerY);const i=e.maxX-t,n=e.maxY-s;return t>i+this._radius||s>n+this._radius?!1:t<=i||s<=n?!0:(t-=i,s-=n,t*t+s*s<=this._radius*this._radius)}canvasPaintSelf(e,t){Dc.prototype.paintCanvas(e,this,t)}createDOMDrawable(e,t){return uy.createFromPool(e,t)}createSVGDrawable(e,t){return gy.createFromPool(e,t)}createCanvasDrawable(e,t){return Dc.createFromPool(e,t)}setRadius(e){if(assert&&assert(e>=0,"A circle needs a non-negative radius"),assert&&assert(isFinite(e),"A circle needs a finite radius"),this._radius!==e){this._radius=e,this.invalidateCircle();const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyRadius()}return this}set radius(e){this.setRadius(e)}get radius(){return this.getRadius()}getRadius(){return this._radius}computeShapeBounds(){let e=new w(-this._radius,-this._radius,this._radius,this._radius);return this._stroke&&(e=e.dilated(this.getLineWidth()/2)),e}containsPointSelf(e){const t=e.x*e.x+e.y*e.y;let s=!0,i;if(this._strokePickable){i=this.getLineWidth()/2;const n=this._radius+i;s=s&&t<=n*n}if(this._fillPickable)return this._strokePickable?s:t<=this._radius*this._radius;if(this._strokePickable){const n=this._radius-i;return s&&t>=n*n}else return!1}setShape(e){if(e!==null)throw new Error("Cannot set the shape of a Circle to something non-null");return this.invalidatePath(),this}getShape(){return this._shape||(this._shape=this.createCircleShape()),this._shape}hasShape(){return!0}setShapeProperty(e){if(e!==null)throw new Error("Cannot set the shapeProperty of a Circle to something non-null, it handles this itself");return this}mutate(e){return super.mutate(e)}}Ai.prototype._mutatorKeys=Xg.concat(Pe.prototype._mutatorKeys);Ai.prototype.drawableMarkFlags=Pe.prototype.drawableMarkFlags.concat(["radius"]).filter(r=>r!=="shape");d.register("Circle",Ai);const jg=["element","preventTransform","allowInput"],qg=r=>!!(r&&r.jquery);class Hn extends D{constructor(e,t){assert&&assert(t===void 0||Object.getPrototypeOf(t)===Object.prototype,"Extra prototype on Node options object is a code smell"),assert&&assert(e instanceof window.Element||e.jquery,"DOM nodes need to be passed an HTML/DOM element or a jQuery selection like $( ... )"),qg(e)&&(e=e[0],assert&&assert(e instanceof window.Element)),super(),this._container=document.createElement("div"),this._container.style.position="absolute",this._container.style.left="0",this._container.style.top="0",this._allowInput=!1,this._$container=$(this._container),this.invalidateDOMLock=!1,this._preventTransform=!1,this.invalidateAllowInput(this._allowInput),t=Li({element:e},t),this.mutate(t),this.setRendererBitmask(p.bitmaskDOM)}calculateDOMBounds(){const e=$(this._element);return new w(0,0,e.width(),e.height())}invalidateDOM(){if(this.invalidateDOMLock)return;this.invalidateDOMLock=!0;const e=document.createElement("div");$(e).css({display:"hidden",padding:"0 !important",margin:"0 !important",position:"absolute",left:0,top:0,width:65535,height:65535}),this._container.removeChild(this._element),e.appendChild(this._element),document.body.appendChild(e);const t=this.calculateDOMBounds();this.invalidateSelf(t),this._$container.width(t.getWidth()),this._$container.height(t.getHeight()),document.body.removeChild(e),e.removeChild(this._element),this._container.appendChild(this._element),this.invalidateDOMLock=!1}createDOMDrawable(e,t){return ko.createFromPool(e,t)}isPainted(){return!0}setElement(e){return assert&&assert(!this._element,"We should only ever attach one DOMElement to a DOM node"),this._element!==e&&(this._element&&this._container.removeChild(this._element),this._element=e,this._container.appendChild(this._element),this.invalidateDOM()),this}set element(e){this.setElement(e)}get element(){return this.getElement()}getElement(){return this._element}setPreventTransform(e){this._preventTransform!==e&&(this._preventTransform=e)}set preventTransform(e){this.setPreventTransform(e)}get preventTransform(){return this.isTransformPrevented()}isTransformPrevented(){return this._preventTransform}setAllowInput(e){this._allowInput!==e&&(this._allowInput=e,this.invalidateAllowInput(e))}isInputAllowed(){return this._allowInput}invalidateAllowInput(e){this._container.dataset.sceneryAllowInput=e?"true":"false",this._container.style.pointerEvents=e?"auto":"none"}set allowInput(e){this.setAllowInput(e)}get allowInput(){return this.isInputAllowed()}mutate(e){return super.mutate(e)}}Hn.prototype._mutatorKeys=jg.concat(D.prototype._mutatorKeys);d.register("DOM",Hn);const Qg=["p1","p2","x1","y1","x2","y2"];class ds extends Pe{constructor(e,t,s,i,n){super(null),this._x1=0,this._y1=0,this._x2=0,this._y2=0,typeof e=="object"?e instanceof T?(assert&&assert(s===void 0||typeof s=="object"),assert&&assert(s===void 0||Object.getPrototypeOf(s)===Object.prototype,"Extra prototype on Node options object is a code smell"),n=Li({x1:e.x,y1:e.y,x2:t.x,y2:t.y,strokePickable:!0},s)):(assert&&assert(t===void 0),assert&&assert(e===void 0||Object.getPrototypeOf(e)===Object.prototype,"Extra prototype on Node options object is a code smell"),n=Li({strokePickable:!0},e)):(assert&&assert(e!==void 0&&typeof t=="number"&&typeof s=="number"&&typeof i=="number"),assert&&assert(n===void 0||Object.getPrototypeOf(n)===Object.prototype,"Extra prototype on Node options object is a code smell"),n=Li({x1:e,y1:t,x2:s,y2:i,strokePickable:!0},n)),this.mutate(n)}setLine(e,t,s,i){assert&&assert(e!==void 0&&t!==void 0&&s!==void 0&&i!==void 0,"parameters need to be defined"),this._x1=e,this._y1=t,this._x2=s,this._y2=i;const n=this._drawables.length;for(let a=0;a<n;a++)this._drawables[a].markDirtyLine();return this.invalidateLine(),this}setPoint1(e,t){typeof e=="number"?(assert&&assert(e!==void 0&&t!==void 0,"parameters need to be defined"),this._x1=e,this._y1=t):(assert&&assert(e.x!==void 0&&e.y!==void 0,"parameters need to be defined"),this._x1=e.x,this._y1=e.y);const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyP1();return this.invalidateLine(),this}set p1(e){this.setPoint1(e)}get p1(){return new T(this._x1,this._y1)}setPoint2(e,t){typeof e=="number"?(assert&&assert(e!==void 0&&t!==void 0,"parameters need to be defined"),this._x2=e,this._y2=t):(assert&&assert(e.x!==void 0&&e.y!==void 0,"parameters need to be defined"),this._x2=e.x,this._y2=e.y);const s=this._drawables.length;for(let i=0;i<s;i++)this._drawables[i].markDirtyP2();return this.invalidateLine(),this}set p2(e){this.setPoint2(e)}get p2(){return new T(this._x2,this._y2)}setX1(e){if(this._x1!==e){this._x1=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyX1();this.invalidateLine()}return this}set x1(e){this.setX1(e)}get x1(){return this.getX1()}getX1(){return this._x1}setY1(e){if(this._y1!==e){this._y1=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyY1();this.invalidateLine()}return this}set y1(e){this.setY1(e)}get y1(){return this.getY1()}getY1(){return this._y1}setX2(e){if(this._x2!==e){this._x2=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyX2();this.invalidateLine()}return this}set x2(e){this.setX2(e)}get x2(){return this.getX2()}getX2(){return this._x2}setY2(e){if(this._y2!==e){this._y2=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyY2();this.invalidateLine()}return this}set y2(e){this.setY2(e)}get y2(){return this.getY2()}getY2(){return this._y2}createLineShape(){return H.lineSegment(this._x1,this._y1,this._x2,this._y2).makeImmutable()}invalidateLine(){assert&&assert(isFinite(this._x1),`A line needs to have a finite x1 (${this._x1})`),assert&&assert(isFinite(this._y1),`A line needs to have a finite y1 (${this._y1})`),assert&&assert(isFinite(this._x2),`A line needs to have a finite x2 (${this._x2})`),assert&&assert(isFinite(this._y2),`A line needs to have a finite y2 (${this._y2})`),this._shape=null,this.invalidatePath()}containsPointSelf(e){return this._strokePickable?super.containsPointSelf(e):!1}canvasPaintSelf(e,t){Cc.prototype.paintCanvas(e,this,t)}computeShapeBounds(){if(this._stroke){const e=this.getLineCap(),t=this.getLineWidth()/2;if(e==="round")return new w(Math.min(this._x1,this._x2)-t,Math.min(this._y1,this._y2)-t,Math.max(this._x1,this._x2)+t,Math.max(this._y1,this._y2)+t);{const s=this._x2-this._x1,i=this._y2-this._y1,n=Math.sqrt(s*s+i*i);if(n===0)return new w(this._x1-t,this._y1-t,this._x2+t,this._y2+t);const a=t*s/n,o=t*i/n,h=w.NOTHING.copy();return e==="butt"?(h.addCoordinates(this._x1-o,this._y1+a),h.addCoordinates(this._x1+o,this._y1-a),h.addCoordinates(this._x2-o,this._y2+a),h.addCoordinates(this._x2+o,this._y2-a)):(assert&&assert(e==="square"),h.addCoordinates(this._x1-a-o,this._y1-o+a),h.addCoordinates(this._x1-a+o,this._y1-o-a),h.addCoordinates(this._x2+a-o,this._y2+o+a),h.addCoordinates(this._x2+a+o,this._y2+o-a)),h}}else{const e=w.NOTHING.copy();return e.addCoordinates(this._x1,this._y1),e.addCoordinates(this._x2,this._y2),e}}createSVGDrawable(e,t){return vy.createFromPool(e,t)}createCanvasDrawable(e,t){return Cc.createFromPool(e,t)}setShape(e){if(e!==null)throw new Error("Cannot set the shape of a Line to something non-null");return this.invalidatePath(),this}getShape(){return this._shape||(this._shape=this.createLineShape()),this._shape}hasShape(){return!0}setShapeProperty(e){if(e!==null)throw new Error("Cannot set the shapeProperty of a Line to something non-null, it handles this itself");return this}mutate(e){return super.mutate(e)}getFillRendererBitmask(){return p.bitmaskCanvas|p.bitmaskSVG|p.bitmaskDOM|p.bitmaskWebGL}}ds.prototype._mutatorKeys=Qg.concat(Pe.prototype._mutatorKeys);ds.prototype.drawableMarkFlags=Pe.prototype.drawableMarkFlags.concat(["line","p1","p2","x1","x2","y1","y2"]).filter(r=>r!=="shape");d.register("Line",ds);const Zg=["rectBounds","rectSize","rectX","rectY","rectWidth","rectHeight","cornerRadius","cornerXRadius","cornerYRadius"],Xd=Yr(Pe);class De extends Xd{constructor(e,t,s,i,n,a,o){const h={sizable:!1};super(null,h);let l={};this._rectX=0,this._rectY=0,this._rectWidth=0,this._rectHeight=0,this._cornerXRadius=0,this._cornerYRadius=0,typeof e=="object"?e instanceof w?typeof t!="number"?(assert&&assert(arguments.length===1||arguments.length===2,"new Rectangle( bounds, { ... } ) should only take one or two arguments"),assert&&assert(t===void 0||typeof t=="object","new Rectangle( bounds, { ... } ) second parameter should only ever be an options object"),assert&&assert(t===void 0||Object.getPrototypeOf(t)===Object.prototype,"Extra prototype on Node options object is a code smell"),assert&&t&&(assert(t.rectWidth===void 0,"Should not specify rectWidth in multiple ways"),assert(t.rectHeight===void 0,"Should not specify rectHeight in multiple ways"),assert(t.rectBounds===void 0,"Should not specify rectBounds in multiple ways")),l=pe(l,{rectBounds:e},t)):(assert&&assert(arguments.length===3||arguments.length===4,"new Rectangle( bounds, cornerXRadius, cornerYRadius, { ... } ) should only take three or four arguments"),assert&&assert(i===void 0||typeof i=="object","new Rectangle( bounds, cornerXRadius, cornerYRadius, { ... } ) fourth parameter should only ever be an options object"),assert&&assert(i===void 0||Object.getPrototypeOf(i)===Object.prototype,"Extra prototype on Node options object is a code smell"),assert&&i&&(assert(i.rectWidth===void 0,"Should not specify rectWidth in multiple ways"),assert(i.rectHeight===void 0,"Should not specify rectHeight in multiple ways"),assert(i.rectBounds===void 0,"Should not specify rectBounds in multiple ways"),assert(i.cornerXRadius===void 0,"Should not specify cornerXRadius in multiple ways"),assert(i.cornerYRadius===void 0,"Should not specify cornerYRadius in multiple ways"),assert(i.cornerRadius===void 0,"Should not specify cornerRadius in multiple ways")),l=pe(l,{rectBounds:e,cornerXRadius:t,cornerYRadius:s},i)):l=pe(l,e):a===void 0?(assert&&assert(arguments.length===4||arguments.length===5,"new Rectangle( x, y, width, height, { ... } ) should only take four or five arguments"),assert&&assert(n===void 0||typeof n=="object","new Rectangle( x, y, width, height, { ... } ) fifth parameter should only ever be an options object"),assert&&assert(n===void 0||Object.getPrototypeOf(n)===Object.prototype,"Extra prototype on Node options object is a code smell"),assert&&n&&(assert(n.rectX===void 0,"Should not specify rectX in multiple ways"),assert(n.rectY===void 0,"Should not specify rectY in multiple ways"),assert(n.rectWidth===void 0,"Should not specify rectWidth in multiple ways"),assert(n.rectHeight===void 0,"Should not specify rectHeight in multiple ways"),assert(n.rectBounds===void 0,"Should not specify rectBounds in multiple ways")),l=pe(l,{rectX:e,rectY:t,rectWidth:s,rectHeight:i},n)):(assert&&assert(arguments.length===6||arguments.length===7,"new Rectangle( x, y, width, height, cornerXRadius, cornerYRadius{ ... } ) should only take six or seven arguments"),assert&&assert(l===void 0||typeof l=="object","new Rectangle( x, y, width, height, cornerXRadius, cornerYRadius{ ... } ) seventh parameter should only ever be an options object"),assert&&assert(l===void 0||Object.getPrototypeOf(l)===Object.prototype,"Extra prototype on Node options object is a code smell"),assert&&o&&(assert(o.rectX===void 0,"Should not specify rectX in multiple ways"),assert(o.rectY===void 0,"Should not specify rectY in multiple ways"),assert(o.rectWidth===void 0,"Should not specify rectWidth in multiple ways"),assert(o.rectHeight===void 0,"Should not specify rectHeight in multiple ways"),assert(o.rectBounds===void 0,"Should not specify rectBounds in multiple ways"),assert(o.cornerXRadius===void 0,"Should not specify cornerXRadius in multiple ways"),assert(o.cornerYRadius===void 0,"Should not specify cornerYRadius in multiple ways"),assert(o.cornerRadius===void 0,"Should not specify cornerRadius in multiple ways")),l=pe(l,{rectX:e,rectY:t,rectWidth:s,rectHeight:i,cornerXRadius:n,cornerYRadius:a},o)),this.localPreferredWidthProperty.lazyLink(this.updatePreferredSizes.bind(this)),this.localPreferredHeightProperty.lazyLink(this.updatePreferredSizes.bind(this)),this.localMinimumWidthProperty.lazyLink(this.updatePreferredSizes.bind(this)),this.localMinimumHeightProperty.lazyLink(this.updatePreferredSizes.bind(this)),this.mutate(l)}getMaximumArcSize(){return Math.min(this._rectWidth/2,this._rectHeight/2)}getStrokeRendererBitmask(){let e=super.getStrokeRendererBitmask();const t=this.getStroke();return t&&!(t instanceof st)&&!(t instanceof Ms)&&!this.hasLineDash()&&(this.getLineJoin()==="miter"||this.getLineJoin()==="round"&&A.borderRadius)&&(e|=p.bitmaskDOM),this.hasStroke()||(e|=p.bitmaskWebGL),e}getPathRendererBitmask(){let e=p.bitmaskCanvas|p.bitmaskSVG;const t=this.getMaximumArcSize();return(!this.hasStroke()||this.getLineWidth()<=this._rectHeight&&this.getLineWidth()<=this._rectWidth)&&(!this.isRounded()||A.borderRadius&&this._cornerXRadius===this._cornerYRadius)&&this._cornerYRadius<=t&&this._cornerXRadius<=t&&(e|=p.bitmaskDOM),!this.hasStroke()&&!this.isRounded()&&(e|=p.bitmaskWebGL),e}setRect(e,t,s,i,n,a){const o=n!==void 0,h=a!==void 0;if(assert&&assert(isFinite(e)&&isFinite(t)&&isFinite(s)&&isFinite(i),"x/y/width/height should be finite numbers"),assert&&assert(!o||isFinite(n)&&(!h||isFinite(a)),"Corner radii (if provided) should be finite numbers"),this._rectX===e&&this._rectY===t&&this._rectWidth===s&&this._rectHeight===i&&(!o||this._cornerXRadius===n)&&(!h||this._cornerYRadius===a))return this;this._rectX=e,this._rectY=t,this._rectWidth=s,this._rectHeight=i,this._cornerXRadius=o?n:this._cornerXRadius,this._cornerYRadius=h?a:this._cornerYRadius;const l=this._drawables.length;for(let c=0;c<l;c++)this._drawables[c].markDirtyRectangle();return this.invalidateRectangle(),this}setRectX(e){if(assert&&assert(isFinite(e),"rectX should be a finite number"),this._rectX!==e){this._rectX=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyX();this.invalidateRectangle()}return this}set rectX(e){this.setRectX(e)}get rectX(){return this.getRectX()}getRectX(){return this._rectX}setRectY(e){if(assert&&assert(isFinite(e),"rectY should be a finite number"),this._rectY!==e){this._rectY=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyY();this.invalidateRectangle()}return this}set rectY(e){this.setRectY(e)}get rectY(){return this.getRectY()}getRectY(){return this._rectY}setRectWidth(e){if(assert&&assert(isFinite(e),"rectWidth should be a finite number"),this._rectWidth!==e){this._rectWidth=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyWidth();this.invalidateRectangle()}return this}set rectWidth(e){this.setRectWidth(e)}get rectWidth(){return this.getRectWidth()}getRectWidth(){return this._rectWidth}setRectHeight(e){if(assert&&assert(isFinite(e),"rectHeight should be a finite number"),this._rectHeight!==e){this._rectHeight=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyHeight();this.invalidateRectangle()}return this}set rectHeight(e){this.setRectHeight(e)}get rectHeight(){return this.getRectHeight()}getRectHeight(){return this._rectHeight}setCornerXRadius(e){if(assert&&assert(isFinite(e),"cornerXRadius should be a finite number"),this._cornerXRadius!==e){this._cornerXRadius=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyCornerXRadius();this.invalidateRectangle()}return this}set cornerXRadius(e){this.setCornerXRadius(e)}get cornerXRadius(){return this.getCornerXRadius()}getCornerXRadius(){return this._cornerXRadius}setCornerYRadius(e){if(assert&&assert(isFinite(e),"cornerYRadius should be a finite number"),this._cornerYRadius!==e){this._cornerYRadius=e;const t=this._drawables.length;for(let s=0;s<t;s++)this._drawables[s].markDirtyCornerYRadius();this.invalidateRectangle()}return this}set cornerYRadius(e){this.setCornerYRadius(e)}get cornerYRadius(){return this.getCornerYRadius()}getCornerYRadius(){return this._cornerYRadius}setRectBounds(e){return this.setRect(e.x,e.y,e.width,e.height),this}set rectBounds(e){this.setRectBounds(e)}get rectBounds(){return this.getRectBounds()}getRectBounds(){return w.rect(this._rectX,this._rectY,this._rectWidth,this._rectHeight)}setRectSize(e){return this.setRectWidth(e.width),this.setRectHeight(e.height),this}set rectSize(e){this.setRectSize(e)}get rectSize(){return this.getRectSize()}getRectSize(){return new Mt(this._rectWidth,this._rectHeight)}setRectWidthFromRight(e){if(this._rectWidth!==e){const t=this._rectX+this._rectWidth;this.setRectWidth(e),this.setRectX(t-e)}return this}set rectWidthFromRight(e){this.setRectWidthFromRight(e)}get rectWidthFromRight(){return this.getRectWidth()}setRectHeightFromBottom(e){if(this._rectHeight!==e){const t=this._rectY+this._rectHeight;this.setRectHeight(e),this.setRectY(t-e)}return this}set rectHeightFromBottom(e){this.setRectHeightFromBottom(e)}get rectHeightFromBottom(){return this.getRectHeight()}isRounded(){return this._cornerXRadius!==0&&this._cornerYRadius!==0}computeShapeBounds(){let e=new w(this._rectX,this._rectY,this._rectX+this._rectWidth,this._rectY+this._rectHeight);return this._stroke&&(e=e.dilated(this.getLineWidth()/2)),e}createRectangleShape(){if(this.isRounded()){const e=Math.min(this._rectWidth/2,this._rectHeight/2);return H.roundRectangle(this._rectX,this._rectY,this._rectWidth,this._rectHeight,Math.min(e,this._cornerXRadius),Math.min(e,this._cornerYRadius)).makeImmutable()}else return H.rectangle(this._rectX,this._rectY,this._rectWidth,this._rectHeight).makeImmutable()}invalidateRectangle(){assert&&assert(isFinite(this._rectX),`A rectangle needs to have a finite x (${this._rectX})`),assert&&assert(isFinite(this._rectY),`A rectangle needs to have a finite y (${this._rectY})`),assert&&assert(this._rectWidth>=0&&isFinite(this._rectWidth),`A rectangle needs to have a non-negative finite width (${this._rectWidth})`),assert&&assert(this._rectHeight>=0&&isFinite(this._rectHeight),`A rectangle needs to have a non-negative finite height (${this._rectHeight})`),assert&&assert(this._cornerXRadius>=0&&isFinite(this._cornerXRadius),`A rectangle needs to have a non-negative finite arcWidth (${this._cornerXRadius})`),assert&&assert(this._cornerYRadius>=0&&isFinite(this._cornerYRadius),`A rectangle needs to have a non-negative finite arcHeight (${this._cornerYRadius})`),this._shape=null,this.invalidatePath(),this.invalidateSupportedRenderers()}updatePreferredSizes(){let e=this.localPreferredWidth,t=this.localPreferredHeight;e!==null&&(e=Math.max(e,this.localMinimumWidth||0)),t!==null&&(t=Math.max(t,this.localMinimumHeight||0)),e!==null&&(this.rectWidth=this.hasStroke()?e-this.lineWidth:e),t!==null&&(this.rectHeight=this.hasStroke()?t-this.lineWidth:t)}invalidateStroke(){super.invalidateStroke(),this.updatePreferredSizes()}containsPointSelf(e){const t=this._rectX,s=this._rectY,i=this._rectWidth,n=this._rectHeight,a=this._cornerXRadius,o=this._cornerYRadius,h=this.getLineWidth()/2;let l=!0;if(this._strokePickable){const c=this.isRounded();if(!c&&this.getLineJoin()==="bevel")return super.containsPointSelf(e);const u=this.getLineJoin()==="miter"&&!c;l=l&&De.intersects(t-h,s-h,i+2*h,n+2*h,u?0:a+h,u?0:o+h,e)}return this._fillPickable?this._strokePickable?l:De.intersects(t,s,i,n,a,o,e):this._strokePickable?l&&!De.intersects(t+h,s+h,i-2*h,n-2*h,a-h,o-h,e):!1}intersectsBoundsSelf(e){return!this.computeShapeBounds().intersection(e).isEmpty()}canvasPaintSelf(e,t){Ec.prototype.paintCanvas(e,this,t)}createDOMDrawable(e,t){return wy.createFromPool(e,t)}createSVGDrawable(e,t){return Ty.createFromPool(e,t)}createCanvasDrawable(e,t){return Ec.createFromPool(e,t)}createWebGLDrawable(e,t){return Iy.createFromPool(e,t)}setShape(e){if(e!==null)throw new Error("Cannot set the shape of a Rectangle to something non-null");return this.invalidatePath(),this}getShape(){return this._shape||(this._shape=this.createRectangleShape()),this._shape}hasShape(){return!0}setShapeProperty(e){if(e!==null)throw new Error("Cannot set the shapeProperty of a Rectangle to something non-null, it handles this itself");return this}setCornerRadius(e){return this.setCornerXRadius(e),this.setCornerYRadius(e),this}set cornerRadius(e){this.setCornerRadius(e)}get cornerRadius(){return this.getCornerRadius()}getCornerRadius(){return assert&&assert(this._cornerXRadius===this._cornerYRadius,"getCornerRadius() invalid if x/y radii are different"),this._cornerXRadius}mutate(e){return super.mutate(e)}static intersects(e,t,s,i,n,a,o){const h=o.x>=e&&o.x<=e+s&&o.y>=t&&o.y<=t+i;if(!h||n<=0||a<=0)return h;const l=Math.min(s/2,i/2);n=Math.min(l,n),a=Math.min(l,a);let c,u,m=!1;if(o.x<e+s/2?(c=e+n,m=m||o.x>=c):(c=e+s-n,m=m||o.x<=c),m||(o.y<t+i/2?(u=t+a,m=m||o.y>=u):(u=t+i-a,m=m||o.y<=u),m))return!0;let b=o.x-c,y=o.y-u;return b/=n,y/=a,b*=b,y*=y,b+y<=1}static rect(e,t,s,i,n){return new De(e,t,s,i,0,0,n)}static roundedRect(e,t,s,i,n,a,o){return new De(e,t,s,i,n,a,o)}static bounds(e,t){return new De(e.minX,e.minY,e.width,e.height,t)}static roundedBounds(e,t,s,i){return new De(e.minX,e.minY,e.width,e.height,t,s,i)}static dimension(e,t){return new De(0,0,e.width,e.height,0,0,t)}}De.prototype._mutatorKeys=[...Zg,...Xd.prototype._mutatorKeys];De.prototype.drawableMarkFlags=Pe.prototype.drawableMarkFlags.concat(["x","y","width","height","cornerXRadius","cornerYRadius"]).filter(r=>r!=="shape");d.register("Rectangle",De);class th extends D{constructor(e){const t=E()({sprites:[],spriteInstances:[],hitTestSprites:!1,renderer:"webgl"},e);super(),this._sprites=t.sprites,this._spriteInstances=t.spriteInstances,this._hitTestSprites=t.hitTestSprites,this.setRendererBitmask(p.bitmaskCanvas|p.bitmaskWebGL),this.mutate(t)}setCanvasBounds(e){this.invalidateSelf(e)}set canvasBounds(e){this.setCanvasBounds(e)}get canvasBounds(){return this.getCanvasBounds()}getCanvasBounds(){return this.getSelfBounds()}canvasPaintSelf(e,t){kc.prototype.paintCanvas(e,this,t)}createCanvasDrawable(e,t){return kc.createFromPool(e,t)}createWebGLDrawable(e,t){return Ey.createFromPool(e,t)}containsPointSelf(e){return super.containsPointSelf(e)?this._hitTestSprites?!!this.getSpriteInstanceFromPoint(e):!0:!1}getSpriteInstanceFromPoint(e){for(let t=this._spriteInstances.length-1;t>=0;t--)if(this._spriteInstances[t].containsPoint(e))return this._spriteInstances[t];return null}getSelfShape(){return this._hitTestSprites?H.union(this._spriteInstances.map(e=>e.getShape())):H.bounds(this.selfBounds)}isPainted(){return!0}invalidatePaint(){const e=this._drawables.length;for(let t=0;t<e;t++)this._drawables[t].markDirty()}mutate(e){return super.mutate(e)}}th.prototype._mutatorKeys=["canvasBounds"].concat(D.prototype._mutatorKeys);d.register("Sprites",th);const Jg=["canvasBounds"],Br=class Br extends D{constructor(e,t){super(t),this.setRendererBitmask(p.bitmaskWebGL),this.painterType=e}setCanvasBounds(e){return this.invalidateSelf(e),this}set canvasBounds(e){this.setCanvasBounds(e)}get canvasBounds(){return this.getCanvasBounds()}getCanvasBounds(){return this.getSelfBounds()}isPainted(){return!0}invalidatePaint(){const e=this._drawables.length;for(let t=0;t<e;t++)this._drawables[t].markDirty()}containsPointSelf(e){return!1}getSelfShape(){return new H}canvasPaintSelf(e,t){assert&&assert(!1,"unimplemented: canvasPaintSelf in WebGLNode")}renderToCanvasSelf(e,t){const s=e.canvas.width,i=e.canvas.height,n=document.createElement("canvas");n.width=s,n.height=i;const a={antialias:!0,preserveDrawingBuffer:!0},o=n.getContext("webgl",a)||n.getContext("experimental-webgl",a);Y.applyWebGLContextDefaults(o);const h=new C().rowMajor(2/s,0,-1,0,-2/i,1,0,0,1);o.viewport(0,0,s,i);const l=this.painterType,c=new l(o,this);c.paint(t,h),c.dispose(),h.freeToPool(),o.flush(),e.context.setTransform(1,0,0,1,0,0),e.context.drawImage(n,0,0),e.context.restore()}createWebGLDrawable(e,t){return My.createFromPool(e,t)}mutate(e){return super.mutate(e)}};Br.PAINTED_NOTHING=0,Br.PAINTED_SOMETHING=1;let Yt=Br;Yt.prototype._mutatorKeys=Jg.concat(D.prototype._mutatorKeys);d.register("WebGLNode",Yt);class em extends De{constructor(e){super(-2e3,-2e3,6e3,6e3,e)}}d.register("Plane",em);const jd=Me(r=>class extends r{constructor(...t){super(...t)}insertChild(t,s){throw new Error("Attempt to insert child into Leaf")}removeChildWithIndex(t,s){throw new Error("Attempt to remove child from Leaf")}});d.register("Leaf",jd);class sh extends jd(D){constructor(e,t,s){assert&&assert(isFinite(e),"width should be a finite number"),assert&&assert(isFinite(t),"height should be a finite number"),super(),this.localBounds=new w(0,0,e,t),this.mutate(s)}}d.register("Spacer",sh);class tm extends sh{constructor(e,t){super(e,0,t)}}d.register("HStrut",tm);class sm extends sh{constructor(e,t){super(0,e,t)}}d.register("VStrut",sm);let im=1;const nm=new T(0,0);class rm extends ht(Object){constructor(e,t,s){assert&&assert(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement);const i={hitTestPixels:!1,pickable:!0};O(e)?i.imageProperty=e:i.image=e;const n=E()(i,s);super(),this.id=im++,this.offset=t,this.pickable=n.pickable,this.shape=null,this.imageData=null,O(e)?this.imageProperty=e:this.image=e,Yn(this,Object.keys(ht.DEFAULT_OPTIONS),n)}get width(){return this.imageWidth}get height(){return this.imageHeight}getShape(){if(!this.pickable)return new H;if(!this.shape){if(this.hitTestPixels)if(this.ensureImageData(),this.imageData)this.shape=ht.hitTestDataToShape(this.imageData,this.width,this.height);else return new H;else if(this.width&&this.height)this.shape=H.rect(0,0,this.width,this.height);else return new H;this.shape=this.shape.transformed(C.translation(-this.offset.x,-this.offset.y))}return this.shape}ensureImageData(){!this.imageData&&this.width&&this.height&&(this.imageData=ht.getHitTestData(this.image,this.width,this.height))}containsPoint(e){if(!this.pickable)return!1;const t=this.width,s=this.height;if(!t&&!s)return!1;const i=nm.set(e).add(this.offset);return i.x<0||i.y<0||i.x>t||i.y>s?!1:this.hitTestPixels?(this.ensureImageData(),this.imageData?ht.testHitTestData(this.imageData,t,s,i):!1):!0}}d.register("SpriteImage",rm);class am{constructor(e){this.imageProperty=new me(e)}getShape(){return this.imageProperty.value.getShape()}containsPoint(e){return this.imageProperty.value.containsPoint(e)}}d.register("Sprite",am);class xi{constructor(e){this.primary=null,this.changeCallback=e,this.notifyChangeCallback=this.notifyChanged.bind(this),this.updateSecondaryListener=this.updateSecondary.bind(this),this.secondaryPropertyCountsMap={}}setPrimary(e){e!==this.primary&&(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] primary update"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.detachPrimary(this.primary),this.primary=e,this.attachPrimary(e),this.notifyChangeCallback(),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop())}clean(){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] clean"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.detachPrimary(this.primary),this.primary=null,sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}updateSecondary(e,t,s){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] secondary update"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();const i=this.secondaryPropertyCountsMap[s.id];assert&&assert(i>0,"We should always be removing at least one reference");for(let n=0;n<i;n++)this.attachSecondary(e);this.notifyChangeCallback(),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}attachPrimary(e){if(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] attachPrimary"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),O(e))sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] add Property listener"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.secondaryLazyLinkProperty(e),this.attachSecondary(e.get()),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop();else if(e instanceof P)sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] Color changed to immutable"),e.setImmutable();else if(e instanceof st){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] add Gradient listeners"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();for(let t=0;t<e.stops.length;t++)this.attachPrimary(e.stops[t].color);sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}detachPrimary(e){if(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] detachPrimary"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),O(e))sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] remove Property listener"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.secondaryUnlinkProperty(e),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop();else if(e instanceof st){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] remove Gradient listeners"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();for(let t=0;t<e.stops.length;t++)this.detachPrimary(e.stops[t].color);sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}attachSecondary(e){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] attachSecondary"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),e instanceof P&&(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] Color set to immutable"),e.setImmutable()),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}notifyChanged(){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints("[PaintObserver] changed"),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.primary instanceof st&&this.primary.invalidateCanvasGradient(),this.changeCallback(),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}secondaryLazyLinkProperty(e){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[PaintObserver] secondaryLazyLinkProperty ${e._id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();const t=e.id;this.secondaryPropertyCountsMap[t]?this.secondaryPropertyCountsMap[t]++:(this.secondaryPropertyCountsMap[t]=1,e.lazyLink(this.updateSecondaryListener)),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}secondaryUnlinkProperty(e){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[PaintObserver] secondaryUnlinkProperty ${e._id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();const t=e.id,s=--this.secondaryPropertyCountsMap[t];assert&&assert(s>=0,"We should have had a reference before"),s===0&&(delete this.secondaryPropertyCountsMap[t],e.isDisposed||e.unlink(this.updateSecondaryListener)),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}}d.register("PaintObserver",xi);class om extends me{constructor(e,t){const s=hs.toColor(e),i=E()({luminanceFactor:0,valueComparisonStrategy:"equalsFunction"},t);super(s,i),this._paint=null,this._luminanceFactor=i.luminanceFactor,this._changeListener=this.invalidatePaint.bind(this),this._paintObserver=new xi(this._changeListener),this.setPaint(e)}setPaint(e){assert&&assert(hs.isPaintDef(e)),this._paint=e,this._paintObserver.setPrimary(e)}set paint(e){this.setPaint(e)}get paint(){return this.getPaint()}getPaint(){return this._paint}setLuminanceFactor(e){assert&&assert(e>=-1&&e<=1),this.luminanceFactor!==e&&(this._luminanceFactor=e,this.invalidatePaint())}set luminanceFactor(e){this.setLuminanceFactor(e)}get luminanceFactor(){return this.getLuminanceFactor()}getLuminanceFactor(){return this._luminanceFactor}invalidatePaint(){this.value=hs.toColor(this._paint).colorUtilsBrightness(this._luminanceFactor)}dispose(){this.paint=null,super.dispose()}}d.register("PaintColorProperty",om);class qd{constructor(){this.initialize()}initialize(){this.svgBlock=null,this.fillStyle="none",this.strokeStyle="none",this.fillPaint=null,this.strokePaint=null,this.updateBaseStyle(),this.strokeDetailStyle=""}dispose(){this.releaseFillPaint(),this.releaseStrokePaint()}releaseFillPaint(){this.fillPaint&&(this.svgBlock.decrementPaint(this.fillPaint),this.fillPaint=null)}releaseStrokePaint(){this.strokePaint&&(this.svgBlock.decrementPaint(this.strokePaint),this.strokePaint=null)}updateFill(e,t){assert&&assert(this.svgBlock===e);const s=kl(t,e);t!==this.fillPaint&&(this.releaseFillPaint(),t&&t.isPaint&&(this.fillPaint=t,e.incrementPaint(t))),s!==this.fillStyle&&(this.fillStyle=s,this.updateBaseStyle())}updateStroke(e,t){assert&&assert(this.svgBlock===e);const s=kl(t,e);t!==this.strokePaint&&(this.releaseStrokePaint(),t&&t.isPaint&&(this.strokePaint=t,e.incrementPaint(t))),s!==this.strokeStyle&&(this.strokeStyle=s,this.updateBaseStyle())}updateBaseStyle(){this.baseStyle=`fill: ${this.fillStyle}; stroke: ${this.strokeStyle};`}updateStrokeDetailStyle(e){let t="";const s=e.getLineWidth();s!==1&&(t+=`stroke-width: ${s};`);const i=e.getLineCap();i!=="butt"&&(t+=`stroke-linecap: ${i};`);const n=e.getLineJoin();n!=="miter"&&(t+=`stroke-linejoin: ${n};`);const a=e.getMiterLimit();t+=`stroke-miterlimit: ${a};`,e.hasLineDash()&&(t+=`stroke-dasharray: ${e.getLineDash().join(",")};`,t+=`stroke-dashoffset: ${e.getLineDashOffset()};`),this.strokeDetailStyle=t}updateSVGBlock(e){const t=this.svgBlock;t&&(this.fillPaint&&t.decrementPaint(this.fillPaint),this.strokePaint&&t.decrementPaint(this.strokePaint)),this.svgBlock=e,this.fillPaint&&e.incrementPaint(this.fillPaint),this.strokePaint&&e.incrementPaint(this.strokePaint)}}function kl(r,e){return r?r.toCSS?r.toCSS():r.isPaint?`url(#${r.id}-${e?e.id:"noblock"})`:r:"none"}d.register("PaintSVGState",qd);const ji=new P("transparent"),yn=class yn{constructor(e,t,s){this.lastColor=null,this.initialize(e,t,s)}isActiveSVGGradientStop(){return!!this.svgGradient}initialize(e,t,s){return sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] initialize: ${e.gradient.id} : ${t}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.svgGradient=e,this.color=s,this.ratio=t,this.svgElement=this.svgElement||document.createElementNS(ne,"stop"),this.svgElement.setAttribute("offset",""+t),this.dirty=!0,this.update(),this.propertyListener=this.propertyListener||this.onPropertyChange.bind(this),this.colorListener=this.colorListener||this.markDirty.bind(this),O(s)?(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] adding Property listener: ${this.svgGradient.gradient.id} : ${this.ratio}`),s.lazyLink(this.propertyListener),s.value instanceof P&&(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] adding Color listener: ${this.svgGradient.gradient.id} : ${this.ratio}`),s.value.changeEmitter.addListener(this.colorListener),this.lastColor=s.value)):s instanceof P&&(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] adding Color listener: ${this.svgGradient.gradient.id} : ${this.ratio}`),s.changeEmitter.addListener(this.colorListener)),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop(),this}onPropertyChange(e,t){assert&&assert(this.isActiveSVGGradientStop());const s=this;this.lastColor!==null&&(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] removing Color listener: ${s.svgGradient.gradient.id} : ${this.ratio}`),this.lastColor.changeEmitter.removeListener(this.colorListener),this.lastColor=null),e instanceof P&&(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] adding Color listener: ${s.svgGradient.gradient.id} : ${this.ratio}`),e.changeEmitter.addListener(this.colorListener),this.lastColor=e),this.markDirty()}markDirty(){assert&&assert(this.isActiveSVGGradientStop()),this.dirty=!0,this.svgGradient.markDirty()}update(){if(!this.dirty)return;this.dirty=!1,assert&&assert(this.isActiveSVGGradientStop());const e=this;sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] update: ${e.svgGradient.gradient.id} : ${this.ratio}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();let t=this.color;O(t)&&(t=t.value),t===null&&(t="transparent"),typeof t=="string"?ji.setCSS(t):ji.set(t);const s=`stop-opacity: ${ji.a.toFixed(20)};`;ji.alpha=1;const i=`stop-color: ${ji.toCSS()};`;this.svgElement.setAttribute("style",`${i} ${s}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}dispose(){assert&&assert(this.isActiveSVGGradientStop());const e=this;sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] dispose: ${e.svgGradient.gradient.id} : ${this.ratio}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();const t=this.color;this.lastColor&&(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] removing Color listener: ${e.svgGradient.gradient.id} : ${this.ratio}`),this.lastColor.changeEmitter.removeListener(this.colorListener),this.lastColor=null),O(t)?(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] removing Property listener: ${e.svgGradient.gradient.id} : ${this.ratio}`),t.hasListener(this.propertyListener)&&t.unlink(this.propertyListener)):t instanceof P&&(sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradientStop] removing Color listener: ${e.svgGradient.gradient.id} : ${this.ratio}`),t.changeEmitter.removeListener(this.colorListener)),this.color=null,this.svgGradient=null,this.freeToPool(),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}freeToPool(){yn.pool.freeToPool(this)}};yn.pool=new nt(yn);let gr=yn;d.register("SVGGradientStop",gr);class ih{constructor(e,t){this.initialize(e,t)}isActiveSVGGradient(){return!!this.svgBlock}initialize(e,t){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradient] initialize ${t.id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.svgBlock=e,this.gradient=t;const s=this.definition!==void 0;this.definition=this.definition||this.createDefinition(),s||this.definition.setAttribute("gradientUnits","userSpaceOnUse"),t.transformMatrix?this.definition.setAttribute("gradientTransform",t.transformMatrix.getSVGTransform()):this.definition.removeAttribute("gradientTransform");const i=t.getSVGStops();this.stops=ee(this.stops);for(let n=0;n<i.length;n++){const a=new gr(this,i[n].ratio,i[n].color);this.stops.push(a),this.definition.appendChild(a.svgElement)}this.dirty=!1,sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}markDirty(){if(!this.dirty){assert&&assert(this.isActiveSVGGradient());const e=this;sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradient] switched to dirty: ${this.gradient.id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),this.dirty=!0,e.svgBlock.markDirtyGradient(this),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}}update(){if(this.dirty){this.dirty=!1,sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradient] update: ${this.gradient.id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();for(let e=0;e<this.stops.length;e++)this.stops[e].update();sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}}dispose(){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGGradient] dispose ${this.gradient.id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();for(let e=0;e<this.stops.length;e++){const t=this.stops[e];this.definition.removeChild(t.svgElement),t.dispose()}ee(this.stops),this.svgBlock=null,this.gradient=null,this.freeToPool(),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop()}}d.register("SVGGradient",ih);const bn=class bn extends ih{constructor(e,t){super(e,t)}initialize(e,t){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGLinearGradient] initialize ${t.id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),super.initialize(e,t);const s=t;return this.definition.setAttribute("x1",""+s.start.x),this.definition.setAttribute("y1",""+s.start.y),this.definition.setAttribute("x2",""+s.end.x),this.definition.setAttribute("y2",""+s.end.y),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop(),this}createDefinition(){return document.createElementNS(ne,"linearGradient")}freeToPool(){bn.pool.freeToPool(this)}};bn.pool=new nt(bn);let mr=bn;d.register("SVGLinearGradient",mr);const Ln=class Ln extends ih{constructor(e,t){super(e,t)}initialize(e,t){return sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGRadialGradient] initialize ${t.id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push(),super.initialize(e,t),this.definition.setAttribute("cx",""+t.largePoint.x),this.definition.setAttribute("cy",""+t.largePoint.y),this.definition.setAttribute("r",""+t.maxRadius),this.definition.setAttribute("fx",""+t.focalPoint.x),this.definition.setAttribute("fy",""+t.focalPoint.y),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop(),this}createDefinition(){return document.createElementNS(ne,"radialGradient")}freeToPool(){Ln.pool.freeToPool(this)}};Ln.pool=new nt(Ln);let fr=Ln;d.register("SVGRadialGradient",fr);const vn=class vn{constructor(e){this.initialize(e)}initialize(e){sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`[SVGPattern] initialize: ${e.id}`),sceneryLog&&sceneryLog.Paints&&sceneryLog.push();const t=this.definition!==void 0;return this.definition=this.definition||document.createElementNS(ne,"pattern"),t||(this.definition.setAttribute("patternUnits","userSpaceOnUse"),this.definition.setAttribute("patternContentUnits","userSpaceOnUse")),e.transformMatrix?this.definition.setAttribute("patternTransform",e.transformMatrix.getSVGTransform()):this.definition.removeAttribute("patternTransform"),this.definition.setAttribute("x","0"),this.definition.setAttribute("y","0"),this.definition.setAttribute("width",""+e.image.width),this.definition.setAttribute("height",""+e.image.height),this.imageElement=this.imageElement||document.createElementNS(ne,"image"),this.imageElement.setAttribute("x","0"),this.imageElement.setAttribute("y","0"),this.imageElement.setAttribute("width",`${e.image.width}px`),this.imageElement.setAttribute("height",`${e.image.height}px`),this.imageElement.setAttributeNS(vi,"xlink:href",e.image.src),t||this.definition.appendChild(this.imageElement),sceneryLog&&sceneryLog.Paints&&sceneryLog.pop(),this}update(){}dispose(){this.freeToPool()}freeToPool(){vn.pool.freeToPool(this)}};vn.pool=new nt(vn);let yr=vn;d.register("SVGPattern",yr);class Qd{constructor(e,t){this._matrices=null,this._dirtyIndex=0,this._listeners=[],this._nodeTransformListeners=[];const s=E()({isStatic:!1},t);this._isStatic=s.isStatic,this.trail=e,this._nodeTransformListeners=[];for(let i=1;i<this.trail.length;i++){const n=(a=>()=>{this.onTransformChange(a)})(i-1);this._nodeTransformListeners.push(n),e.nodes[i].transformEmitter.addListener(n)}}dispose(){for(let e=1;e<this.trail.length;e++){const t=this._nodeTransformListeners[e-1];this.trail.nodes[e].transformEmitter.hasListener(t)&&this.trail.nodes[e].transformEmitter.removeListener(t)}}addListener(e){this._listeners.push(e)}removeListener(e){const t=_.indexOf(this._listeners,e);assert&&assert(t>=0,"TransformTracker listener not found"),this._listeners.splice(t,1)}notifyListeners(){let e=this._listeners;this._isStatic||(e=e.slice());const t=e.length;for(let s=0;s<t;s++)e[s]()}onTransformChange(e){this._dirtyIndex=Math.min(this._dirtyIndex,e),this.notifyListeners()}getMatrix(){if(this._matrices===null){this._matrices=[];for(let t=1;t<this.trail.length;t++)this._matrices.push(new C)}if(this._matrices.length<=0)return C.IDENTITY;const e=this._matrices.length;for(let t=this._dirtyIndex;t<e;t++){const s=this.trail.nodes[t+1].matrix;t===0?this._matrices[t].set(s):(this._matrices[t].set(this._matrices[t-1]),this._matrices[t].multiplyMatrix(s))}return this._dirtyIndex=e,this._matrices[e-1]}get matrix(){return this.getMatrix()}}d.register("TransformTracker",Qd);const Js=Qd;class Zd{constructor(e,t){t=Je({isStatic:!1},t),this.isStatic=t.isStatic,this.trail=e,this._listeners=[],this.trailVisibleProperty=new X(this.trail.isVisible()),this._nodeVisibilityListeners=[];for(let s=0;s<this.trail.length;s++){const i=()=>{this.trailVisibleProperty.set(e.isVisible())};this._nodeVisibilityListeners.push(i),e.nodes[s].visibleProperty.link(i)}this.boundTrailVisibilityChangedListener=this.onVisibilityChange.bind(this),this.trailVisibleProperty.link(this.boundTrailVisibilityChangedListener)}addListener(e){assert&&assert(typeof e=="function"),this._listeners.push(e)}removeListener(e){assert&&assert(typeof e=="function");const t=_.indexOf(this._listeners,e);assert&&assert(t>=0,"TrailVisibilityTracker listener not found"),this._listeners.splice(t,1)}dispose(){for(let e=0;e<this.trail.length;e++){const t=this._nodeVisibilityListeners[e];this.trail.nodes[e].visibleProperty.hasListener(t)&&this.trail.nodes[e].visibleProperty.removeListener(t)}this.trailVisibleProperty.unlink(this.boundTrailVisibilityChangedListener)}onVisibilityChange(){this.notifyListeners()}notifyListeners(){let e=this._listeners;this._isStatic||(e=e.slice());const t=e.length;for(let s=0;s<t;s++)e[s]()}}d.register("TrailVisibilityTracker",Zd);const hm={mutateNode(r,e){e?r.setPDOMAttribute("aria-haspopup",e):(assert&&assert(r.hasPDOMAttribute("aria-haspopup"),"Set aria-haspopup once before removing it."),r.removePDOMAttribute("aria-haspopup")),r.positionInPDOM=!!e}};d.register("AriaHasPopUpMutator",hm);class lm extends D{constructor(e){const t=E()({headingLevel:1},e);super(t),this.tagName=`h${t.headingLevel}`,this.focusHighlight="invisible";const s={blur:()=>{this.focusable=!1}};this.addInputListener(s),this.disposeFocusableHeadingNode=()=>{this.removeInputListener(s)}}focus(){this.focusable=!0,super.focus()}dispose(){this.disposeFocusableHeadingNode(),super.dispose()}}d.register("FocusableHeadingNode",lm);const Ke=" ",or="End of Document",Gt=",",qi=15,Xe="NEXT",zs="PREVIOUS";class cm{constructor(e){const t=this;this.outputUtteranceProperty=new me(new Qi(document.title,"off")),this.linearDOM=this.getLinearDOMElements(e),this.activeElement=null,this.activeLine=null,this.letterPosition=0,this.positionInLine=0,this.wordPosition=0,this.observers=[],this.keyState={},document.addEventListener("keydown",s=>{this.keyState[s.keyCode]=!0;let i;const a=s.shiftKey?zs:Xe;if(this.linearDOM=this.getLinearDOMElements(e),this.updateLiveElementList(),!(this.activeElement&&this.activeElement.getAttribute("role")==="application")){if(this.keyState[40]&&!this.keyState[45])i=this.readNextPreviousLine(Xe);else if(this.keyState[38]&&!this.keyState[45])i=this.readNextPreviousLine(zs);else if(this.keyState[72]){const o=["H1","H2","H3","H4","H5","H6"];i=this.readNextPreviousHeading(o,a)}else this.keyState[9]||(this.keyState[39]&&!this.keyState[17]?i=this.readNextPreviousCharacter(Xe):this.keyState[37]&&!this.keyState[17]?i=this.readNextPreviousCharacter(zs):this.keyState[37]&&this.keyState[17]?i=this.readNextPreviousWord(zs):this.keyState[39]&&this.keyState[17]?i=this.readNextPreviousWord(Xe):this.keyState[45]&&this.keyState[38]?i=this.readActiveLine():this.keyState[49]?i=this.readNextPreviousHeading(["H1"],a):this.keyState[50]?i=this.readNextPreviousHeading(["H2"],a):this.keyState[51]?i=this.readNextPreviousHeading(["H3"],a):this.keyState[52]?i=this.readNextPreviousHeading(["H4"],a):this.keyState[53]?i=this.readNextPreviousHeading(["H5"],a):this.keyState[54]?i=this.readNextPreviousHeading(["H6"],a):this.keyState[70]?i=this.readNextPreviousFormElement(a):this.keyState[66]?i=this.readNextPreviousButton(a):this.keyState[76]?i=this.readNextPreviousList(a):this.keyState[73]?i=this.readNextPreviousListItem(a):this.keyState[45]&&this.keyState[40]&&this.readEntireDocument());this.activeElement&&this.isFocusable(this.activeElement)&&this.activeElement.focus(),i===Ke&&(i="space"),i&&this.outputUtteranceProperty.set(new Qi(i,"off"))}}),document.addEventListener("keyup",s=>{this.keyState[s.keyCode]=!1}),document.addEventListener("focusin",function(s){if(s.target!==t.activeElement){t.activeElement=s.target;const n=t.getAccessibleText(this.activeElement,!0);if(n){const a=t.activeElement.getAttribute("aria-live");t.outputUtteranceProperty.set(new Qi(n,a))}}})}getLinearDOMElements(e){const t=e.getElementsByTagName("*"),s=[];for(let i=0;i<t.length;i++)t[i].nodeType===Node.ELEMENT_NODE&&(s[i]=t[i]);return s}getLiveRole(e){let t=null;return["log","status","alert","progressbar","marquee","timer","assertive","polite"].forEach(i=>{(e.getAttribute("aria-live")===i||e.getAttribute("role")===i)&&(t=i)}),t}getNextPreviousElement(e){this.activeElement||(this.activeElement=this.linearDOM[0]);const t=e==="NEXT"?1:-1,i=this.linearDOM.indexOf(this.activeElement)+t;return this.linearDOM[i]}getLabel(e){const t=document.getElementsByTagName("label");let s;return Array.prototype.forEach.call(t,i=>{i.getAttribute("for")&&(s=i)}),assert&&assert(s,"No label found for id"),s}getAccessibleText(e,t){let s="";if(!e)return or;if(e.getAttribute("class")==="ScreenView"||e.tagName==="HEADER"||e.tagName==="SECTION"||e.tagName==="LABEL")return null;let i=e;for(;i.parentElement;){if(i.getAttribute("aria-hidden")||i.hidden)return null;i=i.parentElement}if(e.tagName==="P"&&(s+=e.textContent),e.tagName==="H1"&&(s+=`Heading Level 1, ${e.textContent}`),e.tagName==="H2"&&(s+=`Heading Level 2, ${e.textContent}`),e.tagName==="H3"&&(s+=`Heading Level 3, ${e.textContent}`),e.tagName==="UL"){const n=e.children.length;s+=`List with ${n} items`}if(e.tagName==="LI"&&(s+=`List Item: ${e.textContent}`),e.tagName==="BUTTON"){const n=" Button";if(e.getAttribute("aria-pressed")){let a=" toggle";const o=" pressed",h=" not";a+=n+Gt,e.getAttribute("aria-pressed")==="true"?a+=o:a+=h+o,s+=e.textContent+Gt+a}else s+=e.textContent+n}if(e.tagName==="INPUT"&&(e.type==="reset"&&(s+=`${e.getAttribute("value")} Button`),e.type==="checkbox")){const a=this.getLabel(e.id).textContent;if(e.getAttribute("role")==="switch"){const o=e.getAttribute("aria-checked");if(o){const h=o==="true"?"On":"Off";s+=`${a+Gt+Ke}switch${Gt}${Ke}${h}`}else assert&&assert(!1,"checkbox switch must have aria-checked attribute")}else{const o=e.checked?" Checked":" Not Checked";s+=`${e.textContent} Checkbox${o}`}}if(t){s.length>0&&(s+=Gt);const n=e.getAttribute("aria-label");n&&(s+=Ke+n+Gt);const a=e.getAttribute("aria-labelledBy");if(a){const c=document.getElementById(a).textContent;s+=Ke+c+Gt}i=e;let o;for(;i.parentElement;)if(o=i.getAttribute("role"),o==="document"||o==="application"){s+=Ke+o+Gt;break}else i=i.parentElement;e.getAttribute("role")&&(o=e.getAttribute("role"),o==="button"&&(s+=`${Ke}Button`)),e.draggable&&(s+=`${Ke}draggable${Gt}`),e.getAttribute("aria-grabbed")==="true"&&(s+=`${Ke}grabbed${Gt}`);const h=e.getAttribute("aria-describedby");if(h){const l=h.split(Ke);let c,u;l.forEach(m=>{c=document.getElementById(m),u=c.textContent,s+=Ke+u})}}return s[s.length-1]===","&&(s=s.slice(0,-1)),s}getNextPreviousElementWithPDOMContent(e){let t;for(;!t;)this.activeElement=this.getNextPreviousElement(e),t=this.getAccessibleText(this.activeElement,!1);return this.activeElement}getNextPreviousElementWithRole(e,t){let s=null;const i=t===Xe?1:-1;this.activeElement||(this.activeElement=this.linearDOM[0]);let n=this.linearDOM.indexOf(this.activeElement)+i;for(;this.linearDOM[n];){for(let a=0;a<e.length;a++){const o=this.linearDOM[n].tagName,h=this.linearDOM[n].type,l=this.linearDOM[n].getAttribute("role"),c=e[a];if(o===c||l===c||h===c){s=this.linearDOM[n];break}}if(s)break;n+=i}return s}readNextPreviousLine(e){let t="";this.letterPosition=0,this.wordPosition=0,this.activeElement||(this.activeElement=this.getNextPreviousElementWithPDOMContent(e));let s=this.getAccessibleText(this.activeElement,!1).split(Ke);if(e===zs&&(this.positionInLine=this.positionInLine-2*qi),!s[this.positionInLine]){this.positionInLine=0;const n=this.activeElement;this.activeElement=this.getNextPreviousElementWithPDOMContent(e),s=this.getAccessibleText(this.activeElement,!1).split(" "),this.activeElement||(this.activeElement=n)}const i=this.positionInLine+qi;for(let n=this.positionInLine;n<i;n++)if(s[n])if(t+=s[n],this.positionInLine+=1,s[n+1])t+=Ke;else{this.positionInLine+=qi-this.positionInLine%qi;break}return this.activeLine=t,t}readActiveLine(){let e="";this.activeLine||(this.activeLine=this.readNextPreviousLine(Xe));const t=this.activeLine.split(Ke);for(let s=0;s<qi;s++)if(t[s])if(e+=t[s],t[s+1])e+=Ke;else break;return e}readNextPreviousWord(e){this.activeLine||(this.activeLine=this.readNextPreviousLine(e));const t=this.activeLine.split(Ke);let s,i;e===Xe?(i=t.length,s=1):e===zs&&(i=0,s=-2),this.wordPosition===i&&(this.activeLine=this.readNextPreviousLine(e));const n=t[this.wordPosition];return this.wordPosition+=s,n}readNextPreviousHeading(e,t){let s,i,n;for(;!s;)n=this.activeElement,i=this.getNextPreviousElementWithRole(e,t),this.activeElement=i,s=this.getAccessibleText(i);if(!i){this.activeElement=n;const a=t===Xe?"more":"previous";if(e.length===1){const o=`No ${a} headings at `,h=e[0];return o+(h==="H1"?"Level 1":h==="H2"?"Level 2":h==="H3"?"Level 3":h==="H4"?"Level 4":h==="H5"?"Level 5":"Level 6")}return`No ${a} headings`}return this.activeElement=i,s}readNextPreviousButton(e){const t=["button","BUTTON","submit","reset"];let s,i,n;for(;!i;)n=this.activeElement,s=this.getNextPreviousElementWithRole(t,e),this.activeElement=s,i=this.getAccessibleText(s,!0);return s?(this.activeElement=s,i):(this.activeElement=n,`No ${e===Xe?"more":"previous"} buttons`)}readNextPreviousFormElement(e){const t=["INPUT","BUTTON"],s=["button"],i=t.concat(s);let n,a,o;for(;!a;)o=this.activeElement,n=this.getNextPreviousElementWithRole(i,e),this.activeElement=n,a=this.getAccessibleText(n,!0);return a===or?(this.activeElement=o,`No ${e===Xe?"next":"previous"} form field`):(this.activeElement=n,a)}readNextPreviousListItem(e){this.activeElement||(this.activeElement=this.getNextPreviousElementWithPDOMContent(e));let t;const s=this.activeElement.parentElement;if(s.tagName==="UL"||s.tagName==="OL"){const i=e===Xe?1:-1;let n=Array.prototype.indexOf.call(s.children,this.activeElement)+i;for(;s.children[n];){if(t=this.getAccessibleText(s.children[n]),t){this.activeElement=s.children[n];break}n+=i}t||(t=this.readNextPreviousList(e))}else t=this.readNextPreviousList(e);return t||`No ${e===Xe?"more":"previous"} list items`}readNextPreviousList(e){this.activeElement||(this.activeElement=this.getNextPreviousElementWithPDOMContent(e));const t=this.activeElement.parentElement;let s;(t.tagName==="UL"||t.tagName==="OL")&&(s=this.activeElement,this.activeElement=t);const i=this.getNextPreviousElementWithRole(["UL","OL"],e);if(!i)return s&&(this.activeElement=s),`No ${e===Xe?"more":"previous"} lists`;const n=this.getAccessibleText(i);let a="";const o=i.children[0];return o&&(a=this.getAccessibleText(o),this.activeElement=o),`${n}, ${a}`}readNextPreviousCharacter(e){this.activeLine||(this.activeLine=this.readNextPreviousLine(Xe));let t,s,i;e===Xe?(t=this.activeLine.length,s=1,i=0):e===zs&&(t=2,s=-1,i=-2),this.letterPosition===t&&(this.activeLine=this.readNextPreviousLine(e),this.letterPosition=this.activeLine.length);const n=this.activeLine[this.letterPosition+i];return this.letterPosition+=s,n}updateLiveElementList(){for(let e=0;e<this.observers.length;e++)this.observers[e]&&this.observers[e].disconnect();this.observers=[];for(let e=0;e<this.linearDOM.length;e++){const t=this.linearDOM[e];if(this.getLiveRole(t)){const i=o=>{o.forEach(h=>{let l,c=h.target;for(;!l;)l=this.getLiveRole(c),c=c.parentElement;if(h.addedNodes[0]){const u=h.addedNodes[0].data;this.outputUtteranceProperty.set(new Qi(u,l))}})},n=new MutationObserver(o=>{i(o)}),a={childList:!0,subtree:!0};n.observe(t,a),this.observers.push(n)}}}readEntireDocument(){const e="polite";let t=this.getAccessibleText(this.activeElement),s=this.activeElement;for(;t!==or;)s=this.activeElement,t=this.readNextPreviousLine(Xe),t===or&&(this.activeElement=s),this.outputUtteranceProperty.set(new Qi(t,e))}isFocusable(e){const t=["tabindex","BUTTON","INPUT"];let s=!1;return t.forEach(i=>{(e.getAttribute(i)||e.tagName===i)&&(s=!0)}),s}}d.register("Cursor",cm);let Qi=class{constructor(e,t){this.text=e,this.liveRole=t}};const Ca={validateValidator:!1},Jd=[];assert&&Object.freeze(Jd);const dm=["name","phetioType","phetioDocumentation","phetioPrivate"].concat(Dt.VALIDATOR_KEYS),Al=r=>r.phetioType,um=r=>r.name;class Vn extends _e{constructor(e){var i;const t=E()({parameters:Jd,hasListenerOrderDependencies:!1,phetioPlayback:_e.DEFAULT_OPTIONS.phetioPlayback,phetioEventMetadata:_e.DEFAULT_OPTIONS.phetioEventMetadata,phetioDocumentation:""},e);assert&&Vn.validateParameters(t.parameters,!!((i=t.tandem)!=null&&i.supplied)),assert&&assert(t.phetioType===void 0,"PhetioDataHandler sets its own phetioType. Instead provide parameter phetioTypes through `options.parameters` with a phetioOuterType");const s=t.parameters.filter(Al);t.phetioType=t.phetioOuterType(s.map(Al)),t.phetioPlayback&&(t.phetioEventMetadata=t.phetioEventMetadata||{},assert&&assert(!t.phetioEventMetadata.hasOwnProperty("dataKeys"),"dataKeys should be supplied by PhetioDataHandler, not elsewhere"),t.phetioEventMetadata.dataKeys=t.parameters.map(um)),t.phetioDocumentation=Vn.getPhetioDocumentation(t.phetioDocumentation,s),super(t),this.parameters=t.parameters}static validateParameters(e,t){Es(e,{valueType:Array});let s=!1;for(let i=0;i<e.length;i++){const n=e[i];assert&&assert(Object.getPrototypeOf(n)===Object.prototype,"Extra prototype on parameter object is a code smell"),s=s||n.phetioPrivate,assert&&s&&assert(n.phetioPrivate,"after first phetioPrivate parameter, all subsequent parameters must be phetioPrivate"),assert&&t&&se.VALIDATION&&assert(n.phetioType||n.phetioPrivate,"instrumented Emitters must include phetioType for each parameter or be marked as `phetioPrivate`."),assert&&n.phetioType&&assert(n.name,"`name` is a required parameter for phet-io instrumented parameters."),assert&&Ge(n,["phetioPrivate"],["name","phetioType","phetioDocumentation"]),assert&&assert(_.intersection(Object.keys(n),Dt.VALIDATOR_KEYS).length>0,`validator must be specified for parameter ${i}`);for(const a in n)assert&&assert(dm.includes(a),`unrecognized parameter key: ${a}`);assert&&Object.freeze(e[i]),Dt.validateValidator(n)}assert&&Object.freeze(e)}validateArguments(...e){assert&&assert(e.length===this.parameters.length,`Emitted unexpected number of args. Expected: ${this.parameters.length} and received ${e.length}`);for(let t=0;t<this.parameters.length;t++){const s=this.parameters[t];assert&&Es(e[t],s,Ca),s.phetioType&&!s.valueType&&assert&&Es(e[t],s.phetioType.validator,Ca)}}getValidationErrors(...e){return assert&&assert(e.length===this.parameters.length,`Emitted unexpected number of args. Expected: ${this.parameters.length} and received ${e.length}`),this.parameters.map((t,s)=>Dt.getValidationError(e[s],t,Ca))}getPhetioData(...e){assert&&assert(se.PHET_IO_ENABLED,"should only get phet-io data in phet-io brand");let t=null;if(this.parameters.length>0){t={};for(let s=0;s<this.parameters.length;s++){const i=this.parameters[s];i.phetioPrivate||(assert&&assert(i.name,"name required"),t[i.name]=i.phetioType.toStateObject(e[s]))}}return t}static getPhetioDocumentation(e,t){const s=i=>{const n=i.phetioDocumentation?` - ${i.phetioDocumentation}`:"";return`<li>${i.name}: ${i.phetioType.typeName}${n}</li>`};return e+(t.length===0?"<br>No parameters.":`<br>The parameters are:<br/><ol>${t.map(s).join("<br/>")}</ol>`)}}it.register("PhetioDataHandler",Vn);const eu=Vn,xl=!1,$s=class $s extends eu{constructor(e){const t=E()({reentrantNotificationStrategy:"stack",phetioOuterType:$s.EmitterIO,phetioState:xl},e);super(t),this.tinyEmitter=new re(null,t.hasListenerOrderDependencies,t.reentrantNotificationStrategy)}emit(...e){assert&&assert(this.tinyEmitter instanceof re,"Emitter should not emit until constructor complete"),assert&&this.validateArguments(...e),se.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&this.phetioStartEvent("emitted",{data:this.getPhetioData(...e)}),this.tinyEmitter.emit(...e),se.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&this.phetioEndEvent()}dispose(){this.tinyEmitter.dispose(),super.dispose()}addListener(e){this.tinyEmitter.addListener(e)}removeListener(e){this.tinyEmitter.removeListener(e)}removeAllListeners(){this.tinyEmitter.removeAllListeners()}hasListener(e){return this.tinyEmitter.hasListener(e)}hasListeners(){return this.tinyEmitter.hasListeners()}getListenerCount(){return this.tinyEmitter.getListenerCount()}debug(e){const t=(...s)=>console.log(e,...s);return this.addListener(t),t}};$s.EmitterIO=e=>{const t=e.map(Ol).join(",");return Ia.has(t)||Ia.set(t,new Le(`EmitterIO<${e.map(Ol).join(", ")}>`,{valueType:$s,documentation:"Emits when an event occurs and calls added listeners.",parameterTypes:e,events:["emitted"],metadataDefaults:{phetioState:xl},methods:{addListener:{returnType:mt,parameterTypes:[qa(mt,e)],implementation:$s.prototype.addListener,documentation:"Adds a listener which will be called when the emitter emits."},removeListener:{returnType:mt,parameterTypes:[qa(mt,e)],implementation:$s.prototype.removeListener,documentation:"Remove a listener."},emit:{returnType:mt,parameterTypes:e,implementation:function(...s){this.emit(...s)},documentation:"Emits a single event to all listeners.",invocableForReadOnlyElements:!1},getValidationErrors:{returnType:Un(V(ge)),parameterTypes:e,implementation:function(...s){return this.getValidationErrors(...s)},documentation:"Checks to see if the proposed values are valid. Returns an array of length N where each element is an error (string) or null if the value is valid."}}})),Ia.get(t)};let He=$s;const Ol=r=>r.typeName,Ia=new Ni;it.register("Emitter",He);class pm{constructor(e){this.speakingStartedEmitter=new He({parameters:[{valueType:Object}]}),this.speakingEndedEmitter=new He({parameters:[{valueType:Object}]}),this.speaking=!1,this.politeUtterances=[];const t=navigator.userAgent,s=t.match(/Windows/),i=!!(t.match(/Version\/[5-9]\./)&&t.match(/Safari\//)&&t.match(/AppleWebKit/));window.speechSynthesis&&SpeechSynthesisUtterance&&window.speechSynthesis.speak?(this.synth=window.speechSynthesis,e.outputUtteranceProperty.link(n=>{const a=new SpeechSynthesisUtterance(n.text);a.addEventListener("start",h=>{this.speakingStartedEmitter.emit(n)}),a.addEventListener("end",h=>{this.speakingEndedEmitter.emit(n)});let o;if(this.synth.getVoices().forEach(h=>{h.default&&(o=h)}),a.voice=o,a.rate=1.2,n.liveRole==="assertive"||n.liveRole==="off"||!n.liveRole)this.politeUtterances=[],this.speaking=!0,s?(this.synth.pause(),this.synth.cancel(),this.synth.speak(a),this.synth.resume()):(this.synth.cancel(),this.synth.speak(a));else if(n.liveRole==="polite")if(i){this.politeUtterances.push(a);const h=()=>{this.speaking=!0;const l=this.politeUtterances.shift();l?this.synth.speak(l):this.speaking=!1};if(this.speaking)setTimeout(()=>{h()},2e3);else{this.synth.speak(a);const l=this.politeUtterances.indexOf(a);l>0&&this.politeUtterances.splice(l,1)}}else this.synth.speak(a)})):e.outputUtteranceProperty.link(()=>{this.speakingStartedEmitter.emit({text:"Sorry! Web Speech API not supported on this platform."})})}}d.register("Reader",pm);const gm=[],Ml=!1,Pn=class Pn extends eu{constructor(e,t){var i;const s=E()({parameters:gm,phetioOuterType:Pn.PhetioActionIO,phetioState:Ml,phetioReadOnly:_e.DEFAULT_OPTIONS.phetioReadOnly,phetioHighFrequency:_e.DEFAULT_OPTIONS.phetioHighFrequency,phetioEventType:_e.DEFAULT_OPTIONS.phetioEventType,phetioDocumentation:"A class that wraps a function, adding API to execute that function and data stream capture."},t);super(s),this.action=e,this.isExecutingCount=0,this.disposeOnExecuteCompletion=!1,this.executedEmitter=new He({parameters:s.parameters,tandem:(i=s.tandem)==null?void 0:i.createTandem("executedEmitter"),hasListenerOrderDependencies:s.hasListenerOrderDependencies,phetioState:s.phetioState,phetioReadOnly:s.phetioReadOnly,phetioHighFrequency:s.phetioHighFrequency,phetioEventType:s.phetioEventType,phetioDocumentation:"Emitter that emits when this actions work is complete"}),this.disposePhetioAction=()=>{this.executedEmitter.dispose()}}execute(...e){assert&&assert(!this.isDisposed,"should not be called if disposed"),assert&&assert(!this.executedEmitter.isDisposed,"self should not be disposed"),this.isExecutingCount++,assert&&super.validateArguments(...e),se.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&this.phetioStartEvent("executed",{data:this.getPhetioData(...e)}),this.action.apply(null,e),this.executedEmitter.emit(...e),se.PHET_IO_ENABLED&&this.isPhetioInstrumented()&&this.phetioEndEvent(),this.isExecutingCount--,this.disposeOnExecuteCompletion&&this.isExecutingCount===0&&(this.disposePhetioAction(),this.disposeOnExecuteCompletion=!1)}dispose(){this.isExecutingCount>0?this.disposeOnExecuteCompletion=!0:this.disposePhetioAction(),super.dispose()}};Pn.PhetioActionIO=e=>{const t=e.map(Rl).join(",");return Ea.has(t)||Ea.set(t,new Le(`PhetioActionIO<${e.map(Rl).join(", ")}>`,{valueType:Pn,documentation:"Executes when an event occurs",events:["executed"],parameterTypes:e,metadataDefaults:{phetioState:Ml},methods:{execute:{returnType:mt,parameterTypes:e,implementation:function(...s){this.execute(...s)},documentation:"Executes the function the PhetioAction is wrapping.",invocableForReadOnlyElements:!1},getValidationErrors:{returnType:Un(V(ge)),parameterTypes:e,implementation:function(...s){return this.getValidationErrors(...s)},documentation:"Checks to see if the proposed values are valid. Returns an array of length N where each element is an error (string) or null if the value is valid."}}})),Ea.get(t)};let br=Pn;const Rl=r=>r.typeName,Ea=new Ni;Hs.register("PhetioAction",br);const q=br,tu=new gp;it.register("stepTimer",tu);const Oe=tu;class su{constructor(e){var s,i;this.keyState={},this._lastKeyDown=null,this.attachedToDocument=!1,this.documentKeyupListener=null,this.documentKeydownListener=null,this.documentBlurListener=null,this._enabled=!0,this.keydownEmitter=new He({parameters:[{valueType:KeyboardEvent}]}),this.keyupEmitter=new He({parameters:[{valueType:KeyboardEvent}]}),this.keyDownStateChangedEmitter=new He({parameters:[{valueType:[KeyboardEvent,null]}]}),this.keydownUpdateAction=new q(n=>{const a=g.getEventCode(n);if(a){if(this.correctModifierKeys(n),assert&&!g.isShiftKey(n)&&assert(n.shiftKey===this.shiftKeyDown,"shift key inconsistency between event and keyState."),assert&&!g.isAltKey(n)&&assert(n.altKey===this.altKeyDown,"alt key inconsistency between event and keyState."),assert&&!g.isControlKey(n)&&assert(n.ctrlKey===this.ctrlKeyDown,"ctrl key inconsistency between event and keyState."),assert&&!g.isMetaKey(n)&&assert(n.metaKey===this.metaKeyDown,"meta key inconsistency between event and keyState."),!this.isKeyDown(a)){const o=g.getEventCode(n);assert&&assert(o,"Could not find key from domEvent"),this.keyState[o]={key:o,timeDown:0}}this._lastKeyDown=a,this.keydownEmitter.emit(n),this.keyDownStateChangedEmitter.emit(n)}},{phetioPlayback:!0,tandem:(s=e==null?void 0:e.tandem)==null?void 0:s.createTandem("keydownUpdateAction"),parameters:[{name:"event",phetioType:xs}],phetioEventType:Z.USER,phetioDocumentation:"Action that executes whenever a keydown occurs from the input listeners this keyStateTracker adds (most likely to the document)."}),this.keyupUpdateAction=new q(n=>{const a=g.getEventCode(n);a&&(this.correctModifierKeys(n),this.isKeyDown(a)&&delete this.keyState[a],Te.mac&&g.isMetaKey(n)&&this.clearState(!0),this.keyupEmitter.emit(n),this.keyDownStateChangedEmitter.emit(n))},{phetioPlayback:!0,tandem:(i=e==null?void 0:e.tandem)==null?void 0:i.createTandem("keyupUpdateAction"),parameters:[{name:"event",phetioType:xs}],phetioEventType:Z.USER,phetioDocumentation:"Action that executes whenever a keyup occurs from the input listeners this keyStateTracker adds (most likely to the document)."});const t=this.step.bind(this);Oe.addListener(t),this.disposeKeyStateTracker=()=>{Oe.removeListener(t),this.attachedToDocument&&this.detachFromDocument()}}keydownUpdate(e){this.enabled&&this.keydownUpdateAction.execute(e)}correctModifierKeys(e){const t=g.getEventCode(e);assert&&assert(t,"key not found from domEvent");let s=!1;e.shiftKey&&!g.isShiftKey(e)&&!this.shiftKeyDown&&(s=s||!this.keyState[g.KEY_SHIFT_LEFT],this.keyState[g.KEY_SHIFT_LEFT]={key:t,timeDown:0}),e.altKey&&!g.isAltKey(e)&&!this.altKeyDown&&(s=s||!this.keyState[g.KEY_ALT_LEFT],this.keyState[g.KEY_ALT_LEFT]={key:t,timeDown:0}),e.ctrlKey&&!g.isControlKey(e)&&!this.ctrlKeyDown&&(s=s||!this.keyState[g.KEY_CONTROL_LEFT],this.keyState[g.KEY_CONTROL_LEFT]={key:t,timeDown:0}),e.metaKey&&!g.isMetaKey(e)&&!this.metaKeyDown&&(s=s||!this.keyState[g.KEY_META_LEFT],this.keyState[g.KEY_META_LEFT]={key:t,timeDown:0}),!e.shiftKey&&this.shiftKeyDown&&(s=s||!!this.keyState[g.KEY_SHIFT_LEFT]||!!this.keyState[g.KEY_SHIFT_RIGHT],delete this.keyState[g.KEY_SHIFT_LEFT],delete this.keyState[g.KEY_SHIFT_RIGHT]),!e.altKey&&this.altKeyDown&&(s=s||!!this.keyState[g.KEY_ALT_LEFT]||!!this.keyState[g.KEY_ALT_RIGHT],delete this.keyState[g.KEY_ALT_LEFT],delete this.keyState[g.KEY_ALT_RIGHT]),!e.ctrlKey&&this.ctrlKeyDown&&(s=s||!!this.keyState[g.KEY_CONTROL_LEFT]||!!this.keyState[g.KEY_CONTROL_RIGHT],delete this.keyState[g.KEY_CONTROL_LEFT],delete this.keyState[g.KEY_CONTROL_RIGHT]),!e.metaKey&&this.metaKeyDown&&(s=s||g.META_KEYS.some(i=>!!this.keyState[i]),g.META_KEYS.forEach(i=>{delete this.keyState[i]})),s&&this.keyDownStateChangedEmitter.emit(e)}keyupUpdate(e){this.enabled&&this.keyupUpdateAction.execute(e)}get movementKeysDown(){return this.isAnyKeyInListDown(g.MOVEMENT_KEYS)}getLastKeyDown(){return this._lastKeyDown}isKeyDown(e){return!!this.keyState[e]}isEnglishKeyDown(e){return this.isAnyKeyInListDown(Qs[e])}getKeysDown(){return Object.keys(this.keyState)}getEnglishKeysDown(){const e=new Set;for(const t of this.getKeysDown()){const s=cd(t);s&&e.add(s)}return e}isAnyKeyInListDown(e){for(let t=0;t<e.length;t++)if(this.isKeyDown(e[t]))return!0;return!1}areKeysDown(e){for(let s=0;s<e.length;s++)if(!this.isKeyDown(e[s]))return!1;return!0}areKeysExclusivelyDown(e){const t=Object.keys(this.keyState);if(t.length!==e.length)return!1;let s=!0;for(let i=0;i<e.length;i++){const n=e[i];let a=[n];g.isModifierKey(n)&&(a=g.MODIFIER_KEY_TO_CODE_MAP.get(n)),_.intersection(t,a).length===0&&(s=!1)}return s}areKeysDownWithoutExtraModifiers(e){for(let t=0;t<g.MODIFIER_KEY_CODES.length;t++){const s=g.MODIFIER_KEY_CODES[t];if(this.isKeyDown(s)&&!e.includes(s))return!1}return this.areKeysDown(e)}keysAreDown(){return Object.keys(this.keyState).length>0}get enterKeyDown(){return this.isKeyDown(g.KEY_ENTER)}get shiftKeyDown(){return this.isAnyKeyInListDown(g.SHIFT_KEYS)}get altKeyDown(){return this.isAnyKeyInListDown(g.ALT_KEYS)}get ctrlKeyDown(){return this.isAnyKeyInListDown(g.CONTROL_KEYS)}get metaKeyDown(){return this.isAnyKeyInListDown(g.META_KEYS)}timeDownForKey(e){return assert&&assert(this.isKeyDown(e),"cannot get timeDown on a key that is not pressed down"),this.keyState[e].timeDown}clearState(e){this.keyState={},e||this.keyDownStateChangedEmitter.emit(null)}step(e){if(this.keysAreDown()){const t=e*1e3;for(const s in this.keyState)this.keyState[s]&&(this.keyState[s].timeDown+=t)}}attachToWindow(){assert&&assert(!this.attachedToDocument,"KeyStateTracker is already attached to document."),this.documentKeydownListener=t=>{this.keydownUpdate(t)},this.documentKeyupListener=t=>{this.keyupUpdate(t)},this.documentBlurListener=t=>{this.clearState()};const e=()=>{window.addEventListener("keyup",this.documentKeyupListener,{capture:!0}),window.addEventListener("keydown",this.documentKeydownListener,{capture:!0}),window.addEventListener("blur",this.documentBlurListener,{capture:!0}),this.attachedToDocument=!0};if(document)e();else{const t=()=>{e(),window.removeEventListener("load",t)};window.addEventListener("load",t)}}setEnabled(e){this._enabled!==e&&(this._enabled=e,!e&&this.clearState())}set enabled(e){this.setEnabled(e)}get enabled(){return this.isEnabled()}isEnabled(){return this._enabled}detachFromDocument(){assert&&assert(this.attachedToDocument,"KeyStateTracker is not attached to window."),assert&&assert(this.documentKeyupListener,"keyup listener was not created or attached to window"),assert&&assert(this.documentKeydownListener,"keydown listener was not created or attached to window."),assert&&assert(this.documentBlurListener,"blur listener was not created or attached to window."),window.removeEventListener("keyup",this.documentKeyupListener),window.removeEventListener("keydown",this.documentKeydownListener),window.removeEventListener("blur",this.documentBlurListener),this.documentKeyupListener=null,this.documentKeydownListener=null,this.documentBlurListener=null,this.attachedToDocument=!1}dispose(){this.disposeKeyStateTracker()}}d.register("KeyStateTracker",su);class mm extends su{constructor(e){super(e)}}const iu=new mm({tandem:se.GENERAL_CONTROLLER.createTandem("keyStateTracker")});d.register("globalKeyStateTracker",iu);const ze=iu,Nl=["interactiveHighlight","interactiveHighlightLayerable","interactiveHighlightEnabled"],nh=Me(r=>{assert&&assert(!r._mixesInteractiveHighlighting,"InteractiveHighlighting is already added to this Type");const e=Bi("InteractiveHighlightingClass",Nl,class extends r{constructor(...s){super(...s),this._pointer=null,this.displays={},this._interactiveHighlight=null,this._interactiveHighlightLayerable=!1,this._interactiveHighlightEnabled=!0,this.interactiveHighlightChangedEmitter=new re,this._isInteractiveHighlightActiveProperty=new X(!1),this._activationListener={enter:this._onPointerEntered.bind(this),over:this._onPointerOver.bind(this),move:this._onPointerMove.bind(this),exit:this._onPointerExited.bind(this),down:this._onPointerDown.bind(this)},this._changedInstanceListener=this.onChangedInstance.bind(this),this.changedInstanceEmitter.addListener(this._changedInstanceListener),this._interactiveHighlightingEnabledListener=this._onInteractiveHighlightingEnabledChange.bind(this),this._boundPointerFocusClearedListener=this.handleLockedPointerFocusCleared.bind(this);const i=this._onPointerRelease.bind(this),n=this._onPointerCancel.bind(this);this._pointerListener={up:i,cancel:n,interrupt:n},this.isInteractiveHighlightActiveProperty=this._isInteractiveHighlightActiveProperty}get isInteractiveHighlighting(){return!0}static get _mixesInteractiveHighlighting(){return!0}setInteractiveHighlight(s){this._interactiveHighlight!==s&&(this._interactiveHighlight=s,this._interactiveHighlightLayerable&&(assert&&assert(s instanceof D),s.visible=!1),this.interactiveHighlightChangedEmitter.emit())}set interactiveHighlight(s){this.setInteractiveHighlight(s)}get interactiveHighlight(){return this.getInteractiveHighlight()}getInteractiveHighlight(){return this._interactiveHighlight}setInteractiveHighlightLayerable(s){this._interactiveHighlightLayerable!==s&&(this._interactiveHighlightLayerable=s,this._interactiveHighlight&&(assert&&assert(this._interactiveHighlight instanceof D),this._interactiveHighlight.visible=!1,this.interactiveHighlightChangedEmitter.emit()))}set interactiveHighlightLayerable(s){this.setInteractiveHighlightLayerable(s)}get interactiveHighlightLayerable(){return this.getInteractiveHighlightLayerable()}getInteractiveHighlightLayerable(){return this._interactiveHighlightLayerable}setInteractiveHighlightEnabled(s){this._interactiveHighlightEnabled=s;const i=Object.keys(this.displays);for(let n=0;n<i.length;n++){const a=this.displays[i[n]];this._interactiveHighlightingEnabledListener(a.focusManager.pointerHighlightsVisibleProperty.value)}}getInteractiveHighlightEnabled(){return this._interactiveHighlightEnabled}set interactiveHighlightEnabled(s){this.setInteractiveHighlightEnabled(s)}get interactiveHighlightEnabled(){return this.getInteractiveHighlightEnabled()}isInteractiveHighlightActivated(){let s=!1;const i=Object.keys(this.displays);for(let n=0;n<i.length;n++){const a=this.displays[i[n]];if(a.focusManager.pointerHighlightsVisibleProperty.value){const o=a.focusManager.pointerFocusProperty.value,h=a.focusManager.lockedPointerFocusProperty.value;if(h){if((h==null?void 0:h.trail.lastNode())===this){s=!0;break}}else if((o==null?void 0:o.trail.lastNode())===this){s=!0;break}}}return s}handleHighlightActiveChange(){this._isInteractiveHighlightActiveProperty.value=this.isInteractiveHighlightActivated()}dispose(){this.changedInstanceEmitter.removeListener(this._changedInstanceListener),this.hasInputListener(this._activationListener)&&this.removeInputListener(this._activationListener),this._pointer&&(this._pointer.removeInputListener(this._pointerListener),this._pointer=null);const s=Object.keys(this.displays);for(let i=0;i<s.length;i++){const n=this.displays[s[i]];this.onDisplayRemoved(n),delete this.displays[s[i]]}super.dispose&&super.dispose()}_onPointerOver(s){const i=s.trail.nodes.find(n=>n.groupFocusHighlight&&n.isInteractiveHighlighting);if(i){const n=s.trail.subtrailTo(i),a=Object.values(this.displays);for(let o=0;o<a.length;o++){const h=a[o];h.focusManager.pointerFocusProperty.value===null&&h.focusManager.pointerFocusProperty.set(new Nt(h,n))}}}_onPointerEntered(s){let i=!1;const n=Object.values(this.displays);for(let a=0;a<n.length;a++){const o=n[a];if(o.focusManager.pointerFocusProperty.value===null||!s.trail.equals(o.focusManager.pointerFocusProperty.value.trail)){const h=new Nt(o,s.trail);o.focusManager.pointerFocusProperty.set(h),o.focusManager.lockedPointerFocusProperty.value===null&&s.pointer.attachedListener&&(this.lockHighlight(h,o.focusManager),i=!0)}}i&&this.savePointer(s.pointer)}_onPointerMove(s){let i=!1;const n=Object.values(this.displays);for(let a=0;a<n.length;a++){const o=n[a],h=s.trail.subtrailTo(this);if((o.focusManager.pointerFocusProperty.value===null||!h.equals(o.focusManager.pointerFocusProperty.value.trail))&&!this.getDescendantsUseHighlighting(s.trail)){const l=new Nt(o,h);o.focusManager.pointerFocusProperty.set(l),o.focusManager.lockedPointerFocusProperty.value===null&&s.pointer.attachedListener&&(this.lockHighlight(l,o.focusManager),i=!0)}}i&&this.savePointer(s.pointer)}_onPointerExited(s){const i=Object.values(this.displays);for(let n=0;n<i.length;n++){const a=i[n];a.focusManager.pointerFocusProperty.set(null);const o=a.focusManager.lockedPointerFocusProperty.value;!s.trail.isPickable()&&(o===null||s.trail.containsNode(o.trail.lastNode()))&&this._onPointerRelease(s)}}_onPointerDown(s){if(this._pointer===null){let i=!1;const n=Object.values(this.displays);for(let a=0;a<n.length;a++){const o=n[a],h=o.focusManager.pointerFocusProperty.value,l=!!o.focusManager.lockedPointerFocusProperty.value;h&&!l&&(assert&&assert(!h.trail.lastNode().isDisposed,"Focus should not be set to a disposed Node"),this.lockHighlight(h,o.focusManager),i=!0)}i&&this.savePointer(s.pointer)}}onDisplayAdded(s){s.focusManager.pointerHighlightsVisibleProperty.hasListener(this._interactiveHighlightingEnabledListener)||s.focusManager.pointerHighlightsVisibleProperty.link(this._interactiveHighlightingEnabledListener)}onDisplayRemoved(s){s.focusManager.lockedPointerFocusProperty.hasListener(this._boundPointerFocusClearedListener)&&s.focusManager.lockedPointerFocusProperty.unlink(this._boundPointerFocusClearedListener),s.focusManager.pointerHighlightsVisibleProperty.unlink(this._interactiveHighlightingEnabledListener)}_onPointerRelease(s){const i=Object.values(this.displays);for(let n=0;n<i.length;n++){const a=i[n];a.focusManager.lockedPointerFocusProperty.value=null,a.focusManager.lockedPointerFocusProperty.hasListener(this._boundPointerFocusClearedListener)&&a.focusManager.lockedPointerFocusProperty.unlink(this._boundPointerFocusClearedListener)}this._pointer&&this._pointer.listeners.includes(this._pointerListener)&&(this._pointer.removeInputListener(this._pointerListener),this._pointer=null)}_onPointerCancel(s){const i=Object.values(this.displays);for(let n=0;n<i.length;n++)i[n].focusManager.pointerFocusProperty.set(null);this._onPointerRelease(s)}savePointer(s){assert&&assert(this._pointer===null,"It should be impossible to already have a Pointer before locking from touchSnag"),this._pointer=s,this._pointer.addInputListener(this._pointerListener)}lockHighlight(s,i){assert&&assert(this._pointer===null,"It should be impossible to already have a Pointer before locking from touchSnag"),i.lockedPointerFocusProperty.set(new Nt(s.display,s.trail.copy())),assert&&assert(!i.lockedPointerFocusProperty.hasListener(this._boundPointerFocusClearedListener),"this listener still on the lockedPointerFocusProperty indicates a memory leak"),i.lockedPointerFocusProperty.link(this._boundPointerFocusClearedListener)}handleLockedPointerFocusCleared(s){s===null&&this._onPointerRelease()}_onInteractiveHighlightingEnabledChange(s){const i=s&&this._interactiveHighlightEnabled,n=this.hasInputListener(this._activationListener);i&&!n?this.addInputListener(this._activationListener):!i&&n&&this.removeInputListener(this._activationListener),this.handleHighlightActiveChange()}onChangedInstance(s,i){assert&&assert(s.trail,"should have a trail"),assert&&assert(s.display,"should have a display");const n=s.trail.uniqueId;if(i){const a=s.display;this.displays[n]=a,this.onDisplayAdded(a)}else{assert&&assert(s.node,"should have a node");const a=this.displays[n];assert&&assert(a,`interactive highlighting does not have a Display for removed instance: ${n}`),s.node.instances.length===0&&this.onDisplayRemoved(a),delete this.displays[n]}}getDescendantsUseHighlighting(s){const i=s.nodes.indexOf(this),n=s.nodes.slice(i+1,s.nodes.length);let a=!1;for(let o=0;o<n.length;o++)if(n[o].isInteractiveHighlighting){a=!0;break}return a}mutate(s){return super.mutate(s)}});return e.prototype._mutatorKeys=Nl.concat(e.prototype._mutatorKeys),assert&&assert(e.prototype._mutatorKeys.length===_.uniq(e.prototype._mutatorKeys).length,"duplicate mutator keys in InteractiveHighlighting"),e});d.register("InteractiveHighlighting",nh);class fm extends nh(D){constructor(e){super(e)}}d.register("InteractiveHighlightingNode",fm);const ym={enabledProperty:null,enabled:!0,enabledPropertyOptions:null,phetioEnabledPropertyInstrumented:!0,tandem:_e.DEFAULT_OPTIONS.tandem};class Xn extends Ro{constructor(e){const t=ls()({},ym,e),s=!t.enabledProperty;assert&&t.enabledPropertyOptions&&assert(!(!t.phetioEnabledPropertyInstrumented&&t.enabledPropertyOptions.tandem),"incompatible options. Cannot specify phetioEnabledPropertyInstrumented opt out and a Tandem via enabledPropertyOptions."),super(t),this.enabledProperty=t.enabledProperty||new Fn(t.enabled,Je({tandem:t.phetioEnabledPropertyInstrumented?t.tandem.createTandem(Fn.TANDEM_NAME):se.OPT_OUT},t.enabledPropertyOptions)),this.disposeEnabledComponent=()=>{s&&this.enabledProperty.dispose()}}setEnabled(e){assert&&assert(this.enabledProperty.isSettable(),"cannot set enabledProperty"),this.enabledProperty.value=e}set enabled(e){this.setEnabled(e)}get enabled(){return this.isEnabled()}isEnabled(){return this.enabledProperty.value}dispose(){this.disposeEnabledComponent(),super.dispose()}}it.register("EnabledComponent",Xn);const bm={valueType:"number",isValidValue:r=>r%1===0,validationMessage:"Should be a valid integer"},Lm={isValidValue:r=>!isNaN(r),validationMessage:"Should not be NaN"},vm={validateValidator:!1},Pm=["FloatingPoint","Integer"],ka="rangeProperty",Bl=os.EVERYTHING,Aa=me.PropertyIO(U),_n=class _n extends me{constructor(e,t){var l;assert&&t&&Ge(["range"],["validValues"]);const s=E()({numberType:"FloatingPoint",range:Bl,validators:[],phetioOuterType:()=>_n.NumberPropertyIO},t);s.rangePropertyOptions=E()({phetioDocumentation:"Provides the range of possible values for the parent NumberPropertyIO",phetioValueType:os.RangeIO,phetioReadOnly:!0,tandem:s.range!==Bl?(l=s.tandem)==null?void 0:l.createTandem(ka):se.OPT_OUT},s.rangePropertyOptions),assert&&se.VALIDATION&&s.rangePropertyOptions.tandem&&s.rangePropertyOptions.tandem.supplied&&assert&&assert(s.rangePropertyOptions.tandem.name===ka,`rangePropertyOptions.tandem.name must be ${ka}: ${s.rangePropertyOptions.tandem.name}`),s.valueType="number",s.phetioValueType=U;const n=!(s.range&&s.range instanceof ft),a=s.range instanceof ft?s.range:new me(s.range,s.rangePropertyOptions);s.validators.push(Lm),s.numberType==="Integer"&&s.validators.push(bm);let o=!1;s.validators.push({isValidValue:c=>a.value.contains(c),validationMessage:()=>`Number value ${o?this.value:e} must be within rangeProperty value: ${a.value}`}),super(e,s),o=!0,this.numberType=s.numberType,this.rangeProperty=a,assert&&se.VALIDATION&&this.rangeProperty.isPhetioInstrumented()&&assert&&assert(this.isPhetioInstrumented(),"NumberProperty must be phet-io instrumented if the range is");const h=()=>{Es(this.value,this.valueValidator,vm)};if(assert&&this.rangeProperty.link(h),this.rangeProperty.addPhetioStateDependencies([this]),this.addPhetioStateDependencies([this.rangeProperty]),s.validValues&&this.validateNumberAndRangeProperty)for(let c=0;c<s.validValues.length;c++){const u=s.validValues[c];this.validateNumberAndRangeProperty(u)}this.disposeNumberProperty=()=>{n?this.rangeProperty.dispose():assert&&this.rangeProperty.unlink(h)},this.resetNumberProperty=()=>{n&&this.rangeProperty.reset()}}get range(){return this.rangeProperty.value}set range(e){this.rangeProperty.value=e}reset(){this.resetValueAndRange(),super.reset()}dispose(){this.disposeNumberProperty(),super.dispose()}setValueAndRange(e,t){assert&&assert(t.contains(e),`value ${e} is not in range [${t.min},${t.max}]`),this.setDeferred(!0),this.rangeProperty.setDeferred(!0),this.set(e),this.rangeProperty.set(t);const s=this.setDeferred(!1),i=this.rangeProperty.setDeferred(!1);s&&s(),i&&i()}resetValueAndRange(){this.setValueAndRange(this.initialValue,this.rangeProperty.initialValue)}toStateObject(){const e=Aa.toStateObject(this);e.numberType=this.numberType,e.range=os.RangeIO.toStateObject(this.rangeProperty.value);const t=this.rangeProperty&&this.rangeProperty.isPhetioInstrumented();return e.rangePhetioID=t?this.rangeProperty.tandem.phetioID:null,e}};_n.NumberPropertyIO=new Le("NumberPropertyIO",{valueType:_n,supertype:Aa,parameterTypes:[U],documentation:`Extends PropertyIO to add values for the numeric range ( min, max ) and numberType ( '${Pm.join("' | '")}' )`,toStateObject:e=>e.toStateObject(),applyState:(e,t)=>{Aa.applyState(e,t)},stateSchema:{numberType:ge,range:os.RangeIO,rangePhetioID:V(ge)}});let Kt=_n;it.register("NumberProperty",Kt);class nu extends ft{constructor(e,t){const s=E()({bidirectional:!1,defaultValue:null,derive:_.identity,map:_.identity,inverseMap:_.identity},t),i=s.derive,n=s.map,a=s.inverseMap,o=typeof i=="function"?i:u=>u[i],h=typeof n=="function"?n:u=>u[n],l=typeof a=="function"?a:u=>u[a],c=e.value===null?h(s.defaultValue):h(o(e.value).value);super(c,s),this.defaultValue=s.defaultValue,this.derive=o,this.map=h,this.inverseMap=l,this.bidirectional=s.bidirectional,this.valuePropertyProperty=e,this.isExternallyChanging=!1,this.propertyPropertyListener=this.onPropertyPropertyChange.bind(this),this.propertyListener=this.onPropertyChange.bind(this),e.link(this.propertyListener),s.bidirectional&&this.lazyLink(this.onSelfChange.bind(this))}onPropertyPropertyChange(e,t,s){this.bidirectional&&this.valuePropertyProperty.value!==null&&s&&this.derive(this.valuePropertyProperty.value)===s&&s.areValuesEqual(this.inverseMap(this.value),s.get())||super.set(this.map(e))}onPropertyChange(e,t){t&&this.derive(t).unlink(this.propertyPropertyListener),e?this.derive(e).link(this.propertyPropertyListener):this.onPropertyPropertyChange(this.defaultValue,null,null)}onSelfChange(e){if(assert&&assert(this.bidirectional),this.valuePropertyProperty.value!==null){const t=this.derive(this.valuePropertyProperty.value);this.areValuesEqual(e,this.map(t.value))||(t.value=this.inverseMap(e))}}dispose(){this.valuePropertyProperty.unlink(this.propertyListener),this.valuePropertyProperty.value!==null&&this.derive(this.valuePropertyProperty.value).unlink(this.propertyPropertyListener),super.dispose()}reset(){assert&&assert(this.bidirectional,"Cannot reset a non-bidirectional DynamicProperty"),this.valuePropertyProperty.value!==null&&this.derive(this.valuePropertyProperty.value).reset()}set(e){assert&&assert(this.bidirectional,`Cannot set values directly to a non-bidirectional DynamicProperty, tried to set: ${e}`),this.isExternallyChanging=!0,super.set(e),this.isExternallyChanging=!1}get value(){return super.value}set value(e){this.set(e)}isSettable(){return super.isSettable()||this.bidirectional}}it.register("DynamicProperty",nu);const xa={aa:{name:"Afar",localizedName:"Afar",direction:"ltr"},ab:{name:"Abkhazian",localizedName:"Abkhazian",direction:"ltr"},ae:{name:"Avestan",localizedName:"Avestan",direction:"rtl"},af:{name:"Afrikaans",localizedName:"Afrikaans",direction:"ltr"},ak:{name:"Akan",localizedName:"Akan",direction:"ltr"},am:{name:"Amharic",localizedName:"Amharic",direction:"ltr"},an:{name:"Aragonese",localizedName:"Aragonese",direction:"ltr"},ar:{name:"Arabic",localizedName:"العربية",direction:"rtl"},ar_MA:{name:"Arabic, Morocco",localizedName:"العربية (المغرب)",direction:"rtl"},ar_SA:{name:"Arabic, Saudi Arabia",localizedName:"العربية (السعودية)",direction:"rtl"},as:{name:"Assamese",localizedName:"Assamese",direction:"ltr"},av:{name:"Avaric",localizedName:"Avaric",direction:"ltr"},ay:{name:"Aymara",localizedName:"Aymara",direction:"ltr"},az:{name:"Azerbaijani",localizedName:"Azerbaijani",direction:"ltr"},ba:{name:"Bashkir",localizedName:"Bashkir",direction:"ltr"},be:{name:"Belarusian",localizedName:"беларускі",direction:"ltr"},bg:{name:"Bulgarian",localizedName:"български",direction:"ltr"},bh:{name:"Bihari",localizedName:"Bihari",direction:"ltr"},bi:{name:"Bislama",localizedName:"Bislama",direction:"ltr"},bm:{name:"Bambara",localizedName:"Bambara",direction:"ltr"},bn:{name:"Bengali",localizedName:"Bengali",direction:"ltr"},bo:{name:"Tibetan",localizedName:"Tibetan",direction:"ltr"},br:{name:"Breton",localizedName:"Breton",direction:"ltr"},bs:{name:"Bosnian",localizedName:"Bosnian",direction:"ltr"},ca:{name:"Catalan",localizedName:"català",direction:"ltr"},ce:{name:"Chechen",localizedName:"Chechen",direction:"ltr"},ch:{name:"Chamorro",localizedName:"Chamorro",direction:"ltr"},co:{name:"Corsican",localizedName:"Corsican",direction:"ltr"},cr:{name:"Cree",localizedName:"Cree",direction:"ltr"},cs:{name:"Czech",localizedName:"čeština",direction:"ltr"},cu:{name:"Church Slavic",localizedName:"Church Slavic",direction:"ltr"},cv:{name:"Chuvash",localizedName:"Chuvash",direction:"ltr"},cy:{name:"Welsh",localizedName:"Welsh",direction:"ltr"},da:{name:"Danish",localizedName:"Dansk",direction:"ltr"},de:{name:"German",localizedName:"Deutsch",direction:"ltr"},dv:{name:"Divehi",localizedName:"Divehi",direction:"ltr"},dz:{name:"Dzongkha",localizedName:"Dzongkha",direction:"ltr"},ee:{name:"Ewe",localizedName:"Ewe",direction:"ltr"},el:{name:"Greek",localizedName:"Ελληνικά",direction:"ltr"},en:{name:"English",localizedName:"English",direction:"ltr"},en_CA:{name:"English, Canada",localizedName:"English (Canada)",direction:"ltr"},en_GB:{name:"English, United Kingdom",localizedName:"English (United Kingdom)",direction:"ltr"},eo:{name:"Esperanto",localizedName:"Esperanto",direction:"ltr"},es:{name:"Spanish",localizedName:"español",direction:"ltr"},es_CO:{name:"Spanish, Colombia",localizedName:"español (Colombia)",direction:"ltr"},es_CR:{name:"Spanish, Costa Rica",localizedName:"español (Costa Rica)",direction:"ltr"},es_ES:{name:"Spanish, Spain",localizedName:"español (España)",direction:"ltr"},es_MX:{name:"Spanish, Mexico",localizedName:"español (México)",direction:"ltr"},es_PE:{name:"Spanish, Peru",localizedName:"español (Perú)",direction:"ltr"},et:{name:"Estonian",localizedName:"Eesti",direction:"ltr"},eu:{name:"Basque",localizedName:"Basque",direction:"ltr"},fa:{name:"Persian",localizedName:"Persian",direction:"rtl"},ff:{name:"Fulah",localizedName:"Fulah",direction:"ltr"},fi:{name:"Finnish",localizedName:"suomi",direction:"ltr"},fj:{name:"Fijian",localizedName:"Fijian",direction:"ltr"},fo:{name:"Faroese",localizedName:"Faroese",direction:"ltr"},fr:{name:"French",localizedName:"français",direction:"ltr"},fu:{name:"Friulian",localizedName:"fu",direction:"ltr"},fy:{name:"Western Frisian",localizedName:"Frisian",direction:"ltr"},ga:{name:"Irish",localizedName:"Gaeilge",direction:"ltr"},gd:{name:"Scottish Gaelic",localizedName:"Scottish Gaelic",direction:"ltr"},gl:{name:"Galician",localizedName:"Gallegan",direction:"ltr"},gn:{name:"Guarani",localizedName:"Guarani",direction:"ltr"},gu:{name:"Gujarati",localizedName:"Gujarati",direction:"ltr"},gv:{name:"Manx",localizedName:"Manx",direction:"ltr"},ha:{name:"Hausa",localizedName:"Hausa",direction:"ltr"},hi:{name:"Hindi",localizedName:"हिंदी",direction:"ltr"},ho:{name:"Hiri Motu",localizedName:"Hiri Motu",direction:"ltr"},hr:{name:"Croatian",localizedName:"hrvatski",direction:"ltr"},ht:{name:"Haitian",localizedName:"Haitian",direction:"ltr"},hu:{name:"Hungarian",localizedName:"magyar",direction:"ltr"},hy:{name:"Armenian",localizedName:"Armenian",direction:"ltr"},hz:{name:"Herero",localizedName:"Herero",direction:"ltr"},ia:{name:"Interlingua",localizedName:"Interlingua",direction:"ltr"},ie:{name:"Interlingue",localizedName:"Interlingue",direction:"ltr"},ig:{name:"Igbo",localizedName:"Igbo",direction:"ltr"},ii:{name:"Sichuan Yi",localizedName:"Sichuan Yi",direction:"ltr"},ik:{name:"Inupiaq",localizedName:"Inupiaq",direction:"ltr"},in:{name:"Indonesian",localizedName:"Bahasa Indonesia",direction:"ltr"},io:{name:"Ido",localizedName:"Ido",direction:"ltr"},is:{name:"Icelandic",localizedName:"íslenska",direction:"ltr"},it:{name:"Italian",localizedName:"italiano",direction:"ltr"},iu:{name:"Inuktitut",localizedName:"Inuktitut",direction:"ltr"},iw:{name:"Hebrew",localizedName:"עברית",direction:"rtl"},ja:{name:"Japanese",localizedName:"日本語",direction:"ltr"},ji:{name:"Yiddish",localizedName:"Yiddish",direction:"ltr"},jv:{name:"Javanese",localizedName:"Javanese",direction:"ltr"},ka:{name:"Georgian",localizedName:"Georgian",direction:"ltr"},kg:{name:"Kongo",localizedName:"Kongo",direction:"ltr"},ki:{name:"Kikuyu",localizedName:"Kikuyu",direction:"ltr"},kj:{name:"Kwanyama",localizedName:"Kwanyama",direction:"ltr"},kk:{name:"Kazakh",localizedName:"Kazakh",direction:"ltr"},kl:{name:"Kalaallisut",localizedName:"Greenlandic",direction:"ltr"},km:{name:"Khmer",localizedName:"Khmer",direction:"ltr"},kn:{name:"Kannada",localizedName:"Kannada",direction:"ltr"},ko:{name:"Korean",localizedName:"한국어",direction:"ltr"},kr:{name:"Kanuri",localizedName:"Kanuri",direction:"ltr"},ks:{name:"Kashmiri",localizedName:"Kashmiri",direction:"ltr"},ku:{name:"Kurdish",localizedName:"Kurdish",direction:"ltr"},ku_TR:{name:"Kurdish, Turkey",localizedName:"Kurdish (Turkey)",direction:"ltr"},kv:{name:"Komi",localizedName:"Komi",direction:"ltr"},kw:{name:"Cornish",localizedName:"Cornish",direction:"ltr"},ky:{name:"Kirghiz",localizedName:"Kirghiz",direction:"ltr"},la:{name:"Latin",localizedName:"Latin",direction:"ltr"},lb:{name:"Luxembourgish",localizedName:"Luxembourgish",direction:"ltr"},lg:{name:"Ganda",localizedName:"Ganda",direction:"ltr"},li:{name:"Limburgish",localizedName:"Limburgish",direction:"ltr"},lk:{name:"Lakota",localizedName:"Lakota",direction:"ltr"},ln:{name:"Lingala",localizedName:"Lingala",direction:"ltr"},lo:{name:"Lao",localizedName:"Lao",direction:"ltr"},lt:{name:"Lithuanian",localizedName:"Lietuvių",direction:"ltr"},lu:{name:"Luba-Katanga",localizedName:"Luba-Katanga",direction:"ltr"},lv:{name:"Latvian",localizedName:"Latviešu",direction:"ltr"},mg:{name:"Malagasy",localizedName:"Malagasy",direction:"ltr"},mh:{name:"Marshallese",localizedName:"Marshallese",direction:"ltr"},mi:{name:"Maori",localizedName:"Maori",direction:"ltr"},mk:{name:"Macedonian",localizedName:"македонски",direction:"ltr"},ml:{name:"Malayalam",localizedName:"Malayalam",direction:"ltr"},mn:{name:"Mongolian",localizedName:"Mongolian",direction:"ltr"},mo:{name:"Moldavian",localizedName:"Moldavian",direction:"ltr"},mr:{name:"Marathi",localizedName:"Marathi",direction:"ltr"},ms:{name:"Malay",localizedName:"Bahasa Melayu",direction:"ltr"},mt:{name:"Maltese",localizedName:"Malti",direction:"ltr"},my:{name:"Burmese",localizedName:"Burmese",direction:"ltr"},na:{name:"Nauru",localizedName:"Nauru",direction:"ltr"},nb:{name:"Norwegian Bokmal",localizedName:"Norwegian Bokmål",direction:"ltr"},nd:{name:"North Ndebele",localizedName:"North Ndebele",direction:"ltr"},ne:{name:"Nepali",localizedName:"Nepali",direction:"ltr"},ng:{name:"Ndonga",localizedName:"Ndonga",direction:"ltr"},nl:{name:"Dutch",localizedName:"Nederlands",direction:"ltr"},nn:{name:"Norwegian Nynorsk",localizedName:"Norwegian Nynorsk",direction:"ltr"},nr:{name:"South Ndebele",localizedName:"South Ndebele",direction:"ltr"},nv:{name:"Navajo",localizedName:"Navajo",direction:"ltr"},ny:{name:"Chichewa",localizedName:"Nyanja",direction:"ltr"},oc:{name:"Occitan",localizedName:"Occitan",direction:"ltr"},oj:{name:"Ojibwa",localizedName:"Ojibwa",direction:"ltr"},om:{name:"Oromo",localizedName:"Oromo",direction:"ltr"},or:{name:"Oriya",localizedName:"Oriya",direction:"ltr"},os:{name:"Ossetian",localizedName:"Ossetian",direction:"ltr"},pa:{name:"Panjabi",localizedName:"Panjabi",direction:"ltr"},pi:{name:"Pali",localizedName:"Pali",direction:"ltr"},pl:{name:"Polish",localizedName:"polski",direction:"ltr"},ps:{name:"Pashto",localizedName:"Pushto",direction:"ltr"},pt:{name:"Portuguese",localizedName:"português",direction:"ltr"},pt_BR:{name:"Portuguese, Brazil",localizedName:"português (Brasil)",direction:"ltr"},qu:{name:"Quechua",localizedName:"Quechua",direction:"ltr"},rm:{name:"Raeto-Romance",localizedName:"Raeto-Romance",direction:"ltr"},rn:{name:"Kirundi",localizedName:"Rundi",direction:"ltr"},ro:{name:"Romanian",localizedName:"română",direction:"ltr"},ru:{name:"Russian",localizedName:"русский",direction:"ltr"},rw:{name:"Kinyarwanda",localizedName:"Kinyarwanda",direction:"ltr"},sa:{name:"Sanskrit",localizedName:"Sanskrit",direction:"ltr"},sc:{name:"Sardinian",localizedName:"Sardinian",direction:"ltr"},sd:{name:"Sindhi",localizedName:"Sindhi",direction:"ltr"},se:{name:"Northern Sami",localizedName:"Northern Sami",direction:"ltr"},sg:{name:"Sango",localizedName:"Sango",direction:"ltr"},sh:{name:"Serbo-Croatian",localizedName:"Serbo-Croatian",direction:"ltr"},si:{name:"Sinhalese",localizedName:"Sinhalese",direction:"ltr"},sk:{name:"Slovak",localizedName:"Slovenčina",direction:"ltr"},sl:{name:"Slovenian",localizedName:"Slovenščina",direction:"ltr"},sm:{name:"Samoan",localizedName:"Samoan",direction:"ltr"},sn:{name:"Shona",localizedName:"Shona",direction:"ltr"},so:{name:"Somali",localizedName:"Somali",direction:"ltr"},sq:{name:"Albanian",localizedName:"shqipe",direction:"ltr"},sr:{name:"Serbian",localizedName:"Српски",direction:"ltr"},ss:{name:"Swati",localizedName:"Swati",direction:"ltr"},st:{name:"Sotho",localizedName:"Southern Sotho",direction:"ltr"},su:{name:"Sundanese",localizedName:"Sundanese",direction:"ltr"},sv:{name:"Swedish",localizedName:"svenska",direction:"ltr"},sw:{name:"Swahili",localizedName:"Swahili",direction:"ltr"},ta:{name:"Tamil",localizedName:"Tamil",direction:"ltr"},te:{name:"Telugu",localizedName:"Telugu",direction:"ltr"},tg:{name:"Tajik",localizedName:"Tajik",direction:"ltr"},th:{name:"Thai",localizedName:"ไทย",direction:"ltr"},ti:{name:"Tigrinya",localizedName:"Tigrinya",direction:"ltr"},tk:{name:"Turkmen",localizedName:"Turkmen",direction:"ltr"},tl:{name:"Tagalog",localizedName:"Tagalog",direction:"ltr"},tn:{name:"Tswana",localizedName:"Tswana",direction:"ltr"},to:{name:"Tonga",localizedName:"Tonga",direction:"ltr"},tr:{name:"Turkish",localizedName:"Türkçe",direction:"ltr"},ts:{name:"Tsonga",localizedName:"Tsonga",direction:"ltr"},tt:{name:"Tatar",localizedName:"Tatar",direction:"ltr"},tw:{name:"Twi",localizedName:"Twi",direction:"ltr"},ty:{name:"Tahitian",localizedName:"Tahitian",direction:"ltr"},ug:{name:"Uighur",localizedName:"Uighur",direction:"ltr"},uk:{name:"Ukrainian",localizedName:"українська",direction:"ltr"},ur:{name:"Urdu",localizedName:"Urdu",direction:"rtl"},uz:{name:"Uzbek",localizedName:"Uzbek",direction:"ltr"},ve:{name:"Venda",localizedName:"Venda",direction:"ltr"},vi:{name:"Vietnamese",localizedName:"Tiếng Việt",direction:"ltr"},vo:{name:"Volapuk",localizedName:"Volapük",direction:"ltr"},wa:{name:"Walloon",localizedName:"Walloon",direction:"ltr"},wo:{name:"Wolof",localizedName:"Wolof",direction:"ltr"},xh:{name:"Xhosa",localizedName:"Xhosa",direction:"ltr"},yo:{name:"Yoruba",localizedName:"Yoruba",direction:"ltr"},za:{name:"Zhuang",localizedName:"Zhuang",direction:"ltr"},zh_CN:{name:"Chinese, Simplified",localizedName:"中文 (中国)",direction:"ltr"},zh_HK:{name:"Chinese, Hong Kong",localizedName:"中文 (香港)",direction:"ltr"},zh_TW:{name:"Chinese, Traditional",localizedName:"中文 (台灣)",direction:"ltr"},zu:{name:"Zulu",localizedName:"Zulu",direction:"ltr"}},ru=new Oo("phetcommon"),hr="‪",lr="‫",ui="‬",is={format:function(r){const e=arguments;return r.replace(/{(\d)}/g,(t,s)=>e[+s+1])},fillIn:function(r,e){r=r&&r.get?r.get():r,assert&&assert(typeof r=="string",`invalid template: ${r}`),assert&&assert(e&&typeof e=="object",`invalid values: ${e}`);let t=r;const s=r.match(/\{\{[^{}]+\}\}/g)||[];for(let i=0;i<s.length;i++){const n=s[i],a=n.replace("{{","").replace("}}","");if(e[a]!==void 0){const o=e[a]&&e[a].get?e[a].get():e[a];t=t.replace(n,o)}}return t},isEmbeddingMark:function(r){return r===hr||r===lr||r===ui},embeddedSlice:function(r,e,t){const s=[];let i;for(t===void 0&&(t=r.length),t<0&&(t+=r.length);e<r.length&&is.isEmbeddingMark(r.charAt(e));)e++;for(;t>=1&&is.isEmbeddingMark(r.charAt(t-1));)t--;if(e>=t||e>=r.length)return"";for(let m=0;m<e;m++)i=r.charAt(m),i===hr||i===lr?s.push(i):i===ui&&s.pop();let n=s.length,a=s.slice();const o=r.slice(e,t);for(let m=0;m<o.length;m++)i=o.charAt(m),i===hr||i===lr?s.push(i):i===ui&&(s.pop(),n=Math.min(s.length,n));let h=s;const l=Math.max(0,n-1);a=a.slice(l),h=h.slice(l);const c=a.join(""),u=h.join("").replace(/./g,ui);return c+o+u},embeddedSplit:function(r,e,t){if(e===void 0)return[r];let s=[],i,n=r;function a(){let h,l;if(e instanceof window.RegExp){const c=n.match(e);c?(h=c.index,l=c[0].length):h=-1}else assert&&assert(typeof e=="string"),h=n.indexOf(e),l=e.length;return{index:h,length:l}}let o=0;for(;(i=a()).index>=0;){s.push(is.embeddedSlice(r,o,o+i.index));const h=i.index+i.length;n=n.slice(h),o+=h}return s.push(is.embeddedSlice(r,o)),t!==void 0&&(assert&&assert(typeof t=="number"),s=_.first(s,t)),s},embeddedDebugString:function(r){return r.replace(/\u202a/g,"[LTR]").replace(/\u202b/g,"[RTL]").replace(/\u202c/g,"[POP]")},wrapLTR:function(r){return hr+r+ui},wrapRTL:function(r){return lr+r+ui},wrapDirection:function(r,e){return assert&&assert(e==="ltr"||e==="rtl"),e==="ltr"?is.wrapLTR(r):is.wrapRTL(r)},localeToLocalizedName:function(r){return assert&&assert(xa[r],"locale needs to be a valid locale code defined in localeInfoModule"),is.wrapDirection(xa[r].localizedName,xa[r].direction)},capitalize(r){const e=r.search(/[A-Za-z0-9]/);if(e===-1)return r.slice(0);const t=e>0?r.slice(0,e):"",s=r.charAt(e).toUpperCase(),i=e+1<r.length?r.slice(e+1):"";return t+s+i}};ru.register("StringUtils",is);const Qt=new Oo("utteranceQueue"),_m="NAME",Sm="OBJECT",wm="CONTEXT",Dm="HINT",Tm={nameObjectContextHint:"{{NAME}}, {{OBJECT}}, {{CONTEXT}} {{HINT}}",nameObjectContext:"{{NAME}}, {{OBJECT}}, {{CONTEXT}}",nameObjectHint:"{{NAME}}, {{OBJECT}}, {{HINT}}",nameContextHint:"{{NAME}}, {{CONTEXT}} {{HINT}}",nameObject:"{{NAME}}, {{OBJECT}}",nameContext:"{{NAME}}, {{CONTEXT}}",nameHint:"{{NAME}}, {{HINT}}",name:"{{NAME}}",objectContextHint:"{{OBJECT}}, {{CONTEXT}} {{HINT}}",objectContext:"{{OBJECT}}, {{CONTEXT}}",objectHint:"{{OBJECT}}, {{HINT}}",contextHint:"{{CONTEXT}} {{HINT}}",object:"{{OBJECT}}",context:"{{CONTEXT}}",hint:"{{HINT}}"},Fr=class Fr{constructor(e){const t=ls()({},Tm,e);this.nameObjectContextHint=t.nameObjectContextHint,this.nameObjectContext=t.nameObjectContext,this.nameObjectHint=t.nameObjectHint,this.nameContextHint=t.nameContextHint,this.nameObject=t.nameObject,this.nameContext=t.nameContext,this.nameHint=t.nameHint,this.name=t.name,this.objectContextHint=t.objectContextHint,this.objectContext=t.objectContext,this.objectHint=t.objectHint,this.contextHint=t.contextHint,this.object=t.object,this.context=t.context,this.hint=t.hint}getResponsePattern(e){const t=this[e];return assert&&assert(t,`no pattern string found for key ${e}`),t}static createPatternKey(e,t,s,i){let n="";return e&&(n=n.concat(_m.concat("_"))),t&&(n=n.concat(Sm.concat("_"))),s&&(n=n.concat(wm.concat("_"))),i&&(n=n.concat(Dm.concat("_"))),_.camelCase(n)}};Fr.DEFAULT_RESPONSE_PATTERNS=new Fr;let Ns=Fr;Qt.register("ResponsePatternCollection",Ns);const Fl={nameResponse:null,objectResponse:null,contextResponse:null,hintResponse:null,ignoreProperties:!1,responsePatternCollection:Ns.DEFAULT_RESPONSE_PATTERNS},Ls=class Ls{constructor(e){const t=ls()({},Fl,e);assert&&assert(t.responsePatternCollection instanceof Ns),this._nameResponse=t.nameResponse,this._objectResponse=t.objectResponse,this._contextResponse=t.contextResponse,this._hintResponse=t.hintResponse,this.ignoreProperties=t.ignoreProperties,this.responsePatternCollection=t.responsePatternCollection}getNameResponse(){return Ls.getResponseText(this._nameResponse)}get nameResponse(){return this.getNameResponse()}set nameResponse(e){this.setNameResponse(e)}setNameResponse(e){this._nameResponse=e}getObjectResponse(){return Ls.getResponseText(this._objectResponse)}get objectResponse(){return this.getObjectResponse()}set objectResponse(e){this.setObjectResponse(e)}setObjectResponse(e){this._objectResponse=e}getContextResponse(){return Ls.getResponseText(this._contextResponse)}get contextResponse(){return this.getContextResponse()}set contextResponse(e){this.setContextResponse(e)}setContextResponse(e){this._contextResponse=e}getHintResponse(){return Ls.getResponseText(this._hintResponse)}get hintResponse(){return this.getHintResponse()}set hintResponse(e){this.setHintResponse(e)}setHintResponse(e){this._hintResponse=e}static getResponseText(e){return O(e)?e.value:typeof e=="function"?e():e}copy(){return new Ls(this.serialize())}serialize(){return{nameResponse:this.nameResponse,objectResponse:this.objectResponse,contextResponse:this.contextResponse,hintResponse:this.hintResponse,ignoreProperties:this.ignoreProperties,responsePatternCollection:this.responsePatternCollection}}};Ls.DEFAULT_OPTIONS=Fl;let Oi=Ls;Qt.register("ResponsePacket",Oi);class Cm extends _e{constructor(e){super(),this.nameResponsesEnabledProperty=new ie(!0),this.objectResponsesEnabledProperty=new ie(!1),this.contextResponsesEnabledProperty=new ie(!1),this.hintResponsesEnabledProperty=new ie(!1)}reset(){this.nameResponsesEnabledProperty.reset(),this.objectResponsesEnabledProperty.reset(),this.contextResponsesEnabledProperty.reset(),this.hintResponsesEnabledProperty.reset()}collectResponses(e){const t=ls()({},Oi.DEFAULT_OPTIONS,e);assert&&assert(t.responsePatternCollection instanceof Ns);const s=!!(t.nameResponse&&(this.nameResponsesEnabledProperty.get()||t.ignoreProperties)),i=!!(t.objectResponse&&(this.objectResponsesEnabledProperty.get()||t.ignoreProperties)),n=!!(t.contextResponse&&(this.contextResponsesEnabledProperty.get()||t.ignoreProperties)),a=!!(t.hintResponse&&(this.hintResponsesEnabledProperty.get()||t.ignoreProperties)),o=Ns.createPatternKey(s,i,n,a);let h="";if(o){const l=t.responsePatternCollection.getResponsePattern(o);h=is.fillIn(l,{NAME:t.nameResponse,OBJECT:t.objectResponse,CONTEXT:t.contextResponse,HINT:t.hintResponse})}return h}}const au=new Cm;Qt.register("responseCollector",au);const ou=au,Hl=1;let Im=1;const Pt=class Pt extends Ro{constructor(e){const t=E()({alert:null,predicate:function(){return!0},canAnnounceProperties:[],descriptionCanAnnounceProperties:[],voicingCanAnnounceProperties:[],alertStableDelay:200,alertMaximumDelay:Number.MAX_VALUE,announcerOptions:{},priority:Hl},e);super(t),this.id=Im++,this._alert=t.alert,this.predicate=t.predicate,this.canAnnounceProperty=new Oa({dependentProperties:t.canAnnounceProperties}),this.descriptionCanAnnounceProperty=new Oa({dependentProperties:t.descriptionCanAnnounceProperties}),this.voicingCanAnnounceProperty=new Oa({dependentProperties:t.voicingCanAnnounceProperties}),this.alertStableDelay=t.alertStableDelay,this.alertMaximumDelay=t.alertMaximumDelay,this.announcerOptions=t.announcerOptions,this.priorityProperty=new Kt(t.priority),this.previousAlertText=null}static getAlertStringFromResponsePacket(e,t){const s=e.serialize();return t||(s.ignoreProperties=!0),ou.collectResponses(s)}getAlertText(e=!1){const t=Pt.alertableToText(this._alert,e);return this.previousAlertText=t,t}getAlert(){return this._alert}get alert(){return this.getAlert()}set alert(e){this.setAlert(e)}setAlert(e){this._alert=e}setAlertStableDelay(e){this.alertStableDelay=e}toString(){return`Utterance_${this.id}#${this.getAlertText()}`}toStateObject(){return{alert:V(Ei([ge,U])).toStateObject(this.getAlertText())}}reset(){this.previousAlertText=null}setCanAnnounceProperties(e){this.canAnnounceProperty.setDependentProperties(e)}set canAnnounceProperties(e){this.setCanAnnounceProperties(e)}get canAnnounceProperties(){return this.getCanAnnounceProperties()}getCanAnnounceProperties(){return this.canAnnounceProperty.getDependentProperties()}setDescriptionCanAnnounceProperties(e){this.descriptionCanAnnounceProperty.setDependentProperties(e)}set descriptionCanAnnounceProperties(e){this.setDescriptionCanAnnounceProperties(e)}get descriptionCanAnnounceProperties(){return this.getDescriptionCanAnnounceProperties()}getDescriptionCanAnnounceProperties(){return this.descriptionCanAnnounceProperty.getDependentProperties()}setVoicingCanAnnounceProperties(e){this.voicingCanAnnounceProperty.setDependentProperties(e)}set voicingCanAnnounceProperties(e){this.setVoicingCanAnnounceProperties(e)}get voicingCanAnnounceProperties(){return this.getVoicingCanAnnounceProperties()}getVoicingCanAnnounceProperties(){return this.voicingCanAnnounceProperty.getDependentProperties()}dispose(){this.canAnnounceProperty.dispose(),this.descriptionCanAnnounceProperty.dispose(),this.voicingCanAnnounceProperty.dispose(),this.priorityProperty.dispose(),super.dispose()}static alertableToText(e,t=!1){let s;if(typeof e=="function")s=e();else if(e instanceof Oi)s=Pt.getAlertStringFromResponsePacket(e,t);else{if(e instanceof Pt)return e.getAlertText(t);O(e)?s=e.value:s=e}return s}};Pt.TOP_PRIORITY=10,Pt.HIGH_PRIORITY=5,Pt.MEDIUM_PRIORITY=2,Pt.DEFAULT_PRIORITY=Hl,Pt.LOW_PRIORITY=0,Pt.UtteranceIO=new Le("UtteranceIO",{valueType:Pt,documentation:"Announces text to a specific browser technology (like aria-live or web speech)",toStateObject:e=>e.toStateObject(),stateSchema:{alert:V(Ei([ge,U]))}});let yt=Pt;class Oa extends nu{constructor(e){const t=E()({dependentProperties:[]},e),s=new me(new X(!1));super(s),this._dependentProperties=[],this.implementationProperty=s,this.setDependentProperties(t.dependentProperties)}setDependentProperties(e){this.implementationProperty.value&&this.implementationProperty.value.dispose();const t=e.length===0?[new X(!0)]:e;this.implementationProperty.value=be.and(t),this._dependentProperties=e}set dependentProperties(e){this.setDependentProperties(e)}get dependentProperties(){return this.getDependentProperties()}getDependentProperties(){return this._dependentProperties.slice(0)}dispose(){this.implementationProperty.dispose(),this._dependentProperties=[],super.dispose()}}Qt.register("Utterance",yt);const Sn=class Sn extends _e{constructor(e){var s;const t=E()({respectResponseCollectorProperties:!0,phetioType:Sn.AnnouncerIO,phetioState:!1},e);super(t),this.readyToAnnounce=!0,this.hasSpoken=!1,this.respectResponseCollectorProperties=t.respectResponseCollectorProperties,this.announcementCompleteEmitter=new He({parameters:[{name:"utterance",phetioType:yt.UtteranceIO},{name:"text",phetioType:V(Ei([ge,U]))}],tandem:(s=t.tandem)==null?void 0:s.createTandem("announcementCompleteEmitter"),phetioReadOnly:!0,phetioDocumentation:"The announcement that has just completed. The Utterance text could potentially differ from the exact text that was announced, so both are emitted. Use `text` for an exact match of what was announced."})}shouldUtteranceCancelOther(e,t){return t.priorityProperty.value<e.priorityProperty.value}onUtterancePriorityChange(e){}};Sn.AnnouncerIO=new Le("AnnouncerIO",{valueType:Sn,documentation:"Announces text to a specific browser technology (like aria-live or web speech)"});let Gn=Sn;Qt.register("Announcer",Gn);const hu={initialize(){if(window.speechSynthesis||window.SpeechSynthesis||window.SpeechSynthesisUtterance)throw new Error("SpeechSynthesis is supported here, the polyfill should not overwrite it");assert&&assert(window.parent,"This polyfill requires a parent frame implementation of SpeechSynthesis."),window.SpeechSynthesis=window.parent.SpeechSynthesis,window.speechSynthesis=new window.parent.SpeechSynthesis,window.SpeechSynthesisUtterance=window.parent.SpeechSynthesisUtterance}};Qt.register("SpeechSynthesisParentPolyfill",hu);class Is{constructor(e,t,s){if(this.dependencies=e,assert&&assert(e.every(_.identity),"dependencies should all be truthy"),assert&&assert(e.length===_.uniq(e).length,"duplicate dependencies"),this.dependencyListeners=new Map,e.forEach(i=>{const n=()=>{if(!this.isDisposed){const a=e.map(o=>o.get());t(...a)}};this.dependencyListeners.set(i,n),i.lazyLink(n,{phetioDependencies:_.without(e,i)})}),!s){const i=e.map(n=>n.get());t(...i)}this.isDisposed=!1}get definedDependencies(){return assert&&assert(this.dependencies!==null,"Dependencies should be defined, has this Property been disposed?"),this.dependencies}dispose(){assert&&assert(this.dependencies,"A Multilink cannot be disposed twice.");const e=this.definedDependencies;for(let t=0;t<e.length;t++){const s=e[t],i=this.dependencyListeners.get(s);assert&&assert(i,"The listener should exist"),s.hasListener(i)&&s.unlink(i)}this.dependencies=null,this.dependencyListeners.clear(),this.isDisposed=!0}static multilink(e,t){return new Is(e,t,!1)}static multilinkAny(e,t){return new Is(e,t)}static lazyMultilink(e,t){return new Is(e,t,!0)}static lazyMultilinkAny(e,t){return new Is(e,t,!0)}static unmultilink(e){e.dispose()}}it.register("Multilink",Is);window.phet&&phet.chipper&&phet.chipper.queryParameters&&phet.chipper.queryParameters.speechSynthesisFromParent&&hu.initialize();const Vl=5e3,Em=5e3,km=1e4,Gl=125,Am=["Albert","Bad News","Bahh","Bells","Boing","Bubbles","Cellos","Good News","Jester","Organ","Superstar","Trinoids","Whisper","Wobble","Zarvox","Flo","Grandma","Grandpa","Junior"];let zl=0;const Wl={cmn:"zh_CN",yue:"zh_HK","yue-HK":"zh_HK",yue_HK:"zh_HK","fil-PH":"tl",fil_PH:"tl"},$l={cancelSelf:!0,cancelOther:!0,voice:null};class Di extends Gn{constructor(e){var s,i,n,a;const t=E()({respectResponseCollectorProperties:!1,debug:!1},e);super(t),this.debug=t.debug,this.voiceProperty=new me(null,{tandem:(s=t.tandem)==null?void 0:s.createTandem("voiceProperty"),phetioValueType:V(Mm),phetioState:!1,phetioReadOnly:!0,phetioDocumentation:"the voice that is currently voicing responses"}),this.voiceRateProperty=new Kt(1,{range:new os(.75,2),tandem:(i=t.tandem)==null?void 0:i.createTandem("voiceRateProperty"),phetioState:!1,phetioDocumentation:"changes the rate of the voicing-feature voice"}),this.voicePitchProperty=new Kt(1,{range:new os(.5,2),tandem:(n=t.tandem)==null?void 0:n.createTandem("voicePitchProperty"),phetioState:!1,phetioDocumentation:"changes the pitch of the voicing-feature voice"}),this.voiceVolumeProperty=new Kt(1,{range:new os(0,1)}),this.hasSpoken=!1,this.timeSinceWakingEngine=0,this.timeSincePauseResume=0,this.timeSincePendingUtterance=0,this.timeSinceUtteranceEnd=Gl,this.startSpeakingEmitter=new He({parameters:[{valueType:"string"},{valueType:yt}]}),this.endSpeakingEmitter=new He({parameters:[{valueType:"string"},{valueType:yt}]}),this.enabledComponentImplementation=new Xn({enabled:!1,tandem:t.tandem,enabledPropertyOptions:{phetioDocumentation:"toggles this controller of SpeechSynthesis on and off",phetioState:!1,phetioFeatured:!1}}),assert&&assert(this.enabledComponentImplementation.enabledProperty.isSettable(),"enabledProperty must be settable"),this.enabledProperty=this.enabledComponentImplementation.enabledProperty,this.mainWindowVoicingEnabledProperty=new ie(!0,{tandem:(a=t.tandem)==null?void 0:a.createTandem("mainWindowVoicingEnabledProperty"),phetioState:!1,phetioDocumentation:"toggles the voicing feature on and off for the simulation screen (not the voicing preferences and toolbar controls)"}),this.voicingFullyEnabledProperty=be.and([this.enabledProperty,this.mainWindowVoicingEnabledProperty]),this._speechAllowedAndFullyEnabledProperty=new ie(!1),this.speechAllowedAndFullyEnabledProperty=this._speechAllowedAndFullyEnabledProperty,this.synth=null,this.voicesProperty=new me([]),this.speakingSpeechSynthesisUtteranceWrapper=null,this.isInitializedProperty=new ie(!1),this.canSpeakProperty=null,this.boundHandleCanSpeakChange=this.handleCanSpeakChange.bind(this),this.boundHandleCanAnnounceChange=this.handleCanAnnounceChange.bind(this),this.debug&&(this.announcementCompleteEmitter.addListener((o,h)=>{console.log("announcement complete",h)}),this.startSpeakingEmitter.addListener(o=>{this.debug&&console.log("startSpeakingListener",o)}),this.endSpeakingEmitter.addListener(o=>{this.debug&&console.log("endSpeakingListener",o)}))}get initialized(){return this.isInitializedProperty.value}initialize(e,t){assert&&assert(!this.initialized,"can only be initialized once"),assert&&assert(Di.isSpeechSynthesisSupported(),"trying to initialize speech, but speech is not supported on this platform."),assert&&assert(zl===0,"Only one instance of SpeechSynthesisAnnouncer can be initialized at a time."),zl++;const s=E()({speechAllowedProperty:new ie(!0)},t);this.synth=window.speechSynthesis,this.canSpeakProperty=be.and([s.speechAllowedProperty,this.enabledProperty]),this.canSpeakProperty.link(this.boundHandleCanSpeakChange),Is.multilink([s.speechAllowedProperty,this.voicingFullyEnabledProperty],(a,o)=>{this._speechAllowedAndFullyEnabledProperty.value=a&&o});const i=this.getSynth();i.addEventListener&&i.addEventListener("voiceschanged",()=>{this.populateVoices()}),this.populateVoices();const n=()=>{this.timeSinceWakingEngine=Vl,e.removeListener(n)};e.addListener(n),Oe.addListener(this.step.bind(this)),this.isInitializedProperty.value=!0}step(e){e*=1e3;const t=this.getSynth();this.initialized&&t&&(this.hasSpoken||(this.hasSpoken=t.speaking),this.timeSinceUtteranceEnd=t.speaking?0:this.timeSinceUtteranceEnd+e,this.timeSincePendingUtterance=this.speakingSpeechSynthesisUtteranceWrapper&&!this.speakingSpeechSynthesisUtteranceWrapper.started?this.timeSincePendingUtterance+e:0,this.timeSincePendingUtterance>Em&&(assert&&assert(this.speakingSpeechSynthesisUtteranceWrapper,"should have this.speakingSpeechSynthesisUtteranceWrapper"),this.handleSpeechSynthesisEnd(this.speakingSpeechSynthesisUtteranceWrapper.announceText,this.speakingSpeechSynthesisUtteranceWrapper),this.speakingSpeechSynthesisUtteranceWrapper=null,this.cancelSynth()),this.timeSinceUtteranceEnd>Gl&&!this.speakingSpeechSynthesisUtteranceWrapper&&(this.readyToAnnounce=!0),Te.chromium&&!Te.android&&this.voiceProperty.value&&!this.voiceProperty.value.localService&&(this.timeSincePauseResume=t.speaking?this.timeSincePauseResume+e:0,this.timeSincePauseResume>km&&(this.timeSincePauseResume=0,t.pause(),t.resume())),Te.chromeOS&&(this.timeSinceWakingEngine+=e,!t.speaking&&this.timeSinceWakingEngine>Vl&&(this.timeSinceWakingEngine=0,t.speak(new SpeechSynthesisUtterance(" ")))))}handleCanSpeakChange(e){e||this.cancel()}populateVoices(){const e=this.getSynth();e&&(this.voicesProperty.value=_.uniqBy(e.getVoices(),t=>t.name))}getPrioritizedVoices(){assert&&assert(this.initialized,"No voices available until the SpeechSynthesisAnnouncer is initialized"),assert&&assert(this.voicesProperty.value.length>0,"No voices available to provided a prioritized list.");const e=this.voicesProperty.value.slice(),t=_.filter(e,i=>!_.some(Am,n=>i.name.includes(n))),s=i=>i.name.includes("Google")?-1:i.name.includes("Fred")?t.length:t.indexOf(i);return t.sort((i,n)=>s(i)-s(n))}getEnglishPrioritizedVoices(){return _.filter(this.getPrioritizedVoices(),e=>e.lang==="en-US"||e.lang==="en_US")}getPrioritizedVoicesForLocale(e){const t=e,s=e.replace("_","-");return _.filter(this.getPrioritizedVoices(),i=>{const n=Wl.hasOwnProperty(i.lang)?Wl[i.lang]:i.lang;let a=!1;return(n.includes("_")||n.includes("-"))&&(a=t===n.slice(0,2)),a||t===n||s===n})}announce(e,t){this.initialized&&this.canSpeakProperty&&this.canSpeakProperty.value?this.requestSpeech(e,t):this.handleAnnouncementFailure(t,e)}handleAnnouncementFailure(e,t){this.debug&&console.log("announcement failure",t),this.announcementCompleteEmitter.emit(e,t)}speakIgnoringEnabled(e){this.initialized&&(this.cancel(),this.requestSpeech(e.getAlertText(this.respectResponseCollectorProperties),e))}requestSpeech(e,t){if(assert&&assert(Di.isSpeechSynthesisSupported(),"trying to speak with speechSynthesis, but it is not supported on this platform"),this.debug&&console.log("requestSpeech",e),!e){this.handleAnnouncementFailure(t,e);return}const s=ls()({},$l,t.announcerOptions),i=Om(Bo(e+""));Es(i,Dt.STRING_WITHOUT_TEMPLATE_VARS_VALIDATOR);const n=new SpeechSynthesisUtterance(i);n.voice=s.voice||this.voiceProperty.value,n.pitch=this.voicePitchProperty.value,n.rate=this.voiceRateProperty.value,n.volume=this.voiceVolumeProperty.value;const a=()=>{this.startSpeakingEmitter.emit(i,t),assert&&assert(this.speakingSpeechSynthesisUtteranceWrapper,"should have been set in requestSpeech"),this.speakingSpeechSynthesisUtteranceWrapper.started=!0,n.removeEventListener("start",a)},o=()=>{this.handleSpeechSynthesisEnd(i,h)},h=new xm(t,e,n,!1,o,a);assert&&assert(this.speakingSpeechSynthesisUtteranceWrapper===null,"Wrapper should be null, we should have received an end event to clear it before the next one."),this.speakingSpeechSynthesisUtteranceWrapper=h,n.addEventListener("start",a),n.addEventListener("end",o),n.addEventListener("error",o),this.readyToAnnounce=!1,this.timeSinceUtteranceEnd=0,t.canAnnounceProperty.link(this.boundHandleCanAnnounceChange),t.voicingCanAnnounceProperty.link(this.boundHandleCanAnnounceChange),this.getSynth().speak(n)}handleCanAnnounceChange(){this.speakingSpeechSynthesisUtteranceWrapper&&this.cancelUtteranceIfCanAnnounceFalse(this.speakingSpeechSynthesisUtteranceWrapper.utterance)}cancelUtteranceIfCanAnnounceFalse(e){(!e.canAnnounceProperty.value||!e.voicingCanAnnounceProperty.value)&&this.cancelUtterance(e)}handleSpeechSynthesisEnd(e,t){this.endSpeakingEmitter.emit(e,t.utterance),this.announcementCompleteEmitter.emit(t.utterance,t.speechSynthesisUtterance.text),t.speechSynthesisUtterance.removeEventListener("error",t.endListener),t.speechSynthesisUtterance.removeEventListener("end",t.endListener),t.speechSynthesisUtterance.removeEventListener("start",t.startListener);const s=t.utterance.canAnnounceProperty;s.hasListener(this.boundHandleCanAnnounceChange)&&s.unlink(this.boundHandleCanAnnounceChange);const i=t.utterance.voicingCanAnnounceProperty;i.hasListener(this.boundHandleCanAnnounceChange)&&i.unlink(this.boundHandleCanAnnounceChange),this.speakingSpeechSynthesisUtteranceWrapper=null}getSynth(){return assert&&assert(Di.isSpeechSynthesisSupported(),"Trying to use SpeechSynthesis, but it is not supported on this platform."),this.synth}cancel(){this.initialized&&this.speakingSpeechSynthesisUtteranceWrapper&&this.cancelUtterance(this.speakingSpeechSynthesisUtteranceWrapper.utterance)}cancelUtterance(e){const t=this.speakingSpeechSynthesisUtteranceWrapper;t&&e===t.utterance&&(this.handleSpeechSynthesisEnd(t.announceText,t),this.cancelSynth())}shouldUtteranceCancelOther(e,t){const s=ls()({},$l,e.announcerOptions);let i;return t.priorityProperty.value!==e.priorityProperty.value?i=t.priorityProperty.value<e.priorityProperty.value:(i=s.cancelOther,t&&t===e&&(i=s.cancelSelf)),i}onUtterancePriorityChange(e){const t=this.speakingSpeechSynthesisUtteranceWrapper;t&&this.shouldUtteranceCancelOther(e,t.utterance)&&this.cancelUtterance(t.utterance)}cancelSynth(){assert&&assert(this.initialized,"must be initialized to use synth");const e=this.getSynth();e&&e.cancel()}static isSpeechSynthesisSupported(){return!!window.speechSynthesis&&!!window.SpeechSynthesisUtterance}}class xm{constructor(e,t,s,i,n,a){this.utterance=e,this.announceText=t,this.speechSynthesisUtterance=s,this.started=i,this.endListener=n,this.startListener=a}}function Om(r){return r.split("<br/>").join(" ").split("<br>").join(" ")}const Mm=new Le("SpeechSynthesisVoiceIO",{isValidValue:r=>!0,toStateObject:r=>r.name});Qt.register("SpeechSynthesisAnnouncer",Di);class Rm extends Di{constructor(e){const t=E()({respectResponseCollectorProperties:!0,phetioDocumentation:"Announcer that manages the voicing feature, providing audio responses via WebAudio."},e);super(t)}initialize(e,t){super.initialize(e,t),ze.keyupEmitter.addListener(s=>{g.isControlKey(s)&&this.cancel()})}voicingSupportedForLocale(e){return e.startsWith("en")}}const lu=new Rm;d.register("voicingManager",lu);const Wt=lu,Nm=4;let So=1;const vs=class vs extends si{constructor(e){super(),this.attributeString=e}};vs.POLITE=new vs("polite"),vs.ASSERTIVE=new vs("assertive"),vs.enumeration=new ii(vs);let bs=vs;function Ul(r){const e=r.attributeString,t=document.createElement("div");for(let s=1;s<=Nm;s++){const i=document.createElement("p");i.setAttribute("id",`elements-${So}-${e}-${s}`),i.setAttribute("aria-live",e),t.appendChild(i)}return t}const wn=class wn extends Gn{constructor(e){const t=E()({respectResponseCollectorProperties:!1,lang:"en"},e);super(t),this.politeElementIndex=0,this.assertiveElementIndex=0,this.ariaLiveContainer=document.createElement("div"),this.ariaLiveContainer.setAttribute("lang",t.lang),this.ariaLiveContainer.setAttribute("id",`aria-live-elements-${So}`),this.ariaLiveContainer.setAttribute("style","position: absolute; left: 0px; top: 0px; width: 0px; height: 0px; clip: rect(0px 0px 0px 0px); pointer-events: none;");const s=Ul(bs.POLITE),i=Ul(bs.ASSERTIVE);this.ariaLiveContainer.appendChild(s),this.ariaLiveContainer.appendChild(i),this.politeElements=Array.from(s.children),this.assertiveElements=Array.from(i.children),So++}announce(e,t,s){const i=E()({ariaLivePriority:bs.POLITE},s);if(this.hasSpoken=!0,e)if(i.ariaLivePriority===bs.POLITE){const n=this.politeElements[this.politeElementIndex];this.updateLiveElement(n,e,t),this.politeElementIndex=(this.politeElementIndex+1)%this.politeElements.length}else if(i.ariaLivePriority===bs.ASSERTIVE){const n=this.assertiveElements[this.assertiveElementIndex];this.updateLiveElement(n,e,t),this.assertiveElementIndex=(this.assertiveElementIndex+1)%this.assertiveElements.length}else assert&&assert(!1,"unsupported aria live prioirity");this.announcementCompleteEmitter.emit(t,e)}cancel(){}cancelUtterance(e){}updateLiveElement(e,t,s){e.textContent="",e.hidden=!1,this.readyToAnnounce=!1,Oe.setTimeout(()=>{s.predicate()?(N.setTextContent(e,t),Oe.setTimeout(()=>{Te.safari?e.hidden=!0:e.textContent="",this.readyToAnnounce=!0},wn.ARIA_LIVE_DELAY)):this.readyToAnnounce=!0},0)}};wn.ARIA_LIVE_DELAY=200,wn.AriaLive=bs;let Lr=wn;Qt.register("AriaLiveAnnouncer",Lr);const cu=Lr;class du{constructor(e){this.utterance=e,this.timeInQueue=0,this.stableTime=0,this.announcingUtterancePriorityListener=null}resetTimingVariables(){this.timeInQueue=0,this.stableTime=0}}Qt.register("UtteranceWrapper",du);class Xr extends _e{constructor(e,t){const s=E()({debug:!1,initialize:!0,featureSpecificAnnouncingControlPropertyName:null},t);super(s),this.announcer=e,this._initialized=s.initialize,this.featureSpecificAnnouncingControlPropertyName=s.featureSpecificAnnouncingControlPropertyName,this.queue=[],this._muted=!1,this._enabled=!0,this.utteranceToPriorityListenerMap=new Map,this.announcingUtteranceWrapper=null,this.debug=s.debug,this.announcer.announcementCompleteEmitter.addListener(i=>{if(this.announcingUtteranceWrapper&&i===this.announcingUtteranceWrapper.utterance){assert&&assert(this.announcingUtteranceWrapper.announcingUtterancePriorityListener,"announcingUtterancePriorityListener should be set on this.announcingUtteranceWrapper");const n=this.announcingUtteranceWrapper.announcingUtterancePriorityListener;this.announcingUtteranceWrapper.utterance.priorityProperty.hasListener(n)&&(this.announcingUtteranceWrapper.utterance.priorityProperty.unlink(n),this.announcingUtteranceWrapper.announcingUtterancePriorityListener=null,this.announcingUtteranceWrapper=null)}}),this.stepQueueListener=null,this._initialized&&(this.stepQueueListener=this.stepQueue.bind(this),Oe.addListener(this.stepQueueListener))}get length(){return this.queue.length}addToBack(e){if(this.initializedAndEnabled)if(!this.announcer.hasSpoken)this.announceImmediately(e);else{const t=this.prepareUtterance(e);this.queue.push(t),this.debug&&console.log("addToBack"),this.addPriorityListenerAndPrioritizeQueue(t)}}addToFront(e){if(Ot("`addToFront()` has been deprecated because it is confusing, and most of the time doesn't do what is expected, because Utterances are announced based on time-in-queue first, and then position in the queue. It is recommended to use addToBack, and then timing variables on Utterances, or instead call queue.clear() before adding a more important alert to the queue."),!this.initializedAndEnabled)return;const t=this.prepareUtterance(e);this.queue.unshift(t)}addPriorityListenerAndPrioritizeQueue(e){assert&&assert(!this.utteranceToPriorityListenerMap.has(e.utterance),"About to add the priority listener twice and only one should exist on the Utterance. The listener should have been removed by removeOthersAndUpdateUtteranceWrapper.");const t=()=>{this.prioritizeUtterances(e)};e.utterance.priorityProperty.lazyLink(t),this.utteranceToPriorityListenerMap.set(e.utterance,t),this.prioritizeUtterances(e)}prepareUtterance(e){e instanceof yt||(e=new yt({alert:e}));const t=new du(e);return this.removeOthersAndUpdateUtteranceWrapper(t),t.stableTime=0,t}removeUtterance(e){const t=i=>i.utterance===e;assert&&assert(_.find(this.queue,t),"utterance to be removed not found in queue");const s=_.remove(this.queue,t);this.removePriorityListeners(s)}prioritizeUtterances(e){let t=this.queue.indexOf(e);const s=t>=0;let i;s?i=t-1:i=-1;for(let n=i;n>=0;n--){const a=this.queue[n];this.shouldUtteranceCancelOther(e.utterance,a.utterance)&&this.removeUtterance(a.utterance)}if(s){t=this.queue.indexOf(e),assert&&assert(t>-1,"utteranceWrapper is not in queue?");const n=this.queue[t+1];n&&this.shouldUtteranceCancelOther(n.utterance,e.utterance)&&this.removeUtterance(e.utterance)}this.queue.length>0&&this.announcer.onUtterancePriorityChange(this.queue[0].utterance)}shouldUtteranceCancelOther(e,t){return this.announcer.shouldUtteranceCancelOther(e,t)}removeOthersAndUpdateUtteranceWrapper(e){const t=[];for(let i=0;i<this.queue.length;i++){const n=this.queue[i];n.utterance===e.utterance&&t.push(n.timeInQueue)}t.length>=1&&(e.timeInQueue=Math.max(...t));const s=_.remove(this.queue,i=>i.utterance===e.utterance);this.removePriorityListeners(s)}get initializedAndEnabled(){return this._enabled&&this._initialized}getNextUtterance(){let e=null;for(let t=0;t<this.queue.length;t++){const s=this.queue[t];if(s.stableTime>s.utterance.alertStableDelay||s.timeInQueue>s.utterance.alertMaximumDelay){e=s;break}}return e}hasUtterance(e){for(let t=0;t<this.queue.length;t++){const s=this.queue[t];if(e===s.utterance)return!0}return!1}clear(){this.debug&&console.log("UttearnceQueue.clear()"),this.removePriorityListeners(this.queue),this.queue.length=0}cancelUtterance(e){this.announcer.cancelUtterance(e),this.hasUtterance(e)&&this.removeUtterance(e)}cancel(){this.debug&&console.log("UtteranceQueue.cancel()"),this.clear(),this.announcer.cancel()}removePriorityListeners(e){e.forEach(t=>this.removePriorityListener(t.utterance))}removePriorityListener(e){const t=this.utteranceToPriorityListenerMap.get(e);t&&(e.priorityProperty.unlink(t),this.utteranceToPriorityListenerMap.delete(e))}setMuted(e){this._muted=e}set muted(e){this.setMuted(e)}get muted(){return this.getMuted()}getMuted(){return this._muted}setEnabled(e){this._enabled=e}set enabled(e){this.setEnabled(e)}get enabled(){return this.isEnabled()}isEnabled(){return this._enabled}stepQueue(e){if(this._enabled&&(e*=1e3,this.queue.length>0)){for(let s=0;s<this.queue.length;s++){const i=this.queue[s];i.timeInQueue+=e,i.stableTime+=e}const t=this.getNextUtterance();t&&this.attemptToAnnounce(t)}}announceImmediately(e){if(this.initializedAndEnabled&&(this.debug&&console.log("announceImmediately"),e instanceof yt||(e=new yt({alert:e})),this.announcingUtteranceWrapper===null||this.announcer.shouldUtteranceCancelOther(e,this.announcingUtteranceWrapper.utterance))){const t=this.prepareUtterance(e);t.stableTime=Number.POSITIVE_INFINITY,t.timeInQueue=Number.POSITIVE_INFINITY,this.queue.unshift(t),this.addPriorityListenerAndPrioritizeQueue(t),this.queue.includes(t)&&this.attemptToAnnounce(t)}}attemptToAnnounce(e){const t=e.utterance;if(this.announcer.readyToAnnounce){const s=t.getAlertText(this.announcer.respectResponseCollectorProperties);this.debug&&console.log("ready to announce in attemptToAnnounce(): ",s);const i=!this.featureSpecificAnnouncingControlPropertyName||t[this.featureSpecificAnnouncingControlPropertyName].value,n=t.canAnnounceProperty.value&&t.predicate()&&i;!this._muted&&n&&s!==""?(assert&&assert(this.announcingUtteranceWrapper===null,"announcingUtteranceWrapper and its priorityProperty listener should have been disposed"),this.announcingUtteranceWrapper=e,this.announcingUtteranceWrapper.announcingUtterancePriorityListener=()=>{this.prioritizeUtterances(e)},e.utterance.priorityProperty.link(this.announcingUtteranceWrapper.announcingUtterancePriorityListener),this.debug&&console.log("announcing: ",s),this.announcer.announce(s,t,t.announcerOptions)):this.debug&&console.log("announcer readyToAnnounce but utterance cannot announce, will not be spoken: ",s),this.queue.includes(e)&&this.removeUtterance(e.utterance)}else this.debug&&console.log("announcer not readyToAnnounce")}dispose(){this._initialized&&(assert&&assert(this.stepQueueListener),Oe.removeListener(this.stepQueueListener)),super.dispose()}static fromFactory(){const e=new cu,t=new Xr(e),s=e.ariaLiveContainer;document.body?document.body.appendChild(s):document.children[0].appendChild(s);let i=0;const n=a=>{const o=a-i;i=a,phet.axon.stepTimer.emit(o/1e3),window.requestAnimationFrame(n)};return window.requestAnimationFrame(n),t}}Qt.register("UtteranceQueue",Xr);const uu=Xr,jr=new uu(Wt,{featureSpecificAnnouncingControlPropertyName:"voicingCanAnnounceProperty"});jr.enabled=!1;d.register("voicingUtteranceQueue",jr);function Bm(r){if(!(r instanceof yt))throw new Error("utterance is not an Utterance")}class Yl extends yt{constructor(e){super(e)}}const wo=["voicingNameResponse","voicingObjectResponse","voicingContextResponse","voicingHintResponse","voicingUtterance","voicingResponsePatternCollection","voicingIgnoreVoicingManagerProperties","voicingFocusListener"],Ht=r=>{assert&&assert(_.includes(ct(r),D),"Only Node subtypes should compose Voicing");const e=Bi("Voicing",wo,class pu extends nh(r){constructor(...s){super(...s),this._boundInstanceCanVoiceChangeListener=this.onInstanceCanVoiceChange.bind(this),this._voicingUtterance=null,pu.prototype.initialize.call(this)}initialize(...s){return super.initialize&&super.initialize(s),this._voicingCanSpeakProperty=new X(!0),this._voicingResponsePacket=new Oi,this._voicingFocusListener=this.defaultFocusListener,this.setVoicingUtterance(new Yl),this._voicingCanSpeakCount=0,this._boundInstancesChangedListener=this.addOrRemoveInstanceListeners.bind(this),this.changedInstanceEmitter.addListener(this._boundInstancesChangedListener),this._speakContentOnFocusListener={focus:i=>{this._voicingFocusListener&&this._voicingFocusListener(i)}},this.addInputListener(this._speakContentOnFocusListener),this}voicingSpeakFullResponse(s){const i=pe({},s);i.hasOwnProperty("nameResponse")||(i.nameResponse=this._voicingResponsePacket.nameResponse),i.hasOwnProperty("objectResponse")||(i.objectResponse=this._voicingResponsePacket.objectResponse),i.hasOwnProperty("contextResponse")||(i.contextResponse=this._voicingResponsePacket.contextResponse),i.hasOwnProperty("hintResponse")||(i.hintResponse=this._voicingResponsePacket.hintResponse),this.collectAndSpeakResponse(i)}voicingSpeakResponse(s){const i=pe({nameResponse:null,objectResponse:null,contextResponse:null,hintResponse:null},s);this.collectAndSpeakResponse(i)}voicingSpeakNameResponse(s){const i=pe({},s);i.hasOwnProperty("nameResponse")||(i.nameResponse=this._voicingResponsePacket.nameResponse),this.collectAndSpeakResponse(i)}voicingSpeakObjectResponse(s){const i=pe({},s);i.hasOwnProperty("objectResponse")||(i.objectResponse=this._voicingResponsePacket.objectResponse),this.collectAndSpeakResponse(i)}voicingSpeakContextResponse(s){const i=pe({},s);i.hasOwnProperty("contextResponse")||(i.contextResponse=this._voicingResponsePacket.contextResponse),this.collectAndSpeakResponse(i)}voicingSpeakHintResponse(s){const i=pe({},s);i.hasOwnProperty("hintResponse")||(i.hintResponse=this._voicingResponsePacket.hintResponse),this.collectAndSpeakResponse(i)}collectAndSpeakResponse(s){this.speakContent(this.collectResponse(s))}collectResponse(s){const i=pe({ignoreProperties:this._voicingResponsePacket.ignoreProperties,responsePatternCollection:this._voicingResponsePacket.responsePatternCollection,utterance:this.voicingUtterance},s);let n=ou.collectResponses(i);return i.utterance&&(i.utterance.alert=n,n=i.utterance),n}speakContent(s){const i=!se.PHET_IO_ENABLED||!this.isInsidePhetioArchetype();s&&i&&jr.addToBack(s)}setVoicingNameResponse(s){this._voicingResponsePacket.nameResponse=s}set voicingNameResponse(s){this.setVoicingNameResponse(s)}get voicingNameResponse(){return this.getVoicingNameResponse()}getVoicingNameResponse(){return this._voicingResponsePacket.nameResponse}setVoicingObjectResponse(s){this._voicingResponsePacket.objectResponse=s}set voicingObjectResponse(s){this.setVoicingObjectResponse(s)}get voicingObjectResponse(){return this.getVoicingObjectResponse()}getVoicingObjectResponse(){return this._voicingResponsePacket.objectResponse}setVoicingContextResponse(s){this._voicingResponsePacket.contextResponse=s}set voicingContextResponse(s){this.setVoicingContextResponse(s)}get voicingContextResponse(){return this.getVoicingContextResponse()}getVoicingContextResponse(){return this._voicingResponsePacket.contextResponse}setVoicingHintResponse(s){this._voicingResponsePacket.hintResponse=s}set voicingHintResponse(s){this.setVoicingHintResponse(s)}get voicingHintResponse(){return this.getVoicingHintResponse()}getVoicingHintResponse(){return this._voicingResponsePacket.hintResponse}setVoicingIgnoreVoicingManagerProperties(s){this._voicingResponsePacket.ignoreProperties=s}set voicingIgnoreVoicingManagerProperties(s){this.setVoicingIgnoreVoicingManagerProperties(s)}get voicingIgnoreVoicingManagerProperties(){return this.getVoicingIgnoreVoicingManagerProperties()}getVoicingIgnoreVoicingManagerProperties(){return this._voicingResponsePacket.ignoreProperties}setVoicingResponsePatternCollection(s){this._voicingResponsePacket.responsePatternCollection=s}set voicingResponsePatternCollection(s){this.setVoicingResponsePatternCollection(s)}get voicingResponsePatternCollection(){return this.getVoicingResponsePatternCollection()}getVoicingResponsePatternCollection(){return this._voicingResponsePacket.responsePatternCollection}setVoicingUtterance(s){this._voicingUtterance!==s&&(this._voicingUtterance&&this.cleanVoicingUtterance(),Ht.registerUtteranceToVoicingNode(s,this),this._voicingUtterance=s)}set voicingUtterance(s){this.setVoicingUtterance(s)}get voicingUtterance(){return this.getVoicingUtterance()}getVoicingUtterance(){return Bm(this._voicingUtterance),this._voicingUtterance}setVoicingFocusListener(s){this._voicingFocusListener=s}set voicingFocusListener(s){this.setVoicingFocusListener(s)}get voicingFocusListener(){return this.getVoicingFocusListener()}getVoicingFocusListener(){return this._voicingFocusListener}defaultFocusListener(){this.voicingSpeakFullResponse({contextResponse:null})}get isVoicing(){return!0}dispose(){this.removeInputListener(this._speakContentOnFocusListener),this.changedInstanceEmitter.removeListener(this._boundInstancesChangedListener),this._voicingUtterance&&(this.cleanVoicingUtterance(),this._voicingUtterance=null),super.dispose()}clean(){this.removeInputListener(this._speakContentOnFocusListener),this.changedInstanceEmitter.removeListener(this._boundInstancesChangedListener),this._voicingUtterance&&(this.cleanVoicingUtterance(),this._voicingUtterance=null),super.clean&&super.clean()}onInstanceCanVoiceChange(s){s?this._voicingCanSpeakCount++:this._voicingCanSpeakCount--,assert&&assert(this._voicingCanSpeakCount>=0,"the voicingCanSpeakCount should not go below zero"),assert&&assert(this._voicingCanSpeakCount<=this.instances.length,"The voicingCanSpeakCount cannot be greater than the number of Instances."),this._voicingCanSpeakProperty.value=this._voicingCanSpeakCount>0}handleInstancesChanged(s,i){s.visible&&s.voicingVisible&&(this._voicingCanSpeakCount=i?this._voicingCanSpeakCount+1:this._voicingCanSpeakCount-1),this._voicingCanSpeakProperty.value=this._voicingCanSpeakCount>0}addOrRemoveInstanceListeners(s,i){assert&&assert(s.canVoiceEmitter,"Instance must be initialized."),i?s.canVoiceEmitter.addListener(this._boundInstanceCanVoiceChangeListener):s.canVoiceEmitter.removeListener(this._boundInstanceCanVoiceChangeListener),this.handleInstancesChanged(s,i)}cleanVoicingUtterance(){assert&&assert(this._voicingUtterance,"A voicingUtterance must be available to clean."),this._voicingUtterance instanceof Yl?this._voicingUtterance.dispose():this._voicingUtterance&&!this._voicingUtterance.isDisposed&&Ht.unregisterUtteranceToVoicingNode(this._voicingUtterance,this)}mutate(s){return super.mutate(s)}});return e.prototype._mutatorKeys=wo.concat(e.prototype._mutatorKeys),assert&&assert(e.prototype._mutatorKeys.length===_.uniq(e.prototype._mutatorKeys).length,"duplicate mutator keys in Voicing"),e};Ht.VOICING_OPTION_KEYS=wo;Ht.alertUtterance=r=>{assert&&assert(r.voicingCanAnnounceProperties.length>0,"voicingCanAnnounceProperties required, this Utterance might not be connected to Node in the scene graph."),jr.addToBack(r)};Ht.registerUtteranceToVoicingNode=(r,e)=>{const t=r.voicingCanAnnounceProperties,s=e._voicingCanSpeakProperty;t.includes(s)||(r.voicingCanAnnounceProperties=t.concat([s]))};Ht.unregisterUtteranceToVoicingNode=(r,e)=>{const t=r.voicingCanAnnounceProperties,s=e._voicingCanSpeakProperty,i=t.indexOf(s);assert&&assert(i>-1,"voicingNode.voicingCanSpeakProperty is not on the Utterance, was it not registered?"),r.voicingCanAnnounceProperties=t.splice(i,1)};Ht.registerUtteranceToNode=(r,e)=>{const t=r.voicingCanAnnounceProperties;t.includes(e.visibleProperty)||(r.voicingCanAnnounceProperties=r.voicingCanAnnounceProperties.concat([e.visibleProperty])),t.includes(e.voicingVisibleProperty)||(r.voicingCanAnnounceProperties=r.voicingCanAnnounceProperties.concat([e.voicingVisibleProperty]))};Ht.unregisterUtteranceToNode=(r,e)=>{const t=r.voicingCanAnnounceProperties;assert&&assert(t.includes(e.visibleProperty)&&t.includes(e.voicingVisibleProperty),"visibleProperty and voicingVisibleProperty were not on the Utterance, was it not registered to the node?");const s=t.indexOf(e.visibleProperty),n=t.splice(s,1).indexOf(e.voicingVisibleProperty),a=t.splice(n,1);r.voicingCanAnnounceProperties=a};d.register("Voicing",Ht);class gu extends yt{constructor(e,t){super(t),this.readingBlockFocus=e}}d.register("ReadingBlockUtterance",gu);const vr=gu;class mu{constructor(e){this.node=null,this.visibilityTracker=null,this.focusProperty=e,this.boundVisibilityListener=this.handleTrailVisibilityChange.bind(this),this.boundInstancesChangedListener=this.handleInstancesChange.bind(this),this.boundNodeDisposedListener=this.handleNodeDisposed.bind(this),this.boundFocusListener=this.handleFocusChange.bind(this),this.focusProperty.link(this.boundFocusListener)}handleFocusChange(e){this.removeDisplayedListeners(),e&&this.addDisplayedListeners(e)}handleTrailVisibilityChange(){this.visibilityTracker&&!this.visibilityTracker.trailVisibleProperty.value&&(this.focusProperty.value=null)}handleInstancesChange(e){e.node&&e.node.instances.length===0&&(this.focusProperty.value=null)}handleNodeDisposed(){this.focusProperty.value=null}addDisplayedListeners(e){assert&&assert(this.visibilityTracker===null,"creating a new TrailVisibilityTracker but the last one was not disposed"),assert&&assert(this.node===null,"Still a reference to the previously focused Node, possible memory leak"),this.visibilityTracker=new Zd(e.trail),this.visibilityTracker.addListener(this.boundVisibilityListener),this.node=e.trail.lastNode(),this.node.changedInstanceEmitter.addListener(this.boundInstancesChangedListener),this.node.disposeEmitter.addListener(this.boundNodeDisposedListener)}removeDisplayedListeners(){this.visibilityTracker&&(this.visibilityTracker.removeListener(this.boundVisibilityListener),this.visibilityTracker.dispose(),this.visibilityTracker=null),this.node&&(this.node.changedInstanceEmitter.removeListener(this.boundInstancesChangedListener),this.node.disposeEmitter.removeListener(this.boundNodeDisposedListener),this.node=null)}dispose(){this.removeDisplayedListeners(),this.focusProperty.unlink(this.boundFocusListener),this.node=null,this.visibilityTracker=null}}d.register("FocusDisplayedController",mu);const Ma=mu,le=class le{constructor(){this.pointerFocusProperty=new me(null),this.readingBlockFocusProperty=new me(null),this.lockedPointerFocusProperty=new me(null),this.pdomFocusHighlightsVisibleProperty=new ie(!0),this.interactiveHighlightsVisibleProperty=new ie(!1),this.readingBlockHighlightsVisibleProperty=new ie(!1),this.voicingFullyEnabledListener=e=>{this.readingBlockHighlightsVisibleProperty.value=e},Wt.voicingFullyEnabledProperty.link(this.voicingFullyEnabledListener),this.pointerHighlightsVisibleProperty=new be([this.interactiveHighlightsVisibleProperty,this.readingBlockHighlightsVisibleProperty],(e,t)=>e||t),this.readingBlockFocusController=new Ma(this.readingBlockFocusProperty),this.startSpeakingListener=(e,t)=>{this.readingBlockFocusProperty.value=t instanceof vr?t.readingBlockFocus:null},Wt.startSpeakingEmitter.addListener(this.startSpeakingListener),this.endSpeakingListener=(e,t)=>{t instanceof vr&&this.readingBlockFocusProperty.value&&(assert&&assert(t.readingBlockFocus,"should be non null focus"),t.readingBlockFocus.trail.equals(this.readingBlockFocusProperty.value.trail)&&(this.readingBlockFocusProperty.value=null))},Wt.endSpeakingEmitter.addListener(this.endSpeakingListener),this.pointerFocusDisplayedController=new Ma(this.pointerFocusProperty),this.lockedPointerFocusDisplayedController=new Ma(this.lockedPointerFocusProperty),[this.pointerFocusProperty,this.lockedPointerFocusProperty].forEach(e=>{e.link(this.onPointerFocusChange.bind(this))})}dispose(){this.pointerFocusProperty.dispose(),this.readingBlockFocusProperty.dispose(),this.lockedPointerFocusProperty.dispose(),this.pdomFocusHighlightsVisibleProperty.dispose(),this.interactiveHighlightsVisibleProperty.dispose(),this.readingBlockHighlightsVisibleProperty.dispose(),this.readingBlockFocusController.dispose(),this.pointerFocusDisplayedController.dispose(),this.pointerHighlightsVisibleProperty.dispose(),this.lockedPointerFocusDisplayedController.dispose(),Wt.startSpeakingEmitter.removeListener(this.startSpeakingListener),Wt.endSpeakingEmitter.removeListener(this.endSpeakingListener),Wt.voicingFullyEnabledProperty.unlink(this.voicingFullyEnabledListener)}static updatePDOMFocusFromEvent(e,t,s){if(assert&&assert(document.activeElement,"Must be called from focusin, therefore active elemetn expected"),s)for(let i=0;i<e.length;i++){const n=e[i],a=document.activeElement;if(n.isElementUnderPDOM(a)){const o=a.getAttribute(N.DATA_PDOM_UNIQUE_ID);assert&&assert(o,"Event target must have a unique ID on its data if it is in the PDOM.");const h=Ft.uniqueIdToTrail(n,o);assert&&assert(h,"We must have a trail since the target was under the PDOM.");const l=Ft.guessVisualTrail(h,n.rootNode);l.lastNode().focusable?le.pdomFocus=new Nt(n,l):(t.target.blur(),t.stopImmediatePropagation());break}}else for(let i=0;i<e.length;i++){const n=e[i],a=n._input.getRelatedTargetTrail(t);a&&a.lastNode().focusable?le.pdomFocus=new Nt(n,Ft.guessVisualTrail(a,n.rootNode)):le.pdomFocus=null}}onPointerFocusChange(e,t){const s=e==null?void 0:e.trail.lastNode();s&&s.isInteractiveHighlighting&&s.handleHighlightActiveChange();const i=t==null?void 0:t.trail.lastNode();i&&i.isInteractiveHighlighting&&i.handleHighlightActiveChange()}static set pdomFocus(e){if(le.pdomFocusProperty.value!==e){let t;le.pdomFocusProperty.value&&(t=le.pdomFocusedNode),le.pdomFocusProperty.value=e,t&&!e&&t.blur()}}static get pdomFocus(){return le.pdomFocusProperty.value}static getPDOMFocusedNode(){let e=null;const t=le.pdomFocusProperty.get();return t&&(e=t.trail.lastNode()),e}static get pdomFocusedNode(){return this.getPDOMFocusedNode()}static attachToWindow(){assert&&assert(!le.globallyAttached,"Can only be attached statically once."),le.attachedWindowFocusListener=()=>{le._windowHasFocusProperty.value=!0},le.attachedWindowBlurListener=()=>{le._windowHasFocusProperty.value=!1},window.addEventListener("focus",le.attachedWindowFocusListener),window.addEventListener("blur",le.attachedWindowBlurListener),le._windowHasFocusProperty.value=document.hasFocus(),le.globallyAttached=!0}static detachFromWindow(){window.removeEventListener("focus",le.attachedWindowFocusListener),window.removeEventListener("blur",le.attachedWindowBlurListener),le._windowHasFocusProperty.value=!1,le.globallyAttached=!1}};le.attachedWindowFocusListener=null,le.attachedWindowBlurListener=null,le.globallyAttached=!1,le.pdomFocusProperty=new me(null,{tandem:se.GENERAL_MODEL.createTandem("pdomFocusProperty"),phetioDocumentation:"Stores the current focus in the Parallel DOM, null if nothing has focus. This is not updated based on mouse or touch input, only keyboard and other alternative inputs. Note that this only applies to simulations that support alternative input.",phetioValueType:V(Nt.FocusIO),phetioState:!1,phetioFeatured:!0,phetioReadOnly:!0}),le._windowHasFocusProperty=new ie(!1),le.windowHasFocusProperty=le._windowHasFocusProperty;let oe=le;d.register("FocusManager",oe);const Kl=new P("rgba(212,19,106,0.5)"),Xl=new P("rgba(250,40,135,0.9)"),Fm=new P("rgba(233,113,166,1.0)"),Hm=new P("rgba(233,113,166,1.0)"),Vm=new P("rgba(159,15,80,1.0)"),Gm=new P("rgba(159,15,80,1.0)"),zm=2.5,Wm=4,$m=2,Um=2,je=class je extends Pe{constructor(e,t){const s=E()({outerStroke:Kl,innerStroke:Xl,outerLineWidth:null,innerLineWidth:null,dashed:!1,transformSourceNode:null},t);super(e),this.highlightChangedEmitter=new He,this._innerHighlightColor=s.innerStroke,this._outerHighlightColor=s.outerStroke;const i=_.pick(s,Object.keys(Pe.DEFAULT_PATH_OPTIONS));this.innerLineWidth=s.innerLineWidth,this.outerLineWidth=s.outerLineWidth,this.transformSourceNode=s.transformSourceNode,s.stroke=s.outerStroke,this.mutate(s);const n=pe({},i,{stroke:s.innerStroke});this.innerHighlightPath=new Pe(e,n),this.addChild(this.innerHighlightPath),this.updateLineWidth(),s.dashed&&this.makeDashed(!0)}mutateWithInnerHighlight(e){super.mutate(e),this.innerHighlightPath&&this.innerHighlightPath.mutate(e),this.highlightChangedEmitter.emit()}makeDashed(e){const t=e?[7,7]:[];this.mutateWithInnerHighlight({lineDash:t})}setShape(e){return super.setShape(e),this.innerHighlightPath&&this.innerHighlightPath.setShape(e),this.highlightChangedEmitter&&this.highlightChangedEmitter.emit(),this}updateLineWidth(e){e=e||this,this.lineWidth=this.getOuterLineWidth(e),this.innerHighlightPath.lineWidth=this.getInnerLineWidth(e),this.highlightChangedEmitter.emit()}getOuterLineWidth(e){return this.outerLineWidth?this.outerLineWidth:je.getOuterLineWidthFromNode(e)}getInnerLineWidth(e){return this.innerLineWidth?this.innerLineWidth:je.getInnerLineWidthFromNode(e)}setInnerHighlightColor(e){this._innerHighlightColor=e,this.innerHighlightPath.setStroke(e),this.highlightChangedEmitter.emit()}set innerHighlightColor(e){this.setInnerHighlightColor(e)}get innerHighlightColor(){return this.getInnerHighlightColor()}getInnerHighlightColor(){return this._innerHighlightColor}setOuterHighlightColor(e){this._outerHighlightColor=e,this.setStroke(e),this.highlightChangedEmitter.emit()}set outerHighlightColor(e){this.setOuterHighlightColor(e)}get outerHighlightColor(){return this.getOuterHighlightColor()}getOuterHighlightColor(){return this._outerHighlightColor}getUniqueHighlightTrail(e){assert&&assert(this.transformSourceNode,"getUniqueHighlightTrail requires a transformSourceNode");const t=this.transformSourceNode;let s=null;if(t.instances.length<=1)s=t.getUniqueTrail();else{const i=t.getTrails().filter(n=>n.isExtensionOf(e,!0));assert&&assert(i.length===1,"No unique trail to highlight, either avoid DAG for transformSourceNode or don't use transformSourceNode with HighlightPath"),s=i[0]}return assert&&assert(s,"no unique Trail found for getUniqueHighlightTrail"),s}static getInnerLineWidthFromNode(e){return zm/je.getWidthMagnitudeFromTransform(e)}static getOuterLineWidthFromNode(e){return Wm/je.getWidthMagnitudeFromTransform(e)}static getWidthMagnitudeFromTransform(e){return e.transform.transformDelta2(T.X_UNIT).magnitude}static getDilationCoefficient(e){return je.getOuterLineWidthFromNode(e)*(.5+.25)}static getGroupDilationCoefficient(e){return je.getOuterLineWidthFromNode(e)*(.5+1.4)}};je.OUTER_FOCUS_COLOR=Kl,je.INNER_FOCUS_COLOR=Xl,je.INNER_LIGHT_GROUP_FOCUS_COLOR=Fm,je.OUTER_LIGHT_GROUP_FOCUS_COLOR=Hm,je.INNER_DARK_GROUP_FOCUS_COLOR=Vm,je.OUTER_DARK_GROUP_FOCUS_COLOR=Gm,je.GROUP_OUTER_LINE_WIDTH=$m,je.GROUP_INNER_LINE_WIDTH=Um;let Pr=je;d.register("HighlightPath",Pr);const Ie=Pr;class Ym extends Ie{constructor(e,t){const s=E()({outerStroke:Ie.OUTER_LIGHT_GROUP_FOCUS_COLOR,innerStroke:Ie.INNER_LIGHT_GROUP_FOCUS_COLOR,outerLineWidth:Ie.GROUP_OUTER_LINE_WIDTH,innerLineWidth:Ie.GROUP_INNER_LINE_WIDTH},t);super(e,s)}}d.register("GroupHighlightPath",Ym);class fu extends Ie{constructor(e,t){const s=E()({useLocalBounds:!0,dilationCoefficient:null,useGroupDilation:!1},t);s.transformSourceNode=e,super(null,s),this.observedBoundsProperty=null,this.boundsListener=null,this.useLocalBounds=s.useLocalBounds,this.useGroupDilation=s.useGroupDilation,this.dilationCoefficient=s.dilationCoefficient,e&&this.setShapeFromNode(e)}setShapeFromNode(e){this.observedBoundsProperty&&(assert&&assert(this.boundsListener,"should be a listener if there is a previous focusHighlightNode"),this.observedBoundsProperty.unlink(this.boundsListener)),this.observedBoundsProperty=e.localBoundsProperty,this.boundsListener=t=>{if(!t.isFinite())return;let s=this.dilationCoefficient;this.dilationCoefficient===null&&(s=this.useGroupDilation?Ie.getGroupDilationCoefficient(e):Ie.getDilationCoefficient(e));const n=(this.useLocalBounds?e.getVisibleLocalBounds():e.getVisibleBounds()).dilated(s);this.updateLineWidthFromNode(e),this.setShape(H.bounds(n))},this.observedBoundsProperty.link(this.boundsListener)}updateLineWidthFromNode(e){this.lineWidth=this.getOuterLineWidth(e),this.innerHighlightPath.lineWidth=this.getInnerLineWidth(e)}}d.register("HighlightFromNode",fu);const zn=fu;class qr extends zn{constructor(e,t){const s=E()({outerStroke:"grey",innerStroke:"black"},t);super(e,s)}}d.register("ReadingBlockHighlight",qr);const jl=["readingBlockTagName","readingBlockNameResponse","readingBlockHintResponse","readingBlockResponsePatternCollection","readingBlockActiveHighlight"];function Km(r){r instanceof vr||assert&&assert(!1,"utterance is not a ReadinBlockUtterance")}class ql extends vr{constructor(e,t){super(e,t)}}const Xm=new Ns({nameHint:"{{NAME}}. {{HINT}}"}),rh=Me(r=>{const e=Bi("ReadingBlock",jl,class extends Ht(r){constructor(...s){super(...s),this._readingBlockTagName="button",this._readingBlockDisabledTagName="p",this._readingBlockActiveHighlight=null,this.readingBlockActiveHighlightChangedEmitter=new re,this.readingBlockResponsePatternCollection=Xm,this._localBoundsChangedListener=this._onLocalBoundsChanged.bind(this),this.localBoundsProperty.link(this._localBoundsChangedListener),this._readingBlockInputListener={focus:i=>this._speakReadingBlockContentListener(i),up:i=>this._speakReadingBlockContentListener(i),click:i=>this._speakReadingBlockContentListener(i)},this._readingBlockFocusableChangeListener=this._onReadingBlockFocusableChanged.bind(this),Wt.speechAllowedAndFullyEnabledProperty.link(this._readingBlockFocusableChangeListener),this.focusHighlight=new qr(this),this.voicingUtterance=new ql(null)}get isReadingBlock(){return!0}setReadingBlockTagName(s){this._readingBlockTagName=s,this._onReadingBlockFocusableChanged(Wt.speechAllowedAndFullyEnabledProperty.value)}set readingBlockTagName(s){this.setReadingBlockTagName(s)}get readingBlockTagName(){return this.getReadingBlockTagName()}getReadingBlockTagName(){return this._readingBlockTagName}setReadingBlockNameResponse(s){this._voicingResponsePacket.nameResponse=s}set readingBlockNameResponse(s){this.setReadingBlockNameResponse(s)}get readingBlockNameResponse(){return this.getReadingBlockNameResponse()}getReadingBlockNameResponse(){return this._voicingResponsePacket.nameResponse}setReadingBlockHintResponse(s){this._voicingResponsePacket.hintResponse=s}set readingBlockHintResponse(s){this.setReadingBlockHintResponse(s)}get readingBlockHintResponse(){return this.getReadingBlockHintResponse()}getReadingBlockHintResponse(){return this._voicingResponsePacket.hintResponse}setReadingBlockResponsePatternCollection(s){this._voicingResponsePacket.responsePatternCollection=s}set readingBlockResponsePatternCollection(s){this.setReadingBlockResponsePatternCollection(s)}get readingBlockResponsePatternCollection(){return this.getReadingBlockResponsePatternCollection()}getReadingBlockResponsePatternCollection(){return this._voicingResponsePacket.responsePatternCollection}setVoicingUtterance(s){super.setVoicingUtterance(s)}set voicingUtterance(s){super.voicingUtterance=s}get voicingUtterance(){return this.getVoicingUtterance()}getVoicingUtterance(){const s=super.getVoicingUtterance();return Km(s),s}setVoicingNameResponse(){assert&&assert(!1,"ReadingBlocks only support setting the name response via readingBlockNameResponse")}getVoicingNameResponse(){assert&&assert(!1,"ReadingBlocks only support getting the name response via readingBlockNameResponse")}setVoicingObjectResponse(){assert&&assert(!1,"ReadingBlocks do not support setting object response")}getVoicingObjectResponse(){assert&&assert(!1,"ReadingBlocks do not support setting object response")}setVoicingContextResponse(){assert&&assert(!1,"ReadingBlocks do not support setting context response")}getVoicingContextResponse(){assert&&assert(!1,"ReadingBlocks do not support setting context response")}setVoicingHintResponse(){assert&&assert(!1,"ReadingBlocks only support setting the hint response via readingBlockHintResponse.")}getVoicingHintResponse(){assert&&assert(!1,"ReadingBlocks only support getting the hint response via readingBlockHintResponse.")}setVoicingResponsePatternCollection(){assert&&assert(!1,"ReadingBlocks only support setting the response patterns via readingBlockResponsePatternCollection.")}getVoicingResponsePatternCollection(){assert&&assert(!1,"ReadingBlocks only support getting the response patterns via readingBlockResponsePatternCollection.")}setReadingBlockActiveHighlight(s){this._readingBlockActiveHighlight!==s&&(this._readingBlockActiveHighlight=s,this.readingBlockActiveHighlightChangedEmitter.emit())}set readingBlockActiveHighlight(s){this.setReadingBlockActiveHighlight(s)}get readingBlockActiveHighlight(){return this._readingBlockActiveHighlight}getReadingBlockActiveHighlight(){return this._readingBlockActiveHighlight}isReadingBlockActivated(){let s=!1;const i=Object.keys(this.displays);for(let n=0;n<i.length;n++){const a=this.displays[i[n]].focusManager.readingBlockFocusProperty.value;if(a&&a.trail.lastNode()===this){s=!0;break}}return s}get readingBlockActivated(){return this.isReadingBlockActivated()}_onReadingBlockFocusableChanged(s){this.focusable=s,s?(this.tagName=this._readingBlockTagName,this.hasInputListener(this._readingBlockInputListener)||this.addInputListener(this._readingBlockInputListener)):(this.tagName=this._readingBlockDisabledTagName,this.hasInputListener(this._readingBlockInputListener)&&this.removeInputListener(this._readingBlockInputListener))}_onLocalBoundsChanged(s){this.mouseArea=s,this.touchArea=s}_speakReadingBlockContentListener(s){const i=this.getConnectedDisplays(),n=this.voicingUtterance,a=this.collectResponse({nameResponse:this.getReadingBlockNameResponse(),hintResponse:this.getReadingBlockHintResponse(),ignoreProperties:this.voicingIgnoreVoicingManagerProperties,responsePatternCollection:this._voicingResponsePacket.responsePatternCollection,utterance:n});if(a){for(let o=0;o<i.length;o++)if(!this.getDescendantsUseHighlighting(s.trail)){const h=s.trail.subtrailTo(this),l=Ft.guessVisualTrail(h,i[o].rootNode),c=new Nt(i[o],l);n.readingBlockFocus=c,this.speakContent(a)}}}cleanVoicingUtterance(){this._voicingUtterance instanceof ql&&this._voicingUtterance.dispose(),super.cleanVoicingUtterance()}dispose(){Wt.speechAllowedAndFullyEnabledProperty.unlink(this._readingBlockFocusableChangeListener),this.localBoundsProperty.unlink(this._localBoundsChangedListener),this.hasInputListener(this._readingBlockInputListener)&&this.removeInputListener(this._readingBlockInputListener),super.dispose()}mutate(s){return super.mutate(s)}});return e.prototype._mutatorKeys=jl.concat(e.prototype._mutatorKeys),assert&&assert(e.prototype._mutatorKeys.length===_.uniq(e.prototype._mutatorKeys).length,"x mutator keys in ReadingBlock"),e});d.register("ReadingBlock",rh);const ei={isPlatformMac:()=>_.includes(window.navigator.platform,"Mac"),getPlatformZoomMetaKey:()=>ei.isPlatformMac()?"metaKey":"ctrlKey",isZoomCommand:(r,e)=>{const t=e?g.KEY_EQUALS:g.KEY_MINUS,s=ei.getPlatformZoomMetaKey();return r[s]&&g.isKeyEvent(r,t)},isZoomResetCommand:r=>{const e=ei.getPlatformZoomMetaKey();return r[e]&&g.isKeyEvent(r,g.KEY_0)}};d.register("KeyboardZoomUtils",ei);const Ql={INPUT:[...g.ARROW_KEYS,g.KEY_PAGE_UP,g.KEY_PAGE_DOWN,g.KEY_HOME,g.KEY_END,g.KEY_ENTER,g.KEY_SPACE],DIV:[...g.ARROW_KEYS,...g.WASD_KEYS],P:[g.KEY_ESCAPE],BUTTON:[g.KEY_ENTER,g.KEY_SPACE]},Zl=g.ALL_KEYS,Jl=100,jm=.1,yu=.6,qm=yu+.1,Qm="keydown",Zm="keyup";class Jm{constructor(e,t){this.display=e,this.random=new No({seed:t}),this.numberOfComponentsTested=10,this.keyupListeners=[],this.currentElement=null}chooseNextElement(){if(this.currentElement===null)this.currentElement=document.activeElement;else if(this.random.nextDouble()<jm){sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.KeyboardFuzzer("choosing new element"),sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.push(),this.clearListeners();const e=N.getRandomFocusable(this.random);e.focus(),this.currentElement=e,sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.pop()}}clearListeners(){this.keyupListeners.forEach(e=>{assert&&assert(typeof e.timeout=="function","should have an attached timeout"),Oe.clearTimeout(e.timeout),e(),assert&&assert(!this.keyupListeners.includes(e),"calling listener should remove itself from the keyupListeners.")})}triggerClickEvent(){sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.KeyboardFuzzer("triggering click"),sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.push();const e=document.activeElement;e instanceof HTMLElement&&e.click(),sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.pop()}triggerKeyDownUpEvents(e){sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.KeyboardFuzzer(`trigger keydown/up: ${e}`),sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.push(),this.triggerDOMEvent(Qm,e);const t=this.random.nextInt(Jl),s=()=>{this.triggerDOMEvent(Zm,e),this.keyupListeners.includes(s)&&this.keyupListeners.splice(this.keyupListeners.indexOf(s),1)};s.timeout=Oe.setTimeout(s,t===Jl?2e3:t),this.keyupListeners.push(s),sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.pop()}triggerRandomKeyDownUpEvents(e){const t=Zl[Math.floor(this.random.nextDouble()*(Zl.length-1))];sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.KeyboardFuzzer(`trigger random keydown/up: ${t}`),sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.push(),this.triggerKeyDownUpEvents(t),sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.pop()}fuzzBoardEvents(e){if(this.display&&this.display._input&&this.display._input.pdomPointer){const t=this.display._input.pdomPointer;t&&!t.blockTrustedEvents&&(t.blockTrustedEvents=!0)}for(let t=0;t<this.numberOfComponentsTested;t++){this.chooseNextElement();for(let s=0;s<e/this.numberOfComponentsTested;s++){sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.KeyboardFuzzer(`main loop, i=${s}`),sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.push();const i=document.activeElement;if(i&&Ql[i.tagName.toUpperCase()]){const n=this.random.nextDouble();if(n<yu){const a=Ql[i.tagName],o=this.random.sample(a);this.triggerKeyDownUpEvents(o)}else n<qm?this.triggerClickEvent():this.triggerRandomKeyDownUpEvents(i)}else i&&this.triggerRandomKeyDownUpEvents(i);sceneryLog&&sceneryLog.KeyboardFuzzer&&sceneryLog.pop()}}}triggerDOMEvent(e,t){if(document.activeElement){const s=new KeyboardEvent(e,{bubbles:!0,code:t,shiftKey:ze.shiftKeyDown,altKey:ze.altKeyDown,ctrlKey:ze.ctrlKeyDown});document.activeElement.dispatchEvent(s)}}}d.register("KeyboardFuzzer",Jm);class ef extends zn{constructor(e,t){const s=E()({outerStroke:Ie.OUTER_LIGHT_GROUP_FOCUS_COLOR,innerStroke:Ie.INNER_LIGHT_GROUP_FOCUS_COLOR,outerLineWidth:Ie.GROUP_OUTER_LINE_WIDTH,innerLineWidth:Ie.GROUP_INNER_LINE_WIDTH,useGroupDilation:!0},t);super(e,s)}}d.register("GroupHighlightFromNode",ef);const ec="rgba(255,255,0,0.5)",jh=class jh extends zn{constructor(e,t){const s=E()({innerStroke:null,outerStroke:null,fill:ec},t);super(e,s)}};jh.ACTIVATED_HIGHLIGHT_COLOR=ec;let _r=jh;d.register("ActivatedReadingBlockHighlight",_r);const tf=_r,dn="PRIMARY_SIBLING",sf="LABEL_SIBLING",nf="DESCRIPTION_SIBLING",rf="CONTAINER_PARENT",af=N.TAGS.LABEL,of=N.TAGS.INPUT,Ra="disabled",hf={attributes:!1,childList:!0,characterData:!0};let lf=1;const Ws=new w(0,0,0,0),es=new w(0,0,0,0),tc=new C,sc=new C,cf=new C;class Ze{constructor(e,t){this.initializePDOMPeer(e,t)}initializePDOMPeer(e,t){return t=Je({primarySibling:null},t),assert&&assert(!this.id||this.isDisposed,"If we previously existed, we need to have been disposed"),this.id=this.id||lf++,this.pdomInstance=e,this.node=this.pdomInstance.node,this.display=e.display,this.trail=e.trail,this.visible=null,this.focusable=null,this._labelSibling=null,this._descriptionSibling=null,this._containerParent=null,this.topLevelElements=[],this.positionDirty=!1,this.forceReflowWorkaround=!1,this.childPositionDirty=!1,this.positionInPDOM=!1,this.mutationObserver=this.mutationObserver||new MutationObserver(this.invalidateCSSPositioning.bind(this,!1)),this.transformListener=this.transformListener||this.invalidateCSSPositioning.bind(this,!1),this.pdomInstance.transformTracker.addListener(this.transformListener),this._preservedDisabledValue=null,this.isDisposed=!1,this.pdomInstance.isRootInstance&&(this._primarySibling=t.primarySibling,this._primarySibling.classList.add(qo.ROOT_CLASS_NAME),N.BLOCKED_DOM_EVENTS.forEach(s=>{this._primarySibling.addEventListener(s,i=>{i.stopPropagation()})})),this}update(e){let t=this.node.getBaseOptions();const s=[];this.node.accessibleName!==null&&(t=this.node.accessibleNameBehavior(this.node,t,this.node.accessibleName,s),assert&&assert(typeof t=="object","should return an object")),this.node.pdomHeading!==null&&(t=this.node.pdomHeadingBehavior(this.node,t,this.node.pdomHeading,s),assert&&assert(typeof t=="object","should return an object")),this.node.helpText!==null&&(t=this.node.helpTextBehavior(this.node,t,this.node.helpText,s),assert&&assert(typeof t=="object","should return an object")),this._primarySibling=cr(t.tagName,this.node.focusable,{namespace:t.pdomNamespace}),t.containerTagName&&(this._containerParent=cr(t.containerTagName,!1)),t.labelTagName&&(this._labelSibling=cr(t.labelTagName,!1,{excludeFromInput:this.node.excludeLabelSiblingFromInput})),t.descriptionTagName&&(this._descriptionSibling=cr(t.descriptionTagName,!1)),e&&this.updateIndicesStringAndElementIds(),this.orderElements(t),this.mutationObserver.disconnect(),this.mutationObserver.observe(this._primarySibling,hf),t.labelContent&&t.labelTagName!==null&&this.setLabelSiblingContent(t.labelContent),t.innerContent&&t.tagName!==null&&this.setPrimarySiblingContent(t.innerContent),t.descriptionContent&&t.descriptionTagName!==null&&this.setDescriptionSiblingContent(t.descriptionContent),t.tagName.toUpperCase()===of&&t.inputType&&this.setAttributeToElement("type",t.inputType),t.labelTagName&&t.labelTagName.toUpperCase()===af&&this.setAttributeToElement("for",this._primarySibling.id,{elementName:Ze.LABEL_SIBLING}),this.setFocusable(this.node.focusable),this.setPositionInPDOM(this.node.positionInPDOM),this.onAriaLabelledbyAssociationChange(),this.onAriaDescribedbyAssociationChange(),this.onActiveDescendantAssociationChange(),this.onAttributeChange(t),this.onClassChange(),this.onInputValueChange(),this.node.updateOtherNodesAriaLabelledby(),this.node.updateOtherNodesAriaDescribedby(),this.node.updateOtherNodesActiveDescendant(),s.forEach(i=>{assert&&assert(typeof i=="function"),i()})}orderElements(e){this._containerParent?(this._containerParent.insertBefore(this._primarySibling,this._containerParent.children[0]||null),this.topLevelElements=[this._containerParent]):this.topLevelElements=[this._labelSibling,this._descriptionSibling,this._primarySibling].filter(_.identity),this._labelSibling&&this.arrangeContentElement(this._labelSibling,e.appendLabel),this._descriptionSibling&&this.arrangeContentElement(this._descriptionSibling,e.appendDescription)}getPrimarySibling(){return this._primarySibling}get primarySibling(){return this.getPrimarySibling()}getLabelSibling(){return this._labelSibling}get labelSibling(){return this.getLabelSibling()}getDescriptionSibling(){return this._descriptionSibling}get descriptionSibling(){return this.getDescriptionSibling()}getContainerParent(){return this._containerParent}get containerParent(){return this.getContainerParent()}getTopLevelElementContainingPrimarySibling(){return this._containerParent||this._primarySibling}onAriaLabelledbyAssociationChange(){this.removeAttributeFromAllElements("aria-labelledby");for(let e=0;e<this.node.ariaLabelledbyAssociations.length;e++){const t=this.node.ariaLabelledbyAssociations[e];assert&&assert(t.otherNode.nodesThatAreAriaLabelledbyThisNode.indexOf(this.node)>=0,"unexpected otherNode"),this.setAssociationAttribute("aria-labelledby",t)}}onAriaDescribedbyAssociationChange(){this.removeAttributeFromAllElements("aria-describedby");for(let e=0;e<this.node.ariaDescribedbyAssociations.length;e++){const t=this.node.ariaDescribedbyAssociations[e];assert&&assert(t.otherNode.nodesThatAreAriaDescribedbyThisNode.indexOf(this.node)>=0,"unexpected otherNode"),this.setAssociationAttribute("aria-describedby",t)}}onActiveDescendantAssociationChange(){this.removeAttributeFromAllElements("aria-activedescendant");for(let e=0;e<this.node.activeDescendantAssociations.length;e++){const t=this.node.activeDescendantAssociations[e];assert&&assert(t.otherNode.nodesThatAreActiveDescendantToThisNode.indexOf(this.node)>=0,"unexpected otherNode"),this.setAssociationAttribute("aria-activedescendant",t)}}handleAttributeWithPDOMOption(e,t){typeof t=="string"?this.setAttributeToElement(e,t):this.removeAttributeFromElement(e)}onAttributeChange(e){for(let t=0;t<this.node.pdomAttributes.length;t++){const s=this.node.pdomAttributes[t];this.setAttributeToElement(s.attribute,s.value,s.options)}this.handleAttributeWithPDOMOption("aria-label",e.ariaLabel),this.handleAttributeWithPDOMOption("role",e.ariaRole)}onClassChange(){for(let e=0;e<this.node.pdomClasses.length;e++){const t=this.node.pdomClasses[e];this.setClassToElement(t.className,t.options)}}onInputValueChange(){if(assert&&assert(this.node.inputValue!==void 0,"use null to remove input value attribute"),this.node.inputValue===null)this.removeAttributeFromElement("value");else{const e=`${this.node.inputValue}`;this.setAttributeToElement("value",e,{asProperty:!0})}}getElementByName(e){if(e===Ze.PRIMARY_SIBLING)return this._primarySibling;if(e===Ze.LABEL_SIBLING)return this._labelSibling;if(e===Ze.DESCRIPTION_SIBLING)return this._descriptionSibling;if(e===Ze.CONTAINER_PARENT)return this._containerParent;throw new Error(`invalid elementName name: ${e}`)}setAttributeToElement(e,t,s){s=Je({namespace:null,asProperty:!1,elementName:dn,element:null},s);const i=s.element||this.getElementByName(s.elementName),n=N.unwrapProperty(t);let a=n;typeof n=="string"&&(a=Bo(n)),e===Ra&&!this.display.interactive&&(this._preservedDisabledValue=s.asProperty?a:!0),s.namespace?i.setAttributeNS(s.namespace,e,a):s.asProperty?i[e]=a:i.setAttribute(e,a)}removeAttributeFromElement(e,t){t=Je({namespace:null,elementName:dn,element:null},t);const s=t.element||this.getElementByName(t.elementName);t.namespace?s.removeAttributeNS(t.namespace,e):e===Ra&&!this.display.interactive?this._preservedDisabledValue=!1:s.removeAttribute(e)}removeAttributeFromAllElements(e){assert&&assert(e!==Ra,"this method does not currently support disabled, to make Display.interactive toggling easier to implement"),assert&&assert(typeof e=="string"),this._primarySibling&&this._primarySibling.removeAttribute(e),this._labelSibling&&this._labelSibling.removeAttribute(e),this._descriptionSibling&&this._descriptionSibling.removeAttribute(e),this._containerParent&&this._containerParent.removeAttribute(e)}setClassToElement(e,t){assert&&assert(typeof e=="string"),t=Je({elementName:dn},t),this.getElementByName(t.elementName).classList.add(e)}removeClassFromElement(e,t){assert&&assert(typeof e=="string"),t=Je({elementName:dn},t),this.getElementByName(t.elementName).classList.remove(e)}setAssociationAttribute(e,t){assert&&assert(N.ASSOCIATION_ATTRIBUTES.indexOf(e)>=0,`unsupported attribute for setting with association object: ${e}`);const s=t.otherNode.getPDOMInstances();if(s.length>0){const i=s[0];i===this.pdomInstance&&(i.peer=this),assert&&assert(i.peer,"peer should exist");const n=i.peer.getElementByName(t.otherElementName),a=this.getElementByName(t.thisElementName);if(a&&n){const o=a.getAttribute(e)||"";assert&&assert(typeof o=="string");const h=[o.trim(),n.id].join(" ").trim();this.setAttributeToElement(e,h,{elementName:t.thisElementName})}}}arrangeContentElement(e,t){if(this.topLevelElements[0]===this._containerParent)assert&&assert(this.topLevelElements.length===1),t?this._containerParent.appendChild(e):this._containerParent.insertBefore(e,this._primarySibling);else{Tt(this.topLevelElements,e);const s=this.topLevelElements.indexOf(this._primarySibling),i=t?this.topLevelElements.length:s;this.topLevelElements.splice(i,0,e)}}isVisible(){if(assert){let e=0;this.topLevelElements.forEach(t=>{!t.hidden&&!t.hasAttribute("hidden")&&(e+=1)}),assert(this.visible?e===this.topLevelElements.length:e===0,"some of the peer's elements are visible and some are not")}return this.visible===null?!0:this.visible}setVisible(e){if(assert&&assert(typeof e=="boolean"),this.visible!==e){this.visible=e;for(let t=0;t<this.topLevelElements.length;t++){const s=this.topLevelElements[t];e?this.removeAttributeFromElement("hidden",{element:s}):this.setAttributeToElement("hidden","",{element:s})}this.invalidateCSSPositioning(Te.safari)}}isFocused(){const e=Ft.guessVisualTrail(this.trail,this.display.rootNode);return oe.pdomFocusProperty.value&&oe.pdomFocusProperty.value.trail.equals(e)}focus(){assert&&assert(this._primarySibling,"must have a primary sibling to focus"),oe.windowHasFocusProperty.value&&this._primarySibling.focus()}blur(){assert&&assert(this._primarySibling,"must have a primary sibling to blur"),this._primarySibling.blur()}setFocusable(e){assert&&assert(typeof e=="boolean");const t=this.isFocused();this.focusable!==e&&(this.focusable=e,N.overrideFocusWithTabIndex(this.primarySibling,e),t&&!e&&this.blur(),this.invalidateCSSPositioning())}setLabelSiblingContent(e){assert&&assert(e===null||typeof e=="string","incorrect label content type"),this._labelSibling&&N.setTextContent(this._labelSibling,e)}setDescriptionSiblingContent(e){assert&&assert(e===null||typeof e=="string","incorrect description content type"),this._descriptionSibling&&N.setTextContent(this._descriptionSibling,e)}setPrimarySiblingContent(e){assert&&assert(e===null||typeof e=="string","incorrect inner content type"),assert&&assert(this.pdomInstance.children.length===0,"descendants exist with accessible content, innerContent cannot be used"),assert&&assert(N.tagNameSupportsContent(this._primarySibling.tagName),`tagName: ${this.node.tagName} does not support inner content`),this._primarySibling&&N.setTextContent(this._primarySibling,e)}setPDOMTransformSourceNode(e){this.pdomInstance.transformTracker.removeListener(this.transformListener),this.pdomInstance.updateTransformTracker(e),this.pdomInstance.transformTracker.addListener(this.transformListener),this.invalidateCSSPositioning()}setPositionInPDOM(e){this.positionInPDOM=e,this.invalidateCSSPositioning()}getElementId(e,t){return`display${this.display.id}-${e}-${t}`}updateIndicesStringAndElementIds(){const e=this.pdomInstance.getPDOMInstanceUniqueId();this._primarySibling&&(this._primarySibling.setAttribute(N.DATA_PDOM_UNIQUE_ID,e),this._primarySibling.id=this.getElementId("primary",e)),this._labelSibling&&(this._labelSibling.setAttribute(N.DATA_PDOM_UNIQUE_ID,e),this._labelSibling.id=this.getElementId("label",e)),this._descriptionSibling&&(this._descriptionSibling.setAttribute(N.DATA_PDOM_UNIQUE_ID,e),this._descriptionSibling.id=this.getElementId("description",e)),this._containerParent&&(this._containerParent.setAttribute(N.DATA_PDOM_UNIQUE_ID,e),this._containerParent.id=this.getElementId("container",e))}invalidateCSSPositioning(e=!1){if(!this.positionDirty){if(this.positionDirty=!0,e){this.forceReflowWorkaround=!0;for(let s=0;s<this.topLevelElements.length;s++)this.topLevelElements[s].style.transform="scale(1)"}let t=this.pdomInstance.parent;for(;t;)t.peer.childPositionDirty=!0,t=t.parent}}positionElements(e){if(assert&&assert(this._primarySibling,"a primary sibling required to receive CSS positioning"),assert&&assert(this.positionDirty,"elements should only be repositioned if dirty"),e){const t=this.node.pdomTransformSourceNode||this.node;if(Ws.set(t.localBounds),Ws.isFinite()){Ws.transform(this.pdomInstance.transformTracker.getMatrix());const s=this.display.bounds;if(s.intersectsBounds(Ws)){Ws.constrainBounds(s);let i=nc(this._primarySibling),n=i.width,a=i.height;n>0&&a>0&&(es.setMinMax(0,0,n,a),es.transform(ic(n,a,Ws)),dr(this._primarySibling,es)),this.labelSibling&&(i=nc(this._labelSibling),n=i.width,a=i.height,a>0&&n>0&&(es.setMinMax(0,0,n,a),es.transform(ic(n,a,Ws)),dr(this._labelSibling,es)))}}}else es.set(Ze.OFFSCREEN_SIBLING_BOUNDS),dr(this._primarySibling,es),this._labelSibling&&dr(this._labelSibling,es);this.forceReflowWorkaround&&this.topLevelElements.forEach(t=>{t.style.transform="",t.style.offsetHeight}),this.positionDirty=!1,this.forceReflowWorkaround=!1}updateSubtreePositioning(e=!1){this.childPositionDirty=!1;const t=this.positionInPDOM||e;this.positionDirty&&this.positionElements(t);for(let s=0;s<this.pdomInstance.children.length;s++){const i=this.pdomInstance.children[s].peer;(i.positionDirty||i.childPositionDirty)&&this.pdomInstance.children[s].peer.updateSubtreePositioning(t)}}recursiveDisable(e){e?(this._preservedDisabledValue=this._primarySibling.disabled,this._primarySibling.disabled=!0):this._primarySibling.disabled=this._preservedDisabledValue;for(let t=0;t<this.pdomInstance.children.length;t++)this.pdomInstance.children[t].peer.recursiveDisable(e)}dispose(){this.isDisposed=!0,this.blur(),this._primarySibling.removeEventListener("blur",this.blurEventListener),this._primarySibling.removeEventListener("focus",this.focusEventListener),this.pdomInstance.transformTracker.removeListener(this.transformListener),this.mutationObserver.disconnect(),this.pdomInstance=null,this.node=null,this.display=null,this.trail=null,this._primarySibling=null,this._labelSibling=null,this._descriptionSibling=null,this._containerParent=null,this.focusable=null,this.freeToPool()}}Ze.PRIMARY_SIBLING=dn;Ze.LABEL_SIBLING=sf;Ze.DESCRIPTION_SIBLING=nf;Ze.CONTAINER_PARENT=rf;Ze.OFFSCREEN_SIBLING_BOUNDS=new w(0,0,1,1);d.register("PDOMPeer",Ze);ae.mixInto(Ze,{initialize:Ze.prototype.initializePDOMPeer});function cr(r,e,t){t=Je({siblingName:null,excludeFromInput:!1},t);const s=N.createElement(r,e,t);return t.excludeFromInput&&s.setAttribute(N.DATA_EXCLUDE_FROM_INPUT,!0),s}function ic(r,e,t){return tc.setToTranslation(t.minX,t.minY),sc.setToScale(t.width/r,t.height/e),tc.multiplyMatrix(sc).multiplyMatrix(cf)}function nc(r){let e=r.clientWidth,t=r.clientHeight;if(e===0&&t===0){const s=r.getBoundingClientRect();e=s.width,t=s.height}return{width:e,height:t}}function dr(r,e){r.style.top=`${e.top}px`,r.style.left=`${e.left}px`,r.style.width=`${e.width}px`,r.style.height=`${e.height}px`}const ns=Ze,Ps=class Ps extends si{};Ps.INDICES=new Ps,Ps.TRAIL_ID=new Ps,Ps.enumeration=new ii(Ps);let At=Ps;const fs=At.TRAIL_ID;let df=1;const _s=class _s{constructor(e,t,s){this.relativeNodes=[],this.relativeVisibilities=[],this.relativeListeners=[],this.transformTracker=null,this.initializePDOMInstance(e,t,s)}initializePDOMInstance(e,t,s){if(assert&&assert(!this.id||this.isDisposed,"If we previously existed, we need to have been disposed"),this.id=this.id||df++,this.parent=e,this.display=t,this.trail=s,this.isRootInstance=e===null,this.node=this.isRootInstance?null:s.lastNode(),this.children=ee(this.children),this.node&&this.node.addPDOMInstance(this),this.invisibleCount=0,this.relativeNodes=[],this.relativeVisibilities=[],this.relativeListeners=[],this.transformTracker=null,this.updateTransformTracker(this.node?this.node.pdomTransformSourceNode:null),this.isDisposed=!1,this.isRootInstance){const i=document.createElement("div");this.peer=ns.createFromPool(this,{primarySibling:i})}else{this.peer=ns.createFromPool(this),this.peer.update(fs===At.TRAIL_ID),assert&&assert(this.peer.primarySibling,"accessible peer must have a primarySibling upon completion of construction");const i=this.parent.trail;for(let n=i.length;n<s.length;n++){const a=s.nodes[n];this.relativeNodes.push(a);const o=a._pdomDisplaysInfo.pdomDisplays,h=_.includes(o,t);this.relativeVisibilities.push(h),h||this.invisibleCount++;const l=this.checkAccessibleDisplayVisibility.bind(this,n-i.length);a.pdomDisplaysEmitter.addListener(l),this.relativeListeners.push(l)}this.updateVisibility()}return sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.PDOMInstance(`Initialized ${this.toString()}`),this}addConsecutiveInstances(e){sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.PDOMInstance(`addConsecutiveInstances on ${this.toString()} with: ${e.map(s=>s.toString()).join(",")}`),sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.push();const t=this.children.length>0;Array.prototype.push.apply(this.children,e);for(let s=0;s<e.length;s++)assert&&assert(!!this.peer.primarySibling,"Primary sibling must be defined to insert elements."),N.insertElements(this.peer.primarySibling,e[s].peer.topLevelElements);t&&this.sortChildren(),assert&&this.node&&(assert&&assert(this.node instanceof D),this.children.length>0&&assert(!this.node.innerContent,`${this.children.length} child PDOMInstances present but this node has innerContent: ${this.node.innerContent}`)),fs===At.INDICES&&this.updateDescendantPeerIds(e),sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.pop()}removeInstancesForTrail(e){sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.PDOMInstance(`removeInstancesForTrail on ${this.toString()} with trail ${e.toString()}`),sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.push();for(let t=0;t<this.children.length;t++){const s=this.children[t],i=s.trail;let n=i.length<e.length;if(!n){for(let a=this.trail.length;a<e.length;a++)if(e.nodes[a]!==i.nodes[a]){n=!0;break}}n||(this.children.splice(t,1),s.dispose(),t-=1)}sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.pop()}removeAllChildren(){for(sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.PDOMInstance(`removeAllChildren on ${this.toString()}`),sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.push();this.children.length;)this.children.pop().dispose();sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.pop()}findChildWithTrail(e){for(let t=0;t<this.children.length;t++){const s=this.children[t];if(s.trail.equals(e))return s}return null}removeSubtree(e){sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.PDOMInstance(`removeSubtree on ${this.toString()} with trail ${e.toString()}`),sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.push();for(let t=this.children.length-1;t>=0;t--){const s=this.children[t];s.trail.isExtensionOf(e,!0)&&(sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.PDOMInstance(`Remove parent: ${this.toString()}, child: ${s.toString()}`),this.children.splice(t,1),s.dispose())}sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.pop()}checkAccessibleDisplayVisibility(e){const t=_.includes(this.relativeNodes[e]._pdomDisplaysInfo.pdomDisplays,this.display),s=this.relativeVisibilities[e];if(t!==s){this.relativeVisibilities[e]=t;const i=this.invisibleCount===0;this.invisibleCount+=t?-1:1,assert&&assert(this.invisibleCount>=0&&this.invisibleCount<=this.relativeNodes.length),this.invisibleCount===0!==i&&this.updateVisibility()}}updateVisibility(){assert&&assert(!!this.peer,"Peer needs to be available on update visibility."),this.peer.setVisible(this.invisibleCount<=0),!this.peer.isVisible()&&oe.pdomFocusedNode&&(assert&&assert(oe.pdomFocusedNode.pdomInstances.length===1,"focusable Nodes do not support DAG, and should be connected with an instance if focused."),oe.pdomFocusedNode.pdomInstances[0].trail.containsNode(this.node)&&(oe.pdomFocus=null))}isGloballyVisible(){return assert&&assert(!!this.peer,"PDOMPeer needs to be available, has this PDOMInstance been disposed?"),this.peer.isVisible()?this.parent?this.parent.isGloballyVisible():!0:!1}getChildOrdering(e){const t=e.lastNode(),s=t.getEffectiveChildren();let i;const n=[];if(t.hasPDOMContent&&t!==this.node){const a=t.pdomInstances;e:for(i=0;i<a.length;i++){const o=a[i];if(o.parent===this){for(let h=0;h<e.length;h++)if(e.nodes[h]!==o.trail.nodes[h+o.trail.length-e.length])continue e;n.push(o)}}assert&&assert(n.length<=1,"If we select more than one this way, we have problems")}else for(i=0;i<s.length;i++)e.addDescendant(s[i],i),Array.prototype.push.apply(n,this.getChildOrdering(e)),e.removeDescendant();return n}sortChildren(){var o,h;assert&&assert(this.peer!==null,"peer required for sort");let e;this.isRootInstance?(assert&&assert(this.display!==null,"Display should be available for the root"),e=this.display.rootNode):(assert&&assert(this.node!==null,"Node should be defined, were we disposed?"),e=this.node);const t=this.getChildOrdering(new R(e));assert&&assert(t.length===this.children.length,"sorting should not change number of children"),this.children=t;const s=this.peer.primarySibling,i=((h=(o=oe.pdomFocusedNode)==null?void 0:o.pdomInstances[0])==null?void 0:h.trail)||null;let n=s.childNodes.length-1;const a=i&&_.find(this.children,l=>i.containsNode(l.peer.node));if(a){const l=_.flatten(this.children.map(u=>u.peer.topLevelElements));if(!_.every(l,(u,m)=>s.children[m]===u)){const u=a.peer.getTopLevelElementContainingPrimarySibling(),m=l.indexOf(u);assert&&assert(m>=0);for(let b=0;b<m;b++)s.insertBefore(l[b],u);for(let b=m+1;b<l.length;b++)s.appendChild(l[b])}}else for(let l=this.children.length-1;l>=0;l--){const c=this.children[l].peer;for(let u=c.topLevelElements.length-1;u>=0;u--){const m=c.topLevelElements[u];s.childNodes[n]!==m&&s.insertBefore(m,s.childNodes[n+1]),n--}}if(assert){const l=_.flatten(this.children.map(c=>c.peer.topLevelElements));assert(_.every(l,(c,u)=>s.children[u]===c))}fs===At.INDICES&&this.updateDescendantPeerIds(this.children)}updateTransformTracker(e){this.transformTracker&&this.transformTracker.dispose();let t=null;e?t=e.getUniqueTrail():t=_s.guessVisualTrail(this.trail,this.display.rootNode),this.transformTracker=new Js(t)}getPDOMInstanceUniqueId(){if(fs===At.INDICES){const e=[];let t=this;for(;t.parent;){const s=t.parent.children.indexOf(t);if(s===-1)return"STILL_BEING_CREATED"+gn.nextDouble();e.unshift(s),t=t.parent}return e.join(N.PDOM_UNIQUE_ID_SEPARATOR)}else return assert&&assert(fs===At.TRAIL_ID),this.trail.getUniqueId()}updateDescendantPeerIds(e){assert&&assert(fs===At.INDICES,"method should not be used with uniqueId comes from TRAIL_ID");const t=Array.from(e);for(;t.length>0;){const s=t.shift();s.peer.updateIndicesStringAndElementIds(),t.push(...s.children)}}static uniqueIdToTrail(e,t){return fs===At.INDICES?e.getTrailFromPDOMIndicesString(t):(assert&&assert(fs===At.TRAIL_ID),R.fromUniqueId(e.rootNode,t))}dispose(){sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.PDOMInstance(`Disposing ${this.toString()}`),sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.push(),assert&&assert(!!this.peer,"PDOMPeer required, were we already disposed?");const e=this.peer;if(!this.isRootInstance){N.removeElements(this.parent.peer.primarySibling,e.topLevelElements);for(let t=0;t<this.relativeNodes.length;t++)this.relativeNodes[t].pdomDisplaysEmitter.removeListener(this.relativeListeners[t])}for(;this.children.length;)this.children.pop().dispose();e.dispose(),this.transformTracker.dispose(),this.transformTracker=null,this.node&&this.node.removePDOMInstance(this),this.relativeNodes=null,this.display=null,this.trail=null,this.node=null,this.peer=null,this.isDisposed=!0,this.freeToPool(),sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.pop()}toString(){return`${this.id}#{${this.trail.toString()}}`}auditRoot(){if(!assert)return;const e=this.display.rootNode;assert(this.trail.length===0,"Should only call auditRoot() on the root PDOMInstance for a display");function t(s,i){assert&&assert(s.children.length===i.children.length,"Different number of children in accessible instance"),assert&&assert(s.node===i.node,"Node mismatch for PDOMInstance");for(let o=0;o<i.children.length;o++)t(s.children[o],i.children[o]);const n=i.isGloballyVisible();let a=!0;for(let o=0;o<i.trail.length;o++)if(i.trail.nodes[o].getTrailsTo(e).filter(c=>c.isPDOMVisible()).length===0){a=!1;break}assert&&assert(n===a,"Instance visibility mismatch")}t(_s.createFakePDOMTree(e),this)}static guessVisualTrail(e,t){e.reindex();const s=e.indices.lastIndexOf(-1);if(s<0)return e;const i=s+1,a=e.nodes[i].getTrailsTo(t);if(a.length===0)return e;const o=a[0];for(let h=i+1;h<e.length;h++)o.addDescendant(e.nodes[h]);return assert&&assert(o.isValid(),`trail not valid: ${e.uniqueId}`),o}static createFakePDOMTree(e){function t(s){let i=_.flatten(s.getEffectiveChildren().map(t));return s.hasPDOMContent&&(i=[{node:s,children:i}]),i}return{node:null,children:t(e)}}freeToPool(){_s.pool.freeToPool(this)}};_s.pool=new nt(_s,{initialize:_s.prototype.initializePDOMInstance});let Sr=_s;d.register("PDOMInstance",Sr);const Ft=Sr,K={addChild(r,e){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`addChild parent:n#${r._id}, child:n#${e._id}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push(),assert&&assert(r instanceof D),assert&&assert(e instanceof D),assert&&assert(!e._rendererSummary.hasNoPDOM());const t=K.beforeOp();e._pdomParent||K.addTree(r,e),K.afterOp(t),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()},removeChild(r,e){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`removeChild parent:n#${r._id}, child:n#${e._id}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push(),assert&&assert(r instanceof D),assert&&assert(e instanceof D),assert&&assert(!e._rendererSummary.hasNoPDOM());const t=K.beforeOp();e._pdomParent||K.removeTree(r,e),K.afterOp(t),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()},childrenOrderChange(r){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`childrenOrderChange node:n#${r._id}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push(),assert&&assert(r instanceof D),assert&&assert(!r._rendererSummary.hasNoPDOM());const e=K.beforeOp();K.reorder(r),K.afterOp(e),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()},pdomOrderChange(r,e,t){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`pdomOrderChange n#${r._id}: ${K.debugOrder(e)},${K.debugOrder(t)}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push(),assert&&assert(r instanceof D);const s=K.beforeOp(),i=[],n=[];qs(e||[],t||[],i,n),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`removed: ${K.debugOrder(i)}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`added: ${K.debugOrder(n)}`);let a,o;if(assert){for(a=0;a<i;a++)assert(i[a]===null||i[a]._pdomParent===r,"Node should have had a pdomOrder");for(a=0;a<n;a++)assert(n[a]===null||n[a]._pdomParent===null,"Node is already specified in a pdomOrder")}const h=K.findPDOMTrails(r);for(a=0;a<i.length;a++){const l=i[a];l&&(K.removeTree(r,l,h),l._pdomParent=null,l.pdomParentChangedEmitter.emit())}for(a=0;a<n.length;a++){const l=n[a];if(l){const c=l._parents;for(o=0;o<c.length;o++)K.removeTree(c[o],l);l._pdomParent=r,l.pdomParentChangedEmitter.emit()}}for(a=0;a<i.length;a++){const l=i[a];if(l){const c=l._parents;for(o=0;o<c.length;o++)K.addTree(c[o],l)}}for(a=0;a<n.length;a++){const l=n[a];l&&K.addTree(r,l,h)}K.reorder(r,h),K.afterOp(s),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()},pdomContentChange(r){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`pdomContentChange n#${r._id}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push(),assert&&assert(r instanceof D);const e=K.beforeOp();let t;const s=r._pdomParent?[r._pdomParent]:r._parents,i=[];for(t=0;t<s.length;t++){const n=s[t],a=K.findPDOMTrails(n);i.push(a),K.removeTree(n,r,a)}for(t=0;t<s.length;t++)K.addTree(s[t],r,i[t]);for(t=0;t<r._rootedDisplays.length;t++){const n=r._rootedDisplays[t];n._accessible&&K.rebuildInstanceTree(n._rootPDOMInstance)}K.afterOp(e),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()},rebuildInstanceTree(r){const e=r.display.rootNode;assert&&assert(e),r.removeAllChildren(),r.addConsecutiveInstances(K.createTree(new R(e),r.display,r))},addTree(r,e,t){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`addTree parent:n#${r._id}, child:n#${e._id}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push(),assert&&K.auditNodeForPDOMCycles(r),t=t||K.findPDOMTrails(r);for(let s=0;s<t.length;s++){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`trail: ${t[s].trail.toString()} full:${t[s].fullTrail.toString()} for ${t[s].pdomInstance.toString()} root:${t[s].isRoot}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push();const i=t[s],n=i.pdomInstance;i.fullTrail.addDescendant(e);const a=K.createTree(i.fullTrail,n.display,n);i.fullTrail.removeDescendant(e),n.addConsecutiveInstances(a),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()}sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()},removeTree(r,e,t){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`removeTree parent:n#${r._id}, child:n#${e._id}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push(),t=t||K.findPDOMTrails(r);for(let s=0;s<t.length;s++){const i=t[s];i.fullTrail.addDescendant(e),i.pdomInstance.removeInstancesForTrail(i.fullTrail),i.fullTrail.removeDescendant(e)}sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()},reorder(r,e){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`reorder n#${r._id}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push(),e=e||K.findPDOMTrails(r);for(let t=0;t<e.length;t++)e[t].pdomInstance.sortChildren();sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop()},createTree(r,e,t){sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`createTree ${r.toString()} parent:${t?t.toString():"null"}`),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.push();const s=r.lastNode(),i=s.getEffectiveChildren();sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.PDOMTree(`effectiveChildren: ${K.debugOrder(i)}`);let n,a=!1;s.hasPDOMContent&&(n=t.findChildWithTrail(r),n?a=!0:n=Ft.pool.create(t,e,r.copy()),t=n);const o=[];for(let h=0;h<i.length;h++)r.addDescendant(i[h],h),Array.prototype.push.apply(o,K.createTree(r,e,t)),r.removeDescendant();return n?(n.addConsecutiveInstances(o),sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop(),a?[]:[n]):(sceneryLog&&sceneryLog.PDOMTree&&sceneryLog.pop(),o)},beforeOp(){return Dr.blockFocusCallbacks=!0,oe.pdomFocusedNode},afterOp(r){r&&r.focusable&&r.focus(),Dr.blockFocusCallbacks=!1},findPDOMTrails(r){const e=[];return K.recursivePDOMTrailSearch(e,new R(r)),e},recursivePDOMTrailSearch(r,e){const t=e.rootNode();let s;if(t.hasPDOMContent){const a=t.pdomInstances;for(s=0;s<a.length;s++)r.push(new oo(a[s],e.copy(),!1));return}else{const a=t.rootedDisplays;for(s=0;s<a.length;s++){const o=a[s];o._accessible&&r.push(new oo(o._rootPDOMInstance,e.copy(),!0))}}const i=t._pdomParent?[t._pdomParent]:t._parents,n=i.length;for(s=0;s<n;s++){const a=i[s];e.addAncestor(a),K.recursivePDOMTrailSearch(r,e),e.removeAncestor()}},auditPDOMDisplays(r){if(assertSlow)if(r._pdomDisplaysInfo.canHavePDOMDisplays()){let e;const t=[];for(e=0;e<r._parents.length;e++)Array.prototype.push.apply(t,r._parents[e]._pdomDisplaysInfo.pdomDisplays);for(e=0;e<r._rootedDisplays.length;e++){const n=r._rootedDisplays[e];n._accessible&&t.push(n)}const s=r._pdomDisplaysInfo.pdomDisplays.slice(),i=t.slice();for(assertSlow(s.length===i.length),e=0;e<i.length;e++)for(let n=0;n<s.length;n++)if(i[e]===s[n]){i.splice(e,1),s.splice(n,1),e--;break}assertSlow(s.length===0&&i.length===0,"Mismatch with accessible pdom displays")}else assertSlow(r._pdomDisplaysInfo.pdomDisplays.length===0,"Invisible/nonaccessible things should have no displays")},auditNodeForPDOMCycles(r){if(assert){const e=new R(r);(function t(){const s=e.rootNode();assert(e.length<=1||s!==r,`Accessible PDOM graph cycle detected. The combined scene-graph DAG with pdomOrder defining additional parent-child relationships should still be a DAG. Cycle detected with the trail: ${e.toString()} path: ${e.toPathString()}`);const i=s._parents.length;for(let n=0;n<i;n++){const a=s._parents[n];e.addAncestor(a),t(),e.removeAncestor()}s._pdomParent&&!s._pdomParent.hasChild(s)&&(e.addAncestor(s._pdomParent),t(),e.removeAncestor())})()}},debugOrder(r){return r===null?"null":`[${r.map(e=>e===null?"null":e._id).join(",")}]`}};d.register("PDOMTree",K);const St=K;class uf{constructor(e,t,s){assert&&assert(e>=2),s=s||null,this.nodeCount=e,this.logToConsole=t,this.nodes=_.range(0,e).map(()=>new D),this.display=new Be(this.nodes[0]),this.random=new No({seed:s}),this.actionsTaken=[]}step(){const e=this.random.sample(this.enumerateActions());if(this.logToConsole&&console.log(e.text),this.actionsTaken.push(e),e.execute(),this.display._rootPDOMInstance.auditRoot(),St.auditPDOMDisplays(this.display.rootNode),this.logToConsole)for(let t=0;t<this.nodes.length;t++){const s=this.nodes[t];console.log(`${t}#${s.id} ${s.tagName} ch:${St.debugOrder(s.children)} or:${St.debugOrder(s.pdomOrder)} vis:${s.visible} avis:${s.pdomVisible}`)}}enumerateActions(){const e=[];return this.nodes.forEach(t=>{e.push({text:`#${t.id}.visible = ${!t.visible}`,execute:()=>{t.visible=!t.visible}}),e.push({text:`#${t.id}.pdomVisible = ${!t.pdomVisible}`,execute:()=>{t.pdomVisible=!t.pdomVisible}}),["span","div",null].forEach(s=>{t.tagName!==s&&e.push({text:`#${t.id}.tagName = ${s}`,execute:()=>{t.tagName=s}})}),this.powerSet(qs(this.nodes,[t]).concat([null])).forEach(s=>{mp.forEachPermutation(s,i=>{this.isPDOMOrderChangeLegal(t,i)&&e.push({text:`#${t.id}.pdomOrder = ${St.debugOrder(i)}`,execute:()=>{t.pdomOrder=i}})})}),this.nodes.forEach(s=>{this.isAddChildLegal(t,s)&&_.range(0,t.children.length+1).forEach(i=>{e.push({text:`#${t.id}.insertChild(${i},#${s.id})`,execute:()=>{t.insertChild(i,s)}})}),t.hasChild(s)&&e.push({text:`#${t.id}.removeChild(#${s.id})`,execute:()=>{t.removeChild(s)}})})}),e}isAddChildLegal(e,t){return!e.hasChild(t)&&this.isAcyclic(e,t)}powerSet(e){if(e.length===0)return[[]];{const t=this.powerSet(e.slice(1));return t.concat(t.map(s=>[e[0]].concat(s)))}}isPDOMOrderChangeLegal(e,t){if(t===null&&(t=[]),t=t.filter(n=>n!==null),_.includes(t,e)||_.uniq(t).length<t.length)return!1;for(let n=0;n<t.length;n++)if(t[n]._pdomParent&&t[n]._pdomParent!==e)return!1;const s=(n,a)=>n===e?n.hasChild(a)||_.includes(t,a):n.hasChild(a)||!!n.pdomOrder&&_.includes(n.pdomOrder,a),i=e.children.concat(t);return _.every(i,n=>this.isAcyclic(e,n,s))}isAcyclic(e,t,s){if(e===t)return!1;const i=t.children.concat(t.pdomOrder).filter(n=>n!==null);for(;i.length;){const n=i.pop();if(n===e)return!1;s?this.nodes.forEach(a=>{s(n,a)&&i.push(a)}):(Array.prototype.push.apply(i,n.children),n.pdomOrder&&Array.prototype.push.apply(i,n.pdomOrder.filter(a=>a!==null)))}return!0}dispose(){this.display.dispose()}}d.register("PDOMFuzzer",uf);const Ss=class Ss extends si{};Ss.DRAG=new Ss,Ss.KEYBOARD_DRAG=new Ss,Ss.enumeration=new ii(Ss,{phetioDocumentation:"entries when signifying Intent of the pointer"});let Ne=Ss;const Dn=class Dn{constructor(e,t){assert&&assert(e===null||e instanceof T),assert&&assert(Object.getPrototypeOf(this)!==Dn.prototype,"Pointer is an abstract class"),this.point=e,this.type=t,this.trail=null,this.inputEnabledTrail=null,this.isDownProperty=new ie(!1),this.attachedProperty=new ie(!1),this._listeners=[],this._attachedListener=null,this._cursor=null,this.lastEventContext=null,this._intents=[],this._pointerCaptured=!1,this._listenerForDragReserve=null,this._listenerForKeyboardDragReserve=null}setCursor(e){return this._cursor=e,this}set cursor(e){this.setCursor(e)}get cursor(){return this.getCursor()}getCursor(){return this._cursor}getListeners(){return this._listeners.slice()}get listeners(){return this.getListeners()}addInputListener(e,t){sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`addInputListener to ${this.toString()} attach:${t}`),sceneryLog&&sceneryLog.Pointer&&sceneryLog.push(),assert&&assert(e,"A listener must be provided"),assert&&assert(t===void 0||typeof t=="boolean","If provided, the attach parameter should be a boolean value"),assert&&assert(!_.includes(this._listeners,e),"Attempted to add an input listener that was already added"),this._listeners.push(e),t&&(assert&&assert(e.interrupt,"Interrupt should exist on attached listeners"),this.attach(e)),sceneryLog&&sceneryLog.Pointer&&sceneryLog.pop()}removeInputListener(e){sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`removeInputListener to ${this.toString()}`),sceneryLog&&sceneryLog.Pointer&&sceneryLog.push(),assert&&assert(e,"A listener must be provided");const t=_.indexOf(this._listeners,e);assert&&assert(t!==-1,"Could not find the input listener to remove"),this.isAttached()&&e===this._attachedListener&&this.detach(e),this._listeners.splice(t,1),sceneryLog&&sceneryLog.Pointer&&sceneryLog.pop()}getAttachedListener(){return this._attachedListener}get attachedListener(){return this.getAttachedListener()}isAttached(){return this.attachedProperty.value}isTouchLike(){return!1}set isDown(e){this.isDownProperty.value=e}get isDown(){return this.isDownProperty.value}interruptAttached(){this.isAttached()&&this._attachedListener.interrupt()}interruptAll(){const e=this._listeners.slice();for(let t=0;t<e.length;t++){const s=e[t];s.interrupt&&s.interrupt()}}attach(e){sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`Attaching to ${this.toString()}`),assert&&assert(!this.isAttached(),"Attempted to attach to an already attached pointer"),this.attachedProperty.value=!0,this._attachedListener=e}updatePoint(e,t="event"){const s=this.hasPointChanged(e);return e&&sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`pointer ${t} at ${e.toString()}`),this.point=e,s}down(e){this.isDown=!0}up(e,t){return this.isDown=!1,this.updatePoint(e,"up")}cancel(e){return this.isDown=!1,this.updatePoint(e,"cancel")}detach(e){sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`Detaching from ${this.toString()}`),assert&&assert(this.isAttached(),"Cannot detach a listener if one is not attached"),assert&&assert(this._attachedListener===e,"Cannot detach a different listener"),this.attachedProperty.value=!1,this._attachedListener=null}hasPointChanged(e){return this.point!==e&&(!e||!this.point||!this.point.equals(e))}addIntent(e){assert&&assert(Ne.enumeration.includes(e),"trying to set unsupported intent for Pointer"),this._intents.includes(e)||this._intents.push(e),assert&&assert(this._intents.length<=Ne.enumeration.values.length,"to many Intents saved, memory leak likely")}removeIntent(e){if(assert&&assert(Ne.enumeration.includes(e),"trying to set unsupported intent for Pointer"),this._intents.includes(e)){const t=this._intents.indexOf(e);this._intents.splice(t,1)}}hasIntent(e){return this._intents.includes(e)}reserveForDrag(){if(!this._intents.includes(Ne.DRAG)){this.addIntent(Ne.DRAG);const e={up:t=>{this.removeIntent(Ne.DRAG),this.removeInputListener(this._listenerForDragReserve),this._listenerForDragReserve=null}};assert&&assert(this._listenerForDragReserve===null,"still a listener to reserve pointer, memory leak likely"),this._listenerForDragReserve=e,this.addInputListener(this._listenerForDragReserve)}}reserveForKeyboardDrag(){if(!this._intents.includes(Ne.KEYBOARD_DRAG)){this.addIntent(Ne.KEYBOARD_DRAG);const e={keyup:s=>t(),blur:s=>t()},t=()=>{this.removeIntent(Ne.KEYBOARD_DRAG),this.removeInputListener(this._listenerForKeyboardDragReserve),this._listenerForKeyboardDragReserve=null};assert&&assert(this._listenerForDragReserve===null,"still a listener on Pointer for reserve, memory leak likely"),this._listenerForKeyboardDragReserve=e,this.addInputListener(this._listenerForKeyboardDragReserve)}}onGotPointerCapture(){this._pointerCaptured=!0}onLostPointerCapture(){this._pointerCaptured&&this.interruptAll(),this._pointerCaptured=!1}dispose(){sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`Disposing ${this.toString()}`),this._listenerForDragReserve&&this._listeners.includes(this._listenerForDragReserve)&&this.removeInputListener(this._listenerForDragReserve),this._listenerForKeyboardDragReserve&&this._listeners.includes(this._listenerForKeyboardDragReserve)&&this.removeInputListener(this._listenerForKeyboardDragReserve),assert&&assert(this._attachedListener===null,"Attached listeners should be cleared before pointer disposal"),assert&&assert(this._listeners.length===0,"Should not have listeners when a pointer is disposed")}toString(){return`Pointer#${this.type}_at_${this.point}`}};Dn.PointerIO=new Le("PointerIO",{valueType:Dn,toStateObject:e=>({point:e.point.toStateObject(),type:e.type}),stateSchema:{point:T.Vector2IO,type:ge}});let Bs=Dn;d.register("Pointer",Bs);class lt extends Bs{constructor(e){super(e,"mouse"),this.id=null,this.leftDown=!1,this.middleDown=!1,this.rightDown=!1,this.wheelDelta=new fp(0,0,0),this.wheelDeltaMode=0,sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`Created ${this.toString()}`)}down(e){switch(assert&&assert(e instanceof MouseEvent),e.button){case 0:this.leftDown=!0;break;case 1:this.middleDown=!0;break;case 2:this.rightDown=!0;break}return super.down(e)}up(e,t){switch(assert&&assert(t instanceof MouseEvent),t.button){case 0:this.leftDown=!1;break;case 1:this.middleDown=!1;break;case 2:this.rightDown=!1;break}return super.up(e,t)}move(e){const t=this.hasPointChanged(e);return e&&sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`mouse move at ${e.toString()}`),this.point=e,t}over(e){const t=this.hasPointChanged(e);return e&&sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`mouse over at ${e.toString()}`),this.point=e,t}out(e){const t=this.hasPointChanged(e);return e&&sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`mouse out at ${e.toString()}`),t}wheel(e){assert&&assert(e instanceof WheelEvent);const t=e;this.wheelDelta.setXYZ(t.deltaX,t.deltaY,t.deltaZ),this.wheelDeltaMode=t.deltaMode}toString(){return"Mouse"}}d.register("Mouse",lt);class un extends Bs{constructor(e,t,s){super(t,"touch"),this.id=e,sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`Created ${this.toString()}`)}move(e){const t=this.hasPointChanged(e);return this.point=e,t}toString(){return`Touch#${this.id}`}isTouchLike(){return!0}}d.register("Touch",un);class bu extends Bs{constructor(e,t,s){super(t,"pen"),this.id=e,sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`Created ${this.toString()}`)}move(e){const t=this.hasPointChanged(e);return this.point=e,t}toString(){return`Pen#${this.id}`}isTouchLike(){return!0}}d.register("Pen",bu);class Mi extends Bs{constructor(e){super(T.ZERO,"pdom"),this.display=e,this.initializeListeners(),this.blockTrustedEvents=!1,this.keydownTargetNode=null,sceneryLog&&sceneryLog.Pointer&&sceneryLog.Pointer(`Created ${this.toString()}`)}initializeListeners(){this.addInputListener({focus:e=>{assert&&assert(this.trail,"trail should have been calculated for the focused node");const t=this.trail.lastNode();if(t.focusable){const s=Ft.guessVisualTrail(this.trail,this.display.rootNode);this.point=s.parentToGlobalPoint(t.center),isNaN(this.point.x)&&this.point.setXY(0,0)}},blur:e=>{this.trail=null,this.keydownTargetNode=null},keydown:e=>{this.blockTrustedEvents&&e.domEvent.isTrusted||(this.keydownTargetNode=e.target)},keyup:e=>{this.blockTrustedEvents&&e.domEvent.isTrusted||this.keydownTargetNode!==e.target&&e.abort()}})}updateTrail(e){return this.trail&&this.trail.equals(e)||(this.trail=e),this.trail}}d.register("PDOMPointer",Mi);class F{constructor(e){this.domEvent=e,this.activeElement=document.activeElement}static createSynthetic(){return new F(new window.Event("synthetic"))}allowsDOMInput(){var t,s;const e=(t=this.domEvent)==null?void 0:t.target;if(e instanceof Element){let i=e;for(;i;){if(i instanceof HTMLElement&&((s=i.dataset)==null?void 0:s.sceneryAllowInput)==="true")return!0;i=i.parentNode}}return!1}}const Ce=new Le("EventContextIO",{valueType:F,documentation:"A DOM event and its context",toStateObject:r=>({domEvent:us.serializeDomEvent(r.domEvent)}),fromStateObject:r=>new F(us.deserializeDomEvent(r.domEvent)),stateSchema:()=>({domEvent:xs})});d.register("EventContext",F);const Hr=class Hr{constructor(e,t,s,i){this.handled=!1,this.aborted=!1,this.trail=e,this.type=t,this.pointer=s,this.context=i,this.domEvent=i.domEvent,this.activeElement=i.activeElement,this.currentTarget=null,this.target=e.lastNode(),this.isPrimary=!(s instanceof lt)||!this.domEvent||this.domEvent.button===0,s.lastEventContext=i}handle(){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent("handled event"),this.handled=!0}abort(){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent("aborted event"),this.aborted=!0}isFromPDOM(){return this.pointer instanceof Mi}canStartPress(){return!this.pointer.isAttached()&&(!(this.pointer instanceof lt)||this.domEvent.button===0)}};Hr.SceneryEventIO=new Le("SceneryEventIO",{valueType:Hr,documentation:'An event, with a "point" field',toStateObject:e=>({type:e.type,domEventType:V(xs).toStateObject(e.domEvent),point:e.pointer&&e.pointer.point?T.Vector2IO.toStateObject(e.pointer.point):null}),stateSchema:{type:ge,domEventType:V(xs),point:V(T.Vector2IO)}});let Ue=Hr;d.register("SceneryEvent",Ue);const rc=Un(Bs.PointerIO),pf=["altKey","button","charCode","clientX","clientY","code","ctrlKey","deltaMode","deltaX","deltaY","deltaZ","key","keyCode","metaKey","pageX","pageY","pointerId","pointerType","scale","shiftKey","target","type","relatedTarget","which"],ac=["deltaMode","deltaX","deltaY","deltaZ","altKey","button","charCode","clientX","clientY","code","ctrlKey","key","keyCode","metaKey","pageX","pageY","pointerId","pointerType","shiftKey","type","relatedTarget","which"],gf=["target","relatedTarget"],mf=["focus","blur","focusin","focusout"],Zi="targetSubstitute",ff=80,te=class te extends _e{constructor(e,t,s,i,n,a){var h,l,c,u,m,b,y,f,L,v,S,B,ce,fe,k,Se,Ye,et,rt,oi,Zt,we,Jt,It;const o=E()({phetioType:te.InputIO,phetioDocumentation:"Central point for user input events, such as mouse, touch"},a);super(o),this.currentSceneryEvent=null,this.display=e,this.rootNode=e.rootNode,this.attachToWindow=t,this.batchDOMEvents=s,this.assumeFullWindow=i,this.passiveEvents=n,this.batchedEvents=[],this.pdomPointer=null,this.mouse=null,this.pointers=[],this.pointerAddedEmitter=new re,this.currentlyFiringEvents=!1,this.upTimeStamp=0,this.validatePointersAction=new q(()=>{let I=this.pointers.length;for(;I--;){const x=this.pointers[I];x.point&&x!==this.pdomPointer&&this.branchChangeEvents(x,x.lastEventContext||F.createSynthetic(),!1)}},{phetioPlayback:!0,tandem:(h=o.tandem)==null?void 0:h.createTandem("validatePointersAction"),phetioHighFrequency:!0}),this.mouseUpAction=new q((I,x)=>{const j=this.ensureMouse(I);j.id=null,this.upEvent(j,x,I)},{phetioPlayback:!0,tandem:(l=o.tandem)==null?void 0:l.createTandem("mouseUpAction"),parameters:[{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a mouse button is released."}),this.mouseDownAction=new q((I,x,j)=>{const Q=this.ensureMouse(x);Q.id=I,this.downEvent(Q,j,x)},{phetioPlayback:!0,tandem:(c=o.tandem)==null?void 0:c.createTandem("mouseDownAction"),parameters:[{name:"id",phetioType:V(U)},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a mouse button is pressed."}),this.mouseMoveAction=new q((I,x)=>{const j=this.ensureMouse(I);j.move(I),this.moveEvent(j,x)},{phetioPlayback:!0,tandem:(u=o.tandem)==null?void 0:u.createTandem("mouseMoveAction"),parameters:[{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the mouse is moved.",phetioHighFrequency:!0}),this.mouseOverAction=new q((I,x)=>{this.ensureMouse(I).over(I)},{phetioPlayback:!0,tandem:(m=o.tandem)==null?void 0:m.createTandem("mouseOverAction"),parameters:[{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the mouse is moved while on the sim."}),this.mouseOutAction=new q((I,x)=>{this.ensureMouse(I).out(I)},{phetioPlayback:!0,tandem:(b=o.tandem)==null?void 0:b.createTandem("mouseOutAction"),parameters:[{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the mouse moves out of the display."}),this.wheelScrollAction=new q(I=>{const x=I.domEvent,j=this.ensureMouse(this.pointFromEvent(x));if(j.wheel(x),j.point){const Q=this.rootNode.trailUnderPointer(j)||new R(this.rootNode);this.dispatchEvent(Q,"wheel",j,I,!0)}},{phetioPlayback:!0,tandem:(y=o.tandem)==null?void 0:y.createTandem("wheelScrollAction"),parameters:[{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the mouse wheel scrolls.",phetioHighFrequency:!0}),this.touchStartAction=new q((I,x,j)=>{const Q=new un(I,x,j.domEvent);this.addPointer(Q),this.downEvent(Q,j,x)},{phetioPlayback:!0,tandem:(f=o.tandem)==null?void 0:f.createTandem("touchStartAction"),parameters:[{name:"id",phetioType:U},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a touch begins."}),this.touchEndAction=new q((I,x,j)=>{const Q=this.findPointerById(I);Q&&(assert&&assert(Q instanceof un),this.upEvent(Q,j,x),this.removePointer(Q))},{phetioPlayback:!0,tandem:(L=o.tandem)==null?void 0:L.createTandem("touchEndAction"),parameters:[{name:"id",phetioType:U},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a touch ends."}),this.touchMoveAction=new q((I,x,j)=>{const Q=this.findPointerById(I);Q&&(assert&&assert(Q instanceof un),Q.move(x),this.moveEvent(Q,j))},{phetioPlayback:!0,tandem:(v=o.tandem)==null?void 0:v.createTandem("touchMoveAction"),parameters:[{name:"id",phetioType:U},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a touch moves.",phetioHighFrequency:!0}),this.touchCancelAction=new q((I,x,j)=>{const Q=this.findPointerById(I);Q&&(assert&&assert(Q instanceof un),this.cancelEvent(Q,j,x),this.removePointer(Q))},{phetioPlayback:!0,tandem:(S=o.tandem)==null?void 0:S.createTandem("touchCancelAction"),parameters:[{name:"id",phetioType:U},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a touch is canceled."}),this.penStartAction=new q((I,x,j)=>{const Q=new bu(I,x,j.domEvent);this.addPointer(Q),this.downEvent(Q,j,x)},{phetioPlayback:!0,tandem:(B=o.tandem)==null?void 0:B.createTandem("penStartAction"),parameters:[{name:"id",phetioType:U},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a pen touches the screen."}),this.penEndAction=new q((I,x,j)=>{const Q=this.findPointerById(I);Q&&(this.upEvent(Q,j,x),this.removePointer(Q))},{phetioPlayback:!0,tandem:(ce=o.tandem)==null?void 0:ce.createTandem("penEndAction"),parameters:[{name:"id",phetioType:U},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a pen is lifted."}),this.penMoveAction=new q((I,x,j)=>{const Q=this.findPointerById(I);Q&&(Q.move(x),this.moveEvent(Q,j))},{phetioPlayback:!0,tandem:(fe=o.tandem)==null?void 0:fe.createTandem("penMoveAction"),parameters:[{name:"id",phetioType:U},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a pen is moved.",phetioHighFrequency:!0}),this.penCancelAction=new q((I,x,j)=>{const Q=this.findPointerById(I);Q&&(this.cancelEvent(Q,j,x),this.removePointer(Q))},{phetioPlayback:!0,tandem:(k=o.tandem)==null?void 0:k.createTandem("penCancelAction"),parameters:[{name:"id",phetioType:U},{name:"point",phetioType:T.Vector2IO},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a pen is canceled."}),this.gotPointerCaptureAction=new q((I,x)=>{const j=this.findPointerById(I);j&&j.onGotPointerCapture()},{phetioPlayback:!0,tandem:(Se=o.tandem)==null?void 0:Se.createTandem("gotPointerCaptureAction"),parameters:[{name:"id",phetioType:U},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a pointer is captured (normally at the start of an interaction)",phetioHighFrequency:!0}),this.lostPointerCaptureAction=new q((I,x)=>{const j=this.findPointerById(I);j&&j.onLostPointerCapture()},{phetioPlayback:!0,tandem:(Ye=o.tandem)==null?void 0:Ye.createTandem("lostPointerCaptureAction"),parameters:[{name:"id",phetioType:U},{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when a pointer loses its capture (normally at the end of an interaction)",phetioHighFrequency:!0}),this.focusinAction=new q(I=>{const x=this.getPDOMEventTrail(I.domEvent,"focusin");x&&(sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`focusin(${te.debugText(null,I.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.dispatchPDOMEvent(x,"focus",I,!1),this.dispatchPDOMEvent(x,"focusin",I,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop())},{phetioPlayback:!0,tandem:(et=o.tandem)==null?void 0:et.createTandem("focusinAction"),parameters:[{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the PDOM root gets the focusin DOM event."}),this.focusoutAction=new q(I=>{const x=this.getPDOMEventTrail(I.domEvent,"focusout");x&&(sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`focusOut(${te.debugText(null,I.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.dispatchPDOMEvent(x,"blur",I,!1),this.dispatchPDOMEvent(x,"focusout",I,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop())},{phetioPlayback:!0,tandem:(rt=o.tandem)==null?void 0:rt.createTandem("focusoutAction"),parameters:[{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the PDOM root gets the focusout DOM event."}),this.clickAction=new q(I=>{const x=this.getPDOMEventTrail(I.domEvent,"click");x&&(sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`click(${te.debugText(null,I.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.dispatchPDOMEvent(x,"click",I,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop())},{phetioPlayback:!0,tandem:(oi=o.tandem)==null?void 0:oi.createTandem("clickAction"),parameters:[{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the PDOM root gets the click DOM event."}),this.inputAction=new q(I=>{const x=this.getPDOMEventTrail(I.domEvent,"input");x&&(sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`input(${te.debugText(null,I.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.dispatchPDOMEvent(x,"input",I,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop())},{phetioPlayback:!0,tandem:(Zt=o.tandem)==null?void 0:Zt.createTandem("inputAction"),parameters:[{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the PDOM root gets the input DOM event."}),this.changeAction=new q(I=>{const x=this.getPDOMEventTrail(I.domEvent,"change");x&&(sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`change(${te.debugText(null,I.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.dispatchPDOMEvent(x,"change",I,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop())},{phetioPlayback:!0,tandem:(we=o.tandem)==null?void 0:we.createTandem("changeAction"),parameters:[{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the PDOM root gets the change DOM event."}),this.keydownAction=new q(I=>{sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`keydown(${te.debugText(null,I.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.dispatchGlobalEvent("globalkeydown",I,!0);const x=this.getPDOMEventTrail(I.domEvent,"keydown");x&&this.dispatchPDOMEvent(x,"keydown",I,!0),this.dispatchGlobalEvent("globalkeydown",I,!1),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()},{phetioPlayback:!0,tandem:(Jt=o.tandem)==null?void 0:Jt.createTandem("keydownAction"),parameters:[{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the PDOM root gets the keydown DOM event."}),this.keyupAction=new q(I=>{sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`keyup(${te.debugText(null,I.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.dispatchGlobalEvent("globalkeyup",I,!0);const x=this.getPDOMEventTrail(I.domEvent,"keydown");x&&this.dispatchPDOMEvent(x,"keyup",I,!0),this.dispatchGlobalEvent("globalkeyup",I,!1),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()},{phetioPlayback:!0,tandem:(It=o.tandem)==null?void 0:It.createTandem("keyupAction"),parameters:[{name:"context",phetioType:Ce}],phetioEventType:Z.USER,phetioDocumentation:"Emits when the PDOM root gets the keyup DOM event."})}interruptPointers(e=null){_.each(this.pointers,t=>{t!==e&&t.interruptAll()})}batchEvent(e,t,s,i){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent("Input.batchEvent"),sceneryLog&&sceneryLog.InputEvent&&sceneryLog.push(),this.display.interactive&&(this.batchedEvents.push(wr.pool.create(e,t,s)),(i||!this.batchDOMEvents)&&this.fireBatchedEvents()),this.passiveEvents!==!0&&(s!==this.mouseDown||Te.edge)&&t!==W.ALT_TYPE&&!e.allowsDOMInput()&&e.domEvent.preventDefault(),sceneryLog&&sceneryLog.InputEvent&&sceneryLog.pop()}fireBatchedEvents(){if(sceneryLog&&sceneryLog.InputEvent&&this.currentlyFiringEvents&&sceneryLog.InputEvent("REENTRANCE DETECTED"),!this.currentlyFiringEvents&&this.batchedEvents.length){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`Input.fireBatchedEvents length:${this.batchedEvents.length}`),sceneryLog&&sceneryLog.InputEvent&&sceneryLog.push(),this.currentlyFiringEvents=!0;const e=this.batchedEvents;for(let t=0;t<e.length;t++){const s=e[t];s.run(this),s.dispose()}ee(e),this.currentlyFiringEvents=!1,sceneryLog&&sceneryLog.InputEvent&&sceneryLog.pop()}}clearBatchedEvents(){this.batchedEvents.length=0}validatePointers(){this.validatePointersAction.execute()}removeTemporaryPointers(){for(let e=this.pointers.length-1;e>=0;e--){const t=this.pointers[e];if(!(t instanceof lt)){this.pointers.splice(e,1);const s=t.trail||new R(this.rootNode);this.exitEvents(t,F.createSynthetic(),s,0,!0)}}}connectListeners(){Dr.addDisplay(this.display,this.attachToWindow,this.passiveEvents)}disconnectListeners(){Dr.removeDisplay(this.display,this.attachToWindow,this.passiveEvents)}pointFromEvent(e){const t=T.pool.create(e.clientX,e.clientY);if(!this.assumeFullWindow){const s=this.display.domElement.getBoundingClientRect();s.width>0&&s.height>0&&(t.subtractXY(s.left,s.top),(s.width!==this.display.width||s.height!==this.display.height)&&(t.x*=this.display.width/s.width,t.y*=this.display.height/s.height))}return t}addPointer(e){this.pointers.push(e),this.pointerAddedEmitter.emit(e)}removePointer(e){for(let t=this.pointers.length-1;t>=0;t--)this.pointers[t]===e&&this.pointers.splice(t,1);e.dispose()}findPointerById(e){let t=this.pointers.length;for(;t--;){const s=this.pointers[t];if(s.id===e)return s}return null}getPDOMEventTrail(e,t){if(!this.display.interactive)return null;const s=this.getTrailFromPDOMEvent(e);return s&&!(t==="click"&&_.some(s.nodes,n=>n.positionInPDOM)&&e.timeStamp-this.upTimeStamp<=ff)?s:null}initMouse(e){const t=new lt(e);return this.mouse=t,this.addPointer(t),t}ensureMouse(e){const t=this.mouse;return t||this.initMouse(e)}initPDOMPointer(){const e=new Mi(this.display);return this.pdomPointer=e,this.addPointer(e),e}ensurePDOMPointer(){const e=this.pdomPointer;return e||this.initPDOMPointer()}dispatchPDOMEvent(e,t,s,i){this.ensurePDOMPointer().updateTrail(e),N.USER_GESTURE_EVENTS.includes(t)&&Be.userGestureEmitter.emit();const n=s.domEvent;n.target&&n.target.hasAttribute(N.DATA_EXCLUDE_FROM_INPUT)||(e.isPickable()||mf.includes(t)||(e=new R([])),assert&&assert(this.pdomPointer),this.dispatchEvent(e,t,this.pdomPointer,s,i))}dispatchGlobalEvent(e,t,s){this.ensurePDOMPointer(),assert&&assert(this.pdomPointer);const i=this.pdomPointer,n=new Ue(new R,e,i,t),a=o=>{if(!o.isDisposed&&o.isVisible()&&o.isInputEnabled()&&o.isPDOMVisible()){for(let h=o._children.length-1;h>=0;h--)a(o._children[h]);!n.aborted&&!n.handled&&(n.currentTarget=o,this.dispatchToListeners(i,o._inputListeners,e,n,s))}};a(this.rootNode)}getRelatedTargetTrail(e){const t=e.relatedTarget;if(t&&this.display.isElementUnderPDOM(t)){const s=e.relatedTarget;assert&&assert(s instanceof window.Element);const i=s.getAttribute(N.DATA_PDOM_UNIQUE_ID);return assert&&assert(i,"should not be null"),Ft.uniqueIdToTrail(this.display,i)}return null}getTrailFromPDOMEvent(e){if(assert&&assert(e.target||e[Zi],"need a way to get the target"),!this.display._accessible)return null;if(e[Zi]){const t=e[Zi].getAttribute(N.DATA_PDOM_UNIQUE_ID);return Ft.uniqueIdToTrail(this.display,t)}else{const t=e.target;if(assert&&assert(t instanceof window.Element,"target is not an Element",t),t&&this.display.isElementUnderPDOM(t)){const s=t.getAttribute(N.DATA_PDOM_UNIQUE_ID);return assert&&assert(s,"should not be null"),Ft.uniqueIdToTrail(this.display,s)}}return null}mouseDown(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`mouseDown('${e}', ${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.mouseDownAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}mouseUp(e,t){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`mouseUp(${te.debugText(e,t.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.mouseUpAction.execute(e,t),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}mouseMove(e,t){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`mouseMove(${te.debugText(e,t.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.mouseMoveAction.execute(e,t),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}mouseOver(e,t){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`mouseOver(${te.debugText(e,t.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.mouseOverAction.execute(e,t),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}mouseOut(e,t){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`mouseOut(${te.debugText(e,t.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.mouseOutAction.execute(e,t),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}wheel(e){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`wheel(${te.debugText(null,e.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.wheelScrollAction.execute(e),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}touchStart(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`touchStart('${e}',${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.touchStartAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}touchEnd(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`touchEnd('${e}',${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.touchEndAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}touchMove(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`touchMove('${e}',${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.touchMoveAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}touchCancel(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`touchCancel('${e}',${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.touchCancelAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}penStart(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`penStart('${e}',${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.penStartAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}penEnd(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`penEnd('${e}',${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.penEndAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}penMove(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`penMove('${e}',${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.penMoveAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}penCancel(e,t,s){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`penCancel('${e}',${te.debugText(t,s.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.penCancelAction.execute(e,t,s),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}pointerDown(e,t,s,i){const n=this.attachToWindow?document.body:this.display.domElement;switch(n.setPointerCapture&&i.domEvent.pointerId&&!i.allowsDOMInput()&&n.setPointerCapture(i.domEvent.pointerId),t=this.handleUnknownPointerType(t,e),t){case"mouse":this.mouseDown(e,s,i);break;case"touch":this.touchStart(e,s,i);break;case"pen":this.penStart(e,s,i);break;default:if(assert)throw new Error(`Unknown pointer type: ${t}`)}}pointerUp(e,t,s,i){switch(this.upTimeStamp=i.domEvent.timeStamp,t=this.handleUnknownPointerType(t,e),t){case"mouse":this.mouseUp(s,i);break;case"touch":this.touchEnd(e,s,i);break;case"pen":this.penEnd(e,s,i);break;default:if(assert)throw new Error(`Unknown pointer type: ${t}`)}}pointerCancel(e,t,s,i){switch(t=this.handleUnknownPointerType(t,e),t){case"mouse":console&&console.log&&console.log("WARNING: Pointer mouse cancel was received");break;case"touch":this.touchCancel(e,s,i);break;case"pen":this.penCancel(e,s,i);break;default:console.log&&console.log(`Unknown pointer type: ${t}`)}}gotPointerCapture(e,t,s,i){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`gotPointerCapture('${e}',${te.debugText(null,i.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.gotPointerCaptureAction.execute(e,i),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}lostPointerCapture(e,t,s,i){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`lostPointerCapture('${e}',${te.debugText(null,i.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.lostPointerCaptureAction.execute(e,i),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}pointerMove(e,t,s,i){switch(t=this.handleUnknownPointerType(t,e),t){case"mouse":this.mouseMove(s,i);break;case"touch":this.touchMove(e,s,i);break;case"pen":this.penMove(e,s,i);break;default:console.log&&console.log(`Unknown pointer type: ${t}`)}}pointerOver(e,t,s,i){}pointerOut(e,t,s,i){}pointerEnter(e,t,s,i){}pointerLeave(e,t,s,i){}focusIn(e){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`focusIn('${te.debugText(null,e.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.focusinAction.execute(e),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}focusOut(e){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`focusOut('${te.debugText(null,e.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.focusoutAction.execute(e),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}input(e){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`input('${te.debugText(null,e.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.inputAction.execute(e),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}change(e){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`change('${te.debugText(null,e.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.changeAction.execute(e),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}click(e){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`click('${te.debugText(null,e.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.clickAction.execute(e),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}keyDown(e){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`keyDown('${te.debugText(null,e.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.keydownAction.execute(e),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}keyUp(e){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`keyUp('${te.debugText(null,e.domEvent)});`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.keyupAction.execute(e),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}handleUnknownPointerType(e,t){return e!==""?e:this.mouse&&this.mouse.id===t?"mouse":"touch"}getPointerTrail(e){return this.rootNode.trailUnderPointer(e)||new R(this.rootNode)}upEvent(e,t,s){if(this.display.isElementUnderPDOM(t.domEvent.target))return;const i=e.up(s,t.domEvent);sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`upEvent ${e.toString()} changed:${i}`),sceneryLog&&sceneryLog.Input&&sceneryLog.push();const n=this.branchChangeEvents(e,t,i);this.dispatchEvent(n,"up",e,t,!0),e.isTouchLike()&&this.exitEvents(e,t,n,0,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}downEvent(e,t,s){if(this.display.isElementUnderPDOM(t.domEvent.target))return;const i=e.updatePoint(s);sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`downEvent ${e.toString()} changed:${i}`),sceneryLog&&sceneryLog.Input&&sceneryLog.push();const n=this.branchChangeEvents(e,t,i);e.down(t.domEvent),this.dispatchEvent(n,"down",e,t,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}moveEvent(e,t){sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`moveEvent ${e.toString()}`),sceneryLog&&sceneryLog.Input&&sceneryLog.push(),this.branchChangeEvents(e,t,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}cancelEvent(e,t,s){const i=e.cancel(s);sceneryLog&&sceneryLog.Input&&sceneryLog.Input(`cancelEvent ${e.toString()} changed:${i}`),sceneryLog&&sceneryLog.Input&&sceneryLog.push();const n=this.branchChangeEvents(e,t,i);this.dispatchEvent(n,"cancel",e,t,!0),e.isTouchLike()&&this.exitEvents(e,t,n,0,!0),sceneryLog&&sceneryLog.Input&&sceneryLog.pop()}branchChangeEvents(e,t,s){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`branchChangeEvents: ${e.toString()} sendMove:${s}`),sceneryLog&&sceneryLog.InputEvent&&sceneryLog.push();const i=this.getPointerTrail(e),n=i.slice(0,Math.min(i.nodes.length,i.getLastInputEnabledIndex()+1)),a=e.inputEnabledTrail||new R(this.rootNode),o=R.branchIndex(n,a),h=a.lastNode()!==n.lastNode();if(sceneryLog&&sceneryLog.InputEvent){const l=e.trail||new R(this.rootNode),c=R.branchIndex(i,l);(c!==i.length||c!==l.length)&&sceneryLog.InputEvent(`changed from ${l.toString()} to ${i.toString()}`)}return s&&this.dispatchEvent(i,"move",e,t,!0),this.exitEvents(e,t,a,o,h),this.enterEvents(e,t,n,o,h),e.trail=i,e.inputEnabledTrail=n,sceneryLog&&sceneryLog.InputEvent&&sceneryLog.pop(),i}enterEvents(e,t,s,i,n){n&&this.dispatchEvent(s,"over",e,t,!0,!0);for(let a=i;a<s.length;a++)this.dispatchEvent(s.slice(0,a+1),"enter",e,t,!1)}exitEvents(e,t,s,i,n){for(let a=s.length-1;a>=i;a--)this.dispatchEvent(s.slice(0,a+1),"exit",e,t,!1,!0);n&&this.dispatchEvent(s,"out",e,t,!0)}dispatchEvent(e,t,s,i,n,a=!1){sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.EventDispatch(`${t} trail:${e.toString()} pointer:${s.toString()} at ${s.point?s.point.toString():"null"}`),sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.push(),assert&&assert(e,"Falsy trail for dispatchEvent"),sceneryLog&&sceneryLog.EventPath&&sceneryLog.EventPath(`${t} ${e.toPathString()}`);const o=new Ue(e,t,s,i);this.currentSceneryEvent=o,this.dispatchToListeners(s,s.getListeners(),t,o),this.dispatchToTargets(e,t,s,o,n,a),this.dispatchToListeners(s,this.display.getInputListeners(),t,o),Be.inputListeners.length&&this.dispatchToListeners(s,Be.inputListeners.slice(),t,o),this.currentSceneryEvent=null,sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.pop()}dispatchToListeners(e,t,s,i,n=null){if(i.handled)return;const a=e.type+s;for(let o=0;o<t.length;o++){const h=t[o];(n===null||n===!!h.capture)&&(!i.aborted&&h[a]&&(sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.EventDispatch(a),sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.push(),h[a](i),sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.pop()),!i.aborted&&h[s]&&(sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.EventDispatch(s),sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.push(),h[s](i),sceneryLog&&sceneryLog.EventDispatch&&sceneryLog.pop()))}}dispatchToTargets(e,t,s,i,n,a=!1){if(i.aborted||i.handled)return;const o=e.getLastInputEnabledIndex();for(let h=e.nodes.length-1;h>=0;n?h--:h=-1){const l=e.nodes[h],c=o<h;if(!(l.isDisposed||!a&&c)&&(i.currentTarget=l,this.dispatchToListeners(s,l.getInputListeners(),t,i),i.aborted||i.handled))return}}static serializeDomEvent(e){const t={constructorName:e.constructor.name};return pf.forEach(s=>{const i=e[s];i==null?t[s]=null:i instanceof Element&&gf.includes(s)&&typeof i.getAttribute=="function"&&i.hasAttribute(N.DATA_PDOM_UNIQUE_ID)?t[s]={[N.DATA_PDOM_UNIQUE_ID]:i.getAttribute(N.DATA_PDOM_UNIQUE_ID),id:i.getAttribute("id")}:t[s]=typeof i=="object"?{}:JSON.parse(JSON.stringify(i))}),t}static deserializeDomEvent(e){const t=e.constructorName||"Event",s=_.pick(e,ac);if(s.relatedTarget){const n=document.getElementById(s.relatedTarget.id);assert&&assert(n,"cannot deserialize event when related target is not in the DOM."),s.relatedTarget=n}const i=new window[t](t,s);for(const n in e)if(e.hasOwnProperty(n)&&!ac.includes(n))if(n==="target"){if(assert){const a=e.target;a&&a.id&&assert(document.getElementById(a.id),"target should exist in the PDOM to support playback.")}i[Zi]=_.clone(e[n])||{},i[Zi].getAttribute=function(a){return this[a]}}else i[n]=e[n];return i}static debugText(e,t){let s=`${t.timeStamp} ${t.type}`;return e!==null&&(s=`${e.x},${e.y} ${s}`),s}static msPointerType(e){return e.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_TOUCH?"touch":e.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_PEN?"pen":e.pointerType===window.MSPointerEvent.MSPOINTER_TYPE_MOUSE?"mouse":e.pointerType}};te.InputIO=new Le("InputIO",{valueType:te,applyState:_.noop,toStateObject:e=>({pointers:rc.toStateObject(e.pointers)}),stateSchema:{pointers:rc}});let us=te;d.register("Input",us);const qe=class qe extends si{};qe.POINTER_TYPE=new qe,qe.MS_POINTER_TYPE=new qe,qe.TOUCH_TYPE=new qe,qe.MOUSE_TYPE=new qe,qe.WHEEL_TYPE=new qe,qe.ALT_TYPE=new qe,qe.enumeration=new ii(qe,{phetioDocumentation:"The type of batched event"});let W=qe;const Tn=class Tn{constructor(e,t,s){this.initialize(e,t,s)}initialize(e,t,s){return assert&&assert(e.domEvent,"for some reason, there is no DOM event?"),this.eventContext=e,this.type=t,this.callback=s,this}run(e){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent("Running batched event"),sceneryLog&&sceneryLog.InputEvent&&sceneryLog.push();const t=this.callback;if(e.validatePointers(),this.type===W.POINTER_TYPE){const s=this.eventContext,i=s.domEvent;t.call(e,i.pointerId,i.pointerType,e.pointFromEvent(i),s)}else if(this.type===W.MS_POINTER_TYPE){const s=this.eventContext,i=s.domEvent;t.call(e,i.pointerId,us.msPointerType(i),e.pointFromEvent(i),s)}else if(this.type===W.TOUCH_TYPE){const s=this.eventContext,i=s.domEvent;for(let n=0;n<i.changedTouches.length;n++){const a=i.changedTouches.item(n);t.call(e,a.identifier,e.pointFromEvent(a),s)}}else if(this.type===W.MOUSE_TYPE){const s=this.eventContext,i=e.pointFromEvent(s.domEvent);t===e.mouseDown?t.call(e,null,i,s):t.call(e,i,s)}else if(this.type===W.WHEEL_TYPE||this.type===W.ALT_TYPE)t.call(e,this.eventContext);else throw new Error(`bad type value: ${this.type}`);sceneryLog&&sceneryLog.InputEvent&&sceneryLog.pop()}dispose(){this.eventContext=null,this.callback=null,this.freeToPool()}freeToPool(){Tn.pool.freeToPool(this)}};Tn.pool=new nt(Tn);let wr=Tn;d.register("BatchedDOMEvent",wr);const yf=()=>{};let oc=!1;const G={blockFocusCallbacks:!1,addDisplay(r,e,t){assert&&assert(r instanceof Be),assert&&assert(typeof e=="boolean"),assert&&assert(!_.includes(this.attachedDisplays,r),"A display cannot be concurrently attached to events more than one time"),oc||(oc=!0,ze.attachToWindow(),oe.attachToWindow()),this.attachedDisplays.push(r),e?this.attachedDisplays.length===1&&this.connectWindowListeners(t):this.addOrRemoveListeners(r.domElement,!0,t),r.domElement.addEventListener("wheel",this.onwheel,G.getEventOptions(t,!0))},removeDisplay(r,e,t){assert&&assert(r instanceof Be),assert&&assert(typeof e=="boolean"),assert&&assert(_.includes(this.attachedDisplays,r),"This display was not already attached to listen for window events"),Tt(this.attachedDisplays,r),e?this.attachedDisplays.length===0&&this.disconnectWindowListeners(t):this.addOrRemoveListeners(r.domElement,!1,t),r.domElement.removeEventListener("wheel",this.onwheel,G.getEventOptions(t,!0))},getEventOptions(r,e){if(A.passive&&r!==null){const s={passive:r};return e&&(s.capture=!1),assert&&assert(!s.capture,"Do not use capture without consulting globalKeyStateTracker, which expects have listeners called FIRST in keyboard-related cases."),s}else return!1},listenersAttachedToWindow:0,listenersAttachedToElement:0,attachedDisplays:[],canUsePointerEvents:!!(window.navigator&&window.navigator.pointerEnabled||window.PointerEvent)&&!Te.firefox,canUseMSPointerEvents:window.navigator&&window.navigator.msPointerEnabled,pointerListenerTypes:["pointerdown","pointerup","pointermove","pointerover","pointerout","pointercancel","gotpointercapture","lostpointercapture"],msPointerListenerTypes:["MSPointerDown","MSPointerUp","MSPointerMove","MSPointerOver","MSPointerOut","MSPointerCancel"],touchListenerTypes:["touchstart","touchend","touchmove","touchcancel"],mouseListenerTypes:["mousedown","mouseup","mousemove","mouseover","mouseout"],wheelListenerTypes:["wheel"],altListenerTypes:N.DOM_EVENTS,getNonWheelUsedTypes(){let r;return this.canUsePointerEvents?(sceneryLog&&sceneryLog.Input&&sceneryLog.Input("Detected pointer events support, using that instead of mouse/touch events"),r=this.pointerListenerTypes):this.canUseMSPointerEvents?(sceneryLog&&sceneryLog.Input&&sceneryLog.Input("Detected MS pointer events support, using that instead of mouse/touch events"),r=this.msPointerListenerTypes):(sceneryLog&&sceneryLog.Input&&sceneryLog.Input("No pointer events support detected, using mouse/touch events"),r=this.touchListenerTypes.concat(this.mouseListenerTypes)),r=r.concat(this.altListenerTypes),r},connectWindowListeners(r){this.addOrRemoveListeners(window,!0,r)},disconnectWindowListeners(r){this.addOrRemoveListeners(window,!1,r)},addOrRemoveListeners(r,e,t){assert&&assert(typeof e=="boolean"),assert&&assert(typeof t=="boolean"||t===null);const s=r===window;assert&&assert(!s||this.listenersAttachedToWindow>0==!e,"Do not add listeners to the window when already attached, or remove listeners when none are attached");const i=e?1:-1;s?this.listenersAttachedToWindow+=i:this.listenersAttachedToElement+=i,assert&&assert(this.listenersAttachedToWindow===0||this.listenersAttachedToElement===0,"Listeners should not be added both with addDisplayToWindow and addDisplayToElement. Use only one.");const n=e?"addEventListener":"removeEventListener",a=this.getNonWheelUsedTypes();for(let o=0;o<a.length;o++){const h=a[o];s&&document[n](h,yf,G.getEventOptions(t,!1));const l=this[`on${h}`];assert&&assert(!!l),r[n](h,l,G.getEventOptions(t,!0))}},batchWindowEvent(r,e,t,s){for(let i=0;i<this.attachedDisplays.length;i++){const a=this.attachedDisplays[i]._input;(!G.blockFocusCallbacks||t!=="focusIn"&&t!=="focusOut")&&a.batchEvent(r,e,a[t],s)}},onpointerdown:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("pointerdown"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push();const t=new F(e);e.pointerType==="mouse"&&Be.userGestureEmitter.emit(),G.batchWindowEvent(t,W.POINTER_TYPE,"pointerDown",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onpointerup:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("pointerup"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push();const t=new F(e);Be.userGestureEmitter.emit(),G.batchWindowEvent(t,W.POINTER_TYPE,"pointerUp",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onpointermove:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("pointermove"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.POINTER_TYPE,"pointerMove",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onpointerover:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("pointerover"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.POINTER_TYPE,"pointerOver",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onpointerout:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("pointerout"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.POINTER_TYPE,"pointerOut",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onpointercancel:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("pointercancel"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.POINTER_TYPE,"pointerCancel",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},ongotpointercapture:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("gotpointercapture"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.POINTER_TYPE,"gotPointerCapture",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onlostpointercapture:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("lostpointercapture"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.POINTER_TYPE,"lostPointerCapture",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onMSPointerDown:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("MSPointerDown"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MS_POINTER_TYPE,"pointerDown",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onMSPointerUp:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("MSPointerUp"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MS_POINTER_TYPE,"pointerUp",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onMSPointerMove:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("MSPointerMove"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MS_POINTER_TYPE,"pointerMove",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onMSPointerOver:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("MSPointerOver"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MS_POINTER_TYPE,"pointerOver",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onMSPointerOut:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("MSPointerOut"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MS_POINTER_TYPE,"pointerOut",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onMSPointerCancel:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("MSPointerCancel"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MS_POINTER_TYPE,"pointerCancel",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},ontouchstart:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("touchstart"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.TOUCH_TYPE,"touchStart",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},ontouchend:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("touchend"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push();const t=new F(e);Be.userGestureEmitter.emit(),G.batchWindowEvent(t,W.TOUCH_TYPE,"touchEnd",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},ontouchmove:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("touchmove"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.TOUCH_TYPE,"touchMove",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},ontouchcancel:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("touchcancel"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.TOUCH_TYPE,"touchCancel",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onmousedown:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("mousedown"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push();const t=new F(e);Be.userGestureEmitter.emit(),G.batchWindowEvent(t,W.MOUSE_TYPE,"mouseDown",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onmouseup:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("mouseup"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push();const t=new F(e);Be.userGestureEmitter.emit(),G.batchWindowEvent(t,W.MOUSE_TYPE,"mouseUp",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onmousemove:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("mousemove"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MOUSE_TYPE,"mouseMove",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onmouseover:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("mouseover"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MOUSE_TYPE,"mouseOver",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onmouseout:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("mouseout"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.MOUSE_TYPE,"mouseOut",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onwheel:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("wheel"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.WHEEL_TYPE,"wheel",!1),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onfocusin:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("focusin"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),oe.updatePDOMFocusFromEvent(G.attachedDisplays,e,!0),G.batchWindowEvent(new F(e),W.ALT_TYPE,"focusIn",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onfocusout:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("focusout"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),oe.updatePDOMFocusFromEvent(G.attachedDisplays,e,!1),G.batchWindowEvent(new F(e),W.ALT_TYPE,"focusOut",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},oninput:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("input"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.ALT_TYPE,"input",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onchange:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("change"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.ALT_TYPE,"change",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onclick:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("click"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.ALT_TYPE,"click",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onkeydown:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("keydown"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.ALT_TYPE,"keyDown",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()},onkeyup:function(e){sceneryLog&&sceneryLog.OnInput&&sceneryLog.OnInput("keyup"),sceneryLog&&sceneryLog.OnInput&&sceneryLog.push(),G.batchWindowEvent(new F(e),W.ALT_TYPE,"keyUp",!0),sceneryLog&&sceneryLog.OnInput&&sceneryLog.pop()}};d.register("BrowserEvents",G);const Dr=G;class Qr{constructor(e){this.callbacks=[],this._delay=400,this._interval=100,this.delayID=null,this.intervalID=null,this.fired=!1,(e==null?void 0:e.delay)!==void 0&&(this.delay=e.delay),(e==null?void 0:e.interval)!==void 0&&(this.interval=e.interval),e!=null&&e.callback&&this.callbacks.push(e.callback)}isRunning(){return this.delayID!==null||this.intervalID!==null}start(){this.isRunning()||(this.fired=!1,this.delayID=Oe.setTimeout(()=>{this.delayID=null,this.intervalID=Oe.setInterval(()=>this.fire(),this.interval),this.fire()},this.delay))}stop(e){this.isRunning()&&(this.delayID&&(Oe.clearTimeout(this.delayID),this.delayID=null),this.intervalID&&(Oe.clearInterval(this.intervalID),this.intervalID=null),e&&!this.fired&&this.fire())}addCallback(e){this.callbacks.includes(e)||this.callbacks.push(e)}removeCallback(e){const t=this.callbacks.indexOf(e);t!==-1&&this.callbacks.splice(t,1)}fire(){const e=this.callbacks.slice(0);for(let t=0;t<e.length;t++)e[t]();this.fired=!0}set delay(e){assert&&assert(e>=0,`bad value for delay: ${e}`),this._delay=e}get delay(){return this._delay}set interval(e){assert&&assert(e>0,`bad value for interval: ${e}`),this._interval=e}get interval(){return this._interval}dispose(){this.stop(!1),this.callbacks.length=0}}it.register("CallbackTimer",Qr);class bf extends Xn{constructor(e){assert&&assert(e.fireOnHoldTiming==="custom"||e.fireOnHoldCustomDelay===void 0&&e.fireOnHoldCustomInterval===void 0,"Cannot specify fireOnHoldCustomDelay / fireOnHoldCustomInterval if fireOnHoldTiming is not custom");const t=E()({modifierKeys:[],ignoredModifierKeys:[],fire:_.noop,fireOnDown:!0,fireOnHold:!1,fireOnHoldTiming:"browser",fireOnHoldCustomDelay:400,fireOnHoldCustomInterval:100,allowOverlap:!1},e);super(t),this.isPressedProperty=new ie(!1),this.interrupted=!1,this.key=t.key,this.modifierKeys=t.modifierKeys,this.ignoredModifierKeys=t.ignoredModifierKeys,this.fire=t.fire,this.fireOnDown=t.fireOnDown,this.fireOnHold=t.fireOnHold,this.fireOnHoldTiming=t.fireOnHoldTiming,this.allowOverlap=t.allowOverlap,this.keys=_.uniq([this.key,...this.modifierKeys]),this.fireOnHold&&this.fireOnHoldTiming==="custom"&&(this.fireOnHoldTimer=new Qr({callback:this.fire.bind(this,null),delay:t.fireOnHoldCustomDelay,interval:t.fireOnHoldCustomInterval}),this.disposeEmitter.addListener(()=>this.fireOnHoldTimer.dispose()),this.isPressedProperty.link(s=>{this.fireOnHoldTimer.stop(!1),s&&this.fireOnHoldTimer.start()}))}getHotkeyString(){return[...this.modifierKeys,this.key].join("+")}dispose(){this.isPressedProperty.dispose(),super.dispose()}}d.register("Hotkey",bf);class Lu{constructor(){this.hotkeysProperty=new X(new Set)}add(e){assert&&assert(!this.hotkeysProperty.value.has(e),"Hotkey already added"),this.hotkeysProperty.value=new Set([...this.hotkeysProperty.value,e])}remove(e){assert&&assert(this.hotkeysProperty.value.has(e),"Hotkey not found"),this.hotkeysProperty.value=new Set([...this.hotkeysProperty.value].filter(t=>t!==e))}}d.register("GlobalHotkeyRegistry",Lu);const Lf=new Lu,hc=(r,e)=>r.size===e.size&&[...r].every(t=>e.has(t));class vu{constructor(){this.enabledHotkeysProperty=new X(new Set),this.englishKeysDown=new Set,this.modifierKeys=[],this.activeHotkeys=new Set,this.availableHotkeysProperty=new be([Lf.hotkeysProperty,oe.pdomFocusProperty],(i,n)=>{const a=new Set(i);if(n)for(const o of n.trail.nodes){if(!o.isInputEnabled())break;o.inputListeners.forEach(h=>{var l;(l=h.hotkeys)==null||l.forEach(c=>{a.add(c)})})}return a},{valueComparisonStrategy:hc});const e=()=>{this.availableHotkeysProperty.recomputeDerivation()};oe.pdomFocusProperty.link((i,n)=>{n&&n.trail.nodes.forEach(a=>{a.inputEnabledProperty.unlink(e)}),i&&i.trail.nodes.forEach(a=>{a.inputEnabledProperty.lazyLink(e)})});const t=()=>{this.enabledHotkeysProperty.value=new Set([...this.availableHotkeysProperty.value].filter(i=>i.enabledProperty.value))},s=new Map;this.availableHotkeysProperty.link((i,n)=>{let a=!1;if(n){for(const o of n)if(!i.has(o)){const h=s.get(o);s.delete(o),assert&&assert(h),o.enabledProperty.unlink(h),a=!0}}for(const o of i)if(!n||!n.has(o)){const h=()=>t();s.set(o,h),o.enabledProperty.lazyLink(h),a=!0}a&&t()}),this.enabledHotkeysProperty.link((i,n)=>{if(this.modifierKeys=_.uniq([...Rp,...[...i].flatMap(a=>a.modifierKeys)]),n)for(const a of n)!i.has(a)&&this.activeHotkeys.has(a)&&this.removeActiveHotkey(a,null,!1);this.updateHotkeyStatus(null)}),ze.keyDownStateChangedEmitter.addListener(i=>{const n=ze.getEnglishKeysDown();if(!hc(this.englishKeysDown,n))this.englishKeysDown=n,this.updateHotkeyStatus(i);else for(const o of[...this.activeHotkeys])o.fireOnHold&&o.fireOnHoldTiming==="browser"&&o.fire(i)})}getHotkeysForMainKey(e){if(!this.englishKeysDown.has(e))return[];const t=[...this.enabledHotkeysProperty.value].filter(s=>s.key!==e?!1:this.modifierKeys.every(i=>this.englishKeysDown.has(i)===s.keys.includes(i)||s.ignoredModifierKeys.includes(i)));if(assert){const s=t.filter(i=>!i.allowOverlap);assert&&assert(s.length<2,`Key conflict detected: ${s.map(i=>i.getHotkeyString())}`)}return t}updateHotkeyStatus(e){const t=g.getEventCode(e),s=t?cd(t):null;for(const i of this.enabledHotkeysProperty.value){const n=this.getHotkeysForMainKey(i.key).includes(i),a=this.activeHotkeys.has(i);n&&!a?this.addActiveHotkey(i,null,i.key===s):!n&&a&&this.removeActiveHotkey(i,null,i.key===s)}}addActiveHotkey(e,t,s){this.activeHotkeys.add(e),e.isPressedProperty.value=!0,e.interrupted=!1,s&&e.fireOnDown&&e.fire(t)}removeActiveHotkey(e,t,s){e.interrupted=!s,s&&!e.fireOnDown&&e.fire(t),e.isPressedProperty.value=!1,this.activeHotkeys.delete(e)}}d.register("HotkeyManager",vu);new vu;class vf{constructor(e,t){this.display=e,this.touches=[],this.nextTouchID=1,this.isMouseDown=!1,this.mousePosition=new T(0,0),this.random=new No({seed:t}),this.mouseToggleAction=()=>{this.mouseToggle()},this.mouseMoveAction=()=>{this.mouseMove()},this.touchStartAction=()=>{const s=this.createTouch(this.getRandomPosition());this.touchStart(s)},this.touchMoveAction=()=>{const s=this.random.sample(this.touches);this.touchMove(s)},this.touchEndAction=()=>{const s=this.random.sample(this.touches);this.touchEnd(s),this.removeTouch(s)},this.touchCancelAction=()=>{const s=this.random.sample(this.touches);this.touchCancel(s),this.removeTouch(s)}}fuzzEvents(e,t,s,i){for(assert&&assert(e>0,`averageEventCount must be positive: ${e}`),this.display._input.currentlyFiringEvents=!0;this.random.nextDouble()<1-1/(e+1);){const a=this.touches.length+(this.isMouseDown?1:0)<i,o=[];t&&(this.isMouseDown||a)&&(o.push(this.mouseToggleAction),o.push(this.mouseMoveAction)),s&&(a&&o.push(this.touchStartAction),this.touches.length&&(o.push(this.random.nextDouble()<.8?this.touchEndAction:this.touchCancelAction),o.push(this.touchMoveAction))),this.random.sample(o)()}this.display._input.currentlyFiringEvents=!1,this.display._input.fireBatchedEvents()}createTouchEvent(e,t){const s=this.display.domElement,i=t.map(n=>({identifier:n.id,target:s,clientX:n.position.x,clientY:n.position.y}));if(window.Touch!==void 0&&window.TouchEvent!==void 0&&window.Touch.length===1&&window.TouchEvent.length===1){const n=i.map(a=>new window.Touch(a));return new window.TouchEvent(e,{cancelable:!0,bubbles:!0,touches:n,targetTouches:[],changedTouches:n,shiftKey:!1})}else{const n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!0,!0,{touches:i,targetTouches:[],changedTouches:i}),n}}getRandomPosition(){return new T(Math.floor(this.random.nextDouble()*this.display.width),Math.floor(this.random.nextDouble()*this.display.height))}createTouch(e){const t={id:this.nextTouchID++,position:e};return this.touches.push(t),t}removeTouch(e){this.touches.splice(this.touches.indexOf(e),1)}touchStart(e){const t=this.createTouchEvent("touchstart",[e]);this.display._input.validatePointers(),this.display._input.touchStart(e.id,e.position,new F(t))}touchMove(e){e.position=this.getRandomPosition();const t=this.createTouchEvent("touchmove",[e]);this.display._input.validatePointers(),this.display._input.touchMove(e.id,e.position,new F(t))}touchEnd(e){const t=this.createTouchEvent("touchend",[e]);this.display._input.validatePointers(),this.display._input.touchEnd(e.id,e.position,new F(t))}touchCancel(e){const t=this.createTouchEvent("touchcancel",[e]);this.display._input.validatePointers(),this.display._input.touchCancel(e.id,e.position,new F(t))}mouseToggle(){const e=document.createEvent("MouseEvent");e.initMouseEvent(this.isMouseDown?"mouseup":"mousedown",!0,!0,window,1,this.mousePosition.x,this.mousePosition.y,this.mousePosition.x,this.mousePosition.y,!1,!1,!1,!1,0,null),this.display._input.validatePointers(),this.isMouseDown?(this.display._input.mouseUp(this.mousePosition,new F(e)),this.isMouseDown=!1):(this.display._input.mouseDown(null,this.mousePosition,new F(e)),this.isMouseDown=!0)}mouseMove(){this.mousePosition=this.getRandomPosition();const e=document.createEvent("MouseEvent");e.initMouseEvent("mousemove",!0,!0,window,0,this.mousePosition.x,this.mousePosition.y,this.mousePosition.x,this.mousePosition.y,!1,!1,!1,!1,0,null),this.display._input.validatePointers(),this.display._input.mouseMove(this.mousePosition,new F(e))}}d.register("InputFuzzer",vf);class Pu extends _e{constructor(e){assert&&Ot("DownUpListener is deprecated, please use PressListener instead"),e=Je({mouseButton:0},e),super(e),this.options=e,this.isDown=!1,this.downCurrentTarget=null,this.downTrail=null,this.pointer=null,this.interrupted=!1,this.downListener={up:t=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`DownUpListener (pointer) up for ${this.downTrail.toString()}`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),assert&&assert(t.pointer===this.pointer),(!(t.pointer instanceof lt)||t.domEvent.button===this.options.mouseButton)&&this.buttonUp(t),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},interrupt:()=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`DownUpListener (pointer) interrupt for ${this.downTrail.toString()}`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.interrupt(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},cancel:t=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`DownUpListener (pointer) cancel for ${this.downTrail.toString()}`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),assert&&assert(t.pointer===this.pointer),this.buttonUp(t),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}}}buttonDown(e){this.isDown||e.pointer instanceof lt&&e.domEvent.button!==this.options.mouseButton||(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DownUpListener buttonDown"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),e.pointer.addInputListener(this.downListener),this.isDown=!0,this.downCurrentTarget=e.currentTarget,this.downTrail=e.trail.subtrailTo(e.currentTarget,!1),this.pointer=e.pointer,this.options.down&&this.options.down(e,this.downTrail),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop())}buttonUp(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DownUpListener buttonUp"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.isDown=!1,this.pointer.removeInputListener(this.downListener);const t=e.currentTarget;if(e.currentTarget=this.downCurrentTarget,this.options.upInside||this.options.upOutside){const i=e.trail.isExtensionOf(this.downTrail,!0)&&!this.interrupted;i&&this.options.upInside?this.options.upInside(e,this.downTrail):!i&&this.options.upOutside&&this.options.upOutside(e,this.downTrail)}this.options.up&&this.options.up(e,this.downTrail),e.currentTarget=t,sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}down(e){this.buttonDown(e)}interrupt(){if(this.isDown){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DownUpListener interrupt"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.interrupted=!0;const e=F.createSynthetic(),t=new Ue(new R,"synthetic",this.pointer,e);t.currentTarget=this.downCurrentTarget,this.buttonUp(t),this.interrupted=!1,sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}}}d.register("DownUpListener",Pu);class Wn extends Pu{constructor(e){assert&&Ot("ButtonListener is deprecated, please use FireListener instead"),e=Je({phetioType:Wn.ButtonListenerIO,phetioState:!1,phetioEventType:Z.USER},e),super({tandem:e.tandem,phetioType:e.phetioType,phetioState:e.phetioState,mouseButton:e.mouseButton||0,down:(t,s)=>{this.setButtonState(t,"down")},up:(t,s)=>{this.setButtonState(t,this._overCount>0?"over":"up")}}),this.buttonState="up",this._overCount=0,this._buttonOptions=e}setButtonState(e,t){if(t!==this.buttonState){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`ButtonListener state change to ${t} from ${this.buttonState} for ${this.downTrail?this.downTrail.toString():this.downTrail}`);const s=this.buttonState;this.buttonState=t,this._buttonOptions[t]&&(this.phetioStartEvent(t),this._buttonOptions[t](e,s),this.phetioEndEvent()),this._buttonOptions.fire&&this._overCount>0&&!this.interrupted&&(this._buttonOptions.fireOnDown?t==="down":s==="down")&&(this.phetioStartEvent("fire"),this._buttonOptions.fire(e),this.phetioEndEvent())}}enter(e){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`ButtonListener enter for ${this.downTrail?this.downTrail.toString():this.downTrail}`),this._overCount++,this._overCount===1&&this.setButtonState(e,this.isDown?"down":"over")}exit(e){sceneryLog&&sceneryLog.InputEvent&&sceneryLog.InputEvent(`ButtonListener exit for ${this.downTrail?this.downTrail.toString():this.downTrail}`),assert&&assert(this._overCount>0,"Exit events not matched by an enter"),this._overCount--,this._overCount===0&&this.setButtonState(e,this.isDown?"out":"up")}focus(e){this.enter(e)}blur(e){this.exit(e)}click(e){this.setButtonState(e,"down"),this.setButtonState(e,"up")}}d.register("ButtonListener",Wn);Wn.ButtonListenerIO=new Le("ButtonListenerIO",{valueType:Wn,documentation:"Button listener",events:["up","over","down","out","fire"]});class Pf extends _e{constructor(e){assert&&Ot("SimpleDragHandler is deprecated, please use DragListener instead"),e=Je({start:null,drag:null,end:null,translate:null,allowTouchSnag:!1,mouseButton:0,dragCursor:"pointer",attach:!0,tandem:se.REQUIRED,phetioState:!1,phetioEventType:Z.USER,phetioReadOnly:!0},e),super(),this.options=e,this.isDraggingProperty=new ie(!1,{phetioReadOnly:e.phetioReadOnly,phetioState:!1,tandem:e.tandem.createTandem("isDraggingProperty"),phetioDocumentation:"Indicates whether the object is dragging"}),this.pointer=null,this.trail=null,this.transform=null,this.node=null,this.lastDragPoint=null,this.startTransformMatrix=null,this.mouseButton=void 0,this.interrupted=!1,this.lastInterruptedTouchLikePointer=null,this._attach=e.attach,this.dragStartAction=new q((t,s)=>{this.dragging||(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("SimpleDragHandler startDrag"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this._attach&&(s.pointer.dragging=!0),s.pointer.cursor=this.options.dragCursor,s.pointer.addInputListener(this.dragListener,this.options.attach),s.pointer.reserveForDrag(),this.isDraggingProperty.set(!0),this.pointer=s.pointer,this.trail=s.trail.subtrailTo(s.currentTarget,!0),this.transform=this.trail.getTransform(),this.node=s.currentTarget,this.lastDragPoint=s.pointer.point,this.startTransformMatrix=s.currentTarget.getMatrix().copy(),this.mouseButton=s.pointer instanceof lt?s.domEvent.button:void 0,this.options.start&&this.options.start.call(null,s,this.trail),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop())},{tandem:e.tandem.createTandem("dragStartAction"),phetioReadOnly:e.phetioReadOnly,parameters:[{name:"point",phetioType:T.Vector2IO,phetioDocumentation:"the position of the drag start in view coordinates"},{phetioPrivate:!0,valueType:[Ue,null]}]}),this.dragAction=new q((t,s)=>{if(!this.dragging||this.isDisposed)return;const i=this.pointer.point.minus(this.lastDragPoint);if(i.magnitudeSquared===0)return;const n=this.transform.inverseDelta2(i);if(assert&&assert(s.pointer===this.pointer,"Wrong pointer in move"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`SimpleDragHandler (pointer) move for ${this.trail.toString()}`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.options.translate){const a=this.node.getMatrix().getTranslation();this.options.translate.call(null,{delta:n,oldPosition:a,position:a.plus(n)})}if(this.lastDragPoint=this.pointer.point,this.options.drag){const a=s.currentTarget;s.currentTarget=this.node,this.options.drag.call(null,s,this.trail),s.currentTarget=a}sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},{phetioHighFrequency:!0,phetioReadOnly:e.phetioReadOnly,tandem:e.tandem.createTandem("dragAction"),parameters:[{name:"point",phetioType:T.Vector2IO,phetioDocumentation:"the position of the drag in view coordinates"},{phetioPrivate:!0,valueType:[Ue,null]}]}),this.dragEndAction=new q((t,s)=>{this.dragging&&(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("SimpleDragHandler endDrag"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this._attach&&(this.pointer.dragging=!1),this.pointer.cursor=null,this.pointer.removeInputListener(this.dragListener),this.isDraggingProperty.set(!1),this.options.end&&this.options.end.call(null,s,this.trail),this.pointer=null,sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop())},{tandem:e.tandem.createTandem("dragEndAction"),phetioReadOnly:e.phetioReadOnly,parameters:[{name:"point",phetioType:T.Vector2IO,phetioDocumentation:"the position of the drag end in view coordinates"},{phetioPrivate:!0,isValidValue:t=>t===null||t instanceof Ue||t.pointer&&t.currentTarget}]}),this.transformListener={transform:t=>{if(!this.trail.isExtensionOf(t.trail,!0))return;const s=t.trail.getMatrix(),i=this.transform.getMatrix();this.node.prependMatrix(s.inverted().timesMatrix(i)),this.transform.setMatrix(s)}},this.dragListener={up:t=>{if(!(!this.dragging||this.isDisposed)){if(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`SimpleDragHandler (pointer) up for ${this.trail.toString()}`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),assert&&assert(t.pointer===this.pointer,"Wrong pointer in up"),!(t.pointer instanceof lt)||t.domEvent.button===this.mouseButton){const s=t.currentTarget;t.currentTarget=this.node,this.endDrag(t),t.currentTarget=s}sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}},cancel:t=>{if(!this.dragging||this.isDisposed)return;sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`SimpleDragHandler (pointer) cancel for ${this.trail.toString()}`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),assert&&assert(t.pointer===this.pointer,"Wrong pointer in cancel");const s=t.currentTarget;t.currentTarget=this.node,this.endDrag(t),t.currentTarget=s,this.transform||this.node.setMatrix(this.startTransformMatrix),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},move:t=>{this.dragAction.execute(t.pointer.point,t)},interrupt:()=>{this.interrupt()}},this.initializePhetioObject({},e)}get dragging(){return this.isDraggingProperty.get()}set dragging(e){assert&&assert(!1,"illegal call to set dragging on SimpleDragHandler")}startDrag(e){this.dragStartAction.execute(e.pointer.point,e)}endDrag(e){this.dragEndAction.execute(e?e.pointer.point:T.ZERO,e)}interrupt(){this.dragging&&(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("SimpleDragHandler interrupt"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.interrupted=!0,this.pointer&&this.pointer.isTouchLike()&&(this.lastInterruptedTouchLikePointer=this.pointer),this.endDrag({pointer:this.pointer,currentTarget:this.node}),this.interrupted=!1,sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop())}tryToSnag(e){e.pointer instanceof lt&&e.domEvent&&this.options.mouseButton!==e.domEvent.button&&this.options.mouseButton!==-1||this.isDisposed||!this.dragging&&(!e.pointer.dragging||!this._attach)&&e.pointer!==this.lastInterruptedTouchLikePointer&&e.canStartPress()&&this.startDrag(e)}tryTouchToSnag(e){this.options.allowTouchSnag&&(this.options.allowTouchSnag===!0||this.options.allowTouchSnag(e))&&this.tryToSnag(e)}down(e){this.tryToSnag(e)}touchenter(e){this.tryTouchToSnag(e)}touchmove(e){this.tryTouchToSnag(e)}dispose(){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("SimpleDragHandler dispose"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.dragging&&(this._attach&&(this.pointer.dragging=!1),this.pointer.cursor=null,this.pointer.removeInputListener(this.dragListener)),this.isDraggingProperty.dispose(),this.dragEndAction.dispose(),this.dragAction.dispose(),this.dragStartAction.dispose(),super.dispose(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}static createForwardingListener(e,t){return t=Je({allowTouchSnag:!1},t),{down:s=>{!s.pointer.dragging&&s.canStartPress()&&e(s)},touchenter:function(s){t.allowTouchSnag&&this.down(s)},touchmove:function(s){t.allowTouchSnag&&this.down(s)}}}}d.register("SimpleDragHandler",Pf);const ah=r=>{var l,c,u,m;Ge(r,["length"],["elements"]);const e=E()({hasListenerOrderDependencies:!1,length:0,elements:[],elementAddedEmitterOptions:{},elementRemovedEmitterOptions:{},lengthPropertyOptions:{}},r);let t=null;if(e.phetioType)assert&&assert(e.phetioType.typeName.startsWith("ObservableArrayIO")),t={name:"value",phetioType:e.phetioType.parameterTypes[0]};else if(Dt.getValidatorValidationError(e))t=Je({name:"value"},{isValidValue:_.stubTrue});else{const b=_.pick(e,Dt.VALIDATOR_KEYS);t=Je({name:"value"},b)}const s=new He(pe({tandem:(l=e.tandem)==null?void 0:l.createTandem("elementAddedEmitter"),parameters:[t],phetioReadOnly:!0,hasListenerOrderDependencies:e.hasListenerOrderDependencies},e.elementAddedEmitterOptions)),i=new He(pe({tandem:(c=e.tandem)==null?void 0:c.createTandem("elementRemovedEmitter"),parameters:[t],phetioReadOnly:!0,hasListenerOrderDependencies:e.hasListenerOrderDependencies},e.elementRemovedEmitterOptions)),n=new Kt(0,pe({numberType:"Integer",tandem:(u=e.tandem)==null?void 0:u.createTandem("lengthProperty"),phetioReadOnly:!0,hasListenerOrderDependencies:e.hasListenerOrderDependencies},e.lengthPropertyOptions)),a=[];assert&&s.addListener(()=>{ki.value||assert&&assert(n.value===a.length,"lengthProperty out of sync while adding element")}),assert&&i.addListener(()=>{ki.value||assert&&assert(n.value===a.length,"lengthProperty out of sync while removing element")});const o=new Proxy(a,{get:function(b,y,f){return assert&&assert(b===a,"array should match the targetArray"),lc.hasOwnProperty(y)?lc[y]:Reflect.get(b,y,f)},set:function(b,y,f){assert&&assert(b===a,"array should match the targetArray");const L=b[y];let v=null;y==="length"&&(v=b.slice(f));const S=Reflect.set(b,y,f),B=Number(y);return Number.isInteger(B)&&B>=0&&L!==f?(n.value=b.length,L!==void 0&&i.emit(b[y]),f!==void 0&&s.emit(f)):y==="length"&&(n.value=f,assert&&assert(v,"removedElements should be defined for key===length"),v&&v.forEach(ce=>i.emit(ce))),S},deleteProperty:function(b,y){assert&&assert(b===a,"array should match the targetArray");const f=Number(y);let L;Number.isInteger(f)&&f>=0&&(L=b[y]);const v=Reflect.deleteProperty(b,y);return L!==void 0&&i.emit(L),v}});o.targetArray=a,o.elementAddedEmitter=s,o.elementRemovedEmitter=i,o.lengthProperty=n;const h=()=>{e.length>=0&&(o.length=e.length),e.elements.length>0&&Array.prototype.push.apply(o,e.elements)};return h(),o.reset=()=>{o.length=0,h()},(m=e.tandem)!=null&&m.supplied&&(assert&&assert(e.phetioType),o.phetioElementType=e.phetioType.parameterTypes[0],o._observableArrayPhetioObject=new _u(o,e)),o};class _u extends _e{constructor(e,t){super(t),this.observableArray=e}}const lc={pop(...r){const e=this,t=e.targetArray.length,s=Array.prototype.pop.apply(e.targetArray,r);return e.lengthProperty.value=e.length,t>0&&e.elementRemovedEmitter.emit(s),s},shift(...r){const e=this,t=e.targetArray.length,s=Array.prototype.shift.apply(e.targetArray,r);return e.lengthProperty.value=e.length,t>0&&e.elementRemovedEmitter.emit(s),s},push(...r){const e=this,t=Array.prototype.push.apply(e.targetArray,r);e.lengthProperty.value=e.length;for(let s=0;s<arguments.length;s++)e.elementAddedEmitter.emit(r[s]);return t},unshift(...r){const e=this,t=Array.prototype.unshift.apply(e.targetArray,r);e.lengthProperty.value=e.length;for(let s=0;s<r.length;s++)e.elementAddedEmitter.emit(r[s]);return t},splice(...r){const e=this,t=Array.prototype.splice.apply(e.targetArray,r);e.lengthProperty.value=e.length;const s=t;for(let i=2;i<r.length;i++)e.elementAddedEmitter.emit(r[i]);return s.forEach(i=>e.elementRemovedEmitter.emit(i)),t},copyWithin(...r){const e=this,t=e.targetArray.slice(),s=Array.prototype.copyWithin.apply(e.targetArray,r);return cc(t,e),s},fill(...r){const e=this,t=e.targetArray.slice(),s=Array.prototype.fill.apply(e.targetArray,r);return cc(t,e),s},get:function(r){return this[r]},addItemAddedListener:function(r){this.elementAddedEmitter.addListener(r)},removeItemAddedListener:function(r){this.elementAddedEmitter.removeListener(r)},addItemRemovedListener:function(r){this.elementRemovedEmitter.addListener(r)},removeItemRemovedListener:function(r){this.elementRemovedEmitter.removeListener(r)},add:function(r){this.push(r)},addAll:function(r){this.push(...r)},remove:function(r){Tt(this,r)},removeAll:function(r){r.forEach(e=>Tt(this,e))},clear:function(){for(;this.length>0;)this.pop()},count:function(r){let e=0;for(let t=0;t<this.length;t++)r(this[t])&&e++;return e},find:function(r,e){return assert&&e!==void 0&&assert(typeof e=="number","fromIndex must be numeric, if provided"),assert&&typeof e=="number"&&assert(e>=0&&e<this.length,`fromIndex out of bounds: ${e}`),_.find(this,r,e)},shuffle:function(r){assert&&assert(r,"random must be supplied");const e=r.shuffle(this);this.targetArray.length=0,Array.prototype.push.apply(this.targetArray,e)},getArrayCopy:function(){return this.slice()},dispose:function(){const r=this;r.elementAddedEmitter.dispose(),r.elementRemovedEmitter.dispose(),r.lengthProperty.dispose(),r._observableArrayPhetioObject&&r._observableArrayPhetioObject.dispose()},toStateObject:function(){return{array:this.map(r=>this.phetioElementType.toStateObject(r))}},applyState:function(r){this.length=0;const e=r.array.map(t=>this.phetioElementType.fromStateObject(t));this.push(...e)}},cc=(r,e)=>{const t=r,s=e.targetArray.slice();for(let i=0;i<t.length;i++){const n=t[i],a=s.indexOf(n);a>=0&&(t.splice(i,1),s.splice(a,1),i--)}t.forEach(i=>e.elementRemovedEmitter.emit(i)),s.forEach(i=>e.elementAddedEmitter.emit(i))},Na=new Ni,_f=r=>(Na.has(r)||Na.set(r,new Le(`ObservableArrayIO<${r.typeName}>`,{valueType:_u,parameterTypes:[r],toStateObject:e=>e.observableArray.toStateObject(),applyState:(e,t)=>e.observableArray.applyState(t),stateSchema:{array:Un(r)}})),Na.get(r));ah.ObservableArrayIO=_f;it.register("createObservableArray",ah);let Sf=0;const wf=_.constant(!0),Df=r=>r.isPressed,qh=class qh extends Xn{constructor(e){const t=E()({press:_.noop,release:_.noop,targetNode:null,drag:_.noop,attach:!0,mouseButton:0,pressCursor:"pointer",useInputListenerCursor:!1,canStartPress:wf,a11yLooksPressedInterval:100,collapseDragEvents:!1,phetioEnabledPropertyInstrumented:!1,tandem:se.REQUIRED,phetioReadOnly:!0,phetioFeatured:_e.DEFAULT_OPTIONS.phetioFeatured},e);assert&&assert(typeof t.mouseButton=="number"&&t.mouseButton>=0&&t.mouseButton%1===0,"mouseButton should be a non-negative integer"),assert&&assert(t.pressCursor===null||typeof t.pressCursor=="string","pressCursor should either be a string or null"),assert&&assert(typeof t.press=="function","The press callback should be a function"),assert&&assert(typeof t.release=="function","The release callback should be a function"),assert&&assert(typeof t.drag=="function","The drag callback should be a function"),assert&&assert(t.targetNode===null||t.targetNode instanceof D,"If provided, targetNode should be a Node"),assert&&assert(typeof t.attach=="boolean","attach should be a boolean"),assert&&assert(typeof t.a11yLooksPressedInterval=="number","a11yLooksPressedInterval should be a number"),super(t),this._id=Sf++,sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} construction`),this._mouseButton=t.mouseButton,this._a11yLooksPressedInterval=t.a11yLooksPressedInterval,this._pressCursor=t.pressCursor,this._pressListener=t.press,this._releaseListener=t.release,this._dragListener=t.drag,this._canStartPress=t.canStartPress,this._targetNode=t.targetNode,this._attach=t.attach,this._collapseDragEvents=t.collapseDragEvents,this.overPointers=ah(),this.isPressedProperty=new ie(!1,{reentrant:!0}),this.isOverProperty=new ie(!1),this.looksOverProperty=new ie(!1),this.isHoveringProperty=new ie(!1),this.isHighlightedProperty=new ie(!1),this.isFocusedProperty=new ie(!1),this.cursorProperty=new be([this.enabledProperty],s=>t.useInputListenerCursor&&s&&this._attach?this._pressCursor:null),this.pointer=null,this.pressedTrail=null,this.interrupted=!1,this._pendingCollapsedDragEvent=null,this._listeningToPointer=!1,this._isHoveringListener=this.invalidateHovering.bind(this),this._isHighlightedListener=this.invalidateHighlighted.bind(this),this.pdomClickingProperty=new ie(!1),this.looksPressedProperty=be.or([this.pdomClickingProperty,this.isPressedProperty]),this._pdomClickingTimeoutListener=null,this._pointerListener={up:this.pointerUp.bind(this),cancel:this.pointerCancel.bind(this),move:this.pointerMove.bind(this),interrupt:this.pointerInterrupt.bind(this),listener:this},this._pressAction=new q(this.onPress.bind(this),{tandem:t.tandem.createTandem("pressAction"),phetioDocumentation:"Executes whenever a press occurs. The first argument when executing can be used to convey info about the SceneryEvent.",phetioReadOnly:!0,phetioFeatured:t.phetioFeatured,phetioEventType:Z.USER,parameters:[{name:"event",phetioType:Ue.SceneryEventIO},{phetioPrivate:!0,valueType:[D,null]},{phetioPrivate:!0,valueType:["function",null]}]}),this._releaseAction=new q(this.onRelease.bind(this),{parameters:[{name:"event",phetioType:V(Ue.SceneryEventIO)},{phetioPrivate:!0,valueType:["function",null]}],tandem:t.tandem.createTandem("releaseAction"),phetioDocumentation:"Executes whenever a release occurs.",phetioReadOnly:!0,phetioFeatured:t.phetioFeatured,phetioEventType:Z.USER}),this.display=null,this.boundInvalidateOverListener=this.invalidateOver.bind(this),this.overPointers.lengthProperty.link(this.invalidateOver.bind(this)),this.isFocusedProperty.link(this.invalidateOver.bind(this)),this.overPointers.lengthProperty.link(this._isHoveringListener),this.isPressedProperty.link(this._isHoveringListener),this.overPointers.addItemAddedListener(s=>s.isDownProperty.link(this._isHoveringListener)),this.overPointers.addItemRemovedListener(s=>s.isDownProperty.unlink(this._isHoveringListener)),this.isHoveringProperty.link(this._isHighlightedListener),this.isPressedProperty.link(this._isHighlightedListener),this.enabledProperty.lazyLink(this.onEnabledPropertyChange.bind(this))}get isPressed(){return this.isPressedProperty.value}get cursor(){return this.cursorProperty.value}get attach(){return this._attach}get targetNode(){return this._targetNode}getCurrentTarget(){return assert&&assert(this.isPressed,"We have no currentTarget if we are not pressed"),this.pressedTrail.lastNode()}get currentTarget(){return this.getCurrentTarget()}canPress(e){return!!this.enabledProperty.value&&!this.isPressed&&this._canStartPress(e,this)&&(!(e.pointer instanceof lt)||e.domEvent.button===this._mouseButton)&&(!this._attach||!e.pointer.isAttached())}canClick(){return this.enabledProperty.value&&!this.isPressed&&this._canStartPress(null,this)}press(e,t,s){return assert&&assert(e,"An event is required"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} press`),this.canPress(e)?(this.flushCollapsedDrag(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} successful press`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this._pressAction.execute(e,t||null,s||null),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop(),!0):(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} could not press`),!1)}release(e,t){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} release`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.flushCollapsedDrag(),this._releaseAction.execute(e||null,t||null),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}drag(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} drag`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),assert&&assert(this.isPressed,"Can only drag while pressed"),this._dragListener(e,this),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}interrupt(){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} interrupt`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.pdomClickingProperty.value?(this.interrupted=!0,this._listeningToPointer?this.release():(this.isPressedProperty.value=!1,this._releaseListener(null,this)),Oe.hasListener(this._pdomClickingTimeoutListener)&&(Oe.clearTimeout(this._pdomClickingTimeoutListener),this.pdomClickingProperty.isDisposed||(this.pdomClickingProperty.value=!1))):this.isPressed&&(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} interrupting`),this.interrupted=!0,this.release()),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}clearOverPointers(){this.overPointers.clear()}step(){this.flushCollapsedDrag()}setCreatePanTargetBounds(e){this._pointerListener.createPanTargetBounds=e}set createPanTargetBounds(e){this.setCreatePanTargetBounds(e)}setCreatePanTargetBoundsFromTrail(e){assert&&assert(e.length>0,"trail has no Nodes to provide localBounds"),this.setCreatePanTargetBounds(()=>e.localToGlobalBounds(e.lastNode().localBounds))}set createPanTargetBoundsFromTrail(e){this.setCreatePanTargetBoundsFromTrail(e)}flushCollapsedDrag(){this._pendingCollapsedDragEvent&&this.drag(this._pendingCollapsedDragEvent),this._pendingCollapsedDragEvent=null}invalidateOver(){let e=!1;if(this._listeningToPointer)e=!1;else for(let t=0;t<this.overPointers.length;t++)if(this.overPointers.get(t).isAttached()){e=!0;break}this.isOverProperty.value=this.overPointers.length>0&&!e,this.looksOverProperty.value=this.isOverProperty.value||this.isFocusedProperty.value&&!!this.display&&this.display.focusManager.pdomFocusHighlightsVisibleProperty.value}invalidateHovering(){for(let e=0;e<this.overPointers.length;e++){const t=this.overPointers[e];if(!t.isDown||t===this.pointer){this.isHoveringProperty.value=!0;return}}this.isHoveringProperty.value=!1}invalidateHighlighted(){this.isHighlightedProperty.value=this.isHoveringProperty.value||this.isPressedProperty.value}onEnabledPropertyChange(e){!e&&this.interrupt()}onPress(e,t,s){assert&&assert(!this.isDisposed,"Should not press on a disposed listener");const i=t||this._targetNode;this.pointer=e.pointer,this.pressedTrail=i?i.getUniqueTrail():e.trail.subtrailTo(e.currentTarget,!1),this.interrupted=!1,this.pointer.addInputListener(this._pointerListener,this._attach),this._listeningToPointer=!0,this.pointer.cursor=this.pressedTrail.lastNode().getEffectiveCursor()||this._pressCursor,this.isPressedProperty.value=!0,this._pressListener(e,this),s&&s()}onRelease(e,t){assert&&assert(this.isPressed,"This listener is not pressed");const s=this;s.pointer.removeInputListener(this._pointerListener),this._listeningToPointer=!1,this.isPressedProperty.value=!1,this._releaseListener(e,this),t&&t(),s.pointer.cursor=null,this.pointer=null,this.pressedTrail=null}down(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} down`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.press(e),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}up(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} up`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.invalidateOver(),this.invalidateHovering(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}enter(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} enter`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.overPointers.push(e.pointer),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}move(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} move`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.invalidateOver(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}exit(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} exit`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.overPointers.includes(e.pointer)&&this.overPointers.remove(e.pointer),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}pointerUp(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} pointer up`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.isPressed&&(assert&&assert(e.pointer===this.pointer),this.release(e)),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}pointerCancel(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} pointer cancel`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.isPressed&&(assert&&assert(e.pointer===this.pointer),this.interrupt()),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}pointerMove(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} pointer move`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.isPressed&&(assert&&assert(e.pointer===this.pointer),this._collapseDragEvents?this._pendingCollapsedDragEvent=e:this.drag(e)),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}pointerInterrupt(){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} pointer interrupt`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.interrupt(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}click(e,t){return this.canClick()&&(this.interrupted=!1,this.pdomClickingProperty.value=!0,this.isFocusedProperty.value=!0,this.isPressedProperty.value=!0,this._pressListener(e,this),t&&t(),this.isPressedProperty.value=!1,this._releaseListener(e,this),Oe.clearTimeout(this._pdomClickingTimeoutListener),this._pdomClickingTimeoutListener=Oe.setTimeout(()=>{this.pdomClickingProperty.isDisposed||(this.pdomClickingProperty.value=!1)},this._a11yLooksPressedInterval)),!0}focus(e){const t=e.trail.rootNode().getRootedDisplays().filter(s=>s.isAccessible());assert&&assert(t.length===1,"cannot focus node with zero or multiple accessible displays attached"),this.display=t[0],this.display.focusManager.pdomFocusHighlightsVisibleProperty.hasListener(this.boundInvalidateOverListener)||this.display.focusManager.pdomFocusHighlightsVisibleProperty.link(this.boundInvalidateOverListener),this.isFocusedProperty.value=!0}blur(){this.display&&(this.display.focusManager.pdomFocusHighlightsVisibleProperty.hasListener(this.boundInvalidateOverListener)&&this.display.focusManager.pdomFocusHighlightsVisibleProperty.unlink(this.boundInvalidateOverListener),this.display=null),this.isFocusedProperty.value=!1}dispose(){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener(`PressListener#${this._id} dispose`),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.overPointers.clear(),this._listeningToPointer&&Df(this)&&this.pointer.removeInputListener(this._pointerListener),this.isPressedProperty.isDisposed||(this.isPressedProperty.unlink(this._isHighlightedListener),this.isPressedProperty.unlink(this._isHoveringListener)),!this.isHoveringProperty.isDisposed&&this.isHoveringProperty.unlink(this._isHighlightedListener),this._pressAction.dispose(),this._releaseAction.dispose(),this.looksPressedProperty.dispose(),this.pdomClickingProperty.dispose(),this.cursorProperty.dispose(),this.isFocusedProperty.dispose(),this.isHighlightedProperty.dispose(),this.isHoveringProperty.dispose(),this.looksOverProperty.dispose(),this.isOverProperty.dispose(),this.isPressedProperty.dispose(),this.overPointers.dispose(),this.display&&(this.display.focusManager.pdomFocusHighlightsVisibleProperty.unlink(this.boundInvalidateOverListener),this.display=null),super.dispose(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}};qh.phetioAPI={pressAction:{phetioType:q.PhetioActionIO([Ue.SceneryEventIO])},releaseAction:{phetioType:q.PhetioActionIO([V(Ue.SceneryEventIO)])}};let jt=qh;d.register("PressListener",jt);class Do extends jt{constructor(e){const t=E()({fire:_.noop,fireOnDown:!1,fireOnHold:!1,fireOnHoldDelay:400,fireOnHoldInterval:100,tandem:se.REQUIRED,phetioReadOnly:_e.DEFAULT_OPTIONS.phetioReadOnly},e);assert&&assert(typeof t.fire=="function","The fire callback should be a function"),assert&&assert(typeof t.fireOnDown=="boolean","fireOnDown should be a boolean"),super(t),this._fireOnDown=t.fireOnDown,this.firedEmitter=new He({tandem:t.tandem.createTandem("firedEmitter"),phetioEventType:Z.USER,phetioReadOnly:t.phetioReadOnly,phetioDocumentation:"Emits at the time that the listener fires",parameters:[{name:"event",phetioType:V(Ue.SceneryEventIO)}]}),this.firedEmitter.addListener(t.fire),t.fireOnHold&&(this._timer=new Qr({callback:this.fire.bind(this,null),delay:t.fireOnHoldDelay,interval:t.fireOnHoldInterval}))}fire(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("FireListener fire"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.firedEmitter.emit(e),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}press(e,t,s){return super.press(e,t,()=>{this._fireOnDown&&this.fire(e),this._timer&&this._timer.start(),s&&s()})}release(e,t){super.release(e,()=>{const s=!this._fireOnDown&&this.isHoveringProperty.value&&!this.interrupted;this._timer?this._timer.stop(s):s&&this.fire(e||null),t&&t()})}click(e,t){return super.click(e,()=>{this.interrupted||this.fire(e),t&&t()})}interrupt(){super.interrupt(),this._timer&&this._timer.stop(!1)}dispose(){this.firedEmitter.dispose(),this._timer&&this._timer.dispose(),super.dispose()}}d.register("FireListener",Do);const Ba=new T(0,0),ts=r=>r.isPressed;class Tf extends jt{constructor(e){const t=E()({positionProperty:null,start:null,end:null,transform:null,dragBoundsProperty:null,allowTouchSnag:!0,applyOffset:!0,useParentOffset:!1,trackAncestors:!1,translateNode:!1,mapPosition:null,offsetPosition:null,canClick:!1,tandem:se.REQUIRED,phetioReadOnly:!0,phetioFeatured:_e.DEFAULT_OPTIONS.phetioFeatured},e);assert&&assert(!t.dragBounds,"options.dragBounds was removed in favor of options.dragBoundsProperty"),assert&&assert(!t.useParentOffset||t.positionProperty,"If useParentOffset is set, a positionProperty is required"),assert&&assert(!(t.mapPosition&&t.dragBoundsProperty),"Only one of mapPosition and dragBoundsProperty can be provided, as they handle mapping of the drag point"),super(t),this._allowTouchSnag=t.allowTouchSnag,this._applyOffset=t.applyOffset,this._useParentOffset=t.useParentOffset,this._trackAncestors=t.trackAncestors,this._translateNode=t.translateNode,this._transform=t.transform,this._positionProperty=t.positionProperty,this._mapPosition=t.mapPosition,this._offsetPosition=t.offsetPosition,this._dragBoundsProperty=t.dragBoundsProperty||new me(null),this._start=t.start,this._end=t.end,this._canClick=t.canClick,this.isUserControlledProperty=this.isPressedProperty,this._globalPoint=new T(0,0),this._localPoint=new T(0,0),this._parentPoint=new T(0,0),this._modelPoint=new T(0,0),this._modelDelta=new T(0,0),this._parentOffset=new T(0,0),this._transformTracker=null,this._transformTrackerListener=this.ancestorTransformed.bind(this),this._lastInterruptedTouchLikePointer=null,this._dragAction=new q(s=>{assert&&assert(ts(this));const n=this.pointer.point;n&&(this._globalPoint.equals(n)||this.reposition(n)),jt.prototype.drag.call(this,s)},{parameters:[{name:"event",phetioType:Ue.SceneryEventIO}],phetioFeatured:t.phetioFeatured,tandem:t.tandem.createTandem("dragAction"),phetioHighFrequency:!0,phetioDocumentation:"Emits whenever a drag occurs with an SceneryEventIO argument.",phetioReadOnly:t.phetioReadOnly,phetioEventType:Z.USER})}press(e,t,s){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener press"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const i=super.press(e,t,()=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener successful press"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),assert&&assert(ts(this));const n=this;n.pointer.reserveForDrag(),this.attachTransformTracker(),assert&&assert(n.pointer.point!==null);const a=n.pointer.point,o=this.globalToParentPoint(this._localPoint.set(a));this._useParentOffset&&this.modelToParentPoint(this._parentOffset.set(this._positionProperty.value)).subtract(o),this.parentToLocalPoint(o),this.reposition(a),this._start&&this._start(e,n),s&&s(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()});return sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop(),i}release(e,t){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener release"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),super.release(e,()=>{this.detachTransformTracker(),this._end&&this._end(e||null,this),t&&t()}),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}canClick(){return super.canClick()&&this._canClick}click(e,t){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener click"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const s=super.click(e,()=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener successful press"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this._start&&this._start(e,this),t&&t(),this._end&&this._end(e,this),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()});return sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop(),s}drag(e){assert&&assert(ts(this));const s=this.pointer.point;!s||this._globalPoint.equals(s)||(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener drag"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this._dragAction.execute(e),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop())}tryTouchSnag(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener tryTouchSnag"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this._allowTouchSnag&&(!this.attach||!e.pointer.isAttached())&&this.press(e),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}getGlobalPoint(){return this._globalPoint.copy()}get globalPoint(){return this.getGlobalPoint()}getLocalPoint(){return this._localPoint.copy()}get localPoint(){return this.getLocalPoint()}getParentPoint(){return this._parentPoint.copy()}get parentPoint(){return this.getParentPoint()}getModelPoint(){return this._modelPoint.copy()}get modelPoint(){return this.getModelPoint()}getModelDelta(){return this._modelDelta.copy()}get modelDelta(){return this.getModelDelta()}globalToParentPoint(e){assert&&assert(ts(this));const t=this;let s;return assert&&(s=t.pressedTrail.globalToParentPoint(e)),t.pressedTrail.getParentTransform().getInverse().multiplyVector2(e),assert&&assert(e.equals(s)),e}parentToLocalPoint(e){assert&&assert(ts(this));const t=this;let s;return assert&&(s=t.pressedTrail.lastNode().parentToLocalPoint(e)),t.pressedTrail.lastNode().getTransform().getInverse().multiplyVector2(e),assert&&assert(e.equals(s)),e}localToParentPoint(e){assert&&assert(ts(this));const t=this;let s;return assert&&(s=t.pressedTrail.lastNode().localToParentPoint(e)),t.pressedTrail.lastNode().getMatrix().multiplyVector2(e),assert&&assert(e.equals(s)),e}parentToModelPoint(e){return this._transform&&(this._transform instanceof Bt?this._transform:this._transform.value).getInverse().multiplyVector2(e),e}modelToParentPoint(e){return this._transform&&(this._transform instanceof Bt?this._transform:this._transform.value).getMatrix().multiplyVector2(e),e}mapModelPoint(e){return this._mapPosition?this._mapPosition(e):this._dragBoundsProperty.value?this._dragBoundsProperty.value.closestPointTo(e):e}applyParentOffset(e){this._offsetPosition&&e.add(this._offsetPosition(e,this)),this._applyOffset&&(this._useParentOffset?e.add(this._parentOffset):(e.subtract(this.localToParentPoint(Ba.set(this._localPoint))),e.add(this.localToParentPoint(Ba.setXY(0,0)))))}reposition(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener reposition"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),assert&&assert(ts(this));const t=this;this._globalPoint.set(e),this.applyParentOffset(this.globalToParentPoint(this._parentPoint.set(e))),this._modelDelta.set(this._modelPoint).negate(),this._modelPoint.set(this.mapModelPoint(this.parentToModelPoint(Ba.set(this._parentPoint)))),this._modelDelta.add(this._modelPoint),this.modelToParentPoint(this._parentPoint.set(this._modelPoint)),this._translateNode&&(t.pressedTrail.lastNode().translation=this._parentPoint),this._positionProperty&&(this._positionProperty.value=this._modelPoint.copy()),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}touchenter(e){e.pointer.isDownProperty.value&&this.tryTouchSnag(e)}touchmove(e){this.tryTouchSnag(e)}ancestorTransformed(){assert&&assert(ts(this));const t=this.pointer.point;t&&this.reposition(t)}attachTransformTracker(){assert&&assert(ts(this));const e=this;this._trackAncestors&&(this._transformTracker=new Js(e.pressedTrail.copy().removeDescendant()),this._transformTracker.addListener(this._transformTrackerListener))}detachTransformTracker(){this._transformTracker&&(this._transformTracker.removeListener(this._transformTrackerListener),this._transformTracker.dispose(),this._transformTracker=null)}getDragBounds(){return this._dragBoundsProperty.value}get dragBounds(){return this.getDragBounds()}setTransform(e){this._transform=e}set transform(e){this.setTransform(e)}get transform(){return this.getTransform()}getTransform(){return this._transform}interrupt(){this.pointer&&this.pointer.isTouchLike()&&(this._lastInterruptedTouchLikePointer=this.pointer),super.interrupt()}canPress(e){return e.pointer===this._lastInterruptedTouchLikePointer?!1:super.canPress(e)}dispose(){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("DragListener dispose"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this._dragAction.dispose(),this.detachTransformTracker(),super.dispose(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}static createForwardingListener(e,t){const s=E()({allowTouchSnag:!0},t);return{down(i){i.canStartPress()&&e(i)},touchenter(i){s.allowTouchSnag&&this.down(i)},touchmove(i){s.allowTouchSnag&&this.down(i)}}}}d.register("DragListener",Tf);class Su{constructor(e,t){this.pointer=e,this.trail=t,this.interrupted=!1,this.initialPoint=e.point,this.localPoint=null,this.recomputeLocalPoint()}recomputeLocalPoint(){this.localPoint=this.trail.globalToLocalPoint(this.pointer.point)}get targetPoint(){return this.trail.globalToParentPoint(this.pointer.point)}}d.register("MultiListenerPress",Su);const Cf=25;class wu{constructor(e,t){const s=E()({mouseButton:0,pressCursor:"pointer",allowScale:!0,allowRotation:!0,allowMultitouchInterruption:!1,allowMoveInterruption:!0,minScale:1,maxScale:4,tandem:se.REQUIRED},t);this._targetNode=e,this._minScale=s.minScale,this._maxScale=s.maxScale,this._mouseButton=s.mouseButton,this._pressCursor=s.pressCursor,this._allowScale=s.allowScale,this._allowRotation=s.allowRotation,this._allowMultitouchInterruption=s.allowMultitouchInterruption,this._allowMoveInterruption=s.allowMoveInterruption,this._presses=[],this._backgroundPresses=[],this.matrixProperty=new me(e.matrix.copy(),{phetioValueType:C.Matrix3IO,tandem:s.tandem.createTandem("matrixProperty"),phetioReadOnly:!0}),this.matrixProperty.link(i=>{this._targetNode.matrix=i}),this._interrupted=!1,this._pressListener={move:i=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener pointer move"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const n=this.findPress(i.pointer);assert&&assert(n,"Press should be found for move event"),this.movePress(n),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},up:i=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener pointer up"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const n=this.findPress(i.pointer);assert&&assert(n,"Press should be found for up event"),this.removePress(n),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},cancel:i=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener pointer cancel"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const n=this.findPress(i.pointer);assert&&assert(n,"Press should be found for cancel event"),n.interrupted=!0,this.removePress(n),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},interrupt:()=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener pointer interrupt"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.interrupt(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}},this._backgroundListener={up:i=>{if(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener background up"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),!this._interrupted){const n=this.findBackgroundPress(i.pointer);assert&&assert(n,"Background press should be found for up event"),this.removeBackgroundPress(n)}sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},move:i=>{const n=this._backgroundPresses.filter(a=>!a.pointer.hasIntent(Ne.DRAG)&&a.initialPoint.distance(a.pointer.point)>Cf);(this.getCurrentScale()!==1||n.length>=2)&&(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener attached, interrupting for press"),n.forEach(a=>{this.removeBackgroundPress(a),this.interruptOtherListeners(a.pointer),this.addPress(a)}))},cancel:i=>{if(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener background cancel"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),!this._interrupted){const n=this.findBackgroundPress(i.pointer);assert&&assert(n,"Background press should be found for cancel event"),this.removeBackgroundPress(n)}sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()},interrupt:()=>{sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener background interrupt"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.interrupt(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}}}findPress(e){for(let t=0;t<this._presses.length;t++)if(this._presses[t].pointer===e)return this._presses[t];return null}findBackgroundPress(e){for(let t=0;t<this._backgroundPresses.length;t++)if(this._backgroundPresses[t].pointer===e)return this._backgroundPresses[t];return null}hasPress(e){return _.some(this._presses.concat(this._backgroundPresses),t=>t.pointer===e.pointer)}interruptOtherListeners(e){const t=e.getListeners();for(let s=0;s<t.length;s++){const i=t[s];i!==this._backgroundListener&&i.interrupt&&i.interrupt()}}down(e){if(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener down"),e.pointer instanceof lt&&e.domEvent instanceof MouseEvent&&e.domEvent.button!==this._mouseButton){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener abort: wrong mouse button");return}this._interrupted=!1;let t;_.includes(e.trail.nodes,this._targetNode)?t=e.trail.subtrailTo(this._targetNode,!1):t=this._targetNode.getUniqueTrailTo(e.target),assert&&assert(_.includes(t.nodes,this._targetNode),"targetNode must be in the Trail for Press"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const s=new Su(e.pointer,t);!this._allowMoveInterruption&&!this._allowMultitouchInterruption?e.pointer.isAttached()||(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener unattached, using press"),this.addPress(s)):(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener attached, adding background press"),this.addBackgroundPress(s)),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}addPress(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener addPress"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.hasPress(e)||(this._presses.push(e),e.pointer.cursor=this._pressCursor,e.pointer.addInputListener(this._pressListener,!0),this.recomputeLocals(),this.reposition()),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}movePress(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener movePress"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.reposition(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}removePress(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener removePress"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),e.pointer.removeInputListener(this._pressListener),e.pointer.cursor=null,Tt(this._presses,e),this.recomputeLocals(),this.reposition(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}addBackgroundPress(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener addBackgroundPress"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.hasPress(e)||(this._backgroundPresses.push(e),e.pointer.addInputListener(this._backgroundListener,!1)),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}removeBackgroundPress(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener removeBackgroundPress"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),e.pointer.removeInputListener(this._backgroundListener),Tt(this._backgroundPresses,e),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}reposition(){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener reposition"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),this.matrixProperty.set(this.computeMatrix()),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}recomputeLocals(){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener recomputeLocals"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();for(let e=0;e<this._presses.length;e++)this._presses[e].recomputeLocalPoint();sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}interrupt(){for(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener interrupt"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();this._presses.length;)this.removePress(this._presses[this._presses.length-1]);for(;this._backgroundPresses.length;)this.removeBackgroundPress(this._backgroundPresses[this._backgroundPresses.length-1]);this._interrupted=!0,sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}computeMatrix(){return this._presses.length===0?this._targetNode.getMatrix():this._presses.length===1?this.computeSinglePressMatrix():this._allowScale&&this._allowRotation?this.computeTranslationRotationScaleMatrix():this._allowScale?this.computeTranslationScaleMatrix():this._allowRotation?this.computeTranslationRotationMatrix():this.computeTranslationMatrix()}computeSinglePressMatrix(){const e=this._presses[0].targetPoint,t=this._presses[0].localPoint;assert&&assert(t,"localPoint is not defined on the Press?");const s=this._targetNode.localToParentPoint(t),i=e.minus(s);return C.translationFromVector(i).timesMatrix(this._targetNode.getMatrix())}computeTranslationMatrix(){const e=new T(0,0);for(let t=0;t<this._presses.length;t++){e.add(this._presses[t].targetPoint);const s=this._presses[t].localPoint;assert&&assert(s,"localPoint is not defined on the Press?"),e.subtract(s)}return C.translationFromVector(e.dividedScalar(this._presses.length))}computeTranslationScaleMatrix(){const e=this._presses.map(c=>(assert&&assert(c.localPoint,"localPoint is not defined on the Press?"),c.localPoint)),t=this._presses.map(c=>c.targetPoint),s=new T(0,0),i=new T(0,0);e.forEach(c=>{s.add(c)}),t.forEach(c=>{i.add(c)}),s.divideScalar(this._presses.length),i.divideScalar(this._presses.length);let n=0,a=0;e.forEach(c=>{n+=c.distanceSquared(s)}),t.forEach(c=>{a+=c.distanceSquared(i)});let o=this.getCurrentScale();a!==0&&(o=this.limitScale(Math.sqrt(a/n)));const h=C.translation(i.x,i.y),l=C.translation(-s.x,-s.y);return h.timesMatrix(C.scaling(o)).timesMatrix(l)}limitScale(e){let t=Math.max(e,this._minScale);return t=Math.min(t,this._maxScale),t}computeTranslationRotationMatrix(){let e;const t=new Gi(2,this._presses.length),s=new Gi(2,this._presses.length),i=new T(0,0),n=new T(0,0);for(e=0;e<this._presses.length;e++){const u=this._presses[e].localPoint,m=this._presses[e].targetPoint;i.add(u),n.add(m),t.set(0,e,u.x),t.set(1,e,u.y),s.set(0,e,m.x),s.set(1,e,m.y)}for(i.divideScalar(this._presses.length),n.divideScalar(this._presses.length),e=0;e<this._presses.length;e++)t.set(0,e,t.get(0,e)-i.x),t.set(1,e,t.get(1,e)-i.y),s.set(0,e,s.get(0,e)-n.x),s.set(1,e,s.get(1,e)-n.y);const a=t.times(s.transpose()),o=new tl(a);let h=o.getV().times(o.getU().transpose());h.det()<0&&(h=o.getV().times(Gi.diagonalMatrix([1,-1])).times(o.getU().transpose()));const l=new C().rowMajor(h.get(0,0),h.get(0,1),0,h.get(1,0),h.get(1,1),0,0,0,1),c=n.minus(l.timesVector2(i));return l.set02(c.x),l.set12(c.y),l}computeTranslationRotationScaleMatrix(){let e;const t=new Gi(this._presses.length*2,4);for(e=0;e<this._presses.length;e++){const l=this._presses[e].localPoint;t.set(2*e+0,0,l.x),t.set(2*e+0,1,l.y),t.set(2*e+0,2,1),t.set(2*e+1,0,l.y),t.set(2*e+1,1,-l.x),t.set(2*e+1,3,1)}const s=new Gi(this._presses.length*2,1);for(e=0;e<this._presses.length;e++){const l=this._presses[e].targetPoint;s.set(2*e+0,0,l.x),s.set(2*e+1,0,l.y)}const i=tl.pseudoinverse(t).times(s),n=i.get(0,0),a=i.get(1,0),o=i.get(2,0),h=i.get(3,0);return new C().rowMajor(n,a,o,-a,n,h,0,0,1)}getCurrentScale(){return this._targetNode.getScaleVector().x}resetTransform(){this._targetNode.resetTransform(),this.matrixProperty.set(this._targetNode.matrix.copy())}}d.register("MultiListener",wu);class xt extends Bt{modelToViewPosition(e){return this.transformPosition2(e)}modelToViewXY(e,t){return new T(this.modelToViewX(e),this.modelToViewY(t))}modelToViewX(e){return this.matrix.m00()*e+this.matrix.m02()}modelToViewY(e){return this.matrix.m11()*e+this.matrix.m12()}modelToViewDelta(e){return this.transformDelta2(e)}modelToViewNormal(e){return this.transformNormal2(e)}modelToViewDeltaX(e){return this.transformDeltaX(e)}modelToViewDeltaY(e){return this.transformDeltaY(e)}modelToViewBounds(e){return this.transformBounds2(e)}modelToViewShape(e){return this.transformShape(e)}modelToViewRay(e){return this.transformRay2(e)}viewToModelPosition(e){return this.inversePosition2(e)}viewToModelXY(e,t){return new T(this.viewToModelX(e),this.viewToModelY(t))}viewToModelX(e){const t=this.getInverse();return t.m00()*e+t.m02()}viewToModelY(e){const t=this.getInverse();return t.m11()*e+t.m12()}viewToModelDelta(e){return this.inverseDelta2(e)}viewToModelDeltaXY(e,t){return new T(this.viewToModelDeltaX(e),this.viewToModelDeltaY(t))}viewToModelNormal(e){return this.inverseNormal2(e)}viewToModelDeltaX(e){return this.inverseDeltaX(e)}viewToModelDeltaY(e){return this.inverseDeltaY(e)}viewToModelBounds(e){return this.inverseBounds2(e)}viewToModelShape(e){return this.inverseShape(e)}viewToModelRay(e){return this.inverseRay2(e)}validateMatrix(e){super.validateMatrix(e),assert&&assert(e.isAligned(),"matrix must be aligned, ModelViewTransform2 does not support arbitrary rotations")}setToRectangleMapping(e,t){const s=t.width/e.width,i=t.x-s*e.x,n=t.height/e.height,a=t.y-n*e.y;return this.setMatrix(C.affine(s,0,i,0,n,a)),this}setToRectangleInvertedYMapping(e,t){const s=t.width/e.width,i=t.x-s*e.x,n=-t.height/e.height,a=t.y-n*e.getMaxY();return this.setMatrix(C.affine(s,0,i,0,n,a)),this}static createIdentity(){return new xt(C.IDENTITY)}static createOffsetScaleMapping(e,t){return new xt(C.affine(t,0,e.x,0,t,e.y))}static createOffsetXYScaleMapping(e,t,s){return new xt(C.affine(t,0,e.x,0,s,e.y))}static createSinglePointXYScaleMapping(e,t,s,i){const n=t.x-e.x*s,a=t.y-e.y*i;return xt.createOffsetXYScaleMapping(new T(n,a),s,i)}static createSinglePointScaleMapping(e,t,s){return xt.createSinglePointXYScaleMapping(e,t,s,s)}static createSinglePointScaleInvertedYMapping(e,t,s){return xt.createSinglePointXYScaleMapping(e,t,s,-s)}static createRectangleMapping(e,t){return new xt().setToRectangleMapping(e,t)}static createRectangleInvertedYMapping(e,t){return new xt().setToRectangleInvertedYMapping(e,t)}}ru.register("ModelViewTransform2",xt);const dc=new C;class Du extends wu{constructor(e,t){var i;const s=E()({panBounds:w.NOTHING,targetBounds:null,targetScale:1,allowRotation:!1},t);super(e,s),this._panBounds=s.panBounds,this._targetBounds=s.targetBounds||e.globalBounds.copy(),this._targetScale=s.targetScale,this.sourceFramePanBoundsProperty=new me(se.API_GENERATION?new w(0,0,0,0):this._panBounds,{tandem:(i=s.tandem)==null?void 0:i.createTandem("sourceFramePanBoundsProperty"),phetioReadOnly:!0,phetioValueType:w.Bounds2IO}),this.sourceFramePanBoundsProperty.lazyLink(()=>{if(ki.value){const n=xt.createRectangleMapping(this.sourceFramePanBoundsProperty.get(),this._panBounds),a=this._targetNode.matrix.translation.componentMultiply(n.matrix.getScaleVector()),o=this.matrixProperty.get().getScaleVector();this.matrixProperty.set(C.translationFromVector(a).timesMatrix(C.scaling(o.x,o.y)))}},{phetioDependencies:[this.matrixProperty]})}correctReposition(){dc.set(this._targetNode.matrix);const e=this._targetBounds.transformed(this._targetNode.getMatrix());e.left>this._panBounds.left&&(this._targetNode.left=this._panBounds.left-(e.left-this._targetNode.left)),e.top>this._panBounds.top&&(this._targetNode.top=this._panBounds.top-(e.top-this._targetNode.top)),e.right<this._panBounds.right&&(this._targetNode.right=this._panBounds.right+(this._targetNode.right-e.right)),e.bottom<this._panBounds.bottom&&(this._targetNode.bottom=this._panBounds.bottom+(this._targetNode.bottom-e.bottom)),dc.equals(this._targetNode.matrix)||this.matrixProperty.set(this._targetNode.matrix.copy())}addPress(e){super.addPress(e);const s=this._targetBounds.transformed(this._targetNode.getMatrix()).equalsEpsilon(this._panBounds,1e-8);e.pointer.cursor=s?null:this._pressCursor}reposition(){super.reposition(),this.correctReposition()}resetTransform(){super.resetTransform(),this.correctReposition()}setPanBounds(e){this._panBounds=e,se.API_GENERATION||this.sourceFramePanBoundsProperty.set(this._panBounds),this.correctReposition()}setTargetBounds(e){this._targetBounds=e,this.correctReposition()}setTargetScale(e){this._targetScale=e}getTargetBounds(){return this._targetBounds}}d.register("PanZoomListener",Du);const uc="all-scroll",If=150,Ef=1e3,pn=new T(0,0),Ji=new T(0,0),pc=new T(0,0),gc=new w(0,0,0,0);class Tu extends Du{constructor(e,t){const s=E()({tandem:se.REQUIRED},t);super(e,s),this.trackpadGestureStartScale=1,this.animatingProperty=new ie(!1),this._transformTracker=null,this._focusBoundsListener=null,this.sourcePosition=null,this.destinationPosition=null,this.sourceScale=this.getCurrentScale(),this.destinationScale=this.getCurrentScale(),this.scaleGestureTargetPosition=null,this.discreteScales=xf(this._minScale,this._maxScale),this.middlePress=null,this._dragBounds=null,this._transformedPanBounds=this._panBounds.transformed(this._targetNode.matrix.inverted()),this._draggingInDragBounds=!1,this._attachedPointers=[],this.boundsFinite=!1;let i=null,n=null;this.gestureStartAction=new q(o=>{assert&&assert(o.pageX,"pageX required on DOMEvent"),assert&&assert(o.pageY,"pageY required on DOMEvent"),assert&&assert(o.scale,"scale required on DOMEvent"),o.preventDefault(),this.trackpadGestureStartScale=o.scale,this.scaleGestureTargetPosition=new T(o.pageX,o.pageY)},{phetioPlayback:!0,tandem:s.tandem.createTandem("gestureStartAction"),parameters:[{name:"event",phetioType:xs}],phetioEventType:Z.USER,phetioDocumentation:"Action that executes whenever a gesture starts on a trackpad in macOS Safari."}),this.gestureChangeAction=new q(o=>{assert&&assert(o.scale,"scale required on DOMEvent"),o.preventDefault();const h=this.sourceScale+o.scale-this.trackpadGestureStartScale;this.setDestinationScale(h)},{phetioPlayback:!0,tandem:s.tandem.createTandem("gestureChangeAction"),parameters:[{name:"event",phetioType:xs}],phetioEventType:Z.USER,phetioDocumentation:"Action that executes whenever a gesture changes on a trackpad in macOS Safari."}),Te.safari&&!Te.mobileSafari&&(i=this.handleGestureStartEvent.bind(this),n=this.handleGestureChangeEvent.bind(this),this.trackpadGestureStartScale=this.getCurrentScale(),window.addEventListener("gesturestart",i),window.addEventListener("gesturechange",n)),ze.keydownEmitter.addListener(this.windowKeydown.bind(this));const a=this.handleFocusChange.bind(this);oe.pdomFocusProperty.link(a),this.sourceFramePanBoundsProperty.lazyLink(()=>{ki.value&&(this.initializePositions(),this.sourceScale=this.getCurrentScale(),this.setDestinationScale(this.sourceScale))},{phetioDependencies:[this.matrixProperty]}),this.disposeAnimatedPanZoomListener=()=>{i&&window.removeEventListener("gesturestart",i),n&&window.removeEventListener("gestureChange",n),this.animatingProperty.dispose(),this._transformTracker&&this._transformTracker.dispose(),oe.pdomFocusProperty.unlink(a)}}step(e){this.middlePress&&this.handleMiddlePress(e),this._attachedPointers.length>0&&this.getCurrentScale()>1&&(this._attachedPointers.length>0&&(this._attachedPointers=this._attachedPointers.filter(t=>t.attachedListener),assert&&assert(this._attachedPointers.length<=10,"Not clearing attachedPointers, there is probably a memory leak")),(this._draggingInDragBounds||this._attachedPointers.some(t=>t instanceof Mi))&&this.repositionDuringDrag()),this.animateToTargets(e)}down(e){super.down(e),this._dragBounds!==null&&e.pointer.hasIntent(Ne.DRAG)&&(this._attachedPointers.length===0&&(this._draggingInDragBounds=this._dragBounds.containsPoint(e.pointer.point)),e.pointer.attachedListener&&(this._attachedPointers.includes(e.pointer)||this._attachedPointers.push(e.pointer))),e.pointer.type==="mouse"&&e.pointer instanceof lt&&e.pointer.middleDown&&!this.middlePress?(this.middlePress=new Af(e.pointer,e.trail),e.pointer.cursor=uc):this.cancelMiddlePress()}cancelMiddlePress(){this.middlePress&&(this.middlePress.pointer.cursor=null,this.middlePress=null,this.stopInProgressAnimation())}movePress(e){this.middlePress||super.movePress(e)}move(e){if(this._attachedPointers.length>0&&this.getCurrentScale()>1)if(this._draggingInDragBounds){if(!this._attachedPointers.includes(e.pointer)){const t=this.hasDragIntent(e.pointer);e.currentTarget!==null&&t&&e.pointer.attachedListener&&this._attachedPointers.push(e.pointer)}}else this._dragBounds&&(this._draggingInDragBounds=this._dragBounds.containsPoint(e.pointer.point))}getTargetNodeDuringDrag(){if(this._attachedPointers.length>0){const e=this._attachedPointers[0].attachedListener;if(assert&&assert(e,"The attached Pointer is expected to have an attached listener."),e.listener instanceof jt||e.listener instanceof mc){const t=e.listener;if(t.isPressed)return t.getCurrentTarget()}}return null}getGlobalBoundsToViewDuringDrag(){let e=null;if(this._attachedPointers.length>0){const t=this._attachedPointers[0].attachedListener;if(assert&&assert(t,"The attached Pointer is expected to have an attached listener."),t.createPanTargetBounds)e=t.createPanTargetBounds();else if(t.listener instanceof jt||t.listener instanceof mc){const s=t.listener;if(s.isPressed){const i=s.getCurrentTarget();if(i.instances.length===1){const n=i.instances[0].trail;assert&&assert(n,"The target should be in one scene graph and have an instance with a trail."),e=n.parentToGlobalBounds(i.visibleBounds)}}}}return e}repositionDuringDrag(){const e=this.getGlobalBoundsToViewDuringDrag(),t=this.getTargetNodeDuringDrag();e&&this.keepBoundsInView(e,this._attachedPointers.some(s=>s instanceof Mi),t==null?void 0:t.limitPanDirection)}cancelPanningDuringDrag(e){if(e){const t=this._attachedPointers.indexOf(e.pointer);t>-1&&this._attachedPointers.splice(t,1)}else this._attachedPointers=[];this._draggingInDragBounds=!1}up(e){this.cancelPanningDuringDrag(e)}wheel(e){if(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener wheel"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),!this.middlePress){const t=new kf(e,this._targetScale);this.repositionFromWheel(t,e)}sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}windowKeydown(e){this.cancelMiddlePress();const t=_.get(window,"phet.joist.sim",null);if((!t||!t.display._accessible||!t.display.pdomRootElement.contains(e.target))&&(this.handleZoomCommands(e),g.isArrowKey(e))){const s=new Fa(ze,this.getCurrentScale(),this._targetScale);this.repositionFromKeys(s)}}keydown(e){const t=e.domEvent;assert&&assert(t instanceof KeyboardEvent,"keydown event must be a KeyboardEvent"),this.cancelMiddlePress(),this.handleZoomCommands(t);const s=e.pointer.hasIntent(Ne.KEYBOARD_DRAG);if(g.isArrowKey(t)&&!s){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener handle arrow key down"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const i=new Fa(ze,this.getCurrentScale(),this._targetScale);this.repositionFromKeys(i),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}}handleFocusChange(e,t){if(this._transformTracker&&(this._transformTracker.dispose(),this._transformTracker=null),t&&t.trail.lastNode()&&t.trail.lastNode().focusPanTargetBoundsProperty){const s=t.trail.lastNode().focusPanTargetBoundsProperty;assert&&assert(this._focusBoundsListener&&s.hasListener(this._focusBoundsListener),"Focus bounds listener should be linked to the previous Node"),s.unlink(this._focusBoundsListener),this._focusBoundsListener=null}if(e){const s=e.trail.lastNode();let i=e.trail;if(e.trail.containsNode(this._targetNode)){const a=e.trail.nodes.indexOf(this._targetNode),o=e.trail.nodes.length;i=e.trail.slice(a,o)}this._transformTracker=new Js(i);const n=()=>{if(this.getCurrentScale()>1){let a;if(s.focusPanTargetBoundsProperty){const o=s.focusPanTargetBoundsProperty.value;a=e.trail.localToGlobalBounds(o)}else a=e.trail.localToGlobalBounds(e.trail.lastNode().localBounds);this.keepBoundsInView(a,!0,s.limitPanDirection)}};this._transformTracker.addListener(n),s.focusPanTargetBoundsProperty&&(this._focusBoundsListener=n,s.focusPanTargetBoundsProperty.link(this._focusBoundsListener)),this.keepTrailInView(e.trail,s.limitPanDirection)}}handleZoomCommands(e){const t=ei.isZoomCommand(e,!0),s=ei.isZoomCommand(e,!1);if(t||s){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiPanZoomListener keyboard zoom in"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),e.preventDefault();const i=this.getNextDiscreteScale(t),n=new Fa(ze,i,this._targetScale);this.repositionFromKeys(n)}else ei.isZoomResetCommand(e)&&(sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener keyboard reset"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push(),e.preventDefault(),this.resetTransform(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop())}handleGestureStartEvent(e){this.gestureStartAction.execute(e)}handleGestureChangeEvent(e){this.gestureChangeAction.execute(e)}handleMiddlePress(e){const t=this.middlePress;assert&&assert(t,"MiddlePress must be defined to handle");const s=this.sourcePosition;if(assert&&assert(s,"sourcePosition must be defined to handle middle press, be sure to call initializePositions"),e>0){const n=t.pointer.point.minus(t.initialPoint),a=n.magnitude/100;a>0&&(n.setMagnitude(Math.min(a/e,If*this._targetScale)),this.setDestinationPosition(s.plus(n)))}}translateScaleToTarget(e,t){const s=this._targetNode.globalToLocalPoint(e),i=this._targetNode.globalToParentPoint(e),n=C.translation(-s.x,-s.y),a=C.translation(i.x,i.y),o=this.limitScale(this.getCurrentScale()+t),h=a.timesMatrix(C.scaling(o)).timesMatrix(n);this.matrixProperty.set(h),this.correctReposition()}setTranslationScaleToTarget(e,t){const s=this._targetNode.globalToLocalPoint(e),i=this._targetNode.globalToParentPoint(e),n=C.translation(-s.x,-s.y),a=C.translation(i.x,i.y),o=this.limitScale(t),h=a.timesMatrix(C.scaling(o)).timesMatrix(n);this.matrixProperty.set(h),this.correctReposition()}translateDelta(e){const t=this._targetNode.globalToParentPoint(this._panBounds.center),s=t.plus(e);this.translateToTarget(s,t)}translateToTarget(e,t){const s=this._targetNode.globalToParentPoint(e),n=this._targetNode.globalToParentPoint(t).minus(s);this.matrixProperty.set(C.translationFromVector(n).timesMatrix(this._targetNode.getMatrix())),this.correctReposition()}repositionFromKeys(e){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener reposition from key press"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const t=this.sourcePosition;assert&&assert(t,"sourcePosition must be defined to handle key press, be sure to call initializePositions");const s=e.scale,i=this.getCurrentScale();s!==i?(this.setDestinationScale(s),this.scaleGestureTargetPosition=e.computeScaleTargetFromKeyPress()):e.translationVector.equals(T.ZERO)||this.setDestinationPosition(t.plus(e.translationVector)),this.correctReposition(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}repositionFromWheel(e,t){sceneryLog&&sceneryLog.InputListener&&sceneryLog.InputListener("MultiListener reposition from wheel"),sceneryLog&&sceneryLog.InputListener&&sceneryLog.push();const s=t.domEvent;assert&&assert(s instanceof WheelEvent,"wheel event must be a WheelEvent");const i=this.sourcePosition;if(assert&&assert(i,"sourcePosition must be defined to handle wheel, be sure to call initializePositions"),s.preventDefault(),e.isCtrlKeyDown){const n=this.limitScale(this.getCurrentScale()+e.scaleDelta);this.scaleGestureTargetPosition=e.targetPoint,this.setDestinationScale(n)}else this.setDestinationPosition(i.plus(e.translationVector));this.correctReposition(),sceneryLog&&sceneryLog.InputListener&&sceneryLog.pop()}correctReposition(){super.correctReposition(),this._panBounds.isFinite()&&(this._transformedPanBounds=this._panBounds.transformed(this._targetNode.matrix.inverted()),this.sourcePosition=this._transformedPanBounds.center,this.sourceScale=this.getCurrentScale())}addPress(e){super.addPress(e),this.stopInProgressAnimation()}removePress(e){super.removePress(e),this.middlePress&&(e.pointer.cursor=uc),this._presses.length===0&&this.stopInProgressAnimation()}interrupt(){this.cancelPanningDuringDrag(),this.cancelMiddlePress(),super.interrupt()}cancel(){this.interrupt()}hasDragIntent(e){return e.hasIntent(Ne.KEYBOARD_DRAG)||e.hasIntent(Ne.DRAG)}panToNode(e,t,s){assert&&assert(this._panBounds.isFinite(),"panBounds should be defined when panning."),this.keepBoundsInView(e.globalBounds,t,s)}keepBoundsInView(e,t,s){assert&&assert(this._panBounds.isFinite(),"panBounds should be defined when panning.");const i=this.sourcePosition;assert&&assert(i,"sourcePosition must be defined to handle keepBoundsInView, be sure to call initializePositions");const n=this._targetNode.globalToLocalBounds(e),a=new T(0,0);let o=0,h=0,l=0,c=0;if(t)o=this._transformedPanBounds.centerX-n.centerX,h=this._transformedPanBounds.centerX-n.centerX,l=this._transformedPanBounds.centerY-n.centerY,c=this._transformedPanBounds.centerY-n.centerY;else if((s==="vertical"||n.width<this._transformedPanBounds.width)&&(s==="horizontal"||n.height<this._transformedPanBounds.height)){const b=150/this.getCurrentScale();o=this._transformedPanBounds.left-n.left+b,h=this._transformedPanBounds.right-n.right-b,l=this._transformedPanBounds.top-n.top+b,c=this._transformedPanBounds.bottom-n.bottom-b}s!=="vertical"&&(h<0&&(a.x=-h),o>0&&(a.x=-o)),s!=="horizontal"&&(c<0&&(a.y=-c),l>0&&(a.y=-l)),this.setDestinationPosition(i.plus(a))}keepTrailInView(e,t){if(this._panBounds.isFinite()&&e.lastNode().bounds.isFinite()){const s=e.localToGlobalBounds(e.lastNode().localBounds);this._panBounds.containsBounds(s)||this.keepBoundsInView(s,!0,t)}}animateToTargets(e){assert&&assert(this.boundsFinite,"initializePositions must be called at least once before animating");const t=this.sourcePosition;assert&&assert(t,"sourcePosition must be defined to animate, be sure to all initializePositions"),assert&&assert(t.isFinite(),"How can the source position not be a finite Vector2?");const s=this.destinationPosition;assert&&assert(s,"destinationPosition must be defined to animate, be sure to all initializePositions"),assert&&assert(s.isFinite(),"How can the destination position not be a finite Vector2?");const i=!s.equalsEpsilon(t,.1),n=!Ve.equalsEpsilon(this.sourceScale,this.destinationScale,.001);if(this.animatingProperty.value=i||n,this._presses.length===0||this.middlePress!==null){if(i){const a=s.minus(t);let o=a;a.magnitude!==0&&(o=a.normalized());const h=this.getTranslationSpeed(a.magnitude);pc.setXY(h,h);const l=pc.multiplyScalar(e),c=o.componentTimes(l);c.magnitude>a.magnitude&&c.set(a),assert&&assert(c.isFinite(),"Trying to translate with a non-finite Vector2"),this.translateDelta(c)}if(n){assert&&assert(this.scaleGestureTargetPosition,"there must be a scale target point");const a=this.destinationScale-this.sourceScale;let o=a*e*6;Math.abs(o)>Math.abs(a)&&(o=a),this.translateScaleToTarget(this.scaleGestureTargetPosition,o),this.setDestinationPosition(t)}else this.destinationScale!==this.sourceScale&&(assert&&assert(this.scaleGestureTargetPosition,"there must be a scale target point"),this.setTranslationScaleToTarget(this.scaleGestureTargetPosition,this.destinationScale),this.setDestinationPosition(t))}}stopInProgressAnimation(){this.boundsFinite&&this.sourcePosition&&(this.setDestinationScale(this.sourceScale),this.setDestinationPosition(this.sourcePosition))}initializePositions(){this.boundsFinite=this._transformedPanBounds.isFinite(),this.boundsFinite?(this.sourcePosition=this._transformedPanBounds.center,this.setDestinationPosition(this.sourcePosition)):(this.sourcePosition=null,this.destinationPosition=null)}setPanBounds(e){super.setPanBounds(e),this.initializePositions(),this._dragBounds=e.erodedXY(e.width*.1,e.height*.1),assert&&assert(this._dragBounds.hasNonzeroArea(),"drag bounds must have some width and height")}setTargetBounds(e){super.setTargetBounds(e),this.initializePositions()}setDestinationPosition(e){assert&&assert(this.boundsFinite,"bounds must be finite before setting destination positions"),assert&&assert(e.isFinite(),"provided destination position is not defined");const t=this.sourcePosition;assert&&assert(t,"sourcePosition must be defined to set destination position, be sure to call initializePositions"),gc.setMinMax(t.x-this._transformedPanBounds.left-this._panBounds.left,t.y-this._transformedPanBounds.top-this._panBounds.top,t.x+this._panBounds.right-this._transformedPanBounds.right,t.y+this._panBounds.bottom-this._transformedPanBounds.bottom),this.destinationPosition=gc.closestPointTo(e)}setDestinationScale(e){this.destinationScale=this.limitScale(e)}getTranslationSpeed(e){assert&&assert(e>=0,"distance for getTranslationSpeed should be a non-negative number");const t=e*this.getCurrentScale(),s=5,i=t*(1/(Math.pow(t,2)-Math.pow(s,2))+s);return Math.min(Math.abs(i),Ef*this.getCurrentScale())}resetTransform(){super.resetTransform(),this.stopInProgressAnimation()}getNextDiscreteScale(e){const t=this.getCurrentScale();let s=null,i=Number.POSITIVE_INFINITY;for(let a=0;a<this.discreteScales.length;a++){const o=Math.abs(this.discreteScales[a]-t);o<i&&(i=o,s=a)}s=s,assert&&assert(s!==null,"nearestIndex should have been found");let n=e?s+1:s-1;return n=Ve.clamp(n,0,this.discreteScales.length-1),this.discreteScales[n]}dispose(){this.disposeAnimatedPanZoomListener()}}class Fa{constructor(e,t,s,i){const n=E()({translationMagnitude:80},i);let a=0;a+=e.isKeyDown(g.KEY_RIGHT_ARROW)?1:0,a-=e.isKeyDown(g.KEY_LEFT_ARROW)?1:0;let o=0;if(o+=e.isKeyDown(g.KEY_DOWN_ARROW)?1:0,o-=e.isKeyDown(g.KEY_UP_ARROW)?1:0,pn.setXY(a,o),!pn.equals(T.ZERO)){const h=n.translationMagnitude*s;pn.setMagnitude(h)}this.translationVector=pn,this.scale=t}computeScaleTargetFromKeyPress(){Ji.setXY(0,0);const e=oe.pdomFocusProperty.value;if(e){const t=e.trail,s=t.lastNode();s.bounds.isFinite()&&Ji.set(t.parentToGlobalPoint(s.center))}else{const t=N.getNextFocusable();if(t!==document.body){assert&&assert(document.body.contains(t),"focusable should be attached to the body");const s=t.offsetLeft+t.offsetWidth/2,i=t.offsetTop+t.offsetHeight/2;Ji.setXY(s,i)}}return assert&&assert(Ji.isFinite(),"target position not defined"),Ji}}class kf{constructor(e,t){const s=e.domEvent;assert&&assert(s instanceof WheelEvent,"SceneryEvent should have a DOMEvent from the wheel input"),this.isCtrlKeyDown=s.ctrlKey,this.scaleDelta=s.deltaY>0?-.5:.5,this.targetPoint=e.pointer.point;let i=s.deltaX*.5,n=s.deltaY*.5;s.deltaMode===window.WheelEvent.DOM_DELTA_LINE&&(i=i*25,n=n*25),this.translationVector=pn.setXY(i*t,n*t)}}class Af{constructor(e,t){assert&&assert(e.type==="mouse","incorrect pointer type"),this.pointer=e,this.trail=t,this.initialPoint=e.point.copy()}}const xf=(r,e)=>{assert&&assert(r>=1,"min scales less than one are currently not supported");const t=8,s=[];for(let n=0;n<t;n++)s[n]=(e-r)/t*(n*n);const i=s[t-1];for(let n=0;n<s.length;n++)s[n]=r+s[n]*(e-r)/i;return s};d.register("AnimatedPanZoomListener",Tu);class Of{constructor(){this._listener=null}initialize(e,t){this._listener=new Tu(e,t)}dispose(){assert&&assert(this._listener,"No listener, call initialize first."),this._listener.dispose(),this._listener=null}get listener(){return assert&&assert(this._listener,"No listener, call initialize first."),this._listener}get initialized(){return!!this._listener}}const Mf=new Of;d.register("animatedPanZoomSingleton",Mf);class Rf{down(e){e.handle()}}d.register("HandleDownlistener",Rf);const Nf=new Map([["both",{left:[g.KEY_A,g.KEY_LEFT_ARROW],right:[g.KEY_RIGHT_ARROW,g.KEY_D],up:[g.KEY_UP_ARROW,g.KEY_W],down:[g.KEY_DOWN_ARROW,g.KEY_S]}],["leftRight",{left:[g.KEY_A,g.KEY_LEFT_ARROW,g.KEY_DOWN_ARROW,g.KEY_S],right:[g.KEY_RIGHT_ARROW,g.KEY_D,g.KEY_UP_ARROW,g.KEY_W],up:[],down:[]}],["upDown",{left:[],right:[],up:[g.KEY_RIGHT_ARROW,g.KEY_D,g.KEY_UP_ARROW,g.KEY_W],down:[g.KEY_A,g.KEY_LEFT_ARROW,g.KEY_DOWN_ARROW,g.KEY_S]}]]);class Cu extends Xn{constructor(e){assert&&Ge(e,["dragSpeed","shiftDragSpeed"],["dragDelta","shiftDragDelta"]),assert&&Ge(e,["mapPosition"],["dragBoundsProperty"]);const t=E()({dragDelta:10,shiftDragDelta:5,dragSpeed:0,shiftDragSpeed:0,keyboardDragDirection:"both",positionProperty:null,transform:null,dragBoundsProperty:null,mapPosition:null,start:null,drag:null,end:null,moveOnHoldDelay:0,moveOnHoldInterval:1e3/60,hotkeyHoldInterval:800,phetioEnabledPropertyInstrumented:!1,tandem:se.REQUIRED,phetioReadOnly:!0},e);assert&&assert(t.shiftDragSpeed<=t.dragSpeed,"shiftDragSpeed should be less than or equal to shiftDragSpeed, it is intended to provide more fine-grained control"),assert&&assert(t.shiftDragDelta<=t.dragDelta,"shiftDragDelta should be less than or equal to dragDelta, it is intended to provide more fine-grained control"),super(t),this._start=t.start,this._drag=t.drag,this._end=t.end,this._dragBoundsProperty=t.dragBoundsProperty||new me(null),this._mapPosition=t.mapPosition,this._transform=t.transform,this._positionProperty=t.positionProperty,this._dragSpeed=t.dragSpeed,this._shiftDragSpeed=t.shiftDragSpeed,this._dragDelta=t.dragDelta,this._shiftDragDelta=t.shiftDragDelta,this._moveOnHoldDelay=t.moveOnHoldDelay,this.moveOnHoldInterval=t.moveOnHoldInterval,this._hotkeyHoldInterval=t.hotkeyHoldInterval,this._keyboardDragDirection=t.keyboardDragDirection,this.isPressedProperty=new ie(!1,{reentrant:!0}),this.keyState=[],this._hotkeys=[],this.currentHotkey=null,this.hotkeyDisablingDragging=!1,this.hotkeyHoldIntervalCounter=this._hotkeyHoldInterval,this.useDragSpeed=t.dragSpeed>0||t.shiftDragSpeed>0,this.moveOnHoldDelayCounter=0,this.moveOnHoldIntervalCounter=0,this.delayComplete=!1,this.dragStartAction=new q(i=>{const n=g.getEventCode(i.domEvent);if(assert&&assert(n,"How can we have a null key for KeyboardDragListener?"),!this.movementKeysDown&&g.isMovementKey(i.domEvent)&&(assert&&assert(this._pointer===null,"We should have cleared the Pointer reference by now."),this._pointer=i.pointer,i.pointer.addInputListener(this._pointerListener,!0),this.isPressedProperty.value=!0),this.keyState.push({keyDown:!0,key:n,timeDown:0}),this._start&&this.movementKeysDown&&this._start(i),!this.useDragSpeed){const a=this.shiftKeyDown()?this._shiftDragDelta:this._dragDelta;this.updatePosition(a),this.moveOnHoldIntervalCounter=0}},{parameters:[{name:"event",phetioType:Ue.SceneryEventIO}],tandem:t.tandem.createTandem("dragStartAction"),phetioDocumentation:"Emits whenever a keyboard drag starts.",phetioReadOnly:t.phetioReadOnly,phetioEventType:Z.USER}),this.dragEmitter=new He({tandem:t.tandem.createTandem("dragEmitter"),phetioHighFrequency:!0,phetioDocumentation:"Emits whenever a keyboard drag occurs.",phetioReadOnly:t.phetioReadOnly,phetioEventType:Z.USER}),this.dragEndAction=new q(i=>{this.movementKeysDown||(assert&&assert(i.pointer===this._pointer,"How could the event Pointer be anything other than this PDOMPointer?"),this._pointer.removeInputListener(this._pointerListener),this._pointer=null,this.isPressedProperty.value=!1),this._end&&this._end(i)},{parameters:[{name:"event",phetioType:Ue.SceneryEventIO}],tandem:t.tandem.createTandem("dragEndAction"),phetioDocumentation:"Emits whenever a keyboard drag ends.",phetioReadOnly:t.phetioReadOnly,phetioEventType:Z.USER});const s=this.step.bind(this);Oe.addListener(s),this.enabledProperty.lazyLink(this.onEnabledPropertyChange.bind(this)),this._pointerListener={listener:this,interrupt:this.interrupt.bind(this)},this._pointer=null,this._disposeKeyboardDragListener=()=>{Oe.removeListener(s),this.isPressedProperty.dispose()}}getDragBounds(){return this._dragBoundsProperty.value}get dragBounds(){return this.getDragBounds()}setTransform(e){this._transform=e}set transform(e){this.setTransform(e)}get transform(){return this.getTransform()}getTransform(){return this._transform}get dragSpeed(){return this._dragSpeed}set dragSpeed(e){this._dragSpeed=e}get shiftDragSpeed(){return this._shiftDragSpeed}set shiftDragSpeed(e){this._shiftDragSpeed=e}get dragDelta(){return this._dragDelta}set dragDelta(e){this._dragDelta=e}get shiftDragDelta(){return this._shiftDragDelta}set shiftDragDelta(e){this._shiftDragDelta=e}get moveOnHoldDelay(){return this._moveOnHoldDelay}set moveOnHoldDelay(e){this._moveOnHoldDelay=e}get moveOnHoldInterval(){return this._moveOnHoldInterval}set moveOnHoldInterval(e){assert&&assert(e>0,"if the moveOnHoldInterval is 0, then the dragging will be dependent on how often the dragListener is stepped"),this._moveOnHoldInterval=e}get hotkeyHoldInterval(){return this._hotkeyHoldInterval}set hotkeyHoldInterval(e){this._hotkeyHoldInterval=e}get isPressed(){return!!this._pointer}getCurrentTarget(){return assert&&assert(this.isPressed,"We have no currentTarget if we are not pressed"),assert&&assert(this._pointer&&this._pointer.trail,"Must have a Pointer with an active trail if we are pressed"),this._pointer.trail.lastNode()}onEnabledPropertyChange(e){!e&&this.interrupt()}keydown(e){const t=e.domEvent,s=g.getEventCode(t);if(assert&&assert(s,"How can we have a null key from a keydown in KeyboardDragListener?"),!t.metaKey&&(g.isMovementKey(t)&&t.preventDefault(),e.pointer.reserveForKeyboardDrag(),!this.keyInListDown([s]))){if(Te.safari&&g.isArrowKey(t)&&this.keyInListDown([g.KEY_RIGHT_ARROW,g.KEY_LEFT_ARROW,g.KEY_UP_ARROW,g.KEY_DOWN_ARROW])){this.interrupt();return}this.canDrag(e)&&this.dragStartAction.execute(e)}}keyup(e){const t=e.domEvent,s=g.getEventCode(t),i=this.movementKeysDown;s===g.KEY_TAB&&t.shiftKey&&this.keyState.push({keyDown:!0,key:g.KEY_SHIFT_LEFT,timeDown:0});for(let a=0;a<this.keyState.length;a++)s===this.keyState[a].key&&this.keyState.splice(a,1);const n=this.movementKeysDown;!n&&i!==n&&this.dragEndAction.execute(e),this.currentHotkey&&!this.allKeysInListDown(this.currentHotkey.keys)&&this.resetHotkeyState(),this.resetPressAndHold()}focusout(e){this.interrupt()}step(e){const t=e*1e3;if(this.keyState.length>0){for(let i=0;i<this.keyState.length;i++)this.keyState[i].keyDown&&(this.keyState[i].timeDown+=t);this.movementKeysDown&&(this.moveOnHoldDelayCounter+=t,this.moveOnHoldIntervalCounter+=t),this.currentHotkey&&(this.hotkeyHoldIntervalCounter+=t);let s=0;if(this.useDragSpeed){const n=(this.shiftKeyDown()?this._shiftDragSpeed:this._dragSpeed)/1e3;s=t*n}else{let i=!1;if(this.moveOnHoldDelayCounter>=this._moveOnHoldDelay&&!this.delayComplete&&(i=!0,this.delayComplete=!0,this.moveOnHoldIntervalCounter=0),this.delayComplete&&this.moveOnHoldIntervalCounter>=this._moveOnHoldInterval){i=!0;const n=this.moveOnHoldIntervalCounter-this._moveOnHoldInterval;this.moveOnHoldIntervalCounter=n}s=i?this.shiftKeyDown()?this._shiftDragDelta:this._dragDelta:0}s>0&&this.updatePosition(s)}}canDrag(e){const t=e.pointer.attachedListener;return this.enabledProperty.value&&(!t||t===this._pointerListener)}updateHotkeys(){for(let e=0;e<this._hotkeys.length;e++){const t=[],s=this._hotkeys[e].keys;for(let n=0;n<s.length;n++)for(let a=0;a<this.keyState.length;a++)this.keyState[a].key===s[n]&&t.push(this.keyState[a]);let i=t.length===1&&s.length===1;for(let n=0;n<t.length-1;n++)t[n+1]&&t[n].timeDown>t[n+1].timeDown&&(i=!0);i&&(this.currentHotkey=this._hotkeys[e],this.hotkeyHoldIntervalCounter>=this._hotkeyHoldInterval&&(this.hotkeyHoldIntervalCounter=0,this._hotkeys[e].callback()))}this.currentHotkey&&(this.keyInListDown(this.currentHotkey.keys)?this.hotkeyDisablingDragging=!0:(this.hotkeyDisablingDragging=!1,this.currentHotkey=null))}updatePosition(e){if(this.updateHotkeys(),!this.hotkeyDisablingDragging){let t=0,s=0;this.leftMovementKeysDown()&&(t-=e),this.rightMovementKeysDown()&&(t+=e),this.upMovementKeysDown()&&(s-=e),this.downMovementKeysDown()&&(s+=e);let i=new T(t,s);if(!i.equals(T.ZERO)){if(this._transform&&(i=(this._transform instanceof Bt?this._transform:this._transform.value).inverseDelta2(i)),this._positionProperty){let n=this._positionProperty.value.plus(i);n=this.mapModelPoint(n),n.equals(this._positionProperty.value)||(this._positionProperty.value=n)}this._drag&&this._drag(i,this),this.dragEmitter.emit()}}}mapModelPoint(e){return this._mapPosition?this._mapPosition(e):this._dragBoundsProperty.value?this._dragBoundsProperty.value.closestPointTo(e):e}keyInListDown(e){let t=!1;for(let s=0;s<this.keyState.length;s++){if(this.keyState[s].keyDown){for(let i=0;i<e.length;i++)if(e[i]===this.keyState[s].key){t=!0;break}}if(t)break}return t}allKeysInListDown(e){assert&&assert(e.length>0,"You are testing to see if an empty list of keys is down?");let t=!0;for(let s=0;s<e.length;s++){const i=_.find(this.keyState,n=>n.key===e[s]);if(!i||!i.keyDown){t=!1;break}}return t}getKeyboardDragDirectionKeys(){const e=Nf.get(this._keyboardDragDirection);return assert&&assert(e,`No direction keys found in map for KeyboardDragDirection ${this._keyboardDragDirection}`),e}leftMovementKeysDown(){return this.keyInListDown(this.getKeyboardDragDirectionKeys().left)}rightMovementKeysDown(){return this.keyInListDown(this.getKeyboardDragDirectionKeys().right)}upMovementKeysDown(){return this.keyInListDown(this.getKeyboardDragDirectionKeys().up)}downMovementKeysDown(){return this.keyInListDown(this.getKeyboardDragDirectionKeys().down)}getMovementKeysDown(){return this.rightMovementKeysDown()||this.leftMovementKeysDown()||this.upMovementKeysDown()||this.downMovementKeysDown()}get movementKeysDown(){return this.getMovementKeysDown()}enterKeyDown(){return this.keyInListDown([g.KEY_ENTER])}shiftKeyDown(){return this.keyInListDown(g.SHIFT_KEYS)}addHotkey(e){this._hotkeys.push(e)}removeHotkey(e){assert&&assert(this._hotkeys.includes(e),"Trying to remove a hotkey that is not in the list of hotkeys.");const t=this._hotkeys.indexOf(e);this._hotkeys.splice(t,1)}setHotkeys(e){this._hotkeys=e.slice(0)}removeAllHotkeys(){this._hotkeys=[]}resetPressAndHold(){this.delayComplete=!1,this.moveOnHoldDelayCounter=0,this.moveOnHoldIntervalCounter=0}resetHotkeyState(){this.currentHotkey=null,this.hotkeyHoldIntervalCounter=this._hotkeyHoldInterval,this.hotkeyDisablingDragging=!1}interrupt(){this.keyState=[],this.resetHotkeyState(),this.resetPressAndHold(),this._pointer&&(assert&&assert(this._pointer.listeners.includes(this._pointerListener),"A reference to the Pointer means it should have the pointerListener"),this._pointer.removeInputListener(this._pointerListener),this._pointer=null,this.isPressedProperty.value=!1,this._end&&this._end())}dispose(){this.interrupt(),this._disposeKeyboardDragListener(),super.dispose()}static isLeftMovementKey(e){return e===g.KEY_A||e===g.KEY_LEFT_ARROW}static isRightMovementKey(e){return e===g.KEY_D||e===g.KEY_RIGHT_ARROW}static isUpMovementKey(e){return e===g.KEY_W||e===g.KEY_UP_ARROW}static isDownMovementKey(e){return e===g.KEY_S||e===g.KEY_DOWN_ARROW}}d.register("KeyboardDragListener",Cu);const mc=Cu;class Bf{constructor(e){const t=E()({callback:_.noop,cancel:_.noop,focus:_.noop,blur:_.noop,global:!1,capture:!1,handle:!1,abort:!1,listenerFireTrigger:"down",fireOnHold:!1,fireOnHoldDelay:400,fireOnHoldInterval:100},e);this._callback=t.callback,this._cancel=t.cancel,this._focus=t.focus,this._blur=t.blur,this._listenerFireTrigger=t.listenerFireTrigger,this._fireOnHold=t.fireOnHold,this._fireOnHoldDelay=t.fireOnHoldDelay,this._fireOnHoldInterval=t.fireOnHoldInterval,this._activeKeyGroups=[],this.keysDown=!1,this._global=t.global,this._handle=t.handle,this._abort=t.abort,this._keyGroups=this.convertKeysToKeyGroups(t.keys),this.listener=this,this.capture=t.capture,this._windowFocusListener=this.handleWindowFocusChange.bind(this),oe.windowHasFocusProperty.link(this._windowFocusListener)}fireCallback(e,t){this._callback(e,t.naturalKeys,this)}handleKeyDown(e){(this._listenerFireTrigger==="down"||this._listenerFireTrigger==="both")&&this._keyGroups.forEach(t=>{this._activeKeyGroups.includes(t)||this.areKeysDownForListener(t)&&t.keys.includes(ze.getLastKeyDown())&&(this._activeKeyGroups.push(t),this.keysDown=!0,e.pointer.reserveForKeyboardDrag(),t.timer&&t.timer.start(),this.fireCallback(e,t))}),this.manageEvent(e)}handleKeyUp(e){if(this._activeKeyGroups.length>0&&this._activeKeyGroups.forEach((t,s)=>{this.areKeysDownForListener(t)||(t.timer&&t.timer.stop(!1),this._activeKeyGroups.splice(s,1))}),this._listenerFireTrigger==="up"||this._listenerFireTrigger==="both"){const t=g.getEventCode(e.domEvent);t&&this._keyGroups.forEach(s=>{this.areModifierKeysDownForListener(s)&&s.keys.includes(t)&&(this.keysDown=!1,this.fireCallback(e,s))})}this.manageEvent(e)}getDownModifierKeys(e){const t=e.modifierKeys,s=[];return t.forEach(i=>{for(const n of i)if(ze.isKeyDown(n)){s.push(n);break}}),s}areKeysDownForListener(e){const t=this.getDownModifierKeys(e),s=t.length===e.modifierKeys.length,i=e.keys.find(n=>ze.isKeyDown(n));if(s&&i){const n=[...t,i];return ze.areKeysDownWithoutExtraModifiers(n)}else return!1}areModifierKeysDownForListener(e){const t=this.getDownModifierKeys(e);return t.length===e.modifierKeys.length?ze.areKeysDownWithoutExtraModifiers(t):!1}manageEvent(e){this._handle&&e.handle(),this._abort&&e.abort()}keydown(e){this._global||this.handleKeyDown(e)}keyup(e){this._global||this.handleKeyUp(e)}globalkeydown(e){this._global&&this.handleKeyDown(e)}globalkeyup(e){this._global&&this.handleKeyUp(e)}handleCancel(){this.clearActiveKeyGroups(),this._cancel(this)}handleWindowFocusChange(e){e||this.handleCancel()}cancel(){this.handleCancel()}interrupt(){this.handleCancel()}focusout(e){this.interrupt(),this._blur(this)}focusin(e){this._focus(this)}dispose(){this._keyGroups.forEach(e=>{e.timer&&e.timer.dispose()}),this._keyGroups.length=0,oe.windowHasFocusProperty.unlink(this._windowFocusListener)}clearActiveKeyGroups(){this._activeKeyGroups.forEach(e=>{e.timer&&e.timer.stop(!1)}),this._activeKeyGroups.length=0}convertKeysToKeyGroups(e){return e.map(s=>{const i=s.split("+");assert&&assert(i.length>0,"no keys provided?");const n=i.slice(-1)[0],a=Qs[n];assert&&assert(a,`Codes were not found, do you need to add it to EnglishStringToCodeMap? ${n}`);let o=[];i.length>1&&(o=i.slice(0,i.length-1).map(u=>{const m=Qs[u];return assert&&assert(m,`Key not found, do you need to add it to EnglishStringToCodeMap? ${u}`),m}));const h=this._fireOnHold?new Qr({callback:()=>this.fireCallback(null,l),delay:this._fireOnHoldDelay,interval:this._fireOnHoldInterval}):null,l={keys:a,modifierKeys:o,naturalKeys:s,timer:h};return l})}}d.register("KeyboardListener",Bf);const Ff=Me(r=>(assert&&assert(_.includes(ct(r),jt),"Only PressListener subtypes should mix SpriteListenable"),class extends r{constructor(...e){super(...e),this.spriteInstance=null}press(e,t,s){if(this.isPressed)return!1;if(this.spriteInstance=null,e.currentTarget instanceof th){const i=e.currentTarget;this.spriteInstance=i.getSpriteInstanceFromPoint(i.globalToLocalPoint(e.pointer.point))}return this.spriteInstance?super.press(e,t,s):!1}}));d.register("SpriteListenable",Ff);const Hf=.75,fc=.6;class Vf{constructor(e){this._pointer=null,this.downPoint=null,this.downEvent=null,this.enabled=!1,this.lastPoint=null,this.currentPoint=null,this.velocity=null,this.swipeDistance=null,this.firstUp=!1,this.timeSinceLastDown=0,this.downPointers=[],this.holdingTime=0,this.focusedNode=null,this.handleEventListener={down:t=>{t.handle(),t.abort(),this.handleDown(t)}},e.pointerAddedEmitter.addListener(t=>{this.enabled&&t.addInputListener(this.handleEventListener,!0)}),this._attachedPointerListener={up:t=>{this.focusedNode&&this.focusedNode.swipeEnd&&this.focusedNode.swipeEnd.bind(this.focusedNode)(t,this),this.focusedNode=null,this._pointer.removeInputListener(this._attachedPointerListener),this._pointer=null},move:t=>{this.focusedNode&&this.focusedNode.swipeMove&&this.focusedNode.swipeMove.bind(this.focusedNode)(t,this)},interrupt:t=>{this.focusedNode=null,this._pointer.removeInputListener(this._attachedPointerListener),this._pointer=null},cancel:t=>{this.focusedNode=null,this._pointer.removeInputListener(this._attachedPointerListener),this._pointer=null}},this._pointerListener={up:t=>{this.endSwipe(),this._pointer=null,this.swipeDistance=t.pointer.point.minus(this.downPoint);const s=this.swipeDistance.y,i=this.swipeDistance.x;if(Math.abs(i)>100&&Math.abs(s)<100)if(i>0){if(oe.pdomFocusedNode&&oe.pdomFocusedNode.innerContent==="Reset All")return;N.getNextFocusable(document.body).focus()}else N.getPreviousFocusable(document.body).focus();else if(this.firstUp){if(this.timeSinceLastDown<fc){this.firstUp=!1,this.timeSinceLastDown=0;const n=document.getElementsByClassName("a11y-pdom-root")[0];n&&n.contains(t.activeElement)&&t.activeElement.click()}}else this.firstUp=!0},move:t=>{this.lastPoint=this.currentPoint,this.currentPoint=t.pointer.point},interrupt:()=>{this.interrupt()},cancel:()=>{this.interrupt()}},Oe.addListener(this.step.bind(this))}handleDown(e){e.pointer.addIntent(Ne.DRAG),this.downPointers.push(e.pointer),this.downPointers.length>1&&(this.downPointers.forEach(t=>t.removeIntent(Ne.DRAG)),e.pointer.removeIntent(Ne.DRAG)),assert&&assert(e.pointer.attachedProperty.get(),"should be attached to the handle listener"),e.pointer.removeInputListener(this.handleEventListener),this._pointer===null&&e.pointer.type==="touch"&&(this._pointer=e.pointer,e.pointer.addInputListener(this._pointerListener,!0),e.abort(),this.downEvent=e,this.downPoint=e.pointer.point,this.currentPoint=this.downPoint.copy(),this.previousPoint=this.currentPoint.copy())}up(e){const t=this.downPointers.indexOf(e.pointer);t>-1&&this.downPointers.splice(t,1)}step(e){if(this.firstUp&&(this.timeSinceLastDown+=e,this.timeSinceLastDown>fc&&(this.firstUp=!1,this.timeSinceLastDown=0)),this._pointer&&!this._pointer.listeners.includes(this._attachedPointerListener))if(this.holdingTime>Hf){const t=oe.pdomFocusedNode;t&&(this._pointer.removeInputListener(this._pointerListener),this.holdingTime=0,this.focusedNode=t,this._pointer.addInputListener(this._attachedPointerListener,!0),this.focusedNode.swipeStart&&this.focusedNode.swipeStart(this.downEvent,this),this.downEvent=null)}else this.holdingTime+=e;this.lastPoint!==null&&this.currentPoint!==null&&(this.velocity=this.lastPoint.minus(this.currentPoint).dividedScalar(e))}endSwipe(){this.holdingTime=0,this._pointer&&this._pointer.listeners.includes(this._pointerListener)&&this._pointer.removeInputListener(this._pointerListener)}detachPointerListener(){this._pointer.detach(this._attachedPointerListener)}interrupt(){this.endSwipe(),this._pointer=null,this.downEvent=null}}d.register("SwipeListener",Vf);const To=["left","right","center","origin"],Co=["top","bottom","center","origin"],at=class at extends si{constructor(e,t,s=Number.POSITIVE_INFINITY){super(),this.horizontal=e,this.vertical=t,this.padRatio=s}static getAllowedAligns(e){return[...e===M.HORIZONTAL?To:Co,null]}static alignToInternal(e,t){return e===M.HORIZONTAL?at.horizontalAlignToInternal(t):at.verticalAlignToInternal(t)}static horizontalAlignToInternal(e){return e===null?null:(assert&&assert(yc[e]),yc[e])}static verticalAlignToInternal(e){return e===null?null:(assert&&assert(bc[e]),bc[e])}static internalToAlign(e,t){return t===null?null:e===M.HORIZONTAL?t.horizontal:t.vertical}};at.START=new at("left","top",0),at.END=new at("right","bottom",1),at.CENTER=new at("center","center",.5),at.ORIGIN=new at("origin","origin"),at.enumeration=new ii(at,{phetioDocumentation:"Alignment for layout containers"});let de=at;const yc={left:de.START,right:de.END,center:de.CENTER,origin:de.ORIGIN},bc={top:de.START,bottom:de.END,center:de.CENTER,origin:de.ORIGIN};d.register("LayoutAlign",de);const Gf=["left","right","center","spaceBetween","spaceAround","spaceEvenly"],zf=["top","bottom","center","spaceBetween","spaceAround","spaceEvenly"],Qe=class Qe extends si{constructor(e,t,s){super(),this.spacingFunctionFactory=e,this.horizontal=t,this.vertical=s}static getAllowedJustificationValues(e){return e===M.HORIZONTAL?Gf:zf}static justifyToInternal(e,t){return e===M.HORIZONTAL?(assert&&assert(Lc[t]),Lc[t]):(assert&&assert(vc[t]),vc[t])}static internalToJustify(e,t){return e===M.HORIZONTAL?t.horizontal:t.vertical}};Qe.START=new Qe(()=>()=>0,"left","top"),Qe.END=new Qe(e=>t=>t===0?e:0,"right","bottom"),Qe.CENTER=new Qe(e=>t=>t===0?e/2:0,"center","center"),Qe.SPACE_BETWEEN=new Qe((e,t)=>s=>s!==0?e/(t-1):0,"spaceBetween","spaceBetween"),Qe.SPACE_AROUND=new Qe((e,t)=>s=>(s!==0?2:1)*e/(2*t),"spaceAround","spaceAround"),Qe.SPACE_EVENLY=new Qe((e,t)=>s=>e/(t+1),"spaceEvenly","spaceEvenly"),Qe.enumeration=new ii(Qe,{phetioDocumentation:"Justify for layout containers"});let ye=Qe;const Lc={left:ye.START,right:ye.END,center:ye.CENTER,spaceBetween:ye.SPACE_BETWEEN,spaceAround:ye.SPACE_AROUND,spaceEvenly:ye.SPACE_EVENLY},vc={top:ye.START,bottom:ye.END,center:ye.CENTER,spaceBetween:ye.SPACE_BETWEEN,spaceAround:ye.SPACE_AROUND,spaceEvenly:ye.SPACE_EVENLY};d.register("LayoutJustification",ye);const Wf={stretch:!0,isSeparator:!0};class oh extends ds{constructor(e){super(ls()({},{layoutOptions:Wf,stroke:"rgb(100,100,100)"},e))}}d.register("Separator",oh);class Iu extends Jo(oh){constructor(e){super(),this.localPreferredHeightProperty.link(t=>{t!==null&&(this.y2=t)}),this.mutate(e)}}d.register("VSeparator",Iu);class Eu extends Ur(oh){constructor(e){super(),this.localPreferredWidthProperty.link(t=>{t!==null&&(this.x2=t)}),this.mutate(e)}}d.register("HSeparator",Eu);const Cn=class Cn{constructor(e){this.initialize(e)}initialize(e){return this.trail=e,this}checkPreconditions(){assert&&assert(this.trail,"Should not be disposed"),assert&&assert(this.trail.getParentMatrix().isAxisAligned(),"Transforms with LayoutProxy need to be axis-aligned")}get node(){return assert&&this.checkPreconditions(),this.trail.lastNode()}get bounds(){return assert&&this.checkPreconditions(),this.trail.parentToGlobalBounds(this.node.bounds)}get visibleBounds(){return assert&&this.checkPreconditions(),this.trail.parentToGlobalBounds(this.node.visibleBounds)}get width(){return this.bounds.width}get height(){return this.bounds.height}get x(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformX(this.node.x)}set x(e){assert&&this.checkPreconditions(),this.node.x=this.trail.getParentTransform().inverseX(e)}get y(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformY(this.node.y)}set y(e){assert&&this.checkPreconditions(),this.node.y=this.trail.getParentTransform().inverseY(e)}get translation(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.translation)}set translation(e){assert&&this.checkPreconditions(),this.node.translation=this.trail.getParentTransform().inversePosition2(e)}get left(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformX(this.node.left)}set left(e){this.node.left=this.trail.getParentTransform().inverseX(e)}get right(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformX(this.node.right)}set right(e){assert&&this.checkPreconditions(),this.node.right=this.trail.getParentTransform().inverseX(e)}get centerX(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformX(this.node.centerX)}set centerX(e){assert&&this.checkPreconditions(),this.node.centerX=this.trail.getParentTransform().inverseX(e)}get top(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformY(this.node.top)}set top(e){assert&&this.checkPreconditions(),this.node.top=this.trail.getParentTransform().inverseY(e)}get bottom(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformY(this.node.bottom)}set bottom(e){assert&&this.checkPreconditions(),this.node.bottom=this.trail.getParentTransform().inverseY(e)}get centerY(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformY(this.node.centerY)}set centerY(e){assert&&this.checkPreconditions(),this.node.centerY=this.trail.getParentTransform().inverseY(e)}get leftTop(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.leftTop)}set leftTop(e){assert&&this.checkPreconditions(),this.node.leftTop=this.trail.getParentTransform().inversePosition2(e)}get centerTop(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.centerTop)}set centerTop(e){assert&&this.checkPreconditions(),this.node.centerTop=this.trail.getParentTransform().inversePosition2(e)}get rightTop(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.rightTop)}set rightTop(e){assert&&this.checkPreconditions(),this.node.rightTop=this.trail.getParentTransform().inversePosition2(e)}get leftCenter(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.leftCenter)}set leftCenter(e){assert&&this.checkPreconditions(),this.node.leftCenter=this.trail.getParentTransform().inversePosition2(e)}get center(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.center)}set center(e){assert&&this.checkPreconditions(),this.node.center=this.trail.getParentTransform().inversePosition2(e)}get rightCenter(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.rightCenter)}set rightCenter(e){assert&&this.checkPreconditions(),this.node.rightCenter=this.trail.getParentTransform().inversePosition2(e)}get leftBottom(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.leftBottom)}set leftBottom(e){assert&&this.checkPreconditions(),this.node.leftBottom=this.trail.getParentTransform().inversePosition2(e)}get centerBottom(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.centerBottom)}set centerBottom(e){assert&&this.checkPreconditions(),this.node.centerBottom=this.trail.getParentTransform().inversePosition2(e)}get rightBottom(){return assert&&this.checkPreconditions(),this.trail.getParentTransform().transformPosition2(this.node.rightBottom)}set rightBottom(e){assert&&this.checkPreconditions(),this.node.rightBottom=this.trail.getParentTransform().inversePosition2(e)}get widthSizable(){return this.node.widthSizable}get heightSizable(){return this.node.heightSizable}get preferredWidth(){assert&&this.checkPreconditions(),assert&&assert(Si(this.node));const e=this.node.preferredWidth;return e===null?null:Math.abs(this.trail.getParentTransform().transformDeltaX(e))}set preferredWidth(e){assert&&this.checkPreconditions(),assert&&assert(Si(this.node)),this.node.preferredWidth=e===null?null:Math.abs(this.trail.getParentTransform().inverseDeltaX(e))}get preferredHeight(){assert&&this.checkPreconditions(),assert&&assert(wi(this.node));const e=this.node.preferredHeight;return e===null?null:Math.abs(this.trail.getParentTransform().transformDeltaY(e))}set preferredHeight(e){assert&&this.checkPreconditions(),assert&&assert(wi(this.node)),this.node.preferredHeight=e===null?null:Math.abs(this.trail.getParentTransform().inverseDeltaY(e))}get minimumWidth(){assert&&this.checkPreconditions();const e=Si(this.node)?this.node.minimumWidth||0:this.node.width;return Math.abs(this.trail.getParentTransform().transformDeltaX(e))}get minimumHeight(){assert&&this.checkPreconditions();const e=wi(this.node)?this.node.minimumHeight||0:this.node.height;return Math.abs(this.trail.getParentTransform().transformDeltaY(e))}getMinimum(e){return e===M.HORIZONTAL?this.minimumWidth:this.minimumHeight}get maxWidth(){return assert&&this.checkPreconditions(),this.node.maxWidth===null?null:Math.abs(this.trail.getParentTransform().transformDeltaX(this.node.maxWidth))}set maxWidth(e){assert&&this.checkPreconditions(),this.node.maxWidth=e===null?null:Math.abs(this.trail.getParentTransform().inverseDeltaX(e))}get maxHeight(){return assert&&this.checkPreconditions(),this.node.maxHeight===null?null:Math.abs(this.trail.getParentTransform().transformDeltaY(this.node.maxHeight))}set maxHeight(e){assert&&this.checkPreconditions(),this.node.maxHeight=e===null?null:Math.abs(this.trail.getParentTransform().inverseDeltaY(e))}getMax(e){return e===M.HORIZONTAL?this.maxWidth:this.maxHeight}get visible(){return this.node.visible}set visible(e){this.node.visible=e}dispose(){this.trail=null,this.freeToPool()}freeToPool(){Cn.pool.freeToPool(this)}};Cn.pool=new nt(Cn,{maxSize:1e3});let $n=Cn;d.register("LayoutProxy",$n);class ku extends gd{constructor(e,t,s){const i=new Wd(e,t);super([i],a=>a.length===1?$n.pool.create(a[0].copy().removeAncestor()):null),this.transformTracker=null,this.trailsBetweenProperty=i,this.lazyLink((a,o)=>{o&&o.dispose()});const n=s==null?void 0:s.onTransformChange;n&&this.link(a=>{this.transformTracker&&(this.transformTracker.dispose(),this.transformTracker=null),a&&(this.transformTracker=new Js(a.trail.copy().addAncestor(e)),this.transformTracker.addListener(n))})}dispose(){this.trailsBetweenProperty.dispose(),this.transformTracker&&this.transformTracker.dispose(),super.dispose()}}d.register("LayoutProxyProperty",ku);class jn{constructor(e){this._layoutLockCount=0,this._layoutAttemptDuringLock=!1,this._enabled=!0,this._listenedNodes=new Set,this.finishedLayoutEmitter=new re,this.ancestorNode=e,this._updateLayoutListener=this.updateLayoutAutomatically.bind(this)}addNode(e,t=!0){assert&&assert(!this._listenedNodes.has(e)),assert&&assert(!t||!e._activeParentLayoutConstraint,"This node is already managed by a layout container - make sure to wrap it in a Node if DAG, removing it from an old layout container, etc."),t&&(e._activeParentLayoutConstraint=this),e.boundsProperty.lazyLink(this._updateLayoutListener),e.visibleProperty.lazyLink(this._updateLayoutListener),Cl(e)&&(e.minimumWidthProperty.lazyLink(this._updateLayoutListener),e.isWidthResizableProperty.lazyLink(this._updateLayoutListener)),Il(e)&&(e.minimumHeightProperty.lazyLink(this._updateLayoutListener),e.isHeightResizableProperty.lazyLink(this._updateLayoutListener)),this._listenedNodes.add(e)}removeNode(e){assert&&assert(this._listenedNodes.has(e)),e._activeParentLayoutConstraint===this&&(e._activeParentLayoutConstraint=null),e.boundsProperty.unlink(this._updateLayoutListener),e.visibleProperty.unlink(this._updateLayoutListener),Cl(e)&&(e.minimumWidthProperty.unlink(this._updateLayoutListener),e.isWidthResizableProperty.unlink(this._updateLayoutListener)),Il(e)&&(e.minimumHeightProperty.unlink(this._updateLayoutListener),e.isHeightResizableProperty.unlink(this._updateLayoutListener)),this._listenedNodes.delete(e)}layout(){}get isLocked(){return this._layoutLockCount>0}lock(){this._layoutLockCount++}unlock(){this._layoutLockCount--}validateLocalPreferredWidth(e){assert&&e.localBounds.isFinite()&&!this._layoutAttemptDuringLock&&e.validateLocalPreferredWidth()}validateLocalPreferredHeight(e){assert&&e.localBounds.isFinite()&&!this._layoutAttemptDuringLock&&e.validateLocalPreferredHeight()}validateLocalPreferredSize(e){assert&&e.localBounds.isFinite()&&!this._layoutAttemptDuringLock&&e.validateLocalPreferredSize()}updateLayout(){let e=0;if(this.isLocked)assert&&e++,assert&&assert(++e<500,"Likely infinite loop detected, are we triggering layout within the layout?"),this._layoutAttemptDuringLock=!0;else{this.lock();do this._layoutAttemptDuringLock=!1,this.layout();while(this._layoutAttemptDuringLock);this.unlock()}}updateLayoutAutomatically(){this._enabled&&this.updateLayout()}createLayoutProxy(e){const t=e.getTrails(s=>s===this.ancestorNode);return t.length===1?$n.pool.create(t[0].removeAncestor()):null}get enabled(){return this._enabled}set enabled(e){this._enabled!==e&&(this._enabled=e,this.updateLayoutAutomatically())}dispose(){const e=[...this._listenedNodes.keys()];for(let t=0;t<e.length;t++)this.removeNode(e[t]);this.finishedLayoutEmitter.dispose()}}d.register("LayoutConstraint",jn);class Zr{constructor(e,t,s){s?(this.layoutProxyProperty=null,this._proxy=s):(this._proxy=null,this.layoutProxyProperty=new ku(e.ancestorNode,t,{onTransformChange:()=>e.updateLayoutAutomatically()}),this.layoutProxyProperty.link(i=>{this._proxy=i,e.updateLayoutAutomatically()})),this._constraint=e,this._node=t,this.layoutOptionsListener=this.onLayoutOptionsChange.bind(this),this.node.layoutOptionsChangedEmitter.addListener(this.layoutOptionsListener)}onLayoutOptionsChange(){}get node(){return this._node}isConnected(){return this._proxy!==null}get proxy(){return assert&&assert(this._proxy),this._proxy}isSizable(e){return e===M.HORIZONTAL?this.proxy.widthSizable:this.proxy.heightSizable}dispose(){this.layoutProxyProperty&&this.layoutProxyProperty.dispose(),this.node.layoutOptionsChangedEmitter.removeListener(this.layoutOptionsListener)}}d.register("LayoutCell",Zr);class qn extends Zr{constructor(e,t,s){super(e,t,s),this.preferredSizeSet=new Us(!1,!1),this.lastAvailableBounds=w.NOTHING.copy(),this.lastUsedBounds=w.NOTHING.copy(),this._marginConstraint=e}reposition(e,t,s,i,n,a){const o=i&&this.isSizable(e)?t:this.getMinimumSize(e);if(assert){const l=e===M.HORIZONTAL?this.node.maxWidth:this.node.maxHeight;assert(!this.isSizable(e)||l===null||Math.abs(l-o)>-1e-9,`Tried to set a preferred size ${o} larger than the specified max${e===M.HORIZONTAL?"Width":"Height"} of ${l}. Ideally, try to avoid putting a maxWidth/maxHeight on a width/height-sizable Node (one that will resize to fit its preferred size) inside a layout container, particularly one that will try to expand the Node past its maximum size.`)}this.attemptPreferredSize(e,o),a===de.ORIGIN?this.positionOrigin(e,s+n):this.positionStart(e,s+(t-this.getCellBounds()[e.size])*a.padRatio);const h=this.getCellBounds();return assert&&assert(h.isFinite()),this.lastAvailableBounds[e.minCoordinate]=s,this.lastAvailableBounds[e.maxCoordinate]=s+t,this.lastUsedBounds.set(h),h}get effectiveLeftMargin(){return this._leftMargin!==null?this._leftMargin:this._marginConstraint._leftMargin}get effectiveRightMargin(){return this._rightMargin!==null?this._rightMargin:this._marginConstraint._rightMargin}get effectiveTopMargin(){return this._topMargin!==null?this._topMargin:this._marginConstraint._topMargin}get effectiveBottomMargin(){return this._bottomMargin!==null?this._bottomMargin:this._marginConstraint._bottomMargin}getEffectiveMinMargin(e){return e===M.HORIZONTAL?this.effectiveLeftMargin:this.effectiveTopMargin}getEffectiveMaxMargin(e){return e===M.HORIZONTAL?this.effectiveRightMargin:this.effectiveBottomMargin}get effectiveMinContentWidth(){return this._minContentWidth!==null?this._minContentWidth:this._marginConstraint._minContentWidth}get effectiveMinContentHeight(){return this._minContentHeight!==null?this._minContentHeight:this._marginConstraint._minContentHeight}getEffectiveMinContent(e){return e===M.HORIZONTAL?this.effectiveMinContentWidth:this.effectiveMinContentHeight}get effectiveMaxContentWidth(){return this._maxContentWidth!==null?this._maxContentWidth:this._marginConstraint._maxContentWidth}get effectiveMaxContentHeight(){return this._maxContentHeight!==null?this._maxContentHeight:this._marginConstraint._maxContentHeight}getEffectiveMaxContent(e){return e===M.HORIZONTAL?this.effectiveMaxContentWidth:this.effectiveMaxContentHeight}getMinimumSize(e){return this.getEffectiveMinMargin(e)+Math.max(this.proxy.getMinimum(e),this.getEffectiveMinContent(e)||0)+this.getEffectiveMaxMargin(e)}getMaximumSize(e){return this.getEffectiveMinMargin(e)+(this.getEffectiveMaxContent(e)||Number.POSITIVE_INFINITY)+this.getEffectiveMaxMargin(e)}attemptPreferredSize(e,t){if(this.proxy[e.sizable]){const s=this.getMinimumSize(e),i=this.getMaximumSize(e);assert&&assert(isFinite(s)),assert&&assert(i>=s),t=Ve.clamp(t,s,i);let n=t-this.getEffectiveMinMargin(e)-this.getEffectiveMaxMargin(e);const a=this.proxy.getMax(e);a!==null&&(n=Math.min(a,n)),this._marginConstraint.setProxyPreferredSize(e,this.proxy,n),this.preferredSizeSet.set(e,!0)}}unsetPreferredSize(e){this.proxy[e.sizable]&&this._marginConstraint.setProxyPreferredSize(e,this.proxy,null)}positionStart(e,t){const s=this.getEffectiveMinMargin(e)+t;this._marginConstraint.setProxyMinSide(e,this.proxy,s)}positionOrigin(e,t){this._marginConstraint.setProxyOrigin(e,this.proxy,t)}getOriginBounds(){return this.getCellBounds().shiftedXY(-this.proxy.x,-this.proxy.y)}getCellBounds(){return this.proxy.bounds.withOffsets(this.effectiveLeftMargin,this.effectiveTopMargin,this.effectiveRightMargin,this.effectiveBottomMargin)}dispose(){M.enumeration.values.forEach(e=>{this.preferredSizeSet.get(e)&&this.unsetPreferredSize(e)}),super.dispose()}static createHelperNode(e,t,s){const i=new D,n=.4,a=H.union(e.map(b=>H.bounds(b.lastAvailableBounds))),o=H.union(e.map(b=>H.bounds(b.lastUsedBounds))),h=H.union(e.map(b=>H.bounds(b.proxy.bounds))),l=H.bounds(t).shapeDifference(a),c=a.shapeDifference(o),u=o.shapeDifference(h),m=(b,y,f)=>{const L=new Fe(b,{font:new xe({size:6,family:"monospace"}),fill:y}),v=De.bounds(L.bounds,{fill:f,children:[L]});return new Md(v,4,Math.floor(v.left),Math.ceil(v.top+1),Math.floor(v.width),Math.floor(v.height-2),C.rotation2(-Math.PI/4))};return i.addChild(new Pe(l,{fill:m("spacing","#000","#fff"),opacity:.6})),i.addChild(new Pe(c,{fill:m("empty","#aaa","#000"),opacity:.6})),i.addChild(new Pe(u,{fill:m("margin","#600","#f00"),opacity:.6})),i.addChild(De.bounds(t,{stroke:"white",lineDash:[2,2],lineDashOffset:2,lineWidth:n})),i.addChild(De.bounds(t,{stroke:"black",lineDash:[2,2],lineWidth:n})),e.forEach(b=>{i.addChild(De.bounds(b.getCellBounds(),{stroke:"rgba(0,255,0,1)",lineWidth:n}))}),e.forEach(b=>{i.addChild(De.bounds(b.proxy.bounds,{stroke:"rgba(255,0,0,1)",lineWidth:n}))}),e.forEach(b=>{const y=b.getCellBounds(),f=new jt({tandem:se.OPT_OUT});i.addChild(De.bounds(y,{inputListeners:[f]}));let L=s(b);b.effectiveLeftMargin&&(L+=`leftMargin: ${b.effectiveLeftMargin}
`),b.effectiveRightMargin&&(L+=`rightMargin: ${b.effectiveRightMargin}
`),b.effectiveTopMargin&&(L+=`topMargin: ${b.effectiveTopMargin}
`),b.effectiveBottomMargin&&(L+=`bottomMargin: ${b.effectiveBottomMargin}
`),b.effectiveMinContentWidth&&(L+=`minContentWidth: ${b.effectiveMinContentWidth}
`),b.effectiveMinContentHeight&&(L+=`minContentHeight: ${b.effectiveMinContentHeight}
`),b.effectiveMaxContentWidth&&(L+=`maxContentWidth: ${b.effectiveMaxContentWidth}
`),b.effectiveMaxContentHeight&&(L+=`maxContentHeight: ${b.effectiveMaxContentHeight}
`),L+=`layoutOptions: ${JSON.stringify(b.node.layoutOptions,null,2).replace(/ /g,"&nbsp;")}
`;const v=new ps(L.trim().replace(/\n/g,"<br>"),{font:new xe({size:12})}),S=De.bounds(v.bounds.dilated(3),{fill:"rgba(255,255,255,0.8)",children:[v],leftTop:y.leftTop});i.addChild(S),f.isOverProperty.link(B=>{S.visible=B})}),i}}d.register("MarginLayoutCell",qn);const Au=["resize","layoutOrigin"];class hh extends Yr(D){constructor(e){super(e),this.layoutOriginProperty=new yp(T.ZERO)}linkLayoutBounds(){this._constraint.layoutBoundsProperty.link(e=>{this.localBounds=e})}setExcludeInvisibleChildrenFromBounds(e){super.setExcludeInvisibleChildrenFromBounds(e),this._constraint.excludeInvisible=e}setChildren(e){if(this.constraint.isLocked)return super.setChildren(e);const t=this.getChildren();return this.constraint.lock(),super.setChildren(e),this.constraint.unlock(),_.isEqual(t,e)||this.constraint.updateLayoutAutomatically(),this}updateLayout(){this._constraint.updateLayout()}get resize(){return this._constraint.enabled}set resize(e){this._constraint.enabled=e}get layoutOrigin(){return this.layoutOriginProperty.value}set layoutOrigin(e){this.layoutOriginProperty.value=e}get constraint(){return this._constraint}dispose(){this._constraint.dispose(),super.dispose()}}d.register("LayoutNode",hh);class lh{initializeLayoutLine(){this.min=0,this.max=Number.POSITIVE_INFINITY,this.minOrigin=Number.POSITIVE_INFINITY,this.maxOrigin=Number.NEGATIVE_INFINITY,this.size=0,this.position=0}hasOrigin(){return isFinite(this.minOrigin)&&isFinite(this.maxOrigin)}}d.register("LayoutLine",lh);const Pc=1e-9;class ch extends jn{constructor(e,t){const s=E()({preferredWidthProperty:new X(null),preferredHeightProperty:new X(null),minimumWidthProperty:new X(null),minimumHeightProperty:new X(null),layoutOriginProperty:new X(T.ZERO)},t);super(e),this._excludeInvisible=!0,this.layoutBoundsProperty=new me(w.NOTHING,{valueComparisonStrategy:"equalsFunction"}),this.preferredWidthProperty=s.preferredWidthProperty,this.preferredHeightProperty=s.preferredHeightProperty,this.minimumWidthProperty=s.minimumWidthProperty,this.minimumHeightProperty=s.minimumHeightProperty,this.layoutOriginProperty=s.layoutOriginProperty,this.preferredWidthProperty.lazyLink(this._updateLayoutListener),this.preferredHeightProperty.lazyLink(this._updateLayoutListener),this.layoutOriginProperty.lazyLink(this._updateLayoutListener)}filterLayoutCells(e){return assert&&assert(_.every(e,t=>!t.node.isDisposed),"A cell's node should not be disposed when layout happens"),e.filter(t=>t.isConnected()&&t.proxy.bounds.isValid()&&(!this.excludeInvisible||t.node.visible))}get excludeInvisible(){return this._excludeInvisible}set excludeInvisible(e){this._excludeInvisible!==e&&(this._excludeInvisible=e,this.updateLayoutAutomatically())}setProxyPreferredSize(e,t,s){t[e.preferredSize]=s}setProxyMinSide(e,t,s){Math.abs(t[e.minSide]-s)>Pc&&(t[e.minSide]=s)}setProxyOrigin(e,t,s){Math.abs(t[e.coordinate]-s)>Pc&&(t[e.coordinate]=s)}dispose(){this.preferredWidthProperty.unlink(this._updateLayoutListener),this.preferredHeightProperty.unlink(this._updateLayoutListener),this.layoutOriginProperty.unlink(this._updateLayoutListener),super.dispose()}}d.register("NodeLayoutConstraint",ch);const xu=["margin","xMargin","yMargin","leftMargin","rightMargin","topMargin","bottomMargin","minContentWidth","minContentHeight","maxContentWidth","maxContentHeight"],dh=Me(r=>class extends r{constructor(...t){super(...t),this._leftMargin=null,this._rightMargin=null,this._topMargin=null,this._bottomMargin=null,this._minContentWidth=null,this._minContentHeight=null,this._maxContentWidth=null,this._maxContentHeight=null,this.changedEmitter=new re}mutateConfigurable(t){Ge(t,["margin"],["xMargin","yMargin"]),Ge(t,["xMargin"],["leftMargin","rightMargin"]),Ge(t,["yMargin"],["topMargin","bottomMargin"])}setConfigToBaseDefault(){this._leftMargin=0,this._rightMargin=0,this._topMargin=0,this._bottomMargin=0,this._minContentWidth=null,this._minContentHeight=null,this._maxContentWidth=null,this._maxContentHeight=null,this.changedEmitter.emit()}setConfigToInherit(){this._leftMargin=null,this._rightMargin=null,this._topMargin=null,this._bottomMargin=null,this._minContentWidth=null,this._minContentHeight=null,this._maxContentWidth=null,this._maxContentHeight=null,this.changedEmitter.emit()}get leftMargin(){return this._leftMargin}set leftMargin(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)),this._leftMargin!==t&&(this._leftMargin=t,this.changedEmitter.emit())}get rightMargin(){return this._rightMargin}set rightMargin(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)),this._rightMargin!==t&&(this._rightMargin=t,this.changedEmitter.emit())}get topMargin(){return this._topMargin}set topMargin(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)),this._topMargin!==t&&(this._topMargin=t,this.changedEmitter.emit())}get bottomMargin(){return this._bottomMargin}set bottomMargin(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)),this._bottomMargin!==t&&(this._bottomMargin=t,this.changedEmitter.emit())}get xMargin(){return assert&&assert(this._leftMargin===this._rightMargin),this._leftMargin}set xMargin(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)),(this._leftMargin!==t||this._rightMargin!==t)&&(this._leftMargin=t,this._rightMargin=t,this.changedEmitter.emit())}get yMargin(){return assert&&assert(this._topMargin===this._bottomMargin),this._topMargin}set yMargin(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)),(this._topMargin!==t||this._bottomMargin!==t)&&(this._topMargin=t,this._bottomMargin=t,this.changedEmitter.emit())}get margin(){return assert&&assert(this._leftMargin===this._rightMargin&&this._leftMargin===this._topMargin&&this._leftMargin===this._bottomMargin),this._topMargin}set margin(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)),(this._leftMargin!==t||this._rightMargin!==t||this._topMargin!==t||this._bottomMargin!==t)&&(this._leftMargin=t,this._rightMargin=t,this._topMargin=t,this._bottomMargin=t,this.changedEmitter.emit())}get minContentWidth(){return this._minContentWidth}set minContentWidth(t){this._minContentWidth!==t&&(this._minContentWidth=t,this.changedEmitter.emit())}get minContentHeight(){return this._minContentHeight}set minContentHeight(t){this._minContentHeight!==t&&(this._minContentHeight=t,this.changedEmitter.emit())}get maxContentWidth(){return this._maxContentWidth}set maxContentWidth(t){this._maxContentWidth!==t&&(this._maxContentWidth=t,this.changedEmitter.emit())}get maxContentHeight(){return this._maxContentHeight}set maxContentHeight(t){this._maxContentHeight!==t&&(this._maxContentHeight=t,this.changedEmitter.emit())}});d.register("MarginLayoutConfigurable",dh);const uh=["orientation","align","stretch","grow"].concat(xu),ph=Me(r=>class extends dh(r){constructor(...t){super(...t),this._orientation=M.HORIZONTAL,this._align=null,this._stretch=null,this._grow=null,this.orientationChangedEmitter=new re}mutateConfigurable(t){super.mutateConfigurable(t),Yn(this,uh,t)}setConfigToBaseDefault(){this._align=de.CENTER,this._stretch=!1,this._grow=0,super.setConfigToBaseDefault()}setConfigToInherit(){this._align=null,this._stretch=null,this._grow=null,super.setConfigToInherit()}get orientation(){return this._orientation===M.HORIZONTAL?"horizontal":"vertical"}set orientation(t){assert&&assert(t==="horizontal"||t==="vertical");const s=t==="horizontal"?M.HORIZONTAL:M.VERTICAL;this._orientation!==s&&(this._orientation=s,this.orientationChangedEmitter.emit(),this.changedEmitter.emit())}get align(){const t=de.internalToAlign(this._orientation,this._align);return assert&&assert(t===null||typeof t=="string"),t}set align(t){assert&&assert(de.getAllowedAligns(this._orientation.opposite).includes(t),`align ${t} not supported, with the orientation ${this._orientation}, the valid values are ${de.getAllowedAligns(this._orientation.opposite)}`);const s=de.alignToInternal(this._orientation.opposite,t);assert&&assert(s===null||s instanceof de),this._align!==s&&(this._align=s,this.changedEmitter.emit())}get stretch(){return this._stretch}set stretch(t){this._stretch!==t&&(this._stretch=t,this.changedEmitter.emit())}get grow(){return this._grow}set grow(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)&&t>=0),this._grow!==t&&(this._grow=t,this.changedEmitter.emit())}});d.register("FlowConfigurable",ph);const $f=[...uh,"isSeparator"];class Ou extends ph(qn){constructor(e,t,s){super(e,t,s),this.size=0,this._isSeparator=!1,this.flowConstraint=e,this.orientation=e.orientation,this.onLayoutOptionsChange()}get effectiveAlign(){return this._align!==null?this._align:this.flowConstraint._align}get effectiveStretch(){return this._stretch!==null?this._stretch:this.flowConstraint._stretch}get effectiveGrow(){return this._grow!==null?this._grow:this.flowConstraint._grow}onLayoutOptionsChange(){this.node.layoutOptions&&this.setOptions(this.node.layoutOptions),super.onLayoutOptionsChange()}setOptions(e){const t=E()({isSeparator:!1},e);assert&&Object.keys(t).forEach(s=>{assert&&assert($f.includes(s),`Cannot provide key ${s} to a FlowCell's layoutOptions. Perhaps this is a Grid-style layout option?`)}),this._isSeparator=t.isSeparator,this.setConfigToInherit(),this.mutateConfigurable(t)}}d.register("FlowCell",Ou);const In=class In extends lh{constructor(e,t){super(),this.initialize(e,t)}initialize(e,t){return this.orientation=e,this.cells=t,this.initializeLayoutLine(),this}getMinimumSize(e){return(this.cells.length-1)*e+_.sum(this.cells.map(t=>t.getMinimumSize(this.orientation)))}freeToPool(){In.pool.freeToPool(this)}clean(){this.cells.length=0,this.freeToPool()}};In.pool=new nt(In,{defaultArguments:[M.HORIZONTAL,[]]});let Ti=In;d.register("FlowLine",Ti);const Mu=[...uh,"spacing","lineSpacing","justify","justifyLines","wrap","excludeInvisible"];class Jr extends ph(ch){constructor(e,t){super(e,t),this.cells=[],this._justify=ye.SPACE_BETWEEN,this._justifyLines=null,this._wrap=!1,this._spacing=0,this._lineSpacing=0,this.displayedCells=[],this.setConfigToBaseDefault(),this.mutateConfigurable(t),Yn(this,Mu,t),this.changedEmitter.addListener(this._updateLayoutListener),this.orientationChangedEmitter.addListener(()=>this.cells.forEach(s=>{s.orientation=this.orientation}))}updateSeparatorVisibility(){let e=0;for(;e<this.cells.length;e++){const s=this.cells[e];if(s._isSeparator)s.node.visible=!1;else if(s.node.visible)break}let t=!1;for(let s=this.cells.length-1;s>e;s--){const i=this.cells[s];i._isSeparator?(i.node.visible=t,t=!1):i.node.visible&&(t=!0)}}layout(){super.layout();const e=this._orientation,t=this._orientation.opposite;this.updateSeparatorVisibility();const s=this.filterLayoutCells(this.cells);if(this.displayedCells=s,!s.length){this.layoutBoundsProperty.value=w.NOTHING,this.minimumWidthProperty.value=null,this.minimumHeightProperty.value=null;return}let i=this.getPreferredProperty(e).value;const n=this.getPreferredProperty(t).value,a=Math.max(...s.map(k=>k.getMinimumSize(e)||0));a>(i||Number.POSITIVE_INFINITY)&&(i=a);const o=[];if(this.wrap){let k=[],Se=i||Number.POSITIVE_INFINITY;for(;s.length;){const Ye=s.shift(),et=Ye.getMinimumSize(e);k.length===0?(k.push(Ye),Se-=et):this.spacing+et<=Se+1e-7?(k.push(Ye),Se-=this.spacing+et):(o.push(Ti.pool.create(e,k)),Se=i||Number.POSITIVE_INFINITY,k=[Ye],Se-=et)}k.length&&o.push(Ti.pool.create(e,k))}else o.push(Ti.pool.create(e,s));o.forEach(k=>{k.cells.forEach(Se=>{if(k.min=Math.max(k.min,Se.getMinimumSize(t)),k.max=Math.min(k.max,Se.getMaximumSize(t)),Se.effectiveAlign===de.ORIGIN){const Ye=Se.getOriginBounds();k.minOrigin=Math.min(Ye[t.minCoordinate],k.minOrigin),k.maxOrigin=Math.max(Ye[t.maxCoordinate],k.maxOrigin)}}),isFinite(k.minOrigin)&&isFinite(k.maxOrigin)?k.size=Math.max(k.min,k.maxOrigin-k.minOrigin):k.size=k.min});const h=Math.max(...o.map(k=>k.getMinimumSize(this.spacing))),l=_.sum(o.map(k=>k.size))+(o.length-1)*this.lineSpacing,c=this.wrap?a:h,u=Math.max(h,i||0),m=Math.max(l,n||0),b=this.layoutOriginProperty.value[e.coordinate],y=this.layoutOriginProperty.value[e.opposite.coordinate];o.forEach(k=>{const Se=_.sum(k.cells.map(we=>we.getMinimumSize(e))),Ye=this.spacing*(k.cells.length-1);let et=u-Se-Ye;k.cells.forEach(we=>{we.size=we.getMinimumSize(e)});let rt;for(;et>1e-7&&(rt=k.cells.filter(we=>we.effectiveGrow!==0&&we.size<we.getMaximumSize(e)-1e-7)).length;){const we=_.sum(rt.map(It=>It.effectiveGrow)),Jt=Math.min(Math.min(...rt.map(It=>(It.getMaximumSize(e)-It.size)/It.effectiveGrow)),et/we);assert&&assert(Jt>1e-11),rt.forEach(It=>{It.size+=Jt*It.effectiveGrow}),et-=Jt*we}k.cells.forEach(we=>we.attemptPreferredSize(e,we.size));const oi=this._justify.spacingFunctionFactory(et,k.cells.length);let Zt=b;k.cells.forEach((we,Jt)=>{Zt+=oi(Jt),Jt>0&&(Zt+=this.spacing),we.positionStart(e,Zt),we.lastAvailableBounds[e.minCoordinate]=Zt,we.lastAvailableBounds[e.maxCoordinate]=Zt+we.size,Zt+=we.size,assert&&assert(this.spacing>=0||we.size>=-this.spacing-1e-7,"Negative spacing more than a cell's size causes issues with layout")})});const f=m-l,L=(o[0].hasOrigin()?o[0].minOrigin:0)+y;let v=L;if(this._justifyLines===null)o.forEach(k=>{k.size+=f/o.length}),o.forEach(k=>{k.position=v,v+=k.size+this.lineSpacing});else{const k=this._justifyLines.spacingFunctionFactory(f,o.length);o.forEach((Se,Ye)=>{v+=k(Ye),Se.position=v,v+=Se.size+this.lineSpacing})}o.forEach(k=>k.cells.forEach(Se=>{Se.reposition(t,k.size,k.position,Se.effectiveStretch,-k.minOrigin,Se.effectiveAlign)}));const S=b,B=b+u,ce=L,fe=L+m;this.layoutBoundsProperty.value=w.oriented(e,S,ce,B,fe),this.minimumWidthProperty.value=e===M.HORIZONTAL?c:l,this.minimumHeightProperty.value=e===M.HORIZONTAL?l:c,this.finishedLayoutEmitter.emit(),o.forEach(k=>k.clean())}get justify(){const e=ye.internalToJustify(this._orientation,this._justify);return assert&&assert(ye.getAllowedJustificationValues(this._orientation).includes(e)),e}set justify(e){assert&&assert(ye.getAllowedJustificationValues(this._orientation).includes(e),`justify ${e} not supported, with the orientation ${this._orientation}, the valid values are ${ye.getAllowedJustificationValues(this._orientation)}`);const t=ye.justifyToInternal(this._orientation,e);this._justify!==t&&(this._justify=t,this.updateLayoutAutomatically())}get justifyLines(){if(this._justifyLines===null)return null;{const e=ye.internalToJustify(this._orientation,this._justifyLines);return assert&&assert(ye.getAllowedJustificationValues(this._orientation).includes(e)),e}}set justifyLines(e){assert&&assert(e===null||ye.getAllowedJustificationValues(this._orientation.opposite).includes(e),`justify ${e} not supported, with the orientation ${this._orientation.opposite}, the valid values are ${ye.getAllowedJustificationValues(this._orientation.opposite)} or null`);const t=e===null?null:ye.justifyToInternal(this._orientation.opposite,e);assert&&assert(t===null||t instanceof ye),this._justifyLines!==t&&(this._justifyLines=t,this.updateLayoutAutomatically())}get wrap(){return this._wrap}set wrap(e){this._wrap!==e&&(this._wrap=e,this.updateLayoutAutomatically())}get spacing(){return this._spacing}set spacing(e){assert&&assert(isFinite(e)),this._spacing!==e&&(this._spacing=e,this.updateLayoutAutomatically())}get lineSpacing(){return this._lineSpacing}set lineSpacing(e){assert&&assert(isFinite(e)),this._lineSpacing!==e&&(this._lineSpacing=e,this.updateLayoutAutomatically())}insertCell(e,t){assert&&assert(e>=0),assert&&assert(e<=this.cells.length),assert&&assert(!_.includes(this.cells,t)),t.orientation=this.orientation,this.cells.splice(e,0,t),this.addNode(t.node),t.changedEmitter.addListener(this._updateLayoutListener),this.updateLayoutAutomatically()}removeCell(e){assert&&assert(_.includes(this.cells,e)),Tt(this.cells,e),this.removeNode(e.node),e.changedEmitter.removeListener(this._updateLayoutListener),this.updateLayoutAutomatically()}reorderCells(e,t,s){this.cells.splice(t,s-t+1,...e),this.updateLayoutAutomatically()}getPreferredProperty(e){return e===M.HORIZONTAL?this.preferredWidthProperty:this.preferredHeightProperty}dispose(){this.lock(),this.cells.forEach(e=>this.removeCell(e)),this.displayedCells=[],super.dispose(),this.unlock()}static create(e,t){return new Jr(e,t)}}d.register("FlowConstraint",Jr);const Uf=[...Au,...Mu.filter(r=>r!=="excludeInvisible")],en={orientation:"horizontal",spacing:0,align:"center",stretch:!1},Qh=class Qh extends hh{constructor(e){const t=E()({excludeInvisibleChildrenFromBounds:!0,resize:!0,disabledOpacity:Ds.DISABLED_OPACITY},e);super(),this._cellMap=new Map,this._constraint=new Jr(this,{preferredWidthProperty:this.localPreferredWidthProperty,preferredHeightProperty:this.localPreferredHeightProperty,minimumWidthProperty:this.localMinimumWidthProperty,minimumHeightProperty:this.localMinimumHeightProperty,layoutOriginProperty:this.layoutOriginProperty,orientation:en.orientation,spacing:en.spacing,align:en.align,stretch:en.stretch,excludeInvisible:!1}),this.onChildInserted=this.onFlowBoxChildInserted.bind(this),this.onChildRemoved=this.onFlowBoxChildRemoved.bind(this),this.onChildrenReordered=this.onFlowBoxChildrenReordered.bind(this),this.onChildrenChanged=this.onFlowBoxChildrenChanged.bind(this),this.childInsertedEmitter.addListener(this.onChildInserted),this.childRemovedEmitter.addListener(this.onChildRemoved),this.childrenReorderedEmitter.addListener(this.onChildrenReordered),this.childrenChangedEmitter.addListener(this.onChildrenChanged);const s=_.omit(t,cs),i=_.pick(t,cs);this._constraint.lock(),this.mutate(s),this._constraint.unlock(),this._constraint.updateLayout(),this.mutate(i),this.linkLayoutBounds()}onFlowBoxChildInserted(e,t){const s=new Ou(this._constraint,e,this._constraint.createLayoutProxy(e));this._cellMap.set(e,s),this._constraint.insertCell(t,s)}onFlowBoxChildRemoved(e){const t=this._cellMap.get(e);assert&&assert(t),this._cellMap.delete(e),this._constraint.removeCell(t),t.dispose()}onFlowBoxChildrenReordered(e,t){this._constraint.reorderCells(this._children.slice(e,t+1).map(s=>this._cellMap.get(s)),e,t)}onFlowBoxChildrenChanged(){this._constraint.updateLayoutAutomatically()}getCell(e){const t=this._cellMap.get(e);return assert&&assert(t),t}get orientation(){return this._constraint.orientation}set orientation(e){this._constraint.orientation=e}get spacing(){return this._constraint.spacing}set spacing(e){this._constraint.spacing=e}get lineSpacing(){return this._constraint.lineSpacing}set lineSpacing(e){this._constraint.lineSpacing=e}get justify(){return this._constraint.justify}set justify(e){this._constraint.justify=e}get justifyLines(){return this._constraint.justifyLines}set justifyLines(e){this._constraint.justifyLines=e}get wrap(){return this._constraint.wrap}set wrap(e){this._constraint.wrap=e}get align(){return assert&&assert(typeof this._constraint.align=="string"),this._constraint.align}set align(e){this._constraint.align=e}get stretch(){return assert&&assert(typeof this._constraint.stretch=="boolean"),this._constraint.stretch}set stretch(e){this._constraint.stretch=e}get grow(){return this._constraint.grow}set grow(e){this._constraint.grow=e}get margin(){return this._constraint.margin}set margin(e){this._constraint.margin=e}get xMargin(){return this._constraint.xMargin}set xMargin(e){this._constraint.xMargin=e}get yMargin(){return this._constraint.yMargin}set yMargin(e){this._constraint.yMargin=e}get leftMargin(){return this._constraint.leftMargin}set leftMargin(e){this._constraint.leftMargin=e}get rightMargin(){return this._constraint.rightMargin}set rightMargin(e){this._constraint.rightMargin=e}get topMargin(){return this._constraint.topMargin}set topMargin(e){this._constraint.topMargin=e}get bottomMargin(){return this._constraint.bottomMargin}set bottomMargin(e){this._constraint.bottomMargin=e}get minContentWidth(){return this._constraint.minContentWidth}set minContentWidth(e){this._constraint.minContentWidth=e}get minContentHeight(){return this._constraint.minContentHeight}set minContentHeight(e){this._constraint.minContentHeight=e}get maxContentWidth(){return this._constraint.maxContentWidth}set maxContentWidth(e){this._constraint.maxContentWidth=e}get maxContentHeight(){return this._constraint.maxContentHeight}set maxContentHeight(e){this._constraint.maxContentHeight=e}dispose(){this._constraint.lock(),this.childInsertedEmitter.removeListener(this.onChildInserted),this.childRemovedEmitter.removeListener(this.onChildRemoved),this.childrenReorderedEmitter.removeListener(this.onChildrenReordered),this.childrenChangedEmitter.removeListener(this.onChildrenChanged);for(const e of this._cellMap.values())e.dispose();super.dispose()}setOrientation(e){return this.orientation=e,this}getOrientation(){return this.orientation}setSpacing(e){return this.spacing=e,this}getSpacing(){return this.spacing}setAlign(e){return this.align=e,this}getAlign(){return this.align}setResize(e){return this.resize=e,this}isResize(){return this.resize}getHelperNode(){return qn.createHelperNode(this.constraint.displayedCells,this.constraint.layoutBoundsProperty.value,t=>{let s="";const i=M.fromLayoutOrientation(t.orientation);return s+=`align: ${de.internalToAlign(i,t.effectiveAlign)}
`,s+=`stretch: ${t.effectiveStretch}
`,s+=`grow: ${t.effectiveGrow}
`,s})}mutate(e){return super.mutate(e)}};Qh.DEFAULT_FLOW_BOX_OPTIONS=en;let Ri=Qh;Ri.prototype._mutatorKeys=[...zd,...Uf,...D.prototype._mutatorKeys];d.register("FlowBox",Ri);const gh=["xAlign","yAlign","stretch","xStretch","yStretch","grow","xGrow","yGrow"].concat(xu),mh=Me(r=>class extends dh(r){constructor(...t){super(...t),this._xAlign=null,this._yAlign=null,this._xStretch=null,this._yStretch=null,this._xGrow=null,this._yGrow=null}mutateConfigurable(t){super.mutateConfigurable(t),Ge(t,["stretch"],["xStretch","yStretch"]),Ge(t,["grow"],["xGrow","yGrow"]),Yn(this,gh,t)}setConfigToBaseDefault(){this._xAlign=de.CENTER,this._yAlign=de.CENTER,this._xStretch=!1,this._yStretch=!1,this._xGrow=0,this._yGrow=0,super.setConfigToBaseDefault()}setConfigToInherit(){this._xAlign=null,this._yAlign=null,this._xStretch=null,this._yStretch=null,this._xGrow=null,this._yGrow=null,super.setConfigToInherit()}get xAlign(){const t=this._xAlign===null?null:this._xAlign.horizontal;return assert&&assert(t===null||typeof t=="string"),t}set xAlign(t){assert&&assert(t===null||To.includes(t),`align ${t} not supported, the valid values are ${To} or null`);const s=de.horizontalAlignToInternal(t);assert&&assert(s===null||s instanceof de),this._xAlign!==s&&(this._xAlign=s,this.changedEmitter.emit())}get yAlign(){const t=this._yAlign===null?null:this._yAlign.vertical;return assert&&assert(t===null||typeof t=="string"),t}set yAlign(t){assert&&assert(t===null||Co.includes(t),`align ${t} not supported, the valid values are ${Co} or null`);const s=de.verticalAlignToInternal(t);assert&&assert(s===null||s instanceof de),this._yAlign!==s&&(this._yAlign=s,this.changedEmitter.emit())}get grow(){return assert&&assert(this._xGrow===this._yGrow),this._xGrow}set grow(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)&&t>=0),(this._xGrow!==t||this._yGrow!==t)&&(this._xGrow=t,this._yGrow=t,this.changedEmitter.emit())}get xGrow(){return this._xGrow}set xGrow(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)&&t>=0),this._xGrow!==t&&(this._xGrow=t,this.changedEmitter.emit())}get yGrow(){return this._yGrow}set yGrow(t){assert&&assert(t===null||typeof t=="number"&&isFinite(t)&&t>=0),this._yGrow!==t&&(this._yGrow=t,this.changedEmitter.emit())}get stretch(){return assert&&assert(this._xStretch===this._yStretch),this._xStretch}set stretch(t){assert&&assert(t===null||typeof t=="boolean"),(this._xStretch!==t||this._yStretch!==t)&&(this._xStretch=t,this._yStretch=t,this.changedEmitter.emit())}get xStretch(){return this._xStretch}set xStretch(t){assert&&assert(t===null||typeof t=="boolean"),this._xStretch!==t&&(this._xStretch=t,this.changedEmitter.emit())}get yStretch(){return this._yStretch}set yStretch(t){assert&&assert(t===null||typeof t=="boolean"),this._yStretch!==t&&(this._yStretch=t,this.changedEmitter.emit())}});d.register("GridConfigurable",mh);const Yf=[...gh,"row","column","horizontalSpan","verticalSpan"];class Ru extends mh(qn){constructor(e,t,s){super(e,t,s),this.gridConstraint=e,this.setOptions(t.layoutOptions),this.onLayoutOptionsChange()}get effectiveXAlign(){return this._xAlign!==null?this._xAlign:this.gridConstraint._xAlign}get effectiveYAlign(){return this._yAlign!==null?this._yAlign:this.gridConstraint._yAlign}getEffectiveAlign(e){return e===M.HORIZONTAL?this.effectiveXAlign:this.effectiveYAlign}get effectiveXGrow(){return this._xGrow!==null?this._xGrow:this.gridConstraint._xGrow}get effectiveYGrow(){return this._yGrow!==null?this._yGrow:this.gridConstraint._yGrow}getEffectiveGrow(e){return e===M.HORIZONTAL?this.effectiveXGrow:this.effectiveYGrow}get effectiveXStretch(){return this._xStretch!==null?this._xStretch:this.gridConstraint._xStretch}get effectiveYStretch(){return this._yStretch!==null?this._yStretch:this.gridConstraint._yStretch}getEffectiveStretch(e){return e===M.HORIZONTAL?this.effectiveXStretch:this.effectiveYStretch}onLayoutOptionsChange(){this.setOptions(this.node.layoutOptions),super.onLayoutOptionsChange()}setOptions(e){const t=E()({column:0,row:0,horizontalSpan:1,verticalSpan:1},e);assert&&Object.keys(t).forEach(s=>{assert&&assert(Yf.includes(s),`Cannot provide key ${s} to a GridCell's layoutOptions. Perhaps this is a Flow-style layout option?`)}),assert&&assert(typeof t.column=="number"&&Number.isInteger(t.column)&&isFinite(t.column)&&t.column>=0),assert&&assert(typeof t.row=="number"&&Number.isInteger(t.row)&&isFinite(t.row)&&t.row>=0),assert&&assert(typeof t.horizontalSpan=="number"&&Number.isInteger(t.horizontalSpan)&&isFinite(t.horizontalSpan)&&t.horizontalSpan>=1),assert&&assert(typeof t.verticalSpan=="number"&&Number.isInteger(t.verticalSpan)&&isFinite(t.verticalSpan)&&t.verticalSpan>=1),this.setConfigToInherit(),this.position=new Us(t.column,t.row),this.size=new Us(t.horizontalSpan,t.verticalSpan),this.mutateConfigurable(t)}containsIndex(e,t){const s=this.position.get(e),i=this.size.get(e);return t>=s&&t<s+i}containsRow(e){return this.containsIndex(M.VERTICAL,e)}containsColumn(e){return this.containsIndex(M.HORIZONTAL,e)}getIndices(e){const t=this.position.get(e),s=this.size.get(e);return _.range(t,t+s)}}d.register("GridCell",Ru);const En=class En extends lh{constructor(e,t,s){super(),this.initialize(e,t,s)}initialize(e,t,s){return this.index=e,this.cells=t,this.grow=s,this.initializeLayoutLine(),this}freeToPool(){En.pool.freeToPool(this)}clean(){this.cells.length=0,this.freeToPool()}};En.pool=new nt(En,{defaultArguments:[0,[],0]});let Tr=En;d.register("GridLine",Tr);const Nu=[...gh,"excludeInvisible","spacing","xSpacing","ySpacing"];class ea extends mh(ch){constructor(e,t){super(e,t),this.cells=new Set,this.displayedCells=[],this.displayedLines=new Us(new Map,new Map),this._spacing=new Us(0,0),this.setConfigToBaseDefault(),this.mutateConfigurable(t),Yn(this,Nu,t),this.changedEmitter.addListener(this._updateLayoutListener)}layout(){super.layout();const e=this.filterLayoutCells([...this.cells]);if(this.displayedCells=e,!e.length){this.layoutBoundsProperty.value=w.NOTHING,this.minimumWidthProperty.value=null,this.minimumHeightProperty.value=null,this.displayedLines.forEach(n=>n.clear());return}const t=new Us(0,0),s=new Us(this.preferredWidthProperty.value,this.preferredHeightProperty.value),i=new w(0,0,0,0);[M.HORIZONTAL,M.VERTICAL].forEach(n=>{const a=this._spacing.get(n),o=this.displayedLines.get(n);o.forEach(L=>L.clean()),o.clear();const l=_.sortedUniq(_.sortBy(_.flatten(e.map(L=>L.getIndices(n))))).map(L=>{const v=_.filter(e,ce=>ce.containsIndex(n,L)),S=Math.max(...v.map(ce=>ce.getEffectiveGrow(n))),B=Tr.pool.create(L,v,S);return o.set(L,B),B}),c=l.slice(0,-1).map(L=>typeof a=="number"?a:a[L.index]);e.forEach(L=>{if(L.size.get(n)===1){const v=o.get(L.position.get(n));if(v.min=Math.max(v.min,L.getMinimumSize(n)),v.max=Math.min(v.max,L.getMaximumSize(n)),L.getEffectiveAlign(n)===de.ORIGIN){const S=L.getOriginBounds();v.minOrigin=Math.min(S[n.minCoordinate],v.minOrigin),v.maxOrigin=Math.max(S[n.maxCoordinate],v.maxOrigin)}}}),e.forEach(L=>{if(L.size.get(n)>1){assert&&assert(L.getEffectiveAlign(n)!==de.ORIGIN,"origin alignment cannot be specified for cells that span >1 width or height");const v=L.getIndices(n).map(ce=>o.get(ce)),S=_.sum(v.map(ce=>ce.min)),B=L.getMinimumSize(n);if(B>S){const ce=(B-S)/v.length;v.forEach(fe=>{fe.min+=ce})}}}),l.forEach(L=>{L.hasOrigin()?L.size=Math.max(L.min,L.maxOrigin-L.minOrigin):L.size=L.min});const u=_.sum(l.map(L=>L.size))+_.sum(c);t.set(n,u);const m=Math.max(u,s.get(n)||0);let b=m-u,y;for(;b>1e-7&&(y=l.filter(L=>L.grow>0&&L.size<L.max-1e-7)).length;){const L=_.sum(y.map(S=>S.grow)),v=Math.min(Math.min(...y.map(S=>(S.max-S.size)/S.grow)),b/L);assert&&assert(v>1e-11),y.forEach(S=>{S.size+=v*S.grow}),b-=v*L}const f=(l[0].hasOrigin()?l[0].minOrigin:0)+this.layoutOriginProperty.value[n.coordinate];i[n.minCoordinate]=f,i[n.maxCoordinate]=f+m,l.forEach((L,v)=>{const S=_.sum(l.slice(0,v).map(ce=>ce.size)),B=_.sum(c.slice(0,v));L.position=f+S+B}),e.forEach(L=>{const v=L.position.get(n),S=L.size.get(n),B=v+S-1,ce=L.getIndices(n).map(rt=>o.get(rt)),fe=o.get(v);let k=0;v!==B&&l.slice(0,-1).forEach((rt,oi)=>{rt.index>=v&&rt.index<B&&(k+=c[oi])});const Se=_.sum(ce.map(rt=>rt.size))+k,Ye=fe.position,et=L.reposition(n,Se,Ye,L.getEffectiveStretch(n),-fe.minOrigin,L.getEffectiveAlign(n));i[n.minCoordinate]=Math.min(i[n.minCoordinate],et[n.minCoordinate]),i[n.maxCoordinate]=Math.max(i[n.maxCoordinate],et[n.maxCoordinate])})}),this.layoutBoundsProperty.value=i,this.minimumWidthProperty.value=t.horizontal,this.minimumHeightProperty.value=t.vertical,this.finishedLayoutEmitter.emit()}get spacing(){return assert&&assert(this.xSpacing===this.ySpacing),this.xSpacing}set spacing(e){assert&&assert(typeof e=="number"&&isFinite(e)&&e>=0||Array.isArray(e)&&_.every(e,t=>typeof t=="number"&&isFinite(t)&&t>=0)),(this._spacing.get(M.HORIZONTAL)!==e||this._spacing.get(M.VERTICAL)!==e)&&(this._spacing.set(M.HORIZONTAL,e),this._spacing.set(M.VERTICAL,e),this.updateLayoutAutomatically())}get xSpacing(){return this._spacing.get(M.HORIZONTAL)}set xSpacing(e){assert&&assert(typeof e=="number"&&isFinite(e)&&e>=0||Array.isArray(e)&&_.every(e,t=>typeof t=="number"&&isFinite(t)&&t>=0)),this._spacing.get(M.HORIZONTAL)!==e&&(this._spacing.set(M.HORIZONTAL,e),this.updateLayoutAutomatically())}get ySpacing(){return this._spacing.get(M.VERTICAL)}set ySpacing(e){assert&&assert(typeof e=="number"&&isFinite(e)&&e>=0||Array.isArray(e)&&_.every(e,t=>typeof t=="number"&&isFinite(t)&&t>=0)),this._spacing.get(M.VERTICAL)!==e&&(this._spacing.set(M.VERTICAL,e),this.updateLayoutAutomatically())}addCell(e){assert&&assert(!this.cells.has(e)),this.cells.add(e),this.addNode(e.node),e.changedEmitter.addListener(this._updateLayoutListener),this.updateLayoutAutomatically()}removeCell(e){assert&&assert(this.cells.has(e)),this.cells.delete(e),this.removeNode(e.node),e.changedEmitter.removeListener(this._updateLayoutListener),this.updateLayoutAutomatically()}dispose(){this.lock(),[...this.cells].forEach(e=>this.removeCell(e)),this.displayedLines.forEach(e=>e.clear()),this.displayedCells=[],super.dispose(),this.unlock()}getIndices(e){const t=[];return this.cells.forEach(s=>{t.push(...s.getIndices(e))}),_.sortedUniq(_.sortBy(t))}getCell(e,t){return _.find([...this.cells],s=>s.containsRow(e)&&s.containsColumn(t))||null}getCellFromNode(e){return _.find([...this.cells],t=>t.node===e)||null}getCells(e,t){return _.filter([...this.cells],s=>s.containsIndex(e,t))}static create(e,t){return new ea(e,t)}}d.register("GridConstraint",ea);const Kf=[...Au,...Nu.filter(r=>r!=="excludeInvisible"),"rows","columns","autoRows","autoColumns"];class Bu extends hh{constructor(e){const t=E()({excludeInvisibleChildrenFromBounds:!0,resize:!0},e);super(),this._cellMap=new Map,this._autoRows=null,this._autoColumns=null,this._autoLockCount=0,this._constraint=new ea(this,{preferredWidthProperty:this.localPreferredWidthProperty,preferredHeightProperty:this.localPreferredHeightProperty,minimumWidthProperty:this.localMinimumWidthProperty,minimumHeightProperty:this.localMinimumHeightProperty,layoutOriginProperty:this.layoutOriginProperty,excludeInvisible:!1}),this.onChildInserted=this.onGridBoxChildInserted.bind(this),this.onChildRemoved=this.onGridBoxChildRemoved.bind(this),this.onChildVisibilityToggled=this.updateAllAutoLines.bind(this),this.childInsertedEmitter.addListener(this.onChildInserted),this.childRemovedEmitter.addListener(this.onChildRemoved);const s=_.omit(t,cs),i=_.pick(t,cs);this._constraint.lock(),this.mutate(s),this._constraint.unlock(),this._constraint.updateLayout(),this.mutate(i),this.linkLayoutBounds()}setLines(e,t){const s=[];for(let i=0;i<t.length;i++){const n=t[i];for(let a=0;a<n.length;a++){const o=n[a];o!==null&&(s.push(o),o.mutateLayoutOptions({[e.line]:i,[e.opposite.line]:a}))}}this.children=s}getLines(e){const t=[];for(const s of this._cellMap.values()){const i=s.position.get(e),n=s.position.get(e.opposite);for(;t.length<i+1;)t.push([]);for(;t[i].length<n+1;)t[i].push(null);t[i][n]=s.node}return t}set rows(e){this.setLines(M.VERTICAL,e)}get rows(){return this.getLines(M.VERTICAL)}set columns(e){this.setLines(M.HORIZONTAL,e)}get columns(){return this.getLines(M.HORIZONTAL)}getNodeAt(e,t){const s=this.constraint.getCell(e,t);return s?s.node:null}getRowOfNode(e){return assert&&assert(this.children.includes(e)),this.constraint.getCellFromNode(e).position.vertical}getColumnOfNode(e){return assert&&assert(this.children.includes(e)),this.constraint.getCellFromNode(e).position.horizontal}getNodesInRow(e){return this.constraint.getCells(M.VERTICAL,e).map(t=>t.node)}getNodesInColumn(e){return this.constraint.getCells(M.HORIZONTAL,e).map(t=>t.node)}addRow(e){return this.rows=[...this.rows,e],this}addColumn(e){return this.columns=[...this.columns,e],this}insertRow(e,t){return this.rows=[...this.rows.slice(0,e),t,...this.rows.slice(e)],this}insertColumn(e,t){return this.columns=[...this.columns.slice(0,e),t,...this.columns.slice(e)],this}removeRow(e){return this.rows=[...this.rows.slice(0,e),...this.rows.slice(e+1)],this}removeColumn(e){return this.columns=[...this.columns.slice(0,e),...this.columns.slice(e+1)],this}set autoRows(e){assert&&assert(e===null||typeof e=="number"&&isFinite(e)&&e>=1),this._autoRows!==e&&(this._autoRows=e,this.updateAutoRows())}get autoRows(){return this._autoRows}set autoColumns(e){assert&&assert(e===null||typeof e=="number"&&isFinite(e)&&e>=1),this._autoColumns!==e&&(this._autoColumns=e,this.updateAutoColumns())}get autoColumns(){return this._autoColumns}updateAutoLines(e,t){if(t!==null&&this._autoLockCount===0){let s=0;this.constraint.lock(),this.children.filter(i=>i.bounds.isValid()&&(!this._constraint.excludeInvisible||i.visible)).forEach((i,n)=>{const a=n%t,o=Math.floor(n/t);(!i.layoutOptions||i.layoutOptions[e.line]!==a||i.layoutOptions[e.opposite.line]!==o||i.layoutOptions.horizontalSpan!==1||i.layoutOptions.verticalSpan!==1)&&(s++,i.mutateLayoutOptions({[e.line]:n%t,[e.opposite.line]:Math.floor(n/t),horizontalSpan:1,verticalSpan:1}))}),this.constraint.unlock(),s>0&&this.constraint.updateLayoutAutomatically()}}updateAutoRows(){this.updateAutoLines(M.VERTICAL,this.autoRows)}updateAutoColumns(){this.updateAutoLines(M.HORIZONTAL,this.autoColumns)}updateAllAutoLines(){assert&&assert(this._autoRows===null||this._autoColumns===null,"autoRows and autoColumns should not both be set when updating children"),this.updateAutoRows(),this.updateAutoColumns()}setChildren(e){const t=this.getChildren();return this._autoLockCount++,super.setChildren(e),this._autoLockCount--,_.isEqual(t,e)||this.updateAllAutoLines(),this}onGridBoxChildInserted(e,t){e.visibleProperty.lazyLink(this.onChildVisibilityToggled);const s=new Ru(this._constraint,e,this._constraint.createLayoutProxy(e));this._cellMap.set(e,s),this._constraint.addCell(s),this.updateAllAutoLines()}onGridBoxChildRemoved(e){const t=this._cellMap.get(e);assert&&assert(t),this._cellMap.delete(e),this._constraint.removeCell(t),t.dispose(),this.updateAllAutoLines(),e.visibleProperty.unlink(this.onChildVisibilityToggled)}mutate(e){return Ge(e,["rows"],["columns"],["children","autoRows","autoColumns"]),e&&assert&&assert(typeof e.autoRows!="number"||typeof e.autoColumns!="number","autoRows and autoColumns should not be specified both as non-null at the same time"),super.mutate(e)}get spacing(){return this._constraint.spacing}set spacing(e){this._constraint.spacing=e}get xSpacing(){return this._constraint.xSpacing}set xSpacing(e){this._constraint.xSpacing=e}get ySpacing(){return this._constraint.ySpacing}set ySpacing(e){this._constraint.ySpacing=e}get xAlign(){return this._constraint.xAlign}set xAlign(e){this._constraint.xAlign=e}get yAlign(){return this._constraint.yAlign}set yAlign(e){this._constraint.yAlign=e}get grow(){return this._constraint.grow}set grow(e){this._constraint.grow=e}get xGrow(){return this._constraint.xGrow}set xGrow(e){this._constraint.xGrow=e}get yGrow(){return this._constraint.yGrow}set yGrow(e){this._constraint.yGrow=e}get stretch(){return this._constraint.stretch}set stretch(e){this._constraint.stretch=e}get xStretch(){return this._constraint.xStretch}set xStretch(e){this._constraint.xStretch=e}get yStretch(){return this._constraint.yStretch}set yStretch(e){this._constraint.yStretch=e}get margin(){return this._constraint.margin}set margin(e){this._constraint.margin=e}get xMargin(){return this._constraint.xMargin}set xMargin(e){this._constraint.xMargin=e}get yMargin(){return this._constraint.yMargin}set yMargin(e){this._constraint.yMargin=e}get leftMargin(){return this._constraint.leftMargin}set leftMargin(e){this._constraint.leftMargin=e}get rightMargin(){return this._constraint.rightMargin}set rightMargin(e){this._constraint.rightMargin=e}get topMargin(){return this._constraint.topMargin}set topMargin(e){this._constraint.topMargin=e}get bottomMargin(){return this._constraint.bottomMargin}set bottomMargin(e){this._constraint.bottomMargin=e}get minContentWidth(){return this._constraint.minContentWidth}set minContentWidth(e){this._constraint.minContentWidth=e}get minContentHeight(){return this._constraint.minContentHeight}set minContentHeight(e){this._constraint.minContentHeight=e}get maxContentWidth(){return this._constraint.maxContentWidth}set maxContentWidth(e){this._constraint.maxContentWidth=e}get maxContentHeight(){return this._constraint.maxContentHeight}set maxContentHeight(e){this._constraint.maxContentHeight=e}setExcludeInvisibleChildrenFromBounds(e){super.setExcludeInvisibleChildrenFromBounds(e),this.updateAllAutoLines()}dispose(){this._constraint.lock(),this.childInsertedEmitter.removeListener(this.onChildInserted),this.childRemovedEmitter.removeListener(this.onChildRemoved);for(const e of this._cellMap.values())e.dispose(),e.node.visibleProperty.unlink(this.onChildVisibilityToggled);super.dispose()}getHelperNode(){return qn.createHelperNode(this.constraint.displayedCells,this.constraint.layoutBoundsProperty.value,t=>{let s="";return s+=`row: ${t.position.vertical}
`,s+=`column: ${t.position.horizontal}
`,t.size.horizontal>1&&(s+=`horizontalSpan: ${t.size.horizontal}
`),t.size.vertical>1&&(s+=`verticalSpan: ${t.size.vertical}
`),s+=`xAlign: ${de.internalToAlign(M.HORIZONTAL,t.effectiveXAlign)}
`,s+=`yAlign: ${de.internalToAlign(M.VERTICAL,t.effectiveYAlign)}
`,s+=`xStretch: ${t.effectiveXStretch}
`,s+=`yStretch: ${t.effectiveYStretch}
`,s+=`xGrow: ${t.effectiveXGrow}
`,s+=`yGrow: ${t.effectiveYGrow}
`,s})}}Bu.prototype._mutatorKeys=[...zd,...Kf,...D.prototype._mutatorKeys];d.register("GridBox",Bu);class Xf extends D{constructor(e,t){Ge(t,["createCellBackground"],["fill","stroke"]);const s=n=>De.bounds(n.lastAvailableBounds,{fill:i.fill,stroke:i.stroke}),i=E()({fill:"white",stroke:"black",createCellBackground:s},t);super(),this.constraint=e,this.createCellBackground=i.createCellBackground,this.layoutListener=this.update.bind(this),this.constraint.finishedLayoutEmitter.addListener(this.layoutListener),this.update(),this.mutate(i)}update(){this.children=this.constraint.displayedCells.map(this.createCellBackground).filter(_.identity)}dispose(){this.constraint.finishedLayoutEmitter.removeListener(this.layoutListener),super.dispose()}}d.register("GridBackgroundNode",Xf);class fh extends jn{constructor(e,t,s){assert&&assert(Array.isArray(t)&&_.every(t,i=>i instanceof D)),super(e),this.lock(),this.nodes=t,this.cells=t.map(i=>new Zr(this,i,null)),this.layoutCallback=s,this.nodes.forEach(i=>this.addNode(i,!1)),this.unlock(),this.updateLayout()}layout(){if(super.layout(),assert&&assert(_.every(this.nodes,t=>!t.isDisposed)),!_.some(this.cells,t=>!t.isConnected())){const t=this.cells.map(s=>s.proxy);this.layoutCallback.apply(null,t),this.finishedLayoutEmitter.emit()}}dispose(){this.cells.forEach(e=>e.dispose()),super.dispose()}static create(e,t,s){return new fh(e,t,s)}}d.register("ManualConstraint",fh);class yh extends jn{constructor(e,t,s){assert&&assert(Array.isArray(t)&&_.every(t,i=>i instanceof D)),super(e),this.lock(),this.nodes=t,this.cells=t.map(i=>new Zr(this,i,null)),this.layoutCallback=s,this.nodes.forEach(i=>this.addNode(i,!1)),this.unlock(),this.updateLayout()}layout(){super.layout(),assert&&assert(_.every(this.nodes,t=>!t.isDisposed));const e=this.cells.map(t=>t.isConnected()?t.proxy:null);this.layoutCallback.apply(null,e),this.finishedLayoutEmitter.emit()}dispose(){this.cells.forEach(e=>e.dispose()),super.dispose()}static create(e,t,s){return new yh(e,t,s)}}d.register("RelaxedManualConstraint",yh);const jf=["alignBounds","xAlign","yAlign","margin","xMargin","yMargin","leftMargin","rightMargin","topMargin","bottomMargin","group"],_c=["left","center","right","stretch"],Sc=["top","center","bottom","stretch"],Fu=Yr(D);class bh extends Fu{constructor(e,t){const s=E()({children:[e]},t),i={sizable:!1};super(i),this._xSet=!1,this._ySet=!1,this._contentBoundsListener=_.noop,assert&&assert(s===void 0||Object.getPrototypeOf(s)===Object.prototype,"Extra prototype on Node options object is a code smell"),this._content=e,this._alignBounds=null,this._xAlign="center",this._yAlign="center",this._leftMargin=0,this._rightMargin=0,this._topMargin=0,this._bottomMargin=0,this._group=null,this._contentBoundsListener=this.invalidateAlignment.bind(this),this._alignBoundsProperty=null,this._alignBoundsPropertyListener=_.noop,Ge(s,["alignBounds"],["alignBoundsProperty"]),t!=null&&t.alignBoundsProperty&&(this._alignBoundsProperty=t.alignBoundsProperty,s.alignBounds=this._alignBoundsProperty.value,this._alignBoundsPropertyListener=n=>{this.alignBounds=n},this._alignBoundsProperty.lazyLink(this._alignBoundsPropertyListener)),this.localBounds=new w(0,0,0,0),this.constraint=new qf(this,e),this._content.boundsProperty.link(this._contentBoundsListener),this.mutate(s),Is.multilink([this.localPreferredWidthProperty,this.localPreferredHeightProperty],(n,a)=>{if(n!==null||a!==null){const o=this._alignBounds||new w(0,0,0,0);n&&(o.minX=0,o.maxX=n,this._xSet=!0),a&&(o.minY=0,o.maxY=a,this._ySet=!0),this._alignBounds=o,this.constraint.updateLayout()}})}invalidateAlignment(){sceneryLog&&sceneryLog.AlignBox&&sceneryLog.AlignBox(`AlignBox#${this.id} invalidateAlignment`),sceneryLog&&sceneryLog.AlignBox&&sceneryLog.push(),this._group&&this._group.onAlignBoxResized(this),this.constraint.updateLayout(),sceneryLog&&sceneryLog.AlignBox&&sceneryLog.pop()}setAlignBounds(e){return assert&&assert(e===null||e instanceof w&&!e.isEmpty()&&e.isFinite(),"alignBounds should be a non-empty finite Bounds2"),this._xSet=!0,this._ySet=!0,this._alignBounds!==e&&(!e||!this._alignBounds||!e.equals(this._alignBounds))&&(this._alignBounds=e,this.constraint.updateLayout()),this}set alignBounds(e){this.setAlignBounds(e)}get alignBounds(){return this.getAlignBounds()}getAlignBounds(){return this._alignBounds}setGroup(e){return assert&&assert(e===null||e instanceof Hu,"group should be an AlignGroup"),this._group!==e&&(this._group&&this._group.removeAlignBox(this),this._group=e,this._group&&this._group.addAlignBox(this)),this}set group(e){this.setGroup(e)}get group(){return this.getGroup()}getGroup(){return this._group}setXAlign(e){return assert&&assert(_c.includes(e),`xAlign should be one of: ${_c}`),this._xAlign!==e&&(this._xAlign=e,this.invalidateAlignment()),this}set xAlign(e){this.setXAlign(e)}get xAlign(){return this.getXAlign()}getXAlign(){return this._xAlign}setYAlign(e){return assert&&assert(Sc.includes(e),`xAlign should be one of: ${Sc}`),this._yAlign!==e&&(this._yAlign=e,this.invalidateAlignment()),this}set yAlign(e){this.setYAlign(e)}get yAlign(){return this.getYAlign()}getYAlign(){return this._yAlign}setMargin(e){return assert&&assert(isFinite(e)&&e>=0,"margin should be a finite non-negative number"),(this._leftMargin!==e||this._rightMargin!==e||this._topMargin!==e||this._bottomMargin!==e)&&(this._leftMargin=this._rightMargin=this._topMargin=this._bottomMargin=e,this.invalidateAlignment()),this}set margin(e){this.setMargin(e)}get margin(){return this.getMargin()}getMargin(){return assert&&assert(this._leftMargin===this._rightMargin&&this._leftMargin===this._topMargin&&this._leftMargin===this._bottomMargin,"Getting margin does not have a unique result if the left and right margins are different"),this._leftMargin}setXMargin(e){return assert&&assert(isFinite(e)&&e>=0,"xMargin should be a finite non-negative number"),(this._leftMargin!==e||this._rightMargin!==e)&&(this._leftMargin=this._rightMargin=e,this.invalidateAlignment()),this}set xMargin(e){this.setXMargin(e)}get xMargin(){return this.getXMargin()}getXMargin(){return assert&&assert(this._leftMargin===this._rightMargin,"Getting xMargin does not have a unique result if the left and right margins are different"),this._leftMargin}setYMargin(e){return assert&&assert(isFinite(e)&&e>=0,"yMargin should be a finite non-negative number"),(this._topMargin!==e||this._bottomMargin!==e)&&(this._topMargin=this._bottomMargin=e,this.invalidateAlignment()),this}set yMargin(e){this.setYMargin(e)}get yMargin(){return this.getYMargin()}getYMargin(){return assert&&assert(this._topMargin===this._bottomMargin,"Getting yMargin does not have a unique result if the top and bottom margins are different"),this._topMargin}setLeftMargin(e){return assert&&assert(isFinite(e)&&e>=0,"leftMargin should be a finite non-negative number"),this._leftMargin!==e&&(this._leftMargin=e,this.invalidateAlignment()),this}set leftMargin(e){this.setLeftMargin(e)}get leftMargin(){return this.getLeftMargin()}getLeftMargin(){return this._leftMargin}setRightMargin(e){return assert&&assert(isFinite(e)&&e>=0,"rightMargin should be a finite non-negative number"),this._rightMargin!==e&&(this._rightMargin=e,this.invalidateAlignment()),this}set rightMargin(e){this.setRightMargin(e)}get rightMargin(){return this.getRightMargin()}getRightMargin(){return this._rightMargin}setTopMargin(e){return assert&&assert(isFinite(e)&&e>=0,"topMargin should be a finite non-negative number"),this._topMargin!==e&&(this._topMargin=e,this.invalidateAlignment()),this}set topMargin(e){this.setTopMargin(e)}get topMargin(){return this.getTopMargin()}getTopMargin(){return this._topMargin}setBottomMargin(e){return assert&&assert(isFinite(e)&&e>=0,"bottomMargin should be a finite non-negative number"),this._bottomMargin!==e&&(this._bottomMargin=e,this.invalidateAlignment()),this}set bottomMargin(e){this.setBottomMargin(e)}get bottomMargin(){return this.getBottomMargin()}getBottomMargin(){return this._bottomMargin}getContent(){return this._content}get content(){return this.getContent()}getContentBounds(){sceneryLog&&sceneryLog.AlignBox&&sceneryLog.AlignBox(`AlignBox#${this.id} getContentBounds`),sceneryLog&&sceneryLog.AlignBox&&sceneryLog.push();const e=this._content.bounds;return sceneryLog&&sceneryLog.AlignBox&&sceneryLog.pop(),new w(e.left-this._leftMargin,e.top-this._topMargin,e.right+this._rightMargin,e.bottom+this._bottomMargin)}setAdjustedLocalBounds(e){if(this._xSet&&this._ySet)this.localBounds=e;else if(this._xSet){const t=this.getContentBounds();this.localBounds=new w(e.minX,t.minY,e.maxX,t.maxY)}else if(this._ySet){const t=this.getContentBounds();this.localBounds=new w(t.minX,e.minY,t.maxX,e.maxY)}else this.localBounds=this.getContentBounds()}dispose(){this._alignBoundsProperty&&this._alignBoundsProperty.unlink(this._alignBoundsPropertyListener),this._content.boundsProperty.unlink(this._contentBoundsListener),this._content=new D,this.group=null,this.constraint.dispose(),super.dispose()}mutate(e){return super.mutate(e)}}class qf extends jn{constructor(e,t){super(e),this.alignBox=e,this.content=t,this.addNode(t),e.isWidthResizableProperty.lazyLink(this._updateLayoutListener),e.isHeightResizableProperty.lazyLink(this._updateLayoutListener)}updateProperty(e,t){const s=this.content[e],i=this.alignBox.localBounds[e]+t;Math.abs(s-i)>1e-5&&(this.content[e]=i)}layout(){super.layout();const e=this.alignBox,t=this.content;if(sceneryLog&&sceneryLog.AlignBox&&sceneryLog.AlignBox(`AlignBoxConstraint#${this.alignBox.id} layout`),sceneryLog&&sceneryLog.AlignBox&&sceneryLog.push(),!t.bounds.isValid())return;const s=e.leftMargin+e.rightMargin,i=e.topMargin+e.bottomMargin;if(e.alignBounds!==null)e.setAdjustedLocalBounds(e.alignBounds);else{const o=t.width+s,h=t.height+i;e.setAdjustedLocalBounds(new w(0,0,o,h))}const n=isFinite(t.width)?(Si(t)?t.minimumWidth||0:t.width)+s:null,a=isFinite(t.height)?(wi(t)?t.minimumHeight||0:t.height)+i:null;t.localBounds.isEmpty()||(e.xAlign==="center"?this.updateProperty("centerX",(e.leftMargin-e.rightMargin)/2):e.xAlign==="left"?this.updateProperty("left",e.leftMargin):e.xAlign==="right"?this.updateProperty("right",-e.rightMargin):e.xAlign==="stretch"?(assert&&assert(Si(t),"xAlign:stretch can only be used if WidthSizable is mixed into the content"),t.preferredWidth=e.localWidth-e.leftMargin-e.rightMargin,this.updateProperty("left",e.leftMargin)):assert&&assert(`Bad xAlign: ${e.xAlign}`),e.yAlign==="center"?this.updateProperty("centerY",(e.topMargin-e.bottomMargin)/2):e.yAlign==="top"?this.updateProperty("top",e.topMargin):e.yAlign==="bottom"?this.updateProperty("bottom",-e.bottomMargin):e.yAlign==="stretch"?(assert&&assert(wi(t),"yAlign:stretch can only be used if HeightSizable is mixed into the content"),t.preferredHeight=e.localHeight-e.topMargin-e.bottomMargin,this.updateProperty("top",e.topMargin)):assert&&assert(`Bad yAlign: ${e.yAlign}`)),sceneryLog&&sceneryLog.AlignBox&&sceneryLog.pop(),e.localMinimumWidth=e.widthSizable?n:e.localWidth,e.localMinimumHeight=e.heightSizable?a:e.localHeight}}bh.prototype._mutatorKeys=jf.concat(Fu.prototype._mutatorKeys);d.register("AlignBox",bh);let Qf=1;const Zf={matchHorizontal:!0,matchVertical:!0};class Hu extends Ro{constructor(e){assert&&assert(e===void 0||Object.getPrototypeOf(e)===Object.prototype,"Extra prototype on options object is a code smell");const t=ls()({},Zf,e);assert&&assert(typeof t.matchHorizontal=="boolean"),assert&&assert(typeof t.matchVertical=="boolean"),super(t),this._alignBoxes=[],this._matchHorizontal=t.matchHorizontal,this._matchVertical=t.matchVertical,this._resizeLock=!1,this._maxWidthProperty=new Kt(0),this._maxHeightProperty=new Kt(0),this.id=Qf++}getMaxWidth(){return this._maxWidthProperty.value}get maxWidth(){return this.getMaxWidth()}getMaxWidthProperty(){return this._maxWidthProperty}get maxWidthProperty(){return this.getMaxWidthProperty()}getMaxHeight(){return this._maxHeightProperty.value}get maxHeight(){return this.getMaxHeight()}getMaxHeightProperty(){return this._maxHeightProperty}get maxHeightProperty(){return this.getMaxHeightProperty()}getMaxSizeProperty(e){return e===M.HORIZONTAL?this._maxWidthProperty:this._maxHeightProperty}createBox(e,t){return new bh(e,pe({group:this},t))}setMatchHorizontal(e){return this._matchHorizontal!==e&&(this._matchHorizontal=e,this.updateLayout()),this}set matchHorizontal(e){this.setMatchHorizontal(e)}get matchHorizontal(){return this.getMatchHorizontal()}getMatchHorizontal(){return this._matchHorizontal}setMatchVertical(e){return this._matchVertical!==e&&(this._matchVertical=e,this.updateLayout()),this}set matchVertical(e){this.setMatchVertical(e)}get matchVertical(){return this.getMatchVertical()}getMatchVertical(){return this._matchVertical}updateLayout(){if(this._resizeLock)return;this._resizeLock=!0,sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.AlignGroup(`AlignGroup#${this.id} updateLayout`),sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.push(),sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.AlignGroup("AlignGroup computing maximum dimension"),sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.push();let e=0,t=0;for(let s=0;s<this._alignBoxes.length;s++){const n=this._alignBoxes[s].getContentBounds();n.isEmpty()||!n.isFinite()||(e=Math.max(e,n.width),t=Math.max(t,n.height))}if(sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.pop(),sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.AlignGroup("AlignGroup applying to boxes"),sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.push(),this._maxWidthProperty.value=e,this._maxHeightProperty.value=t,e>0&&t>0)for(let s=0;s<this._alignBoxes.length;s++)this.setBoxBounds(this._alignBoxes[s],e,t);sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.pop(),sceneryLog&&sceneryLog.AlignGroup&&sceneryLog.pop(),this._resizeLock=!1}setBoxBounds(e,t,s){let i;if(this._matchVertical&&this._matchHorizontal)i=new w(0,0,t,s);else{const n=e.getContentBounds();this._matchVertical?i=new w(0,0,isFinite(n.width)?n.width:t,s):this._matchHorizontal?i=new w(0,0,t,isFinite(n.height)?n.height:s):i=n}e.alignBounds=i}onAlignBoxResized(e){this.updateLayout()}addAlignBox(e){this._alignBoxes.push(e),this.updateLayout()}removeAlignBox(e){Tt(this._alignBoxes,e),this.updateLayout()}dispose(){for(let e=this._alignBoxes.length-1;e>=0;e--)this._alignBoxes[e].dispose();super.dispose()}}d.register("AlignGroup",Hu);class Jf extends Ri{constructor(e){assert&&assert(!e||!e.orientation,"HBox sets orientation"),super(E()({orientation:"horizontal"},e))}onFlowBoxChildInserted(e,t){assert&&assert(!(e instanceof Eu),"HSeparator should not be used in an HBox. Use VSeparator instead"),super.onFlowBoxChildInserted(e,t)}mutate(e){return super.mutate(e)}}d.register("HBox",Jf);class ey extends Ri{constructor(e){assert&&assert(!e||!e.orientation,"VBox sets orientation"),super(E()({orientation:"vertical"},e))}onFlowBoxChildInserted(e,t){assert&&assert(!(e instanceof Iu),"VSeparator should not be used in an VBox. Use HSeparator instead"),super.onFlowBoxChildInserted(e,t)}mutate(e){return super.mutate(e)}}d.register("VBox",ey);const Ha=r=>r.type.toLowerCase()==="element",Va=r=>r.type.toLowerCase()==="text",ot={scratchText:new Fe(""),himalayaGetAttribute(r,e){if(!e)return null;const t=_.find(e.attributes,s=>s.key===r);return t&&t.value||null},himalayaStyleStringToMap(r){const e=r.split(";"),t={};return e.forEach(s=>{if(s.length>0){const i=s.split(":");assert&&assert(i.length===2,"too many colons"),t[i[0].trim()]=i[1].trim()}}),t}};d.register("RichTextUtils",ot);const Fi=Me(r=>(assert&&assert(_.includes(ct(r),D),"Only Node subtypes should mix Paintable"),class extends r{get isCleanable(){return!0}clean(){const t=this;for(let s=t._children.length-1;s>=0;s--){const i=t._children[s];i.isCleanable&&(t.removeChild(i),i.clean())}t.matrix=C.IDENTITY,t.freeToPool()}}));d.register("RichTextCleanable",Fi);const kn=class kn extends Fi(D){constructor(e){super(),this.initialize(e)}initialize(e){return this.localBounds=new w(0,0,0,e),this}freeToPool(){kn.pool.freeToPool(this)}};kn.pool=new nt(kn);let Cr=kn;d.register("RichTextVerticalSpacer",Cr);const An=class An extends Fi(D){constructor(e){super(),this.initialize(e)}initialize(e){return this.isLTR=e,this.leftSpacing=0,this.rightSpacing=0,this}addElement(e){const t=this.children.length>0,s=e.width>0,i=e.getScaleVector().x,n=e.leftSpacing*i,a=e.rightSpacing*i;if(!t&&!s)return sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText("No child or element, ignoring"),!1;if(t)if(!s)sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`No element, adding spacing, ltr:${this.isLTR}, spacing: ${n+a}`),this.isLTR?this.rightSpacing+=n+a:this.leftSpacing+=n+a;else return this.isLTR?(sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`LTR add ${this.rightSpacing} + ${n}`),e.left=this.localRight+this.rightSpacing+n,this.rightSpacing=a):(sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`RTL add ${this.leftSpacing} + ${a}`),e.right=this.localLeft-this.leftSpacing-a,this.leftSpacing=n),this.addChild(e),!0;else return sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`First child, ltr:${this.isLTR}, spacing: ${this.isLTR?a:n}`),this.isLTR?(e.left=0,this.leftSpacing=n,this.rightSpacing=a):(e.right=0,this.leftSpacing=n,this.rightSpacing=a),this.addChild(e),!0;return!1}addExtraBeforeSpacing(e){this.isLTR?this.leftSpacing+=e:this.rightSpacing+=e}freeToPool(){An.pool.freeToPool(this)}};An.pool=new nt(An);let Ci=An;d.register("RichTextElement",Ci);const xn=class xn extends Fi(Fe){constructor(e,t,s,i,n,a,o){super(""),this.initialize(e,t,s,i,n,a,o)}initialize(e,t,s,i,n,a,o){let h="";for(;e.startsWith(" ");)h+=" ",e=e.slice(1);let l="";for(;e.endsWith(" ");)l=" ",e=e.slice(0,e.length-1);this.string=ps.contentToString(e,t),this.boundsMethod=i,this.font=s,this.fill=n,this.stroke=a,this.lineWidth=o;const c=h.length?ot.scratchText.setString(h).setFont(s).width:0,u=l.length?ot.scratchText.setString(l).setFont(s).width:0;return this.leftSpacing=t?c:u,this.rightSpacing=t?u:c,this}clean(){super.clean(),this.fill=null,this.stroke=null}fitsIn(e,t,s){return this.width+(t?s?this.leftSpacing:this.rightSpacing:0)<=e}freeToPool(){xn.pool.freeToPool(this)}};xn.pool=new nt(xn);let Xs=xn;d.register("RichTextLeaf",Xs);const On=class On extends Fi(D){constructor(e){super(),this.leftSpacing=0,this.rightSpacing=0,this.initialize(e)}initialize(e){return this.addChild(e),this}clean(){super.clean(),this.removeAllChildren()}fitsIn(e){return this.width<=e}freeToPool(){On.pool.freeToPool(this)}};On.pool=new nt(On);let Ir=On;d.register("RichTextNode",Ir);const Mn=class Mn extends Ht(Fi(D)){constructor(e,t){super(),this.fireListener=null,this.accessibleInputListener=null,this.allowLinksListener=null,this.initialize(e,t,!1),this.mutate({cursor:"pointer",tagName:"a"})}initialize(e,t,s=!0){return s&&super.initialize(),this.innerContent=e,this.voicingNameResponse=e,typeof t=="function"?(this.fireListener=new Do({fire:t,tandem:se.OPT_OUT}),this.addInputListener(this.fireListener),this.setPDOMAttribute("href","#"),this.setPDOMAttribute("target","_self"),this.accessibleInputListener={click:i=>{i.domEvent&&i.domEvent.preventDefault(),t()}},this.addInputListener(this.accessibleInputListener)):(this.fireListener=new Do({fire:i=>{i.isFromPDOM()&&i.domEvent.preventDefault(),self._linkEventsHandled&&i.handle(),md(t)},tandem:se.OPT_OUT}),this.addInputListener(this.fireListener),this.setPDOMAttribute("href",t),this.setPDOMAttribute("target","_blank"),this.allowLinksListener=i=>{this.visible=i},Ii.link(this.allowLinksListener)),this}clean(){super.clean(),this.fireListener&&(this.removeInputListener(this.fireListener),this.fireListener.dispose()),this.fireListener=null,this.accessibleInputListener&&(this.removeInputListener(this.accessibleInputListener),this.accessibleInputListener=null),this.allowLinksListener&&(Ii.unlink(this.allowLinksListener),this.allowLinksListener=null)}freeToPool(){Mn.pool.freeToPool(this)}};Mn.pool=new nt(Mn);let Er=Mn;d.register("RichTextLink",Er);const Io=himalaya;assert&&assert(Io,"himalaya dependency needed for RichText.");const ty=["boundsMethod","font","fill","stroke","lineWidth","subScale","subXSpacing","subYOffset","supScale","supXSpacing","supYOffset","capHeightScale","underlineLineWidth","underlineHeightScale","strikethroughLineWidth","strikethroughHeightScale","linkFill","linkEventsHandled","links","nodes","replaceNewlines","align","leading","lineWrap",Fe.STRING_PROPERTY_NAME,"string"],wc=window.QueryStringMachine&&QueryStringMachine.containsKey("stringTest"),sy=new xe({size:20}),iy=["b","strong","i","em","sub","sup","u","s"],kt={COMPLETE:"COMPLETE",INCOMPLETE:"INCOMPLETE",NONE:"NONE"},Ga=[],za=[],Vu={"font-family":"family","font-size":"size","font-stretch":"stretch","font-style":"style","font-variant":"variant","font-weight":"weight","line-height":"lineHeight"},Eo=Object.keys(Vu),ny=["color"].concat(Eo),_t=class _t extends Ur(D){constructor(e,t){const s=E()({fill:"#000000",tandemNameSuffix:"Text",phetioType:_t.RichTextIO,phetioVisiblePropertyInstrumented:!1},t);typeof e=="string"||typeof e=="number"?s.string=e:s.stringProperty=e,super(),this._font=sy,this._boundsMethod="hybrid",this._fill="#000000",this._stroke=null,this._lineWidth=1,this._subScale=.75,this._subXSpacing=0,this._subYOffset=0,this._supScale=.75,this._supXSpacing=0,this._supYOffset=0,this._capHeightScale=.75,this._underlineLineWidth=1,this._underlineHeightScale=.15,this._strikethroughLineWidth=1,this._strikethroughHeightScale=.3,this._linkFill="rgb(27,0,241)",this._linkEventsHandled=!1,this._links={},this._nodes={},this._replaceNewlines=!1,this._align="left",this._leading=0,this._lineWrap=null,this._linkItems=[],this._hasAddedLeafToLine=!1,this.needPendingMinimumWidth=!1,this.pendingMinimumWidth=0,this._stringProperty=new Ut("",!0,this.onStringPropertyChange.bind(this)),this.lineContainer=new D({}),this.addChild(this.lineContainer),this.rebuildRichText(),this.localPreferredWidthProperty.lazyLink(()=>this.rebuildRichText()),this.mutate(s)}onStringPropertyChange(){this.rebuildRichText()}setStringProperty(e){return this._stringProperty.setTargetProperty(e,this,_t.STRING_PROPERTY_TANDEM_NAME)}set stringProperty(e){this.setStringProperty(e)}get stringProperty(){return this.getStringProperty()}getStringProperty(){return this._stringProperty}getPhetioMouseHitTarget(e=!1){return eh.value==="string"?this.getStringPropertyPhetioMouseHitTarget(e):super.getPhetioMouseHitTarget(e)}getStringPropertyPhetioMouseHitTarget(e=!1){const t=this._stringProperty.getTargetProperty();return t instanceof _e?t.getPhetioMouseHitTarget(e):"phetioNotSelectable"}initializePhetioObject(e,t){const s=E()({},t),i=this.isPhetioInstrumented();super.initializePhetioObject(e,s),se.PHET_IO_ENABLED&&!i&&this.isPhetioInstrumented()&&this._stringProperty.initializePhetio(this,_t.STRING_PROPERTY_TANDEM_NAME,()=>new $r(this.string,pe({phetioReadOnly:!0,tandem:this.tandem.createTandem(_t.STRING_PROPERTY_TANDEM_NAME),phetioDocumentation:"Property for the displayed text"},s.stringPropertyOptions)))}rebuildRichText(){assert&&ee(Ga),assert&&ee(za);const e=this._lineWrap==="stretch";this.widthSizable=e,this.pendingMinimumWidth=0,this.needPendingMinimumWidth=e;const t=this._lineWrap==="stretch"?this.localPreferredWidth:this._lineWrap;if(this.freeChildrenToPool(),this.string===""){this.appendEmptyLeaf();return}sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`RichText#${this.id} rebuild`),sceneryLog&&sceneryLog.RichText&&sceneryLog.push();let s=this.string.replace(/\u202a/g,'<span dir="ltr">').replace(/\u202b/g,'<span dir="rtl">').replace(/\u202c/g,"</span>");this._replaceNewlines&&(s=s.replace(/\n/g,"<br>"));let i;try{i=Io.parse(s)}catch{i=Io.parse("INVALID TRANSLATION")}this._linkItems.length=0;const n=t===null?Number.POSITIVE_INFINITY:t,a=!0;let o=Ci.pool.create(a);for(this._hasAddedLeafToLine=!1;i.length;){const h=i[0],l=o.bounds.isValid()?o.width:0,c=this.appendElement(o,h,this._font,this._fill,a,n-l,1);sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`lineBreakState: ${c}`),c!==kt.NONE&&(o.bounds.isValid()?(sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText("Adding line due to lineBreak"),this.appendLine(o)):this.appendLine(Cr.pool.create(ot.scratchText.setString("X").setFont(this._font).height)),o=Ci.pool.create(a),this._hasAddedLeafToLine=!1),c!==kt.INCOMPLETE&&(sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText("Finished root element"),i.splice(0,1))}for(o.bounds.isValid()&&(sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText("Adding final line"),this.appendLine(o)),this.lineContainer.getChildrenCount()===0&&this.appendEmptyLeaf(),this.alignLines();this._linkItems.length;)(()=>{const h=this._linkItems[0].element,l=this._linkItems[0].href;let c;const u=[];for(c=this._linkItems.length-1;c>=0;c--){const b=this._linkItems[c];b.element===h&&(u.push(b.node),this._linkItems.splice(c,1))}const m=Er.pool.create(h.innerContent,l);for(this.lineContainer.addChild(m),c=0;c<u.length;c++){const b=u[c],y=b.getUniqueTrailTo(this.lineContainer).getMatrix();b.detach(),b.matrix=y,m.addChild(b)}})();this._linkItems.length=0,assert&&(this._links&&this._links!==!0&&Object.keys(this._links).forEach(h=>{assert&&Ii.value&&!wc&&assert(Ga.includes(h),`Unused RichText link: ${h}`)}),this._nodes&&Object.keys(this._nodes).forEach(h=>{assert&&Ii.value&&!wc&&assert(za.includes(h),`Unused RichText node: ${h}`)})),this.localMinimumWidth=e?this.pendingMinimumWidth:this.localBounds.width,sceneryLog&&sceneryLog.RichText&&sceneryLog.pop()}freeChildrenToPool(){for(;this.lineContainer._children.length;){const e=this.lineContainer._children[this.lineContainer._children.length-1];this.lineContainer.removeChild(e),e.clean()}}dispose(){this.freeChildrenToPool(),super.dispose(),this._stringProperty.dispose()}appendLine(e){this.lineContainer.bounds.isValid()&&(e.top=this.lineContainer.bottom+this._leading,e.left=0),this.lineContainer.addChild(e)}appendEmptyLeaf(){assert&&assert(this.lineContainer.getChildrenCount()===0),this.appendLine(Xs.pool.create("",!0,this._font,this._boundsMethod,this._fill,this._stroke,this._lineWidth))}alignLines(){const e=this._align==="center"?"centerX":this._align,t=this.lineContainer[e];for(let s=0;s<this.lineContainer.getChildrenCount();s++)this.lineContainer.getChildAt(s)[e]=t}appendElement(e,t,s,i,n,a,o){let h=kt.NONE,l;const c=n?e.rightSpacing:e.leftSpacing,u=a-c;if(Va(t)){if(sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`appending leaf: ${t.content}`),sceneryLog&&sceneryLog.RichText&&sceneryLog.push(),l=Xs.pool.create(t.content,n,s,this._boundsMethod,i,this._stroke,this._lineWidth),this.needPendingMinimumWidth&&(this.pendingMinimumWidth=Math.max(this.pendingMinimumWidth,Math.max(...ro(t.content).map(m=>{const b=t.content.slice(m.min,m.max),y=Xs.pool.create(b,n,s,this._boundsMethod,i,this._stroke,this._lineWidth),f=y.width*o;return y.dispose(),f})))),!l.fitsIn(u,this._hasAddedLeafToLine,n)){const m=ro(t.content),b=y=>y.length===0?"":t.content.slice(y[0].min,y[y.length-1].max);if(sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`Overflow leafAdded:${this._hasAddedLeafToLine}, words: ${m.length}`),this._hasAddedLeafToLine||m.length>1){sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText("Skipping words");const y=[];let f=!1;for(y.unshift(m.pop());m.length;)if(l.clean(),l=Xs.pool.create(b(m),n,s,this._boundsMethod,i,this._stroke,this._lineWidth),!l.fitsIn(u,this._hasAddedLeafToLine,n)&&(this._hasAddedLeafToLine||m.length>1))sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`Skipping word ${b([m[m.length-1]])}`),y.unshift(m.pop());else{sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`Success with ${b(m)}`),f=!0;break}if(f)h=kt.INCOMPLETE,t.content=b(y),sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText(`Remaining content: ${t.content}`);else return l.clean(),kt.INCOMPLETE}}this._hasAddedLeafToLine=!0,sceneryLog&&sceneryLog.RichText&&sceneryLog.pop()}else if(Ha(t)){if(t.tagName==="br")return sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText("manual line break"),kt.COMPLETE;if(t.tagName==="span"){const y=ot.himalayaGetAttribute("dir",t);y&&(assert&&assert(y==="ltr"||y==="rtl","Span dir attributes should be ltr or rtl."),n=y==="ltr")}if(t.tagName==="node"){const y=ot.himalayaGetAttribute("id",t),f=y&&this._nodes[y]||null;if(assert&&assert(f,y?`Could not find a matching item in RichText's nodes for ${y}. It should be provided in the nodes option`:"No id attribute provided for a given <node> element"),f){if(assert&&za.push(y),l=Ir.pool.create(f),this._hasAddedLeafToLine&&!l.fitsIn(u))return l.clean(),kt.INCOMPLETE;const L=ot.himalayaGetAttribute("align",t);if(L==="center"||L==="top"||L==="bottom"){const v=ot.scratchText.setString("Test").setFont(s).bounds;L==="center"?l.centerY=v.centerY:L==="top"?l.top=v.top:L==="bottom"&&(l.bottom=v.bottom)}}else return h;this._hasAddedLeafToLine=!0}else l=Ci.pool.create(n);sceneryLog&&sceneryLog.RichText&&sceneryLog.RichText("appending element"),sceneryLog&&sceneryLog.RichText&&sceneryLog.push();const m=ot.himalayaGetAttribute("style",t);if(m){const y=ot.himalayaStyleStringToMap(m);assert&&Object.keys(y).forEach(L=>{assert(_.includes(ny,L),"See supported style CSS keys")}),y.color&&(i=new P(y.color));const f={};for(let L=0;L<Eo.length;L++){const v=Eo[L];y[v]&&(f[Vu[v]]=y[v])}s=(typeof s=="string"?xe.fromCSS(s):s).copy(f)}if(t.tagName==="a"){let y=ot.himalayaGetAttribute("href",t);const f=y;if(y!==null&&this._links!==!0)if(y.startsWith("{{")&&y.indexOf("}}")===y.length-2){const L=y.slice(2,-2);y=this._links[L],assert&&Ga.push(L)}else y=null;assert&&assert(y,`Could not find a matching item in RichText's links for ${f}. It should be provided in the links option, or links should be turned to true (to allow the string to create its own urls`),y&&(this._linkFill!==null&&(i=this._linkFill),t.innerContent||(t.innerContent=_t.himalayaElementToAccessibleString(t,n)),this._linkItems.push({element:t,node:l,href:y}))}else t.tagName==="b"||t.tagName==="strong"?s=(typeof s=="string"?xe.fromCSS(s):s).copy({weight:"bold"}):t.tagName==="i"||t.tagName==="em"?s=(typeof s=="string"?xe.fromCSS(s):s).copy({style:"italic"}):t.tagName==="sub"?(l.scale(this._subScale),l.addExtraBeforeSpacing(this._subXSpacing),l.y+=this._subYOffset):t.tagName==="sup"&&(l.scale(this._supScale),l.addExtraBeforeSpacing(this._supXSpacing),l.y+=this._supYOffset);const b=l.getScaleVector().x;if(t.tagName!=="node"){for(;h===kt.NONE&&t.children.length;){const y=l.bounds.isValid()?l.width:0,f=t.children[0];h=this.appendElement(l,f,s,i,n,a/b,o*b),h!==kt.INCOMPLETE&&t.children.splice(0,1);const L=l.bounds.isValid()?l.width:0;a+=y-L}h===kt.COMPLETE&&t.children.length&&(h=kt.INCOMPLETE)}if(t.tagName==="sub")isFinite(l.height)&&(l.centerY=0);else if(t.tagName==="sup")isFinite(l.height)&&(l.centerY=ot.scratchText.setString("X").setFont(s).top*this._capHeightScale);else if(t.tagName==="u"){const y=-l.top*this._underlineHeightScale;isFinite(l.top)&&l.addChild(new ds(l.localLeft,y,l.localRight,y,{stroke:i,lineWidth:this._underlineLineWidth}))}else if(t.tagName==="s"){const y=l.top*this._strikethroughHeightScale;isFinite(l.top)&&l.addChild(new ds(l.localLeft,y,l.localRight,y,{stroke:i,lineWidth:this._strikethroughLineWidth}))}sceneryLog&&sceneryLog.RichText&&sceneryLog.pop()}return l&&(e.addElement(l)||(this._linkItems=this._linkItems.filter(b=>b.node!==l),l.clean())),h}setString(e){return assert&&assert(e!=null,"String should be defined and non-null. Use the empty string if needed."),e=`${e}`,this._stringProperty.set(e),this}set string(e){this.setString(e)}get string(){return this.getString()}getString(){return this._stringProperty.value}setBoundsMethod(e){return assert&&assert(e==="fast"||e==="fastCanvas"||e==="accurate"||e==="hybrid","Unknown Text boundsMethod"),e!==this._boundsMethod&&(this._boundsMethod=e,this.rebuildRichText()),this}set boundsMethod(e){this.setBoundsMethod(e)}get boundsMethod(){return this.getBoundsMethod()}getBoundsMethod(){return this._boundsMethod}setFont(e){return this._font!==e&&(this._font=e,this.rebuildRichText()),this}set font(e){this.setFont(e)}get font(){return this.getFont()}getFont(){return this._font}setFill(e){return this._fill!==e&&(this._fill=e,this.rebuildRichText()),this}set fill(e){this.setFill(e)}get fill(){return this.getFill()}getFill(){return this._fill}setStroke(e){return this._stroke!==e&&(this._stroke=e,this.rebuildRichText()),this}set stroke(e){this.setStroke(e)}get stroke(){return this.getStroke()}getStroke(){return this._stroke}setLineWidth(e){return this._lineWidth!==e&&(this._lineWidth=e,this.rebuildRichText()),this}set lineWidth(e){this.setLineWidth(e)}get lineWidth(){return this.getLineWidth()}getLineWidth(){return this._lineWidth}setSubScale(e){return assert&&assert(isFinite(e)&&e>0),this._subScale!==e&&(this._subScale=e,this.rebuildRichText()),this}set subScale(e){this.setSubScale(e)}get subScale(){return this.getSubScale()}getSubScale(){return this._subScale}setSubXSpacing(e){return assert&&assert(isFinite(e)),this._subXSpacing!==e&&(this._subXSpacing=e,this.rebuildRichText()),this}set subXSpacing(e){this.setSubXSpacing(e)}get subXSpacing(){return this.getSubXSpacing()}getSubXSpacing(){return this._subXSpacing}setSubYOffset(e){return assert&&assert(isFinite(e)),this._subYOffset!==e&&(this._subYOffset=e,this.rebuildRichText()),this}set subYOffset(e){this.setSubYOffset(e)}get subYOffset(){return this.getSubYOffset()}getSubYOffset(){return this._subYOffset}setSupScale(e){return assert&&assert(isFinite(e)&&e>0),this._supScale!==e&&(this._supScale=e,this.rebuildRichText()),this}set supScale(e){this.setSupScale(e)}get supScale(){return this.getSupScale()}getSupScale(){return this._supScale}setSupXSpacing(e){return assert&&assert(isFinite(e)),this._supXSpacing!==e&&(this._supXSpacing=e,this.rebuildRichText()),this}set supXSpacing(e){this.setSupXSpacing(e)}get supXSpacing(){return this.getSupXSpacing()}getSupXSpacing(){return this._supXSpacing}setSupYOffset(e){return assert&&assert(isFinite(e)),this._supYOffset!==e&&(this._supYOffset=e,this.rebuildRichText()),this}set supYOffset(e){this.setSupYOffset(e)}get supYOffset(){return this.getSupYOffset()}getSupYOffset(){return this._supYOffset}setCapHeightScale(e){return assert&&assert(isFinite(e)&&e>0),this._capHeightScale!==e&&(this._capHeightScale=e,this.rebuildRichText()),this}set capHeightScale(e){this.setCapHeightScale(e)}get capHeightScale(){return this.getCapHeightScale()}getCapHeightScale(){return this._capHeightScale}setUnderlineLineWidth(e){return assert&&assert(isFinite(e)&&e>0),this._underlineLineWidth!==e&&(this._underlineLineWidth=e,this.rebuildRichText()),this}set underlineLineWidth(e){this.setUnderlineLineWidth(e)}get underlineLineWidth(){return this.getUnderlineLineWidth()}getUnderlineLineWidth(){return this._underlineLineWidth}setUnderlineHeightScale(e){return assert&&assert(isFinite(e)&&e>0),this._underlineHeightScale!==e&&(this._underlineHeightScale=e,this.rebuildRichText()),this}set underlineHeightScale(e){this.setUnderlineHeightScale(e)}get underlineHeightScale(){return this.getUnderlineHeightScale()}getUnderlineHeightScale(){return this._underlineHeightScale}setStrikethroughLineWidth(e){return assert&&assert(isFinite(e)&&e>0),this._strikethroughLineWidth!==e&&(this._strikethroughLineWidth=e,this.rebuildRichText()),this}set strikethroughLineWidth(e){this.setStrikethroughLineWidth(e)}get strikethroughLineWidth(){return this.getStrikethroughLineWidth()}getStrikethroughLineWidth(){return this._strikethroughLineWidth}setStrikethroughHeightScale(e){return assert&&assert(isFinite(e)&&e>0),this._strikethroughHeightScale!==e&&(this._strikethroughHeightScale=e,this.rebuildRichText()),this}set strikethroughHeightScale(e){this.setStrikethroughHeightScale(e)}get strikethroughHeightScale(){return this.getStrikethroughHeightScale()}getStrikethroughHeightScale(){return this._strikethroughHeightScale}setLinkFill(e){return this._linkFill!==e&&(this._linkFill=e,this.rebuildRichText()),this}set linkFill(e){this.setLinkFill(e)}get linkFill(){return this.getLinkFill()}getLinkFill(){return this._linkFill}setLinkEventsHandled(e){return this._linkEventsHandled!==e&&(this._linkEventsHandled=e,this.rebuildRichText()),this}set linkEventsHandled(e){this.setLinkEventsHandled(e)}get linkEventsHandled(){return this.getLinkEventsHandled()}getLinkEventsHandled(){return this._linkEventsHandled}setLinks(e){return assert&&assert(e===!0||Object.getPrototypeOf(e)===Object.prototype),this._links!==e&&(this._links=e,this.rebuildRichText()),this}getLinks(){return this._links}set links(e){this.setLinks(e)}get links(){return this.getLinks()}setNodes(e){return assert&&assert(Object.getPrototypeOf(e)===Object.prototype),this._nodes!==e&&(this._nodes=e,this.rebuildRichText()),this}getNodes(){return this._nodes}set nodes(e){this.setNodes(e)}get nodes(){return this.getNodes()}setReplaceNewlines(e){return this._replaceNewlines!==e&&(this._replaceNewlines=e,this.rebuildRichText()),this}set replaceNewlines(e){this.setReplaceNewlines(e)}get replaceNewlines(){return this.getReplaceNewlines()}getReplaceNewlines(){return this._replaceNewlines}setAlign(e){return assert&&assert(e==="left"||e==="center"||e==="right"),this._align!==e&&(this._align=e,this.rebuildRichText()),this}set align(e){this.setAlign(e)}get align(){return this.getAlign()}getAlign(){return this._align}setLeading(e){return assert&&assert(isFinite(e)),this._leading!==e&&(this._leading=e,this.rebuildRichText()),this}set leading(e){this.setLeading(e)}get leading(){return this.getLeading()}getLeading(){return this._leading}setLineWrap(e){return assert&&assert(e===null||e==="stretch"||isFinite(e)&&e>0),this._lineWrap!==e&&(this._lineWrap=e,this.rebuildRichText()),this}set lineWrap(e){this.setLineWrap(e)}get lineWrap(){return this.getLineWrap()}getLineWrap(){return this._lineWrap}mutate(e){return assert&&e&&e.hasOwnProperty("string")&&e.hasOwnProperty(Fe.STRING_PROPERTY_NAME)&&e.stringProperty&&assert&&assert(e.stringProperty.value===e.string,"If both string and stringProperty are provided, then values should match"),super.mutate(e)}static stringWithFont(e,t){return`<span style='font-style: ${t.style};font-variant: ${t.variant};font-weight: ${t.weight};font-stretch: ${t.stretch};font-size: ${t.size};font-family: ${t.family};line-height: ${t.lineHeight};'>${e}</span>`}static himalayaElementToString(e,t){if(Va(e))return _t.contentToString(e.content,t);if(Ha(e)){const s=ot.himalayaGetAttribute("dir",e);return e.tagName==="span"&&s&&(t=s==="ltr"),e.children.map(i=>_t.himalayaElementToString(i,t)).join("")}else return""}static himalayaElementToAccessibleString(e,t){if(Va(e))return _t.contentToString(e.content,t);if(Ha(e)){const s=ot.himalayaGetAttribute("dir",e);e.tagName==="span"&&s&&(t=s==="ltr");const i=e.children.map(n=>_t.himalayaElementToAccessibleString(n,t)).join("");return _.includes(iy,e.tagName)?`<${e.tagName}>${i}</${e.tagName}>`:i}else return""}static contentToString(e,t){const s=he.decode(e);return t?`‪${s}‬`:`‫${s}‬`}};_t.STRING_PROPERTY_TANDEM_NAME=Fe.STRING_PROPERTY_TANDEM_NAME;let ps=_t;ps.prototype._mutatorKeys=ty.concat(D.prototype._mutatorKeys);d.register("RichText",ps);ps.RichTextIO=new Le("RichTextIO",{valueType:ps,supertype:D.NodeIO,documentation:"The PhET-iO Type for the scenery RichText node"});class ry extends rh(Fe){constructor(e,t){const s=E()({readingBlockNameResponse:e,tagName:"p",innerContent:e},t);super(e),this.focusHighlight=new qr(this),this.mutate(s)}}d.register("VoicingText",ry);class ay extends rh(ps){constructor(e,t){const s=E()({readingBlockNameResponse:e,innerContent:e,readingBlockTagName:"button"},t);super(e,s),this.focusHighlight=new qr(this)}}d.register("VoicingRichText",ay);const ke=r=>{if(r instanceof T)return{type:"Vector2",x:r.x,y:r.y};if(r instanceof C)return{type:"Matrix3",m00:r.m00(),m01:r.m01(),m02:r.m02(),m10:r.m10(),m11:r.m11(),m12:r.m12(),m20:r.m20(),m21:r.m21(),m22:r.m22()};if(r instanceof w){const e=r;return{type:"Bounds2",maxX:e.maxX,maxY:e.maxY,minX:e.minX,minY:e.minY}}else{if(r instanceof H)return{type:"Shape",path:r.getSVGPath()};if(Array.isArray(r))return{type:"Array",value:r.map(ke)};if(r instanceof P)return{type:"Color",red:r.red,green:r.green,blue:r.blue,alpha:r.alpha};if(r instanceof ft)return{type:"Property",value:ke(r.value)};if(r instanceof X)return{type:"TinyProperty",value:ke(r.value)};if(wt&&r instanceof wt){const e={};return r.transformMatrix&&(e.transformMatrix=ke(r.transformMatrix)),st&&(r instanceof _i||r instanceof Pi)&&(e.stops=r.stops.map(t=>({ratio:t.ratio,stop:ke(t.color)})),e.start=ke(r.start),e.end=ke(r.end),Pi&&r instanceof Pi?e.type="LinearGradient":_i&&r instanceof _i&&(e.type="RadialGradient",e.startRadius=r.startRadius,e.endRadius=r.endRadius)),Ms&&r instanceof Ms&&(e.type="Pattern",e.url=r.image.src),e}else if(r instanceof D){const e=r,t={},s={};["visible","opacity","disabledOpacity","pickable","inputEnabled","cursor","transformBounds","renderer","usesOpacity","layerSplit","cssTransform","excludeInvisible","webglScale","preventFit"].forEach(n=>{e[n]!==D.DEFAULT_NODE_OPTIONS[n]&&(t[n]=e[n])}),["tagName","innerContent","accessibleName","helpText"].forEach(n=>{e[n]!==null&&(t[n]=e[n])}),["maxWidth","maxHeight","clipArea","mouseArea","touchArea"].forEach(n=>{e[n]!==D.DEFAULT_NODE_OPTIONS[n]&&(s[n]=ke(e[n]))}),e.matrix.isIdentity()||(s.matrix=ke(e.matrix)),e._localBoundsOverridden&&(s.localBounds=ke(e.localBounds)),s.children=e.children.map(n=>n.id),s.hasInputListeners=e.inputListeners.length>0;const i={id:e.id,type:"Node",types:ct(e.constructor).map(n=>n.name).filter(n=>n&&n!=="Object"&&n!=="Node"),name:e.constructor.name,options:t,setup:s};if(Pe&&e instanceof Pe&&(i.type="Path",s.path=ke(e.shape),e.boundsMethod!==Pe.DEFAULT_PATH_OPTIONS.boundsMethod&&(t.boundsMethod=e.boundsMethod)),Ai&&e instanceof Ai&&(i.type="Circle",t.radius=e.radius),ds&&e instanceof ds&&(i.type="Line",t.x1=e.x1,t.y1=e.y1,t.x2=e.x2,t.y2=e.y2),De&&e instanceof De&&(i.type="Rectangle",t.rectX=e.rectX,t.rectY=e.rectY,t.rectWidth=e.rectWidth,t.rectHeight=e.rectHeight,t.cornerXRadius=e.cornerXRadius,t.cornerYRadius=e.cornerYRadius),Fe&&e instanceof Fe&&(i.type="Text",e.boundsMethod!=="hybrid"&&(t.boundsMethod=e.boundsMethod),t.string=e.string,t.font=e.font),$e&&e instanceof $e&&(i.type="Image",["imageOpacity","initialWidth","initialHeight","mipmapBias","mipmapInitialLevel","mipmapMaxLevel"].forEach(n=>{e[n]!==$e.DEFAULT_IMAGE_OPTIONS[n]&&(t[n]=e[n])}),s.width=e.imageWidth,s.height=e.imageHeight,e._mipmapData?(s.imageType="mipmapData",s.mipmapData=e._mipmapData.map(n=>({url:n.url,width:n.width,height:n.height}))):(e._mipmap&&(s.generateMipmaps=!0),e._image instanceof HTMLImageElement?(s.imageType="image",s.src=e._image.src):e._image instanceof HTMLCanvasElement&&(s.imageType="canvas",s.src=e._image.toDataURL()))),Ks&&e instanceof Ks||Yt&&e instanceof Yt){i.type=Ks&&e instanceof Ks?"CanvasNode":"WebGLNode",s.canvasBounds=ke(e.canvasBounds);const n=1,a=document.createElement("canvas");a.width=Math.ceil(e.canvasBounds.width*n),a.height=Math.ceil(e.canvasBounds.height*n);const o=a.getContext("2d"),h=new ks(a,o),l=C.scale(1/n);h.context.setTransform(n,0,0,n,-e.canvasBounds.left,-e.canvasBounds.top),e.renderToCanvasSelf(h,l),s.url=a.toDataURL(),s.scale=n,s.offset=ke(e.canvasBounds.leftTop)}return Hn&&e instanceof Hn&&(i.type="DOM",i.element=new window.XMLSerializer().serializeToString(e.element),e.element instanceof window.HTMLCanvasElement&&(i.dataURL=e.element.toDataURL()),t.preventTransform=e.preventTransform),(Pe&&e instanceof Pe||Fe&&e instanceof Fe)&&(["fillPickable","strokePickable","lineWidth","lineCap","lineJoin","lineDashOffset","miterLimit"].forEach(n=>{e[n]!==Cs[n]&&(t[n]=e[n])}),e.fill!==Cs.fill&&(s.fill=ke(e.fill)),e.stroke!==Cs.stroke&&(s.stroke=ke(e.stroke)),e.lineDash.length&&(s.lineDash=ke(e.lineDash))),i}else return r instanceof Be?{type:"Display",width:r.width,height:r.height,backgroundColor:ke(r.backgroundColor),tree:{type:"Subtree",rootNodeId:r.rootNode.id,nodes:Gu(r.rootNode)}}:{type:"value",value:r}}},Gu=r=>r.getSubtreeNodes().map(ke);d.register("scenerySerialize",ke);const Re=r=>{const e=["Node","Path","Circle","Line","Rectangle","Text","Image","CanvasNode","WebGLNode","DOM"];if(r.type==="Vector2")return new T(r.x,r.y);if(r.type==="Matrix3")return new C().rowMajor(r.m00,r.m01,r.m02,r.m10,r.m11,r.m12,r.m20,r.m21,r.m22);if(r.type==="Bounds2")return new w(r.minX,r.minY,r.maxX,r.maxY);if(r.type==="Shape")return new H(r.path);if(r.type==="Array")return r.value.map(Re);if(r.type==="Color")return new P(r.red,r.green,r.blue,r.alpha);if(r.type==="Property")return new me(Re(r.value));if(r.type==="TinyProperty")return new X(Re(r.value));if(r.type==="Pattern"||r.type==="LinearGradient"||r.type==="RadialGradient"){let t;if(r.type==="Pattern"){const s=new window.Image;s.src=r.url,t=new Ms(s)}else{const s=Re(r.start),i=Re(r.end);r.type==="LinearGradient"?t=new Pi(s.x,s.y,i.x,i.y):r.type==="RadialGradient"&&(t=new _i(s.x,s.y,r.startRadius,i.x,i.y,r.endRadius)),r.stops.forEach(n=>{t.addColorStop(n.ratio,Re(n.stop))})}return r.transformMatrix&&t.setTransformMatrix(Re(r.transformMatrix)),t}else if(_.includes(e,r.type)){let t;const s=r.setup;if(r.type==="Node")t=new D;else if(r.type==="Path")t=new Pe(Re(s.path));else if(r.type==="Circle")t=new Ai({});else if(r.type==="Line")t=new ds({});else if(r.type==="Rectangle")t=new De({});else if(r.type==="Text")t=new Fe("");else if(r.type==="Image"){if(s.imageType==="image"||s.imageType==="canvas")t=new $e(s.src),s.generateMipmaps&&(t.mipmap=!0);else if(s.imageType==="mipmapData"){const i=s.mipmapData.map(n=>{const a={width:n.width,height:n.height,url:n.url};a.img=new window.Image,a.img.src=n.url,a.canvas=document.createElement("canvas"),a.canvas.width=n.width,a.canvas.height=n.height;const o=a.canvas.getContext("2d");return a.updateCanvas=function(){a.img.complete&&(typeof a.img.naturalWidth>"u"||a.img.naturalWidth>0)&&(o.drawImage(a.img,0,0),delete a.updateCanvas)},a});t=new $e(i)}t.initialWidth=s.width,t.initialHeight=s.height}else if(r.type==="CanvasNode"||r.type==="WebGLNode")t=new D({children:[new $e(s.url,{translation:Re(s.offset),scale:1/s.scale})]});else if(r.type==="DOM"){const i=document.createElement("div");i.innerHTML=r.element;const n=i.childNodes[0];if(i.removeChild(n),r.dataURL){const a=new window.Image;a.onload=()=>{n.getContext("2d").drawImage(a,0,0)},a.src=r.dataURL}t=new Hn(n)}return s.clipArea&&(t.clipArea=Re(s.clipArea)),s.mouseArea&&(t.mouseArea=Re(s.mouseArea)),s.touchArea&&(t.touchArea=Re(s.touchArea)),s.matrix&&(t.matrix=Re(s.matrix)),s.localBounds&&(t.localBounds=Re(s.localBounds)),s.fill&&(t.fill=Re(s.fill)),s.stroke&&(t.stroke=Re(s.stroke)),s.lineDash&&(t.lineDash=Re(s.lineDash)),t.mutate(r.options),t._serialization=r,t}else if(r.type==="Subtree"){const t={},s=r.nodes.map(Re);return s.forEach(i=>{t[i._serialization.id]=i}),s.forEach(i=>{i._serialization.setup.children.forEach(n=>{i.addChild(t[n])})}),t[r.rootNodeId]}else return r.type==="value"?r.value:null};d.register("sceneryDeserialize",Re);const oy=r=>Re(ke(r));d.register("sceneryCopy",oy);let hy=1;class Ee{initialize(e){return assert&&assert(!this.id||this.isDisposed,"If we previously existed, we need to have been disposed"),this.id=this.id||hy++,sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`[${this.constructor.name}*] initialize ${this.toString()}`),this.clean(),this.renderer=e,this.dirty=!0,this.isDisposed=!1,this.linksDirty=!1,this.visibleProperty=new X(!0),this.fittableProperty=new X(!0),this}clean(){this.parentDrawable=null,this.backbone=null,this.pendingParentDrawable=null,this.pendingBackbone=null,this.pendingAddition=!1,this.pendingRemoval=!1,assert&&assert(!this.previousDrawable&&!this.nextDrawable,"By cleaning (disposal or fresh creation), we should have disconnected from the linked list"),this.previousDrawable=null,this.nextDrawable=null,this.oldPreviousDrawable=null,this.oldNextDrawable=null,this.visibleProperty&&this.visibleProperty.removeAllListeners(),this.fittableProperty&&this.fittableProperty.removeAllListeners()}update(){let e=!1;return this.dirty&&!this.isDisposed&&(this.dirty=!1,e=!0),e}setVisible(e){this.visibleProperty.value=e}set visible(e){this.setVisible(e)}isVisible(){return this.visibleProperty.value}get visible(){return this.isVisible()}setFittable(e){this.fittableProperty.value=e}set fittable(e){this.setFittable(e)}isFittable(){return this.fittableProperty.value}get fittable(){return this.isFittable()}setBlockBackbone(e){sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`[${this.constructor.name}*] setBlockBackbone ${this.toString()} with ${e.toString()}`),assert&&assert(this instanceof As),this.parentDrawable=e,this.backbone=e,this.pendingParentDrawable=e,this.pendingBackbone=e,this.pendingAddition=!1,this.pendingRemoval=!1}notePendingAddition(e,t,s){sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`[${this.constructor.name}*] notePendingAddition ${this.toString()} with ${t.toString()}, ${s?s.toString():"-"}`),assert&&assert(s!==void 0,"backbone can be either null or a backbone"),assert&&assert(t instanceof As),this.pendingParentDrawable=t,this.pendingBackbone=s,this.pendingAddition=!0,this.pendingRemoval||e.markDrawableChangedBlock(this)}notePendingRemoval(e){sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`[${this.constructor.name}*] notePendingRemoval ${this.toString()}`),this.pendingRemoval=!0,this.pendingAddition||e.markDrawableChangedBlock(this)}notePendingMove(e,t){sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`[${this.constructor.name}*] notePendingMove ${this.toString()} with ${t.toString()}`),assert&&assert(t instanceof As),this.pendingParentDrawable=t,(!this.pendingRemoval||!this.pendingAddition)&&e.markDrawableChangedBlock(this),this.pendingAddition=!0,this.pendingRemoval=!0}updateBlock(){sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`[${this.constructor.name}*] updateBlock ${this.toString()} with add:${this.pendingAddition} remove:${this.pendingRemoval} old:${this.parentDrawable?this.parentDrawable.toString():"-"} new:${this.pendingParentDrawable?this.pendingParentDrawable.toString():"-"}`),sceneryLog&&sceneryLog.Drawable&&sceneryLog.push();let e=!1;return(this.pendingRemoval||this.pendingAddition)&&(e=!this.pendingRemoval||!this.pendingAddition||this.parentDrawable!==this.pendingParentDrawable||this.backbone!==this.pendingBackbone,e?(this.pendingRemoval&&(sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`removing from ${this.parentDrawable.toString()}`),this.parentDrawable.removeDrawable(this),this.pendingAddition||(this.pendingParentDrawable=null,this.pendingBackbone=null)),this.parentDrawable=this.pendingParentDrawable,this.backbone=this.pendingBackbone,this.pendingAddition&&(sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`adding to ${this.parentDrawable.toString()}`),this.parentDrawable.addDrawable(this))):(sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable("unchanged"),this.pendingAddition&&p.isCanvas(this.renderer)&&this.parentDrawable.onPotentiallyMovedDrawable(this)),this.pendingAddition=!1,this.pendingRemoval=!1),sceneryLog&&sceneryLog.Drawable&&sceneryLog.pop(),e}updateLinks(){this.oldNextDrawable=this.nextDrawable,this.oldPreviousDrawable=this.previousDrawable,this.linksDirty=!1}markDirty(){this.dirty||(this.dirty=!0,this.parentDrawable&&this.parentDrawable.markDirtyDrawable(this))}markLinksDirty(e){this.linksDirty||(this.linksDirty=!0,e.markDrawableForLinksUpdate(this))}markForDisposal(e){Ee.disconnectBefore(this,e),Ee.disconnectAfter(this,e),e.markDrawableForDisposal(this)}disposeImmediately(e){Ee.disconnectBefore(this,e),Ee.disconnectAfter(this,e),this.dispose()}dispose(){assert&&assert(!this.isDisposed,"We should not re-dispose drawables"),sceneryLog&&sceneryLog.Drawable&&sceneryLog.Drawable(`[${this.constructor.name}*] dispose ${this.toString()}`),sceneryLog&&sceneryLog.Drawable&&sceneryLog.push(),this.clean(),this.isDisposed=!0,this.freeToPool(),sceneryLog&&sceneryLog.Drawable&&sceneryLog.pop()}audit(e,t,s){assertSlow&&(assertSlow&&assertSlow(!this.isDisposed,"If we are being audited, we assume we are in the drawable display tree, and we should not be marked as disposed"),assertSlow&&assertSlow(this.renderer,"Should not have a 0 (no) renderer"),assertSlow&&assertSlow(!this.backbone||this.parentDrawable,"If we have a backbone reference, we must have a parentDrawable (our block)"),e||(assertSlow&&assertSlow(!this.pendingAddition),assertSlow&&assertSlow(!this.pendingRemoval),assertSlow&&assertSlow(this.parentDrawable===this.pendingParentDrawable,"Assure our parent and pending parent match, if we have updated blocks"),assertSlow&&assertSlow(this.backbone===this.pendingBackbone,"Assure our backbone and pending backbone match, if we have updated blocks")),t||(assertSlow&&assertSlow(this.oldPreviousDrawable===this.previousDrawable,"Pending linked-list references should be cleared by now"),assertSlow&&assertSlow(this.oldNextDrawable===this.nextDrawable,"Pending linked-list references should be cleared by now"),assertSlow&&assertSlow(!this.linksDirty,"Links dirty flag should be clean")),s||assertSlow&&assertSlow(!this.dirty,"Should not be dirty at this phase, if we are in the drawable display tree"))}toString(){return`${this.constructor.name}#${this.id}`}toDetailedString(){return this.toString()}static connectDrawables(e,t,s){e.nextDrawable!==t&&(e.nextDrawable&&(e.nextDrawable.markLinksDirty(s),e.nextDrawable.previousDrawable=null),t.previousDrawable&&(t.previousDrawable.markLinksDirty(s),t.previousDrawable.nextDrawable=null),e.nextDrawable=t,t.previousDrawable=e,e.markLinksDirty(s),t.markLinksDirty(s))}static disconnectBefore(e,t){e.previousDrawable&&(e.markLinksDirty(t),e.previousDrawable.markLinksDirty(t),e.previousDrawable.nextDrawable=null,e.previousDrawable=null)}static disconnectAfter(e,t){e.nextDrawable&&(e.markLinksDirty(t),e.nextDrawable.markLinksDirty(t),e.nextDrawable.previousDrawable=null,e.nextDrawable=null)}static listToArray(e,t){const s=[];for(let i=e;s.push(i),i!==t;i=i.nextDrawable);return s}static oldListToArray(e,t){const s=[];for(let i=e;s.push(i),i!==t;i=i.oldNextDrawable);return s}}d.register("Drawable",Ee);class dt extends Ee{constructor(e,t){assert&&assert(typeof e=="number"),assert&&assert(t),super(),this.initialize(e,t)}initialize(e,t){return super.initialize(e),this.drawableVisibilityListener=this.drawableVisibilityListener||this.updateSelfVisibility.bind(this),this.instance=t,this.node=t.trail.lastNode(),this.node.attachDrawable(this),this.instance.selfVisibleEmitter.addListener(this.drawableVisibilityListener),this.updateSelfVisibility(),this}dispose(){this.instance.selfVisibleEmitter.removeListener(this.drawableVisibilityListener),this.node.detachDrawable(this),this.instance=null,this.node=null,super.dispose()}updateSelfVisibility(){this.visible=this.instance.selfVisible}toDetailedString(){return`${this.toString()} (${this.instance.trail.toPathString()})`}}d.register("SelfDrawable",dt);const zu=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends r{initialize(e,t,...s){super.initialize(e,t,...s),this.fillCallback=this.fillCallback||this.markDirtyFill.bind(this),this.strokeCallback=this.strokeCallback||this.markDirtyStroke.bind(this),this.fillObserver=this.fillObserver||new xi(this.fillCallback),this.strokeObserver=this.strokeObserver||new xi(this.strokeCallback),this.fillObserver.setPrimary(t.node._fill),this.strokeObserver.setPrimary(t.node._stroke)}dispose(){this.fillObserver.clean(),this.strokeObserver.clean(),super.dispose()}markDirtyFill(){assert&&P.checkPaint(this.instance.node._fill),this.markPaintDirty(),this.fillObserver.setPrimary(this.instance.node._fill)}markDirtyStroke(){assert&&P.checkPaint(this.instance.node._stroke),this.markPaintDirty(),this.strokeObserver.setPrimary(this.instance.node._stroke)}markDirtyLineWidth(){this.markPaintDirty()}markDirtyLineOptions(){this.markPaintDirty()}markDirtyCachedPaints(){this.markPaintDirty()}}));d.register("PaintableStatelessDrawable",zu);const Qn=zu,Hi=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends r{initialize(e,t,...s){super.initialize(e,t,...s),this.dirtyFill=!0,this.hadStroke=!1,this.dirtyStroke=!0,this.dirtyLineWidth=!0,this.dirtyLineOptions=!0,this.dirtyCachedPaints=!0,this.lastCachedPaints=[],this.fillCallback=this.fillCallback||this.markDirtyFill.bind(this),this.strokeCallback=this.strokeCallback||this.markDirtyStroke.bind(this),this.fillObserver=this.fillObserver||new xi(this.fillCallback),this.strokeObserver=this.strokeObserver||new xi(this.strokeCallback),this.fillObserver.setPrimary(t.node._fill),this.strokeObserver.setPrimary(t.node._stroke)}cleanPaintableState(){this.dirtyFill=!1,this.dirtyStroke=!1,this.dirtyLineWidth=!1,this.dirtyLineOptions=!1,this.dirtyCachedPaints=!1,this.hadStroke=this.node.getStroke()!==null}dispose(){super.dispose(),this.fillObserver.clean(),this.strokeObserver.clean()}markDirtyFill(){assert&&P.checkPaint(this.instance.node._fill),this.dirtyFill=!0,this.markPaintDirty(),this.fillObserver.setPrimary(this.instance.node._fill)}markDirtyStroke(){assert&&P.checkPaint(this.instance.node._stroke),this.dirtyStroke=!0,this.markPaintDirty(),this.strokeObserver.setPrimary(this.instance.node._stroke)}markDirtyLineWidth(){this.dirtyLineWidth=!0,this.markPaintDirty()}markDirtyLineOptions(){this.dirtyLineOptions=!0,this.markPaintDirty()}markDirtyCachedPaints(){this.dirtyCachedPaints=!0,this.markPaintDirty()}}));d.register("PaintableStatefulDrawable",Hi);class gs extends dt{initialize(e,t){super.initialize(e,t),this.transformListener=this.transformListener||this.markTransformDirty.bind(this),t.relativeTransform.addListener(this.transformListener),t.relativeTransform.addPrecompute()}markTransformDirty(){this.markDirty()}markPaintDirty(){this.markDirty()}updateSelfVisibility(){super.updateSelfVisibility(),this.markDirty()}dispose(){this.instance.relativeTransform.removeListener(this.transformListener),this.instance.relativeTransform.removePrecompute(),super.dispose()}}d.register("CanvasSelfDrawable",gs);class Vi extends dt{initialize(e,t){return super.initialize(e,t),this.transformListener=this.transformListener||this.markTransformDirty.bind(this),this.markTransformDirty(),this.visibilityDirty=!0,t.relativeTransform.addListener(this.transformListener),t.relativeTransform.addPrecompute(),this}markTransformDirty(){this.transformDirty=!0,this.markDirty()}getTransformMatrix(){return this.instance.relativeTransform.validate(),this.instance.relativeTransform.matrix}update(){return super.update()?(this.updateDOM(),this.visibilityDirty&&(this.visibilityDirty=!1,this.domElement.style.visibility=this.visible?"":"hidden"),this.cleanPaintableState&&this.cleanPaintableState(),!0):!1}updateDOM(){}updateSelfVisibility(){super.updateSelfVisibility(),this.visibilityDirty||(this.visibilityDirty=!0,this.markDirty())}dispose(){this.instance.relativeTransform.removeListener(this.transformListener),this.instance.relativeTransform.removePrecompute(),super.dispose()}}d.register("DOMSelfDrawable",Vi);class ri extends dt{initialize(e,t,s,i){return assert&&assert(typeof s=="boolean"),assert&&assert(typeof i=="boolean"),super.initialize(e,t),this.usesPaint=s,this.keepElements=i,this.svgElement=null,this.svgBlock=null,this.usesPaint&&(this.paintState?this.paintState.initialize():this.paintState=new qd),this}update(){return super.update()?(this.updateSVG(),!0):!1}updateSVG(){if(this.paintDirty&&this.updateSVGSelf(this.node,this.svgElement),this.usesPaint&&this.dirtyCachedPaints){const e=this.node._cachedPaints.slice();let t,s;for(t=0;t<e.length;t++){const i=e[t];let n=!0;for(s=0;s<this.lastCachedPaints.length;s++)if(i===this.lastCachedPaints[s]){n=!1;break}n&&this.svgBlock.incrementPaint(i)}for(t=0;t<this.lastCachedPaints.length;t++){const i=this.lastCachedPaints[t];let n=!0;for(s=0;s<e.length;s++)if(i===e[s]){n=!1;break}n&&this.svgBlock.decrementPaint(i)}this.lastCachedPaints=e}this.setToCleanState()}updateFillStrokeStyle(e){if(!this.usesPaint)return;this.dirtyFill&&this.paintState.updateFill(this.svgBlock,this.node.getFillValue()),this.dirtyStroke&&this.paintState.updateStroke(this.svgBlock,this.node.getStrokeValue());const t=this.dirtyLineWidth||this.dirtyLineOptions;t&&this.paintState.updateStrokeDetailStyle(this.node),(this.dirtyFill||this.dirtyStroke||t)&&e.setAttribute("style",this.paintState.baseStyle+this.paintState.strokeDetailStyle),this.cleanPaintableState()}updateSVGBlock(e){const t=this.svgBlock;if(this.usesPaint&&t)for(let s=0;s<this.lastCachedPaints.length;s++)t.decrementPaint(this.lastCachedPaints[s]);if(this.svgBlock=e,this.usesPaint)for(let s=0;s<this.lastCachedPaints.length;s++)e.incrementPaint(this.lastCachedPaints[s]);this.updateDefsSelf&&this.updateDefsSelf(e),this.usesPaint&&this.paintState.updateSVGBlock(e),this.usesPaint&&this.markDirtyFill(),this.usesPaint&&this.markDirtyStroke()}dispose(){this.keepElements||(this.svgElement=null),this.updateDefsSelf&&this.updateDefsSelf(null),this.usesPaint&&this.paintState.dispose(),this.defs=null,this.svgBlock=null,super.dispose()}}d.register("SVGSelfDrawable",ri);class Zn extends dt{initialize(e,t){return super.initialize(e,t),this.transformListener=this.transformListener||this.markTransformDirty.bind(this),t.relativeTransform.addListener(this.transformListener),t.relativeTransform.addPrecompute(),this}markTransformDirty(){this.markDirty()}updateSelfVisibility(){super.updateSelfVisibility(),this.markDirty()}dispose(){this.instance.relativeTransform.removeListener(this.transformListener),this.instance.relativeTransform.removePrecompute(),super.dispose()}}d.register("WebGLSelfDrawable",Zn);const Lh=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends Hi(r){initialize(e,t,...s){super.initialize(e,t,...s),this.paintDirty=!0,this.dirtyRadius=!0}markPaintDirty(){this.paintDirty=!0,this.markDirty()}markDirtyRadius(){this.dirtyRadius=!0,this.markPaintDirty()}setToCleanState(){this.paintDirty=!1,this.dirtyRadius=!1}}));d.register("CircleStatefulDrawable",Lh);const Wu=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends r{initialize(e,t,...s){super.initialize(e,t,...s),this.paintDirty=!0,this.dirtyImage=!0,this.dirtyImageOpacity=!0,this.dirtyMipmap=!0}markPaintDirty(){this.paintDirty=!0,this.markDirty()}markDirtyImage(){this.dirtyImage=!0,this.markPaintDirty()}markDirtyImageOpacity(){this.dirtyImageOpacity=!0,this.markPaintDirty()}markDirtyMipmap(){this.dirtyMipmap=!0,this.markPaintDirty()}setToCleanState(){this.paintDirty=!1,this.dirtyImage=!1,this.dirtyImageOpacity=!1,this.dirtyMipmap=!1}}));d.register("ImageStatefulDrawable",Wu);const vh=Wu,$u=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends Qn(r){initialize(e,t,...s){super.initialize(e,t,...s),this.paintDirty=!0}markPaintDirty(){this.paintDirty=!0,this.markDirty()}markDirtyLine(){this.markPaintDirty()}markDirtyP1(){this.markPaintDirty()}markDirtyP2(){this.markPaintDirty()}markDirtyX1(){this.markPaintDirty()}markDirtyY1(){this.markPaintDirty()}markDirtyX2(){this.markPaintDirty()}markDirtyY2(){this.markPaintDirty()}}));d.register("LineStatelessDrawable",$u);const Uu=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends Hi(r){initialize(e,t,...s){super.initialize(e,t,...s),this.paintDirty=!0,this.dirtyX1=!0,this.dirtyY1=!0,this.dirtyX2=!0,this.dirtyY2=!0}markPaintDirty(){this.paintDirty=!0,this.markDirty()}markDirtyLine(){this.dirtyX1=!0,this.dirtyY1=!0,this.dirtyX2=!0,this.dirtyY2=!0,this.markPaintDirty()}markDirtyP1(){this.dirtyX1=!0,this.dirtyY1=!0,this.markPaintDirty()}markDirtyP2(){this.dirtyX2=!0,this.dirtyY2=!0,this.markPaintDirty()}markDirtyX1(){this.dirtyX1=!0,this.markPaintDirty()}markDirtyY1(){this.dirtyY1=!0,this.markPaintDirty()}markDirtyX2(){this.dirtyX2=!0,this.markPaintDirty()}markDirtyY2(){this.dirtyY2=!0,this.markPaintDirty()}setToCleanState(){this.paintDirty=!1,this.dirtyX1=!1,this.dirtyY1=!1,this.dirtyX2=!1,this.dirtyY2=!1}}));d.register("LineStatefulDrawable",Uu);const Yu=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends Hi(r){initialize(e,t,...s){super.initialize(e,t,...s),this.paintDirty=!0,this.dirtyShape=!0}markPaintDirty(){this.paintDirty=!0,this.markDirty()}markDirtyShape(){this.dirtyShape=!0,this.markPaintDirty()}setToCleanState(){this.paintDirty=!1,this.dirtyShape=!1}}));d.register("PathStatefulDrawable",Yu);const ly=Yu,ta=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends Hi(r){initialize(e,t,...s){super.initialize(e,t,...s),this.paintDirty=!0,this.dirtyX=!0,this.dirtyY=!0,this.dirtyWidth=!0,this.dirtyHeight=!0,this.dirtyCornerXRadius=!0,this.dirtyCornerYRadius=!0}markPaintDirty(){this.paintDirty=!0,this.markDirty()}markDirtyRectangle(){this.dirtyX=!0,this.dirtyY=!0,this.dirtyWidth=!0,this.dirtyHeight=!0,this.dirtyCornerXRadius=!0,this.dirtyCornerYRadius=!0,this.markPaintDirty()}markDirtyX(){this.dirtyX=!0,this.markPaintDirty()}markDirtyY(){this.dirtyY=!0,this.markPaintDirty()}markDirtyWidth(){this.dirtyWidth=!0,this.markPaintDirty()}markDirtyHeight(){this.dirtyHeight=!0,this.markPaintDirty()}markDirtyCornerXRadius(){this.dirtyCornerXRadius=!0,this.markPaintDirty()}markDirtyCornerYRadius(){this.dirtyCornerYRadius=!0,this.markPaintDirty()}setToCleanState(){this.paintDirty=!1,this.dirtyX=!1,this.dirtyY=!1,this.dirtyWidth=!1,this.dirtyHeight=!1,this.dirtyCornerXRadius=!1,this.dirtyCornerYRadius=!1}}));d.register("RectangleStatefulDrawable",ta);const Ku=Me(r=>(assert&&assert(_.includes(ct(r),dt)),class extends Hi(r){initialize(e,t,...s){super.initialize(e,t,...s),this.paintDirty=!0,this.dirtyText=!0,this.dirtyFont=!0,this.dirtyBounds=!0}markPaintDirty(){this.paintDirty=!0,this.markDirty()}markDirtyText(){this.dirtyText=!0,this.markPaintDirty()}markDirtyFont(){this.dirtyFont=!0,this.markPaintDirty()}markDirtyBounds(){this.dirtyBounds=!0,this.markPaintDirty()}setToCleanState(){this.paintDirty=!1,this.dirtyText=!1,this.dirtyFont=!1,this.dirtyBounds=!1}}));d.register("TextStatefulDrawable",Ku);const Xu=Ku,cy=[];class Ph extends gs{paintCanvas(e,t,s){if(assert&&assert(!t.selfBounds.isEmpty(),`CanvasNode should not be used with an empty canvasBounds. Please set canvasBounds (or use setCanvasBounds()) on ${t.constructor.name}`),!t.selfBounds.isEmpty()){const i=e.context;i.save(),i.fillStyle="black",i.strokeStyle="black",i.lineWidth=1,i.lineCap="butt",i.lineJoin="miter",i.lineDash=cy,i.lineDashOffset=0,i.miterLimit=10,t.paintCanvas(i),i.restore()}}}d.register("CanvasNodeDrawable",Ph);ae.mixInto(Ph);const dy=Ph;class _h extends Qn(gs){paintCanvas(e,t,s){assert&&assert(t instanceof D);const i=e.context;i.beginPath(),i.arc(0,0,t._radius,0,Math.PI*2,!1),i.closePath(),t.hasFill()&&(t.beforeCanvasFill(e),i.fill(),t.afterCanvasFill(e)),t.hasPaintableStroke()&&(t.beforeCanvasStroke(e),i.stroke(),t.afterCanvasStroke(e))}markDirtyRadius(){this.markPaintDirty()}dispose(){super.dispose()}}d.register("CircleCanvasDrawable",_h);ae.mixInto(_h);const Dc=_h;class Sh extends Lh(Vi){constructor(e,t){super(e,t),Y.prepareForTransform(this.domElement)}initialize(e,t){if(super.initialize(e,t),this.matrix=this.matrix||C.pool.fetch(),!this.fillElement||!this.strokeElement){const s=document.createElement("div");this.fillElement=s;const i=document.createElement("div");this.strokeElement=i,s.style.display="block",s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.pointerEvents="none",i.style.display="block",i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.pointerEvents="none",s.appendChild(i)}this.domElement=this.fillElement}updateDOM(){const e=this.node,t=this.fillElement,s=this.strokeElement;if(this.paintDirty&&(this.dirtyRadius&&(t.style.width=`${2*e._radius}px`,t.style.height=`${2*e._radius}px`,t.style[A.borderRadius]=`${e._radius}px`),this.dirtyFill&&(t.style.backgroundColor=e.getCSSFill()),this.dirtyStroke&&(e.hasStroke()?s.style.borderStyle="solid":s.style.borderStyle="none"),e.hasStroke())){const i=!this.hadStroke;(i||this.dirtyLineWidth||this.dirtyRadius)&&(s.style.width=`${2*e._radius-e.getLineWidth()}px`,s.style.height=`${2*e._radius-e.getLineWidth()}px`,s.style[A.borderRadius]=`${e._radius+e.getLineWidth()/2}px`),(i||this.dirtyLineWidth)&&(s.style.left=`${-e.getLineWidth()/2}px`,s.style.top=`${-e.getLineWidth()/2}px`,s.style.borderWidth=`${e.getLineWidth()}px`),(i||this.dirtyStroke)&&(s.style.borderColor=e.getSimpleCSSStroke())}if(this.transformDirty||this.dirtyRadius){this.matrix.set(this.getTransformMatrix());const i=C.translation(-e._radius,-e._radius);this.matrix.multiplyMatrix(i),i.freeToPool(),Y.applyPreparedTransform(this.matrix,this.fillElement)}this.setToCleanState(),this.cleanPaintableState(),this.transformDirty=!1}dispose(){super.dispose()}}d.register("CircleDOMDrawable",Sh);ae.mixInto(Sh);const uy=Sh,py=!0;class wh extends Lh(ri){initialize(e,t){super.initialize(e,t,!0,py),this.svgElement=this.svgElement||document.createElementNS(ne,"circle")}updateSVGSelf(){const e=this.svgElement;this.dirtyRadius&&e.setAttribute("r",this.node._radius),this.updateFillStrokeStyle(e)}}d.register("CircleSVGDrawable",wh);ae.mixInto(wh);const gy=wh;class Dh extends Vi{constructor(e,t){super(e,t),Y.prepareForTransform(this.domElement)}initialize(e,t){super.initialize(e,t),this.domElement=this.node._container}updateDOM(){this.transformDirty&&!this.node._preventTransform&&Y.applyPreparedTransform(this.getTransformMatrix(),this.domElement),this.transformDirty=!1}dispose(){super.dispose(),this.domElement=null}}d.register("DOMDrawable",Dh);ae.mixInto(Dh);const ko=Dh;class Th extends gs{paintCanvas(e,t,s){const i=t._imageOpacity!==1;if(t._image&&t._image.width!==0&&t._image.height!==0){if(i&&(e.context.save(),e.context.globalAlpha*=t._imageOpacity),t._mipmap&&t.hasMipmaps()){const n=t.getMipmapLevel(s,ht.CANVAS_MIPMAP_BIAS_ADJUSTMENT),a=t.getMipmapCanvas(n),o=Math.pow(2,n);e.context.drawImage(a,0,0,a.width*o,a.height*o)}else e.context.drawImage(t._image,0,0);i&&e.context.restore()}}markDirtyImage(){this.markPaintDirty()}markDirtyMipmap(){this.markPaintDirty()}markDirtyImageOpacity(){this.markPaintDirty()}}d.register("ImageCanvasDrawable",Th);ae.mixInto(Th);const Tc=Th;class Ch extends vh(Vi){constructor(e,t){super(e,t),Y.prepareForTransform(this.domElement)}initialize(e,t){super.initialize(e,t),this.domElement||(this.domElement=document.createElement("img"),this.domElement.style.display="block",this.domElement.style.position="absolute",this.domElement.style.pointerEvents="none",this.domElement.style.left="0",this.domElement.style.top="0"),this.hasOpacity=!1}updateDOM(){const e=this.node,t=this.domElement;this.paintDirty&&this.dirtyImage&&(t.src=e._image?e._image.src:"//:0"),this.dirtyImageOpacity&&(e._imageOpacity===1?this.hasOpacity&&(this.hasOpacity=!1,t.style.opacity=""):(this.hasOpacity=!0,t.style.opacity=e._imageOpacity)),this.transformDirty&&Y.applyPreparedTransform(this.getTransformMatrix(),this.domElement),this.setToCleanState(),this.transformDirty=!1}dispose(){super.dispose()}}d.register("ImageDOMDrawable",Ch);ae.mixInto(Ch);const my=Ch,fy=!0;class Ih extends vh(ri){initialize(e,t){super.initialize(e,t,!1,fy),sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} initialized for ${t.toString()}`),this.svgElement=this.svgElement||document.createElementNS(ne,"image"),this.svgElement.setAttribute("x","0"),this.svgElement.setAttribute("y","0"),this.hasOpacity=!1,this.usingMipmap=!1,this.mipmapLevel=-1,this._mipmapTransformListener=this._mipmapTransformListener||this.onMipmapTransform.bind(this),this._mipmapListener=this._mipmapListener||this.onMipmap.bind(this),this.node.mipmapEmitter.addListener(this._mipmapListener),this.updateMipmapStatus(t.node._mipmap)}updateSVGSelf(){const e=this.svgElement;this.dirtyImage?(sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} Updating dirty image`),this.node._image?this.updateURL(e,!0):(e.setAttribute("width","0"),e.setAttribute("height","0"),e.setAttributeNS(vi,"xlink:href","//:0"))):this.dirtyMipmap&&this.node._image&&(sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} Updating dirty mipmap`),this.updateURL(e,!1)),this.dirtyImageOpacity&&(this.node._imageOpacity===1?this.hasOpacity&&(this.hasOpacity=!1,e.removeAttribute("opacity")):(this.hasOpacity=!0,e.setAttribute("opacity",this.node._imageOpacity)))}updateURL(e,t){let s=-1;if(this.node._mipmap&&(s=this.node.getMipmapLevel(this.instance.relativeTransform.matrix),sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} Mipmap level: ${s}`)),!(!t&&s===this.mipmapLevel))if(this.mipmapLevel>=0&&s===-1&&e.removeAttribute("transform"),this.mipmapLevel=s,this.node._mipmap&&this.node.hasMipmaps()){sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} Setting image URL to mipmap level ${s}`);const i=this.node.getMipmapURL(s),n=this.node.getMipmapCanvas(s);e.setAttribute("width",`${n.width}px`),e.setAttribute("height",`${n.height}px`),e.setAttribute("transform",`scale(${Math.pow(2,s).toFixed(20)})`),e.setAttributeNS(vi,"xlink:href",i)}else sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} Setting image URL`),e.setAttribute("width",`${this.node.getImageWidth()}px`),e.setAttribute("height",`${this.node.getImageHeight()}px`),e.setAttributeNS(vi,"xlink:href",this.node.getImageURL())}updateMipmapStatus(e){this.usingMipmap!==e&&(this.usingMipmap=e,e?(sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} Adding mipmap compute/listener needs`),this.instance.relativeTransform.addListener(this._mipmapTransformListener),this.instance.relativeTransform.addPrecompute()):(sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} Removing mipmap compute/listener needs`),this.instance.relativeTransform.removeListener(this._mipmapTransformListener),this.instance.relativeTransform.removePrecompute()),this.markDirtyMipmap())}onMipmap(){this.markDirtyMipmap(),this.updateMipmapStatus(this.node._mipmap)}onMipmapTransform(){sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} Transform dirties mipmap`),this.markDirtyMipmap()}dispose(){sceneryLog&&sceneryLog.ImageSVGDrawable&&sceneryLog.ImageSVGDrawable(`${this.id} disposing`),this.updateMipmapStatus(!1),this.node.mipmapEmitter.removeListener(this._mipmapListener),super.dispose()}}d.register("ImageSVGDrawable",Ih);ae.mixInto(Ih);const yy=Ih,ai=5,tn=ai*0,sn=ai*1,nn=ai*2,rn=ai*3,an=ai*4,on=ai*5,pi=0,gi=1,mi=2,fi=3,yi=4;class sa extends vh(Zn){initialize(e,t){super.initialize(e,t),this.vertexArray=this.vertexArray||new Float32Array(ai*6),this.upperLeft=new T(0,0),this.lowerLeft=new T(0,0),this.upperRight=new T(0,0),this.lowerRight=new T(0,0),this.xyDirty=!0,this.uvDirty=!0,this.updatedOnce=!1,this.sprite=null}onAddToBlock(e){this.webglBlock=e,this.markDirty(),this.reserveSprite()}onRemoveFromBlock(e){this.unreserveSprite()}reserveSprite(){if(this.sprite){if(this.sprite.image===this.node._image)return;this.unreserveSprite()}const e=this.node.getImageWidth(),t=this.node.getImageHeight();this.sprite=e>0&&t>0?this.webglBlock.addSpriteSheetImage(this.node._image,e,t):null,this.xyDirty=!0,this.uvDirty=!0}unreserveSprite(){this.sprite&&this.webglBlock.removeSpriteSheetImage(this.sprite),this.sprite=null}markTransformDirty(){this.xyDirty=!0,super.markTransformDirty()}markPaintDirty(){this.xyDirty=!0,this.uvDirty=!0,this.markDirty()}update(){if(!super.update()||(this.reserveSprite(),(this.dirtyImageOpacity||!this.updatedOnce)&&(this.vertexArray[tn+yi]=this.node._imageOpacity,this.vertexArray[sn+yi]=this.node._imageOpacity,this.vertexArray[nn+yi]=this.node._imageOpacity,this.vertexArray[rn+yi]=this.node._imageOpacity,this.vertexArray[an+yi]=this.node._imageOpacity,this.vertexArray[on+yi]=this.node._imageOpacity),this.updatedOnce=!0,!this.sprite))return!1;if(this.uvDirty){this.uvDirty=!1;const e=this.sprite.uvBounds;this.vertexArray[tn+mi]=e.minX,this.vertexArray[tn+fi]=e.minY,this.vertexArray[sn+mi]=e.minX,this.vertexArray[sn+fi]=e.maxY,this.vertexArray[nn+mi]=e.maxX,this.vertexArray[nn+fi]=e.minY,this.vertexArray[rn+mi]=e.maxX,this.vertexArray[rn+fi]=e.minY,this.vertexArray[an+mi]=e.minX,this.vertexArray[an+fi]=e.maxY,this.vertexArray[on+mi]=e.maxX,this.vertexArray[on+fi]=e.maxY}if(this.xyDirty){this.xyDirty=!1;const e=this.node.getImageWidth(),t=this.node.getImageHeight(),s=this.instance.relativeTransform.matrix;s.multiplyVector2(this.upperLeft.setXY(0,0)),s.multiplyVector2(this.lowerLeft.setXY(0,t)),s.multiplyVector2(this.upperRight.setXY(e,0)),s.multiplyVector2(this.lowerRight.setXY(e,t)),this.vertexArray[tn+pi]=this.upperLeft.x,this.vertexArray[tn+gi]=this.upperLeft.y,this.vertexArray[sn+pi]=this.lowerLeft.x,this.vertexArray[sn+gi]=this.lowerLeft.y,this.vertexArray[nn+pi]=this.upperRight.x,this.vertexArray[nn+gi]=this.upperRight.y,this.vertexArray[rn+pi]=this.upperRight.x,this.vertexArray[rn+gi]=this.upperRight.y,this.vertexArray[an+pi]=this.lowerLeft.x,this.vertexArray[an+gi]=this.lowerLeft.y,this.vertexArray[on+pi]=this.lowerRight.x,this.vertexArray[on+gi]=this.lowerRight.y}return!0}}sa.prototype.webglRenderer=p.webglTexturedTriangles;d.register("ImageWebGLDrawable",sa);ae.mixInto(sa);const by=sa;class Eh extends $u(gs){paintCanvas(e,t,s){assert&&assert(t instanceof D);const i=e.context;i.beginPath(),i.moveTo(t.x1,t.y1),i.lineTo(t.x2,t.y2),t.hasPaintableStroke()&&(t.beforeCanvasStroke(e),i.stroke(),t.afterCanvasStroke(e))}}d.register("LineCanvasDrawable",Eh);ae.mixInto(Eh);const Cc=Eh,Ly=!0;class kh extends Uu(ri){initialize(e,t){super.initialize(e,t,!0,Ly),this.svgElement=this.svgElement||document.createElementNS(ne,"line")}updateSVGSelf(){const e=this.svgElement;this.dirtyX1&&e.setAttribute("x1",this.node.x1),this.dirtyY1&&e.setAttribute("y1",this.node.y1),this.dirtyX2&&e.setAttribute("x2",this.node.x2),this.dirtyY2&&e.setAttribute("y2",this.node.y2),this.updateFillStrokeStyle(e)}}d.register("LineSVGDrawable",kh);ae.mixInto(kh);const vy=kh;class Ah extends Qn(gs){paintCanvas(e,t,s){const i=e.context;t.hasShape()&&(i.beginPath(),t._shape.writeToContext(i),t.hasFill()&&(t.beforeCanvasFill(e),i.fill(),t.afterCanvasFill(e)),t.hasPaintableStroke()&&(t.beforeCanvasStroke(e),i.stroke(),t.afterCanvasStroke(e)))}markDirtyShape(){this.markPaintDirty()}}d.register("PathCanvasDrawable",Ah);ae.mixInto(Ah);const Ic=Ah,Py=!0,_y=Te.safari;class xh extends ly(ri){initialize(e,t){super.initialize(e,t,!0,Py),this.svgElement=this.svgElement||document.createElementNS(ne,"path")}updateSVGSelf(){assert&&assert(!this.node.requiresSVGBoundsWorkaround(),"No workaround for https://github.com/phetsims/scenery/issues/196 is provided at this time, please add an epsilon");const e=this.svgElement;if(this.dirtyShape){let t=this.node.hasShape()?_y?this.node._shape.getSVGPathWithSafariWorkaround():this.node._shape.getSVGPath():"";t||(t="M0 0"),e.setAttribute("d",`${t}${Te.safari?" M0 0":""}`)}this.updateFillStrokeStyle(e)}}d.register("PathSVGDrawable",xh);ae.mixInto(xh);const Sy=xh;class Oh extends Qn(gs){writeRectangularPath(e,t){e.beginPath(),e.moveTo(t._rectX,t._rectY),e.lineTo(t._rectX+t._rectWidth,t._rectY),e.lineTo(t._rectX+t._rectWidth,t._rectY+t._rectHeight),e.lineTo(t._rectX,t._rectY+t._rectHeight),e.closePath()}paintCanvas(e,t,s){const i=e.context;if(t.isRounded()){i.beginPath();const n=t.getMaximumArcSize(),a=Math.min(t._cornerXRadius,n),o=Math.min(t._cornerYRadius,n),h=t._rectX+a,l=t._rectX+t._rectWidth-a,c=t._rectY+o,u=t._rectY+t._rectHeight-o;a===o?(i.arc(l,c,a,-Math.PI/2,0,!1),i.arc(l,u,a,0,Math.PI/2,!1),i.arc(h,u,a,Math.PI/2,Math.PI,!1),i.arc(h,c,a,Math.PI,Math.PI*3/2,!1)):(i.ellipse(l,c,a,o,0,-Math.PI/2,0,!1),i.ellipse(l,u,a,o,0,0,Math.PI/2,!1),i.ellipse(h,u,a,o,0,Math.PI/2,Math.PI,!1),i.ellipse(h,c,a,o,0,Math.PI,Math.PI*3/2,!1)),i.closePath(),t.hasFill()&&(t.beforeCanvasFill(e),i.fill(),t.afterCanvasFill(e)),t.hasPaintableStroke()&&(t.beforeCanvasStroke(e),i.stroke(),t.afterCanvasStroke(e))}else t.hasFill()&&(t.getFillValue().transformMatrix?(this.writeRectangularPath(i,t),t.beforeCanvasFill(e),i.fill(),t.afterCanvasFill(e)):(t.beforeCanvasFill(e),i.fillRect(t._rectX,t._rectY,t._rectWidth,t._rectHeight),t.afterCanvasFill(e))),t.hasPaintableStroke()&&(t.getStrokeValue().transformMatrix?(this.writeRectangularPath(i,t),t.beforeCanvasStroke(e),i.stroke(),t.afterCanvasStroke(e)):(t.beforeCanvasStroke(e),i.strokeRect(t._rectX,t._rectY,t._rectWidth,t._rectHeight),t.afterCanvasStroke(e)))}markDirtyRectangle(){this.markPaintDirty()}markDirtyX(){this.markDirtyRectangle()}markDirtyY(){this.markDirtyRectangle()}markDirtyWidth(){this.markDirtyRectangle()}markDirtyHeight(){this.markDirtyRectangle()}markDirtyCornerXRadius(){this.markDirtyRectangle()}markDirtyCornerYRadius(){this.markDirtyRectangle()}}d.register("RectangleCanvasDrawable",Oh);ae.mixInto(Oh);const Ec=Oh,Wa=C.pool.fetch();class Mh extends ta(Vi){constructor(e,t){super(e,t),Y.prepareForTransform(this.domElement)}initialize(e,t){if(super.initialize(e,t),!this.fillElement||!this.strokeElement){const s=document.createElement("div");this.fillElement=s,s.style.display="block",s.style.position="absolute",s.style.left="0",s.style.top="0",s.style.pointerEvents="none";const i=document.createElement("div");this.strokeElement=i,i.style.display="block",i.style.position="absolute",i.style.left="0",i.style.top="0",i.style.pointerEvents="none",s.appendChild(i)}this.domElement=this.fillElement}updateDOM(){const e=this.node,t=this.fillElement,s=this.strokeElement;if(this.paintDirty){const i=Math.min(e._cornerXRadius,e._cornerYRadius),n=this.dirtyCornerXRadius||this.dirtyCornerYRadius;if(this.dirtyWidth&&(t.style.width=`${e._rectWidth}px`),this.dirtyHeight&&(t.style.height=`${e._rectHeight}px`),n&&(t.style[A.borderRadius]=`${i}px`),this.dirtyFill&&(t.style.backgroundColor=e.getCSSFill()),this.dirtyStroke&&(e.hasStroke()?s.style.borderStyle="solid":s.style.borderStyle="none"),e.hasStroke()){const a=!this.hadStroke;(a||this.dirtyWidth||this.dirtyLineWidth)&&(s.style.width=`${e._rectWidth-e.getLineWidth()}px`),(a||this.dirtyHeight||this.dirtyLineWidth)&&(s.style.height=`${e._rectHeight-e.getLineWidth()}px`),(a||this.dirtyLineWidth)&&(s.style.left=`${-e.getLineWidth()/2}px`,s.style.top=`${-e.getLineWidth()/2}px`,s.style.borderWidth=`${e.getLineWidth()}px`),(a||this.dirtyStroke)&&(s.style.borderColor=e.getSimpleCSSStroke()),(a||n||this.dirtyLineWidth||this.dirtyLineOptions)&&(s.style[A.borderRadius]=e.isRounded()||e.getLineJoin()==="round"?`${i+e.getLineWidth()/2}px`:"0")}}if(this.transformDirty||this.dirtyX||this.dirtyY){Wa.set(this.getTransformMatrix());const i=C.translation(e._rectX,e._rectY);Wa.multiplyMatrix(i),i.freeToPool(),Y.applyPreparedTransform(Wa,this.fillElement)}this.setToCleanState(),this.cleanPaintableState(),this.transformDirty=!1}dispose(){super.dispose()}}d.register("RectangleDOMDrawable",Mh);ae.mixInto(Mh);const wy=Mh,Dy=!0;class Rh extends ta(ri){initialize(e,t){super.initialize(e,t,!0,Dy),this.lastArcW=-1,this.lastArcH=-1,this.svgElement=this.svgElement||document.createElementNS(ne,"rect")}updateSVGSelf(){const e=this.svgElement;if(this.dirtyX&&e.setAttribute("x",this.node._rectX),this.dirtyY&&e.setAttribute("y",this.node._rectY),this.dirtyWidth&&e.setAttribute("width",this.node._rectWidth),this.dirtyHeight&&e.setAttribute("height",this.node._rectHeight),this.dirtyCornerXRadius||this.dirtyCornerYRadius||this.dirtyWidth||this.dirtyHeight){let t=0,s=0;if(this.node.isRounded()){const i=this.node.getMaximumArcSize();t=Math.min(this.node._cornerXRadius,i),s=Math.min(this.node._cornerYRadius,i)}t!==this.lastArcW&&(this.lastArcW=t,e.setAttribute("rx",t)),s!==this.lastArcH&&(this.lastArcH=s,e.setAttribute("ry",s))}this.updateFillStrokeStyle(e)}}d.register("RectangleSVGDrawable",Rh);ae.mixInto(Rh);const Ty=Rh,Cy=new P("transparent");class ia extends ta(Zn){initialize(e,t){super.initialize(e,t),this.vertexArray||(this.vertexArray=new Float32Array(6*6)),this.upperLeft=new T(0,0),this.lowerLeft=new T(0,0),this.upperRight=new T(0,0),this.lowerRight=new T(0,0),this.transformDirty=!0,this.includeVertices=!0}onAddToBlock(e){this.webglBlock=e,this.markDirty()}onRemoveFromBlock(e){}markTransformDirty(){this.transformDirty=!0,super.markTransformDirty()}update(){if(!super.update())return!1;if(this.dirtyFill&&(this.includeVertices=this.node.hasFill(),this.includeVertices)){const e=O(this.node.fill)?this.node.fill.value:this.node.fill,t=Cy.set(e),s=t.red/255,i=t.green/255,n=t.blue/255,a=t.alpha;for(let o=0;o<6;o++){const h=o*6;this.vertexArray[2+h]=s,this.vertexArray[3+h]=i,this.vertexArray[4+h]=n,this.vertexArray[5+h]=a}}if(this.transformDirty||this.dirtyX||this.dirtyY||this.dirtyWidth||this.dirtyHeight){this.transformDirty=!1;const e=this.node._rectX,t=this.node._rectY,s=this.node._rectWidth,i=this.node._rectHeight,n=this.instance.relativeTransform.matrix;n.multiplyVector2(this.upperLeft.setXY(e,t)),n.multiplyVector2(this.lowerLeft.setXY(e,t+i)),n.multiplyVector2(this.upperRight.setXY(e+s,t)),n.multiplyVector2(this.lowerRight.setXY(e+s,t+i)),this.vertexArray[0]=this.upperLeft.x,this.vertexArray[1]=this.upperLeft.y,this.vertexArray[6]=this.lowerLeft.x,this.vertexArray[7]=this.lowerLeft.y,this.vertexArray[12]=this.upperRight.x,this.vertexArray[13]=this.upperRight.y,this.vertexArray[18]=this.upperRight.x,this.vertexArray[19]=this.upperRight.y,this.vertexArray[24]=this.lowerLeft.x,this.vertexArray[25]=this.lowerLeft.y,this.vertexArray[30]=this.lowerRight.x,this.vertexArray[31]=this.lowerRight.y}return this.setToCleanState(),this.cleanPaintableState(),!0}}ia.prototype.webglRenderer=p.webglVertexColorPolygons;d.register("RectangleWebGLDrawable",ia);ae.mixInto(ia);const Iy=ia;class Nh extends gs{paintCanvas(e,t,s){assert&&assert(t instanceof D);const i=ht.getApproximateMatrixScale(s)*(window.devicePixelRatio||1),n=t._spriteInstances.length;assert&&n>0&&assert(t.canvasBounds.isValid(),"Sprites canvasBounds should be set and have non-negative area if it renders sprites");for(let a=0;a<n;a++){const o=t._spriteInstances[a],h=o.sprite.imageProperty.value,l=o.alpha!==1||h.imageOpacity!==1,c=h._mipmap&&h.hasMipmaps();if(l&&(e.context.save(),e.context.globalAlpha*=o.alpha*h.imageOpacity),o.transformType===Ys.TRANSLATION&&s.isTranslation())if(c){const u=h.getMipmapLevelFromScale(i,ht.CANVAS_MIPMAP_BIAS_ADJUSTMENT),m=h.getMipmapCanvas(u),b=Math.pow(2,u);e.context.drawImage(m,o.matrix.m02()-h.offset.x,o.matrix.m12()-h.offset.y,m.width*b,m.height*b)}else e.context.drawImage(h.image,o.matrix.m02()-h.offset.x,o.matrix.m12()-h.offset.y);else{if(e.context.save(),o.matrix.canvasAppendTransform(e.context),c){const u=h.getMipmapLevelFromScale(i*ht.getApproximateMatrixScale(o.matrix),ht.CANVAS_MIPMAP_BIAS_ADJUSTMENT),m=h.getMipmapCanvas(u),b=Math.pow(2,u);e.context.drawImage(m,-h.offset.x,-h.offset.y,m.width*b,m.height*b)}else e.context.drawImage(h.image,-h.offset.x,-h.offset.y);e.context.restore()}l&&e.context.restore()}}}d.register("SpritesCanvasDrawable",Nh);ae.mixInto(Nh);const kc=Nh,Ao=5,$a=Ao*6,Ua=new T(0,0),hn=new T(0,0),ln=new T(0,0),Ya=new T(0,0);class na extends Zn{initialize(e,t){super.initialize(e,t),this.contextChangeListener=this.onWebGLContextChange.bind(this),this.spriteSheet=new Os(!0),this.spriteImageUVMap={},this.vertexArray=new Float32Array(128*$a),this.transformMatrixArray=new Float32Array(9),this.spriteChangeListener=this.onSpriteChange.bind(this),this.node._sprites.forEach(s=>{s.imageProperty.lazyLink(this.spriteChangeListener),this.addSpriteImage(s.imageProperty.value)}),this.hasDrawn=!1}addSpriteImage(e){this.spriteImageUVMap[e.id]=this.spriteSheet.addImage(e.image,e.image.width,e.image.height).uvBounds}removeSpriteImage(e){this.spriteSheet.removeImage(e.image),delete this.spriteImageUVMap[e.id]}onSpriteChange(e,t){this.removeSpriteImage(t),this.addSpriteImage(e)}setup(){const e=this.webGLBlock.gl;this.spriteSheet.initializeContext(e),this.shaderProgram=new Wr(e,["attribute vec2 aVertex;","attribute vec2 aTextureCoord;","attribute float aAlpha;","varying vec2 vTextureCoord;","varying float vAlpha;","uniform mat3 uProjectionMatrix;","uniform mat3 uTransformMatrix;","void main() {","  vTextureCoord = aTextureCoord;","  vAlpha = aAlpha;","  vec3 ndc = uProjectionMatrix * ( uTransformMatrix * vec3( aVertex, 1.0 ) );","  gl_Position = vec4( ndc.xy, 0.0, 1.0 );","}"].join(`
`),["precision mediump float;","varying vec2 vTextureCoord;","varying float vAlpha;","uniform sampler2D uTexture;","void main() {","  vec4 color = texture2D( uTexture, vTextureCoord, -0.7 );","  color *= vAlpha;","  gl_FragColor = color;","}"].join(`
`),{attributes:["aVertex","aTextureCoord","aAlpha"],uniforms:["uTexture","uProjectionMatrix","uTransformMatrix"]}),this.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertexArray,e.DYNAMIC_DRAW)}onWebGLContextChange(){this.setup()}onAddToBlock(e){this.webGLBlock=e,this.setup(),e.glChangedEmitter.addListener(this.contextChangeListener)}onRemoveFromBlock(e){e.glChangedEmitter.removeListener(this.contextChangeListener)}draw(){const e=this.node._spriteInstances.length;if(e===0)return 0;assert&&assert(this.node.canvasBounds.isValid(),"Sprites canvasBounds should be set and have non-negative area if it renders sprites"),this.spriteSheet.updateTexture(),this.shaderProgram.use();let t=0,s=!1;for(;$a*e>this.vertexArray.length;)this.vertexArray=new Float32Array(this.vertexArray.length*2),s=!0;for(let o=0;o<e;o++){const h=this.node._spriteInstances[o],l=h.sprite.imageProperty.value,c=h.alpha*l.imageOpacity,u=this.spriteImageUVMap[l.id],m=h.matrix,b=l.offset,y=l.image.width,f=l.image.height;m.multiplyVector2(Ua.setXY(-b.x,-b.y)),m.multiplyVector2(hn.setXY(-b.x,f-b.y)),m.multiplyVector2(ln.setXY(y-b.x,-b.y)),m.multiplyVector2(Ya.setXY(y-b.x,f-b.y)),this.vertexArray[t+0]=Ua.x,this.vertexArray[t+1]=Ua.y,this.vertexArray[t+2]=u.minX,this.vertexArray[t+3]=u.minY,this.vertexArray[t+4]=c,this.vertexArray[t+5]=hn.x,this.vertexArray[t+6]=hn.y,this.vertexArray[t+7]=u.minX,this.vertexArray[t+8]=u.maxY,this.vertexArray[t+9]=c,this.vertexArray[t+10]=ln.x,this.vertexArray[t+11]=ln.y,this.vertexArray[t+12]=u.maxX,this.vertexArray[t+13]=u.minY,this.vertexArray[t+14]=c,this.vertexArray[t+15]=ln.x,this.vertexArray[t+16]=ln.y,this.vertexArray[t+17]=u.maxX,this.vertexArray[t+18]=u.minY,this.vertexArray[t+19]=c,this.vertexArray[t+20]=hn.x,this.vertexArray[t+21]=hn.y,this.vertexArray[t+22]=u.minX,this.vertexArray[t+23]=u.maxY,this.vertexArray[t+24]=c,this.vertexArray[t+25]=Ya.x,this.vertexArray[t+26]=Ya.y,this.vertexArray[t+27]=u.maxX,this.vertexArray[t+28]=u.maxY,this.vertexArray[t+29]=c,t+=$a}const i=this.webGLBlock.gl;i.uniformMatrix3fv(this.shaderProgram.uniformLocations.uProjectionMatrix,!1,this.webGLBlock.projectionMatrixArray),this.instance.relativeTransform.matrix.copyToArray(this.transformMatrixArray),i.uniformMatrix3fv(this.shaderProgram.uniformLocations.uTransformMatrix,!1,this.transformMatrixArray),i.bindBuffer(i.ARRAY_BUFFER,this.vertexBuffer),s?i.bufferData(i.ARRAY_BUFFER,this.vertexArray,i.DYNAMIC_DRAW):i.bufferSubData(i.ARRAY_BUFFER,0,this.vertexArray.subarray(0,t));const n=Float32Array.BYTES_PER_ELEMENT,a=Ao*n;return i.vertexAttribPointer(this.shaderProgram.attributeLocations.aVertex,2,i.FLOAT,!1,a,0*n),i.vertexAttribPointer(this.shaderProgram.attributeLocations.aTextureCoord,2,i.FLOAT,!1,a,2*n),i.vertexAttribPointer(this.shaderProgram.attributeLocations.aAlpha,1,i.FLOAT,!1,a,4*n),i.activeTexture(i.TEXTURE0),i.bindTexture(i.TEXTURE_2D,this.spriteSheet.texture),i.uniform1i(this.shaderProgram.uniformLocations.uTexture,0),i.drawArrays(i.TRIANGLES,0,t/Ao),i.bindTexture(i.TEXTURE_2D,null),this.shaderProgram.unuse(),!this.hasDrawn&&Te.safari&&bp.setTimeout(()=>this.markDirty(),0),this.hasDrawn=!0,1}dispose(){this.node._sprites.forEach(e=>{e.imageProperty.unlink(this.spriteChangeListener)}),this.webGLBlock&&(this.webGLBlock=null),super.dispose()}markPaintDirty(){this.markDirty()}}na.prototype.webglRenderer=p.webglCustom;d.register("SpritesWebGLDrawable",na);ae.mixInto(na);const Ey=na;class Bh extends Qn(gs){paintCanvas(e,t,s){const i=e.context;(t.hasFill()||t.hasPaintableStroke())&&(e.setFont(t._font.getFont()),e.setDirection("ltr")),t.hasFill()&&(t.beforeCanvasFill(e),i.fillText(t.renderedText,0,0),t.afterCanvasFill(e)),t.hasPaintableStroke()&&(t.beforeCanvasStroke(e),i.strokeText(t.renderedText,0,0),t.afterCanvasStroke(e))}markDirtyText(){this.markPaintDirty()}markDirtyFont(){this.markPaintDirty()}markDirtyBounds(){this.markPaintDirty()}}d.register("TextCanvasDrawable",Bh);ae.mixInto(Bh);const Ac=Bh,Ka=C.pool.fetch();class Fh extends Xu(Vi){constructor(e,t){super(e,t),Y.prepareForTransform(this.domElement)}initialize(e,t){super.initialize(e,t),this.domElement||(this.domElement=document.createElement("div"),this.domElement.style.display="block",this.domElement.style.position="absolute",this.domElement.style.pointerEvents="none",this.domElement.style.left="0",this.domElement.style.top="0",this.domElement.setAttribute("dir","ltr"))}updateDOM(){const e=this.node,t=this.domElement;if(this.paintDirty&&(this.dirtyFont&&(t.style.font=e.getFont()),this.dirtyStroke&&(t.style.color=e.getCSSFill()),this.dirtyBounds&&(t.style.width=`${e.getSelfBounds().width}px`,t.style.height=`${e.getSelfBounds().height}px`),this.dirtyText&&(t.textContent=e.renderedText)),this.transformDirty||this.dirtyText||this.dirtyFont||this.dirtyBounds){const s=e.getSelfBounds().minY;Ka.set(this.getTransformMatrix());const i=C.translation(0,s);Ka.multiplyMatrix(i),i.freeToPool(),Y.applyPreparedTransform(Ka,t)}this.setToCleanState(),this.cleanPaintableState(),this.transformDirty=!1}dispose(){super.dispose()}}d.register("TextDOMDrawable",Fh);ae.mixInto(Fh);const ky=Fh,Ay=!0,xy=!Te.edge,xc=Te.safari;class Hh extends Xu(ri){initialize(e,t){if(super.initialize(e,t,!0,Ay),this.hasLength=!1,!this.svgElement){const s=document.createElementNS(ne,"text");if(this.text=s,xc){const i=document.createElementNS(ne,"g");i.appendChild(s),this.svgElement=i,this.workaroundRect=document.createElementNS(ne,"rect"),this.workaroundRect.setAttribute("fill","transparent"),i.appendChild(this.workaroundRect)}else this.svgElement=s;s.appendChild(document.createTextNode("")),s.setAttribute("dominant-baseline","alphabetic"),s.setAttribute("text-rendering","geometricPrecision"),s.setAttributeNS("http://www.w3.org/XML/1998/namespace","xml:space","preserve"),s.setAttribute("direction","ltr")}}updateSVGSelf(){const e=this.text;if(this.dirtyFont&&(e.setAttribute("font-family",this.node._font.getFamily()),e.setAttribute("font-size",this.node._font.getSize()),e.setAttribute("font-style",this.node._font.getStyle()),e.setAttribute("font-weight",this.node._font.getWeight()),e.setAttribute("font-stretch",this.node._font.getStretch())),this.dirtyText&&(e.lastChild.nodeValue=Y.safariEmbeddingMarkWorkaround(this.node.renderedText)),this.dirtyBounds&&xy&&(this.node._boundsMethod!=="accurate"&&isFinite(this.node.selfBounds.width)?(this.hasLength||(this.hasLength=!0,e.setAttribute("lengthAdjust","spacingAndGlyphs")),e.setAttribute("textLength",this.node.selfBounds.width)):this.hasLength&&(this.hasLength=!1,e.removeAttribute("lengthAdjust"),e.removeAttribute("textLength")),xc)){const i=this.node.selfBounds.width*.2,n=this.node.selfBounds.height*.2;this.workaroundRect.setAttribute("x",this.node.selfBounds.minX-i),this.workaroundRect.setAttribute("y",this.node.selfBounds.minY-n),this.workaroundRect.setAttribute("width",this.node.selfBounds.width+2*i),this.workaroundRect.setAttribute("height",this.node.selfBounds.height+2*n)}this.updateFillStrokeStyle(e)}}d.register("TextSVGDrawable",Hh);ae.mixInto(Hh);const Oy=Hh;class ra extends Zn{initialize(e,t){super.initialize(e,t),this.contextChangeListener=this.contextChangeListener||this.onWebGLContextChange.bind(this),this.painter=null}createPainter(){const e=this.node.painterType;return new e(this.webGLBlock.gl,this.node)}onWebGLContextChange(){this.painter=this.createPainter()}onAddToBlock(e){this.webGLBlock=e,this.painter=this.createPainter(),e.glChangedEmitter.addListener(this.contextChangeListener)}onRemoveFromBlock(e){e.glChangedEmitter.removeListener(this.contextChangeListener)}draw(){const e=this.instance.relativeTransform.matrix,t=this.painter.paint(e,this.webGLBlock.projectionMatrix);return assert&&assert(t===Yt.PAINTED_SOMETHING||t===Yt.PAINTED_NOTHING),assert&&assert(Yt.PAINTED_NOTHING===0&&Yt.PAINTED_SOMETHING===1,"Ensure we can pass the value through directly to indicate whether draw calls were made"),t}dispose(){this.painter.dispose(),this.painter=null,this.webGLBlock&&(this.webGLBlock=null),super.dispose()}markPaintDirty(){this.markDirty()}get shaderAttributes(){return this.node.shaderAttributes}}ra.prototype.webglRenderer=p.webglCustom;d.register("WebGLNodeDrawable",ra);ae.mixInto(ra);const My=ra;class ju extends Ee{constructor(e,t){super(),this.initialize(e,t)}initialize(e,t){super.initialize(e),this.instance=t}stitch(e,t,s,i){}}d.register("InlineCanvasCacheDrawable",ju);class qu extends Ee{constructor(e,t,s,i){super(),this.initialize(e,t,s,i)}initialize(e,t,s,i){super.initialize(t),this.instance=s,this.sharedInstance=i}}d.register("SharedCanvasCacheDrawable",qu);class Qu{constructor(e){this.instance=e}initialize(e,t){return this.display=e,this.trail=t,this.node=t&&t.lastNode(),this.transformDirty=!0,this.nodeTransformListener=this.nodeTransformListener||this.onNodeTransformDirty.bind(this),this.matrix=this.matrix||C.identity(),this.relativeSelfDirty=!0,this.relativeChildrenListenersCount=0,this.relativePrecomputeCount=0,this.relativeChildrenPrecomputeCount=0,this.relativeFrameId=-1,this.relativeChildDirtyFrame=e?e._frameId:0,this.relativeTransformListeners=ee(this.relativeTransformListeners),this}get parent(){return this.instance.parent?this.instance.parent.relativeTransform:null}addInstance(e){e.stateless?(assert&&assert(!e.relativeTransform.hasAncestorListenerNeed(),"We only track changes properly if stateless instances do not have needs"),assert&&assert(!e.relativeTransform.hasAncestorComputeNeed(),"We only track changes properly if stateless instances do not have needs")):(e.relativeTransform.hasAncestorListenerNeed()&&this.incrementTransformListenerChildren(),e.relativeTransform.hasAncestorComputeNeed()&&this.incrementTransformPrecomputeChildren()),e.relativeTransform.forceMarkTransformDirty()}removeInstance(e){e.relativeTransform.hasAncestorListenerNeed()&&this.decrementTransformListenerChildren(),e.relativeTransform.hasAncestorComputeNeed()&&this.decrementTransformPrecomputeChildren()}attachNodeListeners(){this.node.transformEmitter.addListener(this.nodeTransformListener)}detachNodeListeners(){this.node.transformEmitter.removeListener(this.nodeTransformListener)}hasDescendantListenerNeed(){return this.instance.isTransformed?this.relativeChildrenListenersCount>0:this.relativeChildrenListenersCount>0||this.relativeTransformListeners.length>0}hasAncestorListenerNeed(){return this.instance.isTransformed?this.relativeTransformListeners.length>0:this.relativeChildrenListenersCount>0||this.relativeTransformListeners.length>0}hasSelfListenerNeed(){return this.relativeTransformListeners.length>0}incrementTransformListenerChildren(){const e=this.hasAncestorListenerNeed();this.relativeChildrenListenersCount++,e!==this.hasAncestorListenerNeed()&&(assert&&assert(!this.instance.isTransformed,"Should not be a change in need if we have the isTransformed flag"),this.parent&&this.parent.incrementTransformListenerChildren())}decrementTransformListenerChildren(){const e=this.hasAncestorListenerNeed();this.relativeChildrenListenersCount--,e!==this.hasAncestorListenerNeed()&&(assert&&assert(!this.instance.isTransformed,"Should not be a change in need if we have the isTransformed flag"),this.parent&&this.parent.decrementTransformListenerChildren())}addListener(e){const t=this.hasAncestorListenerNeed();this.relativeTransformListeners.push(e),t!==this.hasAncestorListenerNeed()&&(this.parent&&this.parent.incrementTransformListenerChildren(),this.hasAncestorComputeNeed()||this.forceMarkTransformDirty())}removeListener(e){const t=this.hasAncestorListenerNeed();this.relativeTransformListeners.splice(_.indexOf(this.relativeTransformListeners,e),1),t!==this.hasAncestorListenerNeed()&&this.parent&&this.parent.decrementTransformListenerChildren()}hasDescendantComputeNeed(){return this.instance.isTransformed?this.relativeChildrenPrecomputeCount>0:this.relativeChildrenPrecomputeCount>0||this.relativePrecomputeCount>0}hasAncestorComputeNeed(){return this.instance.isTransformed?this.relativePrecomputeCount>0:this.relativeChildrenPrecomputeCount>0||this.relativePrecomputeCount>0}hasSelfComputeNeed(){return this.relativePrecomputeCount>0}incrementTransformPrecomputeChildren(){const e=this.hasAncestorComputeNeed();this.relativeChildrenPrecomputeCount++,e!==this.hasAncestorComputeNeed()&&(assert&&assert(!this.instance.isTransformed,"Should not be a change in need if we have the isTransformed flag"),this.parent&&this.parent.incrementTransformPrecomputeChildren())}decrementTransformPrecomputeChildren(){const e=this.hasAncestorComputeNeed();this.relativeChildrenPrecomputeCount--,e!==this.hasAncestorComputeNeed()&&(assert&&assert(!this.instance.isTransformed,"Should not be a change in need if we have the isTransformed flag"),this.parent&&this.parent.decrementTransformPrecomputeChildren())}addPrecompute(){const e=this.hasAncestorComputeNeed();this.relativePrecomputeCount++,e!==this.hasAncestorComputeNeed()&&(this.parent&&this.parent.incrementTransformPrecomputeChildren(),this.hasAncestorListenerNeed()||this.forceMarkTransformDirty())}removePrecompute(){const e=this.hasAncestorComputeNeed();this.relativePrecomputeCount--,e!==this.hasAncestorComputeNeed()&&this.parent&&this.parent.decrementTransformPrecomputeChildren()}onNodeTransformDirty(){this.transformDirty||this.forceMarkTransformDirty()}forceMarkTransformDirty(){this.transformDirty=!0,this.relativeSelfDirty=!0;const e=this.display._frameId;let t=this.instance.parent;for(;t&&t.relativeTransform.relativeChildDirtyFrame!==e;){const s=t.parent,i=t.isTransformed;if(t.relativeTransform.relativeChildDirtyFrame=e,s===null){this.display.markTransformRootDirty(t,i);break}else if(i){this.display.markTransformRootDirty(t,!0);break}t=s}}computeRelativeTransform(){const e=this.node.getMatrix();this.instance.parent&&!this.instance.parent.isTransformed?(this.matrix.set(this.parent.matrix),this.matrix.multiplyMatrix(e)):this.matrix.set(e),this.relativeFrameId=this.display._frameId,this.relativeSelfDirty=!1}isValidationNotNeeded(){return this.hasAncestorComputeNeed()||this.relativeFrameId===this.display._frameId}validate(){if(!this.isValidationNotNeeded()&&(this.instance.parent&&!this.instance.parent.isTransformed&&this.parent.validate(),this.relativeSelfDirty)){this.computeRelativeTransform();const e=this.instance.children.length;for(let t=0;t<e;t++)this.instance.children[t].relativeTransform.relativeSelfDirty=!0}}updateTransformListenersAndCompute(e,t,s,i){sceneryLog&&sceneryLog.RelativeTransform&&sceneryLog.RelativeTransform(`update/compute: ${this.toString()} ${e} => ${t}${i?" passTransform":""}`),sceneryLog&&sceneryLog.RelativeTransform&&sceneryLog.push();let n,a;if(i)for(n=this.instance.children.length,a=0;a<n;a++)this.instance.children[a].relativeTransform.updateTransformListenersAndCompute(!1,!1,s,!1);else{const o=e||this.relativeSelfDirty,h=o||this.relativeChildDirtyFrame===s,l=this.hasDescendantComputeNeed(),c=this.hasDescendantListenerNeed(),u=this.hasSelfComputeNeed(),m=this.hasSelfListenerNeed();if(!l&&o&&!t&&(this.relativeSelfDirty=!0),!h||!l&&!c&&!u&&!m){sceneryLog&&sceneryLog.RelativeTransform&&sceneryLog.pop();return}if(o&&(l||u)&&this.computeRelativeTransform(),this.transformDirty&&(this.transformDirty=!1),this.notifyRelativeTransformListeners(),!this.instance.isTransformed||i){const b=o&&!(l||u);for(n=this.instance.children.length,a=0;a<n;a++)this.instance.children[a].relativeTransform.updateTransformListenersAndCompute(o,b,s,!1)}}sceneryLog&&sceneryLog.RelativeTransform&&sceneryLog.pop()}notifyRelativeTransformListeners(){const e=this.relativeTransformListeners.length;for(let t=0;t<e;t++)this.relativeTransformListeners[t]()}audit(e,t){function s(n){const a=C.pool.fetch(),o=n.node.getMatrix();return n.parent?n.parent.isTransformed?a.set(o):(a.set(s(n.parent)),a.multiplyMatrix(o)):a.set(C.IDENTITY),a}function i(n){return t&&n.isValidationNotNeeded()?!1:n.relativeSelfDirty||n.parent&&i(n.parent)}if(assertSlow){let n=0,a=0;for(let o=0;o<this.instance.children.length;o++){const h=this.instance.children[o];h.relativeTransform.hasAncestorListenerNeed()&&n++,h.relativeTransform.hasAncestorComputeNeed()&&a++}if(assertSlow(n===this.relativeChildrenListenersCount,"Relative listener count invariant"),assertSlow(a===this.relativeChildrenPrecomputeCount,"Relative precompute count invariant"),assertSlow(!this.parent||this.instance.isTransformed||this.relativeChildDirtyFrame!==e||this.parent.relativeChildDirtyFrame===e,"If we have a parent, we need to hold the invariant this.relativeChildDirtyFrame => parent.relativeChildDirtyFrame"),!t&&!i(this)){const o=s(this);assertSlow(o.equals(this.matrix),"If there is no relativeSelfDirty flag set here or in our ancestors, our matrix should be up-to-date")}}}}d.register("RelativeTransform",Qu);class pt{constructor(e,t){this.initialize(e,t)}initialize(e,t){assert&&assert(e===null||e instanceof Ee,"drawableBefore can either be null to indicate that there is no un-changed drawable before our changes, or it can reference an un-changed drawable"),assert&&assert(t===null||t instanceof Ee,"drawableAfter can either be null to indicate that there is no un-changed drawable after our changes, or it can reference an un-changed drawable"),this.nextChangeInterval=null,this.drawableBefore=e,this.drawableAfter=t,this.collapsedEmpty=!1}dispose(){this.nextChangeInterval=null,this.drawableBefore=null,this.drawableAfter=null,this.freeToPool()}constrict(){let e=!1;if(this.isEmpty())return!0;for(;this.drawableBefore&&this.drawableBefore.nextDrawable===this.drawableBefore.oldNextDrawable;)if(this.drawableBefore=this.drawableBefore.nextDrawable,e=!0,this.drawableBefore||(assert&&assert(!this.drawableAfter),this.collapsedEmpty=!0),this.isEmpty())return!0;for(;this.drawableAfter&&this.drawableAfter.previousDrawable===this.drawableAfter.oldPreviousDrawable;)if(this.drawableAfter=this.drawableAfter.previousDrawable,e=!0,this.drawableAfter||(assert&&assert(!this.drawableBefore),this.collapsedEmpty=!0),this.isEmpty())return!0;return e}isEmpty(){return this.collapsedEmpty||this.drawableBefore!==null&&this.drawableBefore===this.drawableAfter}getOldInternalDrawableCount(e,t){const s=this.drawableBefore?this.drawableBefore.oldNextDrawable:e,i=this.drawableAfter;let n=0;for(let a=s;a!==i;a=a.oldNextDrawable)n++;return n}getNewInternalDrawableCount(e,t){const s=this.drawableBefore?this.drawableBefore.nextDrawable:e,i=this.drawableAfter;let n=0;for(let a=s;a!==i;a=a.nextDrawable)n++;return n}static newForDisplay(e,t,s){const i=pt.createFromPool(e,t);return s.markChangeIntervalToDispose(i),i}}d.register("ChangeInterval",pt);ae.mixInto(pt);class Zu{constructor(e){this.instance=e}initialize(e,t){return this.display=e,this.trail=t,this.node=t&&t.lastNode(),this.selfFittable=!!t&&this.isSelfFitSupported(),this.ancestorsFittable=this.selfFittable,this.subtreeUnfittableCount=this.selfFittable?0:1,this.subtreeFittabilityChangeEmitter=this.subtreeFittabilityChangeEmitter||new re,this}get parent(){return this.instance.parent?this.instance.parent.fittability:null}checkSelfFittability(){const e=this.isSelfFitSupported();this.selfFittable!==e&&this.updateSelfFittable()}isSelfFitSupported(){return this.display._allowLayerFitting&&!this.node.isPreventFit()}markSubtreeFittable(){if(!this.selfFittable)return;this.ancestorsFittable=!0;const e=this.instance.children;for(let t=0;t<e.length;t++)e[t].fittability.markSubtreeFittable();this.instance.updateDrawableFittability(!0)}markSubtreeUnfittable(){if(!this.ancestorsFittable)return;this.ancestorsFittable=!1;const e=this.instance.children;for(let t=0;t<e.length;t++)e[t].fittability.markSubtreeUnfittable();this.instance.updateDrawableFittability(!1)}updateSelfFittable(){const e=this.isSelfFitSupported();assert&&assert(this.selfFittable!==e),this.selfFittable=e,this.selfFittable&&(!this.parent||this.parent.ancestorsFittable)?this.markSubtreeFittable():this.selfFittable||this.markSubtreeUnfittable(),this.selfFittable?this.decrementSubtreeUnfittableCount():this.incrementSubtreeUnfittableCount()}incrementSubtreeUnfittableCount(){this.subtreeUnfittableCount++,this.subtreeUnfittableCount===1&&(this.parent&&this.parent.incrementSubtreeUnfittableCount(),this.subtreeFittabilityChangeEmitter.emit())}decrementSubtreeUnfittableCount(){this.subtreeUnfittableCount--,this.subtreeUnfittableCount===0&&(this.parent&&this.parent.decrementSubtreeUnfittableCount(),this.subtreeFittabilityChangeEmitter.emit())}onInsert(e){this.ancestorsFittable||e.markSubtreeUnfittable(),e.subtreeUnfittableCount>0&&this.incrementSubtreeUnfittableCount()}onRemove(e){this.ancestorsFittable||e.markSubtreeFittable(),e.subtreeUnfittableCount>0&&this.decrementSubtreeUnfittableCount()}audit(){if(assertSlow){assertSlow(this.selfFittable===this.isSelfFitSupported(),"selfFittable diverged from isSelfFitSupported()"),assertSlow(this.ancestorsFittable===((this.parent?this.parent.ancestorsFittable:!0)&&this.selfFittable),"Our ancestorsFittable should be false if our parent or our self is not fittable.");let e=0;this.selfFittable||e++,_.each(this.instance.children,t=>{t.fittability.subtreeUnfittableCount>0&&e++}),assertSlow(this.subtreeUnfittableCount===e,"Incorrect subtreeUnfittableCount")}}}d.register("Fittability",Zu);let Ry=1,Ny=1;class Rt{constructor(e,t,s){this.id=`group${Ry++}`,this.initialize(e,t,s)}initialize(e,t,s){sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`initializing ${this.toString()}`),this.block=e,this.instance=t,this.node=t.trail.lastNode(),this.parent=s,this.children=ee(this.children),this.hasSelfDrawable=!1,this.selfDrawable=null,this.dirty=!0,this.willApplyTransforms=this.block.transformRootInstance.trail.nodes.length<this.instance.trail.nodes.length,this.willApplyFilters=this.block.filterRootInstance.trail.nodes.length<this.instance.trail.nodes.length,this.transformDirty=!0,this.hasTransform=this.hasTransform!==void 0?this.hasTransform:!1,this.transformDirtyListener=this.transformDirtyListener||this.markTransformDirty.bind(this),this.willApplyTransforms&&this.node.transformEmitter.addListener(this.transformDirtyListener),this.filterDirty=!0,this.visibilityDirty=!0,this.clipDirty=!0,this.filterElement=this.filterElement||null,this.hasOpacity=this.hasOpacity!==void 0?this.hasOpacity:!1,this.hasFilter=!1,this.clipDefinition=this.clipDefinition!==void 0?this.clipDefinition:null,this.clipPath=this.clipPath!==void 0?this.clipPath:null,this.filterChangeListener=this.filterChangeListener||this.onFilterChange.bind(this),this.visibilityDirtyListener=this.visibilityDirtyListener||this.onVisibleChange.bind(this),this.clipDirtyListener=this.clipDirtyListener||this.onClipChange.bind(this),this.node.visibleProperty.lazyLink(this.visibilityDirtyListener),this.willApplyFilters&&this.node.filterChangeEmitter.addListener(this.filterChangeListener),this.node.clipAreaProperty.lazyLink(this.clipDirtyListener),this.orderDirty=!0,this.orderDirtyListener=this.orderDirtyListener||this.markOrderDirty.bind(this),this.node.childrenChangedEmitter.addListener(this.orderDirtyListener),this.svgGroup||(this.svgGroup=document.createElementNS(ne,"g")),this.instance.addSVGGroup(this),this.block.markDirtyGroup(this)}addSelfDrawable(e){this.selfDrawable=e,this.svgGroup.insertBefore(e.svgElement,this.children.length?this.children[0].svgGroup:null),this.hasSelfDrawable=!0}removeSelfDrawable(e){this.hasSelfDrawable=!1,this.svgGroup.removeChild(e.svgElement),this.selfDrawable=null}addChildGroup(e){this.markOrderDirty(),e.parent=this,this.children.push(e),this.svgGroup.appendChild(e.svgGroup)}removeChildGroup(e){this.markOrderDirty(),e.parent=null,this.children.splice(_.indexOf(this.children,e),1),this.svgGroup.removeChild(e.svgGroup)}markDirty(){this.dirty||(this.dirty=!0,this.block.markDirtyGroup(this))}markOrderDirty(){this.orderDirty||(this.orderDirty=!0,this.markDirty())}markTransformDirty(){this.transformDirty||(this.transformDirty=!0,this.markDirty())}onFilterChange(){this.filterDirty||(this.filterDirty=!0,this.markDirty())}onVisibleChange(){this.visibilityDirty||(this.visibilityDirty=!0,this.markDirty())}onClipChange(){this.clipDirty||(this.clipDirty=!0,this.markDirty())}update(){if(sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`update: ${this.toString()}`),!this.block)return;sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.push();const e=this.svgGroup;if(this.dirty=!1,this.transformDirty&&(this.transformDirty=!1,sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`transform update: ${this.toString()}`),this.willApplyTransforms?this.node.transform.isIdentity()?this.hasTransform&&(this.hasTransform=!1,e.removeAttribute("transform")):(this.hasTransform=!0,e.setAttribute("transform",this.node.transform.getMatrix().getSVGTransform())):this.hasTransform&&(this.hasTransform=!1,e.removeAttribute("transform"))),this.visibilityDirty&&(this.visibilityDirty=!1,sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`visibility update: ${this.toString()}`),e.style.display=this.node.isVisible()?"":"none"),this.filterDirty){this.filterDirty=!1,sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`filter update: ${this.toString()}`);const t=this.node.effectiveOpacity;this.willApplyFilters&&t!==1?(this.hasOpacity=!0,e.setAttribute("opacity",t)):this.hasOpacity&&(this.hasOpacity=!1,e.removeAttribute("opacity"));const s=this.willApplyFilters&&this.node._filters.length,i=`filter-${this.id}`;if(s){for(this.filterElement||(this.filterElement=document.createElementNS(ne,"filter"),this.filterElement.setAttribute("id",i));this.filterElement.firstChild;)this.filterElement.removeChild(this.filterElement.lastChild);let n=50,a="SourceGraphic";const o=this.node._filters.length;for(let c=0;c<o;c++){const u=this.node._filters[c],m=c===o-1?void 0:`e${c}`;u.applySVGFilter(this.filterElement,a,m),n+=u.filterRegionPercentageIncrease,a=m}const h=`-${J(n)}%`,l=`${J(2*n+100)}%`;this.filterElement.setAttribute("x",h),this.filterElement.setAttribute("y",h),this.filterElement.setAttribute("width",l),this.filterElement.setAttribute("height",l)}s&&(this.hasFilter||this.block.defs.appendChild(this.filterElement),e.setAttribute("filter",`url(#${i})`),this.hasFilter=!0),this.hasFilter&&!s&&(e.removeAttribute("filter"),this.hasFilter=!1,this.block.defs.removeChild(this.filterElement))}if(this.clipDirty)if(this.clipDirty=!1,sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`clip update: ${this.toString()}`),this.node.clipArea){if(!this.clipDefinition){const t=`clip${Ny++}`;this.clipDefinition=document.createElementNS(ne,"clipPath"),this.clipDefinition.setAttribute("id",t),this.clipDefinition.setAttribute("clipPathUnits","userSpaceOnUse"),this.block.defs.appendChild(this.clipDefinition),this.clipPath=document.createElementNS(ne,"path"),this.clipDefinition.appendChild(this.clipPath),e.setAttribute("clip-path",`url(#${t})`)}this.clipPath.setAttribute("d",this.node.clipArea.getSVGPath())}else this.clipDefinition&&(e.removeAttribute("clip-path"),this.block.defs.removeChild(this.clipDefinition),this.clipDefinition=null,this.clipPath=null);if(this.orderDirty){this.orderDirty=!1,sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`order update: ${this.toString()}`),sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.push();let t=this.children.length-1;const s=this.instance.children;for(let i=s.length-1;i>=0;i--){const n=s[i].lookupSVGGroup(this.block);if(n){if(this.children[t]!==n){sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`group out of order: ${t} for ${n.toString()}`),e.insertBefore(n.svgGroup,t+1>=this.children.length?null:this.children[t+1].svgGroup);const a=_.indexOf(this.children,n);assert&&assert(a<t,"The item we are moving backwards to location [idx] should not have an index greater than that"),this.children.splice(a,1),this.children.splice(t,0,n)}else sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`group in place: ${t} for ${n.toString()}`);t--}}sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.pop()}sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.pop()}isReleasable(){return!this.hasSelfDrawable&&!this.children.length&&this.parent}dispose(){sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.SVGGroup(`dispose ${this.toString()}`),sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.push(),assert&&assert(this.children.length===0,"Should be empty by now"),this.hasFilter&&(this.svgGroup.removeAttribute("filter"),this.hasFilter=!1,this.block.defs.removeChild(this.filterElement)),this.willApplyTransforms&&this.node.transformEmitter.removeListener(this.transformDirtyListener),this.node.visibleProperty.unlink(this.visibilityDirtyListener),this.willApplyFilters&&this.node.filterChangeEmitter.removeListener(this.filterChangeListener),this.node.clipAreaProperty.unlink(this.clipDirtyListener),this.node.childrenChangedEmitter.removeListener(this.orderDirtyListener),this.instance.active&&this.instance.removeSVGGroup(this),this.clipDefinition&&(this.svgGroup.removeAttribute("clip-path"),this.block.defs.removeChild(this.clipDefinition),this.clipDefinition=null,this.clipPath=null),this.parent=null,this.block=null,this.instance=null,this.node=null,ee(this.children),this.selfDrawable=null,this.freeToPool(),sceneryLog&&sceneryLog.SVGGroup&&sceneryLog.pop()}toString(){return`SVGGroup:${this.block.toString()}_${this.instance.toString()}`}static addDrawable(e,t){assert&&assert(t.instance,"Instance is required for a drawable to be grouped correctly in SVG"),Rt.ensureGroupsToInstance(e,t.instance).addSelfDrawable(t)}static removeDrawable(e,t){t.instance.lookupSVGGroup(e).removeSelfDrawable(t),Rt.releaseGroupsToInstance(e,t.instance)}static ensureGroupsToInstance(e,t){let s=t.lookupSVGGroup(e);if(!s){assert&&assert(t!==e.rootGroup.instance,"Making sure we do not walk past our rootGroup");const i=Rt.ensureGroupsToInstance(e,t.parent);s=Rt.createFromPool(e,t,i),i.addChildGroup(s)}return s}static releaseGroupsToInstance(e,t){const s=t.lookupSVGGroup(e);if(s.isReleasable()){const i=s.parent;i.removeChildGroup(s),Rt.releaseGroupsToInstance(e,i.instance),s.dispose()}}}d.register("SVGGroup",Rt);ae.mixInto(Rt);class Ju extends Ee{initialize(e,t){assert&&assert(!e._isDisposing,"Should not create a block for a Display that is being disposed of"),assert&&assert(!e._isDisposed,"Should not create a block for a disposed Display"),super.initialize(t),this.display=e,this.drawableCount=0,this.used=!0,this.firstDrawable=null,this.lastDrawable=null,this.pendingFirstDrawable=null,this.pendingLastDrawable=null,this.previousBlock=null,this.nextBlock=null,this.zIndex=0,assertSlow&&(this.drawableList=ee(this.drawableList))}dispose(){assert&&assert(this.drawableCount===0,"There should be no drawables on a block when it is disposed"),this.display=null,this.firstDrawable=null,this.lastDrawable=null,this.pendingFirstDrawable=null,this.pendingLastDrawable=null,this.previousBlock=null,this.nextBlock=null,assertSlow&&ee(this.drawableList),super.dispose()}addDrawable(e){if(this.drawableCount++,this.markDirtyDrawable(e),assertSlow){const t=_.indexOf(this.drawableList,e);assertSlow&&assertSlow(t===-1,"Drawable should not be added when it has not been removed"),this.drawableList.push(e),assertSlow&&assertSlow(this.drawableCount===this.drawableList.length,"Count sanity check, to make sure our assertions are not buggy")}}removeDrawable(e){if(this.drawableCount--,this.markDirty(),assertSlow){const t=_.indexOf(this.drawableList,e);assertSlow&&assertSlow(t!==-1,"Drawable should be already added when it is removed"),this.drawableList.splice(t,1),assertSlow&&assertSlow(this.drawableCount===this.drawableList.length,"Count sanity check, to make sure our assertions are not buggy")}}onIntervalChange(e,t){}updateInterval(){(this.pendingFirstDrawable!==this.firstDrawable||this.pendingLastDrawable!==this.lastDrawable)&&(this.onIntervalChange(this.pendingFirstDrawable,this.pendingLastDrawable),this.firstDrawable=this.pendingFirstDrawable,this.lastDrawable=this.pendingLastDrawable)}notifyInterval(e,t){this.pendingFirstDrawable=e,this.pendingLastDrawable=t,this.updateInterval()}audit(e,t,s){if(assertSlow){super.audit(e,t,s);let i=0;if(!t){for(let n=this.firstDrawable;n!==null&&(n.audit(e,t,s),i++,n!==this.lastDrawable);n=n.nextDrawable);if(!e){assertSlow&&assertSlow(i===this.drawableCount,"drawableCount should match"),assertSlow&&assertSlow(this.firstDrawable===this.pendingFirstDrawable,"No pending first drawable"),assertSlow&&assertSlow(this.lastDrawable===this.pendingLastDrawable,"No pending last drawable");for(let n=this.firstDrawable;n!==null&&(assertSlow&&assertSlow(n.renderer===this.renderer,"Renderers should match"),assertSlow&&assertSlow(n.parentDrawable===this,"This block should be this drawable's parent"),assertSlow&&assertSlow(_.indexOf(this.drawableList,n)>=0),n!==this.lastDrawable);n=n.nextDrawable);}}}}}d.register("Block",Ju);const As=Ju,Oc=w.NOTHING.copy();class Ae extends As{initialize(e,t,s,i){return super.initialize(e,t),this.transformRootInstance=s,assert&&assert(typeof s.isDisplayRoot=="boolean"),this.canBeFullDisplay=s.isDisplayRoot,assert&&assert(i===Ae.FULL_DISPLAY||i===Ae.COMMON_ANCESTOR),this.preferredFit=i,this.fit=i,this.dirtyFit=!0,this.commonFitInstance=null,this.fitBounds=w.NOTHING.copy(),this.oldFitBounds=w.NOTHING.copy(),this.unfittableDrawableCount=0,this.dirtyFitListener=this.dirtyFitListener||this.markDirtyFit.bind(this),this.fittableListener=this.fittableListener||this.onFittabilityChange.bind(this),this.display.sizeProperty.lazyLink(this.dirtyFitListener),this}setFit(e){!this.canBeFullDisplay&&e===Ae.FULL_DISPLAY&&(e=Ae.COMMON_ANCESTOR),this.fit!==e&&(this.fit=e,this.markDirtyFit(),this.oldFitBounds.set(w.NOTHING),e===Ae.COMMON_ANCESTOR&&this.removeCommonFitInstance())}markDirtyFit(){sceneryLog&&sceneryLog.dirty&&sceneryLog.dirty(`markDirtyFit on FittedBlock#${this.id}`),this.dirtyFit=!0,this.markDirty()}updateFit(){if(assert&&assert(this.fit===Ae.FULL_DISPLAY||this.fit===Ae.COMMON_ANCESTOR,"Unsupported fit"),!(!this.dirtyFit&&this.fit===Ae.FULL_DISPLAY))if(sceneryLog&&sceneryLog.FittedBlock&&sceneryLog.FittedBlock(`updateFit #${this.id}`),this.dirtyFit=!1,this.fit===Ae.COMMON_ANCESTOR&&this.commonFitInstance===null&&this.addCommonFitInstance(this.computeCommonAncestorInstance()),this.fit===Ae.COMMON_ANCESTOR&&this.commonFitInstance.fittability.subtreeUnfittableCount>0&&this.canBeFullDisplay&&(this.oldFitBounds.set(w.NOTHING),this.fit=Ae.FULL_DISPLAY),this.fit===Ae.FULL_DISPLAY)this.fitBounds.set(w.NOTHING),this.setSizeFullDisplay();else if(this.fit===Ae.COMMON_ANCESTOR){assert&&assert(this.commonFitInstance.trail.length>=this.transformRootInstance.trail.length),this.fitBounds.set(this.commonFitInstance.node.getLocalBounds());let e=this.commonFitInstance;for(;e!==this.transformRootInstance;)this.fitBounds.transform(e.node.getMatrix()),e=e.parent;this.fitBounds.roundOut(),this.fitBounds.dilate(4),this.transformRootInstance.isDisplayRoot&&(Oc.setMinMax(0,0,this.display.width,this.display.height),this.fitBounds.constrainBounds(Oc)),this.fitBounds.isValid()||this.fitBounds.setMinMax(0,0,0,0),this.fitBounds.equals(this.oldFitBounds)||(this.oldFitBounds.set(this.fitBounds),this.setSizeFitBounds())}else throw new Error("unknown fit")}setSizeFullDisplay(){}setSizeFitBounds(){}addCommonFitInstance(e){assert&&assert(this.commonFitInstance===null),e&&(this.commonFitInstance=e,this.commonFitInstance.fittability.subtreeFittabilityChangeEmitter.addListener(this.dirtyFitListener))}removeCommonFitInstance(){this.commonFitInstance&&(this.commonFitInstance.fittability.subtreeFittabilityChangeEmitter.removeListener(this.dirtyFitListener),this.commonFitInstance=null)}dispose(){sceneryLog&&sceneryLog.FittedBlock&&sceneryLog.FittedBlock(`dispose #${this.id}`),this.display.sizeProperty.unlink(this.dirtyFitListener),this.removeCommonFitInstance(),this.transformRootInstance=null,super.dispose()}addDrawable(e){super.addDrawable(e),e.fittableProperty.lazyLink(this.fittableListener),e.fittable||this.incrementUnfittable()}removeDrawable(e){super.removeDrawable(e),e.fittableProperty.unlink(this.fittableListener),e.fittable||this.decrementUnfittable()}onFittabilityChange(e){e?this.decrementUnfittable():this.incrementUnfittable()}incrementUnfittable(){this.unfittableDrawableCount++,this.unfittableDrawableCount===1&&this.checkFitConstraints()}decrementUnfittable(){this.unfittableDrawableCount--,this.unfittableDrawableCount===0&&this.checkFitConstraints()}checkFitConstraints(){this.unfittableDrawableCount>0&&this.canBeFullDisplay?this.setFit(Ae.FULL_DISPLAY):this.setFit(this.preferredFit)}computeCommonAncestorInstance(){assert&&assert(this.firstDrawable.instance&&this.lastDrawable.instance,"For common-ancestor fits, we need the first and last drawables to have direct instance references");let e=this.firstDrawable.instance,t=this.lastDrawable.instance;const s=Math.min(e.trail.length,t.trail.length);for(;e.trail.length>s;)e=e.parent;for(;t.trail.length>s;)t=t.parent;for(;e!==t;)e=e.parent,t=t.parent;const i=e;return assert&&assert(i.trail.length>=this.transformRootInstance.trail.length),i}onIntervalChange(e,t){sceneryLog&&sceneryLog.FittedBlock&&sceneryLog.FittedBlock(`#${this.id}.onIntervalChange ${e.toString()} to ${t.toString()}`),super.onIntervalChange(e,t),this.fit===Ae.COMMON_ANCESTOR&&(this.removeCommonFitInstance(),this.markDirtyFit())}}d.register("FittedBlock",Ae);Ae.FULL_DISPLAY=1;Ae.COMMON_ANCESTOR=2;Ae.fitString={1:"fullDisplay",2:"commonAncestor"};const Xt=Ae,Mc=new C,Rc=new C;class Vh extends Xt{constructor(e,t,s,i){super(),this.initialize(e,t,s,i)}initialize(e,t,s,i){super.initialize(e,t,s,Xt.COMMON_ANCESTOR),this.filterRootInstance=i,this.dirtyDrawables=ee(this.dirtyDrawables),this.domElement||(this.canvas=document.createElement("canvas"),this.canvas.style.position="absolute",this.canvas.style.left="0",this.canvas.style.top="0",this.canvas.style.pointerEvents="none",this.canvasId=this.canvas.id=`scenery-canvas${this.id}`,this.context=this.canvas.getContext("2d"),this.context.save(),this.context.miterLimit=20,this.context.miterLimit=10,this.wrapper=new ks(this.canvas,this.context),this.domElement=this.canvas,this.wrapperStack=[this.wrapper]),this.wrapperStackIndex=0,this.filterListenerCountMap=this.filterListenerCountMap||{},Y.prepareForTransform(this.canvas),Y.unsetTransform(this.canvas),this.canvasDrawOffset=new T(0,0),this.currentDrawable=null,this.clipDirty=!0,this.clipCount=0,this.backingScale=t&p.bitmaskCanvasLowResolution?1:Y.backingScale(this.context),this.clipDirtyListener=this.markDirty.bind(this),this.opacityDirtyListener=this.markDirty.bind(this),sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`initialized #${this.id}`)}setSizeFullDisplay(){const e=this.display.getSize();this.canvas.width=e.width*this.backingScale,this.canvas.height=e.height*this.backingScale,this.canvas.style.width=`${e.width}px`,this.canvas.style.height=`${e.height}px`,this.wrapper.resetStyles(),this.canvasDrawOffset.setXY(0,0),Y.unsetTransform(this.canvas)}setSizeFitBounds(){const e=this.fitBounds.minX,t=this.fitBounds.minY;this.canvasDrawOffset.setXY(-e,-t),Y.setTransform(`matrix(1,0,0,1,${e},${t})`,this.canvas),this.canvas.width=this.fitBounds.width*this.backingScale,this.canvas.height=this.fitBounds.height*this.backingScale,this.canvas.style.width=`${this.fitBounds.width}px`,this.canvas.style.height=`${this.fitBounds.height}px`,this.wrapper.resetStyles()}update(){if(!super.update())return!1;for(sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`update #${this.id}`),sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.push();this.dirtyDrawables.length;)this.dirtyDrawables.pop().update();this.updateFit(),this.context.restore(),this.context.setTransform(1,0,0,1,0,0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.save(),this.wrapper.resetStyles(),this.currentDrawable=null;for(let e=this.firstDrawable;e!==null&&(this.renderDrawable(e),e!==this.lastDrawable);e=e.nextDrawable);return this.currentDrawable&&this.walkDown(this.currentDrawable.instance.trail,0),assert&&assert(this.clipCount===0,"clipCount should be zero after walking back down"),sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.pop(),!0}applyClip(e){this.clipDirty=!1,sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`Apply clip ${e.instance.trail.toDebugString()}`),sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.push();const t=this.wrapperStack[this.wrapperStackIndex],s=t.context;if(s.restore(),s.save(),t.resetStyles(),this.clipCount){const n=e.instance.trail;Mc.rowMajor(this.backingScale,0,this.canvasDrawOffset.x*this.backingScale,0,this.backingScale,this.canvasDrawOffset.y*this.backingScale,0,0,1),Rc.set(this.transformRootInstance.trail.getMatrix()).invert(),Rc.multiplyMatrix(Mc).canvasSetTransform(s);for(let a=0;a<n.length;a++){const o=n.nodes[a];o.getMatrix().canvasAppendTransform(s),o.hasClipArea()&&(s.beginPath(),o.clipArea.writeToContext(s),s.clip())}}sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.pop()}pushWrapper(){if(this.wrapperStackIndex++,this.clipDirty=!0,this.wrapperStackIndex===this.wrapperStack.length){const s=document.createElement("canvas"),i=s.getContext("2d");i.save(),this.wrapperStack.push(new ks(s,i))}const e=this.wrapperStack[this.wrapperStackIndex],t=e.context;e.setDimensions(this.canvas.width,this.canvas.height),t.setTransform(1,0,0,1,0,0),t.clearRect(0,0,this.canvas.width,this.canvas.height)}popWrapper(){this.wrapperStackIndex--,this.clipDirty=!0}walkDown(e,t){const s=this.filterRootInstance.trail.length-1;for(let i=e.length-1;i>=t;i--){const n=e.nodes[i];if(n.hasClipArea()&&(sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`Pop clip ${e.subtrailTo(n).toDebugString()}`),this.clipCount--,this.clipDirty=!0),i>s){if(n._filters.length){sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`Pop filters ${e.subtrailTo(n).toDebugString()}`);const a=this.wrapperStack[this.wrapperStackIndex],o=this.wrapperStack[this.wrapperStackIndex-1];this.popWrapper(),o.context.setTransform(1,0,0,1,0,0);const h=n._filters;let l=A.canvasFilter;for(let c=0;c<h.length;c++)l=l&&h[c].isDOMCompatible();if(l){let c="";for(let u=0;u<h.length;u++)c+=`${c?" ":""}${h[u].getCSSFilterString()}`;o.context.filter=c,o.context.drawImage(a.canvas,0,0),o.context.filter="none"}else{for(let c=0;c<h.length;c++)h[c].applyCanvasFilter(a);o.context.drawImage(a.canvas,0,0)}}if(n.getEffectiveOpacity()!==1){sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`Pop opacity ${e.subtrailTo(n).toDebugString()}`);const a=this.wrapperStack[this.wrapperStackIndex],o=this.wrapperStack[this.wrapperStackIndex-1];this.popWrapper(),o.context.setTransform(1,0,0,1,0,0),o.context.globalAlpha=n.getEffectiveOpacity(),o.context.drawImage(a.canvas,0,0),o.context.globalAlpha=1}}}}walkUp(e,t){const s=this.filterRootInstance.trail.length-1;for(let i=t;i<e.length;i++){const n=e.nodes[i];i>s&&(n.getEffectiveOpacity()!==1&&(sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`Push opacity ${e.subtrailTo(n).toDebugString()}`),this.pushWrapper()),n._filters.length&&(sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`Push filters ${e.subtrailTo(n).toDebugString()}`),this.pushWrapper())),n.hasClipArea()&&(sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`Push clip ${e.subtrailTo(n).toDebugString()}`),this.clipCount++,this.clipDirty=!0)}}renderDrawable(e){if(!e.visible||this.canvas.width===0||this.canvas.height===0)return;sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`renderDrawable #${e.id} ${e.instance.trail.toDebugString()}`),sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.push();const t=this.currentDrawable?e.instance.getBranchIndexTo(this.currentDrawable.instance):0;this.currentDrawable&&this.walkDown(this.currentDrawable.instance.trail,t),this.walkUp(e.instance.trail,t);const s=this.wrapperStack[this.wrapperStackIndex],i=s.context;this.clipDirty&&this.applyClip(e),assert&&assert(e.instance.relativeTransform.isValidationNotNeeded());const n=e.instance.relativeTransform.matrix;i.setTransform(this.backingScale,0,0,this.backingScale,this.canvasDrawOffset.x*this.backingScale,this.canvasDrawOffset.y*this.backingScale),e.instance!==this.transformRootInstance&&n.canvasAppendTransform(i),e.paintCanvas(s,e.instance.node,e.instance.relativeTransform.matrix),this.currentDrawable=e,sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.pop()}dispose(){sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`dispose #${this.id}`),this.transformRootInstance=null,ee(this.dirtyDrawables),this.canvas.width=0,this.canvas.height=0,super.dispose()}markDirtyDrawable(e){sceneryLog&&sceneryLog.dirty&&sceneryLog.dirty(`markDirtyDrawable on CanvasBlock#${this.id} with ${e.toString()}`),assert&&assert(e),assert&&this.display.ensureNotPainting(),this.dirtyDrawables.push(e),this.markDirty()}addDrawable(e){sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`#${this.id}.addDrawable ${e.toString()}`),super.addDrawable(e);for(let t=e.instance;t&&t!==this.filterRootInstance;t=t.parent){const s=t.node;this.filterListenerCountMap[s.id]?this.filterListenerCountMap[s.id]++:(this.filterListenerCountMap[s.id]=1,s.filterChangeEmitter.addListener(this.opacityDirtyListener),s.clipAreaProperty.lazyLink(this.clipDirtyListener))}}removeDrawable(e){sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`#${this.id}.removeDrawable ${e.toString()}`);for(let t=e.instance;t&&t!==this.filterRootInstance;t=t.parent){const s=t.node;assert&&assert(this.filterListenerCountMap[s.id]>0),this.filterListenerCountMap[s.id]--,this.filterListenerCountMap[s.id]===0&&(delete this.filterListenerCountMap[s.id],s.clipAreaProperty.unlink(this.clipDirtyListener),s.filterChangeEmitter.removeListener(this.opacityDirtyListener))}super.removeDrawable(e)}onIntervalChange(e,t){sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`#${this.id}.onIntervalChange ${e.toString()} to ${t.toString()}`),super.onIntervalChange(e,t),this.markDirty()}onPotentiallyMovedDrawable(e){sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.CanvasBlock(`#${this.id}.onPotentiallyMovedDrawable ${e.toString()}`),sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.push(),assert&&assert(e.parentDrawable===this),e.markDirty(),sceneryLog&&sceneryLog.CanvasBlock&&sceneryLog.pop()}toString(){return`CanvasBlock#${this.id}-${Xt.fitString[this.fit]}`}}d.register("CanvasBlock",Vh);ae.mixInto(Vh);const Gh=Vh;class zh extends As{constructor(e,t){super(),this.initialize(e,t)}initialize(e,t){return super.initialize(e,t.renderer),this.domDrawable=t,this.domElement=t.domElement,this}update(){return super.update()?(this.domDrawable.update(),!0):!1}dispose(){this.domDrawable=null,this.domElement=null,super.dispose()}markDirtyDrawable(e){this.markDirty()}addDrawable(e){sceneryLog&&sceneryLog.DOMBlock&&sceneryLog.DOMBlock(`#${this.id}.addDrawable ${e.toString()}`),assert&&assert(this.domDrawable===e,"DOMBlock should only be used with one drawable for now (the one it was initialized with)"),super.addDrawable(e)}removeDrawable(e){sceneryLog&&sceneryLog.DOMBlock&&sceneryLog.DOMBlock(`#${this.id}.removeDrawable ${e.toString()}`),assert&&assert(this.domDrawable===e,"DOMBlock should only be used with one drawable for now (the one it was initialized with)"),super.removeDrawable(e)}}d.register("DOMBlock",zh);ae.mixInto(zh);const ep=zh;class Wh extends Xt{constructor(e,t,s,i){super(),this.initialize(e,t,s,i)}initialize(e,t,s,i){super.initialize(e,t,s,Xt.COMMON_ANCESTOR),this.filterRootInstance=i,this.dirtyGradients=ee(this.dirtyGradients),this.dirtyGroups=ee(this.dirtyGroups),this.dirtyDrawables=ee(this.dirtyDrawables),this.paintCountMap=this.paintCountMap||new ud(this.onAddPaint.bind(this),this.onRemovePaint.bind(this)),this.areReferencesReduced=!0,this.domElement||(this.svg=document.createElementNS(ne,"svg"),this.svg.style.pointerEvents="none",this.svg.style.position="absolute",this.svg.style.left="0",this.svg.style.top="0",this.svg.setAttribute("focusable",!1),this.defs=document.createElementNS(ne,"defs"),this.svg.appendChild(this.defs),this.baseTransformGroup=document.createElementNS(ne,"g"),this.svg.appendChild(this.baseTransformGroup),this.domElement=this.svg),this.forceRefreshListener=()=>{if(!this.workaroundRect){const l=document.createElementNS(ne,"g");this.svg.appendChild(l),this.workaroundRect=document.createElementNS(ne,"rect"),this.workaroundRect.setAttribute("width","0"),this.workaroundRect.setAttribute("height","0"),this.workaroundRect.setAttribute("fill","none"),l.appendChild(this.workaroundRect)}const a=gn.nextIntBetween(0,255),o=gn.nextIntBetween(0,255),h=gn.nextIntBetween(0,255);this.workaroundRect.setAttribute("fill",`rgba(${a},${o},${h},0.02)`)},this.display._refreshSVGEmitter.addListener(this.forceRefreshListener),Y.prepareForTransform(this.svg),Y.unsetTransform(this.svg),this.baseTransformGroup.setAttribute("transform","");const n=s.trail.nodes.length>i.trail.nodes.length?i:s;return this.rootGroup=Rt.createFromPool(this,n,null),this.baseTransformGroup.appendChild(this.rootGroup.svgGroup),sceneryLog&&sceneryLog.SVGBlock&&sceneryLog.SVGBlock(`initialized #${this.id}`),this}onAddPaint(e){const t=e.createSVGPaint(this);return t.definition.setAttribute("id",`${e.id}-${this.id}`),this.defs.appendChild(t.definition),t}onRemovePaint(e,t){this.defs.removeChild(t.definition),t.dispose()}incrementPaint(e){assert&&assert(e.isPaint),sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`incrementPaint ${this} ${e}`),this.paintCountMap.increment(e)}decrementPaint(e){assert&&assert(e.isPaint),sceneryLog&&sceneryLog.Paints&&sceneryLog.Paints(`decrementPaint ${this} ${e}`),this.paintCountMap.decrement(e)}markDirtyGradient(e){this.dirtyGradients.push(e),this.markDirty()}markDirtyGroup(e){this.dirtyGroups.push(e),this.markDirty(),this.areReferencesReduced&&this.display.markForReducedReferences(this),this.areReferencesReduced=!1}markDirtyDrawable(e){sceneryLog&&sceneryLog.dirty&&sceneryLog.dirty(`markDirtyDrawable on SVGBlock#${this.id} with ${e.toString()}`),this.dirtyDrawables.push(e),this.markDirty(),this.areReferencesReduced&&this.display.markForReducedReferences(this),this.areReferencesReduced=!1}setSizeFullDisplay(){sceneryLog&&sceneryLog.SVGBlock&&sceneryLog.SVGBlock(`setSizeFullDisplay #${this.id}`),this.baseTransformGroup.removeAttribute("transform"),Y.unsetTransform(this.svg);const e=this.display.getSize();this.svg.setAttribute("width",e.width),this.svg.setAttribute("height",e.height)}setSizeFitBounds(){sceneryLog&&sceneryLog.SVGBlock&&sceneryLog.SVGBlock(`setSizeFitBounds #${this.id} with ${this.fitBounds.toString()}`);const e=this.fitBounds.minX,t=this.fitBounds.minY;assert&&assert(isFinite(e)&&isFinite(t),"Invalid SVG transform for SVGBlock"),assert&&assert(this.fitBounds.isValid(),"Invalid fitBounds"),this.baseTransformGroup.setAttribute("transform",`translate(${-e},${-t})`),Y.setTransform(`matrix(1,0,0,1,${e},${t})`,this.svg),this.svg.setAttribute("width",this.fitBounds.width),this.svg.setAttribute("height",this.fitBounds.height)}update(){if(!super.update())return!1;for(sceneryLog&&sceneryLog.SVGBlock&&sceneryLog.SVGBlock(`update #${this.id}`);this.dirtyGroups.length;){const e=this.dirtyGroups.pop();e.block===this&&e.update()}for(;this.dirtyGradients.length;)this.dirtyGradients.pop().update();for(;this.dirtyDrawables.length;){const e=this.dirtyDrawables.pop();e.parentDrawable===this&&e.update()}return this.areReferencesReduced=!0,this.updateFit(),!0}reduceReferences(){if(this.areReferencesReduced)return;let e=0,t=0;for(;e<this.dirtyGroups.length;){const s=this.dirtyGroups[e];s.block===this&&(t!==e&&(this.dirtyGroups[t]=s),t++),e++}for(;this.dirtyGroups.length>t;)this.dirtyGroups.pop();for(e=0,t=0;e<this.dirtyDrawables.length;){const s=this.dirtyDrawables[e];s.parentDrawable===this&&(t!==e&&(this.dirtyDrawables[t]=s),t++),e++}for(;this.dirtyDrawables.length>t;)this.dirtyDrawables.pop();this.areReferencesReduced=!0}dispose(){for(sceneryLog&&sceneryLog.SVGBlock&&sceneryLog.SVGBlock(`dispose #${this.id}`),this.svg.setAttribute("width","0"),this.svg.setAttribute("height","0"),this.filterRootInstance=null,ee(this.dirtyGradients),ee(this.dirtyGroups),ee(this.dirtyDrawables),this.paintCountMap.clear(),this.display._refreshSVGEmitter.removeListener(this.forceRefreshListener),this.baseTransformGroup.removeChild(this.rootGroup.svgGroup),this.rootGroup.dispose(),this.rootGroup=null;this.defs.childNodes.length;)this.defs.removeChild(this.defs.childNodes[0]);super.dispose()}addDrawable(e){sceneryLog&&sceneryLog.SVGBlock&&sceneryLog.SVGBlock(`#${this.id}.addDrawable ${e.toString()}`),super.addDrawable(e),Rt.addDrawable(this,e),e.updateSVGBlock(this)}removeDrawable(e){sceneryLog&&sceneryLog.SVGBlock&&sceneryLog.SVGBlock(`#${this.id}.removeDrawable ${e.toString()}`),Rt.removeDrawable(this,e),super.removeDrawable(e)}onIntervalChange(e,t){sceneryLog&&sceneryLog.SVGBlock&&sceneryLog.SVGBlock(`#${this.id}.onIntervalChange ${e.toString()} to ${t.toString()}`),super.onIntervalChange(e,t)}toString(){return`SVGBlock#${this.id}-${Xt.fitString[this.fit]}`}}d.register("SVGBlock",Wh);ae.mixInto(Wh);class $h extends Xt{constructor(e,t,s,i){super(),this.initialize(e,t,s,i)}initialize(e,t,s,i){return sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`initialize #${this.id}`),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.push(),super.initialize(e,t,s,Xt.FULL_DISPLAY),this.filterRootInstance=i,this.preserveDrawingBuffer=e._preserveDrawingBuffer,this.dirtyDrawables=ee(this.dirtyDrawables),this.spriteSheets=this.spriteSheets||[],this.projectionMatrix=this.projectionMatrix||new C,this.projectionMatrixArray=new Float32Array(9),this.customProcessor=this.customProcessor||new By,this.vertexColorPolygonsProcessor=this.vertexColorPolygonsProcessor||new Fy(this.projectionMatrixArray),this.texturedTrianglesProcessor=this.texturedTrianglesProcessor||new Hy(this.projectionMatrixArray),this.glChangedEmitter=new re,this.isContextLost=!1,this.contextLostListener=this.onContextLoss.bind(this),this.contextRestoreListener=this.onContextRestoration.bind(this),this.domElement||(this.domElement=document.createElement("div"),this.domElement.className="webgl-container",this.domElement.style.position="absolute",this.domElement.style.left="0",this.domElement.style.top="0",this.rebuildCanvas()),this.gl.clear(this.gl.COLOR_BUFFER_BIT),Y.prepareForTransform(this.canvas),Y.unsetTransform(this.canvas),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.pop(),this}rebuildCanvas(){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`rebuildCanvas #${this.id}`),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.push();const e=document.createElement("canvas"),t=this.getContextFromCanvas(e);assert&&assert(t||this.canvas,"We should have a WebGL context by now"),t&&(this.canvas&&(this.domElement.removeChild(this.canvas),this.canvas.removeEventListener("webglcontextlost",this.contextLostListener,!1),this.canvas.removeEventListener("webglcontextrestored",this.contextRestoreListener,!1)),this.canvas=e,this.canvas.style.pointerEvents="none",this.canvasId=this.canvas.id=`scenery-webgl${this.id}`,this.canvas.addEventListener("webglcontextlost",this.contextLostListener,!1),this.canvas.addEventListener("webglcontextrestored",this.contextRestoreListener,!1),this.domElement.appendChild(this.canvas),this.setupContext(t)),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.pop()}setupContext(e){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`setupContext #${this.id}`),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.push(),assert&&assert(e,"Should have an actual context if this is called"),this.isContextLost=!1,this.gl=e,this.backingScale=Y.backingScale(this.gl),this.display._allowBackingScaleAntialiasing&&e.getParameter(e.SAMPLES)===0&&(this.backingScale*=2),this.originalBackingScale=this.backingScale,Y.applyWebGLContextDefaults(this.gl),this.markDirty(),this.dirtyFit=!0,this.customProcessor.initializeContext(this.gl),this.vertexColorPolygonsProcessor.initializeContext(this.gl),this.texturedTrianglesProcessor.initializeContext(this.gl);for(let t=0;t<this.spriteSheets.length;t++)this.spriteSheets[t].initializeContext(this.gl);this.glChangedEmitter.emit(),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.pop()}delayedRebuildCanvas(){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`Delaying rebuilding of Canvas #${this.id}`);const e=this;window.setTimeout(function(){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`Executing delayed rebuilding #${this.id}`),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.push(),e.rebuildCanvas(),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.pop()})}onContextLoss(e){this.isContextLost||(sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`Context lost #${this.id}`),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.push(),this.isContextLost=!0,e.preventDefault(),this.canvas.style.display="none",this.markDirty(),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.pop())}onContextRestoration(e){if(this.isContextLost){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`Context restored #${this.id}`),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.push();const t=this.getContextFromCanvas(this.canvas);assert&&assert(t,"We were told the context was restored, so this should work"),this.setupContext(t),this.canvas.style.display="",sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.pop()}}getContextFromCanvas(e){const t={antialias:!0,preserveDrawingBuffer:this.preserveDrawingBuffer};return e.getContext("webgl",t)||e.getContext("experimental-webgl",t)}setSizeFullDisplay(){const e=this.display.getSize();this.canvas.width=Math.ceil(e.width*this.backingScale),this.canvas.height=Math.ceil(e.height*this.backingScale),this.canvas.style.width=`${e.width}px`,this.canvas.style.height=`${e.height}px`}setSizeFitBounds(){throw new Error("setSizeFitBounds unimplemented for WebGLBlock")}update(){if(!super.update())return!1;sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`update #${this.id}`),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.push();const e=this.gl;for(this.isContextLost&&this.display._aggressiveContextRecreation&&this.delayedRebuildCanvas();this.dirtyDrawables.length;)this.dirtyDrawables.pop().update();const t=this.spriteSheets.length;for(let n=0;n<t;n++)this.spriteSheets[n].updateTexture();this.firstDrawable&&this.firstDrawable===this.lastDrawable&&this.firstDrawable.node&&this.firstDrawable.node._webglScale!==null&&this.backingScale!==this.originalBackingScale*this.firstDrawable.node._webglScale&&(this.backingScale=this.originalBackingScale*this.firstDrawable.node._webglScale,this.dirtyFit=!0),this.updateFit(),this.projectionMatrix.rowMajor(2/this.display.width,0,-1,0,-2/this.display.height,1,0,0,1),this.projectionMatrix.copyToArray(this.projectionMatrixArray),this.preserveDrawingBuffer&&e.clear(e.COLOR_BUFFER_BIT),e.viewport(0,0,this.canvas.width,this.canvas.height);let s=null,i=0;for(let n=this.firstDrawable;n!==null;n=n.nextDrawable){if(n.visible){let a=null;n.webglRenderer===p.webglTexturedTriangles?a=this.texturedTrianglesProcessor:n.webglRenderer===p.webglCustom?a=this.customProcessor:n.webglRenderer===p.webglVertexColorPolygons&&(a=this.vertexColorPolygonsProcessor),assert&&assert(a),a!==s&&(s&&(i+=s.deactivate()),s=a,s.activate()),s.processDrawable(n)}if(n===this.lastDrawable)break}return s&&(i+=s.deactivate()),i===0&&!this.preserveDrawingBuffer&&e.clear(e.COLOR_BUFFER_BIT),e.flush(),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.pop(),!0}dispose(){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`dispose #${this.id}`),ee(this.dirtyDrawables),super.dispose()}markDirtyDrawable(e){sceneryLog&&sceneryLog.dirty&&sceneryLog.dirty(`markDirtyDrawable on WebGLBlock#${this.id} with ${e.toString()}`),assert&&assert(e),assert&&assert(!e.isDisposed),this.dirtyDrawables.push(e),this.markDirty()}addDrawable(e){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`#${this.id}.addDrawable ${e.toString()}`),super.addDrawable(e),e.onAddToBlock(this)}removeDrawable(e){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`#${this.id}.removeDrawable ${e.toString()}`);let t=0;for(;(t=this.dirtyDrawables.indexOf(e,t))>=0;)this.dirtyDrawables.splice(t,1);e.onRemoveFromBlock(this),super.removeDrawable(e)}addSpriteSheetImage(e,t,s){let i=null;const n=this.spriteSheets.length;for(let a=0;a<n&&(i=this.spriteSheets[a].addImage(e,t,s),!i);a++);if(!i){const a=new Os(!0);if(i=a.addImage(e,t,s),a.initializeContext(this.gl),this.spriteSheets.push(a),!i)throw new Error("Attempt to load image that is too large for sprite sheets")}return i}removeSpriteSheetImage(e){e.spriteSheet.removeImage(e.image)}onIntervalChange(e,t){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`#${this.id}.onIntervalChange ${e.toString()} to ${t.toString()}`),super.onIntervalChange(e,t),this.markDirty()}onPotentiallyMovedDrawable(e){sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.WebGLBlock(`#${this.id}.onPotentiallyMovedDrawable ${e.toString()}`),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.push(),assert&&assert(e.parentDrawable===this),this.markDirty(),sceneryLog&&sceneryLog.WebGLBlock&&sceneryLog.pop()}toString(){return`WebGLBlock#${this.id}-${Xt.fitString[this.fit]}`}}d.register("WebGLBlock",$h);class Uh{activate(){}initializeContext(e){}processDrawable(e){}deactivate(){}}class By extends Uh{constructor(){super(),this.drawable=null}activate(){this.drawCount=0}processDrawable(e){assert&&assert(e.webglRenderer===p.webglCustom),this.drawable=e,this.draw()}deactivate(){return this.drawCount}draw(){if(this.drawable){const e=this.drawable.draw();assert&&assert(typeof e=="number"),this.drawCount+=e,this.drawable=null}}}class Fy extends Uh{constructor(e){assert&&assert(e instanceof Float32Array),super(),this.projectionMatrixArray=e,this.lastArrayLength=128,this.vertexArray=new Float32Array(this.lastArrayLength)}initializeContext(e){assert&&assert(e,"Should be an actual context"),this.gl=e,this.shaderProgram=new Wr(e,["attribute vec2 aVertex;","attribute vec4 aColor;","varying vec4 vColor;","uniform mat3 uProjectionMatrix;","void main() {","  vColor = aColor;","  vec3 ndc = uProjectionMatrix * vec3( aVertex, 1.0 );","  gl_Position = vec4( ndc.xy, 0.0, 1.0 );","}"].join(`
`),["precision mediump float;","varying vec4 vColor;","void main() {","  gl_FragColor = vec4( vColor.rgb * vColor.a, vColor.a );","}"].join(`
`),{attributes:["aVertex","aColor"],uniforms:["uProjectionMatrix"]}),this.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertexArray,e.DYNAMIC_DRAW)}activate(){this.shaderProgram.use(),this.vertexArrayIndex=0,this.drawCount=0}processDrawable(e){if(e.includeVertices){const t=e.vertexArray;for(;t.length+this.vertexArrayIndex>this.vertexArray.length;){const s=new Float32Array(this.vertexArray.length*2);s.set(this.vertexArray),this.vertexArray=s}this.vertexArray.set(t,this.vertexArrayIndex),this.vertexArrayIndex+=t.length,this.drawCount++}}deactivate(){return this.drawCount&&this.draw(),this.shaderProgram.unuse(),this.drawCount}draw(){const e=this.gl;e.uniformMatrix3fv(this.shaderProgram.uniformLocations.uProjectionMatrix,!1,this.projectionMatrixArray),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),this.vertexArray.length>this.lastArrayLength?e.bufferData(e.ARRAY_BUFFER,this.vertexArray,e.DYNAMIC_DRAW):e.bufferSubData(e.ARRAY_BUFFER,0,this.vertexArray.subarray(0,this.vertexArrayIndex));const t=Float32Array.BYTES_PER_ELEMENT,s=6*t;e.vertexAttribPointer(this.shaderProgram.attributeLocations.aVertex,2,e.FLOAT,!1,s,0*t),e.vertexAttribPointer(this.shaderProgram.attributeLocations.aColor,4,e.FLOAT,!1,s,2*t),e.drawArrays(e.TRIANGLES,0,this.vertexArrayIndex/6),this.vertexArrayIndex=0}}class Hy extends Uh{constructor(e){assert&&assert(e instanceof Float32Array),super(),this.projectionMatrixArray=e,this.lastArrayLength=128,this.vertexArray=new Float32Array(this.lastArrayLength)}initializeContext(e){assert&&assert(e,"Should be an actual context"),this.gl=e,this.shaderProgram=new Wr(e,["attribute vec2 aVertex;","attribute vec2 aTextureCoord;","attribute float aAlpha;","varying vec2 vTextureCoord;","varying float vAlpha;","uniform mat3 uProjectionMatrix;","void main() {","  vTextureCoord = aTextureCoord;","  vAlpha = aAlpha;","  vec3 ndc = uProjectionMatrix * vec3( aVertex, 1.0 );","  gl_Position = vec4( ndc.xy, 0.0, 1.0 );","}"].join(`
`),["precision mediump float;","varying vec2 vTextureCoord;","varying float vAlpha;","uniform sampler2D uTexture;","void main() {","  vec4 color = texture2D( uTexture, vTextureCoord, -0.7 );","  color.a *= vAlpha;","  gl_FragColor = color;","}"].join(`
`),{attributes:["aVertex","aTextureCoord","aAlpha"],uniforms:["uTexture","uProjectionMatrix"]}),this.vertexBuffer=e.createBuffer(),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),e.bufferData(e.ARRAY_BUFFER,this.vertexArray,e.DYNAMIC_DRAW)}activate(){this.shaderProgram.use(),this.currentSpriteSheet=null,this.vertexArrayIndex=0,this.drawCount=0}processDrawable(e){if(!e.sprite)return;assert&&assert(e.webglRenderer===p.webglTexturedTriangles),this.currentSpriteSheet&&e.sprite.spriteSheet!==this.currentSpriteSheet&&this.draw(),this.currentSpriteSheet=e.sprite.spriteSheet;const t=e.vertexArray;for(;t.length+this.vertexArrayIndex>this.vertexArray.length;){const s=new Float32Array(this.vertexArray.length*2);s.set(this.vertexArray),this.vertexArray=s}this.vertexArray.set(t,this.vertexArrayIndex),this.vertexArrayIndex+=t.length}deactivate(){return this.currentSpriteSheet&&this.draw(),this.shaderProgram.unuse(),this.drawCount}draw(){assert&&assert(this.currentSpriteSheet);const e=this.gl;e.uniformMatrix3fv(this.shaderProgram.uniformLocations.uProjectionMatrix,!1,this.projectionMatrixArray),e.bindBuffer(e.ARRAY_BUFFER,this.vertexBuffer),this.vertexArray.length>this.lastArrayLength?e.bufferData(e.ARRAY_BUFFER,this.vertexArray,e.DYNAMIC_DRAW):e.bufferSubData(e.ARRAY_BUFFER,0,this.vertexArray.subarray(0,this.vertexArrayIndex));const t=5,s=Float32Array.BYTES_PER_ELEMENT,i=t*s;e.vertexAttribPointer(this.shaderProgram.attributeLocations.aVertex,2,e.FLOAT,!1,i,0*s),e.vertexAttribPointer(this.shaderProgram.attributeLocations.aTextureCoord,2,e.FLOAT,!1,i,2*s),e.vertexAttribPointer(this.shaderProgram.attributeLocations.aAlpha,1,e.FLOAT,!1,i,4*s),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,this.currentSpriteSheet.texture),e.uniform1i(this.shaderProgram.uniformLocations.uTexture,0),e.drawArrays(e.TRIANGLES,0,this.vertexArrayIndex/t),e.bindTexture(e.TEXTURE_2D,null),this.drawCount++,this.currentSpriteSheet=null,this.vertexArrayIndex=0}}ae.mixInto($h);const tp=$h;class Fs{initialize(e,t,s,i,n,a,o){assert&&assert(a&&o,"We are guaranteed at least one change interval"),assert&&assert(!t||t.previousDrawable===null,"End boundary of drawable linked list should link to null"),assert&&assert(!s||s.nextDrawable===null,"End boundary of drawable linked list should link to null"),sceneryLog&&sceneryLog.Stitch&&(sceneryLog.Stitch(`stitch ${e.toString()} first:${t?t.toString():"null"} last:${s?s.toString():"null"} oldFirst:${i?i.toString():"null"} oldLast:${n?n.toString():"null"}`),sceneryLog.push()),sceneryLog&&sceneryLog.StitchDrawables&&(sceneryLog.StitchDrawables("Before:"),sceneryLog.push(),Fs.debugDrawables(i,n,a,o,!1),sceneryLog.pop(),sceneryLog.StitchDrawables("After:"),sceneryLog.push(),Fs.debugDrawables(t,s,a,o,!0),sceneryLog.pop()),this.backbone=e,this.firstDrawable=t,this.lastDrawable=s,this.touchedBlocks=ee(this.touchedBlocks),assertSlow&&(assertSlow(!this.initialized,"We should not be already initialized (clean should be called)"),this.initialized=!0,this.reindexed=!1,this.pendingAdditions=[],this.pendingRemovals=[],this.pendingMoves=[],this.createdBlocks=[],this.disposedBlocks=[],this.intervalsNotified=[],this.boundariesRecorded=!1,this.previousBlocks=e.blocks.slice(0))}clean(){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch("clean"),sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch("-----------------------------------"),assertSlow&&(this.auditStitch(),this.initialized=!1),this.backbone=null,this.firstDrawable=null,this.lastDrawable=null,sceneryLog&&sceneryLog.Stitch&&sceneryLog.pop()}recordBackboneBoundaries(){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`recording backbone boundaries: ${this.firstDrawable?this.firstDrawable.toString():"null"} to ${this.lastDrawable?this.lastDrawable.toString():"null"}`),this.backbone.previousFirstDrawable=this.firstDrawable,this.backbone.previousLastDrawable=this.lastDrawable,assertSlow&&(this.boundariesRecorded=!0)}notePendingAddition(e,t){assert&&assert(e.renderer===t.renderer),sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`pending add: ${e.toString()} to ${t.toString()}`),sceneryLog&&sceneryLog.Stitch&&sceneryLog.push(),e.notePendingAddition(this.backbone.display,t,this.backbone),assertSlow&&this.pendingAdditions.push({drawable:e,block:t}),sceneryLog&&sceneryLog.Stitch&&sceneryLog.pop()}notePendingMove(e,t){assert&&assert(e.renderer===t.renderer),sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`pending move: ${e.toString()} to ${t.toString()}`),sceneryLog&&sceneryLog.Stitch&&sceneryLog.push(),e.notePendingMove(this.backbone.display,t),assertSlow&&this.pendingMoves.push({drawable:e,block:t}),sceneryLog&&sceneryLog.Stitch&&sceneryLog.pop()}notePendingRemoval(e){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`pending remove: ${e.toString()}`),sceneryLog&&sceneryLog.Stitch&&sceneryLog.push(),e.notePendingRemoval(this.backbone.display),assertSlow&&this.pendingRemovals.push({drawable:e}),sceneryLog&&sceneryLog.Stitch&&sceneryLog.pop()}markBlockForDisposal(e){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`block for disposal: ${e.toString()}`),sceneryLog&&sceneryLog.Stitch&&sceneryLog.push(),e.domElement.parentNode===this.backbone.domElement&&this.backbone.domElement.removeChild(e.domElement),e.markForDisposal(this.backbone.display),assertSlow&&this.disposedBlocks.push({block:e}),sceneryLog&&sceneryLog.Stitch&&sceneryLog.pop()}removeAllBlocks(){for(sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`marking all blocks for disposal (count ${this.backbone.blocks.length})`),sceneryLog&&sceneryLog.Stitch&&sceneryLog.push();this.backbone.blocks.length;){const e=this.backbone.blocks[0];this.removeBlock(e),this.markBlockForDisposal(e)}sceneryLog&&sceneryLog.Stitch&&sceneryLog.pop()}notifyInterval(e,t,s){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`notify interval: ${e.toString()} ${t.toString()} to ${s.toString()}`),sceneryLog&&sceneryLog.Stitch&&sceneryLog.push(),e.notifyInterval(t,s),this.backbone.markDirtyDrawable(e),assertSlow&&this.intervalsNotified.push({block:e,firstDrawable:t,lastDrawable:s}),sceneryLog&&sceneryLog.Stitch&&sceneryLog.pop()}markBeforeBlock(e,t){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`marking block first drawable ${e.toString()} with ${t.toString()}`),e.pendingFirstDrawable=t,this.touchedBlocks.push(e)}markAfterBlock(e,t){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`marking block last drawable ${e.toString()} with ${t.toString()}`),e.pendingLastDrawable=t,this.touchedBlocks.push(e)}updateBlockIntervals(){for(;this.touchedBlocks.length;){const e=this.touchedBlocks.pop();e.used?(sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`update interval: ${e.toString()} ${e.pendingFirstDrawable.toString()} to ${e.pendingLastDrawable.toString()}`),e.updateInterval(),this.backbone.markDirtyDrawable(e),assertSlow&&this.intervalsNotified.push({block:e,firstDrawable:e.pendingFirstDrawable,lastDrawable:e.pendingLastDrawable})):sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`skipping update interval: ${e.toString()}, unused`)}}createBlock(e,t){const s=this.backbone;let i;if(p.isCanvas(e))i=Gh.createFromPool(s.display,e,s.transformRootInstance,s.backboneInstance);else if(p.isSVG(e))i=Wh.createFromPool(s.display,e,s.transformRootInstance,s.backboneInstance);else if(p.isDOM(e))i=ep.createFromPool(s.display,t);else if(p.isWebGL(e))i=tp.createFromPool(s.display,e,s.transformRootInstance,s.backboneInstance);else throw new Error(`unsupported renderer for createBlock: ${e}`);return sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`created block: ${i.toString()} with renderer: ${e} for drawable: ${t.toString()}`),i.setBlockBackbone(s),s.domElement.appendChild(i.domElement),s.isDisplayRoot&&i.domElement.setAttribute("aria-hidden",!0),s.markDirtyDrawable(i),assertSlow&&this.createdBlocks.push({block:i,renderer:e,drawable:t}),i}appendBlock(e){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`appending block: ${e.toString()}`),this.backbone.blocks.push(e),assertSlow&&(this.reindexed=!1)}removeBlock(e){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch(`removing block: ${e.toString()}`);const t=_.indexOf(this.backbone.blocks,e);assert&&assert(t>=0,`Cannot remove block, not attached: ${e.toString()}`),this.backbone.blocks.splice(t,1),assertSlow&&(this.reindexed=!1)}useNoBlocks(){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch("using no blocks"),ee(this.backbone.blocks)}reindex(){sceneryLog&&sceneryLog.Stitch&&sceneryLog.Stitch("reindexing blocks"),this.backbone.reindexBlocks(),assertSlow&&(this.reindexed=!0)}auditStitch(){if(assertSlow){const e=this.backbone.blocks,t=this.previousBlocks;if(assertSlow(this.initialized,"We seem to have finished a stitch without proper initialization"),assertSlow(this.boundariesRecorded,"Our stitch API requires recordBackboneBoundaries() to be called before it is finished."),assertSlow(this.reindexed||e.length===0||t.length===e.length&&_.every(_.zip(t,e),s=>s[0]===s[1]),"Did not reindex on a block change where we are left with blocks"),_.each(this.createdBlocks,s=>{assertSlow(_.some(this.intervalsNotified,i=>s.block===i.block),`Created block does not seem to have an interval notified: ${s.block.toString()}`)}),_.each(this.disposedBlocks,s=>{assertSlow(!_.some(this.intervalsNotified,i=>s.block===i.block),`Removed block seems to have an interval notified: ${s.block.toString()}`)}),_.each(this.disposedBlocks,s=>{const i=s.block;_.each(Ee.oldListToArray(i.firstDrawable,i.lastDrawable),n=>{assertSlow(_.some(this.pendingRemovals,a=>a.drawable===n)||_.some(this.pendingMoves,a=>a.drawable===n),`Drawable ${n.toString()} originally listed for disposed block ${i.toString()} does not seem to be marked for pending removal or move!`)})}),_.each(this.createdBlocks,s=>{const i=s.block;_.each(Ee.listToArray(i.pendingFirstDrawable,i.pendingLastDrawable),n=>{assertSlow(_.some(this.pendingAdditions,a=>a.drawable===n&&a.block===i)||_.some(this.pendingMoves,a=>a.drawable===n&&a.block===i),`Drawable ${n.toString()} now listed for created block ${i.toString()} does not seem to be marked for pending addition or move!`)})}),_.each(this.disposedBlocks,s=>{const i=_.indexOf(e,s.block);assertSlow(i<0,`Disposed block ${s.block.toString()} still present at index ${i}`)}),_.each(this.createdBlocks,s=>{const i=_.indexOf(e,s.block);assertSlow(i>=0,`Created block ${s.block.toString()} is not in the blocks array`)}),_.each(e,s=>{assertSlow(s.used,"All current blocks should be marked as used")}),assertSlow(e.length-t.length===this.createdBlocks.length-this.disposedBlocks.length,`The count of unmodified blocks should be constant (equal differences):
created: ${_.map(this.createdBlocks,s=>s.block.id).join(",")}
disposed: ${_.map(this.disposedBlocks,s=>s.block.id).join(",")}
before: ${_.map(t,s=>s.id).join(",")}
after: ${_.map(e,s=>s.id).join(",")}`),assertSlow(this.touchedBlocks.length===0,"If we marked any blocks for changes, we should have called updateBlockIntervals"),e.length){assertSlow(this.backbone.previousFirstDrawable!==null&&this.backbone.previousLastDrawable!==null,"If we are left with at least one block, we must be tracking at least one drawable"),assertSlow(e[0].pendingFirstDrawable===this.backbone.previousFirstDrawable,"Our first drawable should match the first drawable of our first block"),assertSlow(e[e.length-1].pendingLastDrawable===this.backbone.previousLastDrawable,"Our last drawable should match the last drawable of our last block");for(let s=0;s<e.length-1;s++)assertSlow(e[s].pendingLastDrawable.nextDrawable===e[s+1].pendingFirstDrawable&&e[s].pendingLastDrawable===e[s+1].pendingFirstDrawable.previousDrawable,"Consecutive blocks should have boundary drawables that are also consecutive in the linked list")}else assertSlow(this.backbone.previousFirstDrawable===null&&this.backbone.previousLastDrawable===null,"If we are left with no blocks, it must mean we are tracking precisely zero drawables")}}static debugIntervals(e){if(sceneryLog&&sceneryLog.Stitch)for(let t=e;t!==null;t=t.nextChangeInterval)sceneryLog.Stitch(`  interval: ${t.isEmpty()?"(empty) ":""}${t.drawableBefore?t.drawableBefore.toString():"-"} to ${t.drawableAfter?t.drawableAfter.toString():"-"}`)}static debugDrawables(e,t,s,i,n){if(sceneryLog&&sceneryLog.StitchDrawables){if(e===null){sceneryLog.StitchDrawables("nothing","color: #666;");return}let a=s.drawableBefore===null,o=s;for(let h=e;;h=n?h.nextDrawable:h.oldNextDrawable){a&&h===o.drawableAfter&&(a=!1,o=o.nextChangeInterval);const l=`${h.renderer} ${!n&&h.parentDrawable?h.parentDrawable.toString():""} ${h.toDetailedString()}`;if(sceneryLog.StitchDrawables(l,a?n?"color: #0a0;":"color: #a00;":"color: #666"),!a&&o&&o.drawableBefore===h&&(a=!0),h===t)break}}}}d.register("Stitcher",Fs);function kr(r,e){return r.renderer!==e.renderer||p.isDOM(r.renderer)||p.isDOM(e.renderer)}function Xa(r){return r.previousDrawable!==null&&!kr(r.previousDrawable,r)}function ja(r){return r.nextDrawable!==null&&!kr(r,r.nextDrawable)}function Vy(r,e,t){return r.drawableBefore?r.drawableBefore.nextDrawable!==r.drawableAfter:r.drawableAfter?r.drawableAfter.previousDrawable!==r.drawableBefore:e!==null}function Gy(r,e,t){return r.drawableBefore?r.drawableBefore.oldNextDrawable!==r.drawableAfter:r.drawableAfter?r.drawableAfter.oldPreviousDrawable!==r.drawableBefore:e!==null}function zy(r,e,t){const s=r.drawableBefore?r.drawableBefore.parentDrawable:null,i=r.drawableAfter?r.drawableAfter.parentDrawable:null;return s&&i&&s===i?!1:s?s.nextBlock!==i:i?i.previousBlock!==s:e!==null}function Wy(r){const e=r.drawableAfter;if(e){const t=e.renderer,s=r.nextChangeInterval?r.nextChangeInterval.drawableBefore.nextDrawable:null;let i=e;for(;;){const n=i.nextDrawable;if(n!==s&&n.renderer===t)i=n;else break}return i}else return null}class sp extends Fs{stitch(e,t,s,i,n,a,o){this.initialize(e,t,s,i,n,a,o),this.blockOrderChanged=!1,this.reusableBlocks=ee(this.reusableBlocks),this.blockWasAdded=!1;let h;if(this.recordBackboneBoundaries(),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.GreedyStitcher("phase 1: old linked list"),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.push(),e.blocks.length){const l=e.blocks[0];for(e.blocks[e.blocks.length-1],h=a;h!==null;h=h.nextChangeInterval){if(assert&&assert(!h.isEmpty(),"We now guarantee that the intervals are non-empty"),Gy(h,i)){const c=h.drawableBefore?h.drawableBefore.oldNextDrawable:i,u=h.drawableAfter?h.drawableAfter.oldPreviousDrawable:n;for(let m=c;this.notePendingRemoval(m),m!==u;m=m.oldNextDrawable);}if(zy(h,l)){const c=h.drawableBefore===null?e.blocks[0]:h.drawableBefore.parentDrawable.nextBlock,u=h.drawableAfter===null?e.blocks[e.blocks.length-1]:h.drawableAfter.parentDrawable.previousBlock;for(let m=c;this.unuseBlock(m),m!==u;m=m.nextBlock);}}}if(sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.pop(),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.GreedyStitcher("phase 2: new linked list"),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.push(),t)for(h=a;h!==null;h=h.nextChangeInterval)this.processInterval(e,h,t,s);sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.pop(),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.GreedyStitcher("phase 3: cleanup"),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.push(),this.removeUnusedBlocks(),this.updateBlockIntervals(),t===null?this.useNoBlocks():this.blockOrderChanged&&(this.processBlockLinkedList(e,t.pendingParentDrawable,s.pendingParentDrawable),this.reindex()),this.clean(),ee(this.reusableBlocks),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.pop()}processInterval(e,t,s,i){if(assert&&assert(t instanceof pt),assert&&assert(s instanceof Ee,"We assume we have a non-null remaining section"),assert&&assert(i instanceof Ee,"We assume we have a non-null remaining section"),assert&&assert(!t.isEmpty(),"We now guarantee that the intervals are non-empty"),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`interval: ${t.drawableBefore?t.drawableBefore.toString():"null"} to ${t.drawableAfter?t.drawableAfter.toString():"null"}`),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.push(),Vy(t,s)){let n=t.drawableBefore?t.drawableBefore.nextDrawable:s,a=null,o=null,h=!0;for(;;){const l=n.nextDrawable,c=l===t.drawableAfter;if(assert&&assert(l!==null||c,"If our nextDrawable is null, isLast must be true"),a||(a=n),o===null&&n.parentDrawable&&!n.parentDrawable.used&&n.backbone===e&&n.parentDrawable.parentDrawable===e&&(o=n.parentDrawable,sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`matching at ${n.toString()} with ${o}`)),(c||kr(n,l))&&(h&&this.processEdgeCases(t,Xa(a),ja(n)),this.processSubBlock(t,a,n,o,h,c),a=null,o=null,h=!1),c)break;n=l}}else{if(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("no current internal drawables in interval"),t.drawableBefore&&t.drawableAfter){assert&&assert(t.drawableBefore.nextDrawable===t.drawableAfter);const n=!kr(t.drawableBefore,t.drawableAfter);this.processEdgeCases(t,n,n)}t.drawableBefore&&!ja(t.drawableBefore)?(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("closed-after collapsed link:"),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.push(),this.linkAfterDrawable(t.drawableBefore),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.pop()):t.drawableAfter&&!Xa(t.drawableAfter)&&(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("closed-before collapsed link:"),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.push(),this.linkBeforeDrawable(t.drawableAfter),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.pop())}sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.pop()}processSubBlock(e,t,s,i,n,a){sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`sub-block: ${t.toString()} to ${s.toString()} ${i?`with matched: ${i.toString()}`:"with no match"}`),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.push();const o=Xa(t),h=ja(s);assert&&assert(!o||n,"openBefore implies isFirst"),assert&&assert(!h||a,"openAfter implies isLast"),assert&&assert(!o||!h||t.previousDrawable.pendingParentDrawable===s.nextDrawable.pendingParentDrawable,"If we would use both the before and after blocks, make sure any gluing "),o&&(i=t.previousDrawable.pendingParentDrawable,sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`combining into before block: ${i.toString()}`)),h&&(i=s.nextDrawable.pendingParentDrawable,sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`combining into after block: ${i.toString()}`)),i=this.ensureUsedBlock(i,t);for(let l=t;this.notePendingAddition(l,i),l!==s;l=l.nextDrawable);o||(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("closed-before link:"),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.push(),this.linkBeforeDrawable(t),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.pop()),a&&!h&&(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("last closed-after link:"),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.push(),this.linkAfterDrawable(s),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.pop()),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.pop()}processEdgeCases(e,t,s){if(e.drawableBefore!==null&&e.drawableAfter!==null){const i=e.drawableBefore.pendingParentDrawable,n=e.drawableAfter.pendingParentDrawable,a=e.nextChangeInterval&&e.nextChangeInterval.drawableAfter?e.nextChangeInterval.drawableAfter.pendingParentDrawable:null;i===n&&(this.blockWasAdded=!0),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`edge case: ${t?"open-before ":""}${s?"open-after ":""}${i.toString()} to ${n.toString()}`),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.push();let o;t&&s?(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`glue using ${i.toString()}`),o=i):this.blockWasAdded||i===n?(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("split with fresh block"),o=this.createBlock(e.drawableAfter.renderer,e.drawableAfter),this.blockOrderChanged=!0):(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`split with same afterBlock ${n.toString()}`),o=n),n===o?(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("no externals change here (blockWasAdded => true)"),this.blockWasAdded=!0):(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("moving externals"),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.push(),this.changeExternals(e,o),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.pop()),a!==n&&(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("end of afterBlock stretch"),this.blockWasAdded||(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`unusing ${n.toString()}`),this.unuseBlock(n)),this.blockWasAdded=!1),sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.pop()}}changeExternals(e,t){const s=Wy(e);this.notePendingMoves(t,e.drawableAfter,s),(!e.nextChangeInterval||e.nextChangeInterval.drawableBefore!==s)&&this.linkAfterDrawable(s)}notePendingMoves(e,t,s){for(let i=t;assert&&assert(!i.pendingAddition&&!i.pendingRemoval,"Moved drawables should be thought of as unchanged, and thus have nothing pending yet"),this.notePendingMove(i,e),i!==s;i=i.nextDrawable);}ensureUsedBlock(e,t){return e?(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`using existing block: ${e.toString()}`),e.used||this.useBlock(e)):(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose("searching for block"),e=this.getBlockForRenderer(t.renderer,t)),e}getBlockForRenderer(e,t){let s;if(!p.isDOM(e))for(let i=this.reusableBlocks.length-1;i>=0;i--){const n=this.reusableBlocks[i];if(assert&&assert(!n.used),n.renderer===e){this.useBlockAtIndex(n,i),s=n;break}}return s||(s=this.createBlock(e,t)),this.blockOrderChanged=!0,s}unuseBlock(e){e.used?(sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`unusing block: ${e.toString()}`),e.used=!1,this.reusableBlocks.push(e)):sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`not using already-unused block: ${e.toString()}`)}useBlock(e){this.useBlockAtIndex(e,_.indexOf(this.reusableBlocks,e))}useBlockAtIndex(e,t){sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`using reusable block: ${e.toString()} with renderer: ${e.renderer}`),assert&&assert(t>=0&&this.reusableBlocks[t]===e,`bad index for useBlockAtIndex: ${t}`),assert&&assert(!e.used,"Should be called on an unused (reusable) block"),this.reusableBlocks.splice(t,1),e.used=!0}removeUnusedBlocks(){for(sceneryLog&&sceneryLog.GreedyStitcher&&this.reusableBlocks.length&&sceneryLog.GreedyStitcher("removeUnusedBlocks"),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.push();this.reusableBlocks.length;){const e=this.reusableBlocks.pop();this.markBlockForDisposal(e),this.blockOrderChanged=!0}sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.pop()}linkBeforeDrawable(e){sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`link before ${e.toString()}`);const t=e.previousDrawable;this.linkBlocks(t?t.pendingParentDrawable:null,e.pendingParentDrawable,t,e)}linkAfterDrawable(e){sceneryLog&&sceneryLog.GreedyVerbose&&sceneryLog.GreedyVerbose(`link after ${e.toString()}`);const t=e.nextDrawable;this.linkBlocks(e.pendingParentDrawable,t?t.pendingParentDrawable:null,e,t)}linkBlocks(e,t,s,i){sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.GreedyStitcher(`linking blocks: ${e?`${e.toString()} (${s.toString()})`:"null"} to ${t?`${t.toString()} (${i.toString()})`:"null"}`),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.push(),assert&&assert(e===null&&s===null||e instanceof As&&s instanceof Ee),assert&&assert(t===null&&i===null||t instanceof As&&i instanceof Ee),e&&(e.nextBlock!==t&&(this.blockOrderChanged=!0,e.nextBlock&&(e.nextBlock.previousBlock=null),e.nextBlock=t),this.markAfterBlock(e,s)),t&&(t.previousBlock!==e&&(this.blockOrderChanged=!0,t.previousBlock&&(t.previousBlock.nextBlock=null),t.previousBlock=e),this.markBeforeBlock(t,i)),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.pop()}processBlockLinkedList(e,t,s){for(;e.blocks.length;)e.blocks.pop();if(sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.GreedyStitcher(`processBlockLinkedList: ${t.toString()} to ${s.toString()}`),sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.push(),t)for(let i=t;sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.GreedyStitcher(i.toString()),e.blocks.push(i),i!==s;i=i.nextBlock);sceneryLog&&sceneryLog.GreedyStitcher&&sceneryLog.pop()}}d.register("GreedyStitcher",sp);class $y extends Fs{stitch(e,t,s,i,n,a,o){this.initialize(e,t,s,i,n,a,o);for(let u=e.previousFirstDrawable;u!==null&&(this.notePendingRemoval(u),u!==e.previousLastDrawable);u=u.oldNextDrawable);this.recordBackboneBoundaries(),this.removeAllBlocks();let h=null,l=0,c=null;for(let u=t;u!==null&&((!h||u.renderer!==l)&&(h&&this.notifyInterval(h,c,u.previousDrawable),l=u.renderer,h=this.createBlock(l,u),p.isDOM(l)&&(l=0),this.appendBlock(h),c=u),this.notePendingAddition(u,h),u!==s);u=u.nextDrawable);h&&this.notifyInterval(h,c,s),this.reindex(),this.clean()}}d.register("RebuildStitcher",$y);class Jn extends Ee{constructor(e,t,s,i,n){super(),this.initialize(e,t,s,i,n)}initialize(e,t,s,i,n){if(super.initialize(i),this.display=e,this.backboneInstance=t,this.transformRootInstance=s,this.filterRootAncestorInstance=t.parent?t.parent.getFilterRootInstance():t,this.transformRootAncestorInstance=t.parent?t.parent.getTransformRootInstance():t,this.willApplyTransform=this.transformRootAncestorInstance!==this.transformRootInstance,this.willApplyFilters=this.filterRootAncestorInstance!==this.backboneInstance,this.transformListener=this.transformListener||this.markTransformDirty.bind(this),this.willApplyTransform&&(this.backboneInstance.relativeTransform.addListener(this.transformListener),this.backboneInstance.relativeTransform.addPrecompute()),this.backboneVisibilityListener=this.backboneVisibilityListener||this.updateBackboneVisibility.bind(this),this.backboneInstance.relativeVisibleEmitter.addListener(this.backboneVisibilityListener),this.updateBackboneVisibility(),this.visibilityDirty=!0,this.renderer=i,this.domElement=n?e.domElement:Jn.createDivBackbone(),this.isDisplayRoot=n,this.dirtyDrawables=ee(this.dirtyDrawables),Y.prepareForTransform(this.domElement),this.watchedFilterNodes=ee(this.watchedFilterNodes),this.filterDirty=!0,this.clipDirty=!0,this.filterDirtyListener=this.filterDirtyListener||this.onFilterDirty.bind(this),this.clipDirtyListener=this.clipDirtyListener||this.onClipDirty.bind(this),this.willApplyFilters){assert&&assert(this.filterRootAncestorInstance.trail.nodes.length<this.backboneInstance.trail.nodes.length,"Our backboneInstance should be deeper if we are applying filters");for(let a=this.backboneInstance;a!==this.filterRootAncestorInstance;a=a.parent){const o=a.node;this.watchedFilterNodes.push(o),o.filterChangeEmitter.addListener(this.filterDirtyListener),o.clipAreaProperty.lazyLink(this.clipDirtyListener)}}this.lastZIndex=0,this.blocks=this.blocks||[],this.previousFirstDrawable=null,this.previousLastDrawable=null,this.removedDrawables=!1,this.stitcher=this.stitcher||new sp,sceneryLog&&sceneryLog.BackboneDrawable&&sceneryLog.BackboneDrawable(`initialized ${this.toString()}`)}dispose(){for(sceneryLog&&sceneryLog.BackboneDrawable&&sceneryLog.BackboneDrawable(`dispose ${this.toString()}`),sceneryLog&&sceneryLog.BackboneDrawable&&sceneryLog.push();this.watchedFilterNodes.length;){const e=this.watchedFilterNodes.pop();e.filterChangeEmitter.removeListener(this.filterDirtyListener),e.clipAreaProperty.unlink(this.clipDirtyListener)}if(this.backboneInstance.relativeVisibleEmitter.removeListener(this.backboneVisibilityListener),!this.removedDrawables)for(let e=this.previousFirstDrawable;e!==null&&(e.parentDrawable.removeDrawable(e),e!==this.previousLastDrawable);e=e.nextDrawable);this.markBlocksForDisposal(),this.willApplyTransform&&(this.backboneInstance.relativeTransform.removeListener(this.transformListener),this.backboneInstance.relativeTransform.removePrecompute()),this.backboneInstance=null,this.transformRootInstance=null,this.filterRootAncestorInstance=null,this.transformRootAncestorInstance=null,ee(this.dirtyDrawables),ee(this.watchedFilterNodes),this.previousFirstDrawable=null,this.previousLastDrawable=null,super.dispose(),sceneryLog&&sceneryLog.BackboneDrawable&&sceneryLog.pop()}markBlocksForDisposal(){for(;this.blocks.length;){const e=this.blocks.pop();sceneryLog&&sceneryLog.BackboneDrawable&&sceneryLog.BackboneDrawable(`${this.toString()} removing block: ${e.toString()}`),e.domElement.parentNode===this.domElement&&this.domElement.removeChild(e.domElement),e.markForDisposal(this.display)}}updateBackboneVisibility(){this.visible=this.backboneInstance.relativeVisible,this.visibilityDirty||(this.visibilityDirty=!0,this.markDirty())}markForDisposal(e){for(let t=this.previousFirstDrawable;t!==null&&(t.notePendingRemoval(this.display),t!==this.previousLastDrawable);t=t.oldNextDrawable);this.removedDrawables=!0,super.markForDisposal(e)}markDirtyDrawable(e){assert&&this.display.ensureNotPainting(),this.dirtyDrawables.push(e),this.markDirty()}markTransformDirty(){assert&&assert(this.willApplyTransform,"Sanity check for willApplyTransform"),Y.applyPreparedTransform(this.backboneInstance.relativeTransform.matrix,this.domElement)}onFilterDirty(){this.filterDirty||(this.filterDirty=!0,this.markDirty())}onClipDirty(){this.clipDirty||(this.clipDirty=!0,this.markDirty())}update(){if(!super.update())return!1;for(;this.dirtyDrawables.length;)this.dirtyDrawables.pop().update();if(this.filterDirty){this.filterDirty=!1;let e="";const t=this.watchedFilterNodes.length;for(let s=0;s<t;s++){const i=this.watchedFilterNodes[s],n=i.getEffectiveOpacity();for(let a=0;a<i._filters.length;a++)e+=`${e?" ":""}${i._filters[a].getCSSFilterString()}`;n!==1&&(e+=`${e?" ":""}opacity(${J(n)})`)}this.domElement.style.filter=e}return this.visibilityDirty&&(this.visibilityDirty=!1,this.domElement.style.display=this.visible?"":"none"),this.clipDirty&&(this.clipDirty=!1),!0}getFilterVisibility(){const e=this.watchedFilterNodes.length;for(let t=0;t<e;t++)if(!this.watchedFilterNodes[t].isVisible())return!1;return!0}getFilterClip(){return""}reindexBlocks(){let e=0;for(let t=0;t<this.blocks.length;t++){const s=this.blocks[t];if(s.zIndex<=e){const i=t+1<this.blocks.length&&this.blocks[t+1].zIndex-1>e?Math.ceil((e+this.blocks[t+1].zIndex)/2):e+20;s.domElement.style.zIndex=s.zIndex=i}e=s.zIndex,assert&&(assert(this.blocks[t].zIndex%1===0,"z-indices should be integers"),assert(this.blocks[t].zIndex>0,"z-indices should be greater than zero for our needs (see spec)"),t>0&&assert(this.blocks[t-1].zIndex<this.blocks[t].zIndex,"z-indices should be strictly increasing"))}this.lastZIndex=e+1}stitch(e,t,s,i){if(s===null||i===null){assert&&assert(s===null),assert&&assert(i===null);return}assert&&assert(i.nextChangeInterval===null,"This allows us to have less checks in the loop"),sceneryLog&&sceneryLog.Stitch&&(sceneryLog.Stitch(`Stitch intervals before constricting: ${this.toString()}`),sceneryLog.push(),Fs.debugIntervals(s),sceneryLog.pop());let n=null,a=s,o=!1;for(;a;)o=a.constrict()||o,a.isEmpty()?(assert&&assert(o),n&&(n.nextChangeInterval=a.nextChangeInterval)):(n||(s=a),n=a),a=a.nextChangeInterval;if(n){if(i=n,i.nextChangeInterval=null,sceneryLog&&sceneryLog.Stitch&&o&&(sceneryLog.Stitch(`Stitch intervals after constricting: ${this.toString()}`),sceneryLog.push(),Fs.debugIntervals(s),sceneryLog.pop()),sceneryLog&&d.isLoggingPerformance()){this.display.perfStitchCount++;let h=s;for(;h;)this.display.perfIntervalCount++,this.display.perfDrawableOldIntervalCount+=h.getOldInternalDrawableCount(this.previousFirstDrawable,this.previousLastDrawable),this.display.perfDrawableNewIntervalCount+=h.getNewInternalDrawableCount(e,t),h=h.nextChangeInterval}this.stitcher.stitch(this,e,t,this.previousFirstDrawable,this.previousLastDrawable,s,i)}}audit(e,t,s){if(assertSlow){super.audit(e,t,s),assertSlow&&assertSlow(this.backboneInstance.isBackbone,"We should reference an instance that requires a backbone"),assertSlow&&assertSlow(this.transformRootInstance.isTransformed,"Transform root should be transformed");for(let i=0;i<this.blocks.length;i++)this.blocks[i].audit(e,t,s)}}static createDivBackbone(){const e=document.createElement("div");return e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.width="0",e.style.height="0",e}static repurposeBackboneContainer(e){return(e.style.position!=="relative"||e.style.position!=="absolute")&&(e.style.position="relative"),e.style.left="0",e.style.top="0",e}}d.register("BackboneDrawable",Jn);ae.mixInto(Jn);const bi=Jn;class er{constructor(e,t,s){this.display=e,this.rootNode=t;const i=document.createElementNS(ne,"svg");i.style.position="absolute",i.setAttribute("class",s),i.style.top="0",i.style.left="0",i.style["pointer-events"]="none",this.svg=i;function n(a,o){i.setAttribute("width",""+a),i.setAttribute("height",""+o),i.style.clip=`rect(0px,${a}px,${o}px,0px)`}e.sizeProperty.link(a=>{n(a.width,a.height)}),this.domElement=i}addShape(e,t,s){const i=document.createElementNS(ne,"path");let n=e.getSVGPath();n||(n="M0 0"),n?i.setAttribute("d",n):i.hasAttribute("d")&&i.removeAttribute("d"),i.setAttribute("style",`fill: none; stroke: ${t}; stroke-dasharray: 5, 3; stroke-dashoffset: ${s?5:0}; stroke-width: 3;`),this.svg.appendChild(i)}update(){for(;this.svg.childNodes.length;)this.svg.removeChild(this.svg.childNodes[this.svg.childNodes.length-1]);this.addShapes()}dispose(){}}d.register("ShapeBasedOverlay",er);class ip extends er{constructor(e,t){super(e,t,"canvasNodeBoundsOverlay")}addShapes(){new R(this.rootNode).eachTrailUnder(e=>{const t=e.lastNode();if(!t.isVisible())return!0;if(t instanceof Ks&&e.isVisible()){const s=e.getTransform();this.addShape(s.transformShape(H.bounds(t.selfBounds)),"rgba(0,255,0,0.8)",!0)}return!1})}}d.register("CanvasNodeBoundsOverlay",ip);class np extends er{constructor(e,t){super(e,t,"canvasNodeBoundsOverlay")}addShapes(){const e=this;function t(n,a){n.willApplyTransform&&(a=a.timesMatrix(n.backboneInstance.relativeTransform.matrix)),n.blocks.forEach(o=>{s(o,a)})}function s(n,a){if(n instanceof Xt&&!n.fitBounds.isEmpty()&&e.addShape(H.bounds(n.fitBounds).transformed(a),"rgba(255,0,0,0.8)",!0),n.firstDrawable&&n.lastDrawable){for(let o=n.firstDrawable;o!==n.lastDrawable;o=o.nextDrawable)i(o,a);i(n.lastDrawable,a)}}function i(n,a){n instanceof bi&&t(n,a)}t(this.display.rootBackbone,C.IDENTITY)}}d.register("FittedBlockBoundsOverlay",np);let Nc=Ie.OUTER_FOCUS_COLOR,Bc=Ie.INNER_FOCUS_COLOR,Fc=Ie.INNER_LIGHT_GROUP_FOCUS_COLOR,Hc=Ie.OUTER_LIGHT_GROUP_FOCUS_COLOR;class tt{constructor(e,t,s){this.trail=null,this.node=null,this.activeHighlight=null,this.mode=null,this.groupMode=null,this.groupHighlightNode=null,this.transformTracker=null,this.groupTransformTracker=null,this.nodeModeHighlight=null,this.nodeModeHighlightLayered=!1,this.transformDirty=!0,this.highlightNode=new D,this.readingBlockHighlightNode=new D,this.addedReadingBlockHighlight=null,this.activeReadingBlockNode=null,this.readingBlockTrail=null,this.readingBlockTransformDirty=!0,this.readingBlockTransformTracker=null;const i=E()({pdomFocusHighlightsVisibleProperty:new ie(!0),interactiveHighlightsVisibleProperty:new ie(!1),readingBlockHighlightsVisibleProperty:new ie(!1)},s);this.display=e,this.focusRootNode=t,this.focusRootNode.addChild(this.highlightNode),this.focusRootNode.addChild(this.readingBlockHighlightNode),this.pdomFocusHighlightsVisibleProperty=i.pdomFocusHighlightsVisibleProperty,this.interactiveHighlightsVisibleProperty=i.interactiveHighlightsVisibleProperty,this.readingBlockHighlightsVisibleProperty=i.readingBlockHighlightsVisibleProperty,this.focusDisplay=new Be(this.focusRootNode,{allowWebGL:e.isWebGLAllowed(),allowCSSHacks:!1,accessibility:!1,interactive:!1,allowLayerFitting:!0}),this.domElement=this.focusDisplay.domElement,this.domElement.style.pointerEvents="none",this.shapeFocusHighlightPath=new Ie(null),this.boundsFocusHighlightPath=new zn(null,{useLocalBounds:!0}),this.highlightNode.addChild(this.shapeFocusHighlightPath),this.highlightNode.addChild(this.boundsFocusHighlightPath),this.groupFocusHighlightPath=new zn(null,{useLocalBounds:!0,useGroupDilation:!0,outerLineWidth:Ie.GROUP_OUTER_LINE_WIDTH,innerLineWidth:Ie.GROUP_INNER_LINE_WIDTH,innerStroke:Ie.OUTER_FOCUS_COLOR}),this.groupFocusHighlightParent=new D({children:[this.groupFocusHighlightPath]}),this.focusRootNode.addChild(this.groupFocusHighlightParent),this.readingBlockHighlightPath=new tf(null),this.readingBlockHighlightNode.addChild(this.readingBlockHighlightPath),this.boundsListener=this.onBoundsChange.bind(this),this.transformListener=this.onTransformChange.bind(this),this.domFocusListener=this.onFocusChange.bind(this),this.readingBlockTransformListener=this.onReadingBlockTransformChange.bind(this),this.focusHighlightListener=this.onFocusHighlightChange.bind(this),this.interactiveHighlightListener=this.onInteractiveHighlightChange.bind(this),this.focusHighlightsVisibleListener=this.onFocusHighlightsVisibleChange.bind(this),this.voicingHighlightsVisibleListener=this.onVoicingHighlightsVisibleChange.bind(this),this.pointerFocusListener=this.onPointerFocusChange.bind(this),this.lockedPointerFocusListener=this.onLockedPointerFocusChange.bind(this),this.readingBlockFocusListener=this.onReadingBlockFocusChange.bind(this),this.readingBlockHighlightChangeListener=this.onReadingBlockHighlightChange.bind(this),oe.pdomFocusProperty.link(this.domFocusListener),e.focusManager.pointerFocusProperty.link(this.pointerFocusListener),e.focusManager.readingBlockFocusProperty.link(this.readingBlockFocusListener),e.focusManager.lockedPointerFocusProperty.link(this.lockedPointerFocusListener),this.pdomFocusHighlightsVisibleProperty.link(this.focusHighlightsVisibleListener),this.interactiveHighlightsVisibleProperty.link(this.voicingHighlightsVisibleListener)}dispose(){this.hasHighlight()&&this.deactivateHighlight(),oe.pdomFocusProperty.unlink(this.domFocusListener),this.pdomFocusHighlightsVisibleProperty.unlink(this.focusHighlightsVisibleListener),this.interactiveHighlightsVisibleProperty.unlink(this.voicingHighlightsVisibleListener),this.display.focusManager.pointerFocusProperty.unlink(this.pointerFocusListener),this.display.focusManager.readingBlockFocusProperty.unlink(this.readingBlockFocusListener),this.focusDisplay.dispose()}hasHighlight(){return!!this.trail}hasReadingBlockHighlight(){return!!this.readingBlockTrail}activateHighlight(e,t,s,i,n){this.trail=e,this.node=t;const a=s;this.activeHighlight=a;let o=e;if(a==="invisible")this.mode="invisible";else if(a instanceof H)this.mode="shape",this.shapeFocusHighlightPath.visible=!0,this.shapeFocusHighlightPath.setShape(a);else if(a instanceof D){if(this.mode="node",a instanceof Ie){const h=a;assert&&assert(a.shape!==null,"The shape of the Node highlight should be set by now. Does it have bounds?"),h.transformSourceNode&&(o=a.getUniqueHighlightTrail(this.trail))}this.nodeModeHighlight=a,i?(this.nodeModeHighlightLayered=!0,this.nodeModeHighlight.visible=n.get()):(this.nodeModeHighlight.visible=!0,this.highlightNode.addChild(this.nodeModeHighlight))}else this.mode="bounds",this.boundsFocusHighlightPath.setShapeFromNode(this.node),this.boundsFocusHighlightPath.visible=!0,this.node.localBoundsProperty.lazyLink(this.boundsListener),this.onBoundsChange();this.transformTracker=new Js(o,{isStatic:!0}),this.transformTracker.addListener(this.transformListener),this.activateGroupHighlights(),this.updateHighlightColors(),this.transformDirty=!0}activateFocusHighlight(e,t){this.activateHighlight(e,t,t.focusHighlight,t.focusHighlightLayerable,this.pdomFocusHighlightsVisibleProperty),t.focusHighlightChangedEmitter.addListener(this.focusHighlightListener)}activateInteractiveHighlight(e,t){this.activateHighlight(e,t,t.interactiveHighlight||t.focusHighlight,t.interactiveHighlightLayerable,this.interactiveHighlightsVisibleProperty),assert&&assert(t.isInteractiveHighlighting,"Node does not support any kind of interactive highlighting."),t.interactiveHighlightChangedEmitter.addListener(this.interactiveHighlightListener),t.focusHighlightChangedEmitter.addListener(this.interactiveHighlightListener)}activateReadingBlockHighlight(e){this.readingBlockTrail=e;const t=e.lastNode();assert&&assert(t.isReadingBlock,"should not activate a reading block highlight for a Node that is not a ReadingBlock"),this.activeReadingBlockNode=t;const s=this.activeReadingBlockNode.readingBlockActiveHighlight;this.addedReadingBlockHighlight=s,s==="invisible"||(s instanceof H?(this.readingBlockHighlightPath.setShape(s),this.readingBlockHighlightPath.visible=!0):s instanceof D?this.readingBlockHighlightNode.addChild(s):(this.readingBlockHighlightPath.setShapeFromNode(this.activeReadingBlockNode),this.readingBlockHighlightPath.visible=!0)),this.readingBlockTransformTracker=new Js(this.readingBlockTrail,{isStatic:!0}),this.readingBlockTransformTracker.addListener(this.readingBlockTransformListener),this.activeReadingBlockNode.readingBlockActiveHighlightChangedEmitter.addListener(this.readingBlockHighlightChangeListener),this.readingBlockTransformDirty=!0}deactivateReadingBlockHighlight(){this.readingBlockHighlightPath.visible=!1,this.addedReadingBlockHighlight instanceof D&&this.readingBlockHighlightNode.removeChild(this.addedReadingBlockHighlight),assert&&assert(this.readingBlockTransformTracker,"How can we deactivate the TransformTracker if it wasnt assigned.");const e=this.readingBlockTransformTracker;e.removeListener(this.readingBlockTransformListener),e.dispose(),this.readingBlockTransformTracker=null,assert&&assert(this.activeReadingBlockNode,"How can we deactivate the activeReadingBlockNode if it wasnt assigned."),this.activeReadingBlockNode.readingBlockActiveHighlightChangedEmitter.removeListener(this.readingBlockHighlightChangeListener),this.activeReadingBlockNode=null,this.readingBlockTrail=null,this.addedReadingBlockHighlight=null}deactivateHighlight(){assert&&assert(this.node,"Need an active Node to deactivate highlights");const e=this.node;if(this.mode==="shape")this.shapeFocusHighlightPath.visible=!1;else if(this.mode==="node"){assert&&assert(this.nodeModeHighlight,"How can we deactivate if nodeModeHighlight is not assigned");const s=this.nodeModeHighlight;this.nodeModeHighlightLayered?this.nodeModeHighlightLayered=!1:this.highlightNode.removeChild(s),s.visible=!1,this.nodeModeHighlight=null}else this.mode==="bounds"&&(this.boundsFocusHighlightPath.visible=!1,e.localBoundsProperty.unlink(this.boundsListener));e.focusHighlightChangedEmitter.hasListener(this.focusHighlightListener)&&e.focusHighlightChangedEmitter.removeListener(this.focusHighlightListener);const t=e;t.isInteractiveHighlighting&&(t.interactiveHighlightChangedEmitter.hasListener(this.interactiveHighlightListener)&&t.interactiveHighlightChangedEmitter.removeListener(this.interactiveHighlightListener),t.focusHighlightChangedEmitter.hasListener(this.interactiveHighlightListener)&&t.focusHighlightChangedEmitter.removeListener(this.interactiveHighlightListener)),this.deactivateGroupHighlights(),this.trail=null,this.node=null,this.mode=null,this.activeHighlight=null,this.transformTracker.removeListener(this.transformListener),this.transformTracker.dispose(),this.transformTracker=null}activateGroupHighlights(){assert&&assert(this.trail,"must have an active trail to activate group highlights");const e=this.trail;for(let t=0;t<e.length;t++){const s=e.nodes[t],i=s.groupFocusHighlight;if(i){const n=e.upToNode(s);this.groupTransformTracker=new Js(n),this.groupTransformTracker.addListener(this.transformListener),typeof i=="boolean"?(this.groupFocusHighlightPath.setShapeFromNode(s),this.groupFocusHighlightPath.visible=!0,this.groupHighlightNode=this.groupFocusHighlightPath,this.groupMode="bounds"):i instanceof D&&(this.groupHighlightNode=i,this.groupFocusHighlightParent.addChild(i),this.groupMode="node");break}}}updateHighlightColors(){this.mode==="shape"?(this.shapeFocusHighlightPath.innerHighlightColor!==tt.getInnerHighlightColor()&&this.shapeFocusHighlightPath.setInnerHighlightColor(tt.getInnerHighlightColor()),this.shapeFocusHighlightPath.outerHighlightColor!==tt.getOuterHighlightColor()&&this.shapeFocusHighlightPath.setOuterHighlightColor(tt.getOuterHighlightColor())):this.mode==="bounds"&&(this.boundsFocusHighlightPath.innerHighlightColor!==tt.getInnerHighlightColor()&&this.boundsFocusHighlightPath.setInnerHighlightColor(tt.getInnerHighlightColor()),this.boundsFocusHighlightPath.outerHighlightColor!==tt.getOuterHighlightColor()&&this.boundsFocusHighlightPath.setOuterHighlightColor(tt.getOuterHighlightColor())),this.groupMode&&(this.groupFocusHighlightPath.innerHighlightColor!==tt.getInnerGroupHighlightColor()&&this.groupFocusHighlightPath.setInnerHighlightColor(tt.getInnerGroupHighlightColor()),this.groupFocusHighlightPath.outerHighlightColor!==tt.getOuterGroupHighlightColor()&&this.groupFocusHighlightPath.setOuterHighlightColor(tt.getOuterGroupHighlightColor()))}deactivateGroupHighlights(){this.groupMode&&(this.groupMode==="bounds"?this.groupFocusHighlightPath.visible=!1:this.groupMode==="node"&&(assert&&assert(this.groupHighlightNode,"Need a groupHighlightNode to deactivate this mode"),this.groupFocusHighlightParent.removeChild(this.groupHighlightNode)),this.groupMode=null,this.groupHighlightNode=null,assert&&assert(this.groupTransformTracker,"Need a groupTransformTracker to dispose"),this.groupTransformTracker.removeListener(this.transformListener),this.groupTransformTracker.dispose(),this.groupTransformTracker=null)}afterTransform(){this.mode==="shape"?this.shapeFocusHighlightPath.updateLineWidth():this.mode==="bounds"?this.boundsFocusHighlightPath.updateLineWidth():this.mode==="node"&&this.activeHighlight instanceof Ie&&this.activeHighlight.updateLineWidth&&(assert&&assert(this.node,"Need an active Node to update line width"),this.activeHighlight.updateLineWidth(this.node))}onTransformChange(){this.transformDirty=!0}onReadingBlockTransformChange(){this.readingBlockTransformDirty=!0}onBoundsChange(){assert&&assert(this.node,"Must have an active node when bounds are changing"),this.boundsFocusHighlightPath.setShapeFromNode(this.node)}onFocusChange(e){const t=e&&e.display===this.display?e.trail:null;if(this.hasHighlight()&&this.deactivateHighlight(),t&&this.pdomFocusHighlightsVisibleProperty.value){const s=t.lastNode();this.activateFocusHighlight(t,s)}else this.display.focusManager.pointerFocusProperty.value&&this.interactiveHighlightsVisibleProperty.value&&this.updateInteractiveHighlight(this.display.focusManager.pointerFocusProperty.value)}onPointerFocusChange(e){!this.display.focusManager.lockedPointerFocusProperty.value&&!this.display.focusManager.pdomFocusHighlightsVisibleProperty.value&&this.updateInteractiveHighlight(e)}updateInteractiveHighlight(e){const t=e&&e.display===this.display?e.trail:null;this.hasHighlight()&&this.deactivateHighlight();let s=!1;if(t&&!this.display.focusManager.pdomFocusHighlightsVisibleProperty.value){const i=t.lastNode();(i.isReadingBlock&&this.readingBlockHighlightsVisibleProperty.value||!i.isReadingBlock&&this.interactiveHighlightsVisibleProperty.value)&&(this.activateInteractiveHighlight(t,i),s=!0)}!s&&oe.pdomFocus&&this.pdomFocusHighlightsVisibleProperty.value&&this.onFocusChange(oe.pdomFocus)}onLockedPointerFocusChange(e){this.updateInteractiveHighlight(e||this.display.focusManager.pointerFocusProperty.value)}onReadingBlockFocusChange(e){this.hasReadingBlockHighlight()&&this.deactivateReadingBlockHighlight();const t=e&&e.display===this.display?e.trail:null;t&&this.activateReadingBlockHighlight(t)}onFocusHighlightChange(){assert&&assert(this.node&&this.node.focused,"update should only be necessary if node already has focus"),this.onFocusChange(oe.pdomFocus)}onInteractiveHighlightChange(){if(assert){const e=this.node,t=this.display.focusManager.lockedPointerFocusProperty.value;assert(e||t&&t.trail.lastNode()===this.node,"Update should only be necessary if Node is activated with a Pointer or pointer focus is locked during interaction")}this.updateInteractiveHighlight(this.display.focusManager.lockedPointerFocusProperty.value||this.display.focusManager.pointerFocusProperty.value)}onReadingBlockHighlightChange(){assert&&assert(this.activeReadingBlockNode,"Update should only be necessary when there is an active ReadingBlock Node"),assert&&assert(this.activeReadingBlockNode.readingBlockActivated,"Update should only be necessary while the ReadingBlock is activated"),this.onReadingBlockFocusChange(this.display.focusManager.readingBlockFocusProperty.value)}onFocusHighlightsVisibleChange(){this.onFocusChange(oe.pdomFocus)}onVoicingHighlightsVisibleChange(){this.onPointerFocusChange(this.display.focusManager.pointerFocusProperty.value)}update(){this.hasHighlight()&&this.transformDirty&&(this.transformDirty=!1,assert&&assert(this.transformTracker,"The transformTracker must be available on update if transform is dirty"),this.highlightNode.setMatrix(this.transformTracker.matrix),this.groupHighlightNode&&(assert&&assert(this.groupTransformTracker,"The groupTransformTracker must be available on update if transform is dirty"),this.groupHighlightNode.setMatrix(this.groupTransformTracker.matrix)),this.afterTransform()),this.hasReadingBlockHighlight()&&this.readingBlockTransformDirty&&(this.readingBlockTransformDirty=!1,assert&&assert(this.readingBlockTransformTracker,"The groupTransformTracker must be available on update if transform is dirty"),this.readingBlockHighlightNode.setMatrix(this.readingBlockTransformTracker.matrix)),this.display.size.equals(this.focusDisplay.size)||this.focusDisplay.setWidthHeight(this.display.width,this.display.height),this.focusDisplay.updateDisplay()}static setInnerHighlightColor(e){Bc=e}static getInnerHighlightColor(){return Bc}static setOuterHilightColor(e){Nc=e}static getOuterHighlightColor(){return Nc}static setInnerGroupHighlightColor(e){Fc=e}static getInnerGroupHighlightColor(){return Fc}static setOuterGroupHighlightColor(e){Hc=e}static getOuterGroupHighlightColor(){return Hc}}d.register("HighlightOverlay",tt);class js extends er{constructor(e,t){super(e,t,"hitAreaOverlay")}addShapes(){new R(this.rootNode).eachTrailUnder(e=>{const t=e.lastNode();if(!t.isVisible()||t.pickable===!1)return!0;if(t.inputListeners.length&&e.isVisible()){const s=js.getLocalMouseShape(t),i=js.getLocalTouchShape(t),n=e.getMatrix();s.bounds.isEmpty()||this.addShape(s.transformed(n),"rgba(0,0,255,0.8)",!0),i.bounds.isEmpty()||this.addShape(i.transformed(n),"rgba(255,0,0,0.8)",!1)}return!1})}static getLocalMouseShape(e){let t=H.union([e.mouseArea?e.mouseArea instanceof H?e.mouseArea:H.bounds(e.mouseArea):e.getSelfShape(),...e.children.filter(s=>e.visible&&e.pickable!==!1).map(s=>js.getLocalMouseShape(s).transformed(s.matrix))]);return e.hasClipArea()&&(t=t.shapeIntersection(e.clipArea)),t}static getLocalTouchShape(e){let t=H.union([e.touchArea?e.touchArea instanceof H?e.touchArea:H.bounds(e.touchArea):e.getSelfShape(),...e.children.filter(s=>e.visible&&e.pickable!==!1).map(s=>js.getLocalTouchShape(s).transformed(s.matrix))]);return e.hasClipArea()&&(t=t.shapeIntersection(e.clipArea)),t}}d.register("HitAreaOverlay",js);class rp extends er{constructor(e,t){super(e,t,"mouseTouchAreaOverlay")}addShapes(){new R(this.rootNode).eachTrailUnder(e=>{const t=e.lastNode();if(!t.isVisible())return!0;if((t.mouseArea||t.touchArea)&&e.isVisible()){const s=e.getTransform();t.mouseArea&&this.addShape(s.transformShape(t.mouseArea instanceof w?H.bounds(t.mouseArea):t.mouseArea),"rgba(0,0,255,0.8)",!0),t.touchArea&&this.addShape(s.transformShape(t.touchArea instanceof w?H.bounds(t.touchArea):t.touchArea),"rgba(255,0,0,0.8)",!1)}return!1})}}d.register("PointerAreaOverlay",rp);class ap{constructor(e,t){this.display=e,this.rootNode=t,this.pointerSVGContainer=document.createElement("div"),this.pointerSVGContainer.style.position="absolute",this.pointerSVGContainer.style.top="0",this.pointerSVGContainer.style.left="0",this.pointerSVGContainer.style["pointer-events"]="none";const s=10,i=1,n=(s+i/2)*2,a=n/2;e.sizeProperty.lazyLink(h=>{this.pointerSVGContainer.setAttribute("width",""+h.width),this.pointerSVGContainer.setAttribute("height",""+h.height),this.pointerSVGContainer.style.clip=`rect(0px,${h.width}px,${h.height}px,0px)`});const o=C.IDENTITY.copy();this.pointerAdded=h=>{const l=document.createElementNS(ne,"svg");l.style.position="absolute",l.style.top="0",l.style.left="0",l.style["pointer-events"]="none",Y.prepareForTransform(l),l.setAttribute("width",""+n),l.setAttribute("height",""+n);const c=document.createElementNS(ne,"circle");c.setAttribute("cx",""+(s+i/2)),c.setAttribute("cy",""+(s+i/2)),c.setAttribute("r",""+s),c.setAttribute("style","fill:black;"),c.setAttribute("style","stroke:white;"),c.setAttribute("opacity","0.4");const u=y=>Y.applyPreparedTransform(o.setToTranslation(y.x-a,y.y-a),l),m=()=>{h.isTouchLike()&&(this.pointerSVGContainer.removeChild(l),h.removeInputListener(b))},b={move:()=>{h.point&&u(h.point)},up:m,cancel:m,focus:()=>{h instanceof Mi&&h.point&&(u(h.point),this.pointerSVGContainer.appendChild(l))},blur:()=>{this.pointerSVGContainer.contains(l)&&this.pointerSVGContainer.removeChild(l)}};h.addInputListener(b),b.move(),l.appendChild(c),this.pointerSVGContainer.appendChild(l)},e._input.pointerAddedEmitter.addListener(this.pointerAdded),e._input&&e._input.mouse&&this.pointerAdded(e._input.mouse),this.domElement=this.pointerSVGContainer}dispose(){this.display._input.pointerAddedEmitter.removeListener(this.pointerAdded)}update(){}}d.register("PointerOverlay",ap);let Uy=1;const Yy=p.createOrderBitmask(p.bitmaskSVG,p.bitmaskCanvas,p.bitmaskDOM,p.bitmaskWebGL);class $t{constructor(e,t,s,i){Zh(this,"display",null);this.active=!1,this.initialize(e,t,s,i)}initialize(e,t,s,i){return assert&&assert(!this.active,"We should never try to initialize an already active object"),t.setImmutable(),this.id=this.id||Uy++,this.isWebGLSupported=e.isWebGLAllowed()&&Y.isWebGLSupported,this.relativeTransform=this.relativeTransform||new Qu(this),this.fittability=this.fittability||new Zu(this),this.visible=!0,this.relativeVisible=!0,this.selfVisible=!0,this.visibilityDirty=!0,this.childVisibilityDirty=!0,this.voicingVisible=!0,this.branchIndexMap=this.branchIndexMap||{},this.branchIndexReferences=ee(this.branchIndexReferences),this.addRemoveCounter=0,this.stitchChangeFrame=e._frameId,this.stitchChangeBefore=0,this.stitchChangeAfter=0,this.stitchChangeOnChildren=0,this.stitchChangeIncluded=!1,this.childInsertedListener=this.childInsertedListener||this.onChildInserted.bind(this),this.childRemovedListener=this.childRemovedListener||this.onChildRemoved.bind(this),this.childrenReorderedListener=this.childrenReorderedListener||this.onChildrenReordered.bind(this),this.visibilityListener=this.visibilityListener||this.onVisibilityChange.bind(this),this.markRenderStateDirtyListener=this.markRenderStateDirtyListener||this.markRenderStateDirty.bind(this),this.visibleEmitter=new re,this.relativeVisibleEmitter=new re,this.selfVisibleEmitter=new re,this.canVoiceEmitter=new re,this.cleanInstance(e,t),this.node.addInstance(this),this.externalReferenceCount=0,this.stateless=!0,this.isDisplayRoot=s,this.isSharedCanvasCacheRoot=i,this.preferredRenderers=0,this.isUnderCanvasCache=i,this.isBackbone=!1,this.isTransformed=!1,this.isVisibilityApplied=!1,this.isInstanceCanvasCache=!1,this.isSharedCanvasCachePlaceholder=!1,this.isSharedCanvasCacheSelf=i,this.selfRenderer=0,this.groupRenderer=0,this.sharedCacheRenderer=0,this.renderStateDirtyFrame=e._frameId,this.skipPruningFrame=e._frameId,sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`initialized ${this.toString()}`),this.active=!0,this}cleanInstance(e,t){this.display=e,this.trail=t,this.node=t?t.lastNode():null,this.parent=null,this.oldParent=null,this.children=ee(this.children),this.sharedCacheInstance=null,this.relativeTransform.initialize(e,t),this.fittability.initialize(e,t),this.instanceRemovalCheckList=ee(this.instanceRemovalCheckList),this.selfDrawable=null,this.groupDrawable=null,this.sharedCacheDrawable=null,this.firstDrawable=null,this.lastDrawable=null,this.firstInnerDrawable=null,this.lastInnerDrawable=null,this.svgGroups=ee(this.svgGroups),this.cleanSyncTreeResults()}cleanSyncTreeResults(){this.beforeStableIndex=this.children.length,this.afterStableIndex=-1,this.firstChangeInterval=null,this.lastChangeInterval=null,this.incompatibleStateChange=!1,this.groupChanged=!1,this.cascadingStateChange=!1,this.anyStateChange=!1}updateRenderingState(){sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`updateRenderingState ${this.toString()}${this.stateless?" (stateless)":""}`),sceneryLog&&sceneryLog.Instance&&sceneryLog.push(),sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`old: ${this.getStateString()}`);const e=this.isBackbone,t=this.isTransformed,s=this.isVisibilityApplied,i=this.isInstanceCanvasCache,n=this.isSharedCanvasCacheSelf,a=this.isSharedCanvasCachePlaceholder,o=this.isUnderCanvasCache,h=this.selfRenderer,l=this.groupRenderer,c=this.sharedCacheRenderer,u=this.preferredRenderers;this.isBackbone=!1,this.isTransformed=!1,this.isVisibilityApplied=!1,this.isInstanceCanvasCache=!1,this.isSharedCanvasCacheSelf=!1,this.isSharedCanvasCachePlaceholder=!1,this.selfRenderer=0,this.groupRenderer=0,this.sharedCacheRenderer=0;const m=this.node;this.isUnderCanvasCache=this.isSharedCanvasCacheRoot||(this.parent?this.parent.isUnderCanvasCache||this.parent.isInstanceCanvasCache||this.parent.isSharedCanvasCacheSelf:!1),this.preferredRenderers=this.parent?this.parent.preferredRenderers:Yy,m._renderer&&(this.preferredRenderers=p.pushOrderBitmask(this.preferredRenderers,m._renderer));const b=this.node.hasClipArea(),y=this.node.effectiveOpacity!==1||m._usesOpacity||this.node._filters.length>0;let f=!1,L=!1;if(y)for(let fe=0;fe<this.node._filters.length;fe++){const k=this.node._filters[fe];k.isSVGCompatible()||(f=!0),k.isCanvasCompatible()||(L=!0)}const v=m._cssTransform||m._layerSplit,S=this.isDisplayRoot||!this.isUnderCanvasCache&&v,B=!S&&(y||b)&&(!f&&this.node._rendererSummary.isSubtreeRenderedExclusivelySVG(this.preferredRenderers)||!L&&this.node._rendererSummary.isSubtreeRenderedExclusivelyCanvas(this.preferredRenderers));if((B?!1:S||y||b)?(this.isBackbone=!0,this.isVisibilityApplied=!0,this.isTransformed=this.isDisplayRoot||!!m._cssTransform,this.groupRenderer=p.bitmaskDOM):!B&&(y||b||m._canvasCache)&&(assert&&assert(this.node._rendererSummary.isSingleCanvasSupported(),`Node canvasCache provided, but not all node contents can be rendered with Canvas under ${this.node.constructor.name}`),m._singleCache?this.isSharedCanvasCacheRoot?(this.isSharedCanvasCacheSelf=!0,this.sharedCacheRenderer=this.isWebGLSupported?p.bitmaskWebGL:p.bitmaskCanvas):(assert&&assert(this.node._rendererSummary.areBoundsValid(),`Node singleCache provided, but not all node contents have valid bounds under ${this.node.constructor.name}`),this.isSharedCanvasCachePlaceholder=!0):(this.isInstanceCanvasCache=!0,this.isUnderCanvasCache=!0,this.groupRenderer=this.isWebGLSupported?p.bitmaskWebGL:p.bitmaskCanvas)),this.node.isPainted())if(this.isUnderCanvasCache)this.selfRenderer=p.bitmaskCanvas;else{let fe=this.node._rendererBitmask;if(!this.isWebGLSupported){const k=p.bitmaskWebGL;fe=fe^fe&k}this.selfRenderer=fe&p.bitmaskOrder(this.preferredRenderers,0)||fe&p.bitmaskOrder(this.preferredRenderers,1)||fe&p.bitmaskOrder(this.preferredRenderers,2)||fe&p.bitmaskOrder(this.preferredRenderers,3)||fe&p.bitmaskSVG||fe&p.bitmaskCanvas||fe&p.bitmaskDOM||fe&p.bitmaskWebGL||0,assert&&assert(this.selfRenderer,"setSelfRenderer failure?")}this.groupChanged=e!==this.isBackbone||i!==this.isInstanceCanvasCache||n!==this.isSharedCanvasCacheSelf,this.cascadingStateChange=o!==this.isUnderCanvasCache||u!==this.preferredRenderers,this.incompatibleStateChange=this.isTransformed!==t||this.isSharedCanvasCachePlaceholder!==a,this.anyStateChange=this.groupChanged||this.cascadingStateChange||this.incompatibleStateChange||h!==this.selfRenderer||l!==this.groupRenderer||c!==this.sharedCacheRenderer,s!==this.isVisibilityApplied&&(this.visibilityDirty=!0,this.parent&&this.parent.markChildVisibilityDirty()),this.fittability.checkSelfFittability(),sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`new: ${this.getStateString()}`),sceneryLog&&sceneryLog.Instance&&sceneryLog.pop()}getStateString(){return`${`S[ ${this.isDisplayRoot?"displayRoot ":""}${this.isBackbone?"backbone ":""}${this.isInstanceCanvasCache?"instanceCache ":""}${this.isSharedCanvasCachePlaceholder?"sharedCachePlaceholder ":""}${this.isSharedCanvasCacheSelf?"sharedCacheSelf ":""}${this.isTransformed?"TR ":""}${this.isVisibilityApplied?"VIS ":""}${this.selfRenderer?this.selfRenderer.toString(16):"-"},${this.groupRenderer?this.groupRenderer.toString(16):"-"},${this.sharedCacheRenderer?this.sharedCacheRenderer.toString(16):"-"} `}]`}baseSyncTree(){assert&&assert(this.isDisplayRoot,"baseSyncTree() should only be called on the root instance"),sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`-------- START baseSyncTree ${this.toString()} --------`),this.syncTree(),sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`-------- END baseSyncTree ${this.toString()} --------`),this.cleanSyncTreeResults()}syncTree(){sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`syncTree ${this.toString()} ${this.getStateString()}${this.stateless?" (stateless)":""}`),sceneryLog&&sceneryLog.Instance&&sceneryLog.push(),sceneryLog&&d.isLoggingPerformance()&&this.display.perfSyncTreeCount++,assert&&assert(!this.parent||!this.parent.stateless,"We should not have a stateless parent instance");const e=this.stateless;if(e||this.parent&&this.parent.cascadingStateChange||this.renderStateDirtyFrame===this.display._frameId?this.updateRenderingState():assertSlow&&(this.updateRenderingState(),assertSlow(!this.anyStateChange)),!e&&this.incompatibleStateChange)return sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`incompatible instance ${this.toString()} ${this.getStateString()}, aborting`),sceneryLog&&sceneryLog.Instance&&sceneryLog.pop(),!1;if(this.stateless=!1,assert&&assert(!e||this.children.length===0,"We should not have child instances on an instance without state"),e&&(this.isTransformed&&this.display.markTransformRootDirty(this,!0),this.attachNodeListeners()),this.isSharedCanvasCachePlaceholder)this.sharedSyncTree();else if(e||this.skipPruningFrame===this.display._frameId||this.anyStateChange){this.prepareChildInstances(e);const t=this.firstDrawable,s=this.lastDrawable,i=this.firstInnerDrawable,n=this.lastInnerDrawable,a=this.updateSelfDrawable();this.localSyncTree(a),assertSlow&&this.auditChangeIntervals(i,n,this.firstInnerDrawable,this.lastInnerDrawable),this.groupSyncTree(e),assertSlow&&this.auditChangeIntervals(t,s,this.firstDrawable,this.lastDrawable)}else sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance("pruned");return sceneryLog&&sceneryLog.Instance&&sceneryLog.pop(),!0}localSyncTree(e){const t=this.display._frameId;let s=this.selfDrawable,i=s;assert&&assert(this.firstChangeInterval===null&&this.lastChangeInterval===null,"sanity checks that cleanSyncTreeResults were called");let n=null;e&&(sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.ChangeInterval("self"),sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.push(),n=pt.newForDisplay(null,null,this.display),sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.pop());let a=n,o=e?null:this.selfDrawable;for(let h=0;h<this.children.length;h++){let l=this.children[h];l.syncTree()||(l=this.updateIncompatibleChildInstance(l,h),l.syncTree());const u=l.shouldIncludeInParentDrawables();u&&l.firstDrawable&&(i?Ee.connectDrawables(i,l.firstDrawable,this.display):s=l.firstDrawable,i=l.lastDrawable),sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.ChangeInterval(`changes for ${l.toString()} in ${this.toString()}`),sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.push();const m=l.stitchChangeIncluded,b=u;l.stitchChangeIncluded=b,sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.ChangeInterval(`included: ${m} => ${b}`),l.stitchChangeFrame===t?(sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.ChangeInterval("stitchChangeFrame full change interval"),sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.push(),l.firstChangeInterval=l.lastChangeInterval=pt.newForDisplay(null,null,this.display),sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.pop()):assert&&assert(m===b,"If we do not have stitchChangeFrame activated, our inclusion should not have changed");const y=l.firstChangeInterval;let f=a&&a.drawableAfter===null;const L=y&&y.drawableBefore===null;if(l.stitchChangeBefore===t&&!f&&!L){sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.ChangeInterval("bridge"),sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.push();const S=pt.newForDisplay(o,null,this.display);a&&(a.nextChangeInterval=S),a=S,n=n||a,f=!0,sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.pop()}if((m||b)&&(f?y?y.drawableBefore===null?(a.drawableAfter=y.drawableAfter,a.nextChangeInterval=y.nextChangeInterval,a=l.lastChangeInterval===y?a:l.lastChangeInterval):(a.drawableAfter=l.firstDrawable,a.nextChangeInterval=y,a=l.lastChangeInterval):a.drawableAfter=l.firstDrawable:y&&(n=n||y,y.drawableBefore===null&&(assert&&assert(!a||o,"If we have a current change interval, we should be guaranteed a non-null lastUnchangedDrawable"),y.drawableBefore=o),a&&(a.nextChangeInterval=y),a=l.lastChangeInterval),o=a&&a.drawableAfter===null?null:l.lastDrawable?l.lastDrawable:o),h===this.children.length-1&&l.stitchChangeAfter===t&&!(a&&a.drawableAfter===null)){const S=pt.newForDisplay(o,null,this.display);a&&(a.nextChangeInterval=S),a=S,n=n||a}l.cleanSyncTreeResults(),sceneryLog&&sceneryLog.ChangeInterval&&sceneryLog.pop()}if(assert&&assert(!!n==!!a,"Presence of first and current change intervals should be equal"),!n&&this.stitchChangeOnChildren===this.display._frameId&&this.children.length===0&&(n=a=pt.newForDisplay(null,null,this.display)),this.firstChangeInterval=n,this.lastChangeInterval=a,this.firstDrawable=this.firstInnerDrawable=s,this.lastDrawable=this.lastInnerDrawable=i,assertSlow){let h=null;for(let c=0;c<this.children.length;c++)if(this.children[c].shouldIncludeInParentDrawables()&&this.children[c].firstDrawable){h=this.children[c].firstDrawable;break}this.selfDrawable&&(h=this.selfDrawable);let l=this.selfDrawable;for(let c=this.children.length-1;c>=0;c--)if(this.children[c].shouldIncludeInParentDrawables()&&this.children[c].lastDrawable){l=this.children[c].lastDrawable;break}assertSlow(h===this.firstDrawable),assertSlow(l===this.lastDrawable)}}updateSelfDrawable(){if(this.node.isPainted()){const e=this.selfRenderer;if(!this.selfDrawable||!(this.selfDrawable.renderer&e&p.bitmaskRendererArea))return this.selfDrawable&&(sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`replacing old drawable ${this.selfDrawable.toString()} with new renderer`),this.selfDrawable.markForDisposal(this.display)),this.selfDrawable=p.createSelfDrawable(this,this.node,e,this.fittability.ancestorsFittable),assert&&assert(this.selfDrawable),!0}else assert&&assert(this.selfDrawable===null,"Non-painted nodes should not have a selfDrawable");return!1}updateIncompatibleChildInstance(e,t){if(sceneryLog&&d.isLoggingPerformance()){const i=e.getDescendantCount()+1;i>100?sceneryLog.PerfCritical&&sceneryLog.PerfCritical(`incompatible instance rebuild at ${this.trail.toPathString()}: ${i}`):i>40?sceneryLog.PerfMajor&&sceneryLog.PerfMajor(`incompatible instance rebuild at ${this.trail.toPathString()}: ${i}`):i>0&&sceneryLog.PerfMinor&&sceneryLog.PerfMinor(`incompatible instance rebuild at ${this.trail.toPathString()}: ${i}`)}this.display.markInstanceRootForDisposal(e);const s=$t.createFromPool(this.display,this.trail.copy().addDescendant(e.node,t),!1,!1);return this.replaceInstanceWithIndex(e,s,t),s}groupSyncTree(e){const t=this.groupRenderer;assert&&assert((this.isBackbone?1:0)+(this.isInstanceCanvasCache?1:0)+(this.isSharedCanvasCacheSelf?1:0)==(t?1:0),"We should have precisely one of these flags set for us to have a groupRenderer");const s=!!t!=!!this.groupDrawable||!e&&this.groupChanged||this.groupDrawable&&this.groupDrawable.renderer!==t;s&&(this.groupDrawable&&(sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`replacing group drawable ${this.groupDrawable.toString()}`),this.groupDrawable.markForDisposal(this.display),this.groupDrawable=null),this.firstChangeInterval=this.lastChangeInterval=pt.newForDisplay(null,null,this.display)),t&&(this.firstDrawable&&Ee.disconnectBefore(this.firstDrawable,this.display),this.lastDrawable&&Ee.disconnectAfter(this.lastDrawable,this.display),this.isBackbone?(s&&(this.groupDrawable=bi.createFromPool(this.display,this,this.getTransformRootInstance(),t,this.isDisplayRoot),this.isTransformed&&this.display.markTransformRootDirty(this,!0)),this.firstChangeInterval&&this.groupDrawable.stitch(this.firstDrawable,this.lastDrawable,this.firstChangeInterval,this.lastChangeInterval)):this.isInstanceCanvasCache?(s&&(this.groupDrawable=ju.createFromPool(t,this)),this.firstChangeInterval&&this.groupDrawable.stitch(this.firstDrawable,this.lastDrawable,this.firstChangeInterval,this.lastChangeInterval)):this.isSharedCanvasCacheSelf&&s&&(this.groupDrawable=Gh.createFromPool(t,this)),this.groupDrawable.setFittable(this.fittability.ancestorsFittable),this.firstDrawable=this.lastDrawable=this.groupDrawable),s?this.firstChangeInterval=this.lastChangeInterval=pt.newForDisplay(null,null,this.display):t&&(this.firstChangeInterval=this.lastChangeInterval=null)}sharedSyncTree(){this.ensureSharedCacheInitialized();const e=this.sharedCacheRenderer;(!this.sharedCacheDrawable||this.sharedCacheDrawable.renderer!==e)&&(this.sharedCacheDrawable&&(sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`replacing shared cache drawable ${this.sharedCacheDrawable.toString()}`),this.sharedCacheDrawable.markForDisposal(this.display)),this.sharedCacheDrawable=new qu(this.trail,e,this,this.sharedCacheInstance),this.firstDrawable=this.sharedCacheDrawable,this.lastDrawable=this.sharedCacheDrawable,this.firstChangeInterval=this.lastChangeInterval=pt.newForDisplay(null,null,this.display))}prepareChildInstances(e){for(;this.instanceRemovalCheckList.length;){const t=this.instanceRemovalCheckList.pop();t.addRemoveCounter===-1&&(t.addRemoveCounter=0,this.display.markInstanceRootForDisposal(t))}if(e)for(let t=0;t<this.node.children.length;t++){const s=this.node.children[t];this.appendInstance($t.createFromPool(this.display,this.trail.copy().addDescendant(s,t),!1,!1))}}ensureSharedCacheInitialized(){if(!this.sharedCacheInstance){const e=this.node.getId();this.sharedCacheInstance=this.display._sharedCanvasInstances[e],this.sharedCacheInstance||(this.sharedCacheInstance=$t.createFromPool(this.display,new R(this.node),!1,!0),this.sharedCacheInstance.syncTree(),this.display._sharedCanvasInstances[e]=this.sharedCacheInstance,this.display.markTransformRootDirty(this.sharedCacheInstance,!0)),this.sharedCacheInstance.externalReferenceCount++,this.isTransformed&&this.display.markTransformRootDirty(this,!0)}}shouldIncludeInParentDrawables(){return this.node.isVisible()||!this.node.isExcludeInvisible()}findPreviousDrawable(e){for(let t=e-1;t>=0;t--){const s=this.children[t].lastDrawable;if(s!==null)return s}return null}findNextDrawable(e){const t=this.children.length;for(let s=e+1;s<t;s++){const i=this.children[s].firstDrawable;if(i!==null)return i}return null}appendInstance(e){this.insertInstance(e,this.children.length)}insertInstance(e,t){assert&&assert(e instanceof $t),assert&&assert(t>=0&&t<=this.children.length,`Instance insertion bounds check for index ${t} with previous children length ${this.children.length}`),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.InstanceTree(`inserting ${e.toString()} into ${this.toString()}`),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.push(),e.stitchChangeFrame=this.display._frameId,this.stitchChangeOnChildren=this.display._frameId,this.children.splice(t,0,e),e.parent=this,e.oldParent=this,t<=this.beforeStableIndex&&(this.beforeStableIndex=t-1),t>this.afterStableIndex?this.afterStableIndex=t+1:this.afterStableIndex++,this.fittability.onInsert(e.fittability),this.relativeTransform.addInstance(e),this.markChildVisibilityDirty(),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.pop()}removeInstance(e){this.removeInstanceWithIndex(e,_.indexOf(this.children,e))}removeInstanceWithIndex(e,t){assert&&assert(e instanceof $t),assert&&assert(t>=0&&t<this.children.length,`Instance removal bounds check for index ${t} with previous children length ${this.children.length}`),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.InstanceTree(`removing ${e.toString()} from ${this.toString()}`),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.push();const s=this.display._frameId;e.stitchChangeFrame=s,this.stitchChangeOnChildren=s,t-1>=0&&(this.children[t-1].stitchChangeAfter=s),t+1<this.children.length&&(this.children[t+1].stitchChangeBefore=s),this.children.splice(t,1),e.parent=null,e.oldParent=this,t<=this.beforeStableIndex&&(this.beforeStableIndex=t-1),t>=this.afterStableIndex?this.afterStableIndex=t:this.afterStableIndex--,this.fittability.onRemove(e.fittability),this.relativeTransform.removeInstance(e),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.pop()}replaceInstanceWithIndex(e,t,s){this.removeInstanceWithIndex(e,s),this.insertInstance(t,s)}reorderInstances(e,t){assert&&assert(typeof e=="number"),assert&&assert(typeof t=="number"),assert&&assert(e<=t),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.InstanceTree(`Reordering ${this.toString()}`),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.push();const s=this.display._frameId;this.children.splice(e,t-e+1);for(let i=e;i<=t;i++){const n=this.findChildInstanceOnNode(this.node._children[i]);this.children.splice(i,0,n),n.stitchChangeFrame=s,i>e&&(n.stitchChangeAfter=s),i<t&&(n.stitchChangeBefore=s)}this.stitchChangeOnChildren=s,this.beforeStableIndex=Math.min(this.beforeStableIndex,e-1),this.afterStableIndex=Math.max(this.afterStableIndex,t+1),sceneryLog&&sceneryLog.InstanceTree&&sceneryLog.pop()}findChildInstanceOnNode(e){const t=e.getInstances();for(let s=0;s<t.length;s++)if(t[s].oldParent===this)return t[s];return null}onChildInserted(e,t){sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`inserting child node ${e.constructor.name}#${e.id} into ${this.toString()}`),sceneryLog&&sceneryLog.Instance&&sceneryLog.push(),assert&&assert(!this.stateless,"If we are stateless, we should not receive these notifications");let s=this.findChildInstanceOnNode(e);s?(sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance("instance already exists"),s.addRemoveCounter+=1,assert&&assert(s.addRemoveCounter===0)):(sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance("creating stub instance"),sceneryLog&&sceneryLog.Instance&&sceneryLog.push(),s=$t.createFromPool(this.display,this.trail.copy().addDescendant(e,t),!1,!1),sceneryLog&&sceneryLog.Instance&&sceneryLog.pop()),this.insertInstance(s,t),this.markSkipPruning(),sceneryLog&&sceneryLog.Instance&&sceneryLog.pop()}onChildRemoved(e,t){sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`removing child node ${e.constructor.name}#${e.id} from ${this.toString()}`),sceneryLog&&sceneryLog.Instance&&sceneryLog.push(),assert&&assert(!this.stateless,"If we are stateless, we should not receive these notifications"),assert&&assert(this.children[t].node===e,"Ensure that our instance matches up");const s=this.findChildInstanceOnNode(e);assert&&assert(s!==null,"We should always have a reference to a removed instance"),s.addRemoveCounter-=1,assert&&assert(s.addRemoveCounter===-1),this.instanceRemovalCheckList.push(s),this.removeInstanceWithIndex(s,t),this.markSkipPruning(),sceneryLog&&sceneryLog.Instance&&sceneryLog.pop()}onChildrenReordered(e,t){sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`reordering children for ${this.toString()}`),sceneryLog&&sceneryLog.Instance&&sceneryLog.push(),this.reorderInstances(e,t),this.markSkipPruning(),sceneryLog&&sceneryLog.Instance&&sceneryLog.pop()}onVisibilityChange(){assert&&assert(!this.stateless,"If we are stateless, we should not receive these notifications"),this.stitchChangeFrame=this.display._frameId,this.parent&&this.parent.markSkipPruning(),this.visibilityDirty=!0,this.parent&&this.parent.markChildVisibilityDirty()}onOpacityChange(){assert&&assert(!this.stateless,"If we are stateless, we should not receive these notifications"),this.markRenderStateDirty()}markChildVisibilityDirty(){this.childVisibilityDirty||(this.childVisibilityDirty=!0,this.parent&&this.parent.markChildVisibilityDirty())}updateDrawableFittability(e){this.selfDrawable&&this.selfDrawable.setFittable(e),this.groupDrawable&&this.groupDrawable.setFittable(e)}updateVisibility(e,t,s,i){this.visibilityDirty&&(i=!0);const n=this.node.isVisible(),a=this.visible,o=this.relativeVisible,h=this.selfVisible,l=this.node.voicingVisibleProperty.value,c=this.voicingVisible,u=a&&c;this.visible=e&&n,this.voicingVisible=t&&l,this.relativeVisible=s&&n,this.selfVisible=this.isVisibilityApplied?!0:this.relativeVisible;const m=this.children.length;for(let y=0;y<m;y++){const f=this.children[y];(i||f.visibilityDirty||f.childVisibilityDirty)&&f.updateVisibility(this.visible,this.voicingVisible,this.isVisibilityApplied?!0:this.relativeVisible,i)}this.visibilityDirty=!1,this.childVisibilityDirty=!1,this.visible!==a&&this.visibleEmitter.emit(),this.relativeVisible!==o&&this.relativeVisibleEmitter.emit(),this.selfVisible!==h&&this.selfVisibleEmitter.emit();const b=this.voicingVisible&&this.visible;b!==u&&this.canVoiceEmitter.emit(b)}getDescendantCount(){let e=this.children.length;for(let t=0;t<this.children.length;t++)e+=this.children[t].getDescendantCount();return e}addSVGGroup(e){this.svgGroups.push(e)}removeSVGGroup(e){Tt(this.svgGroups,e)}lookupSVGGroup(e){const t=this.svgGroups.length;for(let s=0;s<t;s++){const i=this.svgGroups[s];if(i.block===e)return i}return null}getFilterRootInstance(){return this.isBackbone||this.isInstanceCanvasCache||!this.parent?this:this.parent.getFilterRootInstance()}getTransformRootInstance(){return this.isTransformed||!this.parent?this:this.parent.getTransformRootInstance()}getVisibilityRootInstance(){return this.isVisibilityApplied||!this.parent?this:this.parent.getVisibilityRootInstance()}attachNodeListeners(){this.relativeTransform.attachNodeListeners(),this.isSharedCanvasCachePlaceholder||(this.node.childInsertedEmitter.addListener(this.childInsertedListener),this.node.childRemovedEmitter.addListener(this.childRemovedListener),this.node.childrenReorderedEmitter.addListener(this.childrenReorderedListener),this.node.visibleProperty.lazyLink(this.visibilityListener),this.node.voicingVisibleProperty.lazyLink(this.visibilityListener),this.node.filterChangeEmitter.addListener(this.markRenderStateDirtyListener),this.node.clipAreaProperty.lazyLink(this.markRenderStateDirtyListener),this.node.instanceRefreshEmitter.addListener(this.markRenderStateDirtyListener))}detachNodeListeners(){this.relativeTransform.detachNodeListeners(),this.isSharedCanvasCachePlaceholder||(this.node.childInsertedEmitter.removeListener(this.childInsertedListener),this.node.childRemovedEmitter.removeListener(this.childRemovedListener),this.node.childrenReorderedEmitter.removeListener(this.childrenReorderedListener),this.node.visibleProperty.unlink(this.visibilityListener),this.node.voicingVisibleProperty.unlink(this.visibilityListener),this.node.filterChangeEmitter.removeListener(this.markRenderStateDirtyListener),this.node.clipAreaProperty.unlink(this.markRenderStateDirtyListener),this.node.instanceRefreshEmitter.removeListener(this.markRenderStateDirtyListener))}markRenderStateDirty(){this.renderStateDirtyFrame=this.display._frameId,this.parent&&this.parent.markSkipPruning()}markSkipPruning(){this.skipPruningFrame=this.display._frameId,this.parent&&this.parent.markSkipPruning()}getBranchIndexTo(e){const t=this.branchIndexMap[e.id];if(t!==void 0)return t;const s=this.trail.getBranchIndexTo(e.trail);return this.branchIndexMap[e.id]=s,e.branchIndexMap[this.id]=s,this.branchIndexReferences.push(e),e.branchIndexReferences.push(this),s}dispose(){for(sceneryLog&&sceneryLog.Instance&&sceneryLog.Instance(`dispose ${this.toString()}`),sceneryLog&&sceneryLog.Instance&&sceneryLog.push(),assert&&assert(this.active,"Seems like we tried to dispose this Instance twice, it is not active"),this.active=!1;this.branchIndexReferences.length;){const t=this.branchIndexReferences.pop();delete this.branchIndexMap[t.id],delete t.branchIndexMap[this.id],Tt(t.branchIndexReferences,this)}this.groupDrawable&&this.groupDrawable.disposeImmediately(this.display),this.sharedCacheDrawable&&this.sharedCacheDrawable.disposeImmediately(this.display),this.selfDrawable&&this.selfDrawable.disposeImmediately(this.display);const e=this.children.length;for(let t=0;t<e;t++)this.children[t].dispose();for(;this.instanceRemovalCheckList.length;){const t=this.instanceRemovalCheckList.pop();t.active&&t.dispose()}this.stateless||this.detachNodeListeners(),this.node.removeInstance(this),this.sharedCacheInstance&&(this.sharedCacheInstance.externalReferenceCount--,this.sharedCacheInstance.externalReferenceCount===0&&(delete this.display._sharedCanvasInstances[this.node.getId()],this.sharedCacheInstance.dispose())),this.cleanInstance(null,null),this.visibleEmitter.removeAllListeners(),this.relativeVisibleEmitter.removeAllListeners(),this.selfVisibleEmitter.removeAllListeners(),this.canVoiceEmitter.removeAllListeners(),this.freeToPool(),sceneryLog&&sceneryLog.Instance&&sceneryLog.pop()}audit(e,t){if(assertSlow){e===void 0&&(e=this.display._frameId),assertSlow(!this.stateless,"State is required for all display instances"),assertSlow(this.firstDrawable===null==(this.lastDrawable===null),"First/last drawables need to both be null or non-null"),assertSlow(!this.isBackbone&&!this.isSharedCanvasCachePlaceholder||this.groupDrawable,"If we are a backbone or shared cache, we need to have a groupDrawable reference"),assertSlow(!this.isSharedCanvasCachePlaceholder||!this.node.isPainted()||this.selfDrawable,"We need to have a selfDrawable if we are painted and not a shared cache"),assertSlow(!this.isTransformed&&!this.isCanvasCache||this.groupDrawable,"We need to have a groupDrawable if we are a backbone or any type of canvas cache"),assertSlow(!this.isSharedCanvasCachePlaceholder||this.sharedCacheDrawable,"We need to have a sharedCacheDrawable if we are a shared cache"),assertSlow(this.addRemoveCounter===0,"Our addRemoveCounter should always be 0 at the end of syncTree");for(let s=0;s<this.children.length;s++)this.children[s].audit(e,t);this.relativeTransform.audit(e,t),this.fittability.audit()}}auditVisibility(e){if(assertSlow){const t=e&&this.node.isVisible(),s=this.trail.isVisible();assertSlow(t===s,"Trail visibility failure"),assertSlow(t===this.visible,"Visible flag failure"),assertSlow(this.voicingVisible===_.reduce(this.trail.nodes,(i,n)=>i&&n.voicingVisibleProperty.value,!0),"When this Instance is voicingVisible: true, all Trail Nodes must also be voicingVisible: true");for(let i=0;i<this.children.length;i++)this.children[i].auditVisibility(t)}}auditChangeIntervals(e,t,s,i){if(e){let a=e;for(;a!==t;)a=a.oldNextDrawable}if(s){let a=s;for(;a!==i;)a=a.nextDrawable}function n(a,o){if(assertSlow)for(assertSlow(a!==null),assertSlow(o!==null);a!==o;)assertSlow(a.nextDrawable===a.oldNextDrawable,"Change interval mismatch"),a=a.nextDrawable}if(assertSlow){const a=this.firstChangeInterval,o=this.lastChangeInterval;if((!a||a.drawableBefore!==null)&&assertSlow(e===s,"If we have no changes, or our first change interval is not open, our firsts should be the same"),(!o||o.drawableAfter!==null)&&assertSlow(t===i,"If we have no changes, or our last change interval is not open, our lasts should be the same"),!a)assertSlow(!o,"We should not be missing only one change interval"),e&&n(e,t);else{assertSlow(o,"We should not be missing only one change interval"),a.drawableBefore!==null&&n(e,a.drawableBefore),o.drawableAfter!==null&&n(o.drawableAfter,t);let h=a;for(;h&&h.nextChangeInterval;){const l=h.nextChangeInterval;assertSlow(h.drawableAfter!==null),assertSlow(l.drawableBefore!==null),n(h.drawableAfter,l.drawableBefore),h=l}}}}toString(){return`${this.id}#${this.node?`${this.node.constructor.name?this.node.constructor.name:"?"}#${this.node.id}`:"-"}`}}d.register("Instance",$t);ae.mixInto($t);const Ky=$t;class op{constructor(e){this.display=e;const t=document.createElementNS(ne,"svg");this.domElement=t,t.style.position="absolute",t.setAttribute("class","safari-workaround"),t.style.top="0",t.style.left="0",t.style["pointer-events"]="none",e.sizeProperty.link(s=>{t.setAttribute("width",""+s.width),t.setAttribute("height",""+s.height),t.style.clip=`rect(0px,${s.width}px,${s.height}px,0px)`}),this.rect=document.createElementNS(ne,"rect"),t.appendChild(this.rect),this.update()}update(){const e=gn.nextDouble();this.rect.setAttribute("x",""+e),this.rect.setAttribute("y",""+e),this.rect.setAttribute("style","fill: rgba(255,200,100,0); stroke: none;"),this.display.width&&this.rect.setAttribute("width",""+(this.display.width-e*2)),this.display.height&&this.rect.setAttribute("height",""+(this.display.height-e*2))}}d.register("SafariWorkaroundOverlay",op);const Xy={"scenery-grab-pointer":["grab","-moz-grab","-webkit-grab","pointer"],"scenery-grabbing-pointer":["grabbing","-moz-grabbing","-webkit-grabbing","pointer"]};let jy=1;const ut=class ut{constructor(e,t){this._refreshSVGEmitter=new He,this._refreshSVGPending=!1,assert&&assert(e,"rootNode is a required parameter");const s=E()({width:t&&t.container&&t.container.clientWidth||640,height:t&&t.container&&t.container.clientHeight||480,allowCSSHacks:!0,allowSafariRedrawWorkaround:!1,allowSceneOverflow:!1,allowLayerFitting:!1,forceSVGRefresh:!1,defaultCursor:"default",backgroundColor:null,preserveDrawingBuffer:!1,allowWebGL:!0,accessibility:!0,supportsInteractiveHighlights:!1,interactive:!0,listenToOnlyElement:!1,batchDOMEvents:!1,assumeFullWindow:!1,aggressiveContextRecreation:!0,passiveEvents:Te.safari?!1:null,allowBackingScaleAntialiasing:!0},t);this.id=jy++,this._accessible=s.accessibility,this._preserveDrawingBuffer=s.preserveDrawingBuffer,this._allowWebGL=s.allowWebGL,this._allowCSSHacks=s.allowCSSHacks,this._allowSceneOverflow=s.allowSceneOverflow,this._defaultCursor=s.defaultCursor,this.sizeProperty=new X(new Mt(s.width,s.height)),this._currentSize=new Mt(-1,-1),this._rootNode=e,this._rootNode.addRootedDisplay(this),this._rootBackbone=null,this._domElement=s.container?bi.repurposeBackboneContainer(s.container):bi.createDivBackbone(),this._sharedCanvasInstances={},this._baseInstance=null,this._frameId=0,this._dirtyTransformRoots=[],this._dirtyTransformRootsWithoutPass=[],this._instanceRootsToDispose=[],this._reduceReferencesNeeded=[],this._drawablesToDispose=[],this._drawablesToChangeBlock=[],this._drawablesToUpdateLinks=[],this._changeIntervalsToDispose=[],this._lastCursor=null,this._currentBackgroundCSS=null,this._backgroundColor=null,this._requestAnimationFrameID=0,this._input=null,this._inputListeners=[],this._interactive=s.interactive,this._listenToOnlyElement=s.listenToOnlyElement,this._batchDOMEvents=s.batchDOMEvents,this._assumeFullWindow=s.assumeFullWindow,this._passiveEvents=s.passiveEvents,this._aggressiveContextRecreation=s.aggressiveContextRecreation,this._allowBackingScaleAntialiasing=s.allowBackingScaleAntialiasing,this._allowLayerFitting=s.allowLayerFitting,this._forceSVGRefresh=s.forceSVGRefresh,this._overlays=[],this._pointerOverlay=null,this._pointerAreaOverlay=null,this._hitAreaOverlay=null,this._canvasAreaBoundsOverlay=null,this._fittedBlockBoundsOverlay=null,assert&&(this._isPainting=!1,this._isDisposing=!1,this._isDisposed=!1),this.applyCSSHacks(),this.setBackgroundColor(s.backgroundColor);const i=new cu;if(this.descriptionUtteranceQueue=new uu(i,{initialize:this._accessible,featureSpecificAnnouncingControlPropertyName:"descriptionCanAnnounceProperty"}),Te.safari&&s.allowSafariRedrawWorkaround&&this.addOverlay(new op(this)),this.focusManager=new oe,(this._accessible||s.supportsInteractiveHighlights)&&(this._focusRootNode=new D,this._focusOverlay=new tt(this,this._focusRootNode,{pdomFocusHighlightsVisibleProperty:this.focusManager.pdomFocusHighlightsVisibleProperty,interactiveHighlightsVisibleProperty:this.focusManager.interactiveHighlightsVisibleProperty,readingBlockHighlightsVisibleProperty:this.focusManager.readingBlockHighlightsVisibleProperty}),this.addOverlay(this._focusOverlay)),this._accessible){this._rootPDOMInstance=Ft.pool.create(null,this,new R),sceneryLog&&sceneryLog.PDOMInstance&&sceneryLog.PDOMInstance(`Display root instance: ${this._rootPDOMInstance.toString()}`),St.rebuildInstanceTree(this._rootPDOMInstance),assert&&assert(this._rootPDOMInstance.peer,"Peer should be created from createFromPool"),this._domElement.appendChild(this._rootPDOMInstance.peer.primarySibling);const n=i.ariaLiveContainer;this._domElement.appendChild(n),n.style[A.userSelect]="none",this._boundHandleFullScreenNavigation=this.handleFullScreenNavigation.bind(this),ze.keydownEmitter.addListener(this._boundHandleFullScreenNavigation)}}getDOMElement(){return this._domElement}get domElement(){return this.getDOMElement()}updateDisplay(){sceneryLog&&d.isLoggingPerformance()&&(this.perfSyncTreeCount=0,this.perfStitchCount=0,this.perfIntervalCount=0,this.perfDrawableBlockChangeCount=0,this.perfDrawableOldIntervalCount=0,this.perfDrawableNewIntervalCount=0),assert&&ut.assertSubtreeDisposed(this._rootNode),sceneryLog&&sceneryLog.Display&&sceneryLog.Display(`updateDisplay frame ${this._frameId}`),sceneryLog&&sceneryLog.Display&&sceneryLog.push();const e=!!this._baseInstance;for(this._input&&this._input.validatePointers(),this._accessible&&this._rootPDOMInstance.peer.updateSubtreePositioning(),this._rootNode.validateWatchedBounds(),assertSlow&&this._accessible&&this._rootPDOMInstance.auditRoot(),assertSlow&&this._rootNode._picker.audit(),this._baseInstance=this._baseInstance||Ky.createFromPool(this,new R(this._rootNode),!0,!1),this._baseInstance.baseSyncTree(),e&&this.markTransformRootDirty(this._baseInstance,this._baseInstance.isTransformed);this._drawablesToUpdateLinks.length;)this._drawablesToUpdateLinks.pop().updateLinks();for(;this._changeIntervalsToDispose.length;)this._changeIntervalsToDispose.pop().dispose();for(this._rootBackbone=this._rootBackbone||this._baseInstance.groupDrawable,assert&&assert(this._rootBackbone,"We are guaranteed a root backbone as the groupDrawable on the base instance"),assert&&assert(this._rootBackbone===this._baseInstance.groupDrawable,"We don't want the base instance's groupDrawable to change"),assertSlow&&this._rootBackbone.audit(!0,!1,!0),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("drawable block change phase"),sceneryLog&&sceneryLog.Display&&sceneryLog.push();this._drawablesToChangeBlock.length;){const t=this._drawablesToChangeBlock.pop().updateBlock();sceneryLog&&d.isLoggingPerformance()&&t&&this.perfDrawableBlockChangeCount++}for(sceneryLog&&sceneryLog.Display&&sceneryLog.pop(),assertSlow&&this._rootBackbone.audit(!1,!1,!0),assertSlow&&this._baseInstance.audit(this._frameId,!1),this.updateDirtyTransformRoots(),this._baseInstance.updateVisibility(!0,!0,!0,!1),assertSlow&&this._baseInstance.auditVisibility(!0),assertSlow&&this._baseInstance.audit(this._frameId,!0),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("instance root disposal phase"),sceneryLog&&sceneryLog.Display&&sceneryLog.push();this._instanceRootsToDispose.length;)this._instanceRootsToDispose.pop().dispose();for(sceneryLog&&sceneryLog.Display&&sceneryLog.pop(),assertSlow&&this._rootNode.auditInstanceSubtreeForDisplay(this),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("drawable disposal phase"),sceneryLog&&sceneryLog.Display&&sceneryLog.push();this._drawablesToDispose.length;)this._drawablesToDispose.pop().dispose();if(sceneryLog&&sceneryLog.Display&&sceneryLog.pop(),assertSlow&&this._baseInstance.audit(this._frameId,!1),assert&&(assert(!this._isPainting,"Display was already updating paint, may have thrown an error on the last update"),this._isPainting=!0),sceneryLog&&sceneryLog.Display&&sceneryLog.Display("repaint phase"),sceneryLog&&sceneryLog.Display&&sceneryLog.push(),this._rootBackbone.update(),sceneryLog&&sceneryLog.Display&&sceneryLog.pop(),assert&&(this._isPainting=!1),assertSlow&&this._rootBackbone.audit(!1,!1,!1),assertSlow&&this._baseInstance.audit(this._frameId,!1),this.updateCursor(),this.updateBackgroundColor(),this.updateSize(),this._overlays.length){let t=this._rootBackbone.lastZIndex;for(let s=0;s<this._overlays.length;s++){const i=this._overlays[s];i.domElement.style.zIndex=""+t++,i.update()}}for(;this._reduceReferencesNeeded.length;)this._reduceReferencesNeeded.pop().reduceReferences();if(this._frameId++,sceneryLog&&d.isLoggingPerformance()){const t=`syncTree count: ${this.perfSyncTreeCount}`;this.perfSyncTreeCount>500?sceneryLog.PerfCritical&&sceneryLog.PerfCritical(t):this.perfSyncTreeCount>100?sceneryLog.PerfMajor&&sceneryLog.PerfMajor(t):this.perfSyncTreeCount>20?sceneryLog.PerfMinor&&sceneryLog.PerfMinor(t):this.perfSyncTreeCount>0&&sceneryLog.PerfVerbose&&sceneryLog.PerfVerbose(t);const s=`drawable block changes: ${this.perfDrawableBlockChangeCount} for -${this.perfDrawableOldIntervalCount} +${this.perfDrawableNewIntervalCount}`;this.perfDrawableBlockChangeCount>200?sceneryLog.PerfCritical&&sceneryLog.PerfCritical(s):this.perfDrawableBlockChangeCount>60?sceneryLog.PerfMajor&&sceneryLog.PerfMajor(s):this.perfDrawableBlockChangeCount>10?sceneryLog.PerfMinor&&sceneryLog.PerfMinor(s):this.perfDrawableBlockChangeCount>0&&sceneryLog.PerfVerbose&&sceneryLog.PerfVerbose(s)}St.auditPDOMDisplays(this.rootNode),(this._forceSVGRefresh||this._refreshSVGPending)&&(this._refreshSVGPending=!1,this.refreshSVG()),sceneryLog&&sceneryLog.Display&&sceneryLog.pop()}getPhetioElementAt(e){const t=this._rootNode.getPhetioMouseHit(e);return t==="phetioNotSelectable"?null:(t&&assert&&assert(t.isPhetioInstrumented(),"a PhetioMouseHit should be instrumented"),t)}updateSize(){let e=!1;this.size.width!==this._currentSize.width&&(e=!0,this._currentSize.width=this.size.width,this._domElement.style.width=`${this.size.width}px`),this.size.height!==this._currentSize.height&&(e=!0,this._currentSize.height=this.size.height,this._domElement.style.height=`${this.size.height}px`),e&&!this._allowSceneOverflow&&(this._domElement.style.clip=`rect(0px,${this.size.width}px,${this.size.height}px,0px)`)}isWebGLAllowed(){return this._allowWebGL}get webglAllowed(){return this.isWebGLAllowed()}getRootNode(){return this._rootNode}get rootNode(){return this.getRootNode()}getRootBackbone(){return assert&&assert(this._rootBackbone),this._rootBackbone}get rootBackbone(){return this.getRootBackbone()}getSize(){return this.sizeProperty.value}get size(){return this.getSize()}getBounds(){return this.size.toBounds()}get bounds(){return this.getBounds()}setSize(e){assert&&assert(e.width%1===0,"Display.width should be an integer"),assert&&assert(e.width>0,"Display.width should be greater than zero"),assert&&assert(e.height%1===0,"Display.height should be an integer"),assert&&assert(e.height>0,"Display.height should be greater than zero"),this.sizeProperty.value=e}setWidthHeight(e,t){this.setSize(new Mt(e,t))}getWidth(){return this.size.width}get width(){return this.getWidth()}set width(e){this.setWidth(e)}setWidth(e){return this.getWidth()!==e&&this.setSize(new Mt(e,this.getHeight())),this}getHeight(){return this.size.height}get height(){return this.getHeight()}set height(e){this.setHeight(e)}setHeight(e){return this.getHeight()!==e&&this.setSize(new Mt(this.getWidth(),e)),this}setBackgroundColor(e){return assert&&assert(e===null||typeof e=="string"||e instanceof P),this._backgroundColor=e,this}set backgroundColor(e){this.setBackgroundColor(e)}get backgroundColor(){return this.getBackgroundColor()}getBackgroundColor(){return this._backgroundColor}get interactive(){return this._interactive}set interactive(e){this._accessible&&e!==this._interactive&&this._rootPDOMInstance.peer.recursiveDisable(!e),this._interactive=e,!this._interactive&&this._input&&(this._input.interruptPointers(),this._input.clearBatchedEvents(),this._input.removeTemporaryPointers(),this._rootNode.interruptSubtreeInput(),this.interruptInput())}addOverlay(e){this._overlays.push(e),this._domElement.appendChild(e.domElement),e.domElement.setAttribute("aria-hidden","true")}removeOverlay(e){this._domElement.removeChild(e.domElement),this._overlays.splice(_.indexOf(this._overlays,e),1)}getPDOMRootElement(){return this._accessible?this._rootPDOMInstance.peer.primarySibling:null}get pdomRootElement(){return this.getPDOMRootElement()}isAccessible(){return this._accessible}isElementUnderPDOM(e){return this._accessible&&this.pdomRootElement.contains(e)}handleFullScreenNavigation(e){if(assert&&assert(this.pdomRootElement,"There must be a PDOM to support keyboard navigation"),Fp.isFullScreen()&&g.isKeyEvent(e,g.KEY_TAB)){const t=this.pdomRootElement;(e.shiftKey?N.getPreviousFocusable(t||void 0):N.getNextFocusable(t||void 0))===e.target&&e.preventDefault()}}getUsedRenderersBitmask(){function e(t){let s=0;return _.each(t.blocks,i=>{i instanceof ep&&i.domDrawable instanceof bi?s=s|e(i.domDrawable):s=s|i.renderer}),s}return e(this._rootBackbone)&p.bitmaskRendererArea}markTransformRootDirty(e,t){t?this._dirtyTransformRoots.push(e):this._dirtyTransformRootsWithoutPass.push(e)}updateDirtyTransformRoots(){for(sceneryLog&&sceneryLog.transformSystem&&sceneryLog.transformSystem("updateDirtyTransformRoots"),sceneryLog&&sceneryLog.transformSystem&&sceneryLog.push();this._dirtyTransformRoots.length;)this._dirtyTransformRoots.pop().relativeTransform.updateTransformListenersAndCompute(!1,!1,this._frameId,!0);for(;this._dirtyTransformRootsWithoutPass.length;)this._dirtyTransformRootsWithoutPass.pop().relativeTransform.updateTransformListenersAndCompute(!1,!1,this._frameId,!1);sceneryLog&&sceneryLog.transformSystem&&sceneryLog.pop()}markDrawableChangedBlock(e){sceneryLog&&sceneryLog.Display&&sceneryLog.Display(`markDrawableChangedBlock: ${e.toString()}`),this._drawablesToChangeBlock.push(e)}markForReducedReferences(e){assert&&assert(!!e.reduceReferences),this._reduceReferencesNeeded.push(e)}markInstanceRootForDisposal(e){sceneryLog&&sceneryLog.Display&&sceneryLog.Display(`markInstanceRootForDisposal: ${e.toString()}`),this._instanceRootsToDispose.push(e)}markDrawableForDisposal(e){sceneryLog&&sceneryLog.Display&&sceneryLog.Display(`markDrawableForDisposal: ${e.toString()}`),this._drawablesToDispose.push(e)}markDrawableForLinksUpdate(e){this._drawablesToUpdateLinks.push(e)}markChangeIntervalToDispose(e){this._changeIntervalsToDispose.push(e)}updateBackgroundColor(){assert&&assert(this._backgroundColor===null||typeof this._backgroundColor=="string"||this._backgroundColor instanceof P);const e=this._backgroundColor===null?"":this._backgroundColor.toCSS?this._backgroundColor.toCSS():this._backgroundColor;e!==this._currentBackgroundCSS&&(this._currentBackgroundCSS=e,this._domElement.style.backgroundColor=e)}updateCursor(){if(this._input&&this._input.mouse&&this._input.mouse.point){if(this._input.mouse.cursor){sceneryLog&&sceneryLog.Cursor&&sceneryLog.Cursor(`set on pointer: ${this._input.mouse.cursor}`),this.setSceneCursor(this._input.mouse.cursor);return}const e=this._rootNode.trailUnderPointer(this._input.mouse);if(e)for(let t=e.getCursorCheckIndex();t>=0;t--){const s=e.nodes[t],i=s.getEffectiveCursor();if(i){sceneryLog&&sceneryLog.Cursor&&sceneryLog.Cursor(`${i} on ${s.constructor.name}#${s.id}`),this.setSceneCursor(i);return}}sceneryLog&&sceneryLog.Cursor&&sceneryLog.Cursor(`--- for ${e?e.toString():"(no hit)"}`)}this.setSceneCursor(this._defaultCursor)}setElementCursor(e){this._domElement.style.cursor=e,this._assumeFullWindow&&(document.body.style.cursor=e)}setSceneCursor(e){if(e!==this._lastCursor){this._lastCursor=e;const t=Xy[e];if(t)for(let s=t.length-1;s>=0;s--)this.setElementCursor(t[s]);else this.setElementCursor(e)}}applyCSSHacks(){this._allowSceneOverflow||(this._domElement.style.overflow="hidden"),this._domElement.style.msTouchAction="none",A.setStyle(this._domElement,A.fontSmoothing,"antialiased"),this._allowCSSHacks&&(document.onselectstart=()=>!1,document.body.style.msContentZooming="none",A.setStyle(this._domElement,A.userDrag,"none"),A.setStyle(this._domElement,A.userSelect,"none"),A.setStyle(this._domElement,A.touchAction,"none"),A.setStyle(this._domElement,A.touchCallout,"none"),A.setStyle(this._domElement,A.tapHighlightColor,"rgba(0,0,0,0)"))}canvasDataURL(e){this.canvasSnapshot(t=>{e(t.toDataURL())})}canvasSnapshot(e){const t=document.createElement("canvas");t.width=this.size.width,t.height=this.size.height;const s=t.getContext("2d");this._rootNode.renderToCanvas(t,s,()=>{e(t,s.getImageData(0,0,t.width,t.height))},this.domElement.style.backgroundColor)}setPointerDisplayVisible(e){const t=!!this._pointerOverlay;e!==t&&(e?(this._pointerOverlay=new ap(this,this._rootNode),this.addOverlay(this._pointerOverlay)):(this.removeOverlay(this._pointerOverlay),this._pointerOverlay.dispose(),this._pointerOverlay=null))}setPointerAreaDisplayVisible(e){const t=!!this._pointerAreaOverlay;e!==t&&(e?(this._pointerAreaOverlay=new rp(this,this._rootNode),this.addOverlay(this._pointerAreaOverlay)):(this.removeOverlay(this._pointerAreaOverlay),this._pointerAreaOverlay.dispose(),this._pointerAreaOverlay=null))}setHitAreaDisplayVisible(e){const t=!!this._hitAreaOverlay;e!==t&&(e?(this._hitAreaOverlay=new js(this,this._rootNode),this.addOverlay(this._hitAreaOverlay)):(this.removeOverlay(this._hitAreaOverlay),this._hitAreaOverlay.dispose(),this._hitAreaOverlay=null))}setCanvasNodeBoundsVisible(e){const t=!!this._canvasAreaBoundsOverlay;e!==t&&(e?(this._canvasAreaBoundsOverlay=new ip(this,this._rootNode),this.addOverlay(this._canvasAreaBoundsOverlay)):(this.removeOverlay(this._canvasAreaBoundsOverlay),this._canvasAreaBoundsOverlay.dispose(),this._canvasAreaBoundsOverlay=null))}setFittedBlockBoundsVisible(e){const t=!!this._fittedBlockBoundsOverlay;e!==t&&(e?(this._fittedBlockBoundsOverlay=new np(this,this._rootNode),this.addOverlay(this._fittedBlockBoundsOverlay)):(this.removeOverlay(this._fittedBlockBoundsOverlay),this._fittedBlockBoundsOverlay.dispose(),this._fittedBlockBoundsOverlay=null))}resizeOnWindowResize(){const e=()=>{this.setWidthHeight(window.innerWidth,window.innerHeight)};window.addEventListener("resize",e),e()}updateOnRequestAnimationFrame(e){let t=0,s=0;const i=this;(function n(){i._requestAnimationFrameID=window.requestAnimationFrame(n,i._domElement);const a=Date.now();t!==0&&(s=(a-t)/1e3),t=a,Oe.emit(s),e&&e(s),i.updateDisplay()})()}cancelUpdateOnRequestAnimationFrame(){window.cancelAnimationFrame(this._requestAnimationFrameID)}initializeEvents(e){assert&&assert(!this._input,"Events cannot be attached twice to a display (for now)");const t=new us(this,!this._listenToOnlyElement,this._batchDOMEvents,this._assumeFullWindow,this._passiveEvents,e);this._input=t,t.connectListeners()}detachEvents(){assert&&assert(this._input,"detachEvents() should be called only when events are attached"),this._input.disconnectListeners(),this._input=null}addInputListener(e){return assert&&assert(!_.includes(this._inputListeners,e),"Input listener already registered on this Display"),_.includes(this._inputListeners,e)||this._inputListeners.push(e),this}removeInputListener(e){return assert&&assert(_.includes(this._inputListeners,e)),this._inputListeners.splice(_.indexOf(this._inputListeners,e),1),this}hasInputListener(e){for(let t=0;t<this._inputListeners.length;t++)if(this._inputListeners[t]===e)return!0;return!1}getInputListeners(){return this._inputListeners.slice(0)}get inputListeners(){return this.getInputListeners()}interruptInput(){const e=this.inputListeners;for(let t=0;t<e.length;t++){const s=e[t];s.interrupt&&s.interrupt()}return this}interruptPointers(){return this._input&&this._input.interruptPointers(),this}interruptOtherPointers(e=null){var t;return this._input&&this._input.interruptPointers(e||((t=this._input.currentSceneryEvent)==null?void 0:t.pointer)||null),this}ensureNotPainting(){assert&&assert(!this._isPainting,"This should not be run in the call tree of updateDisplay(). If you see this, it is likely that either the last updateDisplay() had a thrown error and it is trying to be run again (in which case, investigate that error), OR code was run/triggered from inside an updateDisplay() that has the potential to cause an infinite loop, e.g. CanvasNode paintCanvas() call manipulating another Node, or a bounds listener that Scenery missed.")}loseWebGLContexts(){(function e(t){t.blocks&&t.blocks.forEach(s=>{const i=s.gl;i&&Y.loseContext(i);for(let n=s.firstDrawable;n!==null&&(e(n),n!==s.lastDrawable);n=n.nextDrawable);})})(this._rootBackbone)}inspect(){localStorage.scenerySnapshot=JSON.stringify(ke(this))}getDebugHTML(){const e="font-weight: bold; font-size: 120%; margin-top: 5px;";let t=0,s="";s+=`<div style="${e}">Display (${this.id}) Summary</div>`,s+=`${this.size.toString()} frame:${this._frameId} input:${!!this._input} cursor:${this._lastCursor}<br/>`;function i(f){let L=1;for(let v=0;v<f.children.length;v++)L+=i(f.children[v]);return L}s+=`Nodes: ${i(this._rootNode)}<br/>`;function n(f){let L=1;for(let v=0;v<f.children.length;v++)L+=n(f.children[v]);return L}s+=this._baseInstance?`Instances: ${n(this._baseInstance)}<br/>`:"";function a(f){let L=1;if(f.blocks)_.each(f.blocks,v=>{L+=a(v)});else if(f.firstDrawable&&f.lastDrawable){for(let v=f.firstDrawable;v!==f.lastDrawable;v=v.nextDrawable)L+=a(v);L+=a(f.lastDrawable)}return L}s+=this._rootBackbone?`Drawables: ${a(this._rootBackbone)}<br/>`:"";const o={};function h(f){const L=f.constructor.name;o[L]?o[L]++:o[L]=1}function l(f){let L=0;f.selfDrawable&&(h(f.selfDrawable),L++),f.groupDrawable&&(h(f.groupDrawable),L++),f.sharedCacheDrawable&&(h(f.sharedCacheDrawable),L++);for(let v=0;v<f.children.length;v++)L+=l(f.children[v]);return L}s+=this._baseInstance?`Retained Drawables: ${l(this._baseInstance)}<br/>`:"";for(const f in o)s+=`&nbsp;&nbsp;&nbsp;&nbsp;${f}: ${o[f]}<br/>`;function c(f){if(!f.firstDrawable||!f.lastDrawable)return"";const L=f.domDrawable&&f.domDrawable.blocks;let v=`<div style="margin-left: ${t*20}px">`;if(v+=f.toString(),L||(v+=` (${f.drawableCount} drawables)`),v+="</div>",t+=1,L)for(let S=0;S<f.domDrawable.blocks.length;S++)v+=c(f.domDrawable.blocks[S]);return t-=1,v}if(this._rootBackbone){s+=`<div style="${e}">Block Summary</div>`;for(let f=0;f<this._rootBackbone.blocks.length;f++)s+=c(this._rootBackbone.blocks[f])}function u(f){let L="";function v(ce){L+=` <span style="color: #008">${ce}</span>`}const S=f.node;L+=f.id,L+=` ${S.constructor.name?S.constructor.name:"?"}`,L+=` <span style="font-weight: ${S.isPainted()?"bold":"normal"}">${S.id}</span>`,L+=S.getDebugHTMLExtras(),S.visible||v("invis"),f.visible||v("I-invis"),f.relativeVisible||v("I-rel-invis"),f.selfVisible||v("I-self-invis"),f.fittability.ancestorsFittable||v("nofit-ancestor"),f.fittability.selfFittable||v("nofit-self"),S.pickable===!0&&v("pickable"),S.pickable===!1&&v("unpickable"),f.trail.isPickable()&&v('<span style="color: #808">hits</span>'),S.getEffectiveCursor()&&v(`effectiveCursor:${S.getEffectiveCursor()}`),S.clipArea&&v("clipArea"),S.mouseArea&&v("mouseArea"),S.touchArea&&v("touchArea"),S.getInputListeners().length&&v("inputListeners"),S.getRenderer()&&v(`renderer:${S.getRenderer()}`),S.isLayerSplit()&&v("layerSplit"),S.opacity<1&&v(`opacity:${S.opacity}`),S.disabledOpacity<1&&v(`disabledOpacity:${S.disabledOpacity}`),S._boundsEventCount>0&&v(`<span style="color: #800">boundsListen:${S._boundsEventCount}:${S._boundsEventSelfCount}</span>`);let B="";switch(S.transform.getMatrix().type){case zi.IDENTITY:B="";break;case zi.TRANSLATION_2D:B="translated";break;case zi.SCALING:B="scale";break;case zi.AFFINE:B="affine";break;case zi.OTHER:B="other";break;default:throw new Error(`invalid matrix type: ${S.transform.getMatrix().type}`)}return B&&(L+=` <span style="color: #88f" title="${S.transform.getMatrix().toString().replace(`
`,"&#10;")}">${B}</span>`),L+=` <span style="color: #888">[Trail ${f.trail.indices.join(".")}]</span>`,L+=` <span style="color: #8c8">${S._rendererSummary.bitmask.toString(16)}${S._rendererBitmask!==p.bitmaskNodeDefault?` (${S._rendererBitmask.toString(16)})`:""}</span>`,L}function m(f){let L=f.toString();return f.visible&&(L=`<strong>${L}</strong>`),f.dirty&&(L+=f.dirty?' <span style="color: #c00;">[x]</span>':""),f.fittable||(L+=f.dirty?' <span style="color: #0c0;">[no-fit]</span>':""),L}function b(f){let L=`<div style="margin-left: ${t*20}px">`;function v(S,B){L+=` <span style="color: #888">${S}:${m(B)}</span>`}L+=u(f),f.selfDrawable&&v("self",f.selfDrawable),f.groupDrawable&&v("group",f.groupDrawable),f.sharedCacheDrawable&&v("sharedCache",f.sharedCacheDrawable),L+="</div>",s+=L,t+=1,_.each(f.children,S=>{b(S)}),t-=1}this._baseInstance&&(s+=`<div style="${e}">Root Instance Tree</div>`,b(this._baseInstance)),_.each(this._sharedCanvasInstances,f=>{s+=`<div style="${e}">Shared Canvas Instance Tree</div>`,b(f)});function y(f){let L=`<div style="margin-left: ${t*20}px">`;if(L+=m(f),f.instance?(L+=` <span style="color: #0a0;">(${f.instance.trail.toPathString()})</span>`,L+=`&nbsp;&nbsp;&nbsp;${u(f.instance)}`):f.backboneInstance&&(L+=` <span style="color: #a00;">(${f.backboneInstance.trail.toPathString()})</span>`,L+=`&nbsp;&nbsp;&nbsp;${u(f.backboneInstance)}`),L+="</div>",s+=L,f.blocks)t+=1,_.each(f.blocks,v=>{y(v)}),t-=1;else if(f.firstDrawable&&f.lastDrawable){t+=1;for(let v=f.firstDrawable;v!==f.lastDrawable;v=v.nextDrawable)y(v);y(f.lastDrawable),t-=1}}return this._rootBackbone&&(s+='<div style="font-weight: bold;">Root Drawable Tree</div>',y(this._rootBackbone)),s}getDebugURI(){return`data:text/html;charset=utf-8,${encodeURIComponent(`<!DOCTYPE html><html lang="en"><head><title>Scenery Debug Snapshot</title></head><body style="font-size: 12px;">${this.getDebugHTML()}</body></html>`)}`}popupDebug(){window.open(this.getDebugURI())}iframeDebug(){const e=document.createElement("iframe");e.width=""+window.innerWidth,e.height=""+window.innerHeight,e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.zIndex="10000",document.body.appendChild(e),e.contentWindow.document.open(),e.contentWindow.document.write(this.getDebugHTML()),e.contentWindow.document.close(),e.contentWindow.document.body.style.background="white";const t=document.createElement("button");t.style.position="absolute",t.style.top="0",t.style.right="0",t.style.zIndex="10001",document.body.appendChild(t),t.textContent="close",["pointerdown","click","touchdown"].forEach(s=>{t.addEventListener(s,()=>{document.body.removeChild(e),document.body.removeChild(t)},!0)})}getPDOMDebugHTML(){let e="";const t="font-weight: bold; font-size: 120%; margin-top: 5px;",s="&nbsp;&nbsp;&nbsp;&nbsp;";e+=`<div style="${t}">Accessible Instances</div><br>`,i(this._rootPDOMInstance,"");function i(h,l){e+=`${l+Qa(`${h.isRootInstance?"":h.node.tagName} ${h.toString()}`)}<br>`,h.children.forEach(c=>{i(c,l+s)})}e+=`<br><div style="${t}">Parallel DOM</div><br>`;let n=this._rootPDOMInstance.peer.primarySibling.outerHTML;n=n.replace(/></g,`>
<`);const a=n.split(`
`);let o="";for(let h=0;h<a.length;h++){const l=a[h],c=l.startsWith("</");c&&(o=o.slice(s.length)),e+=`${o+Qa(l)}<br>`,c||(o+=s)}return e}foreignObjectRasterization(e){const t={};let s=0;function i(y){y.id||(y.id=`unknown-canvas-${s++}`),t[y.id]=y.toDataURL()}function n(y){if(y instanceof bi)_.each(y.blocks,f=>{n(f)});else if(y instanceof As&&y.firstDrawable&&y.lastDrawable){for(let f=y.firstDrawable;f!==y.lastDrawable;f=f.nextDrawable)n(f);n(y.lastDrawable),(y instanceof Gh||y instanceof tp)&&y.canvas&&y.canvas instanceof window.HTMLCanvasElement&&i(y.canvas)}ko&&y instanceof ko&&(y.domElement instanceof window.HTMLCanvasElement&&i(y.domElement),Array.prototype.forEach.call(y.domElement.getElementsByTagName("canvas"),f=>{i(f)}))}n(this._rootBackbone);const a=document.implementation.createHTMLDocument("");a.documentElement.innerHTML=this.domElement.outerHTML,a.documentElement.setAttribute("xmlns",a.documentElement.namespaceURI),a.documentElement.appendChild(document.createElement("style")).innerHTML=`.${qo.ROOT_CLASS_NAME} { display:none; } `;let o=a.documentElement.getElementsByTagName("canvas");o=Array.prototype.slice.call(o);for(let y=0;y<o.length;y++){const f=o[y],L=f.style.cssText,v=a.createElement("img"),S=t[f.id];assert&&assert(S,"Must have missed a toDataURL() on a Canvas"),v.src=S,v.setAttribute("style",L),f.parentNode.replaceChild(v,f)}const h=this.width,l=this.height,c=()=>{ut.elementToSVGDataURL(a.documentElement,h,l,e)};let u=0,m=!1;const b=Array.prototype.slice.call(a.documentElement.getElementsByTagName("image"));for(let y=0;y<b.length;y++){const f=b[y],L=f.getAttribute("xlink:href");L.slice(0,5)!=="data:"&&(u++,m=!0,(()=>{const v=new window.Image,S=f;v.onload=()=>{const B=document.createElement("canvas");B.width=v.width,B.height=v.height,B.getContext("2d").drawImage(v,0,0),S.setAttribute("xlink:href",B.toDataURL()),--u===0&&c(),assert&&assert(u>=0)},v.onerror=()=>{--u===0&&c(),assert&&assert(u>=0)},v.src=L})())}m||c()}popupRasterization(){this.foreignObjectRasterization(e=>{e&&window.open(e)})}getTrailFromPDOMIndicesString(e){if(!this._rootPDOMInstance)return null;let t=this._rootPDOMInstance;const s=e.split(N.PDOM_UNIQUE_ID_SEPARATOR);for(let i=0;i<s.length;i++){const n=Number(s[i]);if(t=t.children[n],!t)return null}return t&&t.trail?t.trail:null}refreshSVG(){this._refreshSVGEmitter.emit()}refreshSVGOnNextFrame(){this._refreshSVGPending=!0}dispose(){assert&&(assert(!this._isDisposing),assert(!this._isDisposed),this._isDisposing=!0),this._input&&this.detachEvents(),this._rootNode.removeRootedDisplay(this),this._accessible&&(assert&&assert(this._boundHandleFullScreenNavigation,"_boundHandleFullScreenNavigation was not added to the keyStateTracker"),ze.keydownEmitter.removeListener(this._boundHandleFullScreenNavigation),this._rootPDOMInstance.dispose()),this._focusOverlay&&this._focusOverlay.dispose(),this.sizeProperty.dispose(),this._baseInstance&&this._baseInstance.dispose(),this.descriptionUtteranceQueue.dispose(),this.focusManager&&this.focusManager.dispose(),assert&&(this._isDisposing=!1,this._isDisposed=!0)}static elementToSVGDataURL(e,t,s,i){const n=document.createElement("canvas"),a=n.getContext("2d");n.width=t,n.height=s;const o=new window.XMLSerializer().serializeToString(e),h=`<svg xmlns="http://www.w3.org/2000/svg" width="${t}" height="${s}"><foreignObject width="100%" height="100%"><div xmlns="http://www.w3.org/1999/xhtml">${o}</div></foreignObject></svg>`,l=new window.Image;l.onload=()=>{a.drawImage(l,0,0),i(n.toDataURL())},l.onerror=()=>{i(null)};const c=new window.TextEncoderLite("utf-8").encode(h),u=window.fromByteArray(c);l.src=`data:image/svg+xml;base64,${u}`}static assertSubtreeDisposed(e){if(assert&&assert(!e.isDisposed,"Disposed nodes should not be included in a scene graph to display."),assert)for(let t=0;t<e.children.length;t++)ut.assertSubtreeDisposed(e.children[t])}static addInputListener(e){assert&&assert(!_.includes(ut.inputListeners,e),"Input listener already registered"),_.includes(ut.inputListeners,e)||ut.inputListeners.push(e)}static removeInputListener(e){assert&&assert(_.includes(ut.inputListeners,e)),ut.inputListeners.splice(_.indexOf(ut.inputListeners,e),1)}static interruptInput(){const e=ut.inputListeners.slice(0);for(let t=0;t<e.length;t++){const s=e[t];s.interrupt&&s.interrupt()}}};ut.INTERRUPT_OTHER_POINTERS=e=>{var t,s;(s=(t=phet==null?void 0:phet.joist)==null?void 0:t.display)==null||s.interruptOtherPointers(e==null?void 0:e.pointer)};let Be=ut;d.register("Display",Be);Be.userGestureEmitter=new He;Be.inputListeners=[];const xo={};let Vc=0;function qy(r){r._parents.forEach(e=>hp(e,r,1))}function Qy(r){r._parents.forEach(e=>hp(e,r,-1))}function Gc(r){const e=xo[r];assert&&assert(this.parents.length===1,"IndexedNodeIO only supports nodes with a single parent"),this.parents[0].childrenChangedEmitter.removeListener(e),delete xo[r]}function hp(r,e,t){let i=r.indexOfChild(e)+t;for(;i>0&&i<r.children.length&&!r.children[i].visible;)i+=t;i>=0&&i<r.children.length&&r.moveChildToIndex(e,i),r.onIndexedNodeIOChildMoved&&r.onIndexedNodeIOChildMoved(e)}const Zy=new Le("IndexedNodeIO",{valueType:D,documentation:"Node that can be moved forward/back by index, which specifies z-order and/or layout order",supertype:D.NodeIO,toStateObject:r=>{const e={index:null};return r.parents[0]&&(assert&&assert(r.parents.length===1,"IndexedNodeIO only supports nodes with a single parent"),e.index=r.parents[0].indexOfChild(r)),e},applyState:(r,e)=>{const t=r.parents[0];if(t&&e.index){assert&&assert(r.parents.length===1,"IndexedNodeIO only supports nodes with a single parent");const s=t.children,i=t.indexOfChild(r);s[i]=s[e.index],s[e.index]=r,t.setChildren(s)}},stateSchema:{index:V(U)},methods:{linkIndex:{returnType:U,parameterTypes:[qa(mt,[U])],documentation:"Following the PropertyIO.link pattern, subscribe for notifications when the index in the parent changes, and receive a callback with the current value.  The return value is a numeric ID for use with clearLinkIndex.",implementation:function(r){const e=()=>{assert&&assert(this.parents.length===1,"IndexedNodeIO only supports nodes with a single parent");const s=this.parents[0].indexOfChild(this);r(s)};assert&&assert(this.parents.length===1,"IndexedNodeIO only supports nodes with a single parent"),this.parents[0].childrenChangedEmitter.addListener(e),e();const t=Vc;return xo[t]=e,Vc++,t}},unlinkIndex:{returnType:mt,parameterTypes:[U],documentation:"Unlink a listener that has been added using linkIndex, by its numerical ID (like setTimeout/clearTimeout)",implementation:Gc},clearLinkIndex:{returnType:mt,parameterTypes:[U],documentation:'Deprecated, see "unlinkIndex".',implementation:function(r){assert&&Ot("clearLinkIndex is deprecated, use unlinkIndex instead.",!0),Gc.call(this,r)}},moveForward:{returnType:mt,parameterTypes:[],implementation:function(){return qy(this)},documentation:"Move this Node one index forward in each of its parents, skipping invisible Nodes. If the Node is already at the front, this is a no-op."},moveBackward:{returnType:mt,parameterTypes:[],implementation:function(){return Qy(this)},documentation:"Move this Node one index backward in each of its parents, skipping invisible Nodes. If the Node is already at the back, this is a no-op."}}});d.register("IndexedNodeIO",Zy);class Jy extends be{constructor(e,t,s){s=Je({nodeTandem:se.REQUIRED},s);const i=new ie(!0,{tandem:s.nodeTandem.createTandem("visibleProperty")});super([i,...e],(n,...a)=>n&&t(...a))}}d.register("PhetioControlledVisibilityProperty",Jy);export{wi as $,Tu as A,ie as B,P as C,Be as D,Ht as E,Do as F,Bu as G,Jf as H,$e as I,Ds as J,Bf as K,ds as L,Is as M,D as N,He as O,Pe as P,q as Q,De as R,Yr as S,Fe as T,yt as U,ey as V,Ur as W,mo as X,go as Y,fo as Z,jn as _,Pi as a,ib as a0,Xn as a1,zn as a2,ns as a3,nh as a4,Ri as a5,nb as a6,Qr as a7,Zy as a8,oh as a9,Ue as aa,g as ab,Rg as ac,oe as ad,hm as ae,lt as af,Bi as ag,N as ah,Mf as ai,ze as aj,xa as ak,so as al,Rd as am,Wt as an,Fp as ao,Ie as ap,rb as aq,_i as b,be as c,Kt as d,bh as e,Hu as f,Eu as g,nu as h,fh as i,$r as j,xe as k,ps as l,Ai as m,jt as n,om as o,Qo as p,is as q,Si as r,Oe as s,Cl as t,Tf as u,O as v,Bl as w,ah as x,$p as y,ki as z};
