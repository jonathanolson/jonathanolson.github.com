var Qe=Object.defineProperty;var et=(p,r,e)=>r in p?Qe(p,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):p[r]=e;var v=(p,r,e)=>(et(p,typeof r!="symbol"?r+"":r,e),e);import{T as a,P as fe,E as je,d as Xe,o as ye,V as j,h as Ce,D as tt,c as Ye,C as ot,B as Se}from"./UnivariatePolynomial-1rLpyqfN.js";import{c as _,h as k,B as oe,F as pe,N as b,P as D,L as rt,C as Le,R as st,H as Ue,M as ee,T as _e,G as nt,l as qe,m as it}from"./PhetioControlledVisibilityProperty-CzTgKbkx.js";import{F as he,S as V,E as H,V as at,B as Fe,C as lt}from"./BasicPuzzle-DGsxIJRd.js";import{b as ct,L as dt,a as pt,c as ht,P as Je}from"./TextPushButton-Coq2A-51.js";import{h as xe,S as N,L as ke,_ as Ve,G as ut,e as M,f as R,m as Ze,k as ft,d as gt}from"./getCoordinateClusteredMap-Bd_wM-c0.js";import{e as wt,f as mt,g as Oe,J as Ct,s as Ie,h as yt,i as Pt,v as Ae,j as St,k as Be,w as vt,m as G,n as Et,q as Vt,x as bt,y as Tt,I as K,G as Nt,E as Lt,A as Ft,C as xt,c as $,O as kt,r as Ot,u as It,P as be}from"./Theme-DMXUyWiP.js";import{b as At,c as Bt,d as Mt,T as Rt,W as Dt,a0 as Wt,C as ae,a5 as Ht,M as jt,N as Xt,P as Yt,Q as Ut,e as _t,Z as Te,U as qt,i as Jt,a6 as Zt,F as zt,g as ge,a as Gt}from"./autoSolver-D0maTTyV.js";import{A as Kt}from"./ShadedSphereNode-uuPU3yfJ.js";import{F as $t,B as Qt,R as eo,a as to,b as oo,c as ro,S as so,d as no}from"./SectorOnlyOneFeature-B1Nn5A2g.js";import{c as io}from"./getPeriodicTilingGenerator-zRiID_iR.js";const ze=(p,r,e,t)=>(o,s,d)=>{const i=[new At(o,s),new Bt(o,s)];return(p||r||e||t)&&(i.push(new Mt(o,s)),(r||e||t)&&(i.push(new Rt(o,s)),(e||t)&&(i.push(new Dt(o,s)),t&&i.push(new Wt(o,s))))),new ae(i)},ao={edgesVisibleProperty:wt,edgesHaveColorsProperty:mt,faceColorsVisibleProperty:Oe,faceColorThresholdProperty:Ct,sectorsVisibleProperty:Ie,sectorsNextToEdgesVisibleProperty:yt,sectorsTrivialVisibleProperty:Pt,vertexStateVisibleProperty:Ae,allVertexStateVisibleProperty:St,faceStateVisibleProperty:Be,whiteLineVisibleProperty:vt,redLineVisibleProperty:G,verticesVisibleProperty:Et,smallVertexProperty:Vt,redXsVisibleProperty:bt,redXsAlignedProperty:Tt,faceValueStyleProperty:K,redLineStyleProperty:Nt,vertexStyleProperty:Lt,joinedLinesJoinProperty:Ft,joinedLinesCapProperty:xt,safeSolverFactoryProperty:new _([Oe,Ie,Ae,Be],(p,r,e,t)=>ze(p,r,e,t)),autoSolverFactoryProperty:Ht,theme:$},te=(p,r,e,t,o)=>{const s=ze(p,r,e,t);return{faceColorsVisibleProperty:new oe(p),sectorsVisibleProperty:new oe(r),vertexStateVisibleProperty:new oe(e),faceStateVisibleProperty:new oe(t),safeSolverFactoryProperty:new fe(s),autoSolverFactoryProperty:o?new _([o],d=>(i,c,h)=>new ae([s(i,c,h),d(i,c,h)])):new fe(s)}},le=new _([jt,Xt],(p,r)=>(e,t,o)=>new ae([new Yt(e,t,{solveJointToRed:!0,solveForcedLineToBlack:p,solveAlmostEmptyToRed:!0},o?void 0:[]),new Ut(e,t,{solveToRed:!0,solveToBlack:p},o?void 0:[]),...r?[new _t(e,t,{solveToRed:!0,solveToBlack:p,resolveAllRegions:!1},o?void 0:[])]:[]])),lo=new _([le],p=>(r,e,t)=>new ae([p(r,e,t),new Te(r,e,{solveToRed:!0,solveToBlack:!0})])),Ge=new _([le],p=>(r,e,t)=>new ae([p(r,e,t),new qt(r,e,t?void 0:[])])),co=new _([Ge],p=>(r,e,t)=>new ae([p(r,e,t),new Te(r,e,{solveToRed:!0,solveToBlack:!0})])),po=p=>({...te(!0,!1,!1,!1,le),theme:p,edgesVisibleProperty:new a(!0),edgesHaveColorsProperty:new a(!0),faceColorThresholdProperty:new a(Number.POSITIVE_INFINITY),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!0),redLineVisibleProperty:G,verticesVisibleProperty:new a(!1),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!1),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("round"),joinedLinesJoinProperty:new a("round"),joinedLinesCapProperty:new a("round")}),ho=p=>({...te(!0,!1,!1,!1,lo),theme:p,edgesVisibleProperty:new a(!0),edgesHaveColorsProperty:new a(!1),faceColorThresholdProperty:new a(2),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!0),redLineVisibleProperty:G,verticesVisibleProperty:new a(!1),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!1),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("round"),joinedLinesJoinProperty:new a("round"),joinedLinesCapProperty:new a("round")}),uo=p=>({...te(!0,!1,!1,!1,new fe((r,e,t)=>new ae([new Te(r,e,{solveToRed:!0,solveToBlack:!0},t?void 0:[])]))),theme:p,edgesVisibleProperty:new a(!1),edgesHaveColorsProperty:new a(!1),faceColorThresholdProperty:new a(2),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!1),redLineVisibleProperty:G,verticesVisibleProperty:new a(!1),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!1),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("round"),joinedLinesJoinProperty:new a("round"),joinedLinesCapProperty:new a("round")}),fo=p=>({...te(!1,!1,!1,!1,le),theme:p,edgesVisibleProperty:new a(!0),edgesHaveColorsProperty:new a(!1),faceColorThresholdProperty:new a(Number.POSITIVE_INFINITY),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!1),redLineVisibleProperty:G,verticesVisibleProperty:new a(!0),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!0),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("square"),joinedLinesJoinProperty:new a("miter"),joinedLinesCapProperty:new a("square")}),cr=p=>({...te(!1,!0,!1,!1,le),theme:p,edgesVisibleProperty:new a(!0),edgesHaveColorsProperty:new a(!1),faceColorThresholdProperty:new a(Number.POSITIVE_INFINITY),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!1),redLineVisibleProperty:G,verticesVisibleProperty:new a(!0),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!0),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("square"),joinedLinesJoinProperty:new a("miter"),joinedLinesCapProperty:new a("square")}),go=p=>({...te(!0,!0,!1,!1,Ge),theme:p,edgesVisibleProperty:new a(!0),edgesHaveColorsProperty:new a(!0),faceColorThresholdProperty:new a(Number.POSITIVE_INFINITY),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!0),redLineVisibleProperty:G,verticesVisibleProperty:new a(!1),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!1),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("round"),joinedLinesJoinProperty:new a("round"),joinedLinesCapProperty:new a("round")}),wo=p=>({...te(!0,!0,!1,!1,co),theme:p,edgesVisibleProperty:new a(!0),edgesHaveColorsProperty:new a(!1),faceColorThresholdProperty:new a(2),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!0),redLineVisibleProperty:G,verticesVisibleProperty:new a(!1),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!1),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("round"),joinedLinesJoinProperty:new a("round"),joinedLinesCapProperty:new a("round")}),mo=p=>({...te(!0,!1,!0,!1,le),theme:p,edgesVisibleProperty:new a(!0),edgesHaveColorsProperty:new a(!1),faceColorThresholdProperty:new a(2),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!0),redLineVisibleProperty:G,verticesVisibleProperty:new a(!1),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!1),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("round"),joinedLinesJoinProperty:new a("round"),joinedLinesCapProperty:new a("round")}),Co=p=>({...te(!0,!1,!1,!0,le),theme:p,edgesVisibleProperty:new a(!0),edgesHaveColorsProperty:new a(!1),faceColorThresholdProperty:new a(2),sectorsNextToEdgesVisibleProperty:new a(!1),sectorsTrivialVisibleProperty:new a(!1),allVertexStateVisibleProperty:new a(!1),whiteLineVisibleProperty:new a(!0),redLineVisibleProperty:G,verticesVisibleProperty:new a(!1),smallVertexProperty:new a(!1),redXsVisibleProperty:new a(!1),redXsAlignedProperty:new a(!1),faceValueStyleProperty:K,redLineStyleProperty:new a("middle"),vertexStyleProperty:new a("round"),joinedLinesJoinProperty:new a("round"),joinedLinesCapProperty:new a("round")}),yo=po($),Po=ho($),So=uo($),Ke=fo($),vo=go($),Eo=wo($),Vo=mo($),bo=Co($),ve={basicLines:yo,basicFaceColoring:Po,pureFaceColor:So,classic:Ke,basicSectors:vo,sectorsWithColors:Eo,vertexState:Vo,faceState:bo,custom:ao},Me=Ke,To=p=>({edgesVisibleProperty:new k(p,{derive:"edgesVisibleProperty"}),edgesHaveColorsProperty:new k(p,{derive:"edgesHaveColorsProperty"}),faceColorsVisibleProperty:new k(p,{derive:"faceColorsVisibleProperty"}),faceColorThresholdProperty:new k(p,{derive:"faceColorThresholdProperty"}),sectorsVisibleProperty:new k(p,{derive:"sectorsVisibleProperty"}),sectorsNextToEdgesVisibleProperty:new k(p,{derive:"sectorsNextToEdgesVisibleProperty"}),sectorsTrivialVisibleProperty:new k(p,{derive:"sectorsTrivialVisibleProperty"}),vertexStateVisibleProperty:new k(p,{derive:"vertexStateVisibleProperty"}),allVertexStateVisibleProperty:new k(p,{derive:"allVertexStateVisibleProperty"}),faceStateVisibleProperty:new k(p,{derive:"faceStateVisibleProperty"}),whiteLineVisibleProperty:new k(p,{derive:"whiteLineVisibleProperty"}),redLineVisibleProperty:new k(p,{derive:"redLineVisibleProperty"}),verticesVisibleProperty:new k(p,{derive:"verticesVisibleProperty"}),smallVertexProperty:new k(p,{derive:"smallVertexProperty"}),redXsVisibleProperty:new k(p,{derive:"redXsVisibleProperty"}),redXsAlignedProperty:new k(p,{derive:"redXsAlignedProperty"}),faceValueStyleProperty:new k(p,{derive:"faceValueStyleProperty"}),redLineStyleProperty:new k(p,{derive:"redLineStyleProperty"}),vertexStyleProperty:new k(p,{derive:"vertexStyleProperty"}),joinedLinesJoinProperty:new k(p,{derive:"joinedLinesJoinProperty"}),joinedLinesCapProperty:new k(p,{derive:"joinedLinesCapProperty"}),safeSolverFactoryProperty:new k(p,{derive:"safeSolverFactoryProperty"}),autoSolverFactoryProperty:new k(p,{derive:"autoSolverFactoryProperty"}),theme:kt(new _([p],r=>r.theme))}),No=new ct("puzzleStyle",{serialize:p=>Object.keys(ve).find(r=>ve[r]===p),deserialize:p=>p?ve[p]??Me:Me}),ie=To(No),dr=new dt("showPuzzleStyleProperty",!0),O=class O extends je{constructor(r){super(),this.isEnabledProperty=r}};v(O,"EDGE_STATE",new O(new oe(!0))),v(O,"EDGE_STATE_REVERSED",new O(new oe(!0))),v(O,"FACE_COLOR_MATCH",new O(ie.faceColorsVisibleProperty)),v(O,"FACE_COLOR_OPPOSITE",new O(ie.faceColorsVisibleProperty)),v(O,"SECTOR_STATE",new O(ie.sectorsVisibleProperty)),v(O,"VERTEX_STATE",new O(ie.vertexStateVisibleProperty)),v(O,"FACE_STATE",new O(ie.faceStateVisibleProperty)),v(O,"FACE_VALUE",new O(new oe(!1))),v(O,"DELETE_FACE",new O(new oe(!1))),v(O,"enumeration",new Xe(O));let U=O;const re=new pt("editModeProperty",U.EDGE_STATE);let Ee=null;const Re=p=>{p||(re.value=U.EDGE_STATE)};re.link(p=>{Ee&&Ee.isEnabledProperty.unlink(Re),Ee=p,p.isEnabledProperty.link(Re)});const pr=p=>{p.isEnabledProperty.value&&(re.value=p)},Lo=new _([re],p=>p===U.EDGE_STATE||p===U.EDGE_STATE_REVERSED),$e=new _([re],p=>p===U.FACE_COLOR_MATCH||p===U.FACE_COLOR_OPPOSITE),Fo=new _([re],p=>p===U.SECTOR_STATE),xo=new _([re],p=>p===U.VERTEX_STATE),ko=new _([re,$e],(p,r)=>r||p===U.FACE_STATE||p===U.FACE_VALUE||p===U.DELETE_FACE),Oo=(p,r,e)=>{const t=new pe({mouseButton:0,fire:d=>{var i;return e&&e(p,(i=d.domEvent)!=null&&i.shiftKey?2:0)}}),o=new pe({mouseButton:2,fire:d=>{var i;return e&&e(p,(i=d.domEvent)!=null&&i.shiftKey?0:2)}}),s=new pe({mouseButton:1,fire:d=>e&&e(p,1)});r.addInputListener(t),r.addInputListener(o),r.addInputListener(s),r.cursor="pointer",r.disposeEmitter.addListener(()=>{t.dispose(),o.dispose(),s.dispose()})};class Pe extends b{constructor(r,e,t,o){const s=ye()({useBackgroundOffsetStroke:!1,backgroundOffsetDistance:.3,facePressListener:()=>{},noninteractive:!1},o);super({pickableProperty:$e}),this.outerBoundary=r,this.innerBoundaries=e,this.style=t,!s.noninteractive&&Oo(null,this,s.facePressListener);const d=r.map(m=>m.start.viewCoordinates),i=s.useBackgroundOffsetStroke,c=s.backgroundOffsetDistance,l=xe(d)>0?-c:c,n=m=>{const u=new ut;u.addShape(0,m),u.computeSimplifiedFaces(),u.computeFaceInclusion(P=>P[0]>0);const C=u.createFilledSubGraph(),g=C.facesToShape();return u.dispose(),C.dispose(),g},w=Pe.getOffsetBackgroundShape(r,i,c),f=e.map(m=>{const u=m.map(g=>g.start.viewCoordinates),C=N.polygon(u);if(i)return n(C.getOffsetShape(l));{const P=C.getStrokedShape(new ke({lineWidth:2*c})).subpaths.map(y=>new N([y]));return n(Ve.minBy(P,y=>y.getArea()))}});this.children=[new D(w,{fill:t.theme.puzzleBackgroundColorProperty,stroke:t.theme.puzzleBackgroundStrokeColorProperty,lineWidth:.03}),...f.map(m=>new D(m,{fill:t.theme.playAreaBackgroundColorProperty,stroke:t.theme.puzzleBackgroundStrokeColorProperty,lineWidth:.03}))]}static getOffsetBackgroundShape(r,e,t){const o=r.map(c=>c.start.viewCoordinates),s=N.polygon(o),i=xe(o)>0?-t:t;if(e)return s.getOffsetShape(i).getSimplifiedAreaShape();{const c=s.getStrokedShape(new ke({lineWidth:2*t})),h=c.subpaths.map(l=>new N([l]));try{return c.bounds.width===9.718028227819117?N.bounds(c.bounds):Ve.maxBy(h,l=>l.getArea()).getSimplifiedAreaShape()}catch{return N.bounds(c.bounds)}}}}class Io extends b{constructor(e,t,o){super({pickable:!1,visibleProperty:o.edgesVisibleProperty});v(this,"simpleRegionNodeMap",new Map);v(this,"regionIdMap",new Map);v(this,"weirdEdgeNodeMap",new Map);v(this,"regionContainer",new b);v(this,"weirdEdgeContainer",new b);v(this,"adjacentFacesMap",new Map);this.board=e,this.style=o,e.faces.forEach(i=>{this.adjacentFacesMap.set(i,i.edges.map(c=>c.getOtherFace(i)).filter(c=>c!==null))}),this.children=[this.weirdEdgeContainer,this.regionContainer],t.value.getSimpleRegions().forEach(i=>this.addRegion(i)),t.value.getWeirdEdges().forEach(i=>this.addWeirdEdge(i)),this.updateHues();const s=(i,c)=>{const h=c.getSimpleRegions(),l=i.getSimpleRegions(),n=c.getWeirdEdges(),w=i.getWeirdEdges(),f=[],m=[];Ze(h,l,f,m,[]);const C=new Set(f);for(const g of m)if(this.regionIdMap.has(g.id)){const P=this.regionIdMap.get(g.id);this.replaceRegion(P,g),C.delete(P)}else this.addRegion(g);for(const g of C)this.removeRegion(g);for(const g of n)w.includes(g)||this.removeWeirdEdge(g);for(const g of w)n.includes(g)||this.addWeirdEdge(g);(m.length||f.length)&&this.updateHues()};t.lazyLink(s),this.disposeEmitter.addListener(()=>t.unlink(s)),this.disposeEmitter.addListener(()=>{for(;this.simpleRegionNodeMap.size;)this.removeRegion(this.simpleRegionNodeMap.keys().next().value)});const d=()=>this.updateHues();o.theme.simpleRegionHueLUTProperty.link(d),o.edgesHaveColorsProperty.lazyLink(d),this.disposeEmitter.addListener(()=>{o.theme.simpleRegionHueLUTProperty.unlink(d),o.edgesHaveColorsProperty.unlink(d)})}addRegion(e){const t=new de(e,this.style);this.simpleRegionNodeMap.set(e,t),this.regionIdMap.set(e.id,e),this.regionContainer.addChild(t)}replaceRegion(e,t){M()&&R(e.id===t.id);const o=this.simpleRegionNodeMap.get(e);o.updateRegion(t),this.simpleRegionNodeMap.delete(e),this.simpleRegionNodeMap.set(t,o),this.regionIdMap.delete(e.id),this.regionIdMap.set(t.id,t)}removeRegion(e){const t=this.simpleRegionNodeMap.get(e);this.regionContainer.removeChild(t),this.simpleRegionNodeMap.delete(e),this.regionIdMap.delete(e.id),t.dispose()}addWeirdEdge(e){const t=e.start.viewCoordinates,o=e.end.viewCoordinates,s=new rt(t.x,t.y,o.x,o.y,{lineWidth:.1,stroke:this.style.theme.edgeWeirdColorProperty,lineCap:"square"});this.weirdEdgeNodeMap.set(e,s),this.weirdEdgeContainer.addChild(s)}removeWeirdEdge(e){const t=this.weirdEdgeNodeMap.get(e);this.weirdEdgeContainer.removeChild(t),this.weirdEdgeNodeMap.delete(e)}updateHues(){const e=[...this.simpleRegionNodeMap.values()];if(e.length<2)return;const t=new j(0,0),o=()=>{for(const l of e)l.hueVector.getMagnitude()>1e-6?l.hueVector.normalize():l.hueVector.setXY(1,0)},s=new Map,d=[];this.board.faces.forEach(l=>{s.set(l,[])});for(const l of e){const n=new Set;for(const f of l.simpleRegion.edges)for(const m of f.faces)n.add(m);const w=new Set;for(const f of n){w.add(f);for(const m of this.adjacentFacesMap.get(f))w.add(m)}for(const f of w){const m=s.get(f);if(m.length)for(const u of m){let C=!1;for(const g of d)if(g.a===u&&g.b===l){g.weight++,C=!0;break}C||d.push({a:u,b:l,weight:1})}m.push(l)}}const i=new Map;for(const l of e)i.set(l,j.ZERO.copy());const c=(l,n,w)=>{const f=i.get(l),m=i.get(n),u=l.hueVector.dot(n.hueVector),C=t.set(n.hueVector).subtract(l.hueVector);if(C.magnitude>1e-9){C.normalize();const g=.3,P=w*((Math.max(g,u)-g)/(1-g))**3;C.multiplyScalar(P),f.subtract(C),m.add(C)}};let h=1;for(let l=0;l<100;l++){h*=.99;for(const n of e)i.get(n).setXY(0,0);for(const n of d){const w=n.a,f=n.b,m=n.weight;c(w,f,m)}if(e.length<8)for(let n=0;n<e.length;n++){const w=e[n];for(let f=n+1;f<e.length;f++)c(w,e[f],.2)}for(const n of e){const w=i.get(n);w.multiplyScalar(h/n.edgeCount),n.hueVector.add(w),i.get(n).setXY(0,0)}o()}for(const l of e)l.updateHue()}}class de extends D{constructor(e,t){const o=j.createPolar(1,Ce.nextDoubleBetween(0,2*Math.PI));super(de.toShape(e),{stroke:de.hueVectorToPaint(o,t),lineWidth:.1,lineCap:"square",lineJoin:"round"});v(this,"hueVector");v(this,"edgeCount");this.simpleRegion=e,this.style=t,this.hueVector=o,this.edgeCount=e.edges.length;const s=i=>{this.lineJoin=i};t.joinedLinesJoinProperty.link(s),this.disposeEmitter.addListener(()=>t.joinedLinesJoinProperty.unlink(s));const d=i=>{this.lineCap=i};t.joinedLinesCapProperty.link(d),this.disposeEmitter.addListener(()=>t.joinedLinesCapProperty.unlink(d))}updateHue(){this.stroke=de.hueVectorToPaint(this.hueVector.getMagnitude()>1e-6?this.hueVector:j.X_UNIT,this.style)}updateRegion(e){this.simpleRegion=e,this.shape=de.toShape(e),this.edgeCount=e.edges.length}static hueVectorToPaint(e,t){const o=t.theme.simpleRegionHueLUTProperty.value,s=(Math.round(e.getAngle()*180/Math.PI)+360)%360;return M()&&R(s>=0&&s<o.length),t.edgesHaveColorsProperty.value?o[s]:t.theme.blackLineColorProperty}static toShape(e){const t=new N;let o=!0;for(const s of e.halfEdges)o&&(o=!1,t.moveToPoint(s.start.viewCoordinates)),t.lineToPoint(s.end.viewCoordinates);return e.isSolved&&t.close(),t.makeImmutable()}}class Ao extends b{constructor(e,t,o){const s=new b;super({pickable:!1,children:[s]});v(this,"faceColorNodeMap",new Map);v(this,"faceColorIdMap",new Map);v(this,"adjacentFacesMap",new Map);v(this,"faceColorNodeContainer");v(this,"dualColorViews",new Set);this.board=e,this.stateProperty=t,this.style=o,this.faceColorNodeContainer=s,e.faces.forEach(h=>{this.adjacentFacesMap.set(h,h.edges.map(l=>l.getOtherFace(h)).filter(l=>l!==null))});{const h=t.value.getFaceColors();for(const l of h)this.addFaceColor(l,t.value.getFacesWithColor(l));this.addDualColorViews(t.value,h)}this.updateHues();let d=t.value.clone();const i=h=>{const l=d;d=h.clone();const n=l.getFaceColors(),w=h.getFaceColors(),f=[],m=[],u=[];Ze(n,w,f,m,u);const C=new Set(f),g=this.removeInvalidDualColorViews(h),P=[...g];for(const y of m)if(g.add(y),this.faceColorIdMap.has(y.id)){const S=this.faceColorIdMap.get(y.id);this.replaceFaceColor(S,y,h.getFacesWithColor(y)),C.delete(S)}else this.addFaceColor(y,h.getFacesWithColor(y));for(const y of u)this.updateFaceColor(y,h.getFacesWithColor(y));for(const y of C)g.delete(y),this.removeFaceColor(y);this.addDualColorViews(h,[...g]),(m.length||f.length||P.length)&&this.updateHues()};t.lazyLink(i),this.disposeEmitter.addListener(()=>t.unlink(i)),this.disposeEmitter.addListener(()=>{for(;this.faceColorNodeMap.size;)this.removeFaceColor(this.faceColorNodeMap.keys().next().value)});const c=()=>this.updateHues();o.theme.faceColorBasicHueLUTProperty.lazyLink(c),o.theme.faceColorLightHueLUTProperty.lazyLink(c),o.theme.faceColorDarkHueLUTProperty.lazyLink(c),o.theme.faceColorInsideColorProperty.lazyLink(c),o.theme.faceColorOutsideColorProperty.lazyLink(c),o.theme.faceColorDefaultColorProperty.lazyLink(c),o.faceColorThresholdProperty.lazyLink(c),this.updateHues(),this.disposeEmitter.addListener(()=>{o.theme.faceColorBasicHueLUTProperty.unlink(c),o.theme.faceColorLightHueLUTProperty.unlink(c),o.theme.faceColorDarkHueLUTProperty.unlink(c),o.theme.faceColorInsideColorProperty.unlink(c),o.theme.faceColorOutsideColorProperty.unlink(c),o.theme.faceColorDefaultColorProperty.unlink(c),o.faceColorThresholdProperty.unlink(c)})}addFaceColor(e,t){const o=new ue(e,t,this.style);this.faceColorNodeMap.set(e,o),this.faceColorIdMap.set(e.id,e),this.faceColorNodeContainer.addChild(o)}replaceFaceColor(e,t,o){M()&&R(e.id===t.id);const s=this.faceColorNodeMap.get(e);s.updateFaceColor(t,o),this.faceColorNodeMap.delete(e),this.faceColorNodeMap.set(t,s),this.faceColorIdMap.delete(e.id),this.faceColorIdMap.set(t.id,t)}updateFaceColor(e,t){const o=this.faceColorNodeMap.get(e);let s=o.faces.length!==t.length;if(!s)for(let d=0;d<t.length;d++){const i=o.faces[d],c=t[d];if(i!==c){s=!0;break}}s&&o.updateFaceColor(e,t)}removeFaceColor(e){const t=this.faceColorNodeMap.get(e);this.faceColorNodeContainer.removeChild(t),this.faceColorNodeMap.delete(e),this.faceColorIdMap.delete(e.id),t.dispose()}addDualColorViews(e,t){const o=new Set(t);for(;o.size;){const s=o.values().next().value;o.delete(s);const d=this.faceColorNodeMap.get(s);M()&&R(d);const i=e.getOppositeFaceColor(s);if(i){M()&&R(o.has(i)),o.delete(i);const c=this.faceColorNodeMap.get(i);M()&&R(c),this.dualColorViews.add(new De([d,c],this.style))}else this.dualColorViews.add(new De([d],this.style))}}removeInvalidDualColorViews(e){const t=new Set,o=new Set(e.getFaceColors());for(const s of[...this.dualColorViews])if(!s.isStillValidInState(this.stateProperty.value,o)){for(const d of s.colorNodes)t.add(d.faceColor);this.dualColorViews.delete(s),s.dispose()}return t}updateHues(){const e=[...this.dualColorViews].filter(t=>t.colorNodes[0].faceColor.colorState!==he.UNDECIDED&&this.style.theme.faceColorOutsideColorProperty.value.alpha===1&&this.style.theme.faceColorInsideColorProperty.value.alpha===1?!1:t.faceCount>=this.style.faceColorThresholdProperty.value);if(e.length>=2){const t=new j(0,0),o=()=>{for(const l of e)l.hueVector.getMagnitude()>1e-6?l.hueVector.normalize():l.hueVector.setXY(Ce.nextDouble()-.5,Ce.nextDouble()-.5).normalize()},s=new Map,d=[];this.board.faces.forEach(l=>{s.set(l,[])});for(const l of e){const n=new Set;for(const f of l.faces)n.add(f);const w=new Set;for(const f of n){w.add(f);for(const m of this.adjacentFacesMap.get(f))w.add(m)}for(const f of w){const m=s.get(f);if(m){if(m.length)for(const u of m){let C=!1;for(const g of d)if(g.a===u&&g.b===l){g.weight++,C=!0;break}C||d.push({a:u,b:l,weight:1})}m.push(l)}}}const i=new Map;for(const l of e)i.set(l,j.ZERO.copy());const c=(l,n,w)=>{const f=i.get(l),m=i.get(n),u=l.hueVector.dot(n.hueVector),C=t.set(n.hueVector).subtract(l.hueVector);C.magnitudeSquared>1e-11&&C.normalize();const g=.2,P=Math.abs(u),y=w*((Math.max(g,P)-g)/(1-g))**3;C.multiplyScalar(y),f.subtract(C),m.add(C)};let h=1;for(let l=0;l<100;l++){h*=.99;for(const n of e)i.get(n).setXY(0,0);for(const n of d){const w=n.a,f=n.b,m=n.weight;c(w,f,m)}if(e.length<8)for(let n=0;n<e.length;n++){const w=e[n];for(let f=n+1;f<e.length;f++)c(w,e[f],.2)}for(const n of e){const w=i.get(n);w.multiplyScalar(h/n.faceCount),n.hueVector.add(w),i.get(n).setXY(0,0)}o()}}for(const t of this.dualColorViews)t.updateHue()}}const z=class z extends je{};v(z,"BASIC",new z),v(z,"PRIMARY",new z),v(z,"SECONDARY",new z),v(z,"enumeration",new Xe(z));let q=z;class De{constructor(r,e){v(this,"hueVector");v(this,"faceCount");if(this.colorNodes=r,this.style=e,M()&&R(r.length===1||r.length===2),this.faceCount=Ve.sum(this.colorNodes.map(t=>t.faceCount)),r.forEach(t=>{t.dualColorView=this}),r.length===1)r[0].type=q.BASIC,this.hueVector=r[0].hueVector.copy();else{const t=r[0].faceCount>r[1].faceCount?r[0]:r[1],o=t===r[0]?r[1]:r[0];let s;t.type===q.PRIMARY?s=t:o.type===q.PRIMARY||t.type===q.SECONDARY?s=o:(o.type,q.SECONDARY,s=t);const d=s===t?o:t;this.hueVector=t.hueVector.copy(),s.type=q.PRIMARY,d.type=q.SECONDARY}}get faces(){return this.colorNodes.flatMap(r=>r.faces)}isStillValidInState(r,e){for(const t of this.colorNodes)if(!e.has(t.faceColor))return!1;return this.colorNodes.length===1?r.getOppositeFaceColor(this.colorNodes[0].faceColor)===null:r.getOppositeFaceColor(this.colorNodes[0].faceColor)===this.colorNodes[1].faceColor}updateHue(){for(const r of this.colorNodes)r.hueVector.set(this.hueVector),r.updateHue(this.faceCount>=this.style.faceColorThresholdProperty.value)}dispose(){for(const r of this.colorNodes)r.dualColorView=null}}class ue extends D{constructor(e,t,o){const s=j.createPolar(1,Ce.nextDoubleBetween(0,2*Math.PI));super(ue.toShape(t));v(this,"hueVector");v(this,"faceCount");v(this,"dualColorView",null);v(this,"type",q.BASIC);this.faceColor=e,this.faces=t,this.style=o,this.hueVector=s,this.faceCount=t.length}updateHue(e){e||this.faceColor.colorState!==he.UNDECIDED?this.fill=ue.hueVectorToPaint(this.hueVector.getMagnitude()>1e-6?this.hueVector:j.X_UNIT,this.faceColor.colorState,this.type,this.style):this.fill=this.style.theme.faceColorDefaultColorProperty}updateFaceColor(e,t){const o=t.length-this.faceCount;this.faceColor=e,this.faces=t,this.shape=ue.toShape(t),this.faceCount=t.length,this.dualColorView&&(this.dualColorView.faceCount+=o)}static hueVectorToPaint(e,t,o,s){const d=o===q.BASIC?s.theme.faceColorBasicHueLUTProperty.value:o===q.PRIMARY?s.theme.faceColorLightHueLUTProperty.value:s.theme.faceColorDarkHueLUTProperty.value,i=(Math.round(e.getAngle()*180/Math.PI)+360)%360;M()&&R(i>=0&&i<d.length);const c=d[i];if(t===he.UNDECIDED)return c;{const l=(t===he.INSIDE?s.theme.faceColorInsideColorProperty:s.theme.faceColorOutsideColorProperty).value,n=l.alpha,w=new Le(c);return new Le((1-n)*w.red+n*l.red,(1-n)*w.green+n*l.green,(1-n)*w.blue+n*l.blue).toCSS()}}static toShape(e){const t=new N;for(const o of e)t.polygon(o.vertices.map(s=>s.viewCoordinates));return t.makeImmutable()}}class Bo extends b{constructor(r,e,t,o){let s=[];try{let d=new N;for(const c of r.faces)d.polygon(c.vertices.map(h=>h.viewCoordinates));if(r.faceColor.colorState===he.OUTSIDE)try{const c=N.polygon(e.outerBoundary.map(n=>n.start.viewCoordinates)),l=Pe.getOffsetBackgroundShape(e.outerBoundary,o.useBackgroundOffsetStroke,o.backgroundOffsetDistance).shapeDifference(c);d=d.shapeUnion(l)}catch(c){console.error(c)}const i=new D(d.getOffsetShape(-.07).getSimplifiedAreaShape(),{stroke:t.theme.selectedFaceColorHighlightColorProperty,lineWidth:.03});s.push(i)}catch(d){console.error(d)}super({children:s}),this.selectedFaceColorHighlight=r}}class Q extends b{static getSectorBaseShape(r,e){const t=r.start.viewCoordinates,o=r.end.viewCoordinates,s=r.next.end.viewCoordinates,d=t.minus(o),i=s.minus(o),c=d.normalized(),l=i.normalized().minus(c).angle+Math.PI/2,n=r.face?r.face.viewCoordinates:j.createPolar(e,l).plus(o),w=t.average(o),f=s.average(o);return N.polygon([w,o,f,n]).makeImmutable()}static getSectorArcShape(r,e){const t=r.start.viewCoordinates,o=r.end.viewCoordinates,s=r.next.end.viewCoordinates,d=t.minus(o),i=s.minus(o),c=d.normalized(),h=d.angle;let l=i.angle;return l<h&&(l+=2*Math.PI),new N().moveToPoint(o).lineToPoint(c.timesScalar(e).plus(o)).arcPoint(o,e,h,l,!0).close().makeImmutable()}static getStrokeFromStyle(r,e){return r===V.ONLY_ONE?e.theme.sectorOnlyOneColorProperty:r===V.NOT_ZERO?e.theme.sectorNotZeroColorProperty:r===V.NOT_ONE?e.theme.sectorNotOneColorProperty:r===V.NOT_TWO?e.theme.sectorNotTwoColorProperty:e.theme.sectorOtherColorProperty}}v(Q,"nameMap",new Map([[V.NONE,"Invalid"],[V.ONLY_ZERO,"No Lines"],[V.ONLY_ONE,"Only One Line"],[V.ONLY_TWO,"Both Lines"],[V.NOT_ZERO,"At Least One Line"],[V.NOT_ONE,"Zero or Two Lines"],[V.NOT_TWO,"Less Than Two Lines"],[V.ANY,"Any Lines"]]));class Mo extends b{constructor(r,e,t,o){const s=[],d=[],i=r.sector,c=r.currentState,h=Q.getSectorArcShape(i,.5),l=new D(h.getOffsetShape(.05),{stroke:t.theme.selectedSectorEditColorProperty,lineWidth:.02});s.push(l);const n=[];if(c===V.ANY&&(n.push(V.NOT_ZERO),n.push(V.NOT_ONE),n.push(V.NOT_TWO)),c.one&&c!==V.ONLY_ONE&&n.push(V.ONLY_ONE),n.length){const w=n.map(u=>{const C=Q.getStrokeFromStyle(u,t);return new ht({accessibleName:Q.nameMap.get(u),content:new st(0,0,25,25),listener:()=>{o.sectorSetListener&&o.sectorSetListener(i,u)},buttonAppearanceStrategy:Ot,baseColor:C,xMargin:10.4,yMargin:6.5,mouseAreaXDilation:5,mouseAreaYDilation:5,touchAreaXDilation:5,touchAreaYDilation:5})});d.push(...w);const f=new Je(new Ue({children:w,spacing:10}),{xMargin:10,yMargin:10,fill:t.theme.uiBackgroundColorProperty,stroke:t.theme.uiForegroundColorProperty,scale:.01});d.push(f);const m=.1;s.push(f),f.centerBottom=l.centerTop.plusXY(0,-.15),f.top<e.top+m&&(f.centerTop=l.centerBottom.plusXY(0,.15)),f.left<e.left+m&&(f.left=e.left+m),f.right>e.right-m&&(f.right=e.right-m)}super({children:s}),this.selectedSectorEdit=r,this.disposeEmitter.addListener(()=>{d.forEach(w=>w.dispose())})}}class Ro extends b{constructor(r,e,t,o){const s=new D(null,{lineWidth:.02,stroke:o.theme.whiteLineColorProperty}),d=new D(null,{stroke:o.theme.xColorProperty,lineWidth:.025}),i=new D(null,{lineWidth:.02,fill:o.theme.redLineColorProperty});super({children:[s,d,i],pickable:!1});const c=r.edges.map(u=>H.BLACK);let h=!1,l=!1,n=!1,w=!1,f=null;const m=ee.multilink([e,t,o.whiteLineVisibleProperty,o.redXsVisibleProperty,o.redXsAlignedProperty,o.redLineVisibleProperty,o.redLineStyleProperty],(u,C,g,P,y,S,F)=>{if(this.visible=!C,s.visible=g,d.visible=P,i.visible=S,this.visible){let T=!1;for(let E=0;E<r.edges.length;E++){const x=u.getEdgeState(r.edges[E]);x!==c[E]&&(T=!0,c[E]=x)}if(h!==y&&(T=!0,h=y),l!==g&&(T=!0,l=g),n!==P&&(T=!0,n=P),w!==S&&(T=!0,w=S),f!==F&&(T=!0,f=F),T){const E=new N,x=new N,J=new N;for(let B=0;B<r.edges.length;B++){const se=c[B];if(g&&se===H.WHITE){const I=r.edges[B];E.moveTo(I.start.viewCoordinates.x,I.start.viewCoordinates.y),E.lineTo(I.end.viewCoordinates.x,I.end.viewCoordinates.y)}if(se===H.RED){if(P){const I=r.edges[B],L=.07;let A=I.start.viewCoordinates.blend(I.end.viewCoordinates,.5);if(y){const X=I.end.viewCoordinates.minus(I.start.viewCoordinates).getAngle(),W=new j(-L,-L).rotate(X).add(A),Y=new j(L,L).rotate(X).add(A),Z=new j(-L,L).rotate(X).add(A),ne=new j(L,-L).rotate(X).add(A);x.moveTo(W.x,W.y),x.lineTo(Y.x,Y.y),x.moveTo(Z.x,Z.y),x.lineTo(ne.x,ne.y)}else x.moveTo(A.x-L,A.y-L),x.lineTo(A.x+L,A.y+L),x.moveTo(A.x-L,A.y+L),x.lineTo(A.x+L,A.y-L)}if(S){const I=r.edges[B],L=.4,A=.017,X=I.start.viewCoordinates.blend(I.end.viewCoordinates,.5),W=X.blend(I.start.viewCoordinates,L),Y=X.blend(I.end.viewCoordinates,L);for(let Z=0;Z<5;Z++){const ne=W.blend(Y,Z/4);J.moveTo(ne.x+A,ne.y),J.arc(ne.x,ne.y,A,0,2*Math.PI,!1)}}}}E.makeImmutable(),x.makeImmutable(),J.makeImmutable(),s.shape=E,d.shape=x,i.shape=J}}});this.disposeEmitter.addListener(()=>m.dispose())}}class Ne extends b{constructor(r,e,t){super();const o=new N,s=r.map(n=>{const w=e(n);return w.makeImmutable(),o.subpaths.push(...w.subpaths),w});this.mouseArea=this.touchArea=o.makeImmutable();const d=n=>{const w=n.trail.globalToLocalPoint(n.pointer.point);for(let f=0;f<s.length;f++){const m=s[f];if(m.bounds.containsPoint(w)&&m.containsPoint(w))return r[f]}return null},i=(n,w)=>{const f=d(n);f&&t(f,w)},c=new pe({mouseButton:0,fire:n=>{var w;return i(n,(w=n.domEvent)!=null&&w.shiftKey?2:0)}}),h=new pe({mouseButton:2,fire:n=>{var w;return i(n,(w=n.domEvent)!=null&&w.shiftKey?0:2)}}),l=new pe({mouseButton:1,fire:n=>i(n,1)});this.addInputListener(c),this.addInputListener(h),this.addInputListener(l),this.cursor="pointer",this.disposeEmitter.addListener(()=>{c.dispose(),h.dispose(),l.dispose()})}}class Do extends Ne{constructor(r,e){super(r.edges,t=>{const o=t.start.viewCoordinates,s=t.end.viewCoordinates,d=new N;let i;if(t.faces.length===2)i=[o,t.faces[0].viewCoordinates,s,t.faces[1].viewCoordinates];else{M()&&R(t.faces.length===1,"EdgeNode only supports edges with 1 or 2 faces");const c=t.forwardHalf.face===null?t.forwardHalf:t.reversedHalf;M()&&R(c.previous.face===null),M()&&R(c.next.face===null);const h=c.start.viewCoordinates,l=c.end.viewCoordinates,n=c.previous.start.viewCoordinates,w=c.next.end.viewCoordinates,f=(C,g,P)=>{const y=g.minus(C).normalized(),S=P.minus(g).normalized();let F=y.minus(S);return F.getMagnitude()<1e-6?F=y.getPerpendicular():F=F.normalized(),tt.triangleAreaSigned(C,g,g.plus(F))<0&&(F=F.negated()),F},m=f(n,h,l),u=f(h,l,w);i=[h,t.faces[0].viewCoordinates,l,l.plus(u.times(e.backgroundOffsetDistance)),h.plus(m.times(e.backgroundOffsetDistance))]}return d.polygon(i),d.makeImmutable(),d},e.edgePressListener)}}const We=[.02,.02],ce=.2,we=.02;class Wo extends b{constructor(r,e,t){const o=new D(null,{lineWidth:.025,lineCap:"butt",stroke:Q.getStrokeFromStyle(V.NOT_ZERO,t)}),s=new D(null,{lineWidth:.025,lineCap:"butt",stroke:Q.getStrokeFromStyle(V.NOT_ONE,t)}),d=new D(null,{lineWidth:.025,lineCap:"butt",stroke:Q.getStrokeFromStyle(V.NOT_TWO,t)}),i=new D(null,{lineWidth:.025,lineCap:"butt",stroke:Q.getStrokeFromStyle(V.ONLY_ONE,t)});super({pickable:!1,visibleProperty:t.sectorsVisibleProperty,children:[o,s,d,i]}),this.board=r;const c=r.halfEdges.map(n=>V.NONE),h=r.edges.map(n=>H.BLACK),l=ee.multilink([e,t.sectorsVisibleProperty],(n,w)=>{if(w){let f=!1;for(let m=0;m<r.halfEdges.length;m++){const u=n.getSectorState(r.halfEdges[m]);u!==c[m]&&(f=!0,c[m]=u)}for(let m=0;m<r.edges.length;m++){const u=n.getEdgeState(r.edges[m]);u!==h[m]&&(f=!0,h[m]=u)}if(f){const m=new N,u=new N,C=new N,g=new N;for(let P=0;P<r.halfEdges.length;P++){const y=c[P];if(y!==V.NOT_ZERO&&y!==V.NOT_ONE&&y!==V.NOT_TWO&&y!==V.ONLY_ONE)continue;const S=r.halfEdges[P],F=n.getEdgeState(S.edge),T=n.getEdgeState(S.next.edge);if(F!==H.WHITE||T!==H.WHITE)continue;if(y===V.NOT_ONE){const W=S.end.edges.filter(Z=>n.getEdgeState(Z)===H.BLACK),Y=S.end.edges.filter(Z=>n.getEdgeState(Z)===H.WHITE);if(W.length===0&&Y.length===2)continue}const E=S.start.viewCoordinates,x=S.end.viewCoordinates,J=S.next.end.viewCoordinates,B=E.minus(x),se=J.minus(x),I=B.normalized(),L=B.angle;let A=se.angle;A<L&&(A+=2*Math.PI);const X=(W,Y)=>(W.moveToPoint(I.timesScalar(Y).add(x)),W.arcPoint(x,Y,L,A,!0),W);if(y===V.ONLY_ONE)X(g,ce);else if(y===V.NOT_ONE)X(u,ce-we),X(u,ce+we);else if(y===V.NOT_ZERO){const W=new N;X(W,ce-we),X(W,ce+we);const Y=W.getDashedShape(We,0);m.subpaths.push(...Y.subpaths)}else if(y===V.NOT_TWO){const W=new N;X(W,ce);const Y=W.getDashedShape(We,0);C.subpaths.push(...Y.subpaths)}}o.shape=m.makeImmutable(),s.shape=u.makeImmutable(),d.shape=C.makeImmutable(),i.shape=g.makeImmutable()}}});this.disposeEmitter.addListener(()=>l.dispose())}}class Ho extends Ne{constructor(r,e){super(r.halfEdges,t=>Q.getSectorBaseShape(t,e.backgroundOffsetDistance),e.sectorPressListener)}}class jo extends _e{constructor(r,e){const t=ye()({font:It,fill:$.uiForegroundColorProperty},e);super(r,t)}}class Xo extends b{constructor(r,e,t){super({translation:r.viewCoordinates}),this.face=r;const s=e.value.getFaceState(r),d=s.possibilityCount===0||s.possibilityCount>9;let i;const c=s.possibilityCount===1?t.theme.faceValueCompletedColorProperty:t.theme.faceValueColorProperty;if(d)i=new jo(s.possibilityCount,{font:be,maxWidth:.4,maxHeight:.4});else{const h=new Set(r.vertices);i=new nt({spacing:1.5,autoColumns:Math.ceil(Math.sqrt(s.possibilityCount)),children:s.getAllowedCombinations().map(l=>{const n=new b,w=new Set(l.map(u=>u.start)),f=new Set(l.map(u=>u.end)),m=u=>u.minus(r.viewCoordinates);if(n.addChild(new D(N.polygon(r.vertices.map(u=>m(u.viewCoordinates))),{stroke:c,lineWidth:.03,opacity:.2})),w.size){const u=new N;if(l.length===r.edges.length)u.polygon(r.vertices.map(C=>m(C.viewCoordinates)));else{const C=new Set(l);for(;C.size;){const g=[...h].find(S=>[...C].filter(F=>F.start===S||F.end===S).length===1);M()&&R(g);let P=g,y=[...C].find(S=>S.start===P||S.end===P)??null;for(u.moveToPoint(m(P.viewCoordinates));y;)C.delete(y),P=y.getOtherVertex(P),u.lineToPoint(m(P.viewCoordinates)),y=[...C].find(S=>S.start===P||S.end===P)??null}}n.addChild(new D(u,{stroke:c,lineWidth:.15,lineCap:"round",lineJoin:"round"}))}for(const u of r.vertices)!w.has(u)&&!f.has(u)&&n.addChild(new qe(.1,{fill:c,translation:m(u.viewCoordinates)}));return n}),maxWidth:.6,maxHeight:.6})}i.center=j.ZERO,this.addChild(i)}}class Yo extends b{constructor(r,e,t,o){super({pickable:!1});const s=ee.multilink([e,o.faceStateVisibleProperty],(i,c)=>{this.children.forEach(h=>h.dispose()),this.children=[],c&&r.faces.forEach(h=>{this.addChild(new Xo(h,e,o))})});this.disposeEmitter.addListener(()=>s.dispose());const d=i=>{this.visible=!i};t.link(d),this.disposeEmitter.addListener(()=>{t.unlink(d),this.children.forEach(i=>i.dispose())})}}class Uo extends Ne{constructor(r,e){super(r.faces,t=>t?N.polygon(t.vertices.map(o=>o.viewCoordinates)):new N,e.facePressListener)}}class _o extends b{constructor(r,e,t,o){super({pickable:!1}),this.board=r;const s=r.faces.map(h=>null),d=()=>{const h=[],l=t.faceValueStyleProperty.value,n=t.theme.faceValueColorProperty.value,w=t.theme.faceValueCompletedColorProperty.value,f=t.theme.faceValueErrorColorProperty.value,m=t.theme.faceValueRatioColorProperty.value,u=t.faceStateVisibleProperty.value;this.visible=!u;for(let C=0;C<r.faces.length;C++){const g=s[C];if(g!==null){const P=r.faces[C],y=new it("",Ye({subScale:.7},o==null?void 0:o.textOptions)),S=ee.multilink([e],F=>{let T,E,x=!1,J=!1;if(g===null)T="",E=null;else{let B=0,se=0;for(const I of P.edges){const L=F.getEdgeState(I);L===H.BLACK?B++:L===H.WHITE&&se++}if(l==="static"||g===0)T=`${g}`;else if(l==="remaining")T=`${g-B}`,x=B>0;else if(l==="ratio")g-B===0?T="0":(T=`${g-B}<sub style="color: ${m.toCSS()};">/<sub>${se}</sub></sub>`,J=!0),x=B>0;else throw new Error(`unhandled faceValueStyle: ${l}`);B<g?E=n:B===g?E=w:E=f}y.string=T,y.fill=E,y.maxWidth=J?.8:.9,y.maxHeight=J?.8:.9,y.center=P.viewCoordinates});y.disposeEmitter.addListener(()=>S.dispose()),h.push(y)}}this.children.forEach(C=>C.dispose()),this.children=h},i=ee.multilink([e],h=>{let l=!1;for(let n=0;n<r.faces.length;n++){const w=h.getFaceValue(r.faces[n]);w!==s[n]&&(l=!0,s[n]=w)}l&&d()}),c=ee.multilinkAny([t.faceValueStyleProperty,t.theme.faceValueColorProperty,t.theme.faceValueCompletedColorProperty,t.theme.faceValueErrorColorProperty,t.theme.faceValueRatioColorProperty,t.faceStateVisibleProperty],d);this.disposeEmitter.addListener(()=>{i.dispose(),c.dispose(),this.children.forEach(h=>h.dispose())})}}class qo extends b{constructor(r,e,t){super({pickable:!1}),this.vertex=r;const o=.12,d=r.edges.map(f=>f.getOtherVertex(r).viewCoordinates.minus(r.viewCoordinates).normalized()).map(f=>f.times(o)),c=N.polygon(ot.grahamScan([j.ZERO,...d],!1)).getOffsetShape(-.05),h=new D(null,{stroke:t.theme.vertexStateLineProperty,lineWidth:.01}),l=new D(c,{translation:r.viewCoordinates,fill:t.theme.vertexStateBackgroundProperty,stroke:t.theme.vertexStateOutlineProperty,lineWidth:.01,children:[h,...d.map(f=>new qe({radius:.02,translation:f,fill:t.theme.vertexStatePointProperty}))]});let n=null;const w=ee.multilink([e,t.vertexStateVisibleProperty,t.allVertexStateVisibleProperty],(f,m,u)=>{const C=()=>{this.children=[]};if(!m){C();return}const g=f.getVertexState(r);if(!u){let P=!1,y=!1;const S=new Set;for(const T of r.edges){const E=f.getEdgeState(T);P=P||E===H.BLACK,y=y||E===H.WHITE,E===H.WHITE&&S.add(T)}if(P||!y){C();return}if(at.fromLookup(r,(T,E)=>S.has(T)&&S.has(E),!0).equals(g)){C();return}}if(!n||!n.equals(g)){n=g;const P=new N;for(const y of g.getAllowedPairs()){const S=F=>F.getOtherVertex(r).viewCoordinates.minus(r.viewCoordinates).normalized().times(o);P.moveToPoint(S(y[0])),P.lineToPoint(S(y[1]))}g.allowsEmpty()&&(P.moveTo(.03,0),P.circle(j.ZERO,.03),P.close()),P.makeImmutable(),h.shape=P}this.children=[l]});this.disposeEmitter.addListener(()=>w.dispose())}}class Jo extends b{constructor(r,e,t,o){super({pickable:!1});const s=ee.multilink([e,o.vertexStateVisibleProperty],(i,c)=>{this.children.forEach(h=>h.dispose()),this.children=[],c&&r.vertices.forEach(h=>{this.addChild(new qo(h,e,o))})});this.disposeEmitter.addListener(()=>s.dispose());const d=i=>{this.visible=!i};t.link(d),this.disposeEmitter.addListener(()=>{t.unlink(d),this.children.forEach(i=>i.dispose())})}}const Zo=.03,zo=.05;class Go extends D{constructor(r,e,t,o){super(null,{pickable:!1,fill:o.theme.vertexColorProperty});const s=r.edges.map(h=>H.BLACK);let d=o.vertexStyleProperty.value,i=o.smallVertexProperty.value;const c=ee.multilink([e,t,o.verticesVisibleProperty,o.vertexStyleProperty,o.smallVertexProperty],(h,l,n,w,f)=>{if(this.visible=!l&&n,this.visible){let m=!1;for(let u=0;u<r.edges.length;u++){const C=h.getEdgeState(r.edges[u]);C!==s[u]&&(m=!0,s[u]=C)}if(d!==w&&(d=w,m=!0),i!==f&&(i=f,m=!0),m){const u=new N;for(let C=0;C<r.vertices.length;C++){const g=r.vertices[C];if(g.edges.every(P=>h.getEdgeState(P)!==H.BLACK)){const P=g.viewCoordinates,y=f?Zo:zo;w==="round"?(u.moveTo(P.x+y,P.y),u.arc(P.x,P.y,y,0,2*Math.PI,!1)):w==="square"?u.rect(P.x-y,P.y-y,2*y,2*y):M()&&R(!1,`unhandled vertex style: ${w}`)}}this.shape=u}}});this.disposeEmitter.addListener(()=>c.dispose())}}class He extends b{constructor(e,t){const o=ye()({textOptions:{font:be,maxWidth:.9,maxHeight:.9},edgePressListener:()=>{},facePressListener:()=>{},sectorPressListener:()=>{},sectorSetListener:()=>{},backgroundOffsetDistance:.3,selectedFaceColorHighlightProperty:new fe(null),selectedSectorEditProperty:new fe(null),style:ie,noninteractive:!1},t),s=o.style,d=new b({visibleProperty:s.faceColorsVisibleProperty}),i=new b({pickableProperty:ko}),c=new b({pickableProperty:Fo}),h=new b({pickableProperty:Lo}),l=new b({pickableProperty:xo}),n=new b,w=new b({pickable:!1}),f=new b({pickable:!1}),m=new b({pickable:null}),u=new b({pickable:!1}),C=new b,g=new _([e.stateProperty],T=>{if(T.getWeirdEdges().length||T.hasInvalidFaceColors())return!1;const E=T.getSimpleRegions();return E.length===1&&E[0].isSolved}),P=T=>{T?d.addChild(new Ao(e.board,e.stateProperty,s)):d.children.forEach(E=>E.dispose())};s.faceColorsVisibleProperty.link(P),i.addChild(new _o(e.board,e.stateProperty,s,o)),o.noninteractive||i.addChild(new Uo(e.board,o)),f.addChild(new Yo(e.board,e.stateProperty,g,s));const y=new Pe(e.board.outerBoundary,e.board.innerBoundaries,s,o);l.addChild(new Go(e.board,e.stateProperty,g,s)),w.addChild(new Jo(e.board,e.stateProperty,g,s)),h.addChild(new Ro(e.board,e.stateProperty,g,s)),o.noninteractive||h.addChild(new Do(e.board,o)),c.addChild(new Wo(e.board,e.stateProperty,s)),o.noninteractive||c.addChild(new Ho(e.board,o)),n.addChild(new Io(e.board,e.stateProperty,s));super(Ye({children:[y,d,i,c,h,l,n,w,f,m,u,C]},o));v(this,"annotationContainer");v(this,"backgroundNode");this.puzzle=e,this.annotationContainer=m;const S=T=>{u.children.forEach(E=>E.dispose()),T&&u.addChild(new Bo(T,e.board,s,o))};o.selectedFaceColorHighlightProperty.link(S),this.disposeEmitter.addListener(()=>o.selectedFaceColorHighlightProperty.unlink(S));const F=T=>{C.children.forEach(E=>E.dispose()),T&&C.addChild(new Mo(T,y,s,o))};o.selectedSectorEditProperty.link(F),this.disposeEmitter.addListener(()=>o.selectedSectorEditProperty.unlink(F)),this.disposeEmitter.addListener(()=>{s.faceColorsVisibleProperty.unlink(P),[d,i,h,l,n,w,f,c].forEach(E=>{E.children.forEach(x=>x.dispose()),E.dispose()}),g.dispose(),y.dispose()}),this.backgroundNode=y}addAnnotationNode(e){this.annotationContainer.addChild(e)}removeAnnotationNode(e){this.annotationContainer.removeChild(e)}clearAnnotationNodes(){this.annotationContainer.removeAllChildren()}getBackgroundBounds(){return this.backgroundNode.bounds}}class hr extends b{constructor(r,e,t){const o=ye()({style:ie},t),s=e.getEmbeddedCompleteData(r.inputFeatureSet),d=e.getEmbeddedCompleteData(r.outputFeatureSet),i=new He(new Fe(e.smallBoard,s),{noninteractive:!0,style:o.style}),c=new He(new Fe(e.smallBoard,d),{noninteractive:!0,style:o.style}),h=r.highlander?new b({children:e.getEmbeddedQuestionFaces(r.inputFeatureSet).map(g=>new _e("?",{font:be,maxWidth:.9,maxHeight:.9,opacity:.5,fill:r.highlander?o.style.theme.faceValueColorProperty:o.style.theme.faceValueCompletedColorProperty,center:g.viewCoordinates}))}):new b,n=e.tightBounds.dilated(.5),w=.5,f=N.roundRectangle(n.x,n.y,n.width,n.height,w,w),m=new b({children:[i,h],clipArea:f,localBounds:n}),u=new b({children:[c,h],clipArea:f,localBounds:n}),C=new Je(new Ue({spacing:.2,children:[m,new Kt(0,0,20,0,{fill:o.style.theme.uiForegroundColorProperty,stroke:o.style.theme.uiForegroundColorProperty,headHeight:7,headWidth:7,tailWidth:1,layoutOptions:{align:"center"},opacity:.6,scale:1/30}),u]}),{cornerRadius:w*1.2,xMargin:.1,yMargin:.1,lineWidth:.05,stroke:null,fill:o.style.theme.patternAnnotationBackgroundColorProperty});o.children=[C],super(o),this.rule=r,this.displayEmbedding=e,this.disposeEmitter.addListener(()=>{i.dispose(),c.dispose()})}}const Ko=(p,r)=>{Jt(Zt,p,r,!0)};class me{constructor(r,e,t,o,s,d,i,c,h,l){this.sourcePatternBoard=r,this.boardPatternBoard=e,this.largeBoard=t,this.embedding=o,this.smallBoard=s,this.toSmallFaceMap=d,this.toSmallEdgeMap=i,this.toSmallSectorMap=c,this.tightBounds=h,this.expandedBounds=l}mapFace(r){const e=this.embedding.mapFace(r),t=this.boardPatternBoard.getFace(e);if(t){const o=this.toSmallFaceMap.get(t);return M()&&R(o),o}else return null}mapEdge(r){return(r.isExit?this.embedding.mapExitEdges(r):[this.embedding.mapNonExitEdge(r)]).map(o=>this.boardPatternBoard.getEdge(o)).map(o=>{const s=this.toSmallEdgeMap.get(o);return M()&&R(s),s})}mapSector(r){const e=this.embedding.mapSector(r),t=this.boardPatternBoard.getSector(e),o=this.toSmallSectorMap.get(t);return M()&&R(o),o}getEmbeddedQuestionFaces(r){const e=new Set;for(const t of r.patternBoard.faces)if(r.getFaceValue(t)!==void 0){const o=this.mapFace(t);o&&e.add(o)}return this.smallBoard.faces.filter(t=>!e.has(t))}getEmbeddedCompleteData(r){const e=lt.empty(this.smallBoard);for(const t of r.getFeaturesArray())if(t instanceof $t)t.value!==null&&e.setFaceValue(this.mapFace(t.face),t.value);else if(t instanceof Qt)this.mapEdge(t.edge).forEach(o=>e.setEdgeState(o,H.BLACK));else if(t instanceof eo)this.mapEdge(t.edge).forEach(o=>e.setEdgeState(o,H.RED));else if(t instanceof to)e.setSectorState(this.mapSector(t.sector),V.NOT_ZERO);else if(t instanceof oo)e.setSectorState(this.mapSector(t.sector),V.NOT_ONE);else if(t instanceof ro)e.setSectorState(this.mapSector(t.sector),V.NOT_TWO);else if(t instanceof so)e.setSectorState(this.mapSector(t.sector),V.ONLY_ONE);else if(t instanceof no){const o=(d,i)=>{const c=this.mapFace(d),h=this.mapFace(i),l=c?e.getFaceColor(c):e.getOutsideColor(),n=h?e.getFaceColor(h):e.getOutsideColor();new zt(ge(e,l),ge(e,n)).apply(e)},s=(d,i)=>{const c=this.mapFace(d),h=this.mapFace(i),l=c?e.getFaceColor(c):e.getOutsideColor(),n=h?e.getFaceColor(h):e.getOutsideColor();new Gt(ge(e,l),ge(e,n)).apply(e)};for(let d=1;d<t.primaryFaces.length;d++)o(t.primaryFaces[d-1],t.primaryFaces[d]);for(let d=1;d<t.secondaryFaces.length;d++)o(t.secondaryFaces[d-1],t.secondaryFaces[d]);t.secondaryFaces.length&&s(t.primaryFaces[0],t.secondaryFaces[0])}else throw new Error(`unhandled feature: ${t}`);return Ko(this.smallBoard,e),e}static getEmbeddingBounds(r,e,t){const o=Se.NOTHING.copy(),s=i=>{o.addPoint(e.getVertex(t.mapVertex(i)).viewCoordinates)};r.vertices.forEach(s);const d=i=>{const c=e.getFace(t.mapFace(i));c&&c.vertices.forEach(h=>o.addPoint(h.viewCoordinates))};return r.faces.forEach(d),r.edges.forEach(i=>{let c;i.isExit?c=t.mapExitEdges(i).map(h=>e.getEdge(h)):c=[e.getEdge(t.mapNonExitEdge(i))],c.forEach(h=>{o.addPoint(h.start.viewCoordinates),o.addPoint(h.end.viewCoordinates)})}),o}static findBestEmbedding(r,e,t){const o=io(r,e);if(o.length===0)return null;const s=Se.NOTHING.copy();t.vertices.forEach(h=>s.addPoint(h.viewCoordinates));const d=s.center;let i=null,c=Number.POSITIVE_INFINITY;for(let h=0;h<o.length;h++){const l=o[h],w=me.getEmbeddingBounds(r,e,l).center,f=d.distance(w);f<c&&(c=f,i=l)}return i}static getDisplayEmbedding(r,e,t,o){const s=me.getEmbeddingBounds(r,e,o),d=s.dilated(.5),i=t.faces.filter(u=>{const C=Se.NOTHING.copy();return u.vertices.forEach(g=>C.addPoint(g.viewCoordinates)),d.intersectsBounds(C)}),c=t.vertices.filter(u=>u.faces.some(C=>i.includes(C))),h=ft({vertices:c.map(u=>({logicalCoordinates:u.logicalCoordinates,viewCoordinates:u.viewCoordinates})),faces:i.map(u=>({logicalCoordinates:u.logicalCoordinates,vertices:u.vertices.map(C=>({logicalCoordinates:C.logicalCoordinates,viewCoordinates:C.viewCoordinates}))}))}),l=new gt(h),n=1e-6,w=new Map(i.map((u,C)=>{const g=l.faces.find(P=>P.viewCoordinates.equalsEpsilon(u.viewCoordinates,n));return M()&&R(g),[u,g]})),f=new Map(t.edges.map(u=>{const C=l.edges.find(g=>g.start.viewCoordinates.equalsEpsilon(u.start.viewCoordinates,n)&&g.end.viewCoordinates.equalsEpsilon(u.end.viewCoordinates,n)||g.start.viewCoordinates.equalsEpsilon(u.end.viewCoordinates,n)&&g.end.viewCoordinates.equalsEpsilon(u.start.viewCoordinates,n))??null;return C?[u,C]:null}).filter(u=>u!==null)),m=new Map(t.halfEdges.map(u=>{const C=l.halfEdges.find(g=>g.start.viewCoordinates.equalsEpsilon(u.start.viewCoordinates,n)&&g.end.viewCoordinates.equalsEpsilon(u.end.viewCoordinates,n))??null;return C?[u,C]:null}).filter(u=>u!==null));return M()&&R(o),new me(r,e,t,o,l,w,f,m,s,d)}}export{me as D,hr as E,Xo as F,He as P,jo as U,qo as V,cr as a,po as b,ho as c,uo as d,wo as e,ie as f,fo as g,Oo as h,ko as i,re as j,U as k,yo as l,Po as m,So as n,Ke as o,No as p,vo as q,Eo as r,Ko as s,bo as t,ao as u,Vo as v,dr as w,pr as x,To as y};
